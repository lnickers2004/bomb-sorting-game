/* Goo Engine 0.9.5
 * Copyright 2014 Goo Technologies AB
 */
(function () {
	'use strict';
	if (!window.define) {
		var _moduleBank = {};

		window.define = function (nam, dependencies, callback) {
			var resolvedModules;
			if (callback instanceof Function) {
				dependencies.forEach(function (dependency) {
					if (!_moduleBank[dependency] && dependency !== 'exports') {
						console.warn(dependency, 'requested by', nam, 'was not declared');
					}
				});
				resolvedModules = dependencies.map(function (dependency) {
					return _moduleBank[dependency];
				});
			} else {
				resolvedModules = [];
				callback = dependencies;
			}

			if (dependencies[0] === "exports") {
				_moduleBank[nam] = {};
				callback(_moduleBank[nam]);
			} else {
				_moduleBank[nam] = callback.apply(null, resolvedModules);
			}
		};

		window.require = function (dependencies, callback) {
			dependencies.forEach(function (dependency) {
				if (!_moduleBank[dependency]) {
					console.warn(dependency, 'was not declared');
				}
			});
			var resolvedModules = dependencies.map(function (dependency) {
				return _moduleBank[dependency];
			});

			callback.apply(null, resolvedModules);
		};

		window.goo = {};
	}
})();(function(window) {function f(){
define("goo/math/MathUtils",[],function(){"use strict";function t(){}return t.DEG_TO_RAD=Math.PI/180,t.RAD_TO_DEG=180/Math.PI,t.HALF_PI=.5*Math.PI,t.TWO_PI=2*Math.PI,t.EPSILON=1e-7,t.radFromDeg=function(e){return e*t.DEG_TO_RAD},t.degFromRad=function(e){return e*t.RAD_TO_DEG},t.lerp=function(t,e,o){return e===o?e:e+(o-e)*t},t.clamp=function(t,e,o){return o>e?e>t?e:t>o?o:t:o>t?o:t>e?e:t},t.radialClamp=function(e,o,r){var i=(o+r)/2+(r>o?Math.PI:0),n=t.moduloPositive(e-i,t.TWO_PI),a=t.moduloPositive(o-i,t.TWO_PI),s=t.moduloPositive(r-i,t.TWO_PI);return 0>e&&o>0?o-=t.TWO_PI:e>0&&0>o&&(o+=t.TWO_PI),e>t.TWO_PI&&r<t.TWO_PI&&(r+=t.TWO_PI),a>n?o:n>s?r:e},t.moduloPositive=function(t,e){var o=t%e;return o+=0>o?e:0},t.scurve3=function(t){return(-2*t+3)*t*t},t.scurve5=function(t){return((6*t-15)*t+10)*t*t*t},t.sphericalToCartesian=function(t,e,o,r){var i=t*Math.cos(o);r.x=i*Math.cos(e),r.y=t*Math.sin(o),r.z=i*Math.sin(e)},t.cartesianToSpherical=function(t,e,o,r){var i=Math.sqrt(t*t+o*o);r.x=Math.sqrt(t*t+e*e+o*o),r.y=Math.atan2(o,t),r.z=Math.atan2(e,i)},t.getTriangleNormal=function(t,e,o,r,i,n,a,s,l){var h=r-t,d=i-e,c=n-o,u=a-t,p=s-e,m=l-o,f=d*m-c*p,g=c*u-h*m,v=h*p-d*u;return[f,g,v]},t.isPowerOfTwo=function(t){return 0===(t&t-1)},t.nearestHigherPowerOfTwo=function(t){return Math.floor(Math.pow(2,Math.ceil(Math.log(t)/Math.log(2))))},t.closeTo=function(t,e,o){return o="undefined"!=typeof o?o:.001,Math.abs(t-e)<=o},t.sign=function(t){return 0>t?-1:t>0?1:0},t.triangleArea=function(t,e,o){return Math.abs(t.x*e.y+e.x*o.y+o.x*t.y-e.y*o.x-o.y*t.x-t.y*e.x)/2},t.barycentricInterpolation=function(e,o,r,i){var n=t.triangleArea(o,r,i),a=t.triangleArea(e,r,i),s=t.triangleArea(e,o,i),l=n+a+s;if(!l){if(i[0]===e[0]&&i[2]===e[2])return e;if(i[0]===o[0]&&i[2]===o[2])return o;if(i[0]===r[0]&&i[2]===r[2])return r}return i.z=(n*e.z+a*o.z+s*r.z)/l,i},t.smoothstep=function(e,o,r){return r=t.clamp((r-e)/(o-e),0,1),r*r*(3-2*r)},t.randomSeed=1337,t.fastRandom=function(){return t.randomSeed=(9301*t.randomSeed+49297)%233280,t.randomSeed/233280},t}),define("goo/math/Vector",["goo/math/MathUtils"],function(t){"use strict";function e(t){this.data=new Float32Array(t||0)}return e.prototype.setupAliases=function(t){for(var e=this,o=0;o<t.length;o++)!function(r){for(var i=0;i<t[r].length;i++)Object.defineProperty(e,t[r][i],{get:function(){return this.data[r]},set:function(t){this.data[r]=t}});Object.defineProperty(e,o,{get:function(){return this.data[r]},set:function(t){this.data[r]=t}})}(o)},e.add=function(t,o,r){var i=t.data||t,n=o.data||o,a=i.length;if(r||(r=new e(a)),n.length!==a||r.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)r.data[s]=i[s]+n[s];return r},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,o,r){var i=t.data||t,n=o.data||o,a=i.length;if(r||(r=new e(a)),n.length!==a||r.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)r.data[s]=i[s]-n[s];return r},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,o,r){var i=t.data||t,n=o.data||o,a=i.length;if(r||(r=new e(a)),n.length!==a||r.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)r.data[s]=i[s]*n[s];return r},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,o,r){var i=t.data||t,n=o.data||o,a=i.length;if(r||(r=new e(a)),n.length!==a||r.data.length!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var s=0;a>s;s++)r.data[s]=i[s]/n[s];return r},e.prototype.div=function(t){return e.div(this,t,this)},e.copy=function(t,o){var r=t.data.length;if(o||(o=new e(r)),o.data.length!==r)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return o.data.set(t.data),o},e.prototype.copy=function(t){return e.copy(t,this)},e.dot=function(t,e){var o=t.data||t,r=e.data||e,i=o.length;if(r.length!==i)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var n=0,a=0;i>a;a++)n+=o[a]*r[a];return n},e.prototype.dot=function(t){return e.dot(this,t)},e.apply=function(t,o,r){var i=t.rows,n=t.cols,a=o.data.length;if(r||(r=new e(i)),r.data.length!==i||n!==a)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};if(r===o)return e.copy(e.apply(t,o),r);for(var s=0;n>s;s++)for(var l=s*i,h=0;i>h;h++){for(var d=0,c=0;a>c;c++)d+=t.data[c*t.rows+h]*o.data[c];r.data[l+h]=d}return r},e.prototype.apply=function(t){return e.apply(t,this,this)},e.equals=function(e,o){var r=e.data.length;if(r!==o.data.length)return!1;for(var i=0;r>i;i++)if(Math.abs(e.data[i]-o.data[i])>t.EPSILON)return!1;return!0},e.prototype.equals=function(t){return e.equals(this,t)},e.distanceSquared=function(t,o){return e.sub(t,o).lengthSquared()},e.prototype.distanceSquared=function(t){return e.sub(this,t).lengthSquared()},e.distance=function(t,o){return e.sub(t,o).length()},e.prototype.distance=function(t){return e.sub(this,t).length()},e.prototype.lengthSquared=function(){return e.dot(this,this)},e.prototype.length=function(){return Math.sqrt(e.dot(this,this))},e.prototype.scale=function(t){for(var e=this.data.length-1;e>=0;e--)this.data[e]*=t;return this},e.prototype.invert=function(){for(var t=0;t<this.data.length;t++)this.data[t]=0-this.data[t];return this},e.prototype.normalize=function(){var e=this.length(),o=this.data.length;if(e<t.EPSILON)for(var r=0;o>r;r++)this.data[r]=0;else{e=1/e;for(var r=0;o>r;r++)this.data[r]*=e}return this},e.prototype.clone=function(){return e.copy(this)},e.prototype.set=function(){if(1===arguments.length&&"object"==typeof arguments[0])if(arguments[0]instanceof e)this.copy(arguments[0]);else if(arguments[0].length>1)for(var t=0;t<arguments[0].length;t++)this.data[t]=arguments[0][t];else this.set(arguments[0][0]);else for(var t=0;t<arguments.length;t++)this.data[t]=arguments[t];return this},e.prototype.toString=function(){var t="";t+="[";for(var e=0;e<this.data.length;e++)t+=this.data[e],t+=e!==this.data.length-1?", ":"";return t+="]"},e}),define("goo/math/Vector3",["goo/math/Vector"],function(t){"use strict";function e(){t.call(this,3),0!==arguments.length?this.set(arguments):this.setd(0,0,0)}return e.prototype=Object.create(t.prototype),e.prototype.setupAliases([["x","u","r"],["y","v","g"],["z","w","b"]]),e.ZERO=new e(0,0,0),e.ONE=new e(1,1,1),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.add=function(t,o,r){"number"==typeof t&&(t=[t,t,t]),"number"==typeof o&&(o=[o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(3!==i.length||3!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]+n[0],r.data[1]=i[1]+n[1],r.data[2]=i[2]+n[2],r},e.addv=function(t,o,r){return r||(r=new e),r.data[0]=t.data[0]+o.data[0],r.data[1]=t.data[1]+o.data[1],r.data[2]=t.data[2]+o.data[2],r},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,o,r){"number"==typeof t&&(t=[t,t,t]),"number"==typeof o&&(o=[o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(3!==i.length||3!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]-n[0],r.data[1]=i[1]-n[1],r.data[2]=i[2]-n[2],r},e.subv=function(t,o,r){return r||(r=new e),r.data[0]=t.data[0]-o.data[0],r.data[1]=t.data[1]-o.data[1],r.data[2]=t.data[2]-o.data[2],r},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,o,r){"number"==typeof t&&(t=[t,t,t]),"number"==typeof o&&(o=[o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(3!==i.length||3!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]*n[0],r.data[1]=i[1]*n[1],r.data[2]=i[2]*n[2],r},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,o,r){"number"==typeof t&&(t=[t,t,t]),"number"==typeof o&&(o=[o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(3!==i.length||3!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]/n[0],r.data[1]=i[1]/n[1],r.data[2]=i[2]/n[2],r},e.prototype.div=function(t){return e.div(this,t,this)},e.dot=function(t,e){"number"==typeof t&&(t=[t,t,t]),"number"==typeof e&&(e=[e,e,e]);var o=t.data||t,r=e.data||e;if(3!==o.length||3!==r.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var i=0;return i+=o[0]*r[0],i+=o[1]*r[1],i+=o[2]*r[2]},e.dotv=function(t,e){var o=t.data,r=e.data,i=0;return i+=o[0]*r[0],i+=o[1]*r[1],i+=o[2]*r[2]},e.prototype.dot=function(t){return e.dot(this,t)},e.cross=function(t,o,r){r||(r=new e);var i=t.data||t,n=o.data||o;if(3!==i.length||3!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var a=n[2]*i[1]-n[1]*i[2],s=n[0]*i[2]-n[2]*i[0],l=n[1]*i[0]-n[0]*i[1];return r.data[0]=a,r.data[1]=s,r.data[2]=l,r},e.prototype.cross=function(t){return e.cross(this,t,this)},e.prototype.lerp=function(t,e){return this.data[0]=(1-e)*this.data[0]+e*t.data[0],this.data[1]=(1-e)*this.data[1]+e*t.data[1],this.data[2]=(1-e)*this.data[2]+e*t.data[2],this},e.prototype.setd=function(t,e,o){return this.data[0]=t,this.data[1]=e,this.data[2]=o,this},e.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this.data[2]=t[2],this},e.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this.data[2]=t.data[2],this},e.prototype.add_d=function(t,e,o){return this.data[0]+=t,this.data[1]+=e,this.data[2]+=o,this},e.prototype.addv=function(t){return this.data[0]+=t.data[0],this.data[1]+=t.data[1],this.data[2]+=t.data[2],this},e.prototype.mulv=function(t){return this.data[0]*=t.data[0],this.data[1]*=t.data[1],this.data[2]*=t.data[2],this},e.prototype.muld=function(t,e,o){return this.data[0]*=t,this.data[1]*=e,this.data[2]*=o,this},e.prototype.subv=function(t){return this.data[0]-=t.data[0],this.data[1]-=t.data[1],this.data[2]-=t.data[2],this},e.prototype.sub_d=function(t,e,o){return this.data[0]-=t,this.data[1]-=e,this.data[2]-=o,this},e.prototype.lengthSquared=function(){return this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]},e.prototype.length=function(){return Math.sqrt(this.lengthSquared())},e.prototype.normalize=function(){var t=this.length();return 1e-7>t?(this.data[0]=0,this.data[1]=0,this.data[2]=0):(t=1/t,this.data[0]*=t,this.data[1]*=t,this.data[2]*=t),this},e.distanceSquared=function(t,e){var o=t.data[0]-e.data[0],r=t.data[1]-e.data[1],i=t.data[2]-e.data[2];return o*o+r*r+i*i},e.distance=function(t,o){return Math.sqrt(e.distanceSquared(t,o))},e.prototype.distanceSquared=function(t){return e.distanceSquared(this,t)},e.prototype.distance=function(t){return e.distance(this,t)},e}),define("goo/math/Matrix",["goo/math/MathUtils"],function(t){"use strict";function e(t,e){this.rows=t||0,this.cols=e||0,this.data=new Float32Array(this.rows*this.cols)}return e.prototype.setupAliases=function(t){for(var e=this,o=0;o<t.length;o++)!function(r){for(var i=0;i<t[r].length;i++)Object.defineProperty(e,t[r][i],{get:function(){return this.data[r]},set:function(t){this.data[r]=t}});Object.defineProperty(e,o,{get:function(){return this.data[r]},set:function(t){this.data[r]=t}})}(o)},e.add=function(t,o,r){var i=t.rows,n=t.cols;if(r||(r=new e(i,n)),o instanceof e){if(o.rows!==i||o.cols!==n||r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]+o.data[a]}else{if(r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]+o}return r},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,o,r){var i=t.rows,n=t.cols;if(r||(r=new e(i,n)),o instanceof e){if(o.rows!==i||o.cols!==n||r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]-o.data[a]}else{if(r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]-o}return r},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,o,r){var i=t.rows,n=t.cols;if(r||(r=new e(i,n)),o instanceof e){if(o.rows!==i||o.cols!==n||r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]*o.data[a]}else{if(r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]*o}return r},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,o,r){var i=t.rows,n=t.cols;if(r||(r=new e(i,n)),o instanceof e){if(o.rows!==i||o.cols!==n||r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]/o.data[a]}else{if(r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};o=1/o;for(var a=0;a<t.data.length;a++)r.data[a]=t.data[a]*o}return r},e.prototype.div=function(t){return e.div(this,t,this)},e.combine=function(t,o,r){var i=t.rows,n=o.cols,a=t.cols=o.rows;if(r||(r=new e(i,n)),t.cols!==a||o.rows!==a||r.rows!==i||r.cols!==n)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};if(r===t||r===o)return e.copy(e.combine(t,o),r);for(var s=0;n>s;s++)for(var l=s*i,h=0;i>h;h++){for(var d=0,c=0;a>c;c++)d+=t.data[c*t.rows+h]*o.data[s*o.rows+c];r.data[l+h]=d}return r},e.prototype.combine=function(t){return e.combine(this,t,this)},e.transpose=function(t,o){var r=t.cols,i=t.rows;if(o||(o=new e(r,i)),o.rows!==r||o.cols!==i)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};if(o===t)return e.copy(e.transpose(t),o);for(var n=0;i>n;n++)for(var a=n*r,s=0;r>s;s++)o.data[a+s]=t.data[s*i+n];return o},e.prototype.transpose=function(){return e.transpose(this,this)},e.copy=function(t,o){var r=t.rows,i=t.cols;if(o||(o=new e(r,i)),o.rows!==r||o.cols!==i)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return o.data.set(t.data),o},e.prototype.copy=function(t){return e.copy(t,this)},e.equals=function(e,o){if(e.rows!==o.rows||e.cols!==o.cols)return!1;for(var r=0;r<e.data.length;r++)if(Math.abs(e.data[r]-o.data[r])>t.EPSILON)return!1;return!0},e.prototype.equals=function(t){return e.equals(this,t)},e.prototype.isOrthogonal=function(){for(var e=0;e<this.cols;e++)for(var o=e+1;o<this.cols;o++){for(var r=e*this.rows,i=o*this.rows,n=0,a=0;a<this.rows;a++)n+=this.data[r+a]*this.data[i+a];if(Math.abs(n)>t.EPSILON)return!1}return!0},e.prototype.isNormal=function(){for(var e=0;e<this.cols;e++){for(var o=e*this.rows,r=0,i=0;i<this.rows;i++)r+=this.data[o+i]*this.data[o+i];if(Math.abs(r-1)>t.EPSILON)return!1}return!0},e.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},e.prototype.clone=function(){return e.copy(this)},e.prototype.set=function(){if(1===arguments.length&&"object"==typeof arguments[0])if(arguments[0]instanceof e)this.copy(arguments[0]);else for(var t=0;t<arguments[0].length;t++)this.data[t]=arguments[0][t];else for(var t=0;t<arguments.length;t++)this.data[t]=arguments[t];return this},e.prototype.toString=function(){for(var t="",e=0;e<this.cols;e++){var o=e*this.rows;t+="[";for(var r=0;r<this.rows;r++)t+=this.data[o+r],t+=r!==this.rows-1?", ":"";t+=e!==this.cols-1?"], ":"]"}return t},e}),define("goo/math/Matrix3x3",["goo/math/MathUtils","goo/math/Matrix","goo/math/Vector3"],function(t,e,o){"use strict";function r(){e.call(this,3,3),0===arguments.length?this.setIdentity():this.set(arguments),this._tempX=new o,this._tempY=new o,this._tempZ=new o}return r.prototype=Object.create(e.prototype),r.prototype.setupAliases([["e00"],["e10"],["e20"],["e01"],["e11"],["e21"],["e02"],["e12"],["e22"]]),r.IDENTITY=new r(1,0,0,0,1,0,0,0,1),r.add=function(t,e,o){o||(o=new r);var i=o.data,n=t.data;if(e instanceof r){var a=e.data;i[0]=n[0]+a[0],i[1]=n[1]+a[1],i[2]=n[2]+a[2],i[3]=n[3]+a[3],i[4]=n[4]+a[4],i[5]=n[5]+a[5],i[6]=n[6]+a[6],i[7]=n[7]+a[7],i[8]=n[8]+a[8]}else i[0]=n[0]+e,i[1]=n[1]+e,i[2]=n[2]+e,i[3]=n[3]+e,i[4]=n[4]+e,i[5]=n[5]+e,i[6]=n[6]+e,i[7]=n[7]+e,i[8]=n[8]+e;return o},r.prototype.add=function(t){return r.add(this,t,this)},r.sub=function(t,e,o){o||(o=new r);var i=o.data,n=t.data;if(e instanceof r){var a=e.data;i[0]=n[0]-a[0],i[1]=n[1]-a[1],i[2]=n[2]-a[2],i[3]=n[3]-a[3],i[4]=n[4]-a[4],i[5]=n[5]-a[5],i[6]=n[6]-a[6],i[7]=n[7]-a[7],i[8]=n[8]-a[8]}else i[0]=n[0]-e,i[1]=n[1]-e,i[2]=n[2]-e,i[3]=n[3]-e,i[4]=n[4]-e,i[5]=n[5]-e,i[6]=n[6]-e,i[7]=n[7]-e,i[8]=n[8]-e;return o},r.prototype.sub=function(t){return r.sub(this,t,this)},r.mul=function(t,e,o){o||(o=new r);var i=o.data,n=t.data;if(e instanceof r){var a=e.data;i[0]=n[0]*a[0],i[1]=n[1]*a[1],i[2]=n[2]*a[2],i[3]=n[3]*a[3],i[4]=n[4]*a[4],i[5]=n[5]*a[5],i[6]=n[6]*a[6],i[7]=n[7]*a[7],i[8]=n[8]*a[8]}else i[0]=n[0]*e,i[1]=n[1]*e,i[2]=n[2]*e,i[3]=n[3]*e,i[4]=n[4]*e,i[5]=n[5]*e,i[6]=n[6]*e,i[7]=n[7]*e,i[8]=n[8]*e;return o},r.prototype.mul=function(t){return r.mul(this,t,this)},r.div=function(t,e,o){o||(o=new r);var i=o.data,n=t.data;if(e instanceof r){var a=e.data;i[0]=n[0]/a[0],i[1]=n[1]/a[1],i[2]=n[2]/a[2],i[3]=n[3]/a[3],i[4]=n[4]/a[4],i[5]=n[5]/a[5],i[6]=n[6]/a[6],i[7]=n[7]/a[7],i[8]=n[8]/a[8]}else i[0]=n[0]/e,i[1]=n[1]/e,i[2]=n[2]/e,i[3]=n[3]/e,i[4]=n[4]/e,i[5]=n[5]/e,i[6]=n[6]/e,i[7]=n[7]/e,i[8]=n[8]/e;return o},r.prototype.div=function(t){return r.div(this,t,this)},r.combine=function(t,e,o){o||(o=new r);var i=t.data,n=i[0],a=i[3],s=i[6],l=i[1],h=i[4],d=i[7],c=i[2],u=i[5],p=i[8],m=e.data,f=m[0],g=m[3],v=m[6],y=m[1],x=m[4],w=m[7],_=m[2],b=m[5],S=m[8],M=o.data;return M[0]=n*f+a*y+s*_,M[3]=n*g+a*x+s*b,M[6]=n*v+a*w+s*S,M[1]=l*f+h*y+d*_,M[4]=l*g+h*x+d*b,M[7]=l*v+h*w+d*S,M[2]=c*f+u*y+p*_,M[5]=c*g+u*x+p*b,M[8]=c*v+u*w+p*S,o},r.prototype.combine=function(t){return r.combine(this,t,this)},r.transpose=function(t,e){e||(e=new r);var o=t.data,i=e.data;if(e===t){var n=o[3],a=o[6],s=o[7];return i[3]=o[1],i[6]=o[2],i[7]=o[5],i[1]=n,i[2]=a,i[5]=s,e}return i[0]=o[0],i[1]=o[3],i[2]=o[6],i[3]=o[1],i[4]=o[4],i[5]=o[7],i[6]=o[2],i[7]=o[5],i[8]=o[8],e},r.prototype.transpose=function(){return r.transpose(this,this)},r.invert=function(o,i){if(i||(i=new r),i===o)return e.copy(r.invert(o),i);var n=o.determinant();if(Math.abs(n)<t.EPSILON)return i;n=1/n;var a=i.data,s=o.data;return a[0]=(s[4]*s[8]-s[7]*s[5])*n,a[1]=(s[7]*s[2]-s[1]*s[8])*n,a[2]=(s[1]*s[5]-s[4]*s[2])*n,a[3]=(s[6]*s[5]-s[3]*s[8])*n,a[4]=(s[0]*s[8]-s[6]*s[2])*n,a[5]=(s[3]*s[2]-s[0]*s[5])*n,a[6]=(s[3]*s[7]-s[6]*s[4])*n,a[7]=(s[6]*s[1]-s[0]*s[7])*n,a[8]=(s[0]*s[4]-s[3]*s[1])*n,i},r.prototype.invert=function(){return r.invert(this,this)},r.prototype.isOrthogonal=function(){var e=this.data,o=e[0]*e[3]+e[1]*e[4]+e[2]*e[5];return Math.abs(o)>t.EPSILON?!1:(o=e[0]*e[6]+e[1]*e[7]+e[2]*e[8],Math.abs(o)>t.EPSILON?!1:(o=e[3]*e[6]+e[4]*e[7]+e[5]*e[8],Math.abs(o)>t.EPSILON?!1:!0))},r.prototype.isNormal=function(){var e=this.data,o=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];return Math.abs(o-1)>t.EPSILON?!1:(o=e[3]*e[3]+e[4]*e[4]+e[5]*e[5],Math.abs(o-1)>t.EPSILON?!1:(o=e[6]*e[6]+e[7]*e[7]+e[8]*e[8],Math.abs(o-1)>t.EPSILON?!1:!0))},r.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},r.prototype.determinant=function(){var t=this.data;return t[0]*(t[4]*t[8]-t[7]*t[5])-t[3]*(t[1]*t[8]-t[7]*t[2])+t[6]*(t[1]*t[5]-t[4]*t[2])},r.prototype.setIdentity=function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},r.prototype.applyPost=function(t){var e=t.data,o=this.data,r=e[0],i=e[1],n=e[2];return e[0]=o[0]*r+o[3]*i+o[6]*n,e[1]=o[1]*r+o[4]*i+o[7]*n,e[2]=o[2]*r+o[5]*i+o[8]*n,t},r.prototype.applyPre=function(t){var e=t.data,o=this.data,r=e[0],i=e[1],n=e[2];return e[0]=o[0]*r+o[1]*i+o[2]*n,e[1]=o[3]*r+o[4]*i+o[5]*n,e[2]=o[6]*r+o[7]*i+o[8]*n,t},r.prototype.multiplyDiagonalPost=function(t,e){var o=t.data[0],r=t.data[1],i=t.data[2],n=this.data,a=e.data;return a[0]=o*n[0],a[1]=o*n[1],a[2]=o*n[2],a[3]=r*n[3],a[4]=r*n[4],a[5]=r*n[5],a[6]=i*n[6],a[7]=i*n[7],a[8]=i*n[8],e},r.prototype.fromAngles=function(t,e,o){var r=Math.cos(t),i=Math.sin(t),n=Math.cos(e),a=Math.sin(e),s=Math.cos(o),l=Math.sin(o),h=this.data;return h[0]=n*s,h[3]=a*i-n*l*r,h[6]=n*l*i+a*r,h[1]=l,h[4]=s*r,h[7]=-s*i,h[2]=-a*s,h[5]=a*l*r+n*i,h[8]=-a*l*i+n*r,this},r.prototype.rotateX=function(t,e){e=e||this;var o=this.data,r=e.data,i=Math.sin(t),n=Math.cos(t),a=o[3],s=o[4],l=o[5],h=o[6],d=o[7],c=o[8];return o!==r&&(r[0]=o[0],r[1]=o[1],r[2]=o[2]),r[3]=a*n+h*i,r[4]=s*n+d*i,r[5]=l*n+c*i,r[6]=h*n-a*i,r[7]=d*n-s*i,r[8]=c*n-l*i,r},r.prototype.rotateY=function(t,e){e=e||this;var o=this.data,r=e.data,i=Math.sin(t),n=Math.cos(t),a=o[0],s=o[1],l=o[2],h=o[6],d=o[7],c=o[8];return o!==r&&(r[3]=o[3],r[4]=o[4],r[5]=o[5]),r[0]=a*n-h*i,r[1]=s*n-d*i,r[2]=l*n-c*i,r[6]=a*i+h*n,r[7]=s*i+d*n,r[8]=l*i+c*n,r},r.prototype.rotateZ=function(t,e){e=e||this;var o=this.data,r=e.data,i=Math.sin(t),n=Math.cos(t),a=o[0],s=o[1],l=o[2],h=o[3],d=o[4],c=o[5];return o!==r&&(r[6]=o[6],r[7]=o[7],r[8]=o[8]),r[0]=a*n+h*i,r[1]=s*n+d*i,r[2]=l*n+c*i,r[3]=h*n-a*i,r[4]=d*n-s*i,r[5]=c*n-l*i,r},r.prototype.toAngles=function(e){var r=e;r||(r=new o);var i=this.data,n=r.data;return i[3]>1-t.EPSILON?(n[1]=Math.atan2(i[2],i[8]),n[2]=Math.PI/2,n[0]=0):i[3]<-1+t.EPSILON?(n[1]=Math.atan2(i[2],i[8]),n[2]=-Math.PI/2,n[0]=0):(n[1]=Math.atan2(-i[2],i[0]),n[0]=Math.atan2(-i[7],i[4]),n[2]=Math.asin(i[1])),r},r.prototype.fromAngleNormalAxis=function(t,e,o,r){var i=Math.cos(t),n=Math.sin(t),a=1-i,s=e*e,l=o*o,h=r*r,d=e*o*a,c=e*r*a,u=o*r*a,p=e*n,m=o*n,f=r*n,g=this.data;return g[0]=s*a+i,g[3]=d-f,g[6]=c+m,g[1]=d+f,g[4]=l*a+i,g[7]=u-p,g[2]=c-m,g[5]=u+p,g[8]=h*a+i,this},r.prototype.lookAt=function(t,e){var r=this._tempX,i=this._tempY,n=this._tempZ;n.setv(t).normalize(),r.setv(e).cross(n).normalize(),r.equals(o.ZERO)&&(0!==n.data[0]?r.setd(n.data[1],-n.data[0],0):r.setd(0,n.data[2],-n.data[1])),i.setv(n).cross(r);var a=this.data;return a[0]=r.data[0],a[1]=r.data[1],a[2]=r.data[2],a[3]=i.data[0],a[4]=i.data[1],a[5]=i.data[2],a[6]=n.data[0],a[7]=n.data[1],a[8]=n.data[2],this},r.prototype.copyQuaternion=function(t){return t.toRotationMatrix(this)},r.prototype.copy=function(t){var e=this.data,o=t.data;return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],e[4]=o[4],e[5]=o[5],e[6]=o[6],e[7]=o[7],e[8]=o[8],this},r.prototype.clone=function(){var t=this.data;return new r(t[0],t[1],t[2],t[3],t[4],t[5],t[4],t[5],t[6])},r}),define("goo/math/Matrix4x4",["goo/math/MathUtils","goo/math/Matrix"],function(t,e){"use strict";function o(){e.call(this,4,4),0===arguments.length?this.setIdentity():this.set(arguments)}return o.prototype=Object.create(e.prototype),o.prototype.setupAliases([["e00"],["e10"],["e20"],["e30"],["e01"],["e11"],["e21"],["e31"],["e02"],["e12"],["e22"],["e32"],["e03"],["e13"],["e23"],["e33"]]),o.IDENTITY=new o(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),o.add=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00+e.e00,r.e10=t.e10+e.e10,r.e20=t.e20+e.e20,r.e30=t.e30+e.e30,r.e01=t.e01+e.e01,r.e11=t.e11+e.e11,r.e21=t.e21+e.e21,r.e31=t.e31+e.e31,r.e02=t.e02+e.e02,r.e12=t.e12+e.e12,r.e22=t.e22+e.e22,r.e32=t.e32+e.e32,r.e03=t.e03+e.e03,r.e13=t.e13+e.e13,r.e23=t.e23+e.e23,r.e33=t.e33+e.e33):(r.e00=t.e00+e,r.e10=t.e10+e,r.e20=t.e20+e,r.e30=t.e30+e,r.e01=t.e01+e,r.e11=t.e11+e,r.e21=t.e21+e,r.e31=t.e31+e,r.e02=t.e02+e,r.e12=t.e12+e,r.e22=t.e22+e,r.e32=t.e32+e,r.e03=t.e03+e,r.e13=t.e13+e,r.e23=t.e23+e,r.e33=t.e33+e),r},o.prototype.add=function(t){return o.add(this,t,this)},o.sub=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00-e.e00,r.e10=t.e10-e.e10,r.e20=t.e20-e.e20,r.e30=t.e30-e.e30,r.e01=t.e01-e.e01,r.e11=t.e11-e.e11,r.e21=t.e21-e.e21,r.e31=t.e31-e.e31,r.e02=t.e02-e.e02,r.e12=t.e12-e.e12,r.e22=t.e22-e.e22,r.e32=t.e32-e.e32,r.e03=t.e03-e.e03,r.e13=t.e13-e.e13,r.e23=t.e23-e.e23,r.e33=t.e33-e.e33):(r.e00=t.e00-e,r.e10=t.e10-e,r.e20=t.e20-e,r.e30=t.e30-e,r.e01=t.e01-e,r.e11=t.e11-e,r.e21=t.e21-e,r.e31=t.e31-e,r.e02=t.e02-e,r.e12=t.e12-e,r.e22=t.e22-e,r.e32=t.e32-e,r.e03=t.e03-e,r.e13=t.e13-e,r.e23=t.e23-e,r.e33=t.e33-e),r},o.prototype.sub=function(t){return o.sub(this,t,this)},o.mul=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00*e.e00,r.e10=t.e10*e.e10,r.e20=t.e20*e.e20,r.e30=t.e30*e.e30,r.e01=t.e01*e.e01,r.e11=t.e11*e.e11,r.e21=t.e21*e.e21,r.e31=t.e31*e.e31,r.e02=t.e02*e.e02,r.e12=t.e12*e.e12,r.e22=t.e22*e.e22,r.e32=t.e32*e.e32,r.e03=t.e03*e.e03,r.e13=t.e13*e.e13,r.e23=t.e23*e.e23,r.e33=t.e33*e.e33):(r.e00=t.e00*e,r.e10=t.e10*e,r.e20=t.e20*e,r.e30=t.e30*e,r.e01=t.e01*e,r.e11=t.e11*e,r.e21=t.e21*e,r.e31=t.e31*e,r.e02=t.e02*e,r.e12=t.e12*e,r.e22=t.e22*e,r.e32=t.e32*e,r.e03=t.e03*e,r.e13=t.e13*e,r.e23=t.e23*e,r.e33=t.e33*e),r},o.prototype.mul=function(t){return o.mul(this,t,this)},o.div=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00/e.e00,r.e10=t.e10/e.e10,r.e20=t.e20/e.e20,r.e30=t.e30/e.e30,r.e01=t.e01/e.e01,r.e11=t.e11/e.e11,r.e21=t.e21/e.e21,r.e31=t.e31/e.e31,r.e02=t.e02/e.e02,r.e12=t.e12/e.e12,r.e22=t.e22/e.e22,r.e32=t.e32/e.e32,r.e03=t.e03/e.e03,r.e13=t.e13/e.e13,r.e23=t.e23/e.e23,r.e33=t.e33/e.e33):(e=1/e,r.e00=t.e00*e,r.e10=t.e10*e,r.e20=t.e20*e,r.e30=t.e30*e,r.e01=t.e01*e,r.e11=t.e11*e,r.e21=t.e21*e,r.e31=t.e31*e,r.e02=t.e02*e,r.e12=t.e12*e,r.e22=t.e22*e,r.e32=t.e32*e,r.e03=t.e03*e,r.e13=t.e13*e,r.e23=t.e23*e,r.e33=t.e33*e),r},o.prototype.div=function(t){return o.div(this,t,this)},o.combine=function(t,e,r){r||(r=new o);var i=t.data,n=i[0],a=i[4],s=i[8],l=i[12],h=i[1],d=i[5],c=i[9],u=i[13],p=i[2],m=i[6],f=i[10],g=i[14],v=i[3],y=i[7],x=i[11],w=i[15],_=e.data,b=_[0],S=_[4],M=_[8],C=_[12],P=_[1],T=_[5],E=_[9],D=_[13],A=_[2],R=_[6],I=_[10],O=_[14],L=_[3],N=_[7],F=_[11],B=_[15],k=r.data;return k[0]=n*b+a*P+s*A+l*L,k[4]=n*S+a*T+s*R+l*N,k[8]=n*M+a*E+s*I+l*F,k[12]=n*C+a*D+s*O+l*B,k[1]=h*b+d*P+c*A+u*L,k[5]=h*S+d*T+c*R+u*N,k[9]=h*M+d*E+c*I+u*F,k[13]=h*C+d*D+c*O+u*B,k[2]=p*b+m*P+f*A+g*L,k[6]=p*S+m*T+f*R+g*N,k[10]=p*M+m*E+f*I+g*F,k[14]=p*C+m*D+f*O+g*B,k[3]=v*b+y*P+x*A+w*L,k[7]=v*S+y*T+x*R+w*N,k[11]=v*M+y*E+x*I+w*F,k[15]=v*C+y*D+x*O+w*B,r},o.prototype.combine=function(t){return o.combine(this,t,this)},o.transpose=function(t,e){e||(e=new o);var r=t.data,i=e.data;if(e===t){var n=r[4],a=r[8],s=r[12],l=r[9],h=r[13],d=r[14];return i[4]=r[1],i[8]=r[2],i[12]=r[3],i[9]=r[6],i[13]=r[7],i[14]=r[11],i[1]=n,i[2]=a,i[3]=s,i[6]=l,i[7]=h,i[11]=d,e}return i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15],e},o.prototype.transpose=function(){return o.transpose(this,this)},o.invert=function(r,i){if(i||(i=new o),i===r)return e.copy(o.invert(r),i);var n=r.determinant();if(Math.abs(n)<t.EPSILON)return i;var a=r.data,s=i.data;return n=1/n,s[0]=(a[5]*(a[10]*a[15]-a[14]*a[11])-a[9]*(a[6]*a[15]-a[14]*a[7])+a[13]*(a[6]*a[11]-a[10]*a[7]))*n,s[1]=(a[1]*(a[14]*a[11]-a[10]*a[15])-a[9]*(a[14]*a[3]-a[2]*a[15])+a[13]*(a[10]*a[3]-a[2]*a[11]))*n,s[2]=(a[1]*(a[6]*a[15]-a[14]*a[7])-a[5]*(a[2]*a[15]-a[14]*a[3])+a[13]*(a[2]*a[7]-a[6]*a[3]))*n,s[3]=(a[1]*(a[10]*a[7]-a[6]*a[11])-a[5]*(a[10]*a[3]-a[2]*a[11])+a[9]*(a[6]*a[3]-a[2]*a[7]))*n,s[4]=(a[4]*(a[14]*a[11]-a[10]*a[15])-a[8]*(a[14]*a[7]-a[6]*a[15])+a[12]*(a[10]*a[7]-a[6]*a[11]))*n,s[5]=(a[0]*(a[10]*a[15]-a[14]*a[11])-a[8]*(a[2]*a[15]-a[14]*a[3])+a[12]*(a[2]*a[11]-a[10]*a[3]))*n,s[6]=(a[0]*(a[14]*a[7]-a[6]*a[15])-a[4]*(a[14]*a[3]-a[2]*a[15])+a[12]*(a[6]*a[3]-a[2]*a[7]))*n,s[7]=(a[0]*(a[6]*a[11]-a[10]*a[7])-a[4]*(a[2]*a[11]-a[10]*a[3])+a[8]*(a[2]*a[7]-a[6]*a[3]))*n,s[8]=(a[4]*(a[9]*a[15]-a[13]*a[11])-a[8]*(a[5]*a[15]-a[13]*a[7])+a[12]*(a[5]*a[11]-a[9]*a[7]))*n,s[9]=(a[0]*(a[13]*a[11]-a[9]*a[15])-a[8]*(a[13]*a[3]-a[1]*a[15])+a[12]*(a[9]*a[3]-a[1]*a[11]))*n,s[10]=(a[0]*(a[5]*a[15]-a[13]*a[7])-a[4]*(a[1]*a[15]-a[13]*a[3])+a[12]*(a[1]*a[7]-a[5]*a[3]))*n,s[11]=(a[0]*(a[9]*a[7]-a[5]*a[11])-a[4]*(a[9]*a[3]-a[1]*a[11])+a[8]*(a[5]*a[3]-a[1]*a[7]))*n,s[12]=(a[4]*(a[13]*a[10]-a[9]*a[14])-a[8]*(a[13]*a[6]-a[5]*a[14])+a[12]*(a[9]*a[6]-a[5]*a[10]))*n,s[13]=(a[0]*(a[9]*a[14]-a[13]*a[10])-a[8]*(a[1]*a[14]-a[13]*a[2])+a[12]*(a[1]*a[10]-a[9]*a[2]))*n,s[14]=(a[0]*(a[13]*a[6]-a[5]*a[14])-a[4]*(a[13]*a[2]-a[1]*a[14])+a[12]*(a[5]*a[2]-a[1]*a[6]))*n,s[15]=(a[0]*(a[5]*a[10]-a[9]*a[6])-a[4]*(a[1]*a[10]-a[9]*a[2])+a[8]*(a[1]*a[6]-a[5]*a[2]))*n,i},o.prototype.invert=function(){return o.invert(this,this)},o.prototype.isOrthogonal=function(){var e;return e=this.e00*this.e01+this.e10*this.e11+this.e20*this.e21+this.e30*this.e31,Math.abs(e)>t.EPSILON?!1:(e=this.e00*this.e02+this.e10*this.e12+this.e20*this.e22+this.e30*this.e32,Math.abs(e)>t.EPSILON?!1:(e=this.e00*this.e03+this.e10*this.e13+this.e20*this.e23+this.e30*this.e33,Math.abs(e)>t.EPSILON?!1:(e=this.e01*this.e02+this.e11*this.e12+this.e21*this.e22+this.e31*this.e32,Math.abs(e)>t.EPSILON?!1:(e=this.e01*this.e03+this.e11*this.e13+this.e21*this.e23+this.e31*this.e33,Math.abs(e)>t.EPSILON?!1:(e=this.e02*this.e03+this.e12*this.e13+this.e22*this.e23+this.e32*this.e33,Math.abs(e)>t.EPSILON?!1:!0)))))},o.prototype.isNormal=function(){var e;return e=this.e00*this.e00+this.e10*this.e10+this.e20*this.e20+this.e30*this.e30,Math.abs(e-1)>t.EPSILON?!1:(e=this.e01*this.e01+this.e11*this.e11+this.e21*this.e21+this.e31*this.e31,Math.abs(e-1)>t.EPSILON?!1:(e=this.e02*this.e02+this.e12*this.e12+this.e22*this.e22+this.e32*this.e32,Math.abs(e-1)>t.EPSILON?!1:(e=this.e03*this.e03+this.e13*this.e13+this.e23*this.e23+this.e33*this.e33,Math.abs(e-1)>t.EPSILON?!1:!0)))},o.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},o.prototype.determinant=function(){var t=this.data,e=t[5]*t[10]*t[15]+t[9]*t[14]*t[7]+t[13]*t[6]*t[11]-t[13]*t[10]*t[7]-t[9]*t[6]*t[15]-t[5]*t[14]*t[11],o=t[1]*t[10]*t[15]+t[9]*t[14]*t[3]+t[13]*t[2]*t[11]-t[13]*t[10]*t[3]-t[9]*t[2]*t[15]-t[1]*t[14]*t[11],r=t[1]*t[6]*t[15]+t[5]*t[14]*t[3]+t[13]*t[2]*t[7]-t[13]*t[6]*t[3]-t[5]*t[2]*t[15]-t[1]*t[14]*t[7],i=t[1]*t[6]*t[11]+t[5]*t[10]*t[3]+t[9]*t[2]*t[7]-t[9]*t[6]*t[3]-t[5]*t[2]*t[11]-t[1]*t[10]*t[7];return t[0]*e-t[4]*o+t[8]*r-t[12]*i},o.prototype.setIdentity=function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},o.prototype.setRotationFromVector=function(t){var e=Math.sin(t.x),o=Math.cos(t.x),r=Math.sin(t.y),i=Math.cos(t.y),n=Math.sin(t.z),a=Math.cos(t.z);return this.e00=a*i,this.e10=n*i,this.e20=0-r,this.e01=a*r*e-n*o,this.e11=n*r*e+a*o,this.e21=i*e,this.e02=a*r*o+n*e,this.e12=n*r*o-a*e,this.e22=i*o,this},o.prototype.setRotationFromQuaternion=function(t){var e=t.lengthSquared();e=e>0?2/e:0;var o=t.x*e,r=t.y*e,i=t.z*e,n=t.w*o,a=t.w*r,s=t.w*i,l=t.x*o,h=t.x*r,d=t.x*i,c=t.y*r,u=t.y*i,p=t.z*i;return this.e00=1-c-p,this.e10=h+s,this.e20=d-a,this.e01=h-s,this.e11=1-l-p,this.e21=u+n,this.e02=d+a,this.e12=u-n,this.e22=1-l-c,this},o.prototype.setTranslation=function(t){return this.e03=t.x,this.e13=t.y,this.e23=t.z,this},o.prototype.getTranslation=function(t){return t.x=this.data[12],t.y=this.data[13],t.z=this.data[14],this},o.prototype.getScale=function(t){var e=Math.sqrt(t.setd(this.data[0],this.data[4],this.data[8]).lengthSquared()),o=Math.sqrt(t.setd(this.data[1],this.data[5],this.data[9]).lengthSquared()),r=Math.sqrt(t.setd(this.data[2],this.data[6],this.data[10]).lengthSquared());return t.x=e,t.y=o,t.z=r,this},o.prototype.setScale=function(t){return this.e00*=t.x,this.e10*=t.y,this.e20*=t.z,this.e01*=t.x,this.e11*=t.y,this.e21*=t.z,this.e02*=t.x,this.e12*=t.y,this.e22*=t.z,this},o.prototype.applyPre=function(t){var e=t.data[0],o=t.data[1],r=t.data[2],i=t.data[3],n=this.data;return t.data[0]=n[0]*e+n[1]*o+n[2]*r+n[3]*i,t.data[1]=n[4]*e+n[5]*o+n[6]*r+n[7]*i,t.data[2]=n[8]*e+n[9]*o+n[10]*r+n[11]*i,t.data[3]=n[12]*e+n[13]*o+n[14]*r+n[15]*i,t
},o.prototype.applyPost=function(t){var e=t.data[0],o=t.data[1],r=t.data[2],i=t.data[3],n=this.data;return t.data[0]=n[0]*e+n[4]*o+n[8]*r+n[12]*i,t.data[1]=n[1]*e+n[5]*o+n[9]*r+n[13]*i,t.data[2]=n[2]*e+n[6]*o+n[10]*r+n[14]*i,t.data[3]=n[3]*e+n[7]*o+n[11]*r+n[15]*i,t},o.prototype.applyPostPoint=function(t){var e=t.data[0],o=t.data[1],r=t.data[2],i=this.data;return t.data[0]=i[0]*e+i[4]*o+i[8]*r+i[12],t.data[1]=i[1]*e+i[5]*o+i[9]*r+i[13],t.data[2]=i[2]*e+i[6]*o+i[10]*r+i[14],t},o.prototype.applyPostVector=function(t){var e=t.x,o=t.y,r=t.z,i=this.data;return t.x=i[0]*e+i[4]*o+i[8]*r,t.y=i[1]*e+i[5]*o+i[9]*r,t.z=i[2]*e+i[6]*o+i[10]*r,t},o.prototype.copy=function(t){var e=this.data,o=t.data;return e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3],e[4]=o[4],e[5]=o[5],e[6]=o[6],e[7]=o[7],e[8]=o[8],e[9]=o[9],e[10]=o[10],e[11]=o[11],e[12]=o[12],e[13]=o[13],e[14]=o[14],e[15]=o[15],this},o.prototype.clone=function(){var t=this.data;return new o(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])},o}),define("goo/math/Transform",["goo/math/Vector3","goo/math/Matrix3x3","goo/math/Matrix4x4"],function(t,e,o){"use strict";function r(){this.matrix=new o,this.normalMatrix=new o,this.translation=new t,this.rotation=new e,this.scale=new t(1,1,1),this.tmpVec=new t,this.tmpVec2=new t,this.tmpMat1=new e}return r.combine=function(t,o,i){if(t.scale.data[0]!==t.scale.data[1]||t.scale.data[0]!==t.scale.data[2])throw{name:"NonUniformScaleException",message:"Non-uniform scaling in left hand transform, cannot resolve combined transform"};i=i||new r;var n=i.tmpVec;n.setv(o.translation),t.rotation.applyPost(n),n.mulv(t.scale),n.addv(t.translation);var a=i.tmpVec2;a.setv(o.scale),a.mulv(t.scale);var s=i.tmpMat1;return e.combine(t.rotation,o.rotation,s),i.rotation.copy(s),i.scale.setv(a),i.translation.setv(n),i.update(),i},r.prototype.combine=function(t){return r.combine(this,t,this)},r.prototype.multiply=function(t,r){o.combine(t.matrix,r.matrix,this.matrix),this.tmpMat1.data.set(t.rotation.data),this.rotation.data.set(r.rotation.data),e.combine(this.tmpMat1,this.rotation,this.rotation),this.translation.setv(r.translation),this.translation.mulv(t.scale),this.tmpMat1.applyPost(this.translation).addv(t.translation),this.scale.setv(t.scale).mulv(r.scale)},r.prototype.setIdentity=function(){this.matrix.setIdentity(),this.translation.setv(t.ZERO),this.rotation.setIdentity(),this.scale.setv(t.ONE)},r.prototype.applyForward=function(t,e){return e.setv(t),this.matrix.applyPostPoint(e),e},r.prototype.applyForwardVector=function(t,e){return e.copy(t),e.set(e.x*this.scale.x,e.y*this.scale.y,e.z*this.scale.z),this.rotation.applyPost(e),e},r.prototype.update=function(){var t=this.matrix.data,e=this.rotation.data,o=this.scale.data,r=this.translation.data;t[0]=o[0]*e[0],t[1]=o[0]*e[1],t[2]=o[0]*e[2],t[3]=0,t[4]=o[1]*e[3],t[5]=o[1]*e[4],t[6]=o[1]*e[5],t[7]=0,t[8]=o[2]*e[6],t[9]=o[2]*e[7],t[10]=o[2]*e[8],t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1},r.prototype.copy=function(t){this.matrix.copy(t.matrix),this.translation.setv(t.translation),this.rotation.copy(t.rotation),this.scale.setv(t.scale)},r.prototype.setRotationXYZ=function(t,e,o){this.rotation.fromAngles(t,e,o)},r.prototype.lookAt=function(e,o){o||(o=t.UNIT_Y),this.tmpVec.setv(this.translation).subv(e).normalize(),this.rotation.lookAt(this.tmpVec,o)},r.prototype.invert=function(t){var e=t;e||(e=new r),e.matrix.copy(this.matrix),e.matrix.invert();var o=e.rotation.copy(this.rotation);return o.multiplyDiagonalPost(this.scale,o).invert(),e.translation.copy(this.translation),e.rotation.applyPost(e.translation).invert(),e},r.prototype.toString=function(){return""+this.matrix},r}),define("goo/entities/components/Component",[],function(){"use strict";function t(){this.enabled=!0,this.installedAPI={}}return t.prototype.applyAPI=function(t){this.installedAPI||(this.installedAPI={});var e=this.api;for(var o in e)"undefined"==typeof t[o]?(t[o]=e[o],this.installedAPI[o]=!0):console.warn("Could not install method "+o+" of "+this.type+" as it is already taken")},t.prototype.removeAPI=function(t){var e=this.installedAPI;for(var o in e)delete t[o]},t}),define("goo/entities/Selection",[],function(){"use strict";function t(){if(this.stack=[],1===arguments.length){var o=arguments[0];o instanceof t?o.top&&this.stack.push(o.top):this.stack.push(Array.isArray(o)?o:[o])}else arguments.length>1&&this.stack.push(Array.prototype.slice.call(arguments,0));this.stack.length>0&&(this.stack[0]=e(this.stack[0])),this.top=0===this.stack.length?null:this.stack[0]}function e(t){for(var e=[],o=0;o<t.length;o++){var r=t[o];t.lastIndexOf(r)===o&&e.push(r)}return e}function o(){if(1===arguments.length){var e=arguments[0];return e instanceof t?e.top?e.top:[]:Array.isArray(e)?e:[e]}return arguments.length>1?Array.prototype.slice.call(arguments,0):[]}return t.EMPTY=new t,t.prototype.contains=function(t){return null===this.top?!1:-1!==this.top.indexOf(t)},t.prototype.size=function(){return null===this.top?0:this.top.length},t.prototype.each=function(t){if(null===this.top)return this;for(var e=0;e<this.top.length&&t(this.top[e])!==!1;e++);return this},t.prototype.filter=function(t){if(null===this.top)return this;var e=this.top.filter(t);return this.stack.push(e),this.top=e,this},t.prototype.map=function(t){if(null===this.top)return this;var e=this.top.map(t);return this.stack.push(e),this.top=e,this},t.prototype.flatMap=function(t){if(null===this.top)return this;var e=this.top.map(t),o=e.reduce(function(t,e){return t.concat(e)},[]);return this.stack.push(o),this.top=o,this},t.prototype.reduce=function(t,e){if(null===this.top)return this;var o=[this.top.reduce(t,e)];return this.stack.push(o),this.top=o,this},t.prototype.and=function(){if(null===this.top)return this;var t=o.apply(null,arguments),r=this.top.concat(t);return r=e(r),this.stack.push(r),this.top=r,this},t.prototype.intersects=function(t){if(null===this.top)return this;var e,r,t=o.apply(null,arguments),i=[];t.length>this.top.length?(e=this.top,r=t):(e=t,r=this.top);for(var n=0;n<e.length;n++){var a=e[n];-1!==r.indexOf(a)&&i.push(a)}return this.stack.push(i),this.top=i,this},t.prototype.without=function(){if(null===this.top)return this;for(var t=o.apply(null,arguments),e=[],r=0;r<this.top.length;r++){var i=this.top[r];-1===t.indexOf(i)&&e.push(i)}return this.stack.push(e),this.top=e,this},t.prototype.andSelf=function(){if(null===this.top)return this;if(this.stack.length<=1)return this;var t=this.stack[this.stack.length-2],o=t.concat(this.top);return o=e(o),this.stack.push(o),this.top=o,this},t.prototype.end=function(){return null===this.top?this:(this.stack.pop(),this.top=0===this.stack.length?null:this.stack[this.stack.length-1],this)},t.prototype.first=function(){return null===this.top?null:this.top[0]},t.prototype.clone=function(){var e=new t;return e.top=this.top,e.stack=this.stack.concat([]),e},t.prototype.get=function(t){return"number"!=typeof t?null===this.top?[]:this.top.concat([]):0>t?null===this.top?void 0:this.top[this.top.length+t]:null===this.top?void 0:this.top[t]},t.prototype.toArray=function(){return null===this.top?[]:this.top.concat([])},t}),define("goo/entities/EntitySelection",["goo/entities/Selection"],function(t){"use strict";function e(){t.apply(this,arguments)}function o(){if(1===arguments.length){var t=arguments[0];return t instanceof e?t.top?t.top:[]:Array.isArray(t)?t:[t]}return arguments.length>1?Array.prototype.slice.call(arguments,0):[]}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.and=function(t){if(null===this.top)return this;var e,r,i,t=o.apply(null,arguments);t.length>this.top.length?(r=this.top,i=t):(r=t,i=this.top);for(var n=[],a=0;a<i.length;a++){var s=i[a].id;n[s]=!0}e=i.concat([]);for(var a=0;a<r.length;a++)n[r[a].id]||e.push(r[a]);return this.stack.push(e),this.top=e,this},e.prototype.intersects=function(t){if(null===this.top)return this;var e,r,i,t=o.apply(null,arguments);t.length>this.top.length?(r=this.top,i=t):(r=t,i=this.top);for(var n=[],a=0;a<i.length;a++){var s=i[a].id;n[s]=!0}e=[];for(var a=0;a<r.length;a++)n[r[a].id]&&e.push(r[a]);return this.stack.push(e),this.top=e,this},e.prototype.without=function(){if(null===this.top)return this;for(var t,e=o.apply(null,arguments),r=[],i=0;i<e.length;i++){var n=e[i].id;r[n]=!0}t=[];for(var i=0;i<this.top.length;i++)r[this.top[i].id]||t.push(this.top[i]);return this.stack.push(t),this.top=t,this},e.prototype.andSelf=function(){if(null===this.top)return this;if(this.stack.length<=1)return this;var t=this.stack[this.stack.length-2];return this.and.apply(this,t)},e.prototype.parent=function(){if(null===this.top)return this;var t=[],e=this.top.filter(function(e){return e.transformComponent.parent?t[e.transformComponent.parent.entity.id]?!1:(t[e.transformComponent.parent.entity.id]=!0,!0):!1}).map(function(t){return t.transformComponent.parent.entity});return this.stack.push(e),this.top=e,this},e.prototype.children=function(){if(null===this.top)return this;var t=this.top.map(function(t){return t.transformComponent.children.map(function(t){return t.entity})}),e=t.reduce(function(t,e){return t.concat(e)},[]);return this.stack.push(e),this.top=e,this},e}),define("goo/entities/components/TransformComponent",["goo/math/Transform","goo/math/Vector3","goo/entities/components/Component","goo/entities/EntitySelection","goo/math/Matrix4x4"],function(t,e,o,r,i){"use strict";function n(){this.type="TransformComponent",this.entity=null,this.parent=null,this.children=[],this.transform=new t,this.worldTransform=new t,this._dirty=!0,this._updated=!1,this.api={getTranslation:function(){return n.prototype.getTranslation.apply(this,arguments)}.bind(this),setTranslation:function(){return n.prototype.setTranslation.apply(this,arguments),this.entity}.bind(this),getScale:function(){return n.prototype.getScale.apply(this,arguments)}.bind(this),setScale:function(){return n.prototype.setScale.apply(this,arguments),this.entity}.bind(this),addTranslation:function(){return n.prototype.addTranslation.apply(this,arguments),this.entity}.bind(this),getRotation:function(){return n.prototype.getRotation.apply(this,arguments)}.bind(this),addRotation:function(){return n.prototype.addRotation.apply(this,arguments),this.entity}.bind(this),setRotation:function(){return n.prototype.setRotation.apply(this,arguments),this.entity}.bind(this),lookAt:function(){return n.prototype.lookAt.apply(this,arguments),this.entity}.bind(this),attachChild:function(t){return this.attachChild(t.transformComponent),this.entity}.bind(this),detachChild:function(t){return this.detachChild(t.transformComponent),this.entity}.bind(this),children:function(){return new r(this.entity).children()}.bind(this),parent:function(){return new r(this.entity).parent()}.bind(this),traverse:function(t,e){if(e=void 0!==e?e:0,t(this.entity,e)!==!1)for(var o=0;o<this.children.length;o++){var r=this.children[o].entity;r.traverse(t,e+1)}return this.entity}.bind(this),traverseUp:function(t){for(var e=this;t(e.entity)!==!1&&e.parent;)e=e.parent;return this.entity}.bind(this)}}return n.type="TransformComponent",n.prototype=Object.create(o.prototype),n.prototype.constructor=n,n.prototype.getTranslation=function(){return this.transform.translation},n.prototype.setTranslation=function(){return this.transform.translation.set(arguments),this._dirty=!0,this},n.prototype.getScale=function(){return this.transform.scale},n.prototype.setScale=function(){return this.transform.scale.set(arguments),this._dirty=!0,this},n.prototype.addTranslation=function(){return this.transform.translation.add(3===arguments.length?arguments:arguments[0]),this._dirty=!0,this},n.prototype.getRotation=function(t){return this.tmpRotVec=this.tmpRotVec||new e,t=t||this.tmpRotVec,this.transform.rotation.toAngles(t)},n.prototype.addRotation=function(){if(this.tmpVec=this.tmpVec||new e,this.getRotation(this.tmpVec),1===arguments.length&&"object"==typeof arguments[0]){var t=arguments[0];t instanceof e?this.transform.rotation.fromAngles(this.tmpVec.x+t.x,this.tmpVec.y+t.y,this.tmpVec.z+t.z):3===t.length&&this.transform.rotation.fromAngles(this.tmpVec.x+t[0],this.tmpVec.y+t[1],this.tmpVec.z+t[2])}else this.transform.rotation.fromAngles(this.tmpVec.x+arguments[0],this.tmpVec.y+arguments[1],this.tmpVec.z+arguments[2]);return this._dirty=!0,this},n.prototype.setRotation=function(){if(1===arguments.length&&"object"==typeof arguments[0]){var t=arguments[0];t instanceof e?this.transform.rotation.fromAngles(t.x,t.y,t.z):3===t.length&&this.transform.rotation.fromAngles(t[0],t[1],t[2])}else this.transform.rotation.fromAngles(arguments[0],arguments[1],arguments[2]);return this._dirty=!0,this},n.prototype.lookAt=function(t,o){return 3===arguments.length?this.transform.lookAt(new e(arguments[0],arguments[1],arguments[2])):(Array.isArray(t)&&(t=new e(t)),Array.isArray(o)&&(o=new e(o)),this.transform.lookAt(t,o)),this._dirty=!0,this},n.prototype.setUpdated=function(){this._dirty=!0},n.prototype.attached=function(t){this.entity=t},n.prototype.detached=function(){this.entity=void 0},n.prototype.attachChild=function(t,e){for(var o=this;o;){if(o===t)return void console.warn("attachChild: An object can't be added as a descendant of itself.");o=o.parent}t.parent&&t.parent.detachChild(t),e&&(t.updateTransform(),this.updateTransform(),this.updateWorldTransform(),t.transform.multiply(this.worldTransform.invert(),t.transform)),t.parent=this,this.children.push(t)},n.prototype.detachChild=function(t,e){if(t===this)return void console.warn("attachChild: An object can't be removed from itself.");e&&t.transform.copy(t.worldTransform);var o=this.children.indexOf(t);-1!==o&&(t.parent=null,this.children.splice(o,1))},n.prototype.updateTransform=function(){this.transform.update()},n.prototype.updateWorldTransform=function(){this.parent?this.worldTransform.multiply(this.parent.worldTransform,this.transform):this.worldTransform.copy(this.transform),i.invert(this.worldTransform.matrix,this.worldTransform.normalMatrix),i.transpose(this.worldTransform.normalMatrix,this.worldTransform.normalMatrix),this._dirty=!1,this._updated=!0},n.applyOnEntity=function(o,r){var i=r.transformComponent;i||(i=new n);var a=!1;return Array.isArray(o)&&3===o.length?(i.transform.translation.setd(o[0],o[1],o[2]),a=!0):o instanceof e?(i.transform.translation.setd(o.data[0],o.data[1],o.data[2]),a=!0):"object"==typeof o&&"undefined"!=typeof o.x&&"undefined"!=typeof o.y&&"undefined"!=typeof o.z?(i.transform.translation.setd(o.x,o.y,o.z),a=!0):o instanceof t&&(i.transform=o,a=!0),a?(r.setComponent(i),!0):void 0},n}),define("goo/renderer/bounds/BoundingVolume",["goo/math/Vector3"],function(t){"use strict";function e(e){this.center=new t,e&&this.center.setv(e),this.min=new t(1/0,1/0,1/0),this.max=new t(-1/0,-1/0,-1/0)}return e.Outside=0,e.Inside=1,e.Intersects=2,e}),define("goo/renderer/BufferData",[],function(){"use strict";function t(t,e){this.data=t,this.target=e,this.glBuffer=null,this._dataUsage="StaticDraw",this._dataNeedsRefresh=!1}return t.prototype.setDataUsage=function(t){this._dataUsage=t},t.prototype.setDataNeedsRefresh=function(){this._dataNeedsRefresh=!0},t.prototype.destroy=function(t){t.deleteBuffer(this.glBuffer)},t}),define("goo/renderer/Util",[],function(){"use strict";function t(){}return t.getByteSize=function(t){switch(t){case"Byte":return 1;case"UnsignedByte":return 1;case"Short":return 2;case"UnsignedShort":return 2;case"Int":return 4;case"HalfFloat":return 2;case"Float":return 4;case"Double":return 8;default:throw"Unknown type: "+t}},t.checkGLError=function(t){for(var e=t.getError(),o=!1;e!==t.NO_ERROR;){if(o=!0,e===t.INVALID_ENUM)console.error("An unacceptable value is specified for an enumerated argument. The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.INVALID_VALUE)console.error("A numeric argument is out of range. The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.INVALID_OPERATION)console.error("The specified operation is not allowed in the current state. The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.FRAMEBUFFER_COMPLETE)console.error("The command is trying to render to or read from the framebuffer while the currently bound framebuffer is not framebuffer complete (i.e. the return value from glCheckFramebufferStatus is not GL_FRAMEBUFFER_COMPLETE). The offending command is ignored and has no other side effect than to set the error flag.");else if(e===t.OUT_OF_MEMORY)throw"There is not enough memory left to execute the command. The state of the GL is undefined, except for the state of the error flags, after this error is recorded.";e=t.getError()}if(o)throw"Stopping due to error"},t.isPowerOfTwo=function(t){return 0===(t&t-1)},t.nearestPowerOfTwo=function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.log(2)))},t.clone=function(e){if(null===e||"object"!=typeof e)return e;if(e instanceof Uint8Array)return e;if(e instanceof Date){var o=new Date;return o.setTime(e.getTime()),o}if(e instanceof Array){for(var o=[],r=0,i=e.length;i>r;++r)o[r]=t.clone(e[r]);return o}if(e instanceof Object){var o={};for(var n in e)e.hasOwnProperty(n)&&(o[n]=t.clone(e[n]));return o}throw new Error("Unable to copy obj! Its type isn't supported.")},t._blankImages={},t.getBlankImage=function(e,o,r,i,n,a){var s=t.nearestPowerOfTwo(r),l=t.nearestPowerOfTwo(i);s=Math.min(s,n),l=Math.min(l,n);var h=4===o.length?"rgba("+Number(255*o[0]).toFixed(0)+","+Number(255*o[1]).toFixed(0)+","+Number(255*o[2]).toFixed(0)+","+Number(o[3]).toFixed(2)+")":"rgb("+Number(255*o[0]).toFixed(0)+","+Number(255*o[1]).toFixed(0)+","+Number(255*o[2]).toFixed(0)+")",d=h+s+"x"+l,c=t._blankImages[d];if(!c){c=document.createElement("canvas"),c.width=s,c.height=l;var u=c.getContext("2d");u.beginPath(),u.rect(0,0,s,l),u.fillStyle=h,u.fill(),t._blankImages[d]=c}void 0===a?e.image=c:(e.image.isData=!1,e.image.data[a]=c)},t.scaleImage=function(e,o,r,i,n,a){var s=t.nearestPowerOfTwo(r),l=t.nearestPowerOfTwo(i);if(s=Math.min(s,n),l=Math.min(l,n),o.width!==s||o.height!==l){var h=document.createElement("canvas");h.width=s,h.height=l,o.getAttribute&&h.setAttribute("data-ref",o.getAttribute("data-ref"));var d=h.getContext("2d");d.drawImage(o,0,0,o.width,o.height,0,0,s,l),h.dataReady=!0,h.src=o.src,void 0===a?e.image=h:e.image.data[a]=h}},t}),define("goo/renderer/BufferUtils",[],function(){"use strict";function t(){}function e(){var e=["Trident","MSIE","Firefox","Safari","Chrome","Opera"],o=navigator.userAgent,r=e.length-1;for(r;r>-1&&-1===o.indexOf(e[r]);r--);t.browserType=e[r]}return t.createIndexBuffer=function(e,o){var r;if(256>=o)r="Trident"===t.browserType?new Uint16Array(e):new Uint8Array(e);else{if(!(65536>=o))throw new Error("Maximum number of vertices is 65536. Got: "+o);r=new Uint16Array(e)}return r},e(),t}),define("goo/math/Vector2",["goo/math/Vector"],function(t){"use strict";function e(){t.call(this,2),0!==arguments.length?this.set(arguments):this.setd(0,0)}return e.prototype=Object.create(t.prototype),e.prototype.setupAliases([["x","u","s"],["y","v","t"]]),e.ZERO=new e(0,0),e.ONE=new e(1,1),e.UNIT_X=new e(1,0),e.UNIT_Y=new e(0,1),e.add=function(t,o,r){"number"==typeof t&&(t=[t,t]),"number"==typeof o&&(o=[o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(2!==i.length||2!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]+n[0],r.data[1]=i[1]+n[1],r},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,o,r){"number"==typeof t&&(t=[t,t]),"number"==typeof o&&(o=[o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(2!==i.length||2!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]-n[0],r.data[1]=i[1]-n[1],r},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,o,r){"number"==typeof t&&(t=[t,t]),"number"==typeof o&&(o=[o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(2!==i.length||2!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]*n[0],r.data[1]=i[1]*n[1],r},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,o,r){"number"==typeof t&&(t=[t,t]),"number"==typeof o&&(o=[o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(2!==i.length||2!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]/n[0],r.data[1]=i[1]/n[1],r},e.prototype.div=function(t){return e.div(this,t,this)},e.dot=function(t,e){"number"==typeof t&&(t=[t,t]),"number"==typeof e&&(e=[e,e]);var o=t.data||t,r=e.data||e;if(2!==o.length||2!==r.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var i=0;return i+=o[0]*r[0],i+=o[1]*r[1]},e.prototype.dot=function(t){return e.dot(this,t)},e.prototype.setd=function(t,e){return this.data[0]=t,this.data[1]=e,this},e.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this},e.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this},e}),define("goo/math/Vector4",["goo/math/Vector"],function(t){"use strict";function e(){t.call(this,4),0!==arguments.length?this.set(arguments):this.setd(0,0,0,0)}return e.prototype=Object.create(t.prototype),e.prototype.setupAliases([["x","r"],["y","g"],["z","b"],["w","a"]]),e.ZERO=new e(0,0,0,0),e.ONE=new e(1,1,1,1),e.UNIT_X=new e(1,0,0,0),e.UNIT_Y=new e(0,1,0,0),e.UNIT_Z=new e(0,0,1,0),e.UNIT_W=new e(0,0,0,1),e.add=function(t,o,r){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof o&&(o=[o,o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(4!==i.length||4!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]+n[0],r.data[1]=i[1]+n[1],r.data[2]=i[2]+n[2],r.data[3]=i[3]+n[3],r},e.prototype.add=function(t){return e.add(this,t,this)},e.sub=function(t,o,r){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof o&&(o=[o,o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(4!==i.length||4!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]-n[0],r.data[1]=i[1]-n[1],r.data[2]=i[2]-n[2],r.data[3]=i[3]-n[3],r},e.prototype.sub=function(t){return e.sub(this,t,this)},e.mul=function(t,o,r){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof o&&(o=[o,o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(4!==i.length||4!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]*n[0],r.data[1]=i[1]*n[1],r.data[2]=i[2]*n[2],r.data[3]=i[3]*n[3],r},e.prototype.mul=function(t){return e.mul(this,t,this)},e.div=function(t,o,r){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof o&&(o=[o,o,o,o]),r||(r=new e);var i=t.data||t,n=o.data||o;if(4!==i.length||4!==n.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};return r.data[0]=i[0]/n[0],r.data[1]=i[1]/n[1],r.data[2]=i[2]/n[2],r.data[3]=i[3]/n[3],r},e.prototype.div=function(t){return e.div(this,t,this)},e.dot=function(t,e){"number"==typeof t&&(t=[t,t,t,t]),"number"==typeof e&&(e=[e,e,e,e]);var o=t.data||t,r=e.data||e;if(4!==o.length||4!==r.length)throw{name:"Illegal Arguments",message:"The arguments are of incompatible sizes."};var i=0;return i+=o[0]*r[0],i+=o[1]*r[1],i+=o[2]*r[2],i+=o[3]*r[3]},e.prototype.dot=function(t){return e.dot(this,t)},e.prototype.lerp=function(t,e){return this.x=(1-e)*this.x+e*t.x,this.y=(1-e)*this.y+e*t.y,this.z=(1-e)*this.z+e*t.z,this.w=(1-e)*this.w+e*t.w,this},e.prototype.setd=function(t,e,o,r){return this.data[0]=t,this.data[1]=e,this.data[2]=o,this.data[3]=r,this},e.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this.data[2]=t[2],this.data[3]=t[3],this},e.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this.data[2]=t.data[2],this.data[3]=t.data[3],this},e}),define("goo/renderer/MeshData",["goo/renderer/BufferData","goo/renderer/Util","goo/renderer/BufferUtils","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4"],function(t,e,o,r,i,n){"use strict";function a(t,e,o){this.attributeMap=t,this.vertexCount=void 0!==e?e:0,this.indexCount=void 0!==o?o:0,this.primitiveCounts=[0],this.vertexData=null,this.indexData=null,this.dataViews={},this.indexLengths=null,this.indexModes=["Triangles"],this.type=a.MESH,this.rebuildData(this.vertexCount,this.indexCount)}function s(t){for(var o={},r=0;r<t.length;r++){var i=t[r];if(void 0===p[i])throw"No default attribute named: "+i;o[i]=e.clone(p[i])}return o}var l=window.Uint8ClampedArray;a.MESH=0,a.SKINMESH=1,a.prototype.rebuildData=function(t,e,o){var r={},i=null;if(o){for(var n in this.attributeMap){var a=this.dataViews[n];a&&(r[n]=a)}this.indexData&&(i=this.indexData.data)}if(this.rebuildVertexData(t),this.rebuildIndexData(e),o){for(var n in this.attributeMap){var s=r[n];if(s){var a=this.dataViews[n];a.set(s)}}r={},i&&this.indexData.data.set(i)}},a.prototype.rebuildVertexData=function(o){if(isNaN(o)||(this.vertexCount=o,this._vertexCountStore=this.vertexCount),this.vertexCount>0){var r=0;for(var i in this.attributeMap){var n=this.attributeMap[i];r+=e.getByteSize(n.type)*n.count}this.vertexData=new t(new ArrayBuffer(r*this.vertexCount),"ArrayBuffer"),this.generateAttributeData()}},a.prototype.rebuildIndexData=function(e){if(void 0!==e&&(this.indexCount=e),this.indexCount>0){var r=o.createIndexBuffer(this.indexCount,this.vertexCount);this.indexData=new t(r,"ElementArrayBuffer")}},a.prototype.setVertexDataUpdated=function(){this.vertexData._dataNeedsRefresh=!0},a.prototype.getSectionCount=function(){return this.indexLengths?this.indexLengths.length:1},a.prototype.getPrimitiveCount=function(t){return t>=0&&t<this.primitiveCounts.length?this.primitiveCounts[t]:0},a.prototype.getPrimitiveVertices=function(t,e,o){var r=this.getPrimitiveCount(e);if(t>=r||0>t)throw new Error("Invalid primitiveIndex '"+t+"'.  Count is "+r);var n=this.indexModes[e],s=a.getVertexCount(n),l=o;(!l||l.length<s)&&(l=[]);for(var h=this.getAttributeBuffer(a.POSITION),d=0;s>d;d++)if(l[d]||(l[d]=new i),this.getIndexBuffer()){var c=this.getIndexBuffer()[this.getVertexIndex(t,d,e)];l[d].x=h[3*c+0],l[d].y=h[3*c+1],l[d].z=h[3*c+2]}else{var c=this.getVertexIndex(t,d,e);l[d].x=h[3*c+0],l[d].y=h[3*c+1],l[d].z=h[3*c+2]}return l},a.prototype.getVertexIndex=function(t,e,o){for(var r=0,i=0;o>i;i++)r+=this.indexLengths[i];switch(this.indexModes[o]){case"Triangles":r+=3*t+e;break;case"TriangleStrip":r+=t+e;break;case"TriangleFan":r+=0===e?0:t+e;break;case"Points":r+=t;break;case"Lines":r+=2*t+e;break;case"LineStrip":case"LineLoop":r+=t+e;break;default:return a.logger.warning("unimplemented index mode: "+this.indexModes[o]),-1}return r},a.prototype.getTotalPrimitiveCount=function(){for(var t=0,e=0,o=this.primitiveCounts.length;o>e;e++)t+=this.primitiveCounts[e];return t},a.prototype.updatePrimitiveCounts=function(){var t=this.indexData?this.indexData.data.length:this.vertexCount,e=this.getSectionCount();this.primitiveCounts.length!==e&&(this.primitiveCounts=[]);for(var o=0;e>o;o++){var r=this.indexLengths?this.indexLengths[o]:t,i=a.getPrimitiveCount(this.indexModes[o],r);this.primitiveCounts[o]=i}},a.getPrimitiveCount=function(t,e){switch(t){case"Triangles":return e/3;case"TriangleFan":case"TriangleStrip":return e-2;case"Lines":return e/2;case"LineStrip":return e-1;case"LineLoop":return e;case"Points":return e}throw new Error("unimplemented index mode: "+t)},a.getVertexCount=function(t){switch(t){case"Triangles":case"TriangleFan":case"TriangleStrip":return 3;case"Lines":case"LineStrip":case"LineLoop":return 2;case"Points":return 1}throw new Error("unimplemented index mode: "+t)};var h={Byte:Int8Array,UnsignedByte:Uint8Array,UnsignedByteClamped:l,Short:Int16Array,UnsignedShort:Uint16Array,Int:Int32Array,UnsignedInt:Uint32Array,Float:Float32Array};a.prototype.generateAttributeData=function(){var t,o=this.vertexData.data,r=0;for(var i in this.attributeMap){var n=this.attributeMap[i];n.offset=r;var a=this.vertexCount*n.count;r+=a*e.getByteSize(n.type);var s=h[n.type];if(!s)throw"Unsupported DataType: "+n.type;t=new s(o,n.offset,a),this.dataViews[i]=t}},a.prototype.makeInterleavedData=function(){var o=0,r=0;for(var i in this.attributeMap){var n=this.attributeMap[i];n.offset=o,o+=n.count*e.getByteSize(n.type)}var a=new t(new ArrayBuffer(o*this.vertexCount),this.vertexData.target);a._dataUsage=this.vertexData._dataUsage,a._dataNeedsRefresh=!0;var s=new DataView(a.data);for(var i in this.attributeMap){var l=this.dataViews[i],n=this.attributeMap[i];n.stride=o;for(var r=n.offset,h=n.count,d=e.getByteSize(n.type),c=this.getDataMethod(n.type),u=s[c],p=0;p<this.vertexCount;p++)for(var m=0;h>m;m++)u.apply(s,[r+o*p+m*d,l[p*h+m],!0])}this.vertexData=a},a.prototype.getDataMethod=function(t){switch(t){case"Byte":return"setInt8";case"UnsignedByte":return"setUInt8";case"Short":return"setInt16";case"UnsignedShort":return"setUInt16";case"Int":return"setInt32";case"HalfFloat":return"setInt16";case"Float":return"setFloat32"}},a.prototype.getAttributeBuffer=function(t){return this.dataViews[t]},a.prototype.getIndexData=function(){return this.indexData},a.prototype.getIndexBuffer=function(){return null!==this.indexData?this.indexData.data:null},a.prototype.getIndexLengths=function(){return this.indexLengths},a.prototype.getIndexModes=function(){return this.indexModes},a.prototype.resetVertexCount=function(){this.vertexCount=this._vertexCountStore},a.prototype.applyTransform=function(t,e){var o=new i,r=this.getAttributeBuffer(t),n=r.length;if(t===a.POSITION)for(var s=0;n>s;s+=3)o.setd(r[s+0],r[s+1],r[s+2]),e.matrix.applyPostPoint(o),r[s+0]=o[0],r[s+1]=o[1],r[s+2]=o[2];else if(t===a.NORMAL)for(var s=0;n>s;s+=3)o.setd(r[s+0],r[s+1],r[s+2]),e.rotation.applyPost(o),r[s+0]=o[0],r[s+1]=o[1],r[s+2]=o[2];else if(t===a.TANGENT)for(var s=0;n>s;s+=3)o.setd(r[s+0],r[s+1],r[s+2]),e.rotation.applyPost(o),r[s+0]=o[0],r[s+1]=o[1],r[s+2]=o[2];return this},a.prototype.applyFunction=function(t,e){var o,a,s=this.getAttributeBuffer(t),l=s.length,h=this.attributeMap[t].count;switch(h){case 1:for(var d=0;l>d;d++)s[d]=e(s[d]);break;case 2:o=new r;for(var d=0;l>d;d+=2)o.setd(s[d+0],s[d+1]),a=e(o),s[d+0]=a[0],s[d+1]=a[1];break;case 3:o=new i;for(var d=0;l>d;d+=3)o.setd(s[d+0],s[d+1],s[d+2]),a=e(o),s[d+0]=a[0],s[d+1]=a[1],s[d+2]=a[2];break;case 4:o=new n;for(var d=0;l>d;d+=4)o.setd(s[d+0],s[d+1],s[d+2],s[d+3]),a=e(o),s[d+0]=a[0],s[d+1]=a[1],s[d+2]=a[2],s[d+3]=a[3]}return this},a.prototype.getNormalsMeshData=function(t){if(void 0!==this.getAttributeBuffer("POSITION")&&void 0!==this.getAttributeBuffer("NORMAL")){t=void 0!==t?t:1;for(var e=[],o=[],r=this.dataViews.POSITION.length/3,i=0;r>i;i++)e.push(this.dataViews.POSITION[3*i+0],this.dataViews.POSITION[3*i+1],this.dataViews.POSITION[3*i+2],this.dataViews.POSITION[3*i+0]+this.dataViews.NORMAL[3*i+0]*t,this.dataViews.POSITION[3*i+1]+this.dataViews.NORMAL[3*i+1]*t,this.dataViews.POSITION[3*i+2]+this.dataViews.NORMAL[3*i+2]*t);for(var i=0;2*r>i;i+=2)o.push(i,i+1);var n=new a(a.defaultMap([a.POSITION]),e.length,o.length);return n.getAttributeBuffer(a.POSITION).set(e),n.getIndexBuffer().set(o),n.indexModes[0]="Lines",n}},a.prototype.buildWireframeData=function(){var t=e.clone(this.attributeMap),o=new a(t,this.vertexCount,0);o.indexModes[0]="Lines";var r=this.getIndexBuffer(),i=[],n=0;this.updatePrimitiveCounts();for(var s=0;s<this.getSectionCount();s++)for(var l=this.indexModes[s],h=this.getPrimitiveCount(s),d=0;h>d;d++)switch(l){case"Triangles":case"TriangleFan":case"TriangleStrip":var c=r[this.getVertexIndex(d,0,s)],u=r[this.getVertexIndex(d,1,s)],p=r[this.getVertexIndex(d,2,s)];i[n+0]=c,i[n+1]=u,i[n+2]=u,i[n+3]=p,i[n+4]=p,i[n+5]=c,n+=6;break;case"Lines":case"LineStrip":var c=r[this.getVertexIndex(d,0,s)],u=r[this.getVertexIndex(d,1,s)];i[n+0]=c,i[n+1]=u,n+=2;break;case"LineLoop":var c=r[this.getVertexIndex(d,0,s)],u=r[this.getVertexIndex(d,1,s)];d===h-1&&(u=r[this.getVertexIndex(0,0,s)]),i[n+0]=c,i[n+1]=u,n+=2;
break;case"Points":}if(n>0){o.rebuildIndexData(n);for(var m in t)o.getAttributeBuffer(m).set(this.getAttributeBuffer(m));o.getIndexBuffer().set(i)}return o.paletteMap=this.paletteMap,o.weightsPerVertex=this.weightsPerVertex,o};var d=new i,c=new i,u=new i;a.prototype.buildFlatMeshData=function(){var t=this.getIndexBuffer();if(null===t)return console.debug("No indices, probably a point mesh"),this;var o=e.clone(this.attributeMap),r={};for(var i in o)r[i]={oldBuffer:this.getAttributeBuffer(i),values:[]};var n=0;this.updatePrimitiveCounts();for(var s=0;s<this.getSectionCount();s++)for(var l=this.indexModes[s],h=this.getPrimitiveCount(s),p=!1,m=0;h>m;m++)switch(l){case"TriangleStrip":p=m%2===1?!0:!1;case"Triangles":case"TriangleFan":var f=t[this.getVertexIndex(m,0,s)],g=t[this.getVertexIndex(m,1,s)],v=t[this.getVertexIndex(m,2,s)];if(p){var y=v;v=g,g=y}for(var i in r)if(i!==a.NORMAL){for(var x=o[i].count,w=0;x>w;w++)r[i].values[n*x+w]=r[i].oldBuffer[f*x+w],r[i].values[(n+1)*x+w]=r[i].oldBuffer[g*x+w],r[i].values[(n+2)*x+w]=r[i].oldBuffer[v*x+w];i===a.POSITION&&(d.setd(r[i].values[3*n],r[i].values[3*n+1],r[i].values[3*n+2]),c.setd(r[i].values[3*(n+1)],r[i].values[3*(n+1)+1],r[i].values[3*(n+1)+2]),u.setd(r[i].values[3*(n+2)],r[i].values[3*(n+2)+1],r[i].values[3*(n+2)+2]),c.subv(d),u.subv(d),c.cross(u).normalize(),r[a.NORMAL]&&(r[a.NORMAL].values[3*n]=c.data[0],r[a.NORMAL].values[3*n+1]=c.data[1],r[a.NORMAL].values[3*n+2]=c.data[2],r[a.NORMAL].values[3*(n+1)]=c.data[0],r[a.NORMAL].values[3*(n+1)+1]=c.data[1],r[a.NORMAL].values[3*(n+1)+2]=c.data[2],r[a.NORMAL].values[3*(n+2)]=c.data[0],r[a.NORMAL].values[3*(n+2)+1]=c.data[1],r[a.NORMAL].values[3*(n+2)+2]=c.data[2]))}n+=3}if(0===n)return console.warn("Could not build flat data"),this;var _=new a(o,n);for(var i in r)_.getAttributeBuffer(i).set(r[i].values);return _.paletteMap=this.paletteMap,_.weightPerVertex=this.weightsPerVertex,_},a.POSITION="POSITION",a.NORMAL="NORMAL",a.COLOR="COLOR",a.TANGENT="TANGENT",a.TEXCOORD0="TEXCOORD0",a.TEXCOORD1="TEXCOORD1",a.TEXCOORD2="TEXCOORD2",a.TEXCOORD3="TEXCOORD3",a.WEIGHTS="WEIGHTS",a.JOINTIDS="JOINTIDS",a.createAttribute=function(t,e,o){return{count:t,type:e,stride:0,offset:0,normalized:void 0!==o?o:!1}};var p={POSITION:a.createAttribute(3,"Float"),NORMAL:a.createAttribute(3,"Float"),COLOR:a.createAttribute(4,"Float"),TANGENT:a.createAttribute(4,"Float"),TEXCOORD0:a.createAttribute(2,"Float"),TEXCOORD1:a.createAttribute(2,"Float"),TEXCOORD2:a.createAttribute(2,"Float"),TEXCOORD3:a.createAttribute(2,"Float"),WEIGHTS:a.createAttribute(4,"Float"),JOINTIDS:a.createAttribute(4,"Float")};return a.defaultMap=function(t){return s(void 0===t?Object.keys(p):t)},a}),define("goo/renderer/bounds/BoundingSphere",["goo/math/Vector3","goo/math/MathUtils","goo/renderer/bounds/BoundingVolume","goo/renderer/MeshData"],function(t,e,o,r){"use strict";function i(e,r){o.call(this,e),this.radius=void 0!==r?r:1,this.vec=new t}return i.prototype=Object.create(o.prototype),i.prototype.constructor=i,i.prototype.computeFromPoints=function(t){var e=this.min,o=this.max,r=this.vec;e.setd(1/0,1/0,1/0),o.setd(-1/0,-1/0,-1/0);for(var i,n,a,s=0;s<t.length;s+=3)i=t[s+0],n=t[s+1],a=t[s+2],e.x=i<e.x?i:e.x,e.y=n<e.y?n:e.y,e.z=a<e.z?a:e.z,o.x=i>o.x?i:o.x,o.y=n>o.y?n:o.y,o.z=a>o.z?a:o.z;for(var l,h=o.addv(e).div(2),d=0,s=0;s<t.length;s+=3)r.setd(t[s],t[s+1],t[s+2]),l=r.subv(h).lengthSquared(),l>d&&(d=l);this.radius=Math.sqrt(d),this.center.setv(h)},i.prototype.computeFromPrimitives=function(e,o,i,n,a){if(!(0>=a-n)){for(var s=[],l=[],h=r.getVertexCount(e.indexModes[o]),d=0,c=n;a>c;c++){l=e.getPrimitiveVertices(i[c],o,l);for(var u=0;h>u;u++)s[d++]=(new t).set(l[u])}this.averagePoints(s)}},i.prototype.averagePoints=function(e){this.center.set(e[0]);for(var o=1;o<e.length;o++)this.center.add(e[o]);var r=1/e.length;this.center.mul(r);for(var i=0,o=0;o<e.length;o++){var n=t.sub(e[o],this.center,this.vec),a=n.lengthSquared();a>i&&(i=a)}this.radius=Math.sqrt(i)+1e-5},i.prototype.transform=function(t,e){null===e&&(e=new i),t.applyForward(this.center,e.center);var o=t.scale;return e.radius=Math.abs(this._maxAxis(o)*this.radius),e},i.prototype.whichSide=function(t){var e=t.normal.data,r=this.center.data,i=e[0]*r[0]+e[1]*r[1]+e[2]*r[2]-t.constant;return i<-this.radius?o.Inside:i>this.radius?o.Outside:o.Intersects},i.prototype._pseudoDistance=function(t,e){return t.normal.x*e.x+t.normal.y*e.y+t.normal.z*e.z-t.constant},i.prototype._maxAxis=function(t){return Math.max(Math.abs(t.x),Math.max(Math.abs(t.y),Math.abs(t.z)))},i.prototype.toString=function(){var t=Math.round(10*this.center.x)/10,e=Math.round(10*this.center.y)/10,o=Math.round(10*this.center.z)/10,r=Math.round(10*this.radius)/10;return"["+t+","+e+","+o+"] - "+r},i.prototype.intersects=function(t){return t.intersectsSphere(this)},i.prototype.intersectsBoundingBox=function(t){t.min.x=t.center.x-t.xExtent,t.min.y=t.center.y-t.yExtent,t.min.z=t.center.z-t.zExtent,t.max.x=t.center.x+t.xExtent,t.max.y=t.center.y+t.yExtent,t.max.z=t.center.z+t.zExtent;var e=Math.pow(this.radius,2),o=0;return this.center.x<t.min.x?o+=Math.pow(this.center.x-t.min.x,2):this.center.x>t.max.x&&(o+=Math.pow(this.center.x-t.max.x,2)),this.center.y<t.min.y?o+=Math.pow(this.center.y-t.min.y,2):this.center.y>t.max.y&&(o+=Math.pow(this.center.y-t.max.y,2)),this.center.z<t.min.z?o+=Math.pow(this.center.z-t.min.z,2):this.center.z>t.max.z&&(o+=Math.pow(this.center.z-t.max.z,2)),e>=o},i.prototype.intersectsSphere=function(t){var e=this.vec.setv(this.center).subv(t.center),o=this.radius+t.radius;return e.dot(e)<=o*o},i.prototype.intersectsRay=function(e){if(!this.center)return!1;var o=(new t).copy(e.origin).sub(this.center),r=o.dot(o)-this.radius*this.radius;if(0>=r)return!0;var i=e.direction.dot(o);return i>=0?!1:i*i>=r},i.prototype.intersectsRayWhere=function(e){var o,r,i,n=(new t).copy(e.origin).sub(this.center),a=n.dot(n)-this.radius*this.radius;if(0>=a){o=e.direction.dot(n),r=o*o-a,i=Math.sqrt(r);var s=[i-o],l=[(new t).copy(e.direction).mul(s[0]).add(e.origin)];return{distances:s,points:l}}if(o=e.direction.dot(n),o>=0)return null;if(r=o*o-a,0>r)return null;if(r>=1e-5){i=Math.sqrt(r);var s=[-o-i,-o+i],l=[(new t).copy(e.direction).mul(s[0]).add(e.origin),(new t).copy(e.direction).mul(s[1]).add(e.origin)];return{distances:s,points:l}}var s=[-o],l=[(new t).copy(e.direction).mul(s[0]).add(e.origin)];return{distances:s,points:l}},i.prototype.merge=function(t){if(t instanceof i)return this.mergeSphere(t.center,t.radius,this);var e=this.vec.setd(t.xExtent,t.yExtent,t.zExtent).length();return this.mergeSphere(t.center,e,this)},i.prototype.mergeSphere=function(t,o,r){r||(r=new i);var n=this.vec.setv(t).subv(this.center),a=n.lengthSquared(),s=o-this.radius,l=s*s;if(l>=a)return 0>=s?(r.center.setv(this.center),r.radius=this.radius,r):(r.center.setv(t),r.radius=o,r);var h=Math.sqrt(a),d=r.center;if(h>e.EPSILON){var c=(h+s)/(2*h);d.addv(n.mul(c))}return r.radius=.5*(h+this.radius+o),r},i.prototype.clone=function(t){return t&&t instanceof i?(t.center.setv(this.center),t.radius=this.radius,t):new i(this.center,this.radius)},i}),define("goo/renderer/bounds/BoundingBox",["goo/math/Vector3","goo/renderer/bounds/BoundingVolume","goo/renderer/bounds/BoundingSphere","goo/math/MathUtils"],function(t,e,o,r){"use strict";function i(o,r,i,n){e.call(this,o),this.xExtent=void 0!==r?r:1,this.yExtent=void 0!==i?i:1,this.zExtent=void 0!==n?n:1,this._compVect1=new t,this._compVect2=new t,this.vec=new t,this.corners=[];for(var a=0;8>a;a++)this.corners.push(new t)}return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.computeFromPoints=function(t){var e=this.min,o=this.max,r=this.vec;e.setd(1/0,1/0,1/0),o.setd(-1/0,-1/0,-1/0);for(var i,n,a,s=0;s<t.length;s+=3)i=t[s+0],n=t[s+1],a=t[s+2],e.x=i<e.x?i:e.x,e.y=n<e.y?n:e.y,e.z=a<e.z?a:e.z,o.x=i>o.x?i:o.x,o.y=n>o.y?n:o.y,o.z=a>o.z?a:o.z;r.setv(o).subv(e).div(2),this.xExtent=r.x,this.yExtent=r.y,this.zExtent=r.z,this.center.setv(o).addv(e).div(2)},i.prototype.computeFromPrimitives=function(t,e,o,r,n){if(!(0>=n-r)){for(var a=this._compVect1.set(1/0,1/0,1/0),s=this._compVect2.set(-1/0,-1/0,-1/0),l=[],h=r;n>h;h++){l=t.getPrimitiveVertices(o[h],e,l);for(var d=0;d<l.length;d++)i.checkMinMax(a,s,l[d])}this.center.copy(a.add(s)),this.center.mul(.5),this.xExtent=s.x-this.center.x,this.yExtent=s.y-this.center.y,this.zExtent=s.z-this.center.z}},i.checkMinMax=function(t,e,o){o.x<t.x&&(t.x=o.x),o.x>e.x&&(e.x=o.x),o.y<t.y&&(t.y=o.y),o.y>e.y&&(e.y=o.y),o.z<t.z&&(t.z=o.z),o.z>e.z&&(e.z=o.z)},i.prototype.transform=function(t,e){null===e&&(e=new i);var o=this.corners;this.getCorners(o);for(var r=0;r<o.length;r++)t.matrix.applyPostPoint(o[r]);for(var n=o[0].data[0],a=o[0].data[1],s=o[0].data[2],l=n,h=a,d=s,r=1;r<o.length;r++){var c=o[r].data[0],u=o[r].data[1],p=o[r].data[2];n=Math.min(n,c),a=Math.min(a,u),s=Math.min(s,p),l=Math.max(l,c),h=Math.max(h,u),d=Math.max(d,p)}var m=.5*(l+n),f=.5*(h+a),g=.5*(d+s);return e.center.setd(m,f,g),e.xExtent=l-m,e.yExtent=h-f,e.zExtent=d-g,e},i.prototype.getCorners=function(e){if(!e||8!==e.length){e=[];for(var o=0;o<e.length;o++)e.push(new t)}var r=this.center.data;return e[0].setd(r[0]+this.xExtent,r[1]+this.yExtent,r[2]+this.zExtent),e[1].setd(r[0]+this.xExtent,r[1]+this.yExtent,r[2]-this.zExtent),e[2].setd(r[0]+this.xExtent,r[1]-this.yExtent,r[2]+this.zExtent),e[3].setd(r[0]+this.xExtent,r[1]-this.yExtent,r[2]-this.zExtent),e[4].setd(r[0]-this.xExtent,r[1]+this.yExtent,r[2]+this.zExtent),e[5].setd(r[0]-this.xExtent,r[1]+this.yExtent,r[2]-this.zExtent),e[6].setd(r[0]-this.xExtent,r[1]-this.yExtent,r[2]+this.zExtent),e[7].setd(r[0]-this.xExtent,r[1]-this.yExtent,r[2]-this.zExtent),e},i.prototype.whichSide=function(t){var o=t.normal.data,r=this.center.data,i=Math.abs(this.xExtent*o[0])+Math.abs(this.yExtent*o[1])+Math.abs(this.zExtent*o[2]),n=o[0]*r[0]+o[1]*r[1]+o[2]*r[2]-t.constant;return-i>n?e.Inside:n>i?e.Outside:e.Intersects},i.prototype._pseudoDistance=function(t,e){var o=t.normal.data,r=e.data;return o[0]*r[0]+o[1]*r[1]+o[2]*r[2]-t.constant},i.prototype._maxAxis=function(t){return Math.max(Math.abs(t.x),Math.max(Math.abs(t.y),Math.abs(t.z)))},i.prototype.toString=function(){var t=Math.round(10*this.center.x)/10,e=Math.round(10*this.center.y)/10,o=Math.round(10*this.center.z)/10;return"["+t+","+e+","+o+"] - ["+this.xExtent+","+this.yExtent+","+this.zExtent+"]"},i.prototype.intersects=function(t){return t.intersectsBoundingBox(this)},i.prototype.intersectsBoundingBox=function(t){return this.center.x+this.xExtent<t.center.x-t.xExtent||this.center.x-this.xExtent>t.center.x+t.xExtent?!1:this.center.y+this.yExtent<t.center.y-t.yExtent||this.center.y-this.yExtent>t.center.y+t.yExtent?!1:this.center.z+this.zExtent<t.center.z-t.zExtent||this.center.z-this.zExtent>t.center.z+t.zExtent?!1:!0},i.prototype.intersectsSphere=function(t){this.min.x=this.center.x-this.xExtent,this.min.y=this.center.y-this.yExtent,this.min.z=this.center.z-this.zExtent,this.max.x=this.center.x+this.xExtent,this.max.y=this.center.y+this.yExtent,this.max.z=this.center.z+this.zExtent;var e=Math.pow(t.radius,2),o=0;return t.center.x<this.min.x?o+=Math.pow(t.center.x-this.min.x,2):t.center.x>this.max.x&&(o+=Math.pow(t.center.x-this.max.x,2)),t.center.y<this.min.y?o+=Math.pow(t.center.y-this.min.y,2):t.center.y>this.max.y&&(o+=Math.pow(t.center.y-this.max.y,2)),t.center.z<this.min.z?o+=Math.pow(t.center.z-this.min.z,2):t.center.z>this.max.z&&(o+=Math.pow(t.center.z-this.max.z,2)),e>=o},i.prototype.testStaticAABBAABB=function(e,o){var r=this,i=e,n={mtvDistance:1e10,mtvAxis:new t};return this.testAxisStatic(t.UNIT_X,r.center.x-r.xExtent,r.center.x+r.xExtent,i.center.x-i.xExtent,i.center.x+i.xExtent,n)?this.testAxisStatic(t.UNIT_Y,r.center.y-r.yExtent,r.center.y+r.yExtent,i.center.y-i.yExtent,i.center.y+i.yExtent,n)?this.testAxisStatic(t.UNIT_Z,r.center.z-r.zExtent,r.center.z+r.zExtent,i.center.z-i.zExtent,i.center.z+i.zExtent,n)?(o&&(o.isIntersecting=!0,o.normal=n.mtvAxis,o.penetration=1.001*Math.sqrt(n.mtvDistance)),!0):!1:!1:!1},i.prototype.testAxisStatic=function(e,o,r,i,n,a){var s=t.dot(e,e);if(1e-6>s)return!0;var l=n-o,h=r-i;if(0>=l||0>=h)return!1;var d=h>l?l:-h,c=(new t).copy(e).mul(d/s),u=t.dot(c,c);return u<a.mtvDistance&&(a.mtvDistance=u,a.mtvAxis=e),!0},i.prototype.intersectsRay=function(t){if(isNaN(this.center.x)||isNaN(this.center.y)||isNaN(this.center.z))return!1;var e=this._compVect1.setv(t.origin).subv(this.center),o=t.direction,n=[0,1/0],a=this.xExtent;a<r.ZERO_TOLERANCE&&a>=0&&(a=r.ZERO_TOLERANCE);var s=this.yExtent;s<r.ZERO_TOLERANCE&&s>=0&&(s=r.ZERO_TOLERANCE);var l=this.zExtent;l<r.ZERO_TOLERANCE&&l>=0&&(l=r.ZERO_TOLERANCE);var h=i.clip(o.data[0],-e.data[0]-a,n)&&i.clip(-o.data[0],e.data[0]-a,n)&&i.clip(o.data[1],-e.data[1]-s,n)&&i.clip(-o.data[1],e.data[1]-s,n)&&i.clip(o.data[2],-e.data[2]-l,n)&&i.clip(-o.data[2],e.data[2]-l,n);return!h||0===n[0]&&1/0===n[1]?!1:!0},i.prototype.intersectsRayWhere=function(e){if(isNaN(this.center.x)||isNaN(this.center.y)||isNaN(this.center.z))return null;var o=t.sub(e.origin,this.center,this._compVect1),n=e.direction,a=[0,1/0],s=this.xExtent;s<r.ZERO_TOLERANCE&&s>=0&&(s=r.ZERO_TOLERANCE);var l=this.yExtent;l<r.ZERO_TOLERANCE&&l>=0&&(l=r.ZERO_TOLERANCE);var h=this.zExtent;h<r.ZERO_TOLERANCE&&h>=0&&(h=r.ZERO_TOLERANCE);var d=i.clip(n.x,-o.x-s,a)&&i.clip(-n.x,o.x-s,a)&&i.clip(n.y,-o.y-l,a)&&i.clip(-n.y,o.y-l,a)&&i.clip(n.z,-o.z-h,a)&&i.clip(-n.z,o.z-h,a);if(d&&(0!==a[0]||1/0!==a[1])){if(a[1]>a[0]){var c=a,u=[new t(e.direction).mul(c[0]).add(e.origin),new t(e.direction).mul(c[1]).add(e.origin)];return{distances:c,points:u}}var c=[a[0]],u=[new t(e.direction).mul(c[0]).add(e.origin)];return{distances:c,points:u}}return null},i.clip=function(t,e,o){return t>0?e>t*o[1]?!1:(e>t*o[0]&&(o[0]=e/t),!0):0>t?e>t*o[0]?!1:(e>t*o[1]&&(o[1]=e/t),!0):0>=e},i.prototype.merge=function(t){return t instanceof i?this.mergeBox(t.center,t.xExtent,t.yExtent,t.zExtent,this):t instanceof o?this.mergeBox(t.center,t.radius,t.radius,t.radius,this):this},i.prototype.mergeBox=function(t,e,o,r,n){n||(n=new i);var a=this._compVect1,s=this._compVect2;return a.x=this.center.x-this.xExtent,a.x>t.x-e&&(a.x=t.x-e),a.y=this.center.y-this.yExtent,a.y>t.y-o&&(a.y=t.y-o),a.z=this.center.z-this.zExtent,a.z>t.z-r&&(a.z=t.z-r),s.x=this.center.x+this.xExtent,s.x<t.x+e&&(s.x=t.x+e),s.y=this.center.y+this.yExtent,s.y<t.y+o&&(s.y=t.y+o),s.z=this.center.z+this.zExtent,s.z<t.z+r&&(s.z=t.z+r),n.center.set(s).addv(a).muld(.5,.5,.5),n.xExtent=s.x-n.center.x,n.yExtent=s.y-n.center.y,n.zExtent=s.z-n.center.z,n},i.prototype.clone=function(t){return t&&t instanceof i?(t.center.setv(this.center),t.xExtent=this.xExtent,t.yExtent=this.yExtent,t.zExtent=this.zExtent,t):new i(this.center,this.xExtent,this.yExtent,this.zExtent)},i}),define("goo/entities/components/MeshDataComponent",["goo/renderer/bounds/BoundingBox","goo/entities/components/Component","goo/renderer/MeshData"],function(t,e,o){"use strict";function r(e){this.type="MeshDataComponent",this.meshData=e,this.modelBound=new t,this.autoCompute=!0,this.currentPose=null}return r.type="MeshDataComponent",r.prototype=Object.create(e.prototype),r.prototype.constructor=r,r.prototype.setModelBound=function(t,e){this.modelBound=t,this.autoCompute=e},r.prototype.computeBoundFromPoints=function(){if(this.autoCompute&&null!==this.modelBound&&this.meshData){var t=this.meshData.getAttributeBuffer("POSITION");void 0!==t&&(this.modelBound.computeFromPoints(t),this.autoCompute=!1)}},r.applyOnEntity=function(t,e){if(t instanceof o){var i=new r(t);return e.setComponent(i),!0}},r}),define("goo/renderer/ShaderCall",[],function(){"use strict";function t(t,e,o){if(this.context=t,this.location=e,this.location.value=void 0,o)switch(o){case"float":this.call=this.uniform1f;break;case"bool":case"int":case"integer":case"sampler2D":case"sampler3D":case"samplerCube":this.call=this.uniform1i;break;case"floatarray":this.call=this.uniform1fv;break;case"intarray":case"samplerArray":this.call=this.uniform1iv;break;case"vec2":this.call=this.uniform2fv;break;case"vec3":this.call=this.uniform3fv;break;case"vec4":this.call=this.uniform4fv;break;case"mat2":this.call=this.uniformMatrix2fv;break;case"mat3":this.call=this.uniformMatrix3fv;break;case"mat4":this.call=this.uniformMatrix4fv;break;default:throw"Uniform type not handled: "+o}}function e(t,e,o){if(0>o)return!1;for(;o--;)if(t[o]!==e[o])return!1;return!0}function o(t,e){for(var o=t.length;o--;)if(t[o]!==e[o])return!1;return!0}return t.prototype.uniform1f=function(t){var e=this.location.value;e!==t&&(this.context.uniform1f(this.location,t),this.location.value=t)},t.prototype.uniform1fv=function(t){var e=this.location.value;void 0!==e&&o(t,e)||(this.context.uniform1fv(this.location,t),this.location.value=t.slice())},t.prototype.uniform1i=function(t){var e=this.location.value;e!==t&&(this.context.uniform1i(this.location,t),this.location.value=t)},t.prototype.uniform1iv=function(t){var e=this.location.value;void 0!==e&&o(t,e)||(this.context.uniform1iv(this.location,t),this.location.value=t.slice())},t.prototype.uniform2f=function(t,e){var o=this.location.value;(void 0===o||2!==o.length||o[0]!==t||o[1]!==e)&&(this.context.uniform2f(this.location,t,e),this.location.value=[t,e])},t.prototype.uniform2fv=function(t){var e=this.location.value;if(void 0!==e){if(o(t,e))return}else e=this.location.value=new Float64Array(t.length);this.context.uniform2fv(this.location,t);for(var r=t.length;r--;)e[r]=t[r]},t.prototype.uniform2i=function(t,e){var o=this.location.value;(void 0===o||2!==o.length||o[0]!==t||o[1]!==e)&&(this.context.uniform2i(this.location,t,e),this.location.value=[t,e])},t.prototype.uniform2iv=function(t){var e=this.location.value;void 0!==e&&o(t,e)||(this.context.uniform2iv(this.location,t),this.location.value=t.slice())},t.prototype.uniform3f=function(t,e,o){var r=this.location.value;(void 0===r||3!==r.length||r[0]!==t||r[1]!==e||r[2]!==o)&&(this.context.uniform3f(this.location,t,e,o),this.location.value=[t,e,o])},t.prototype.uniform3fv=function(t){var e=this.location.value;if(void 0!==e){if(o(t,e))return}else e=this.location.value=new Float64Array(t.length);this.context.uniform3fv(this.location,t);for(var r=t.length;r--;)e[r]=t[r]},t.prototype.uniform3i=function(t,e,o){var r=this.location.value;(void 0===r||3!==r.length||r[0]!==t||r[1]!==e||r[2]!==o)&&(this.context.uniform3i(this.location,t,e,o),this.location.value=[t,e,o])},t.prototype.uniform3iv=function(t){var e=this.location.value;void 0!==e&&o(t,e)||(this.context.uniform3iv(this.location,t),this.location.value=t.slice())},t.prototype.uniform4f=function(t,e,o,r){var i=this.location.value;(void 0===i||4!==i.length||i[0]!==t||i[1]!==e||i[2]!==o||i[3]!==r)&&(this.context.uniform4f(this.location,t,e,o,r),this.location.value=[t,e,o,r])},t.prototype.uniform4fv=function(t){var e=this.location.value;if(void 0!==e){if(o(t,e))return}else e=this.location.value=new Float64Array(t.length);this.context.uniform4fv(this.location,t);for(var r=t.length;r--;)e[r]=t[r]},t.prototype.uniform4i=function(t,e,o,r){var i=this.location.value;(void 0===i||4!==i.length||i[0]!==t||i[1]!==e||i[2]!==o||i[3]!==r)&&(this.context.uniform4i(this.location,t,e,o,r),this.location.value=[t,e,o,r])},t.prototype.uniform4iv=function(t){var e=this.location.value;void 0!==e&&o(t,e)||(this.context.uniform4iv(this.location,t),this.location.value=t.slice())},t.prototype.uniformMatrix2fv=function(t,o){if(o=o===!0,!t.data)return void this.context.uniformMatrix2fv(this.location,o,t);var r=this.location.value;if(void 0!==r){var i=e(r.data,t.data,4);if(i)return;r.copy(t)}else this.location.value=t.clone();this.context.uniformMatrix2fv(this.location,o,t.data)},t.prototype.uniformMatrix3fv=function(t,o){if(o=o===!0,!t.data)return void this.context.uniformMatrix3fv(this.location,o,t);var r=this.location.value;if(void 0!==r){var i=e(r.data,t.data,9);if(i)return;r.copy(t)}else this.location.value=t.clone();this.context.uniformMatrix3fv(this.location,o,t.data)},t.prototype.uniformMatrix4fv=function(t,r){if(r=r===!0,t.data){var i=this.location.value;if(void 0!==i){var n=e(i.data,t.data,16);if(n)return;i.copy(t)}else this.location.value=t.clone();this.context.uniformMatrix4fv(this.location,r,t.data)}else{var a=t,i=this.location.value;if(void 0!==i){if(o(a,i))return}else i=this.location.value=new Float64Array(a.length);this.context.uniformMatrix4fv(this.location,r,a);for(var s=a.length;s--;)i[s]=a[s]}},t}),define("goo/util/StringUtil",[],function(){"use strict";var t={};t.endsWith=function(t,e){return-1!==t.indexOf(e,t.length-e.length)},t.startsWith=function(t,e){return 0===t.indexOf(e)},t.capitalize=function(t){return t.charAt(0).toUpperCase()+t.substring(1)},t.uncapitalize=function(t){return t.charAt(0).toLowerCase()+t.substring(1)},t.createUniqueId=function(t){var e=Date.now(),o="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(t){var o=(e+16*Math.random())%16|0;return"x"===t?o.toString(16):(3&o|8).toString(16)});return o+"."+t},t.getUntil=function(t,e){var o=t.indexOf(e);return-1===o?t:t.slice(0,o)},t.getAfterLast=function(t,e){var o=t.lastIndexOf(e);return-1===o?t:t.slice(o+e.length,t.length)},t.getFrom=function(t,e){var o=t.indexOf(e);return-1===o?"":t.slice(o+e.length,t.length)},t.getIndexedName=function(t,e,o){o||(o="_");var r,i=new RegExp(t+"("+o+"\\d+)?"),n=0;for(r in e){var a=e[r],s=i.exec(a);if(s)if(s.length>1&&s[1]){var l=parseInt(s[1].substring(o.length),10);l>=n&&(n=l+1)}else n=1}return t+o+n},t.getUniqueName=function(e,o,r){return-1===o.indexOf(e)?e:t.getIndexedName(e,o,r)},t.toAscii=function(t){return t.replace(/([^\x00-\x7F])/g,"x")},t.hashCode=function(t){var e=0;if(0===t.length)return e;for(var o=0;o<t.length;o++){var r=t.charCodeAt(o);e=(e<<5)-e+r,e&=e}return btoa(e).replace("/","_").replace("+","-")};var e=+new Date;return t.getUniqueId=function(){e++;var o=Array.prototype.slice.call(arguments,0).join("");return t.hashCode(e+""+o)},t.escapeHtmlEntities=function(t){var e=document.createElement("div");e.appendChild(document.createTextNode(t));var o={34:"quot"};return e.innerHTML.replace(/[\u00A0-\u2666\"\']/g,function(t){var e=o[t.charCodeAt(0)];return"&"+(e||"#"+t.charCodeAt(0))+";"})},t}),define("goo/entities/Entity",["goo/entities/components/Component","goo/util/StringUtil"],function(t,e){"use strict";function o(t,r,i){this._world=t,this._components=[],this.id=void 0!==i?i:e.createUniqueId("entity"),this._index=o.entityCount,this._tags={},this._attributes={},this.name=void 0!==r?r:"Entity_"+this._index,this.skip=!1,this.hidden=!1,this.static=!1,o.entityCount++}function r(t){return t.charAt(0).toLowerCase()+t.substr(1)}return o.prototype.set=function(){for(var e=0;e<arguments.length;e++){var o=arguments[e];if(o instanceof t)this.setComponent(o);else for(var r=this._world._components,i=0;i<r.length;i++){var n=r[i],a=n.applyOnEntity(o,this);if(a)break}}return this},o.prototype.addToWorld=function(t){return this._world.addEntity(this,t),this},o.prototype.removeFromWorld=function(t){return this._world.removeEntity(this,t),this},o.prototype.setComponent=function(t){return this.hasComponent(t.type)?this:(this._components.push(t),this[r(t.type)]=t,t.attached&&t.attached(this),t.applyAPI(this),this._world.entityManager.containsEntity(this)&&this._world.changedEntity(this,t,"addedComponent"),this)},o.prototype.hasComponent=function(t){var e=r(t),o=this[e];return!!o&&this._components.indexOf(o)>-1},o.prototype.getComponent=function(t){var e=r(t);return this.hasComponent(t)?this[e]:void 0},o.prototype.clearComponent=function(t){var e=r(t),o=this[e];if(o&&this._components.indexOf(o)>-1){o.detached&&o.detached(this),o.removeAPI(this);var i=this._components.indexOf(o);this._components.splice(i,1),delete this[e],this._world.entityManager.containsEntity(this)&&this._world.changedEntity(this,o,"removedComponent")}return this},o.prototype.setTag=function(t){return this._tags[t]=!0,this},o.prototype.hasTag=function(t){return!!this._tags[t]},o.prototype.clearTag=function(t){return delete this._tags[t],this},o.prototype.setAttribute=function(t,e){return this._attributes[t]=e,this},o.prototype.hasAttribute=function(t){return"undefined"!=typeof this._attributes[t]},o.prototype.getAttribute=function(t){return this._attributes[t]},o.prototype.clearAttribute=function(t){return delete this._attributes[t],this},o.prototype.toString=function(){return this.name},o.entityCount=0,o}),define("goo/entities/managers/Manager",[],function(){"use strict";function t(){}return t.prototype.applyAPI=function(t){this.installedAPI||(this.installedAPI={});var e=this.api;for(var o in e)"undefined"==typeof t[o]?(t[o]=e[o],this.installedAPI[o]=!0):console.warn("Could not install method "+o+" of "+this.type+" as it is already taken")},t}),define("goo/entities/managers/EntityManager",["goo/entities/managers/Manager","goo/entities/EntitySelection"],function(t,e){"use strict";function o(){this.type="EntityManager",this._entitiesById={},this._entitiesByIndex={},this._entityCount=0,this.api={id:function(){var t=o.prototype.getEntityById.apply(this,arguments);return new e(t)}.bind(this),name:function(t){var o=this.getEntities();return new e(o.filter(function(e){return e.name===t}))}.bind(this)}}return o.prototype=Object.create(t.prototype),o.prototype.added=function(t){this.containsEntity(t)||(this._entitiesById[t.id]=t,this._entitiesByIndex[t._index]=t,this._entityCount++)},o.prototype.removed=function(t){this.containsEntity(t)&&(delete this._entitiesById[t.id],delete this._entitiesByIndex[t._index],this._entityCount--)},o.prototype.containsEntity=function(t){return void 0!==this._entitiesById[t.id]},o.prototype.getEntityById=function(t){return this._entitiesById[t]},o.prototype.getEntityByIndex=function(t){return this._entitiesByIndex[t]},o.prototype.getEntityByName=function(t){for(var e in this._entitiesById){var o=this._entitiesById[e];if(o.name===t)return o}},o.prototype.size=function(){return this._entityCount},o.prototype.getEntities=function(){var t=[];for(var e in this._entitiesById)t.push(this._entitiesById[e]);return t},o.prototype.getTopEntities=function(){var t=[];for(var e in this._entitiesById){var o=this._entitiesById[e];o.transformComponent?o.transformComponent.parent||t.push(o):t.push(o)}return t},o}),define("goo/entities/systems/System",[],function(){"use strict";function t(t,e){this.type=t,this.interests=e,this._activeEntities=[],this.passive=!1,this.priority=0}function e(t){return t.charAt(0).toLowerCase()+t.substr(1)}return t.prototype.added=function(t){this._check(t)},t.prototype.changed=function(t){this._check(t)},t.prototype.removed=function(t){var e=this._activeEntities.indexOf(t);-1!==e&&(this._activeEntities.splice(e,1),this.deleted&&this.deleted(t))},t.prototype._check=function(t){if(!this.interests||0!==this.interests.length){var o=null===this.interests;if(!o&&this.interests.length<=t._components.length){o=!0;for(var r=0;r<this.interests.length;r++){var i=e(this.interests[r]);if(!t[i]){o=!1;break}}}var n=this._activeEntities.indexOf(t);o&&-1===n?(this._activeEntities.push(t),this.inserted&&this.inserted(t)):o||-1===n||(this._activeEntities.splice(n,1),this.deleted&&this.deleted(t))}},t.prototype._process=function(t){this.process&&this.process(this._activeEntities,t)},t}),define("goo/entities/World",["goo/entities/Entity","goo/entities/managers/EntityManager","goo/entities/components/TransformComponent","goo/entities/managers/Manager","goo/entities/systems/System","goo/entities/components/Component","goo/entities/EntitySelection"],function(t,e,o,r,i,n,a){"use strict";function s(t){this.gooRunner=t,this._managers=[],this._systems=[],this._addedEntities=[],this._changedEntities=[],this._removedEntities=[],this.by={},this._installDefaultSelectors(),this.entityManager=new e,this.setManager(this.entityManager),this.time=0,this.tpf=1,this._components=[]}return s.time=0,s.tpf=1,s.prototype._installDefaultSelectors=function(){this.by.system=function(t){var e=this.getSystem(t);return new a(e._activeEntities)}.bind(this),this.by.component=function(t){var e=this.entityManager.getEntities();return new a(e.filter(function(e){return!!e[t]}))}.bind(this),this.by.tag=function(t){var e=this.entityManager.getEntities();return new a(e.filter(function(e){return e.hasTag(t)}))}.bind(this),this.by.attribute=function(t){var e=this.entityManager.getEntities();return new a(e.filter(function(e){return e.hasAttribute(t)}))}.bind(this)},s.prototype.add=function(){for(var e=0;e<arguments.length;e++){var o=arguments[e];o instanceof t?this.addEntity(o):o instanceof r?this.setManager(o):o instanceof i?this.setSystem(o):o instanceof n&&this.registerComponent(o)}return this},s.prototype.registerComponent=function(t){return-1===this._components.indexOf(t)&&this._components.push(t),this},s.prototype.setManager=function(t){return this._managers.push(t),t.applyAPI(this.by),this},s.prototype.getManager=function(t){for(var e=0;e<this._managers.length;e++){var o=this._managers[e];if(o.type===t)return o}},s.prototype.setSystem=function(t){for(var e=t.priority,o=0;o<this._systems.length&&!(this._systems[o].priority>e);o++);return this._systems.splice(o,0,t),this},s.prototype.getSystem=function(t){for(var e=0;e<this._systems.length;e++){var o=this._systems[e];if(o.type===t)return o}},s.prototype.createEntity=function(){for(var e=new t(this),r=0;r<arguments.length;r++)"string"==typeof arguments[r]?e.name=arguments[r]:e.set(arguments[r]);return e.transformComponent||e.setComponent(new o),e},s.prototype.getEntities=function(){return this.entityManager.getEntities()},s.prototype.addEntity=function(t,e){if(-1===this._addedEntities.indexOf(t)&&this._addedEntities.push(t),t.transformComponent&&(void 0===e||e===!0))for(var o=t.transformComponent.children,r=0;r<o.length;r++)this.addEntity(o[r].entity,e);return this},s.prototype.removeEntity=function(t,e){-1===this._removedEntities.indexOf(t)&&this._removedEntities.push(t);var o=t.transformComponent;if(o.parent&&(o.parent.detachChild(o),o.parent=null),e===!1){for(var r=o.children,i=0;i<r.length;i++)r[i].parent=null;o.children=[]}else for(var r=o.children,i=0;i<r.length;i++)this._recursiveRemoval(r[i].entity,e);return this},s.prototype._recursiveRemoval=function(t,e){if(-1===this._removedEntities.indexOf(t)&&this._removedEntities.push(t),t.transformComponent&&(void 0===e||e===!0))for(var o=t.transformComponent.children,r=0;r<o.length;r++)this._recursiveRemoval(o[r].entity,e)},s.prototype.changedEntity=function(t,e,o){var r={entity:t};void 0!==e&&(r.component=e),void 0!==o&&(r.eventType=o),this._changedEntities.push(r)},s.prototype.process=function(){this._check(this._addedEntities,function(t,e){if(t.added&&t.added(e),t.addedComponent)for(var o=0;o<e._components.length;o++)t.addedComponent(e,e._components[o])}),this._check(this._changedEntities,function(t,e){t.changed&&t.changed(e.entity),void 0!==e.eventType&&t[e.eventType]&&t[e.eventType](e.entity,e.component)}),this._check(this._removedEntities,function(t,e){if(t.removed&&t.removed(e),t.removedComponent)for(var o=0;o<e._components.length;o++)t.removedComponent(e,e._components[o])});for(var t=0;t<this._systems.length;t++){var e=this._systems[t];e.passive||e._process(this.tpf)}},s.prototype._check=function(t,e){for(var o=0;o<t.length;o++){for(var r=t[o],i=0;i<this._managers.length;i++){var n=this._managers[i];e(n,r)}for(var a=0;a<this._systems.length;a++){var s=this._systems[a];e(s,r)}}t.length=0},s}),define("goo/renderer/RenderQueue",["goo/math/Vector3"],function(t){"use strict";function e(){var e=this,o=new t;this.opaqueSorter=function(t,r){var i=t.meshRendererComponent.materials[0],n=r.meshRendererComponent.materials[0];if(null===i||null===n)return 0;if(i===n){var a=t.meshRendererComponent.worldBound,s=r.meshRendererComponent.worldBound;if(null===a||null===s)return 0;var l=o.setv(e.camera.translation).subv(a.center).lengthSquared(),h=o.setv(e.camera.translation).subv(s.center).lengthSquared();return l-h}var d=i.shader,c=n.shader;if(null===d||null===c)return 0;if(d._id===c._id){var a=t.meshRendererComponent.worldBound,s=r.meshRendererComponent.worldBound;
if(null===a||null===s)return 0;var l=o.setv(e.camera.translation).subv(a.center).lengthSquared(),h=o.setv(e.camera.translation).subv(s.center).lengthSquared();return l-h}return d._id-c._id},this.transparentSorter=function(t,r){var i=t.meshRendererComponent.worldBound,n=r.meshRendererComponent.worldBound,a=o.setv(e.camera.translation).subv(i.center).lengthSquared(),s=o.setv(e.camera.translation).subv(n.center).lengthSquared();return s-a},this.bucketSorter=function(t,e){return t-e}}return e.prototype.sort=function(t,o){var r=0;this.camera=o;for(var i={},n=[],a=0;a<t.length;a++){var s=t[a],l=s.meshRendererComponent;if(l&&0!==l.materials.length){var h=l.materials[0].getRenderQueue(),d=i[h];d||(d=[],i[h]=d,n.push(h)),d.push(s)}else t[r]=s,r++}n.length>1&&n.sort(this.bucketSorter);for(var c=0;c<n.length;c++){var u=n[c],d=i[u];d.sort(u<e.TRANSPARENT?this.opaqueSorter:this.transparentSorter);for(var a=0;a<d.length;a++)t[r]=d[a],r++}},e.BACKGROUND=0,e.OPAQUE=1e3,e.TRANSPARENT=2e3,e.OVERLAY=3e3,e}),define("goo/util/ArrayUtil",[],function(){"use strict";var t={};return t.getTypedArray=function(t,e){var o=e[0],r=e[1],i=e[2];if("float32"===i)return new Float32Array(t,o,r);if("uint8"===i)return new Uint8Array(t,o,r);if("uint16"===i)return new Uint16Array(t,o,r);if("uint32"===i)return new Uint32Array(t,o,r);throw new Error("Binary format "+i+" is not supported")},t.remove=function(t,e,o){var r=-1;if("function"==typeof o){for(var i=0;i<t.length;i++)if(o(t[i],e)){r=i;break}}else r=t.indexOf(e);r>-1&&t.splice(r,1)},t.find=function(t,e){for(var o=0;o<t.length;o++)if(e(t[o]))return t[o];return null},t}),define("goo/entities/Bus",["goo/util/ArrayUtil"],function(t){"use strict";function e(){this.trie={name:"",listeners:[],children:{}}}return e.prototype.emit=function(t,e,o){o=o!==!1,"string"==typeof t&&(t=[t]);for(var r=0;r<t.length;r++)this._emitToSingle(t[r],e,o)},e.prototype._getNode=function(t,e){for(var o=this.trie,r=t.split("."),i=0;i<r.length;i++){var n=r[i];if(o.children[n])o=o.children[n];else{if(!e)return;var a={listeners:[],children:[]};o.children[n]=a,o=a}}return o},e.prototype._emitToSingle=function(t,e,o){var r=this._getNode(t,o);r&&(this._emitToAll(r,e),o&&(r.latestData=e))},e.prototype._emitToAll=function(t,e){for(var o=0;o<t.listeners.length;o++)t.listeners[o](e);for(var r=Object.keys(t.children),o=0;o<r.length;o++)this._emitToAll(t.children[r],e)},e.prototype.addListener=function(t,e,o){o=o!==!1;for(var r=this.trie,i=t.split("."),n=0;n<i.length;n++){var a=i[n];if(r.children[a])r=r.children[a];else{var s={listeners:[],children:[]};r.children[a]=s,r=s}}-1===r.listeners.indexOf(e)&&(r.listeners.push(e),o&&r.latestData&&e(r.latestData))},e.prototype.removeListener=function(e,o){var r=this._getNode(e);r&&t.remove(r.listeners,o)},e.prototype.removeAllOnChannel=function(t){var e=this._getNode(t);e&&(e.listeners=[])},e.prototype.removeChannelAndChildren=function(t){var e=t.split("."),o=e.pop(),r=e.join("."),i=this._getNode(r);delete i.children[o]},e.prototype._removeListener=function(e,o){t.remove(e.listeners,o);for(var r=Object.keys(e.children),i=0;i<r.length;i++)this._removeListener(e.children[r[i]],o)},e.prototype.removeListenerFromAllChannels=function(t){this._removeListener(this.trie,t)},e}),define("goo/entities/SystemBus",["goo/entities/Bus"],function(t){"use strict";return new t}),define("goo/renderer/Shader",["goo/renderer/ShaderCall","goo/math/Matrix4x4","goo/entities/World","goo/renderer/RenderQueue","goo/renderer/Util","goo/entities/SystemBus"],function(t,e,o,r,i,n){"use strict";function a(t,e){if(!e.vshader||!e.fshader)throw new Error("Missing shader sources for shader: "+t);this.originalShaderDefinition=e,this.shaderDefinition=e,this.name=t,this.origVertexSource=e.vshader,this.origFragmentSource=e.fshader,this.vertexSource="function"==typeof this.origVertexSource?this.origVertexSource():this.origVertexSource,this.fragmentSource="function"==typeof this.origFragmentSource?this.origFragmentSource():this.origFragmentSource,this.shaderProgram=null,this.attributeMapping={},this.attributeIndexMapping={},this.uniformMapping={},this.uniformCallMapping={},this.textureSlots=[],this.textureSlotsNaming={},this.currentCallbacks={},this.overridePrecision=e.precision||null,this.processors=e.processors,this.builder=e.builder,this.defines=e.defines,this.attributes=e.attributes||{},this.uniforms=e.uniforms||{},this.renderQueue=r.OPAQUE,this._id=a.id++,this.errorOnce=!1}function s(t){t[a.PROJECTION_MATRIX]=function(t,e){var o=e.camera.getProjectionMatrix();t.uniformMatrix4fv(o)},t[a.VIEW_MATRIX]=function(t,e){var o=e.camera.getViewMatrix();t.uniformMatrix4fv(o)},t[a.WORLD_MATRIX]=function(t,o){var r=void 0!==o.transform?o.transform.matrix:e.IDENTITY;t.uniformMatrix4fv(r)},t[a.NORMAL_MATRIX]=function(t,o){var r=void 0!==o.transform?o.transform.normalMatrix:e.IDENTITY;t.uniformMatrix4fv(r)},t[a.VIEW_INVERSE_MATRIX]=function(t,e){var o=e.camera.getViewInverseMatrix();t.uniformMatrix4fv(o)},t[a.VIEW_PROJECTION_MATRIX]=function(t,e){var o=e.camera.getViewProjectionMatrix();t.uniformMatrix4fv(o)},t[a.VIEW_PROJECTION_INVERSE_MATRIX]=function(t,e){var o=e.camera.getViewProjectionInverseMatrix();t.uniformMatrix4fv(o)};for(var r=0;16>r;r++)t[a["TEXTURE"+r]]=function(t){return function(e){e.uniform1i(t)}}(r);for(var r=0;8>r;r++)t[a["LIGHT"+r]]=function(t){return function(e,o){var r=o.lights[t];void 0!==r?e.uniform3f(r.translation.data[0],r.translation.data[1],r.translation.data[2]):e.uniform3f(-20,20,20)}}(r);t[a.LIGHTCOUNT]=function(t,e){t.uniform1i(e.lights.length)},t[a.CAMERA]=function(t,e){var o=e.camera.translation;t.uniform3f(o.data[0],o.data[1],o.data[2])},t[a.NEAR_PLANE]=function(t,e){t.uniform1f(e.camera.near)},t[a.FAR_PLANE]=function(t,e){t.uniform1f(e.camera.far)},t[a.MAIN_NEAR_PLANE]=function(t,e){t.uniform1f(e.mainCamera.near)},t[a.MAIN_FAR_PLANE]=function(t,e){t.uniform1f(e.mainCamera.far)},t[a.MAIN_DEPTH_SCALE]=function(t,e){t.uniform1f(1/(e.mainCamera.far-e.mainCamera.near))},t[a.AMBIENT]=function(t,e){var o=void 0!==e.material.materialState?e.material.materialState.ambient:a.DEFAULT_AMBIENT;t.uniform4fv(o)},t[a.EMISSIVE]=function(t,e){var o=void 0!==e.material.materialState?e.material.materialState.emissive:a.DEFAULT_EMISSIVE;t.uniform4fv(o)},t[a.DIFFUSE]=function(t,e){var o=void 0!==e.material.materialState?e.material.materialState.diffuse:a.DEFAULT_DIFFUSE;t.uniform4fv(o)},t[a.SPECULAR]=function(t,e){var o=void 0!==e.material.materialState?e.material.materialState.specular:a.DEFAULT_SPECULAR;t.uniform4fv(o)},t[a.SPECULAR_POWER]=function(t,e){var o=void 0!==e.material.materialState?e.material.materialState.shininess:a.DEFAULT_SHININESS;o=Math.max(o,1),t.uniform1f(o)},t[a.TIME]=function(t){t.uniform1f(o.time)},t[a.TPF]=function(t){t.uniform1f(o.tpf)},t[a.RESOLUTION]=function(t,e){t.uniform2f(e.renderer.viewportWidth,e.renderer.viewportHeight)}}var l=window.WebGLRenderingContext;a.id=0,a.prototype.clone=function(){return new a(this.name,i.clone({precision:this.precision,processors:this.processors,builder:this.builder,defines:this.defines,attributes:this.attributes,uniforms:this.uniforms,vshader:this.origVertexSource,fshader:this.origFragmentSource}))},a.prototype.cloneOriginal=function(){return new a(this.name,this.originalShaderDefinition)};var h=/\b(attribute|uniform)\s+(float|int|bool|vec2|vec3|vec4|mat3|mat4|sampler2D|sampler3D|samplerCube)\s+(\w+)(\s*\[\s*\w+\s*\])*;/g;a.prototype.apply=function(t,e){var o=e.context,r=e.rendererRecord;null===this.shaderProgram&&(this._investigateShaders(),this.addDefines(this.defines),this.addPrecision(this.overridePrecision||e.shaderPrecision),this.compile(e));var i=!1;if(r.usedProgram!==this.shaderProgram&&(o.useProgram(this.shaderProgram),r.usedProgram=this.shaderProgram,i=!0),this.attributes)for(var n=t.meshData.attributeMap,a=this.attributes,s=Object.keys(a),l=0,h=s.length;h>l;l++){var d=s[l],c=n[a[d]];if(c){var u=this.attributeIndexMapping[d];void 0!==u&&(i&&e.context.enableVertexAttribArray(u),e.bindVertexAttribute(u,c))}}this._bindUniforms(t)},a.prototype._bindUniforms=function(t){if(this.uniforms){this.textureIndex=0;for(var e=Object.keys(this.uniforms),o=0,r=e.length;r>o;o++)this._bindUniform(e[o],t)}},a.prototype._bindUniform=function(t,e){var o=this.uniformCallMapping[t];if(void 0!==o){var r=void 0!==e.material.uniforms[t]?e.material.uniforms[t]:this.uniforms[t];if("string"==typeof r){var i=this.currentCallbacks[t];if(i)i(o,e);else{var n=this.textureSlotsNaming[t];if(void 0!==n){var a=e.material.getTexture(n.mapping);if(a instanceof Array){var s=[];n.index=[];for(var l=0;l<a.length;l++)n.index.push(this.textureIndex),s.push(this.textureIndex++);o.call(s)}else n.index=this.textureIndex,o.call(this.textureIndex++)}}}else{var h="function"==typeof r?r(e):r;o.call(h)}}},a.prototype.rebuild=function(){this.shaderProgram=null,this.attributeMapping={},this.attributeIndexMapping={},this.uniformMapping={},this.uniformCallMapping={},this.currentCallbacks={},this.vertexSource="function"==typeof this.origVertexSource?this.origVertexSource():this.origVertexSource,this.fragmentSource="function"==typeof this.origFragmentSource?this.origFragmentSource():this.origFragmentSource},a.prototype._investigateShaders=function(){this.textureSlots=[],this.textureSlotsNaming={},a.investigateShader(this.vertexSource,this),a.investigateShader(this.fragmentSource,this)},a.investigateShader=function(t,e){h.lastIndex=0;for(var o=h.exec(t);null!==o;){var r={format:o[2]},i=o[1],n=o[3],a=o[4];if(a&&("float"===r.format?r.format="floatarray":"int"===r.format?r.format="intarray":0===r.format.indexOf("sampler")&&(r.format="samplerArray")),"attribute"===i)e.attributeMapping[n]=r;else{if(0===r.format.indexOf("sampler")){var s={format:r.format,name:n,mapping:e.uniforms[n],index:e.textureSlots.length};e.textureSlots.push(s),e.textureSlotsNaming[s.name]=s}e.uniformMapping[n]=r}o=h.exec(t)}},a.prototype.compile=function(e){var o=e.context,r=this._getShader(o,l.VERTEX_SHADER,this.vertexSource),i=this._getShader(o,l.FRAGMENT_SHADER,this.fragmentSource);(null===r||null===i)&&console.error("Shader error - no shaders"),this.shaderProgram=o.createProgram();var a=o.getError();if((null===this.shaderProgram||a!==l.NO_ERROR)&&(console.error("Shader error: "+a+" [shader: "+this.name+"]"),n.emit("goo.shader.error")),o.attachShader(this.shaderProgram,r),o.attachShader(this.shaderProgram,i),o.linkProgram(this.shaderProgram),!o.getProgramParameter(this.shaderProgram,l.LINK_STATUS)){var s=o.getProgramInfoLog(this.shaderProgram);console.error("Could not initialise shaders: "+s),n.emit("goo.shader.error",s)}for(var h in this.attributeMapping){var d=o.getAttribLocation(this.shaderProgram,h);-1!==d&&(this.attributeIndexMapping[h]=d)}for(var h in this.uniformMapping){var c=o.getUniformLocation(this.shaderProgram,h);if(null!==c)this.uniformCallMapping[h]=new t(o,c,this.uniformMapping[h].format);else for(var u=this.textureSlots.length,p=0;u>p;p++){var m=this.textureSlots[p];if(m.name===h){for(this.textureSlots.splice(p,1),delete this.textureSlotsNaming[m.name];u-1>p;p++)this.textureSlots[p].index--;break}}}if(this.uniforms){if(this.uniforms.$link){for(var f=this.uniforms.$link instanceof Array?this.uniforms.$link:[this.uniforms.$link],p=0;p<f.length;p++){var g=f[p];for(var h in g)this.uniforms[h]=g[h]}delete this.uniforms.$link}for(var v in this.uniforms){var y=this.uniforms[v];this.defaultCallbacks[y]&&(this.currentCallbacks[v]=this.defaultCallbacks[y])}}};var d=/\b\d+:(\d+):\s(.+)\b/g,c=/\((\d+),\s*\d+\):\s(.+)/g;a.prototype._getShader=function(t,e,o){var r=t.createShader(e);if(t.shaderSource(r,o),t.compileShader(r),!t.getShaderParameter(r,l.COMPILE_STATUS)){var i=t.getShaderInfoLog(r),n=e===l.VERTEX_SHADER?"VertexShader":"FragmentShader";d.lastIndex=0;var a=d.exec(i);if(null===a&&(a=c.exec(i)),null!==a)for(;null!==a;){var s=o.split("\n"),h=a[1],u=a[2];console.error("Error in "+n+" - ["+this.name+"]["+this._id+"] at line "+h+":"),console.error("	Error: "+u),console.error("	Source: "+s[h-1]),a=d.exec(i)}else console.error("Error in "+n+" - ["+this.name+"]["+this._id+"] "+i);return null}return r};var u=/\bprecision\s+(lowp|mediump|highp)\s+(float|int);/g;a.prototype.addPrecision=function(t){u.lastIndex=0;var e=u.exec(this.vertexSource);null===e&&(this.vertexSource="precision "+t+" float;\n"+this.vertexSource),u.lastIndex=0;var o=u.exec(this.fragmentSource);null===o&&(this.fragmentSource="precision "+t+" float;\n"+this.fragmentSource)},a.prototype.addDefines=function(t){if(t){var e=this.generateDefines(t);this.vertexSource=e+"\n"+this.vertexSource,this.fragmentSource=e+"\n"+this.fragmentSource}},a.prototype.generateDefines=function(t){var e=[];for(var o in t){var r=t[o];if(r!==!1){var i="#define "+o+" "+r;e.push(i)}}return e.join("\n")},a.prototype.getShaderDefinition=function(){return{vshader:this.vertexSource,fshader:this.fragmentSource,defines:this.defines,attributes:this.attributes,uniforms:this.uniforms}},a.prototype.toString=function(){return this.name},a.PROJECTION_MATRIX="PROJECTION_MATRIX",a.VIEW_MATRIX="VIEW_MATRIX",a.VIEW_INVERSE_MATRIX="VIEW_INVERSE_MATRIX",a.VIEW_PROJECTION_MATRIX="VIEW_PROJECTION_MATRIX",a.VIEW_PROJECTION_INVERSE_MATRIX="VIEW_PROJECTION_INVERSE_MATRIX",a.WORLD_MATRIX="WORLD_MATRIX",a.NORMAL_MATRIX="NORMAL_MATRIX";for(var p=0;8>p;p++)a["LIGHT"+p]="LIGHT"+p;return a.CAMERA="CAMERA",a.AMBIENT="AMBIENT",a.EMISSIVE="EMISSIVE",a.DIFFUSE="DIFFUSE",a.SPECULAR="SPECULAR",a.SPECULAR_POWER="SPECULAR_POWER",a.NEAR_PLANE="NEAR_PLANE",a.FAR_PLANE="FAR_PLANE",a.MAIN_NEAR_PLANE="NEAR_PLANE",a.MAIN_FAR_PLANE="FAR_PLANE",a.MAIN_DEPTH_SCALE="DEPTH_SCALE",a.TIME="TIME",a.TPF="TPF",a.RESOLUTION="RESOLUTION",a.DIFFUSE_MAP="DIFFUSE_MAP",a.NORMAL_MAP="NORMAL_MAP",a.SPECULAR_MAP="SPECULAR_MAP",a.LIGHT_MAP="LIGHT_MAP",a.SHADOW_MAP="SHADOW_MAP",a.AO_MAP="AO_MAP",a.EMISSIVE_MAP="EMISSIVE_MAP",a.DEPTH_MAP="DEPTH_MAP",a.DEFAULT_AMBIENT=[.1,.1,.1,1],a.DEFAULT_EMISSIVE=[0,0,0,0],a.DEFAULT_DIFFUSE=[.8,.8,.8,1],a.DEFAULT_SPECULAR=[.6,.6,.6,1],a.DEFAULT_SHININESS=64,a.prototype.defaultCallbacks={},s(a.prototype.defaultCallbacks),a}),define("goo/renderer/Material",["goo/renderer/Shader"],function(t){"use strict";function e(){this.id=null,this.name="Default Material",this.shader=null,"string"==typeof arguments[0]?this.name=arguments[0]:arguments[0]&&arguments[0].vshader&&arguments[0].fshader&&(this.shader=e.createShader(arguments[0])),arguments[1]&&arguments[1].vshader&&arguments[1].fshader?this.shader=e.createShader(arguments[1]):"string"==typeof arguments[1]&&(this.name=arguments[1]),this.uniforms={},this._textureMaps={},this.cullState={enabled:!0,cullFace:"Back",frontFace:"CCW"},this.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},this.depthState={enabled:!0,write:!0},this.offsetState={enabled:!1,factor:1,units:1},this.dualTransparency=!1,this.wireframe=!1,this.flat=!1,this.renderQueue=null}return e.prototype.setTexture=function(t,e){this._textureMaps[t]=e},e.prototype.getTexture=function(t){return this._textureMaps[t]},e.prototype.removeTexture=function(t){delete this._textureMaps[t]},e.prototype.getTextures=function(){var t=[];for(var e in this._textureMaps)t.push(this._textureMaps[e]);return t},e.prototype.getTextureEntries=function(){return this._textureMaps},e.prototype.getRenderQueue=function(){return null!==this.renderQueue?this.renderQueue:null!==this.shader?this.shader.renderQueue:1e3},e.prototype.setRenderQueue=function(t){this.renderQueue=t},e.store=[],e.hash=[],e.createShader=function(o,r){var i=e.store.indexOf(o);if(-1!==i)return e.hash[i];var n=new t(r||null,o);return null===n.name&&(n.name="DefaultShader"+n._id),e.store.push(o),e.hash.push(n),n},e.clearShaderCache=function(){e.store.length=0,e.hash.length=0},e.createMaterial=function(t,o){var r=new e(o||"DefaultMaterial");return r.shader=e.createShader(t),r},e.createEmptyMaterial=function(t,o){var r=new e(o||"Empty Material");return r.empty(),r.shader=t?e.createShader(t):void 0,r},e.prototype.empty=function(){this.cullState={},this.blendState={},this.depthState={},this.offsetState={},this.wireframe=void 0,this.renderQueue=void 0,this.flat=void 0,this._textureMaps={},this.shader=void 0,this.uniforms={}},e}),define("goo/entities/components/MeshRendererComponent",["goo/entities/components/Component","goo/renderer/Material"],function(t,e){"use strict";function o(t){this.type="MeshRendererComponent",this.materials=Array.isArray(t)?t:t?[t]:[],this.worldBound=null,this.cullMode="Dynamic",this.castShadows=!0,this.receiveShadows=!0,this.isPickable=!0,this.isReflectable=!0,this.hidden=!1}return o.prototype=Object.create(t.prototype),o.prototype.updateBounds=function(t,e){this.worldBound=t.transform(e,this.worldBound)},o.applyOnEntity=function(t,r){var i=r.meshRendererComponent;i||(i=new o);var n=!1;return t instanceof e&&(i.materials.push(t),n=!0),n?(r.setComponent(i),!0):void 0},o}),define("goo/util/Handy",[],function(){"use strict";function t(){}return t.deepFreeze=function(e){var o,r;Object.freeze(e);for(r in e)o=e[r],e.hasOwnProperty(r)&&"object"==typeof o&&!Object.isFrozen(o)&&t.deepFreeze(o)},t.defineProperty=function(t,e,o,r){var i=o;Object.defineProperty(t,e,{get:function(){return i},set:function(t){i=t,r(i)},configurable:!0,enumerable:!0})},t.addListener=function(t,e,o,r){var i=t[e];Object.defineProperty(t,e,{get:function(){return o&&o(),i},set:function(t){i=t,r&&r(i)},configurable:!0,enumerable:!0})},t}),define("goo/math/Plane",["goo/math/Vector3"],function(t){"use strict";function e(e,o){this.normal=new t(void 0!==e?e:t.UNIT_Y),this.constant=isNaN(o)?0:o}e.XZ=new e(t.UNIT_Y,0),e.XY=new e(t.UNIT_Z,0),e.YZ=new e(t.UNIT_X,0),e.prototype.pseudoDistance=function(t){return this.normal.dot(t)-this.constant},e.prototype.setPlanePoints=function(t,e,o){return this.normal.set(e).sub(t),this.normal.cross([o.x-t.x,o.y-t.y,o.z-t.z]).normalize(),this.constant=this.normal.dot(t),this},e.prototype.reflectVector=function(e,o){var r=o;"undefined"==typeof r&&(r=new t);var i=2*this.normal.dot(e);return r.set(e).sub([this.normal.x*i,this.normal.y*i,this.normal.z*i]),r};var o=new t;return e.prototype.rayIntersect=function(e,r){r=r||new t;var i=e.direction.dot(this.normal);if(Math.abs(i)<1e-8)return console.warn("Ray parallell with plane"),null;var n=this.constant,a=o.set(this.normal).muld(n,n,n).subv(e.origin).dot(this.normal),s=a/i;return r.setv(e.direction).muld(s,s,s).addv(e.origin)},e}),define("goo/math/Ray",["goo/math/Vector3","goo/math/MathUtils"],function(t,e){"use strict";function o(e,o){this.origin=e||new t,this.direction=o||(new t).copy(t.UNIT_Z),this.calcVec1=new t,this.calcVec2=new t,this.calcVec3=new t,this.calcVec4=new t}return o.prototype.intersects=function(t,e,o){return 3===t.length?this.intersectsTriangle(t[0],t[1],t[2],e,o):4===t.length?this.intersectsTriangle(t[0],t[1],t[2],e,o)||this.intersectsTriangle(t[0],t[2],t[3],e,o):!1},o.prototype.intersectsTriangle=function(o,r,i,n,a){var s,l=this.calcVec1.set(this.origin).sub(o),h=this.calcVec2.set(r).sub(o),d=this.calcVec3.set(i).sub(o),c=this.calcVec4.set(h).cross(d),u=this.direction.dot(c);if(u>e.EPSILON)s=1;else{if(!(u<-e.EPSILON))return!1;s=-1,u=-u}var p=s*this.direction.dot(t.cross(l,d,d)),m=!1;if(p>=0){var f=s*this.direction.dot(h.cross(l));if(f>=0&&u>=p+f){var g=-s*l.dot(c);if(g>=0){if(!a)return!0;var v=1/u,y=g*v;if(n){var x=p*v,w=f*v;a.setd(y,x,w)}else a.setv(this.origin).add_d(this.direction.x*y,this.direction.y*y,this.direction.z*y);m=!0}}}return m},o.prototype.getDistanceToPrimitive=function(t){var e=this.calcVec1;return this.intersects(t,!1,e)?this.origin.distance(e.x,e.y,e.z):1/0},o.prototype.intersectsPlane=function(t,e){var o=t.normal,r=o.dot(this.direction);if(Math.abs(r)<1e-5)return!1;var i=-o.dot(this.origin)+t.constant,n=i/r;return 1e-5>n?!1:(e&&e.setv(this.direction).scale(n).addv(this.origin),!0)},o.prototype.distanceSquared=function(t,e){var o=this.calcVec1;o.setv(t).subv(this.origin);var r=this.direction.dot(o);return r>0?(o.setv(this.direction).scale(r),o.addv(this.origin)):o.setv(this.origin),e&&e.setv(o),o.subv(t),o.lengthSquared()},o}),define("goo/renderer/Camera",["goo/util/Handy","goo/math/Vector3","goo/math/Vector4","goo/math/Matrix4x4","goo/math/Plane","goo/math/MathUtils","goo/math/Ray","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(n,a,s,l){n="undefined"!=typeof n?n:45,a="undefined"!=typeof a?a:1,s="undefined"!=typeof s?s:1,l="undefined"!=typeof l?l:1e3,this.translation=new e(0,0,0),this._left=new e(-1,0,0),this._up=new e(0,1,0),this._direction=new e(0,0,-1),t.defineProperty(this,"this._depthRangeNear",0,function(){this._depthRangeDirty=!0}),t.defineProperty(this,"this._depthRangeFar",1,function(){this._depthRangeDirty=!0}),this._depthRangeDirty=!0,this._frustumNear=1,this._frustumFar=2,this._frustumLeft=-.5,this._frustumRight=.5,this._frustumTop=.5,this._frustumBottom=-.5,this._coeffLeft=[],this._coeffRight=[],this._coeffBottom=[],this._coeffTop=[],this._viewPortLeft=0,this._viewPortRight=1,this._viewPortTop=1,this._viewPortBottom=0,this._planeQuantity=6,this._worldPlane=[];for(var h=0;h<d.FRUSTUM_PLANES;h++)this._worldPlane[h]=new i;this._newDirection=new e,this.projectionMode=d.Perspective,this.lockedRatio=!1,this.aspect=a,this._updateMVMatrix=!0,this._updateInverseMVMatrix=!0,this._updatePMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVPMatrix=!0,this.modelView=new r,this.modelViewInverse=new r,this.projection=new r,this.modelViewProjection=new r,this.modelViewProjectionInverse=new r,this._depthRangeDirty=!0,this._viewPortDirty=!0,this._planeState=0,this._clipPlane=new o,this._qCalc=new o,this._corners=[];for(var h=0;8>h;h++)this._corners.push(new e);this._extents=new e,this.vNearPlaneCenter=new e,this.vFarPlaneCenter=new e,this.direction=new e,this.left=new e,this.up=new e,this.planeNormal=new e,this.changedProperties=!0,this.setFrustumPerspective(n,a,s,l),this.onFrameChange()}d.LEFT_PLANE=0,d.RIGHT_PLANE=1,d.BOTTOM_PLANE=2,d.TOP_PLANE=3,d.FAR_PLANE=4,d.NEAR_PLANE=5,d.FRUSTUM_PLANES=6,d.Perspective=0,d.Parallel=1,d.Custom=2,d.Outside=0,d.Inside=1,d.Intersects=2,d.prototype.normalize=function(){this._left.normalize(),this._up.normalize(),this._direction.normalize(),this.onFrameChange()},d.prototype.setProjectionMode=function(t){this.projectionMode=t,this.update()},d.prototype.setFrustumPerspective=function(t,e,o,r){if(void 0!==t&&null!==t&&(this.fov=t),void 0!==e&&null!==e&&(this.aspect=e),void 0!==o&&null!==o&&(this.near=o),void 0!==r&&null!==r&&(this.far=r),void 0!==this.fov){var i=Math.tan(this.fov*n.DEG_TO_RAD*.5)*this.near,a=i*this.aspect;this._frustumLeft=-a,this._frustumRight=a,this._frustumBottom=-i,this._frustumTop=i,this._frustumNear=this.near,this._frustumFar=this.far,this.onFrustumChange()}},d.prototype.setFrustum=function(t,e,o,r,i,n,a){void 0!==t&&null!==t&&(this.near=t),void 0!==e&&null!==e&&(this.far=e),void 0!==o&&null!==o&&(this.left=o),void 0!==r&&null!==r&&(this.right=r),void 0!==i&&null!==i&&(this.top=i),void 0!==n&&null!==n&&(this.bottom=n),void 0!==a&&null!==a&&(this.aspect=a),this._frustumNear=this.near,this._frustumFar=this.far,this._frustumLeft=this.left*this.aspect,this._frustumRight=this.right*this.aspect,this._frustumTop=this.top,this._frustumBottom=this.bottom,this.onFrustumChange()},d.prototype.copy=function(t){this.translation.setv(t.translation),this._left.setv(t._left),this._up.setv(t._up),this._direction.setv(t._direction),this.fov=t.fov,this.aspect=t.aspect,this.near=t.near,this.far=t.far,this._frustumLeft=t._frustumLeft,this._frustumRight=t._frustumRight,this._frustumBottom=t._frustumBottom,this._frustumTop=t._frustumTop,this._frustumNear=t._frustumNear,this._frustumFar=t._frustumFar,this.projectionMode=t.projectionMode,this._depthRangeDirty=!0,this.onFrustumChange(),this.onFrameChange()},d.prototype.setFrame=function(t,e,o,r){this._left.copy(e),this._up.copy(o),this._direction.copy(r),this.translation.copy(t),this.onFrameChange()},d.prototype.lookAt=function(t,o){this._newDirection.copy(t).sub(this.translation).normalize(),this._newDirection.equals(this._direction)||(this._direction.copy(this._newDirection),this._up.copy(o).normalize(),this._up.equals(e.ZERO)&&this._up.copy(e.UNIT_Y),this._left.copy(this._up).cross(this._direction).normalize(),this._left.equals(e.ZERO)&&(0!==this._direction.x?this._left.set(this._direction.y,-this._direction.x,0):this._left.set(0,this._direction.z,-this._direction.y)),this._up.copy(this._direction).cross(this._left).normalize(),this.onFrameChange())},d.prototype.makeDirty=function(){this._depthRangeDirty=!0,this._viewPortDirty=!0},d.prototype.update=function(){this._depthRangeDirty=!0,this.onFrustumChange(),this.onFrameChange()},d.prototype.setViewPort=function(){console.warn("Camera.setViewPort() not implemented.")},d.prototype.contains=function(t){if(!t)return d.Inside;for(var e=d.Inside,o=d.FRUSTUM_PLANES-1;o>=0;o--)switch(t.whichSide(this._worldPlane[o])){case h.Inside:return d.Outside;case h.Outside:break;case h.Intersects:e=d.Intersects}return e},d.prototype.onFrustumChange=function(){if(this.projectionMode===d.Perspective){var t=this._frustumNear*this._frustumNear,e=this._frustumLeft*this._frustumLeft,o=this._frustumRight*this._frustumRight,r=this._frustumBottom*this._frustumBottom,i=this._frustumTop*this._frustumTop,n=1/Math.sqrt(t+e);this._coeffLeft[0]=this._frustumNear*n,this._coeffLeft[1]=-this._frustumLeft*n,n=1/Math.sqrt(t+o),this._coeffRight[0]=-this._frustumNear*n,this._coeffRight[1]=this._frustumRight*n,n=1/Math.sqrt(t+r),this._coeffBottom[0]=this._frustumNear*n,this._coeffBottom[1]=-this._frustumBottom*n,n=1/Math.sqrt(t+i),this._coeffTop[0]=-this._frustumNear*n,this._coeffTop[1]=this._frustumTop*n}else this.projectionMode===d.Parallel&&(this._frustumRight>this._frustumLeft?(this._coeffLeft[0]=-1,this._coeffLeft[1]=0,this._coeffRight[0]=1,this._coeffRight[1]=0):(this._coeffLeft[0]=1,this._coeffLeft[1]=0,this._coeffRight[0]=-1,this._coeffRight[1]=0),this._frustumTop>this._frustumBottom?(this._coeffBottom[0]=-1,this._coeffBottom[1]=0,this._coeffTop[0]=1,this._coeffTop[1]=0):(this._coeffBottom[0]=1,this._coeffBottom[1]=0,this._coeffTop[0]=-1,this._coeffTop[1]=0));this._updatePMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVMatrix=!0,this._updateInverseMVPMatrix=!0,this.changedProperties=!0},d.prototype.onFrameChange=function(){var t=this._direction.dot(this.translation),e=this.planeNormal;e.x=this._left.x*this._coeffLeft[0],e.y=this._left.y*this._coeffLeft[0],e.z=this._left.z*this._coeffLeft[0],e.add([this._direction.x*this._coeffLeft[1],this._direction.y*this._coeffLeft[1],this._direction.z*this._coeffLeft[1]]),this._worldPlane[d.LEFT_PLANE].normal.copy(e),this._worldPlane[d.LEFT_PLANE].constant=this.translation.dot(e),e.x=this._left.x*this._coeffRight[0],e.y=this._left.y*this._coeffRight[0],e.z=this._left.z*this._coeffRight[0],e.add([this._direction.x*this._coeffRight[1],this._direction.y*this._coeffRight[1],this._direction.z*this._coeffRight[1]]),this._worldPlane[d.RIGHT_PLANE].normal.copy(e),this._worldPlane[d.RIGHT_PLANE].constant=this.translation.dot(e),e.x=this._up.x*this._coeffBottom[0],e.y=this._up.y*this._coeffBottom[0],e.z=this._up.z*this._coeffBottom[0],e.add([this._direction.x*this._coeffBottom[1],this._direction.y*this._coeffBottom[1],this._direction.z*this._coeffBottom[1]]),this._worldPlane[d.BOTTOM_PLANE].normal.copy(e),this._worldPlane[d.BOTTOM_PLANE].constant=this.translation.dot(e),e.x=this._up.x*this._coeffTop[0],e.y=this._up.y*this._coeffTop[0],e.z=this._up.z*this._coeffTop[0],e.add([this._direction.x*this._coeffTop[1],this._direction.y*this._coeffTop[1],this._direction.z*this._coeffTop[1]]),this._worldPlane[d.TOP_PLANE].normal.copy(e),this._worldPlane[d.TOP_PLANE].constant=this.translation.dot(e),this.projectionMode===d.Parallel&&(this._frustumRight>this._frustumLeft?(this._worldPlane[d.LEFT_PLANE].constant=this._worldPlane[d.LEFT_PLANE].contant+this._frustumLeft,this._worldPlane[d.RIGHT_PLANE].constant=this._worldPlane[d.RIGHT_PLANE].contant-this._frustumRight):(this._worldPlane[d.LEFT_PLANE].constant=this._worldPlane[d.LEFT_PLANE].contant-this._frustumLeft,this._worldPlane[d.RIGHT_PLANE].constant=this._worldPlane[d.RIGHT_PLANE].contant+this._frustumRight),this._frustumBottom>this._frustumTop?(this._worldPlane[d.TOP_PLANE].constant=this._worldPlane[d.TOP_PLANE].contant+this._frustumTop,this._worldPlane[d.BOTTOM_PLANE].constant=this._worldPlane[d.BOTTOM_PLANE].contant-this._frustumBottom):(this._worldPlane[d.TOP_PLANE].constant=this._worldPlane[d.TOP_PLANE].contant-this._frustumTop,this._worldPlane[d.BOTTOM_PLANE].constant=this._worldPlane[d.BOTTOM_PLANE].contant+this._frustumBottom)),e.copy(this._direction).invert(),this._worldPlane[d.FAR_PLANE].normal.copy(e),this._worldPlane[d.FAR_PLANE].constant=-(t+this._frustumFar),this._worldPlane[d.NEAR_PLANE].normal.copy(this._direction),this._worldPlane[d.NEAR_PLANE].constant=t+this._frustumNear,this._updateMVMatrix=!0,this._updateMVPMatrix=!0,this._updateInverseMVMatrix=!0,this._updateInverseMVPMatrix=!0},d.prototype.updateProjectionMatrix=function(){if(this.projectionMode===d.Parallel){this.projection.setIdentity();var t=this.projection.data;t[0]=2/(this._frustumRight-this._frustumLeft),t[5]=2/(this._frustumTop-this._frustumBottom),t[10]=-2/(this._frustumFar-this._frustumNear),t[12]=-(this._frustumRight+this._frustumLeft)/(this._frustumRight-this._frustumLeft),t[13]=-(this._frustumTop+this._frustumBottom)/(this._frustumTop-this._frustumBottom),t[14]=-(this._frustumFar+this._frustumNear)/(this._frustumFar-this._frustumNear)}else if(this.projectionMode===d.Perspective){this.projection.setIdentity();var t=this.projection.data;t[0]=2*this._frustumNear/(this._frustumRight-this._frustumLeft),t[5]=2*this._frustumNear/(this._frustumTop-this._frustumBottom),t[8]=(this._frustumRight+this._frustumLeft)/(this._frustumRight-this._frustumLeft),t[9]=(this._frustumTop+this._frustumBottom)/(this._frustumTop-this._frustumBottom),t[10]=-(this._frustumFar+this._frustumNear)/(this._frustumFar-this._frustumNear),t[11]=-1,t[14]=-(2*this._frustumFar*this._frustumNear)/(this._frustumFar-this._frustumNear),t[15]=-0}},d.prototype.updateModelViewMatrix=function(){this.modelView.setIdentity();var t=this.modelView.data;t[0]=-this._left.x,t[4]=-this._left.y,t[8]=-this._left.z,t[1]=this._up.x,t[5]=this._up.y,t[9]=this._up.z,t[2]=-this._direction.x,t[6]=-this._direction.y,t[10]=-this._direction.z,t[12]=this._left.dot(this.translation),t[13]=-this._up.dot(this.translation),t[14]=this._direction.dot(this.translation)},d.prototype.getPickRay=function(t,o,r,i,n){n||(n=new a);var s=new e,l=new e;return this.getWorldCoordinates(t,i-o,r,i,0,s),this.getWorldCoordinates(t,i-o,r,i,.3,l).sub(s).normalize(),n.origin.copy(s),n.direction.copy(l),n},d.prototype.getWorldPosition=function(t,r,i,n,a,s){s||(s=new e),a=this.far/(this.far-this.near)+this.far*this.near/(this.near-this.far)/a,this.checkInverseModelViewProjection();var l=new o;return l.set((t/i-this._viewPortLeft)/(this._viewPortRight-this._viewPortLeft)*2-1,((n-r)/n-this._viewPortBottom)/(this._viewPortTop-this._viewPortBottom)*2-1,2*a-1,1),this.modelViewProjectionInverse.applyPost(l),l.mul(1/l.w),s.x=l.x,s.y=l.y,s.z=l.z,s},d.prototype.getWorldCoordinates=function(t,r,i,n,a,s){s||(s=new e),this.checkInverseModelViewProjection();var l=new o;return l.set((t/i-this._viewPortLeft)/(this._viewPortRight-this._viewPortLeft)*2-1,(r/n-this._viewPortBottom)/(this._viewPortTop-this._viewPortBottom)*2-1,2*a-1,1),this.modelViewProjectionInverse.applyPost(l),l.mul(1/l.w),s.x=l.x,s.y=l.y,s.z=l.z,s},d.prototype.getScreenCoordinates=function(t,e,o,r){return r=this.getNormalizedDeviceCoordinates(t,r),r.x=(r.x+1)*(this._viewPortRight-this._viewPortLeft)/2*e,r.y=(r.y+1)*(this._viewPortTop-this._viewPortBottom)/2*o,r.z=(r.z+1)/2,r},d.prototype.getFrustumCoordinates=function(t,e){return e=this.getNormalizedDeviceCoordinates(t,e),e.x=(e.x+1)*(this._frustumRight-this._frustumLeft)/2+this._frustumLeft,e.y=(e.y+1)*(this._frustumTop-this._frustumBottom)/2+this._frustumBottom,e.z=(e.z+1)*(this._frustumFar-this._frustumNear)/2+this._frustumNear,e
},d.prototype.getNormalizedDeviceCoordinates=function(t,r){r||(r=new e),this.checkModelViewProjection();var i=new o;return i.set(t.x,t.y,t.z,1),this.modelViewProjection.applyPost(i),i.mul(1/i.w),r.x=i.x,r.y=i.y,r.z=i.z,r},d.prototype.checkModelView=function(){this._updateMVMatrix&&(this.updateModelViewMatrix(),this._updateMVMatrix=!1)},d.prototype.checkProjection=function(){this._updatePMatrix&&(this.updateProjectionMatrix(),this._updatePMatrix=!1)},d.prototype.checkModelViewProjection=function(){this._updateMVPMatrix&&(this.checkModelView(),this.checkProjection(),this.modelViewProjection.copy(this.getProjectionMatrix()).combine(this.getViewMatrix()),this._updateMVPMatrix=!1)},d.prototype.checkInverseModelView=function(){this._updateInverseMVMatrix&&(this.checkModelView(),r.invert(this.modelView,this.modelViewInverse),this._updateInverseMVMatrix=!1)},d.prototype.checkInverseModelViewProjection=function(){this._updateInverseMVPMatrix&&(this.checkModelViewProjection(),r.invert(this.modelViewProjection,this.modelViewProjectionInverse),this._updateInverseMVPMatrix=!1)},d.prototype.getViewMatrix=function(){return this.checkModelView(),this.modelView},d.prototype.getProjectionMatrix=function(){return this.checkProjection(),this.projection},d.prototype.getViewProjectionMatrix=function(){return this.checkModelViewProjection(),this.modelViewProjection},d.prototype.getViewInverseMatrix=function(){return this.checkInverseModelView(),this.modelViewInverse},d.prototype.getViewProjectionInverseMatrix=function(){return this.checkInverseModelViewProjection(),this.modelViewProjectionInverse},d.prototype.pack=function(t){for(var e=t.center,r=this._corners,i=this._extents,n=0;n<r.length;n++)r[n].set(e);t instanceof s?i.setd(t.xExtent,t.yExtent,t.zExtent):t instanceof l&&i.setd(t.radius,t.radius,t.radius),r[0].add_d(i.x,i.y,i.z),r[1].add_d(i.x,-i.y,i.z),r[2].add_d(i.x,i.y,-i.z),r[3].add_d(i.x,-i.y,-i.z),r[4].add_d(-i.x,i.y,i.z),r[5].add_d(-i.x,-i.y,i.z),r[6].add_d(-i.x,i.y,-i.z),r[7].add_d(-i.x,-i.y,-i.z);for(var a=this.getViewMatrix(),h=Number.MAX_VALUE,d=-Number.MAX_VALUE,c=new o,n=0;n<r.length;n++)c.setd(r[n].x,r[n].y,r[n].z,1),a.applyPre(c),h=Math.min(-c.z,h),d=Math.max(-c.z,d);h=Math.min(Math.max(this._frustumNear,h),this._frustumFar),d=Math.max(h,Math.min(this._frustumFar,d));var u=h/this._frustumNear;this._frustumLeft=this._frustumLeft*u,this._frustumRight=this._frustumRight*u,this._frustumTop=this._frustumTop*u,this._frustumBottom=this._frustumBottom*u,this._frustumNear=h,this._frustumFar=d},d.prototype.calculateFrustumCorners=function(t,e){t=void 0!==t?t:this._frustumNear,e=void 0!==e?e:this._frustumFar;var o=(this._frustumTop-this._frustumBottom)*t*.5/this._frustumNear,r=(this._frustumRight-this._frustumLeft)*t*.5/this._frustumNear,i=(this._frustumTop-this._frustumBottom)*e*.5/this._frustumNear,n=(this._frustumRight-this._frustumLeft)*e*.5/this._frustumNear;this.projectionMode===d.Parallel&&(o=.5*(this._frustumTop-this._frustumBottom),r=.5*(this._frustumRight-this._frustumLeft),i=.5*(this._frustumTop-this._frustumBottom),n=.5*(this._frustumRight-this._frustumLeft));var a=this.vNearPlaneCenter,s=this.vFarPlaneCenter,l=this.direction,h=this.left,c=this.up;return l.setv(this._direction).mul(t),a.setv(this.translation).addv(l),l.setv(this._direction).mul(e),s.setv(this.translation).addv(l),h.setv(this._left).mul(r),c.setv(this._up).mul(o),this._corners[0].setv(a).subv(h).subv(c),this._corners[1].setv(a).addv(h).subv(c),this._corners[2].setv(a).addv(h).addv(c),this._corners[3].setv(a).subv(h).addv(c),h.setv(this._left).mul(n),c.setv(this._up).mul(i),this._corners[4].setv(s).subv(h).subv(c),this._corners[5].setv(s).addv(h).subv(c),this._corners[6].setv(s).addv(h).addv(c),this._corners[7].setv(s).subv(h).addv(c),this._corners};var c=function(t){return t>0?1:0>t?-1:0};return d.prototype.setToObliqueMatrix=function(t,e){e=e||0;var r=this._clipPlane.setv(t);this.getViewMatrix().applyPost(r),r.w=this.translation.y*t.y+e,this._updatePMatrix=!0;var i=this.getProjectionMatrix();this._qCalc.setd((c(r.x)+i[8])/i[0],(c(r.y)+i[9])/i[5],-1,(1+i[10])/i[14]),r.mul(2/o.dot(r,this._qCalc)),i[2]=r.x,i[6]=r.y,i[10]=r.z+1,i[14]=r.w,this._updateMVPMatrix=!0,this._updateInverseMVPMatrix=!0},d}),define("goo/entities/components/CameraComponent",["goo/entities/components/Component","goo/math/Vector3","goo/renderer/Camera","goo/entities/SystemBus"],function(t,e,o,r){"use strict";function i(t){this.type="CameraComponent",this.camera=t,this.leftVec=new e(-1,0,0),this.upVec=new e(0,1,0),this.dirVec=new e(0,0,-1),this.api={setAsMainCamera:function(){return r.emit("goo.setCurrentCamera",{camera:this.cameraComponent.camera,entity:this}),this}}}return i.type="CameraComponent",i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype.setUpVector=function(t){0===t?(this.leftVec.setd(0,-1,0),this.upVec.setd(1,0,0),this.dirVec.setd(0,0,-1)):2===t?(this.leftVec.setd(-1,0,0),this.upVec.setd(0,0,1),this.dirVec.setd(0,-1,0)):(this.leftVec.setd(-1,0,0),this.upVec.setd(0,1,0),this.dirVec.setd(0,0,-1))},i.prototype.updateCamera=function(t){this.camera._left.setv(this.leftVec),t.matrix.applyPostVector(this.camera._left),this.camera._up.setv(this.upVec),t.matrix.applyPostVector(this.camera._up),this.camera._direction.setv(this.dirVec),t.matrix.applyPostVector(this.camera._direction),t.matrix.getTranslation(this.camera.translation),this.camera.update()},i.applyOnEntity=function(t,e){if(t instanceof o){var r=new i(t);return e.setComponent(r),!0}},i}),define("goo/renderer/light/Light",["goo/math/Vector3"],function(t){"use strict";function e(e){this.translation=new t,this.color=e||new t(1,1,1),this.intensity=1,this.specularIntensity=1,this.shadowCaster=!1,this.lightCookie=null,this.shadowSettings={size:100,near:1,far:1e3,resolution:[512,512],upVector:t.UNIT_Y,darkness:1,shadowType:"VSM"},this.changedProperties=!1,this.changedColor=!1}return e}),define("goo/entities/components/LightComponent",["goo/entities/components/Component","goo/renderer/light/Light"],function(t,e){"use strict";function o(t){this.type="LightComponent",this.light=t,this.hidden=!1}return o.prototype=Object.create(t.prototype),o.prototype.updateLight=function(t){this.light.update(t)},o.applyOnEntity=function(t,r){if(t instanceof e){var i=new o(t);return r.setComponent(i),!0}},o}),define("goo/util/ObjectUtil",[],function(){"use strict";var t={},e=Array.prototype,o=Object.prototype,r={},i=e.slice,n=o.toString,a=o.hasOwnProperty,s=Array.isArray,l=Object.keys,h=e.forEach;t.has=function(t,e){return a.call(t,e)},t.defaults=function(t){return d(i.call(arguments,1),function(e){if(e)for(var o in e)("undefined"==typeof t[o]||null===t[o])&&(t[o]=e[o])}),t},t.extend=function(t){return d(i.call(arguments,1),function(e){if(e)for(var o in e)t[o]=e[o]}),t},t.isObject=function(t){return t===Object(t)},t.clone=function(e){return t.isObject(e)?t.isArray(e)?e.slice():t.extend({},e):e},t.keys=l||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var o=[];for(var r in e)t.has(e,r)&&(o[o.length]=r);return o},t.isArray=s||function(t){return"[object Array]"===n.call(t)};var d=t.each=t.forEach=function(e,o,i,n){if("undefined"!=typeof e&&null!==e)if(h&&e.forEach===h)e.forEach(o,i);else if(e.length===+e.length){for(var a=0,s=e.length;s>a;a++)if(o.call(i,e[a],a,e)===r)return}else{var l=t.keys(e);void 0!==n&&l.sort(function(t,o){return e[t][n]-e[o][n]});for(var a=0,d=l.length;d>a;a++)if(o.call(i,e[l[a]],l[a],e)===r)return}};return t.deepClone=function(e){if(!e)return e;var o,r=[Number,String,Boolean];if(r.forEach(function(t){e instanceof t&&(o=t(e))}),"undefined"==typeof o)if("[object Array]"===Object.prototype.toString.call(e))o=[],e.forEach(function(e,r){o[r]=t.deepClone(e)});else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var o=e.cloneNode(!0);else if(e.prototype)o=e;else if(e instanceof Date)o=new Date(e);else{o={};for(var i in e)o[i]=t.deepClone(e[i])}else o=e;return o},t.indexOf=function(t,e){for(var o=0;o<t.length;o++)if(o in t&&t[o]===e)return o;return-1},t}),define("goo/scripts/ScriptUtils",["goo/util/ObjectUtil"],function(t){"use strict";var e={};return e.fillDefaultValues=function(e,o){if(o instanceof Array){var r=[];o.forEach(function(o){o&&"string"==typeof o.key&&void 0!==o["default"]&&(r.push(o.key),"undefined"==typeof e[o.key]&&(e[o.key]=t.clone(o["default"])))});for(var i in e)-1===r.indexOf(i)&&"enabled"!==i&&delete e[i]}},e.fillDefaultNames=function(t){function e(t){if("string"!=typeof t||0===t.length)return"";var e=t[0].toUpperCase()+t.slice(1);return e.replace(/(.)([A-Z])/g,"$1 $2")}t instanceof Array&&t.forEach(function(t){t&&"undefined"==typeof t.name&&(t.name=e(t.key))})},e.getKey=function(t){return e._keys[t]?e._keys[t]:t.charCodeAt(0)},e._keys={Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Pause:19,Capslock:20,Esc:27,Space:32,Pageup:33,Pagedown:34,End:35,Home:36,Leftarrow:37,Uparrow:38,Rightarrow:39,Downarrow:40,Insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"0numpad":96,"1numpad":97,"2numpad":98,"3numpad":99,"4numpad":100,"5numpad":101,"6numpad":102,"7numpad":103,"8numpad":104,"9numpad":105,Multiply:106,Plus:107,Minus:109,Dot:110,Slash1:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Equals:187,Comma:188,Slash:191,Backslash:220},e._keyInverse=function(t){for(var e={},o=Object.keys(t),r=0;r<o.length;r++)e[t[o[r]]]=o[r];return e}(e._keys),e.keyForCode=function(t){return e._keyInverse[t]},e}),define("goo/scripts/Scripts",["goo/scripts/ScriptUtils","goo/util/ObjectUtil"],function(t,e){"use strict";var o={},r={},i={};return i.register=function(e){var r=e.externals.key||e.externals.name;return o[r]?void console.warn("Script already registered for key "+r):(t.fillDefaultNames(e.externals.parameters),void(o[r]=e))},i.addClass=function(t,e){r[t]=e},i.getClasses=function(){return r},i.getScript=function(t){return o[t]},i.create=function(r,i){if(!o[r])throw new Error("Script is not registered");var n=o[r]();return n.parameters={},n.environment=null,n.externals=o[r].externals,o[r].externals&&t.fillDefaultValues(n.parameters,o[r].externals.parameters),i&&e.extend(n.parameters,i),n},i.allScripts=function(){for(var t={},e=Object.keys(o),r=0;r<e.length;r++){var i=e[r];t[i]=o[i]}return t},i}),define("goo/scripts/newwave/OrbitCamControlScript",["goo/math/Vector3","goo/math/Vector2","goo/math/MathUtils"],function(t,e,o){"use strict";function r(){function r(r,i){T=i.domElement,E=["Any","Left","Middle","Right"].indexOf(r.dragButton)-1,-1>E&&(E=-1),i.smoothness=Math.pow(o.clamp(r.smoothness,0,1),.3),i.inertia=Math.pow(o.clamp(r.drag,0,1),.3),v=[0,0,0,0,0],y=[0,0,0,0,0],x=[0,0,0,0,0],w=0,_=new e(0,0),i.spherical=f=new t(r.spherical),f.data[1]*=o.DEG_TO_RAD,f.data[2]*=o.DEG_TO_RAD,i.lookAtPoint=g=new t(r.lookAtPoint),i.goingToLookAt=new t(g),i.targetSpherical=b=new t(f),S=new t,C=new t(t.UNIT_Y),P=200,i.dirty=!0,M={buttonDown:!1,lastX:0/0,lastY:0/0},c(r,i)}function i(t,e,r,i){i.domElement!==document&&i.domElement.focus(),(-1===E||E===t)&&(M.buttonDown=e,e?(M.lastX=0/0,M.lastY=0/0,_.set(0,0),f.y=o.moduloPositive(f.y,o.TWO_PI),b.copy(f)):d(r))}function n(t,e,o,r){var i=0,n=0;isNaN(M.lastX)||isNaN(M.lastY)?(M.lastX=t,M.lastY=e):(i=-(t-M.lastX),n=e-M.lastY,M.lastX=t,M.lastY=e),!M.buttonDown||0===i&&0===n||(v[w]=Date.now(),y[w]=i,x[w]=n,w++,w>v.length-1&&(w=0),_.set(0,0),s(o.orbitSpeed*i,o.orbitSpeed*n,o,r))}function a(t,e,r){var i=(e+r)/2+(r>e?Math.PI:0),n=o.moduloPositive(t-i,o.TWO_PI),a=o.moduloPositive(e-i,o.TWO_PI),s=o.moduloPositive(r-i,o.TWO_PI);return 0>t&&e>0?e-=o.TWO_PI:t>0&&0>e&&(e+=o.TWO_PI),t>o.TWO_PI&&r<o.TWO_PI&&(r+=o.TWO_PI),a>n?e:n>s?r:t}function s(t,e,r,i){if(r.clampAzimuth){var n=r.minAzimuth*o.DEG_TO_RAD,s=r.maxAzimuth*o.DEG_TO_RAD;b.y=a(b.y-t,n,s)}else b.y=b.y-t;var l=r.minAscent*o.DEG_TO_RAD,h=r.maxAscent*o.DEG_TO_RAD;b.z=o.clamp(b.z+e,l,h),i.dirty=!0}function l(t,e,o){var r=Math.max(-1,Math.min(1,-t.wheelDelta||t.detail));r*=A*b.x,h(e.zoomSpeed*r,e,o)}function h(t,e,r){b.x=o.clamp(b.x+t,e.minZoomDistance,e.maxZoomDistance),r.dirty=!0}function d(t){for(var e=Date.now(),o=0,r=0,i=!1,n=0,a=v.length;a>n;n++)e-v[n]<P&&(o+=y[n],r+=x[n],i=!0);i?_.set(o*t.orbitSpeed/v.length,r*t.orbitSpeed/v.length):_.set(0,0)}function c(t,e){var o=0;D={mousedown:function(o){t.whenUsed&&e.entity!==e.activeCameraEntity||i(o.button,!0,t,e)},mouseup:function(o){i(o.button,!1,t,e)},mousemove:function(o){t.whenUsed&&e.entity!==e.activeCameraEntity||n(o.clientX,o.clientY,t,e)},mouseleave:function(t){e.listeners.mouseup(t)},mousewheel:function(o){t.whenUsed&&e.entity!==e.activeCameraEntity||l(o,t,e)},touchstart:function(o){t.whenUsed&&e.entity!==e.activeCameraEntity||i(E,1===o.targetTouches.length,t,e)},touchend:function(){i(E,!1,t,e),o=0},touchmove:function(r){if(!t.whenUsed||e.entity===e.activeCameraEntity){var i,a,s,h=r.targetTouches,d=h[0].clientX,c=h[0].clientY;if(2===h.length){var u=h[1].clientX,p=h[1].clientY;s=(d-u)*(d-u)+(c-p)*(c-p)}else i=d,a=c,n(i,a,t,e);var m=(s-o)/Math.max(T.height,T.width);m/=3,0===o?o=s:2===h.length&&Math.abs(m)>.3&&(l({wheelDelta:m},t,e),o=s)}}},D.DOMMouseScroll=D.mousewheel,D.mouseleave=D.mouseup;for(var r in D)e.domElement.addEventListener(r,D[r]);T.oncontextmenu=function(){return!1}}function u(t,e,r){if(_.lengthSquared()>1e-6){s(_.x,_.y,e,r);var i=o.lerp(r.inertia,0,1-t/r.inertia);_.mul(i)}else _.set(0,0,0)}function p(t,e,r){var i=e.entity,n=i.transformComponent,a=n.transform,s=o.lerp(e.smoothness,1,e.world.tpf);e.goingToLookAt.equals(e.lookAtPoint)||(e.lookAtPoint.lerp(e.goingToLookAt,s),e.dirty=!0),t.releaseVelocity&&u(i._world.tpf,t,e),e.dirty&&(f.y=t.clampAzimuth?o.lerp(s,f.y,b.y):o.lerp(s,f.y,b.y),f.x=o.lerp(s,f.x,b.x),f.z=o.lerp(s,f.z,b.z),o.sphericalToCartesian(f.x,f.y,f.z,S),a.translation.set(S.add(g)),a.translation.equals(g)||a.lookAt(g,C),f.distanceSquared(b)<1e-6&&(e.dirty=!1,f.y=o.moduloPositive(f.y,o.TWO_PI),b.copy(f),e.dirty=!1),n.setUpdated(),r.SystemBus.emit("goo.cameraPositionChanged",{spherical:e.spherical.data,translation:a.translation.data,lookAtPoint:e.lookAtPoint.data,id:i.id}))}function m(t,e){for(var o in D)e.domElement.removeEventListener(o,D[o])}var f,g,v,y,x,w,_,b,S,M,C,P,T,E,D,A=.035;return{setup:r,update:p,cleanup:m}}return r.externals={name:"OrbitCamControlScript",description:"Enables camera to orbit around a point in 3D space using the mouse",parameters:[{key:"whenUsed","default":!0,type:"boolean"},{key:"dragButton",description:"Button to enable dragging","default":"Any",options:["Any","Left","Middle","Right"],type:"string",control:"select"},{key:"orbitSpeed","default":.005,type:"float",scale:.001,decimals:3},{key:"zoomSpeed","default":1,type:"float",scale:.1},{key:"drag",name:"Inertia","default":.9,type:"float",control:"slider",min:0,max:1},{key:"smoothness","default":.4,type:"float",min:0,max:1,control:"slider"},{key:"minZoomDistance","default":1,type:"float",min:.01},{key:"maxZoomDistance","default":1e3,type:"float",min:1},{key:"minAscent",description:"Maximum arc the camera can reach below the target point","default":-89,type:"int",control:"slider",min:-89,max:89},{key:"maxAscent",description:"Maximum arc the camera can reach above the target point","default":89.95,type:"int",control:"slider",min:-89,max:89},{key:"clampAzimuth","default":!1,type:"boolean"},{key:"minAzimuth",description:"Maximum arc the camera can reach clockwise of the target point","default":90,type:"int",control:"slider",min:0,max:360},{key:"maxAzimuth",description:"Maximum arc the camera can reach counter-clockwise of the target point","default":270,type:"int",control:"slider",min:0,max:360},{key:"lookAtPoint",description:"The point to orbit around","default":[0,0,0],type:"vec3"},{key:"spherical",name:"Start Point",description:"The initial position of the camera given in spherical coordinates (r, theta, phi). Theta is the angle from the x-axis towards the z-axis, and phi is the angle from the xz-plane towards the y-axis.","default":[15,0,0],type:"vec3"}]},r}),define("goo/renderer/RendererRecord",[],function(){"use strict";function t(){this.currentBuffer={ArrayBuffer:{buffer:null,valid:!1},ElementArrayBuffer:{buffer:null,valid:!1}},this.currentFrameBuffer=null,this.clippingTestValid=!1,this.clippingTestEnabled=!1,this.clips=[],this.enabledTextures=0,this.texturesValid=!1,this.currentTextureArraysUnit=0,this.textureRecord=[],this.usedProgram=null,this.boundAttributes=[],this.depthRecord={},this.cullRecord={},this.blendRecord={},this.offsetRecord={},this.lineRecord={},this.pointRecord={}}return t.prototype.invalidateBuffer=function(t){this.currentBuffer[t].buffer=null,this.currentBuffer[t].valid=!1},t}),define("goo/renderer/Texture",["goo/math/Vector2"],function(t){"use strict";function e(e,o,r,i){this.glTexture=null,o=o||{},this.wrapS=o.wrapS||"Repeat",this.wrapT=o.wrapT||"Repeat",this.magFilter=o.magFilter||"Bilinear",this.minFilter=o.minFilter||"Trilinear",this.anisotropy=void 0!==o.anisotropy?o.anisotropy:1,this.format=o.format||"RGBA",this.type=o.type||"UnsignedByte",this.variant="2D",this.offset=new t(o.offset||[0,0]),this.repeat=new t(o.repeat||[1,1]),this.lodBias=0,this.generateMipmaps=void 0!==o.generateMipmaps?o.generateMipmaps:!0,this.premultiplyAlpha=void 0!==o.premultiplyAlpha?o.premultiplyAlpha:!1,this.unpackAlignment=void 0!==o.unpackAlignment?o.unpackAlignment:1,this.flipY=void 0!==o.flipY?o.flipY:!0,this.hasBorder=!1,this.needsUpdate=!1,this.updateCallback=null,this.readyCallback=null,e&&this.setImage(e,r,i,o)}return e.prototype.checkDataReady=function(){return this.image&&(this.image.dataReady||this.image instanceof HTMLImageElement)||null!==this.readyCallback&&this.readyCallback()},e.prototype.checkNeedsUpdate=function(){return this.needsUpdate||null!==this.updateCallback&&this.updateCallback()},e.prototype.setNeedsUpdate=function(){this.needsUpdate=!0},e.prototype.setImage=function(t,e,o,r){this.image=t;var i=t instanceof Array?t[0]:t;if(i instanceof Uint8Array||i instanceof Uint8ClampedArray||i instanceof Uint16Array||i instanceof Float32Array){if(e=e||t.width,o=o||t.height,void 0===e||void 0===o)throw"Data textures need width and height";this.image={data:t},this.image.width=e,this.image.height=o,this.image.isData=!0,this.image.dataReady=!0,i instanceof Uint8Array||i instanceof Uint8ClampedArray?this.type="UnsignedByte":i instanceof Uint16Array?(this.type="UnsignedShort565",this.format=r.format||"RGB"):i instanceof Float32Array&&(this.type="Float",this.format=r.format||"RGBA")}else i instanceof HTMLCanvasElement?this.image.dataReady=!0:t instanceof Array&&(this.image={data:t});this.setNeedsUpdate()},e.prototype.destroy=function(t){t.deleteTexture(this.glTexture)},e.CUBE_FACES=["PositiveX","NegativeX","PositiveY","NegativeY","PositiveZ","NegativeZ"],e}),define("goo/util/rsvp",["exports"],function(t){"use strict";function e(t,e){n.async(function(){t.trigger("promise:resolved",{detail:e}),t.isResolved=!0,t.resolvedValue=e})}function o(t,e){n.async(function(){t.trigger("promise:failed",{detail:e}),t.isRejected=!0,t.rejectedValue=e})}function r(t){var e,o=[],r=new g,i=t.length;0===i&&r.resolve([]);var n=function(t,e){o[t]=e,0===--i&&r.resolve(o)},a=function(t){return function(e){n(t,e)}},s=function(t){r.reject(t)};for(e=0;i>e;e++)t[e].then(a(e),s);return r}function i(t,e){n[t]=e}var n={},a="undefined"!=typeof window?window:{},s=a.MutationObserver||a.WebKitMutationObserver,l=window.process;if("undefined"!=typeof l&&"[object process]"==={}.toString.call(l))n.async=function(t,e){l.nextTick(function(){t.call(e)})};else if(s){var h=[],d=new s(function(){var t=h.slice();h=[],t.forEach(function(t){var e=t[0],o=t[1];e.call(o)})}),c=document.createElement("div");d.observe(c,{attributes:!0}),window.addEventListener("unload",function(){d.disconnect(),d=null}),n.async=function(t,e){h.push([t,e]),c.setAttribute("drainQueue","drainQueue")}}else n.async=function(t,e){setTimeout(function(){t.call(e)},1)};var u=function(t,e){this.type=t;for(var o in e)e.hasOwnProperty(o)&&(this[o]=e[o])},p=function(t,e){for(var o=0,r=t.length;r>o;o++)if(t[o][0]===e)return o;return-1},m=function(t){var e=t._promiseCallbacks;return e||(e=t._promiseCallbacks={}),e},f={mixin:function(t){return t.on=this.on,t.off=this.off,t.trigger=this.trigger,t},on:function(t,e,o){var r,i,n=m(this);for(t=t.split(/\s+/),o=o||this;i=t.shift();)r=n[i],r||(r=n[i]=[]),-1===p(r,e)&&r.push([e,o])},off:function(t,e){var o,r,i,n=m(this);for(t=t.split(/\s+/);r=t.shift();)e?(o=n[r],i=p(o,e),-1!==i&&o.splice(i,1)):n[r]=[]},trigger:function(t,e){var o,r,i,n,a,s=m(this);if(o=s[t])for(var l=0,h=o.length;h>l;l++)r=o[l],i=r[0],n=r[1],"object"!=typeof e&&(e={detail:e}),a=new u(t,e),i.call(n,a)}},g=function(){this.on("promise:resolved",function(t){this.trigger("success",{detail:t.detail})},this),this.on("promise:failed",function(t){this.trigger("error",{detail:t.detail})},this)},v=function(){},y=function(t,e,o,r){var i,n,a,s,l="function"==typeof o;if(l)try{i=o(r.detail),a=!0}catch(h){s=!0,n=h}else i=r.detail,a=!0;i&&"function"==typeof i.then?i.then(function(t){e.resolve(t)},function(t){e.reject(t)}):l&&a?e.resolve(i):s?e.reject(n):e[t](i)};g.prototype={then:function(t,e){var o=new g;return this.isResolved&&n.async(function(){y("resolve",o,t,{detail:this.resolvedValue})},this),this.isRejected&&n.async(function(){y("reject",o,e,{detail:this.rejectedValue})},this),this.on("promise:resolved",function(e){y("resolve",o,t,e)}),this.on("promise:failed",function(t){y("reject",o,e,t)}),o},resolve:function(t){e(this,t),this.resolve=v,this.reject=v},reject:function(t){o(this,t),this.resolve=v,this.reject=v}},f.mixin(g.prototype),t.Promise=g,t.Event=u,t.EventTarget=f,t.all=r,t.configure=i}),define("goo/util/PromiseUtil",["goo/util/rsvp"],function(t){"use strict";var e={};return e.createDummyPromise=function(e,o){var r;return r=new t.Promise,o?r.reject(o):r.resolve(e),r},e.optimisticAll=function(e){var o=0,r=e.length,i=[],n=new t.Promise;if(r>0)for(var a=0;r>a;a++)!function(t){e[t].then(function(e){i[t]=e,o++,o===r&&n.resolve(i)},function(e){i[t]=e,o++,o===r&&n.resolve(i)})}(a);else n.resolve(i);return n},e.defer=function(e,o){var r,i,n;return n=new t.Promise,o.apply?(r=new t.Promise,i=r.then(function(){return o()}),setTimeout(function(){r.resolve()},e),i):(setTimeout(function(){n.resolve(o)},e),n)},e}),define("goo/loaders/handlers/ConfigHandler",["goo/util/rsvp","goo/util/PromiseUtil"],function(t,e){"use strict";function o(t,e,o,r){this.world=t,this.getConfig=e,this.updateObject=o,this.loadObject=r,this._objects={},this._loading={}}return o.prototype._create=function(){return{}},o.prototype._remove=function(t){delete this._objects[t]},o.prototype._prepare=function(t){t=t},o.prototype._load=function(t,e){return this.loadObject(t,e)},o.prototype.load=function(t,o){var r=t.split(".").pop();if(r!==this.constructor._type)throw new Error("Trying to load type"+r+" with handler for "+this._type);var i=this;return this._loading[t]?this._loading[t]:this._objects[t]&&!o.reload?e.createDummyPromise(this._objects[t]):this._loading[t]=this.getConfig(t,o).then(function(e){return i.update(t,e,o)}).then(function(e){return delete i._loading[t],e}).then(null,function(e){throw delete i._loading[t],e})},o.prototype.clear=function(){var e=[];for(var o in this._objects)e.push(this.update(o,null,{}));return this._objects={},this._loading={},t.all(e)},o.prototype.update=function(t,e,o){return this._loading[t]=this._update(t,e,o)},o.prototype._update=function(t,o,r){return o?(this._objects[t]||(this._objects[t]=this._create()),this._prepare(o),e.createDummyPromise(this._objects[t])):(this._remove(t,r),e.createDummyPromise())},o.handlerClasses={},o.getHandler=function(t){return o.handlerClasses[t]},o._registerClass=function(t,e){return e._type=t,o.handlerClasses[t]=e},o}),define("goo/loaders/dds/DdsUtils",[],function(){"use strict";function t(){}return t.getDdsExtension=function(t){for(var e=["","WEBKIT_","MOZ_"],o=0;o<e.length;o++){var r=t.getExtension(e[o]+"WEBGL_compressed_texture_s3tc");if("undefined"!=typeof r&&null!==r)return r}return null},t.isSupported=function(e){return null!==t.getDdsExtension(e)},t.shiftCount=function(t){if(0===t)return 0;for(var e=0;0===(1&t);)if(t>>=1,e++,e>32)throw"invalid mask!";return e},t.isSet=function(t,e){return(t&e)===e},t.getIntFromString=function(e){for(var o=[],r=0;r<e.length;r++)o[r]=e.charCodeAt(r);return t.getIntFromBytes(o)},t.getIntFromBytes=function(t){var e=0;return e|=(255&t[0])<<0,t.length>1&&(e|=(255&t[1])<<8),t.length>2&&(e|=(255&t[2])<<16),t.length>3&&(e|=(255&t[3])<<24),e},t.getComponents=function(t){switch(t){case"Alpha":return 1;case"RGB":return 3;case"RGBA":return 4;case"Luminance":return 1;case"LuminanceAlpha":return 2;case"PrecompressedDXT1":return 1;case"PrecompressedDXT1A":return 1;case"PrecompressedDXT3":return 2;case"PrecompressedDXT5":return 2}return 0},t.flipDXT=function(e,o,r,i){for(var n=new Uint8Array(e.length),a=o+3>>2,s=r+3>>2,l=8*t.getComponents(i),h=0;s>h;h++)for(var d=s-h-1,c=0;a>c;c++){var u=(d*a+c)*l,p=(h*a+c)*l;switch(i){case"PrecompressedDXT1":case"PrecompressedDXT1A":n[u+0]=e[p+0],n[u+1]=e[p+1],n[u+2]=e[p+2],n[u+3]=e[p+3],n[u+4]=e[p+7],n[u+5]=e[p+6],n[u+6]=e[p+5],n[u+7]=e[p+4];break;case"PrecompressedDXT3":n[u+0]=e[p+6],n[u+1]=e[p+7],n[u+2]=e[p+4],n[u+3]=e[p+5],n[u+4]=e[p+2],n[u+5]=e[p+3],n[u+6]=e[p+0],n[u+7]=e[p+1],n[u+8]=e[p+8],n[u+9]=e[p+9],n[u+10]=e[p+10],n[u+11]=e[p+11],n[u+12]=e[p+15],n[u+13]=e[p+14],n[u+14]=e[p+13],n[u+15]=e[p+12];break;case"PrecompressedDXT5":n[u+0]=e[p+0],n[u+1]=e[p+1],t.getBytesFromUInt24(n,u+5,t.flipUInt24(t.getUInt24(e,p+2))),t.getBytesFromUInt24(n,u+2,t.flipUInt24(t.getUInt24(e,p+5))),n[u+8]=e[p+8],n[u+9]=e[p+9],n[u+10]=e[p+10],n[u+11]=e[p+11],n[u+12]=e[p+15],n[u+13]=e[p+14],n[u+14]=e[p+13],n[u+15]=e[p+12]}}return n},t.getUInt24=function(t,e){var o=0;return o|=(255&t[e+0])<<0,o|=(255&t[e+1])<<8,o|=(255&t[e+2])<<16},t.getBytesFromUInt24=function(t,e,o){t[e+0]=255&o,t[e+1]=(65280&o)>>8,t[e+2]=(16711680&o)>>16},t.ThreeBitMask=7,t.flipUInt24=function(e){for(var o=[],r=0;2>r;r++)o.push([0,0,0,0]);o[0][0]=e&t.ThreeBitMask,e>>=3,o[0][1]=e&t.ThreeBitMask,e>>=3,o[0][2]=e&t.ThreeBitMask,e>>=3,o[0][3]=e&t.ThreeBitMask,e>>=3,o[1][0]=e&t.ThreeBitMask,e>>=3,o[1][1]=e&t.ThreeBitMask,e>>=3,o[1][2]=e&t.ThreeBitMask,e>>=3,o[1][3]=e&t.ThreeBitMask;var i=0;return i|=o[1][0]<<0,i|=o[1][1]<<3,i|=o[1][2]<<6,i|=o[1][3]<<9,i|=o[0][0]<<12,i|=o[0][1]<<15,i|=o[0][2]<<18,i|=o[0][3]<<21},t}),define("goo/loaders/dds/DdsLoader",["goo/loaders/dds/DdsUtils"],function(t){"use strict";function e(){this.dwSize=0,this.dwFlags=0,this.dwFourCC=0,this.dwRGBBitCount=0,this.dwRBitMask=0,this.dwGBitMask=0,this.dwBBitMask=0,this.dwABitMask=0}function o(){this.dwSize=0,this.dwFlags=0,this.dwHeight=0,this.dwWidth=0,this.dwLinearSize=0,this.dwDepth=0,this.dwMipMapCount=0,this.dwAlphaBitDepth=0,this.dwReserved1=[],this.ddpf=null,this.dwCaps=0,this.dwCaps2=0,this.dwCaps3=0,this.dwCaps4=0,this.dwTextureStage=0}function r(){this.flipVertically=!1,this.bpp=0,this.header=null,this.headerDX10=null,this.mipmapByteSizes=[]}function i(){}return e.HEADER_OFFSET=19,e.DDPF_ALPHAPIXELS=1,e.DDPF_ALPHA=2,e.DDPF_FOURCC=4,e.DDPF_RGB=64,e.DDPF_YUV=512,e.DDPF_LUMINANCE=131072,e.read=function(t){var o=new e;if(o.dwSize=t[e.HEADER_OFFSET+0],32!==o.dwSize)throw"invalid pixel format size: "+o.dwSize;return o.dwFlags=t[e.HEADER_OFFSET+1],o.dwFourCC=t[e.HEADER_OFFSET+2],o.dwRGBBitCount=t[e.HEADER_OFFSET+3],o.dwRBitMask=t[e.HEADER_OFFSET+4],o.dwGBitMask=t[e.HEADER_OFFSET+5],o.dwBBitMask=t[e.HEADER_OFFSET+6],o.dwABitMask=t[e.HEADER_OFFSET+7],o},o.DDSD_CAPS=1,o.DDSD_HEIGHT=2,o.DDSD_WIDTH=4,o.DDSD_PITCH=8,o.DDSD_PIXELFORMAT=4096,o.DDSD_MIPMAPCOUNT=131072,o.DDSD_LINEARSIZE=524288,o.DDSD_DEPTH=8388608,o.DDSCAPS_COMPLEX=8,o.DDSCAPS_MIPMAP=4194304,o.DDSCAPS_TEXTURE=4096,o.DDSCAPS2_CUBEMAP=512,o.DDSCAPS2_CUBEMAP_POSITIVEX=1024,o.DDSCAPS2_CUBEMAP_NEGATIVEX=2048,o.DDSCAPS2_CUBEMAP_POSITIVEY=4096,o.DDSCAPS2_CUBEMAP_NEGATIVEY=8192,o.DDSCAPS2_CUBEMAP_POSITIVEZ=16384,o.DDSCAPS2_CUBEMAP_NEGATIVEZ=32768,o.DDSCAPS2_VOLUME=2097152,o.read=function(r){var i=new o;if(i.dwSize=r[1],124!==i.dwSize)throw"invalid dds header size: "+i.dwSize;i.dwFlags=r[2],i.dwHeight=r[3],i.dwWidth=r[4],i.dwLinearSize=r[5],i.dwDepth=r[6],i.dwMipMapCount=r[7],i.dwAlphaBitDepth=r[8];for(var n=0;n<i.dwReserved1.length;n++)i.dwReserved1[n]=r[9+n];i.ddpf=e.read(r),i.dwCaps=r[27],i.dwCaps2=r[28],i.dwCaps3=r[29],i.dwCaps4=r[30],i.dwTextureStage=r[31];var a=1+Math.ceil(Math.log(Math.max(i.dwHeight,i.dwWidth))/Math.log(2));return t.isSet(i.dwCaps,o.DDSCAPS_MIPMAP)?t.isSet(i.dwFlags,o.DDSD_MIPMAPCOUNT)?i.dwMipMapCount!==a&&console.warn("Got "+i.dwMipMapCount+" mipmaps, expected "+a):i.dwMipMapCount=a:i.dwMipMapCount=1,i},r.prototype.calcMipmapSizes=function(t){for(var e=this.header.dwWidth,o=this.header.dwHeight,r=0,i=0;i<this.header.dwMipMapCount;i++)r=t?~~((e+3)/4)*~~((o+3)/4)*this.bpp*2:~~(e*o*this.bpp/8),this.mipmapByteSizes.push(4*~~((r+3)/4)),e=~~(e/2)>1?~~(e/2):1,o=~~(o/2)>1?~~(o/2):1},i.updateDepth=function(e,r){if(t.isSet(r.header.dwCaps2,o.DDSCAPS2_CUBEMAP)){var i=0;if(t.isSet(r.header.dwCaps2,o.DDSCAPS2_CUBEMAP_POSITIVEX)&&i++,t.isSet(r.header.dwCaps2,o.DDSCAPS2_CUBEMAP_NEGATIVEX)&&i++,t.isSet(r.header.dwCaps2,o.DDSCAPS2_CUBEMAP_POSITIVEY)&&i++,t.isSet(r.header.dwCaps2,o.DDSCAPS2_CUBEMAP_NEGATIVEY)&&i++,t.isSet(r.header.dwCaps2,o.DDSCAPS2_CUBEMAP_POSITIVEZ)&&i++,t.isSet(r.header.dwCaps2,o.DDSCAPS2_CUBEMAP_NEGATIVEZ)&&i++,6!==i)throw new Error("Cubemaps without all faces defined are not currently supported.");e.depth=i}else e.depth=r.header.dwDepth>0?r.header.dwDepth:1},i.readDXT=function(e,o,r,i){if(i.image.isCompressed=!0,!r.flipVertically)return new Uint8Array(e.buffer,e.byteOffset+0,o);for(var n=r.header.dwWidth,a=r.header.dwHeight,s=new Uint8Array(o),l=0,h=0;h<r.header.dwMipMapCount;h++){var d=e.subarray(l,l+r.mipmapByteSizes[h]),c=t.flipDXT(d,n,a,i.format);s.set(c,l),l+=c.length,n=~~(n/2)>1?~~(n/2):1,a=~~(a/2)>1?~~(a/2):1}return s},i.readUncompressed=function(e,o,r,i,n,a,s,l){var h=t.shiftCount(s.header.ddpf.dwRBitMask),d=t.shiftCount(s.header.ddpf.dwGBitMask),c=t.shiftCount(s.header.ddpf.dwBBitMask),u=t.shiftCount(s.header.ddpf.dwABitMask),p=~~(s.header.ddpf.dwRGBBitCount/8),m=1*t.getComponents(l.format),f=new Uint8Array(o),g=s.header.dwWidth,v=s.header.dwHeight,y=0,x=0,w=0,_=[];for(w=0;p>w;w++)_.push(0);for(var b=0;b<s.header.dwMipMapCount;b++){for(var S=0;v>S;S++)for(var M=0;g>M;M++){for(w=0;p>w;w++)_[w]=e[x++];w=t.getIntFromBytes(_);var C=(w&s.header.ddpf.dwRBitMask)>>h,P=(w&s.header.ddpf.dwGBitMask)>>d,T=(w&s.header.ddpf.dwBBitMask)>>c,E=(w&s.header.ddpf.dwABitMask)>>u;n?f[y++]=E:i?(f[y++]=C,a&&(f[y++]=E)):r&&(f[y++]=C,f[y++]=P,f[y++]=T,a&&(f[y++]=E))}y+=g*v*m,g=~~(g/2)>1?~~(g/2):1,v=~~(v/2)>1?~~(v/2):1}return f},i.populate=function(o,r,n){var a=r.header.ddpf.dwFlags,s=t.isSet(a,e.DDPF_FOURCC),l=t.isSet(a,e.DDPF_RGB),h=t.isSet(a,e.DDPF_ALPHAPIXELS),d=t.isSet(a,e.DDPF_LUMINANCE),c=t.isSet(a,e.DDPF_ALPHA);if(o.type="UnsignedByte",s){var u=r.header.ddpf.dwFourCC;if(u===t.getIntFromString("DXT1"))r.bpp=4,o.format="PrecompressedDXT1A";else if(u===t.getIntFromString("DXT3"))r.bpp=8,o.format="PrecompressedDXT3";else{if(u!==t.getIntFromString("DXT5"))throw u===t.getIntFromString("DX10")?new Error("dxt10 LATC formats not supported currently: "+r.headerDX10.dxgiFormat):u===t.getIntFromString("DXT2")?"DXT2 is not supported.":u===t.getIntFromString("DXT4")?"DXT4 is not supported.":"unsupported compressed dds format found ("+u+")";r.bpp=8,o.format="PrecompressedDXT5"}}else if(r.bpp=r.header.ddpf.dwRGBBitCount,l)o.format=h?"RGBA":"RGB";else{if(!d&&!h)throw new Error("unsupported uncompressed dds format found.");d&&h?o.format="LuminanceAlpha":d?o.format="Luminance":c&&(o.format="Alpha")}r.calcMipmapSizes(s),o.image.mipmapSizes=r.mipmapByteSizes;
for(var p=0,m=0;m<r.mipmapByteSizes.length;m++)p+=r.mipmapByteSizes[m];for(var f=[],m=0;m<o.image.depth;m++)s?f.push(i.readDXT(n,p,r,o)):(l||d||c)&&f.push(i.readUncompressed(n,p,l,d,c,h,r,o));o.image.data=1===o.image.depth?f[0]:f,o.image.useArrays=!0},i.prototype.load=function(e,n,a,s,l){var h=new Int32Array(e,s+0,32),d=h[0];if(d!==t.getIntFromString("DDS "))throw"Not a dds file.";var c=new r;c.flipVertically=a,c.header=o.read(h),c.headerDX10=c.header.ddpf.dwFourCC===t.getIntFromString("DX10")?o.read(Int32Array.create(e,s+128,5)):null;var u=n.image;("undefined"==typeof u||null===u)&&(u={},n.image=u),u.width=c.header.dwWidth,u.height=c.header.dwHeight,i.updateDepth(u,c);var p=128+(c.headerDX10?20:0);i.populate(n,c,new Uint8Array(e,s+p,l-p)),(!c.mipmapByteSizes||c.mipmapByteSizes.length<2)&&(n.minFilter="BilinearNoMipMaps"),u.bpp=c.bpp,u.dataReady=!0,u.isData=!0,n.needsUpdate=!0},i.SUPPORTS_DDS=!1,i.prototype.isSupported=function(){return i.SUPPORTS_DDS},i.prototype.toString=function(){return"DdsLoader"},i}),define("goo/loaders/crunch/CrunchLoader",["goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils"],function(t,e){"use strict";function o(){}return o.cCRNFmtDXT1=0,o.cCRNFmtDXT3=1,o.cCRNFmtDXT5=2,o.prototype.arrayBufferCopy=function(t,e,o,r){var i,n=o/4,a=r%4,s=new Uint32Array(t.buffer,0,(r-a)/4),l=new Uint32Array(e.buffer);for(i=0;i<s.length;i++)l[n+i]=s[i];for(i=r-a;r>i;i++)e[o+i]=t[i]},o.prototype.load=function(t,r,i){if("undefined"==typeof window.CrunchModule)return void console.warn("Crunch library not loaded! Include a script tag pointing to lib/crunch/crunch.js in your html-file.");var n,a,s,l,h,d,c,u,p=window.CrunchModule,m=new Uint8Array(t),f=t.byteLength,g=p._malloc(f);this.arrayBufferCopy(m,p.HEAPU8,g,f),n=p._crn_get_dxt_format(g,f);var v;switch(n){case o.cCRNFmtDXT1:r.format="PrecompressedDXT1A",v=4;break;case o.cCRNFmtDXT3:r.format="PrecompressedDXT3",v=8;break;case o.cCRNFmtDXT5:r.format="PrecompressedDXT5",v=8;break;default:return console.error("Unsupported image format"),0}l=p._crn_get_width(g,f),h=p._crn_get_height(g,f),d=p._crn_get_levels(g,f),s=p._crn_get_uncompressed_size(g,f,0),a=p._malloc(s);var y=r.image;("undefined"==typeof y||null===y)&&(y={},r.image=y),y.width=l,y.height=h,y.depth=1;var x=[];for(r.image.mipmapSizes=[],u=0;d>u;++u)u&&(s=p._crn_get_uncompressed_size(g,f,u)),p._crn_decompress(g,f,a,s,u),c=new Uint8Array(p.HEAPU8.buffer,a,s),i&&(c=e.flipDXT(c,l,h,r.format)),x.push(c),r.image.mipmapSizes.push(s),l*=.5,h*=.5;r.image.data=x,r.image.useArrays=!0,r.type="UnsignedByte",r.image.isCompressed=!0,1>=d&&(r.minFilter="BilinearNoMipMaps"),y.bpp=v,y.dataReady=!0,y.isData=!0,r.needsUpdate=!0,p._free(g),p._free(a)},o.prototype.dxtToRgb565=function(t,e,o,r){for(var i=new Uint16Array(4),n=new Uint16Array(o*r),a=0,s=0,l=0,h=0,d=0,c=0,u=0,p=0,m=0,f=o/4,g=r/4,v=0;g>v;v++)for(var y=0;f>y;y++)l=e+4*(v*f+y),i[0]=t[l],i[1]=t[l+1],h=31&i[0],d=2016&i[0],c=63488&i[0],u=31&i[1],p=2016&i[1],m=63488&i[1],i[2]=5*h+3*u>>3|5*d+3*p>>3&2016|5*c+3*m>>3&63488,i[3]=5*u+3*h>>3|5*p+3*d>>3&2016|5*m+3*c>>3&63488,a=t[l+2],s=4*v*o+4*y,n[s]=i[3&a],n[s+1]=i[a>>2&3],n[s+2]=i[a>>4&3],n[s+3]=i[a>>6&3],s+=o,n[s]=i[a>>8&3],n[s+1]=i[a>>10&3],n[s+2]=i[a>>12&3],n[s+3]=i[a>>14],a=t[l+3],s+=o,n[s]=i[3&a],n[s+1]=i[a>>2&3],n[s+2]=i[a>>4&3],n[s+3]=i[a>>6&3],s+=o,n[s]=i[a>>8&3],n[s+1]=i[a>>10&3],n[s+2]=i[a>>12&3],n[s+3]=i[a>>14];return n},o.prototype.isSupported=function(){return t.SUPPORTS_DDS},o.prototype.toString=function(){return"CrunchLoader"},o}),define("goo/loaders/tga/TgaLoader",[],function(){"use strict";function t(){this.header=null,this.offset=0,this.use_rle=!1,this.use_pal=!1,this.use_rgb=!1,this.use_grey=!1}return t.TYPE_NO_DATA=0,t.TYPE_INDEXED=1,t.TYPE_RGB=2,t.TYPE_GREY=3,t.TYPE_RLE_INDEXED=9,t.TYPE_RLE_RGB=10,t.TYPE_RLE_GREY=11,t.ORIGIN_MASK=48,t.ORIGIN_SHIFT=4,t.ORIGIN_BL=0,t.ORIGIN_BR=1,t.ORIGIN_UL=2,t.ORIGIN_UR=3,t.prototype.load=function(t,e){this.loadData(new Uint8Array(t));var o=this.getCanvas();e.setImage(o,o.width,o.height),o.dataReady=!0,e.needsUpdate=!0},t.prototype.loadData=function(e){if(e.length<19)throw new Error("Targa::load() - Not enough data to contain header.");if(this.offset=0,this.header={id_length:e[this.offset++],colormap_type:e[this.offset++],image_type:e[this.offset++],colormap_index:e[this.offset++]|e[this.offset++]<<8,colormap_length:e[this.offset++]|e[this.offset++]<<8,colormap_size:e[this.offset++],origin:[e[this.offset++]|e[this.offset++]<<8,e[this.offset++]|e[this.offset++]<<8],width:e[this.offset++]|e[this.offset++]<<8,height:e[this.offset++]|e[this.offset++]<<8,pixel_size:e[this.offset++],flags:e[this.offset++]},this.checkHeader(),this.header.id_length+this.offset>e.length)throw new Error("Targa::load() - No data ?");switch(this.offset+=this.header.id_length,this.header.image_type){case t.TYPE_RLE_INDEXED:this.use_rle=!0;break;case t.TYPE_INDEXED:this.use_pal=!0;break;case t.TYPE_RLE_RGB:this.use_rle=!0;break;case t.TYPE_RGB:this.use_rgb=!0;break;case t.TYPE_RLE_GREY:this.use_rle=!0;break;case t.TYPE_GREY:this.use_grey=!0}this.parse(e)},t.prototype.checkHeader=function(){switch(this.header.image_type){case t.TYPE_INDEXED:case t.TYPE_RLE_INDEXED:if(this.header.colormap_length>256||24!==this.header.colormap_size||1!==this.header.colormap_type)throw new Error("Targa::checkHeader() - Invalid type colormap data for indexed type");break;case t.TYPE_RGB:case t.TYPE_GREY:case t.TYPE_RLE_RGB:case t.TYPE_RLE_GREY:if(this.header.colormap_type)throw new Error("Targa::checkHeader() - Invalid type colormap data for colormap type");break;case t.TYPE_NO_DATA:throw new Error("Targa::checkHeader() - No data on this TGA file");default:throw new Error("Targa::checkHeader() - Invalid type '"+this.header.image_type+"'")}if(this.header.width<=0||this.header.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==this.header.pixel_size&&16!==this.header.pixel_size&&24!==this.header.pixel_size&&32!==this.header.pixel_size)throw new Error("Targa::checkHeader() - Invalid pixel size '"+this.header.pixel_size+"'")},t.prototype.parse=function(t){var e,o,r,i,n;if(e=this.header,o=15&e.flags,i=e.pixel_size>>3,n=e.width*e.height*i,this.use_pal&&(this.palettes=t.subarray(this.offset,this.offset+=e.colormap_length*i)),this.use_rle){r=new Uint8Array(n);for(var a,s,l,h=0,d=new Uint8Array(i);n>h;)if(a=t[this.offset++],s=(127&a)+1,128&a){for(l=0;i>l;++l)d[l]=t[this.offset++];for(l=0;s>l;++l)r.set(d,h+l*i);h+=i*s}else{for(s*=i,l=0;s>l;++l)r[h+l]=t[this.offset++];h+=s}}else r=t.subarray(this.offset,this.offset+=this.use_pal?e.width*e.height:n);this.image=r},t.prototype.getImageData=function(e){var o,r,i,n,a,s,l,h,d=this.header.width,c=this.header.height;switch(h=e||{width:d,height:c,data:new Uint8Array(d*c*4)},(this.header.flags&t.ORIGIN_MASK)>>t.ORIGIN_SHIFT){default:case t.ORIGIN_UL:o=0,i=1,s=d,r=0,n=1,a=c;break;case t.ORIGIN_BL:o=0,i=1,s=d,r=c-1,n=-1,a=-1;break;case t.ORIGIN_UR:o=d-1,i=-1,s=-1,r=0,n=1,a=c;break;case t.ORIGIN_BR:o=d-1,i=-1,s=-1,r=c-1,n=-1,a=-1}return l="getImageData"+(this.use_grey?"Grey":"")+this.header.pixel_size+"bits",this[l](h.data,r,n,a,o,i,s),h},t.prototype.getCanvas=function(){var t=document.createElement("canvas"),e=t.getContext("2d"),o=e.createImageData(this.header.width,this.header.height);return t.width=this.header.width,t.height=this.header.height,e.putImageData(this.getImageData(o),0,0),t},t.prototype.getDataURL=function(t){return this.getCanvas().toDataURL(t||"image/png")},t.prototype.getImageData8bits=function(t,e,o,r,i,n,a){var s,l,h,d=this.image,c=this.palettes,u=this.header.width,p=0;for(h=e;h!==r;h+=o)for(l=i;l!==a;l+=n,p++)s=d[p],t[4*(l+u*h)+3]=255,t[4*(l+u*h)+2]=c[3*s+0],t[4*(l+u*h)+1]=c[3*s+1],t[4*(l+u*h)+0]=c[3*s+2];return t},t.prototype.getImageData16bits=function(t,e,o,r,i,n,a){var s,l,h,d=this.image,c=this.header.width,u=0;for(h=e;h!==r;h+=o)for(l=i;l!==a;l+=n,u+=2)s=d[u+0]+(d[u+1]<<8),t[4*(l+c*h)+0]=(31744&s)>>7,t[4*(l+c*h)+1]=(992&s)>>2,t[4*(l+c*h)+2]=(31&s)>>3,t[4*(l+c*h)+3]=32768&s?0:255;return t},t.prototype.getImageData24bits=function(t,e,o,r,i,n,a){var s,l,h=this.image,d=this.header.width,c=0;for(l=e;l!==r;l+=o)for(s=i;s!==a;s+=n,c+=3)t[4*(s+d*l)+3]=255,t[4*(s+d*l)+2]=h[c+0],t[4*(s+d*l)+1]=h[c+1],t[4*(s+d*l)+0]=h[c+2];return t},t.prototype.getImageData32bits=function(t,e,o,r,i,n,a){var s,l,h=this.image,d=this.header.width,c=0;for(l=e;l!==r;l+=o)for(s=i;s!==a;s+=n,c+=4)t[4*(s+d*l)+2]=h[c+0],t[4*(s+d*l)+1]=h[c+1],t[4*(s+d*l)+0]=h[c+2],t[4*(s+d*l)+3]=h[c+3];return t},t.prototype.getImageDataGrey8bits=function(t,e,o,r,i,n,a){var s,l,h,d=this.image,c=this.header.width,u=0;for(h=e;h!==r;h+=o)for(l=i;l!==a;l+=n,u++)s=d[u],t[4*(l+c*h)+0]=s,t[4*(l+c*h)+1]=s,t[4*(l+c*h)+2]=s,t[4*(l+c*h)+3]=255;return t},t.prototype.getImageDataGrey16bits=function(t,e,o,r,i,n,a){var s,l,h=this.image,d=this.header.width,c=0;for(l=e;l!==r;l+=o)for(s=i;s!==a;s+=n,c+=2)t[4*(s+d*l)+0]=h[c+0],t[4*(s+d*l)+1]=h[c+0],t[4*(s+d*l)+2]=h[c+0],t[4*(s+d*l)+3]=h[c+1];return t},t.prototype.isSupported=function(){return!0},t.prototype.toString=function(){return"TgaLoader"},t}),define("goo/util/CanvasUtils",["goo/util/rsvp"],function(t){"use strict";function e(){}return e.loadCanvasFromPath=function(t,e){var o={};3===arguments.length&&(o=arguments[1],e=arguments[2]);var r=new Image;r.src=t;var i=document.createElement("canvas"),n=i.getContext("2d");r.onload=function(){if(o.width=o.width?o.width:r.width,o.height=o.height?o.height:r.height,o.sourceX=o.sourceX?o.sourceX:0,o.sourceY=o.sourceY?o.sourceY:0,o.sourceWidth=o.sourceWidth?o.sourceWidth:r.width,o.sourceHeight=o.sourceHeight?o.sourceHeight:r.height,o.destX=o.destX?o.destX:0,o.destY=o.destY?o.destY:0,o.destWidth=o.destWidth?o.destWidth:o.width,o.destHeight=o.destHeight?o.destHeight:o.height,o.resizeToFit){var t=o.sourceWidth/o.sourceHeight;t>1?(o.destHeight=o.destWidth/t,o.destY=.5*(o.height-o.destHeight)):1>t&&(o.destWidth=o.destHeight*t,o.destX=.5*(o.width-o.destWidth))}i.width=o.width,i.height=o.height,n.drawImage(r,o.sourceX,o.sourceY,o.sourceWidth,o.sourceHeight,o.destX,o.destY,o.destWidth,o.destHeight),e(i)}},e.renderSvgToCanvas=function(t,o,r){var i=window.URL||window.webkitURL||window,n=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),a=i.createObjectURL(n);e.loadCanvasFromPath(a,o,r)},e.getMatrixFromCanvas=function(t){for(var e=t.getContext("2d"),o=function(o,r){return 0>o||o>t.width||0>r||r>t.height?0:e.getImageData(o,r,1,1).data[0]/255},r=[],i=0;i<t.width;i++){r.push([]);for(var n=0;n<t.height;n++)r[i].push(o(i,t.height-(n+1)))}return r},e.svgDataToImage=function(e){var o=new Image,r=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),i=window.URL||window.webkitURL||window,n=i.createObjectURL(r);o.src=n;var a=new t.Promise;return o.onload=function(){a.resolve(o)},o.onerror=function(){a.reject()},a},e}),define("goo/loaders/handlers/TextureHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Texture","goo/loaders/dds/DdsLoader","goo/loaders/crunch/CrunchLoader","goo/loaders/tga/TgaLoader","goo/util/rsvp","goo/util/PromiseUtil","goo/renderer/Util","goo/util/ObjectUtil","goo/util/CanvasUtils"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(){t.apply(this,arguments)}return d.prototype=Object.create(t.prototype),d.prototype.constructor=d,t._registerClass("texture",d),d.minFilters=["NearestNeighborNoMipMaps","NearestNeighborNearestMipMap","NearestNeighborLinearMipMap","BilinearNoMipMaps","BilinearNearestMipMap","Trilinear"],d.magFilters=["NearestNeighbor","Bilinear"],d.loaders={dds:o,crn:r,tga:i},d.WHITE=new Uint8Array([255,255,255,255]),d.BLACK=new Uint8Array([0,0,0,255]),d.prototype._prepare=function(t){l.defaults(t,{wrapS:"Repeat",wrapT:"Repeat",magFilter:"Bilinear",minFilter:"Trilinear",anisotropy:1,offset:[0,0],repeat:[1,1],flipY:!0,lodBias:0})},d.prototype._remove=function(t){delete this._objects[t]},d.prototype._create=function(){return new e},d.prototype._update=function(e,o,r){var i=this;return t.prototype._update.call(this,e,o,r).then(function(t){if(t){var e;t.wrapS=o.wrapS,t.wrapT=o.wrapT,-1!==d.magFilters.indexOf(o.magFilter)&&(t.magFilter=o.magFilter),-1!==d.minFilters.indexOf(o.minFilter)&&(t.minFilter=o.minFilter),t.anisotropy=Math.max(o.anisotropy,1),t.offset.set(o.offset),t.repeat.set(o.repeat),t.lodBias=o.lodBias,t.flipY!==o.flipY&&(t.flipY=o.flipY,t.setNeedsUpdate()),t.updateCallback=null;var n=o.imageRef;if(n){var a=n.split(".").pop().toLowerCase(),c=d.loaders[a];if(c)t.a=n,e=i.loadObject(n).then(function(e){if(e&&e.preloaded)return l.extend(t.image,e.image),t.format=e.format,t.setNeedsUpdate(),t;var r=new c;return r.load(e,t,o.flipY,0,e.byteLength),t});else if(-1!==["jpg","jpeg","png","gif"].indexOf(a))e=i.loadObject(n,r).then(function(e){return t.image!==e&&t.setImage(e),t});else{if(-1===["mp4","ogv","webm"].indexOf(a))throw new Error("Unknown texture type");e=i.loadObject(n,r).then(function(e){return e.width=e.videoWidth,e.height=e.videoHeight,(s.isPowerOfTwo(e.width)===!1||s.isPowerOfTwo(e.height)===!1)&&(t.generateMipmaps=!1,t.minFilter="BilinearNoMipMaps"),t.setImage(e),t.updateCallback=function(){return!e.paused},(void 0===o.autoPlay||o.autoPlay)&&e.play(),t})}}else e=o.svgData?h.svgDataToImage(o.svgData).then(function(e){if(!e)throw new Error("Could not convert SVG to image!");return t.setImage(e),t}):t;return r&&r.texture&&r.texture.dontwait?t:e}})},d}),define("goo/sound/AudioContext",[],function(){"use strict";try{var t=window.AudioContext||window.webkitAudioContext;return new t}catch(e){console.warn("Web audio not supported")}}),define("goo/util/Ajax",["goo/loaders/handlers/TextureHandler","goo/sound/AudioContext","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/util/rsvp"],function(t,e,o,r,i){"use strict";function n(t,e){t&&(this._rootPath=t,"/"!==t.slice(-1)&&(this._rootPath+="/")),this.options=e||{},this._cache={}}return n.prototype.prefill=function(t,e){e?this._cache=t:r.extend(this._cache,t)},n.prototype.get=function(t){t=t||{};var e=t.url||"",o="GET",r=new XMLHttpRequest;r.open(o,e,!0),t.responseType&&(r.responseType=t.responseType);var n=new i.Promise;return r.onreadystatechange=function(){4===r.readyState&&(r.status>=200&&r.status<=299?n.resolve(r):n.reject(r.statusText))},r.send(),n},n.ARRAY_BUFFER="arraybuffer",n.prototype.load=function(t,e){function a(t,e){return t&&n.types[e]&&r.indexOf(n.types[e],t)>=0}var s=this,l=t.slice(t.lastIndexOf(".")+1).toLowerCase();if(t||o.createDummyPromise(null,"Path was undefined"),0===t.indexOf(n.ENGINE_SHADER_PREFIX))return o.createDummyPromise();if(this._cache[t]&&!e)return a(l,"bundle")&&this.prefill(this._cache[t],e),this._cache[t]instanceof i.Promise?this._cache[t]:o.createDummyPromise(this._cache[t]);var h=this._rootPath?this._rootPath+t:t;if(a(l,"image"))return this._cache[t]=this._loadImage(h);if(a(l,"video"))return this._cache[t]=this._loadVideo(h);if(a(l,"audio"))return this._cache[t]=this._loadAudio(h);var d={url:h};return a(l,"binary")&&(d.responseType=n.ARRAY_BUFFER),this._cache[t]=this.get(d).then(function(t){if(a(l,"bundle")){var o=JSON.parse(t.response);return s.prefill(o,e),o}return a(l,"json")?JSON.parse(t.response):t.response}).then(null,function(e){throw new Error("Could not load data from "+t+", "+e)})},n.prototype.update=function(t,e){return this._cache[t]=e,o.createDummyPromise(e)},n.prototype._loadImage=function(t){window.URL=window.URL||window.webkitURL;var e=new Image;this.crossOrigin&&(e.crossOrigin="anonymous");var o=new i.Promise;return e.addEventListener("load",function(){e.dataReady=!0,window.URL&&void 0!==window.URL.revokeObjectURL&&window.URL.revokeObjectURL(e.src),o.resolve(e)},!1),e.addEventListener("error",function(e){o.reject("Could not load image from "+t+", "+e)},!1),e.src=t,o},n.prototype._loadVideo=function(t){var e=document.createElement("video");this.crossOrigin&&(e.crossOrigin="anonymous");var o=new i.Promise;return e.addEventListener("canplay",function(){e.dataReady=!0,o.resolve(e)},!1),e.addEventListener("onerror",function(e){o.reject("Coult not load video from "+t+", "+e)},!1),e.src=t,o},n.prototype._loadAudio=function(t){var e={url:t,responseType:n.ARRAY_BUFFER};return this.get(e).then(function(t){return t.response}).then(null,function(e){throw new Error("Could not load data from "+t+", "+e)})},n.ENGINE_SHADER_PREFIX="GOO_ENGINE_SHADERS/",n.types={text:["vert","frag"],json:["shader","script","entity","material","scene","mesh","texture","skeleton","animation","clip","bundle","project","machine","posteffects","animstate","sound","environment","skybox"],image:["jpg","jpeg","png","gif"],video:["mp4","ogv","webm"],binary:["dat","bin"].concat(r.keys(t.loaders)),audio:["mp3","wav","ogg"],bundle:["bundle"]},n.types.asset=n.types.image.concat(n.types.binary),n}),define("goo/util/Latch",[],function(){"use strict";function t(t,e){this.count=t,this.callback=e}return t.prototype.countDown=function(){this.count--,this.isDone()&&this.callback&&this.callback.done?this.callback.done():this.callback&&this.callback.progress&&this.callback.progress(this.count)},t.prototype.isDone=function(){return 0===this.count},t}),define("goo/renderer/TextureCreator",["goo/renderer/Texture","goo/renderer/Util","goo/loaders/handlers/TextureHandler","goo/util/Ajax","goo/util/StringUtil","goo/util/Latch"],function(t,e,o,r,i,n){"use strict";function a(){var t=this.ajax=new r;this.textureHandler=new o({},function(e,o){return t.load(e,o?o.noCache:!1)},function(){},function(e,o){return t.load(e,o?o.noCache:!1)})}a.UNSUPPORTED_FALLBACK=".png",a.clearCache=function(){},a.prototype.loadTexture2D=function(t,e,o){var r=i.createUniqueId("texture");e=e||{},e.imageRef=t;var n=this.textureHandler._objects[r]=this.textureHandler._create();return this.textureHandler.update(r,e).then(function(){o&&o(n)}),n},a.prototype.loadTextureVideo=function(t,e,o,r){var n=i.createUniqueId("texture");o=o||{},o.imageRef=t,o.loop=e,o.wrapS="EdgeClamp",o.wrapT="EdgeClamp",o.autoPlay=!0;var a=this.textureHandler._objects[n]=this.textureHandler._create();return this.textureHandler.update(n,o,{texture:{dontwait:!0}}).then(null,function(t){r(t)}),a},a.prototype.loadTextureWebCam=function(){var o=document.createElement("video");o.autoplay=!0,o.loop=!0;var r=new t(o,{wrapS:"EdgeClamp",wrapT:"EdgeClamp"});return r.readyCallback=function(){return o.readyState>=3?(console.log("WebCam video ready: "+o.videoWidth+", "+o.videoHeight),o.width=o.videoWidth,o.height=o.videoHeight,(e.isPowerOfTwo(o.width)===!1||e.isPowerOfTwo(o.height)===!1)&&(r.generateMipmaps=!1,r.minFilter="BilinearNoMipMaps"),o.dataReady=!0,!0):!1},r.updateCallback=function(){return!o.paused},window.URL=window.URL||window.webkitURL,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getUserMedia?navigator.getUserMedia({video:!0},function(t){o.src=window.URL.createObjectURL(t)},function(t){console.warn("Unable to capture WebCam. Please reload the page.",t)}):console.warn("No support for WebCam getUserMedia found!"),r},a.prototype.loadTextureCube=function(e,o){var r=new t(null,o);r.variant="CUBE";for(var i=[],a=new n(6,{done:function(){for(var t=i[0].width,e=i[0].height,o=0;6>o;o++){var n=i[o];(t!==n.width||e!==n.height)&&(r.generateMipmaps=!1,r.minFilter="BilinearNoMipMaps",console.error("Images not all the same size!"))}r.setImage(i),r.image.dataReady=!0,r.image.width=t,r.image.height=e}}),s=this,l=0;l<e.length;l++)!function(t){var o=e[t];"string"==typeof o?s.ajax._loadImage(o).then(function(e){i[t]=e,a.countDown()}):(i[t]=o,a.countDown())}(l);return r},a._globalCallback=null,a._finishedLoading=function(t){if(a._globalCallback)try{a._globalCallback(t)}catch(e){console.error("Error in texture callback:",e)}};var s=new Uint8Array([255,255,255,255]);return a.DEFAULT_TEXTURE_2D=new t(s,null,1,1),a.DEFAULT_TEXTURE_CUBE=new t([s,s,s,s,s,s],null,1,1),a.DEFAULT_TEXTURE_CUBE.variant="CUBE",a}),define("goo/renderer/pass/RenderTarget",["goo/math/Vector2"],function(t){"use strict";function e(e,o,r){this.glTexture=null,this._glRenderBuffer=null,this._glFrameBuffer=null,this.width=Math.floor(e),this.height=Math.floor(o),r=r||{},this.wrapS=void 0!==r.wrapS?r.wrapS:"EdgeClamp",this.wrapT=void 0!==r.wrapT?r.wrapT:"EdgeClamp",this.magFilter=void 0!==r.magFilter?r.magFilter:"Bilinear",this.minFilter=void 0!==r.minFilter?r.minFilter:"BilinearNoMipMaps",this.anisotropy=void 0!==r.anisotropy?r.anisotropy:1,this.format=void 0!==r.format?r.format:"RGBA",this.type=void 0!==r.type?r.type:"UnsignedByte",this.variant="2D",this.offset=new t(0,0),this.repeat=new t(1,1),this.generateMipmaps=void 0!==r.generateMipmaps?r.generateMipmaps:!1,this.premultiplyAlpha=void 0!==r.premultiplyAlpha?r.premultiplyAlpha:!1,this.unpackAlignment=void 0!==r.unpackAlignment?r.unpackAlignment:1,this.flipY=void 0!==r.flipY?r.flipY:!0,this.depthBuffer=void 0!==r.depthBuffer?r.depthBuffer:!0,this.stencilBuffer=void 0!==r.stencilBuffer?r.stencilBuffer:!0}return e.prototype.clone=function(){var t=new e(this.width,this.height);return t.wrapS=this.wrapS,t.wrapT=this.wrapT,t.magFilter=this.magFilter,t.minFilter=this.minFilter,t.anisotropy=this.anisotropy,t.format=this.format,t.type=this.type,t.variant=this.variant,t.offset.copy(this.offset),t.repeat.copy(this.repeat),t.generateMipmaps=this.generateMipmaps,t.premultiplyAlpha=this.premultiplyAlpha,t.unpackAlignment=this.unpackAlignment,t.flipY=this.flipY,t.depthBuffer=this.depthBuffer,t.stencilBuffer=this.stencilBuffer,t},e}),define("goo/renderer/shaders/ShaderFragment",[],function(){"use strict";function t(){}return t.noisecommon=["vec4 mod289(vec4 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 mod289(vec3 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec2 mod289(vec2 x) {","  return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec3 permute(vec3 x) {","  return mod289(((x*34.0)+1.0)*x);","}","vec4 permute(vec4 x) {","  return mod289(((x*34.0)+1.0)*x);","}"].join("\n"),t.noise2d=[t.noisecommon,"float snoise(vec2 v)","  {","  const vec4 C = vec4(0.211324865405187,  // (3.0-sqrt(3.0))/6.0","                      0.366025403784439,  // 0.5*(sqrt(3.0)-1.0)","                     -0.577350269189626,  // -1.0 + 2.0 * C.x","                      0.024390243902439); // 1.0 / 41.0","  vec2 i  = floor(v + dot(v, C.yy) );","  vec2 x0 = v -   i + dot(i, C.xx);","  vec2 i1;","  //i1.x = step( x0.y, x0.x ); // x0.x > x0.y ? 1.0 : 0.0","  //i1.y = 1.0 - i1.x;","  i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);","  // x0 = x0 - 0.0 + 0.0 * C.xx ;","  // x1 = x0 - i1 + 1.0 * C.xx ;","  // x2 = x0 - 1.0 + 2.0 * C.xx ;","  vec4 x12 = x0.xyxy + C.xxzz;","  x12.xy -= i1;","  i = mod289(i); // Avoid truncation effects in permutation","  vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 ))","		+ i.x + vec3(0.0, i1.x, 1.0 ));","  vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);","  m = m*m ;","  m = m*m ;","  vec3 x = 2.0 * fract(p * C.www) - 1.0;","  vec3 h = abs(x) - 0.5;","  vec3 ox = floor(x + 0.5);","  vec3 a0 = x - ox;","  m *= 1.79284291400159 - 0.85373472095314 * ( a0*a0 + h*h );","  vec3 g;","  g.x  = a0.x  * x0.x  + h.x  * x0.y;","  g.yz = a0.yz * x12.xz + h.yz * x12.yw;","  return 130.0 * dot(m, g);","}"].join("\n"),t.noise3d=[t.noisecommon,"vec4 taylorInvSqrt(vec4 r) {","	return 1.79284291400159 - 0.85373472095314 * r;","}","float snoise(vec3 v) {","	const vec2  C = vec2(1.0/6.0, 1.0/3.0) ;","	const vec4  D = vec4(0.0, 0.5, 1.0, 2.0);","	vec3 i  = floor(v + dot(v, C.yyy) );","	vec3 x0 =   v - i + dot(i, C.xxx) ;","	vec3 g = step(x0.yzx, x0.xyz);","	vec3 l = 1.0 - g;","	vec3 i1 = min( g.xyz, l.zxy );","	vec3 i2 = max( g.xyz, l.zxy );","	vec3 x1 = x0 - i1 + C.xxx;","	vec3 x2 = x0 - i2 + C.yyy; // 2.0*C.x = 1/3 = C.y","	vec3 x3 = x0 - D.yyy;      // -1.0+3.0*C.x = -0.5 = -D.y","	i = mod289(i); ","	vec4 p = permute( permute( permute( ","         i.z + vec4(0.0, i1.z, i2.z, 1.0 ))","       + i.y + vec4(0.0, i1.y, i2.y, 1.0 )) ","       + i.x + vec4(0.0, i1.x, i2.x, 1.0 ));","	float n_ = 0.142857142857; // 1.0/7.0","	vec3  ns = n_ * D.wyz - D.xzx;","	vec4 j = p - 49.0 * floor(p * ns.z * ns.z);  //  mod(p,7*7)","	vec4 x_ = floor(j * ns.z);","	vec4 y_ = floor(j - 7.0 * x_ );    // mod(j,N)","	vec4 x = x_ *ns.x + ns.yyyy;","	vec4 y = y_ *ns.x + ns.yyyy;","	vec4 h = 1.0 - abs(x) - abs(y);","	vec4 b0 = vec4( x.xy, y.xy );","	vec4 b1 = vec4( x.zw, y.zw );","	vec4 s0 = floor(b0)*2.0 + 1.0;","	vec4 s1 = floor(b1)*2.0 + 1.0;","	vec4 sh = -step(h, vec4(0.0));","	vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ;","	vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ;","	vec3 p0 = vec3(a0.xy,h.x);","	vec3 p1 = vec3(a0.zw,h.y);","	vec3 p2 = vec3(a1.xy,h.z);","	vec3 p3 = vec3(a1.zw,h.w);","	vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2, p2), dot(p3,p3)));","	p0 *= norm.x;","	p1 *= norm.y;","	p2 *= norm.z;","	p3 *= norm.w;","	vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);","	m = m * m;","	return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );","}"].join("\n"),t.methods={packDepth:["vec4 packDepth( const in float depth ) {","	const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","	const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","	vec4 res = fract( depth * bit_shift );","	res -= res.xxyz * bit_mask;","	return res;","}"].join("\n"),unpackDepth:["float unpackDepth( const in vec4 rgba_depth ) {","	const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","	float depth = dot( rgba_depth, bit_shift );","	return depth;","}"].join("\n"),packDepth16:["vec2 packDepth16( const in float depth ) {","	const vec2 bias = vec2(1.0 / 255.0, 0.0);","	vec2 res = vec2(depth, fract(depth * 255.0));","	return res - (res.yy * bias);","}"].join("\n"),unpackDepth16:["float unpackDepth16( const in vec2 rg_depth ) {","	return rg_depth.x + (rg_depth.y / 255.0);","}"].join("\n"),hsv:["vec3 rgb2hsv(vec3 c) {","vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);","vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));","vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));","float d = q.x - min(q.w, q.y);","float e = 1.0e-10;","return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);","}","vec3 hsv2rgb(vec3 c){","vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);","vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);","return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);","}"].join("\n")},t}),define("goo/renderer/light/PointLight",["goo/renderer/light/Light"],function(t){"use strict";function e(e){t.call(this,e),this.range=1e3}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.update=function(t){t.matrix.getTranslation(this.translation)},e}),define("goo/renderer/light/DirectionalLight",["goo/math/Vector3","goo/renderer/light/Light"],function(t,e){"use strict";function o(o){e.call(this,o),this.direction=new t}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.update=function(t){t.matrix.getTranslation(this.translation),this.direction.setd(0,0,-1),t.matrix.applyPostVector(this.direction)},o}),define("goo/renderer/light/SpotLight",["goo/math/Vector3","goo/renderer/light/Light"],function(t,e){"use strict";function o(o){e.call(this,o),this.direction=new t,this.range=1e3,this.angle=45,this.penumbra=null,this.exponent=16}return o.prototype=Object.create(e.prototype),o.prototype.constructor=o,o.prototype.update=function(t){t.matrix.getTranslation(this.translation),this.direction.setd(0,0,-1),t.matrix.applyPostVector(this.direction)},o}),define("goo/util/TangentGenerator",["goo/math/Vector2","goo/math/Vector3","goo/renderer/MeshData"],function(t,e,o){"use strict";function r(){}return r.addTangentBuffer=function(r,i){function n(e){for(var o=[],r=0;r<e.length;r+=2)o.push(new t(e[r+0],e[r+1]));return o}function a(t){for(var o=[],r=0;r<t.length;r+=3)o.push(new e(t[r+0],t[r+1],t[r+2]));return o}i=i||0;var s=r.getAttributeBuffer(o.POSITION);if(s){var l=r.getAttributeBuffer(o.NORMAL);if(l){var h=r.getAttributeBuffer("TEXCOORD"+i);if(h||0===i||(h=r.getAttributeBuffer(o.TEXCOORD0)),h){var d=r.getIndexBuffer();if(d){for(var c=r.vertexCount,u=r.indexCount/3,p=[],m=[],f=0;c>f;f++)p[f]=new e,m[f]=new e;for(var g=a(s),v=a(l),y=n(h),x=0;u>x;x++){var w=d[3*x],_=d[3*x+1],b=d[3*x+2],S=g[w],M=g[_],C=g[b],P=y[w],T=y[_],E=y[b],D=M.x-S.x,A=C.x-S.x,R=M.y-S.y,I=C.y-S.y,O=M.z-S.z,L=C.z-S.z,N=T.x-P.x,F=E.x-P.x,B=T.y-P.y,k=E.y-P.y,z=1/(N*k-F*B);if(isFinite(z)!==!1){var U=new e((k*D-B*A)*z,(k*R-B*I)*z,(k*O-B*L)*z),V=new e((N*A-F*D)*z,(N*I-F*R)*z,(N*L-F*O)*z);p[w].add(U),p[_].add(U),p[b].add(U),m[w].add(V),m[_].add(V),m[b].add(V)}}r.attributeMap[o.TANGENT]=o.createAttribute(4,"Float"),r.rebuildData(r.vertexCount,r.indexCount,!0);for(var j=r.getAttributeBuffer(o.TANGENT),X=new e,H=new e,x=0;c>x;x++){var W=v[x],G=p[x],Y=W.dot(G);X.copy(G).sub(H.copy(W).mul(Y)).normalize(),j[4*x+0]=X.x,j[4*x+1]=X.y,j[4*x+2]=X.z,Y=X.copy(W).cross(G).dot(m[x]);var q=0>Y?-1:1;j[4*x+3]=q}return j}}}}},r}),define("goo/renderer/shaders/ShaderBuilder",["goo/renderer/MeshData","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight","goo/renderer/Texture","goo/math/MathUtils","goo/util/TangentGenerator"],function(t,e,o,r,i,n,a){"use strict";function s(){}var l=new o;return l.translation.setd(10,10,10),l.direction.setd(1,1,1).normalize(),s.defaultLight=l,s.SKYBOX=null,s.SKYSPHERE=null,s.ENVIRONMENT_TYPE=0,s.GLOBAL_AMBIENT=[0,0,0],s.CLEAR_COLOR=[1,0,0,0],s.USE_FOG=!1,s.FOG_SETTINGS=[0,1e4],s.FOG_COLOR=[1,1,1],s.uber={processor:function(e,o){var r=o.meshData.attributeMap,i=o.material,n=i._textureMaps;e.defines=e.defines||{},e.uniforms.clearColor=s.CLEAR_COLOR,s.SKYBOX&&(i.uniforms.reflectivity>0||i.uniforms.refractivity>0)?i.setTexture("ENVIRONMENT_CUBE",s.SKYBOX):i.getTexture("ENVIRONMENT_CUBE")&&i.removeTexture("ENVIRONMENT_CUBE"),s.SKYSPHERE&&(i.uniforms.reflectivity>0||i.uniforms.refractivity>0)?(i.setTexture("ENVIRONMENT_SPHERE",s.SKYSPHERE),e.defines.ENVIRONMENT_TYPE=s.ENVIRONMENT_TYPE):i.getTexture("ENVIRONMENT_SPHERE")&&i.removeTexture("ENVIRONMENT_SPHERE");for(var l=Object.keys(r),h=0,d=l.length;d>h;h++){var c=l[h];e.defines[c]||(e.defines[c]=!0)}for(var l=Object.keys(n),h=0,d=l.length;d>h;h++){var u=l[h];if(void 0!==n[u]&&null!==n[u]&&"SHADOW_MAP"!==u&&(e.defines[u]||(e.defines[u]=!0),"DIFFUSE_MAP"===u)){var p=n[u].offset,m=n[u].repeat;e.uniforms.offsetRepeat=e.uniforms.offsetRepeat||[0,0,1,1],e.uniforms.offsetRepeat[0]=p.x,e.uniforms.offsetRepeat[1]=p.y,e.uniforms.offsetRepeat[2]=m.x,e.uniforms.offsetRepeat[3]=m.y,e.uniforms.lodBias=n[u].lodBias}}for(var l=Object.keys(e.defines),h=0,d=l.length;d>h;h++){var c=l[h];"MAX_POINT_LIGHTS"!==c&&"MAX_DIRECTIONAL_LIGHTS"!==c&&"MAX_SPOT_LIGHTS"!==c&&"SHADOW_TYPE"!==c&&"JOINT_COUNT"!==c&&"WEIGHTS"!==c&&"PHYSICALLY_BASED_SHADING"!==c&&"ENVIRONMENT_TYPE"!==c&&"WRAP_AROUND"!==c&&(r[c]||n[c]||delete e.defines[c])}o.material.uniforms.discardThreshold>=0?e.defines.DISCARD=!0:delete e.defines.DISCARD,s.USE_FOG?(e.defines.FOG=!0,e.uniforms.fogSettings=s.FOG_SETTINGS,e.uniforms.fogColor=s.FOG_COLOR):delete e.defines.FOG,e.defines.SKIP_SPECULAR=!0,e.defines.NORMAL&&e.defines.NORMAL_MAP&&!o.meshData.getAttributeBuffer(t.TANGENT)&&a.addTangentBuffer(o.meshData)}},s.light={processor:function(t,a){t.uniforms.materialAmbient=t.uniforms.materialAmbient||"AMBIENT",t.uniforms.materialEmissive=t.uniforms.materialEmissive||"EMISSIVE",t.uniforms.materialDiffuse=t.uniforms.materialDiffuse||"DIFFUSE",t.uniforms.materialSpecular=t.uniforms.materialSpecular||"SPECULAR",t.uniforms.materialSpecularPower=t.uniforms.materialSpecularPower||"SPECULAR_POWER",t.uniforms.globalAmbient=s.GLOBAL_AMBIENT,t.defines=t.defines||{};for(var l=a.lights,h=[],d=0;d<l.length;d++){var c=l[d];c instanceof e?(t.uniforms["pointLight"+d]=[c.translation.data[0],c.translation.data[1],c.translation.data[2],c.range],t.uniforms["pointLightColor"+d]=[c.color.data[0]*c.intensity,c.color.data[1]*c.intensity,c.color.data[2]*c.intensity,c.specularIntensity],h.push("P")):c instanceof o?(t.uniforms["directionalLightDirection"+d]=[c.direction.data[0],c.direction.data[1],c.direction.data[2]],t.uniforms["directionalLightColor"+d]=[c.color.data[0]*c.intensity,c.color.data[1]*c.intensity,c.color.data[2]*c.intensity,c.specularIntensity],h.push("D")):c instanceof r&&(t.uniforms["spotLight"+d]=[c.translation.data[0],c.translation.data[1],c.translation.data[2],c.range],t.uniforms["spotLightColor"+d]=[c.color.data[0]*c.intensity,c.color.data[1]*c.intensity,c.color.data[2]*c.intensity,c.specularIntensity],t.uniforms["spotLightDirection"+d]=[c.direction.data[0],c.direction.data[1],c.direction.data[2]],t.uniforms["spotLightAngle"+d]=Math.cos(c.angle*n.DEG_TO_RAD/2),t.uniforms["spotLightPenumbra"+d]=void 0!==c.penumbra?Math.sin(c.penumbra*n.DEG_TO_RAD/4):0,h.push("S"));
var u=c.lightCookie instanceof i;if((u||c.shadowCaster&&a.renderable.meshRendererComponent&&a.renderable.meshRendererComponent.receiveShadows)&&c.shadowSettings.shadowData){var p=c.shadowSettings.shadowData;c.shadowCaster&&(t.uniforms["shadowMaps"+d]="SHADOW_MAP"+d,a.material.setTexture("SHADOW_MAP"+d,p.shadowResult)),u?(t.uniforms["lightCookie"+d]="LIGHT_COOKIE"+d,a.material.setTexture("LIGHT_COOKIE"+d,c.lightCookie),h.push("C"),t.defines.COOKIE=!0):t.defines.COOKIE=!1;for(var m=p.lightCamera.getViewProjectionMatrix().data,f=t.uniforms["shadowLightMatrices"+d]=t.uniforms["shadowLightMatrices"+d]||[],g=0;16>g;g++)f[g]=m[g];if(c.shadowCaster){var v=p.lightCamera.translation.data,y=t.uniforms["shadowLightPositions"+d]=t.uniforms["shadowLightPositions"+d]||[];if(y[0]=v[0],y[1]=v[1],y[2]=v[2],t.uniforms["cameraScales"+d]=1/(p.lightCamera.far-p.lightCamera.near),t.uniforms["shadowDarkness"+d]=c.shadowSettings.darkness,"PCF"===c.shadowSettings.shadowType){var x=t.uniforms["shadowMapSizes"+d]=t.uniforms["shadowMapSizes"+d]||[];x[0]=c.shadowSettings.resolution[0],x[1]=c.shadowSettings.resolution[1]}h.push("H","PCF"===c.shadowSettings.shadowType?1:"VSM"===c.shadowSettings.shadowType?2:0)}}}t.defines.LIGHT=h.join("")},builder:function(t,n){var a=[],l=[],h=[],d=[];a.push("const mat4 ScaleMatrix = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),h.push("uniform vec4 materialAmbient;","uniform vec4 materialEmissive;","uniform vec4 materialDiffuse;","uniform vec4 materialSpecular;","uniform float materialSpecularPower;","uniform vec3 globalAmbient;","float ChebychevInequality(in vec2 moments, in float t) {","if ( t <= moments.x ) return 1.0;","float variance = moments.y - (moments.x * moments.x);","variance = max(variance, 0.02);","float d = t - moments.x;","return variance / (variance + d * d);","}"),d.push("#if defined(SPECULAR_MAP) && defined(TEXCOORD0)","float specularStrength = texture2D(specularMap, texCoord0).x;","#else","float specularStrength = 1.0;","#endif","vec3 totalDiffuse = vec3(0.0);","vec3 totalSpecular = vec3(0.0);");for(var c=n.lights,u=0;u<c.length;u++){var p=c[u];d.push("{","float shadow = 1.0;","vec3 normalizedViewPosition = normalize(viewPosition);");var m=p.lightCookie instanceof i;(p.shadowCaster||m)&&n.renderable.meshRendererComponent&&n.renderable.meshRendererComponent.receiveShadows&&(a.push("uniform mat4 shadowLightMatrices"+u+";","varying vec4 shadowLightDepths"+u+";"),l.push("shadowLightDepths"+u+" = ScaleMatrix * shadowLightMatrices"+u+" * worldPos;"),p.shadowCaster&&h.push("uniform sampler2D shadowMaps"+u+";","uniform vec3 shadowLightPositions"+u+";","uniform float cameraScales"+u+";","uniform float shadowDarkness"+u+";"),m&&h.push("uniform sampler2D lightCookie"+u+";"),h.push("varying vec4 shadowLightDepths"+u+";"),p.shadowCaster&&"PCF"===p.shadowSettings.shadowType&&h.push("uniform vec2 shadowMapSizes"+u+";"),d.push("vec3 depth = shadowLightDepths"+u+".xyz / shadowLightDepths"+u+".w;"),p.shadowCaster&&(d.push("depth.z = length(vWorldPos.xyz - shadowLightPositions"+u+") * cameraScales"+u+";","if (depth.x >= 0.0 && depth.x <= 1.0 && depth.y >= 0.0 && depth.y <= 1.0 && shadowLightDepths"+u+".z >= 0.0 && depth.z <= 1.0) {"),"PCF"===p.shadowSettings.shadowType?d.push("depth.z *= 0.96;","float shadowPcf = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSizes"+u+".x;","float yPixelOffset = 1.0 / shadowMapSizes"+u+".y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","float fDepth = 0.0;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(dx0, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(0.0, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(dx1, dy0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(dx0, 0.0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth =  texture2D(shadowMaps"+u+", depth.xy).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(dx1, 0.0)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(dx0, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(0.0, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","fDepth = texture2D(shadowMaps"+u+", depth.xy + vec2(dx1, dy1)).r;","if (fDepth < depth.z) shadowPcf += shadowDelta;","shadow = mix(1.0, 1.0 - shadowPcf, shadowDarkness"+u+");"):"VSM"===p.shadowSettings.shadowType?d.push("vec4 texel = texture2D(shadowMaps"+u+", depth.xy);","vec2 moments = vec2(texel.x, texel.y);","shadow = ChebychevInequality(moments, depth.z);","shadow = pow(shadow, shadowDarkness"+u+" * 8.0);"):d.push("depth.z *= 0.96;","float shadowDepth = texture2D(shadowMaps"+u+", depth.xy).x;","if ( depth.z > shadowDepth ) shadow = 1.0 - shadowDarkness"+u+";"),d.push("}","shadow = clamp(shadow, 0.0, 1.0);"))),p instanceof e?(h.push("uniform vec4 pointLight"+u+";","uniform vec4 pointLightColor"+u+";"),d.push("vec3 lVector = normalize(pointLight"+u+".xyz - vWorldPos.xyz);","float lDistance = 1.0 - min((length(pointLight"+u+".xyz - vWorldPos.xyz) / pointLight"+u+".w), 1.0);","float dotProduct = dot(N, lVector);","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max(dotProduct, 0.0);","float pointDiffuseWeightHalf = max(0.5 * dotProduct + 0.5, 0.0);","float wrapRGB = 1.0;","vec3 pointDiffuseWeight = mix(vec3(pointDiffuseWeightFull), vec3(pointDiffuseWeightHalf), wrapRGB);","#else","float pointDiffuseWeight = max(dotProduct, 0.0);","#endif","totalDiffuse += materialDiffuse.rgb * pointLightColor"+u+".rgb * pointDiffuseWeight * lDistance * shadow;","vec3 pointHalfVector = normalize(lVector + normalizedViewPosition);","float pointDotNormalHalf = max(dot(N, pointHalfVector), 0.0);","float pointSpecularWeight = pointLightColor"+u+".a * specularStrength * max(pow(pointDotNormalHalf, materialSpecularPower), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecularPower + 2.0001 ) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(lVector, pointHalfVector), 5.0);","totalSpecular += schlick * pointLightColor"+u+".rgb * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization * shadow;","#else","totalSpecular += materialSpecular.rgb * pointLightColor"+u+".rgb * pointSpecularWeight * pointDiffuseWeight * lDistance * shadow;","#endif")):p instanceof o?(h.push("uniform vec4 directionalLightColor"+u+";","uniform vec3 directionalLightDirection"+u+";"),d.push("vec3 dirVector = normalize(-directionalLightDirection"+u+");","float dotProduct = dot(N, dirVector);","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max(dotProduct, 0.0);","float dirDiffuseWeightHalf = max(0.5 * dotProduct + 0.5, 0.0);","float wrapRGB = 1.0;","vec3 dirDiffuseWeight = mix(vec3(dirDiffuseWeightFull), vec3(dirDiffuseWeightHalf), wrapRGB);","#else","float dirDiffuseWeight = max(dotProduct, 0.0);","#endif","vec3 cookie = vec3(1.0);"),m&&d.push("vec4 cookieTex = texture2D(lightCookie"+u+", depth.xy);","cookie = cookieTex.rgb * cookieTex.a;"),d.push("totalDiffuse += materialDiffuse.rgb * directionalLightColor"+u+".rgb * dirDiffuseWeight * shadow * cookie;","vec3 dirHalfVector = normalize(dirVector + normalizedViewPosition);","float dirDotNormalHalf = max(dot(N, dirHalfVector), 0.0);","float dirSpecularWeight = directionalLightColor"+u+".a * specularStrength * max(pow(dirDotNormalHalf, materialSpecularPower), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecularPower + 2.0001) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(dirVector, dirHalfVector), 5.0);","totalSpecular += schlick * directionalLightColor"+u+".rgb * dirSpecularWeight * dirDiffuseWeight * specularNormalization * shadow * cookie;","#else","totalSpecular += materialSpecular.rgb * directionalLightColor"+u+".rgb * dirSpecularWeight * dirDiffuseWeight * shadow * cookie;","#endif")):p instanceof r&&(h.push("uniform vec4 spotLightColor"+u+";","uniform vec4 spotLight"+u+";","uniform vec3 spotLightDirection"+u+";","uniform float spotLightAngle"+u+";","uniform float spotLightPenumbra"+u+";"),d.push("vec3 lVector = normalize(spotLight"+u+".xyz - vWorldPos.xyz);","float lDistance = 1.0 - min((length(spotLight"+u+".xyz - vWorldPos.xyz) / spotLight"+u+".w), 1.0);","float spotEffect = dot(normalize(-spotLightDirection"+u+"), lVector);","if (spotEffect > spotLightAngle"+u+") {","if (spotLightPenumbra"+u+" > 0.0) {","spotEffect = (spotEffect - spotLightAngle"+u+") / spotLightPenumbra"+u+";","spotEffect = clamp(spotEffect, 0.0, 1.0);","} else {","spotEffect = 1.0;","}","float dotProduct = dot(N, lVector);","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max(dotProduct, 0.0);","float spotDiffuseWeightHalf = max(0.5 * dotProduct + 0.5, 0.0);","float wrapRGB = 1.0;","vec3 spotDiffuseWeight = mix(vec3(spotDiffuseWeightFull), vec3(spotDiffuseWeightHalf), wrapRGB);","#else","float spotDiffuseWeight = max(dotProduct, 0.0);","#endif","vec3 cookie = vec3(1.0);"),m&&d.push("cookie = texture2D(lightCookie"+u+", depth.xy).rgb;"),d.push("totalDiffuse += materialDiffuse.rgb * spotLightColor"+u+".rgb * spotDiffuseWeight * lDistance * spotEffect * shadow * cookie;","vec3 spotHalfVector = normalize(lVector + normalizedViewPosition);","float spotDotNormalHalf = max(dot(N, spotHalfVector), 0.0);","float spotSpecularWeight = spotLightColor"+u+".a * specularStrength * max(pow(spotDotNormalHalf, materialSpecularPower), 0.0);","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = (materialSpecularPower + 2.0001) / 8.0;","vec3 schlick = materialSpecular.rgb + vec3(1.0 - materialSpecular.rgb) * pow(1.0 - dot(lVector, spotHalfVector), 5.0);","totalSpecular += schlick * spotLightColor"+u+".rgb * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect * shadow * cookie;","#else","totalSpecular += materialSpecular.rgb * spotLightColor"+u+".rgb * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect * shadow * cookie;","#endif","}")),d.push("}")}d.push("#if defined(EMISSIVE_MAP) && defined(TEXCOORD0)","vec3 emissive = vec3(0.0);","#else","vec3 emissive = materialEmissive.rgb;","#endif","#ifdef SKIP_SPECULAR","final_color.xyz = final_color.xyz * (emissive + totalDiffuse + globalAmbient + materialAmbient.rgb);","#else","final_color.xyz = final_color.xyz * (emissive + totalDiffuse + globalAmbient + materialAmbient.rgb) + totalSpecular;","#endif","#if defined(EMISSIVE_MAP) && defined(TEXCOORD0)","final_color.rgb += texture2D(emissiveMap, texCoord0).rgb * materialEmissive.rgb;","#endif"),s.light.prevertex=a.join("\n"),s.light.vertex=l.join("\n"),s.light.prefragment=h.join("\n"),s.light.fragment=d.join("\n")}},s.animation={processor:function(t,e){var o=e.currentPose;t.defines=t.defines||{},o?(t.uniforms.jointPalette||(t.uniforms.jointPalette=s.animation.jointPalette),t.defines.JOINT_COUNT=Math.max(3*e.meshData.paletteMap.length,80)):delete t.defines.JOINT_COUNT},jointPalette:function(t){var e=t.meshData,o=t.currentPose;if(o){var r=o._matrixPalette,i=e.store;i||(i=new Float32Array(12*e.paletteMap.length),e.store=i);for(var n,a=0;a<e.paletteMap.length;a++){n=r[e.paletteMap[a]];for(var l=0;12>l;l++)i[12*a+l]=n.data[s.animation.order[l]]}return i}},order:[0,4,8,12,1,5,9,13,2,6,10,14],prevertex:["#ifdef JOINTIDS","attribute vec4 vertexJointIDs;","#endif","#ifdef WEIGHTS","attribute vec4 vertexWeights;","#endif","#ifdef JOINT_COUNT","uniform vec4 jointPalette[JOINT_COUNT];","#endif"].join("\n"),vertex:["#if defined(JOINT_COUNT) && defined(WEIGHTS) && defined(JOINTIDS)","int x = 3*int(vertexJointIDs.x);","int y = 3*int(vertexJointIDs.y);","int z = 3*int(vertexJointIDs.z);","int w = 3*int(vertexJointIDs.w);","mat4 mat = mat4(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);","mat += mat4(","	jointPalette[x+0].x, jointPalette[x+1].x, jointPalette[x+2].x, 0,","	jointPalette[x+0].y, jointPalette[x+1].y, jointPalette[x+2].y, 0,","	jointPalette[x+0].z, jointPalette[x+1].z, jointPalette[x+2].z, 0,","	jointPalette[x+0].w, jointPalette[x+1].w, jointPalette[x+2].w, 1",") * vertexWeights.x;","mat += mat4(","	jointPalette[y+0].x, jointPalette[y+1].x, jointPalette[y+2].x, 0,","	jointPalette[y+0].y, jointPalette[y+1].y, jointPalette[y+2].y, 0,","	jointPalette[y+0].z, jointPalette[y+1].z, jointPalette[y+2].z, 0,","	jointPalette[y+0].w, jointPalette[y+1].w, jointPalette[y+2].w, 1",") * vertexWeights.y;","mat += mat4(","	jointPalette[z+0].x, jointPalette[z+1].x, jointPalette[z+2].x, 0,","	jointPalette[z+0].y, jointPalette[z+1].y, jointPalette[z+2].y, 0,","	jointPalette[z+0].z, jointPalette[z+1].z, jointPalette[z+2].z, 0,","	jointPalette[z+0].w, jointPalette[z+1].w, jointPalette[z+2].w, 1",") * vertexWeights.z;","mat += mat4(","	jointPalette[w+0].x, jointPalette[w+1].x, jointPalette[w+2].x, 0,","	jointPalette[w+0].y, jointPalette[w+1].y, jointPalette[w+2].y, 0,","	jointPalette[w+0].z, jointPalette[w+1].z, jointPalette[w+2].z, 0,","	jointPalette[w+0].w, jointPalette[w+1].w, jointPalette[w+2].w, 1",") * vertexWeights.w;","wMatrix = wMatrix * mat / mat[3][3];","#ifdef NORMAL","nMatrix = nMatrix * mat / mat[3][3];","#endif","#endif"].join("\n")},s}),define("goo/renderer/shaders/ShaderLib",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderBuilder","goo/renderer/Util","goo/entities/World"],function(t,e,o,r,i,n){"use strict";function a(){}return a.uber={processors:[r.uber.processor,r.light.processor,r.animation.processor],attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL,vertexTangent:t.TANGENT,vertexColor:t.COLOR,vertexUV0:t.TEXCOORD0,vertexUV1:t.TEXCOORD1,vertexJointIDs:t.JOINTIDS,vertexWeights:t.WEIGHTS},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,normalMatrix:e.NORMAL_MATRIX,cameraPosition:e.CAMERA,diffuseMap:e.DIFFUSE_MAP,offsetRepeat:[0,0,1,1],normalMap:e.NORMAL_MAP,normalMultiplier:1,specularMap:e.SPECULAR_MAP,emissiveMap:e.EMISSIVE_MAP,aoMap:e.AO_MAP,lightMap:e.LIGHT_MAP,environmentCube:"ENVIRONMENT_CUBE",environmentSphere:"ENVIRONMENT_SPHERE",reflectionMap:"REFLECTION_MAP",transparencyMap:"TRANSPARENCY_MAP",opacity:1,reflectivity:0,refractivity:0,etaRatio:-.5,fresnel:0,discardThreshold:-.01,fogSettings:[0,1e4],fogColor:[1,1,1],shadowDarkness:.5,vertexColorAmount:1,lodBias:0},builder:function(t,e){r.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","#ifdef NORMAL","attribute vec3 vertexNormal;","#endif","#ifdef TANGENT","attribute vec4 vertexTangent;","#endif","#ifdef COLOR","attribute vec4 vertexColor;","#endif","#ifdef TEXCOORD0","attribute vec2 vertexUV0;","uniform vec4 offsetRepeat;","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","attribute vec2 vertexUV1;","varying vec2 texCoord1;","#endif","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 normalMatrix;","uniform vec3 cameraPosition;","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef COLOR","varying vec4 color;","#endif",r.light.prevertex,r.animation.prevertex,"void main(void) {","mat4 wMatrix = worldMatrix;","#ifdef NORMAL","mat4 nMatrix = normalMatrix;","#endif",r.animation.vertex,"vec4 worldPos = wMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;","viewPosition = cameraPosition - worldPos.xyz;","#ifdef NORMAL","	normal = normalize((nMatrix * vec4(vertexNormal, 0.0)).xyz);","#endif","#ifdef TANGENT","	tangent = normalize((nMatrix * vec4(vertexTangent.xyz, 0.0)).xyz);","	binormal = cross(normal, tangent) * vec3(vertexTangent.w);","#endif","#ifdef COLOR","	color = vertexColor;","#endif","#ifdef TEXCOORD0","	texCoord0 = vertexUV0 * offsetRepeat.zw + offsetRepeat.xy;","#endif","#ifdef TEXCOORD1","	texCoord1 = vertexUV1;","#endif",r.light.vertex,"}"].join("\n")},fshader:function(){return["uniform float lodBias;","#ifdef DIFFUSE_MAP","uniform sampler2D diffuseMap;","#endif","#ifdef NORMAL_MAP","uniform sampler2D normalMap;","uniform float normalMultiplier;","#endif","#ifdef SPECULAR_MAP","uniform sampler2D specularMap;","#endif","#ifdef EMISSIVE_MAP","uniform sampler2D emissiveMap;","#endif","#ifdef AO_MAP","uniform sampler2D aoMap;","#endif","#ifdef LIGHT_MAP","uniform sampler2D lightMap;","#endif","#ifdef TRANSPARENCY_MAP","uniform sampler2D transparencyMap;","#endif","#ifdef ENVIRONMENT_CUBE","uniform samplerCube environmentCube;","#else","uniform sampler2D environmentSphere;","#endif","uniform vec4 clearColor;","uniform float reflectivity;","uniform float fresnel;","uniform float refractivity;","uniform float etaRatio;","#ifdef REFLECTION_MAP","uniform sampler2D reflectionMap;","#endif","uniform float opacity;","#ifdef DISCARD","uniform float discardThreshold;","#endif","#ifdef FOG","uniform vec2 fogSettings;","uniform vec3 fogColor;","#endif","varying vec3 vWorldPos;","varying vec3 viewPosition;","#ifdef NORMAL","varying vec3 normal;","#endif","#ifdef TANGENT","varying vec3 binormal;","varying vec3 tangent;","#endif","#ifdef COLOR","varying vec4 color;","uniform float vertexColorAmount;","#endif","#ifdef TEXCOORD0","varying vec2 texCoord0;","#endif","#ifdef TEXCOORD1","varying vec2 texCoord1;","#endif",r.light.prefragment,"void main(void)","{","vec4 final_color = vec4(1.0);","#if defined(DIFFUSE_MAP) && defined(TEXCOORD0)","final_color *= texture2D(diffuseMap, texCoord0, lodBias);","#endif","#ifdef COLOR","final_color *= mix(vec4(1.0), color, vertexColorAmount);","#endif","#if defined(TRANSPARENCY_MAP) && defined(TEXCOORD0)","final_color.a = texture2D(transparencyMap, texCoord0).a;","#endif","final_color.a *= opacity;","#ifdef DISCARD","if (final_color.a < discardThreshold) discard;","#endif","#ifdef AO_MAP","#ifdef TEXCOORD1","final_color.rgb *= texture2D(aoMap, texCoord1).rgb;","#elif defined(TEXCOORD0)","final_color.rgb *= texture2D(aoMap, texCoord0).rgb;","#endif","#endif","#ifdef LIGHT_MAP","#ifdef TEXCOORD1","final_color.rgb *= texture2D(lightMap, texCoord1).rgb * 2.0 - 0.5;","#elif defined(TEXCOORD0)","final_color.rgb *= texture2D(lightMap, texCoord0).rgb * 2.0 - 0.5;","#endif","#else","vec3 N = vec3(0.0, 1.0, 0.0);","#if defined(NORMAL)","N = normalize(normal);","#endif","#if defined(TANGENT) && defined(NORMAL_MAP) && defined(TEXCOORD0)","mat3 tangentToWorld = mat3(tangent, binormal, normal);","vec3 tangentNormal = texture2D(normalMap, texCoord0, lodBias).xyz * vec3(2.0) - vec3(1.0);","tangentNormal.xy *= normalMultiplier;","vec3 worldNormal = (tangentToWorld * tangentNormal);","N = normalize(worldNormal);","#endif",r.light.fragment,"#endif","if (refractivity > 0.0) {","vec3 refractionVector = refract(normalize(viewPosition), N, etaRatio);","refractionVector.x = -refractionVector.x;","vec4 environment = vec4(0.0);","#ifdef ENVIRONMENT_CUBE","environment = textureCube(environmentCube, refractionVector);","#elif defined(ENVIRONMENT_SPHERE)","refractionVector = -refractionVector;","float m = 4.0 * sqrt(refractionVector.x*refractionVector.x + refractionVector.y*refractionVector.y + (refractionVector.z+1.0)*(refractionVector.z+1.0));","environment = texture2D(environmentSphere, (refractionVector.xy / m) + 0.5);","#endif","environment.rgb = mix(clearColor.rgb, environment.rgb, environment.a);","final_color.rgb = mix(final_color.rgb, environment.rgb, refractivity);","}","if (reflectivity > 0.0) {","vec3 reflectionVector = reflect(viewPosition, N);","reflectionVector.yz = -reflectionVector.yz;","vec4 environment = vec4(0.0);","#ifdef ENVIRONMENT_CUBE","environment = textureCube(environmentCube, reflectionVector);","#elif defined(ENVIRONMENT_SPHERE)","reflectionVector = -reflectionVector;","float m = 4.0 * sqrt(reflectionVector.x*reflectionVector.x + reflectionVector.y*reflectionVector.y + (reflectionVector.z+1.0)*(reflectionVector.z+1.0));","environment = texture2D(environmentSphere, (reflectionVector.xy / m) + 0.5);","#endif","environment.rgb = mix(clearColor.rgb, environment.rgb, environment.a);","float reflectionAmount = reflectivity;","#if defined(REFLECTION_MAP) && defined(TEXCOORD0)","reflectionAmount *= texture2D(reflectionMap, texCoord0).r;","#endif","float fresnelVal = pow(1.0 - abs(dot(normalize(viewPosition), N)), fresnel * 4.0);","reflectionAmount *= fresnelVal;","final_color.rgb = mix(final_color.rgb, environment.rgb, reflectionAmount);","}","#ifndef LIGHT_MAP","final_color.rgb += totalSpecular;","final_color.a += min(length(totalSpecular), 1.0);","#endif","#ifdef FOG","float d = pow(smoothstep(fogSettings.x, fogSettings.y, length(viewPosition)), 1.0);","final_color.rgb = mix(final_color.rgb, fogColor, d);","#endif","gl_FragColor = final_color;","}"].join("\n")}},a.screenCopy={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = texture2D(diffuseMap, texCoord0);","}"].join("\n")},a.copy={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,opacity:1,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform float opacity;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = vec4(texture2D(diffuseMap, texCoord0).rgb, opacity);","}"].join("\n")},a.copyPure={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,opacity:1,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform float opacity;","varying vec2 texCoord0;","void main(void)","{","vec4 col = texture2D(diffuseMap, texCoord0);","gl_FragColor = vec4(col.rgb, col.a * opacity);","}"].join("\n")},a.simple={attributes:{vertexPosition:t.POSITION},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["void main(void)","{","gl_FragColor = vec4(1.0);","}"].join("\n")},a.simpleColored={attributes:{vertexPosition:t.POSITION},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,color:[1,1,1],opacity:1},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform vec3 color;","uniform float opacity;","void main(void)","{","if (opacity == 0.0) {","discard;","}","gl_FragColor = vec4(color, opacity);","}"].join("\n")},a.simpleLit={processors:[r.light.processor],defines:{NORMAL:!0},attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraPosition:e.CAMERA,opacity:1},builder:function(t,e){r.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;",r.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;",r.light.vertex,"normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["#ifdef SPECULAR_MAP","uniform sampler2D specularMap;","#ifdef TEXCOORD0","varying vec2 texCoord0;","#endif","#endif","uniform float opacity;",r.light.prefragment,"#ifdef NORMAL","varying vec3 normal;","#endif","varying vec3 vWorldPos;","varying vec3 viewPosition;","void main(void)","{","if (opacity == 0.0) {","discard;","}","#ifdef NORMAL","vec3 N = normalize(normal);","#else","vec3 N = vec3(0,0,1);","#endif","vec4 final_color = vec4(1.0);",r.light.fragment,"final_color.a = opacity;","gl_FragColor = final_color;","}"].join("\n")}},a.billboard={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,viewMatrix:e.VIEW_MATRIX,worldMatrix:e.WORLD_MATRIX,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(0.0, 0.0, 0.0, 1.0) + projectionMatrix * vec4(vertexPosition.x, vertexPosition.y, 0.0, 0.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = texture2D(diffuseMap, texCoord0);","}"].join("\n")},a.textured={defines:{TEXCOORD0:!0,DIFFUSE_MAP:!0},attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["#if defined(TEXCOORD0) && defined(DIFFUSE_MAP)","uniform sampler2D diffuseMap;","varying vec2 texCoord0;","#endif","void main(void)","{","#if defined(TEXCOORD0) && defined(DIFFUSE_MAP)","gl_FragColor = texture2D(diffuseMap, texCoord0);","#else","gl_FragColor = vec4(1.0);","#endif","}"].join("\n")},a.texturedLit={processors:[r.light.processor],attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraPosition:e.CAMERA,diffuseMap:e.DIFFUSE_MAP},builder:function(t,e){r.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;",r.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;",r.light.vertex,"normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","texCoord0 = vertexUV0;","viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["uniform sampler2D diffuseMap;",r.light.prefragment,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void)","{","vec3 N = normalize(normal);","vec4 final_color = texture2D(diffuseMap, texCoord0);",r.light.fragment,"gl_FragColor = final_color;","}"].join("\n")}},a.convolution={defines:{KERNEL_SIZE_FLOAT:"25.0",KERNEL_SIZE_INT:"25"},attributes:{position:t.POSITION,uv:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,uImageIncrement:[.001953125,0],cKernel:[],size:1},vshader:["attribute vec3 position;","attribute vec2 uv;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float size;","uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vUv = uv - ( ( KERNEL_SIZE_FLOAT - 1.0 ) / 2.0 ) * size * uImageIncrement;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( position, 1.0 );","}"].join("\n"),fshader:["uniform float cKernel[ KERNEL_SIZE_INT ];","uniform sampler2D tDiffuse;","uniform vec2 uImageIncrement;","uniform float size;","varying vec2 vUv;","void main() {","vec2 imageCoord = vUv;","vec4 sum = vec4( 0.0 );","for( int i = 0; i < KERNEL_SIZE_INT; i ++ ) {","sum += texture2D( tDiffuse, imageCoord ) * cKernel[ i ];","imageCoord += uImageIncrement * size;","}","gl_FragColor = sum;","}"].join("\n"),buildKernel:function(t){function e(t,e){return Math.exp(-(t*t)/(2*e*e))}var o,r,i,n,a=25,s=2*Math.ceil(3*t)+1;for(s>a&&(s=a),n=.5*(s-1),r=new Array(s),i=0,o=0;s>o;++o)r[o]=e(o-n,t),i+=r[o];for(o=0;s>o;++o)r[o]/=i;return r}},a.showDepth={attributes:{vertexPosition:t.POSITION},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,near:e.NEAR_PLANE,far:e.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform float near;","uniform float far;","void main(void)","{","float depth = gl_FragCoord.z / gl_FragCoord.w;","float d = 1.0 - smoothstep( near, far, depth );","gl_FragColor = vec4(d);","}"].join("\n")},a.showNormals={defines:{NORMAL:!0},attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,opacity:1},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec3 normal;","void main() {","normal = vec3(worldMatrix * vec4(vertexNormal, 0.0));","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform float opacity;","#ifdef NORMAL","varying vec3 normal;","#else","vec3 normal = vec3(0,0,1);","#endif","void main() {","gl_FragColor = vec4( 0.5 * normalize( normal ) + 0.5, opacity );","}"].join("\n")},a.bokehShader={attributes:{position:t.POSITION,uv:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tColor:e.DIFFUSE_MAP,tDepth:e.DEPTH_MAP,focus:1,aspect:1,aperture:.025,maxblur:1},vshader:["attribute vec3 position;","attribute vec2 uv;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","	vUv = uv;","	gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( position, 1.0 );","}"].join("\n"),fshader:["varying vec2 vUv;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float maxblur;","uniform float aperture;","uniform float focus;","uniform float aspect;","void main() {","vec2 aspectcorrect = vec2( 1.0, aspect );","vec4 depth1 = texture2D( tDepth, vUv );","float factor = depth1.x - focus;","vec2 dofblur = vec2 ( clamp( factor * aperture, -maxblur, maxblur ) );","vec2 dofblur9 = dofblur * 0.9;","vec2 dofblur7 = dofblur * 0.7;","vec2 dofblur4 = dofblur * 0.4;","vec4 col = vec4( 0.0 );","col += texture2D( tColor, vUv.xy );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur4 );","gl_FragColor = col / 41.0;","gl_FragColor.a = 1.0;","}"].join("\n")},a.particles={attributes:{vertexPosition:t.POSITION,vertexColor:t.COLOR,vertexUV0:t.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,diffuseMap:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","varying vec4 color;","void main(void) {","texCoord0 = vertexUV0;","color = vertexColor;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","varying vec4 color;","void main(void)","{","vec4 texCol = texture2D(diffuseMap, texCoord0);","if (color.a == 0.0 || texCol.a == 0.0) discard;","else gl_FragColor = texCol * color;","}"].join("\n")},a.sepia={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,amount:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float amount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 color = texture2D(tDiffuse, vUv );","vec3 c = color.rgb;","color.r = dot(c, vec3(1.0 - 0.607 * amount, 0.769 * amount, 0.189 * amount));","color.g = dot(c, vec3(0.349 * amount, 1.0 - 0.314 * amount, 0.168 * amount));","color.b = dot(c, vec3(0.272 * amount, 0.534 * amount, 1.0 - 0.869 * amount));","gl_FragColor = vec4(min(vec3(1.0), color.rgb), color.a);","}"].join("\n")},a.dotscreen={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,tSize:[256,256],center:[.5,.5],angle:1.57,scale:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","float s = sin( angle ), c = cos( angle );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","float average = ( color.r + color.g + color.b ) / 3.0;","gl_FragColor = vec4( color.rgb * vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},a.vignette={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,offset:1,darkness:1.5},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float offset;","uniform float darkness;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );","gl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );","}"].join("\n")},a.film={attributes:a.copy.attributes,uniforms:{tDiffuse:e.DIFFUSE_MAP,time:function(){return n.time
},nIntensity:.5,sIntensity:.5,sCount:1024,grayscale:0,$link:a.copy.uniforms},vshader:a.copy.vshader,fshader:["uniform float time;","uniform bool grayscale;","uniform float nIntensity;","uniform float sIntensity;","uniform float sCount;","uniform sampler2D tDiffuse;","varying vec2 texCoord0;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, texCoord0 );","float x = texCoord0.x * texCoord0.y * time * 1000.0;","x = mod( x, 13.0 ) * mod( x, 123.0 );","float dx = mod( x, 0.01 );","vec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx * 100.0, 0.0, 1.0 );","vec2 sc = vec2( sin( texCoord0.y * sCount ), cos( texCoord0.y * sCount ) );","cResult += cTextureScreen.rgb * vec3( sc.x, sc.y, sc.x ) * sIntensity;","cResult = cTextureScreen.rgb + nIntensity * ( cResult - cTextureScreen.rgb );","if( grayscale ) {","	cResult = vec3( cResult.r * 0.3 + cResult.g * 0.59 + cResult.b * 0.11 );","}","gl_FragColor = vec4( cResult, cTextureScreen.a );","}"].join("\n")},a.noise={attributes:a.copy.attributes,uniforms:{tDiffuse:e.DIFFUSE_MAP,time:function(){return n.time},nIntensity:.5,grayscale:0,$link:a.copy.uniforms},vshader:a.copy.vshader,fshader:["uniform float time;","uniform bool grayscale;","uniform float nIntensity;","uniform sampler2D tDiffuse;","varying vec2 texCoord0;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, texCoord0);","float x = texCoord0.x * texCoord0.y * time * 1000.0;","vec3 cResult;","if ( !grayscale ) {","float y = fract(sin(dot(vec2(mod( x + 20.0, 87.0 ), mod( x + 150.0, 23.0 )), vec2(12.9898,78.233))) * 43758.5453);","float z = fract(sin(dot(vec2(mod( x + 30.0, 19.0 ), mod( x + 200.0, 103.0 )), vec2(12.9898,78.233))) * 43758.5453);","x = fract(sin(dot(vec2(mod( x, 13.0 ), mod( x + 50.0, 123.0 )), vec2(12.9898,78.233))) * 43758.5453);","cResult = vec3(x, y, z);","} else {","x = fract(sin(dot(vec2(mod( x, 13.0 ), mod( x + 50.0, 123.0 )), vec2(12.9898,78.233))) * 43758.5453);","cResult = vec3(x);","}","gl_FragColor = vec4( mix(cTextureScreen.rgb, cResult, nIntensity), cTextureScreen.a );","}"].join("\n")},a.bleachbypass={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,opacity:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 base = texture2D( tDiffuse, vUv );","vec3 lumCoeff = vec3( 0.25, 0.65, 0.1 );","float lum = dot( lumCoeff, base.rgb );","vec3 blend = vec3( lum );","float L = min( 1.0, max( 0.0, 10.0 * ( lum - 0.45 ) ) );","vec3 result1 = 2.0 * base.rgb * blend;","vec3 result2 = 1.0 - 2.0 * ( 1.0 - blend ) * ( 1.0 - base.rgb );","vec3 newColor = mix( result1, result2, L );","float A2 = opacity * base.a;","vec3 mixRGB = A2 * newColor.rgb;","mixRGB += ( ( 1.0 - A2 ) * base.rgb );","gl_FragColor = vec4( mixRGB, base.a );","}"].join("\n")},a.horizontalTiltShift={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,h:1/128,r:.5},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float h;","uniform float r;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float hh = h * abs( r - vUv.y );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * hh, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x,            vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * hh, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},a.colorify={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,color:[1,1,1],amount:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform vec3 color;","uniform float amount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( gl_FragColor.rgb, luma );","gl_FragColor.rgb = mix(gl_FragColor.rgb, v * color, amount);","}"].join("\n")},a.hatch={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,width:0,spread:10,replace:!0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float width;","uniform float spread;","uniform bool replace;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","float lum = length(gl_FragColor.rgb);","vec3 mult = vec3(1.0, 1.0, 1.0);","float halfSpread = (spread*0.5);","if (lum < 1.00) {","float diff = abs(mod(gl_FragCoord.x + gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (lum < 0.75) {","float diff = abs(mod(gl_FragCoord.x - gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (lum < 0.50) {","float diff = abs(mod(gl_FragCoord.x + halfSpread + gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (lum < 0.25) {","float diff = abs(mod(gl_FragCoord.x + halfSpread - gl_FragCoord.y, spread) - halfSpread);","if (diff <= width) {","mult *= vec3(1.0 - (width - diff) / width);","}","}","if (replace) {","gl_FragColor.rgb = mult;","} else {","gl_FragColor.rgb *= mult;","}","}"].join("\n")},a.normalmap={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,heightMap:e.DIFFUSE_MAP,resolution:[512,512],height:.05},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float height;","uniform vec2 resolution;","uniform sampler2D heightMap;","varying vec2 vUv;","void main() {","float val = texture2D( heightMap, vUv ).x;","float valU = texture2D( heightMap, vUv + vec2( 1.0 / resolution.x, 0.0 ) ).x;","float valV = texture2D( heightMap, vUv + vec2( 0.0, 1.0 / resolution.y ) ).x;","gl_FragColor = vec4( ( 0.5 * normalize( vec3( val - valU, val - valV, height  ) ) + 0.5 ), 1.0 );","}"].join("\n")},a.ssao={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,tDepth:e.DEPTH_MAP,size:[512,512],cameraNear:e.MAIN_NEAR_PLANE,cameraFar:e.MAIN_FAR_PLANE,fogNear:e.MAIN_NEAR_PLANE,fogFar:e.MAIN_FAR_PLANE,fogEnabled:0,onlyAO:0,aoClamp:.3,lumInfluence:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float cameraNear;","uniform float cameraFar;","uniform float fogNear;","uniform float fogFar;","uniform bool fogEnabled;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","float width = size.x;","float height = size.y;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","const int samples = 16;","const float radius = 2.0;","const bool useNoise = false;","const float noiseAmount = 0.0003;","const float diffArea = 0.4;","const float gDisplace = 0.4;","const vec3 onlyAOColor = vec3( 1.0, 1.0, 1.0 );","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( width / 2.0 ) );","float gg = fract( coord.t * ( height / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","float doFog() {","float zdepth = unpackDepth( texture2D( tDepth, vUv ) );","float depth = -cameraFar * cameraNear / ( zdepth * cameraFarMinusNear - cameraFar );","return smoothstep( fogNear, fogFar, depth );","}","float readDepth( const in vec2 coord ) {","return cameraCoef / ( cameraFarPlusNear - unpackDepth( texture2D( tDepth, coord ) ) * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 2.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","float dd = radius - depth * radius;","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + dd * vv;","vec2 coord2 = vUv - dd * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / width )  / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / height ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float pw;","float ph;","float ao;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","pw = cos( l ) * r;","ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","if ( fogEnabled ) {","ao = mix( ao, 1.0, doFog() );","}","vec3 color = texture2D( tDiffuse, vUv ).rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = onlyAOColor * vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, 1.0 );","}"].join("\n")},a.skinning={defines:{JOINT_COUNT:56,WEIGHTS:4},attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0,vertexWeights:t.WEIGHTS,vertexJointIDs:t.JOINTIDS},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,diffuseMap:e.DIFFUSE_MAP,jointPalette:function(t){var e=t.meshData,o=e.currentPose;if(o){var r=o._matrixPalette,i=16*e.paletteMap.length,n=e.store;n||(n=new Float32Array(i),e.store=n);for(var a,s=0;s<e.paletteMap.length;s++){a=r[e.paletteMap[s]];for(var l=0;4>l;l++)for(var h=0;4>h;h++)n[16*s+4*l+h]=a.data[4*h+l]}return n}}},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","attribute vec4 vertexWeights;","attribute vec4 vertexJointIDs;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 jointPalette[JOINT_COUNT];","varying vec2 texCoord0;","void main(void) {","mat4 mat = mat4(0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0);","mat += jointPalette[int(vertexJointIDs.x)] * vertexWeights.x;","mat += jointPalette[int(vertexJointIDs.y)] * vertexWeights.y;","mat += jointPalette[int(vertexJointIDs.z)] * vertexWeights.z;","mat += jointPalette[int(vertexJointIDs.w)] * vertexWeights.w;","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * mat * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{","gl_FragColor = texture2D(diffuseMap, texCoord0);","}"].join("\n")},a.rgbshift={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,amount:.005,angle:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float amount;","uniform float angle;","varying vec2 vUv;","void main() {","vec2 offset = amount * vec2( cos(angle), sin(angle));","vec4 cr = texture2D(tDiffuse, vUv + offset);","vec4 cga = texture2D(tDiffuse, vUv);","vec4 cb = texture2D(tDiffuse, vUv - offset);","gl_FragColor = vec4(cr.r, cga.g, cb.b, cga.a);","}"].join("\n")},a.brightnesscontrast={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,brightness:0,contrast:0,saturation:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float brightness;","uniform float contrast;","uniform float saturation;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","gl_FragColor.rgb += brightness;","if (contrast > 0.0) {","gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) / (1.0 - contrast) + 0.5;","} else {","gl_FragColor.rgb = (gl_FragColor.rgb - 0.5) * (1.0 + contrast) + 0.5;","}","vec3 gray = vec3(dot(vec3(0.2126,0.7152,0.0722), gl_FragColor.rgb));","gl_FragColor.rgb = mix(gl_FragColor.rgb, gray, -saturation);","}"].join("\n")},a.hsb={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,hue:0,saturation:0,brightness:0},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform float hue;","uniform float saturation;","uniform float brightness;","varying vec2 vUv;",o.methods.hsv,"void main() {","gl_FragColor = texture2D(tDiffuse, vUv);","vec3 fragHSV = rgb2hsv(gl_FragColor.rgb).xyz;","fragHSV.x += hue * 0.5;","fragHSV.y *= saturation + 1.0 - max(brightness, 0.0) * 2.0;","fragHSV.z *= min(brightness + 1.0, 1.0);","fragHSV.z += max(brightness, 0.0);","fragHSV.xyz = clamp(fragHSV.xyz, vec3(-10.0, 0.0, 0.0), vec3(10.0, 1.0, 1.0));","gl_FragColor.rgb = hsv2rgb(fragHSV);","}"].join("\n")},a.luminosity={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","gl_FragColor = vec4( v, v, v, texel.w );","}"].join("\n")},a.point={attributes:{vertexPosition:t.POSITION,vertexColor:t.COLOR},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,pointSize:2},vshader:["attribute vec3 vertexPosition;","attribute vec4 vertexColor;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform float pointSize;","varying vec4 color;","void main(void) {","color = vertexColor;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","gl_PointSize = pointSize;","}"].join("\n"),fshader:["varying vec4 color;","void main(void)","{","gl_FragColor = color;","}"].join("\n")},a.toon={attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraPosition:e.CAMERA,lightPosition:e.LIGHT0,HighlightColour:[.9,.8,.7,1],MidColour:[.65,.55,.45,1],ShadowColour:[.4,.3,.2,1],HighlightSize:.2,ShadowSize:.01,OutlineWidth:.15},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform vec3 lightPosition;","varying vec3 N;","varying vec3 V;","varying vec3 L;","void main() {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","N = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","L = lightPosition - worldPos.xyz;","V = cameraPosition - worldPos.xyz;","gl_Position = projectionMatrix * viewMatrix * worldPos;","}"].join("\n"),fshader:["uniform vec4 HighlightColour;","uniform vec4 MidColour;","uniform vec4 ShadowColour;","uniform float HighlightSize;","uniform float ShadowSize;","uniform float OutlineWidth;","varying vec3 N;","varying vec3 L;","varying vec3 V;","void main() {","vec3 n = normalize(N);","vec3 l = normalize(L);","vec3 v = normalize(V);","float lambert = dot(l,n);","vec4 colour = MidColour;","if (lambert > 1.0 - HighlightSize) colour = HighlightColour;","if (lambert < ShadowSize) colour = ShadowColour;","if (dot(n,v) < OutlineWidth) colour = vec4(0.0,0.0,0.0,1.0);","gl_FragColor = colour;","}"].join("\n")},a.differenceOfGaussians={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,gaussBlurredImage1:"BLUR1",gaussBlurredImage2:"BLUR2",originalImage:"ORIGINAL",threshold:.01,edgeColor:[1,0,1,1],backgroundColor:[0,0,0,1],backgroundMix:1},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D gaussBlurredImage1;","uniform sampler2D gaussBlurredImage2;","uniform sampler2D originalImage;","uniform float threshold;","uniform float backgroundMix;","uniform vec4 edgeColor;","uniform vec4 backgroundColor;","varying vec2 texCoord0;","void main(void)","{","vec4 blur1 = texture2D(gaussBlurredImage1, texCoord0);","vec4 blur2 = texture2D(gaussBlurredImage2, texCoord0);","vec4 originalColor = texture2D(originalImage, texCoord0);","vec3 nonEdgeColor = mix(originalColor.rgb, backgroundColor.rgb, backgroundMix);","vec3 diffColor = abs(blur1.rgb - blur2.rgb);","float edgeValue = (diffColor.r + diffColor.g + diffColor.b) / 3.0;","edgeValue = smoothstep(0.0, threshold, edgeValue);","vec3 outputColor = mix(nonEdgeColor, edgeColor.rgb, edgeValue);","gl_FragColor = vec4(outputColor, 1.0);","}"].join("\n")},a.downsample={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","}"].join("\n")},a.boxfilter={attributes:{vertexPosition:t.POSITION,vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,tDiffuse:e.DIFFUSE_MAP,viewport:[128,128]},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform sampler2D tDiffuse;","uniform vec2 viewport;","varying vec2 vUv;","void main() {","vec3 result = vec3(0.0);","for(int x=-1; x<=1; x++) {","for(int y=-1; y<=1; y++) {","result += texture2D(tDiffuse, vUv + vec2(x, y) / viewport).rgb;","}","}","gl_FragColor = vec4(result / vec3(9.0), 1.0);","}"].join("\n")},a.lightDepth={processors:[r.animation.processor],defines:{SHADOW_TYPE:0,WEIGHTS:!0,JOINTIDS:!0},attributes:{vertexPosition:t.POSITION,vertexJointIDs:t.JOINTIDS,vertexWeights:t.WEIGHTS},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraScale:e.MAIN_DEPTH_SCALE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 worldPosition;",r.animation.prevertex,"void main(void) {","mat4 wMatrix = worldMatrix;",r.animation.vertex,"worldPosition = viewMatrix * wMatrix * vec4(vertexPosition, 1.0);","gl_Position = projectionMatrix * worldPosition;","}"].join("\n"),fshader:["uniform float cameraScale;","varying vec4 worldPosition;","void main(void)","{","float linearDepth = length(worldPosition) * cameraScale;","#if SHADOW_TYPE == 0","gl_FragColor = vec4(linearDepth);","#elif SHADOW_TYPE == 1","gl_FragColor = vec4(linearDepth);","#elif SHADOW_TYPE == 2","gl_FragColor = vec4(linearDepth, linearDepth * linearDepth, 0.0, 0.0);","#endif","}"].join("\n")},a.packDepth={attributes:{vertexPosition:t.POSITION},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,farPlane:e.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 vPosition;","void main(void) {","vPosition = viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fshader:["uniform float farPlane;",o.methods.packDepth,"varying vec4 vPosition;","void main(void)","{","float linearDepth = min(length(vPosition), farPlane) / farPlane;","gl_FragColor = packDepth(linearDepth);","}"].join("\n")},a.pickingShader={defines:{WEIGHTS:!0,JOINTIDS:!0},attributes:{vertexPosition:t.POSITION,vertexJointIDs:t.JOINTIDS,vertexWeights:t.WEIGHTS},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,cameraFar:e.FAR_PLANE,id:function(t){return null!=t.renderable._index?t.renderable._index+1:t.renderable.id+1}},processors:[r.animation.processor],vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float cameraFar;",r.animation.prevertex,"varying float depth;","void main() {","mat4 wMatrix = worldMatrix;",r.animation.vertex,"vec4 mvPosition = viewMatrix * wMatrix * vec4( vertexPosition, 1.0 );","depth = -mvPosition.z / cameraFar;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fshader:["uniform float id;","varying float depth;",o.methods.packDepth16,"void main() {","vec2 packedId = vec2(floor(id/255.0), mod(id, 255.0)) * vec2(1.0/255.0);","vec2 packedDepth = packDepth16(depth);","gl_FragColor = vec4(packedId, packedDepth);","}"].join("\n")},a}),define("goo/util/Enum",[],function(){"use strict";function t(t,e){return Object.getOwnPropertyNames(e).forEach(function(o){Object.defineProperty(t,o,Object.getOwnPropertyDescriptor(e,o))}),t}function e(e,o){this.name=e,o&&t(this,o),Object.freeze(this)}function o(t){1===arguments.length&&null!==t&&"object"==typeof t?Object.keys(t).forEach(function(o){this[o]=new e(o,t[o])},this):Array.prototype.forEach.call(arguments,function(t){this[t]=new e(t)},this),Object.freeze(this)}return e.prototype=Object.create(null),e.prototype.constructor=e,e.prototype.toString=function(){return"|"+this.name+"|"},Object.freeze(e.prototype),o.prototype.symbols=function(){return Object.keys(this).map(function(t){return this[t]},this)},o.prototype.contains=function(t){return!t instanceof e?!1:this[t.name]===t},o}),define("goo/shapes/Box",["goo/renderer/MeshData","goo/util/Enum"],function(t,e){"use strict";function o(e,r,i,n,a,s){if(1===arguments.length&&arguments[0]instanceof Object){var l=arguments[0];e=l.width,r=l.height,i=l.length,n=l.tileX,a=l.tileY,s=l.textureMode}this.xExtent=void 0!==e?.5*e:.5,this.yExtent=void 0!==r?.5*r:.5,this.zExtent=void 0!==i?.5*i:.5,this.tileX=n||1,this.tileY=a||1,"string"==typeof s&&(s=o.TextureModes[s]),this.textureMode=void 0!==s?s:o.TextureModes.Uniform;var h=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,h,24,36),this.rebuild()}return o.prototype=Object.create(t.prototype),o.prototype.rebuild=function(){function e(t){for(var e=0;e<t.length;e++){var o=3*t[e];d.push(h[o]),d.push(h[o+1]),d.push(h[o+2])}}function r(){for(var t=0;t<c.length/3;t++)for(var e=0;4>e;e++){var o=3*t;u.push(c[o]),u.push(c[o+1]),u.push(c[o+2])}}var i=this.xExtent,n=this.yExtent,a=this.zExtent,s=this.tileX,l=this.tileY,h=[-i,-n,-a,i,-n,-a,i,n,-a,-i,n,-a,i,-n,a,-i,-n,a,i,n,a,-i,n,a],d=[];e([0,1,2,3,1,4,6,2,4,5,7,6,5,0,3,7,2,6,7,3,0,5,4,1]),this.getAttributeBuffer(t.POSITION).set(d);var c=[0,0,-1,1,0,0,0,0,1,-1,0,0,0,1,0,0,-1,0],u=[];r(),this.getAttributeBuffer(t.NORMAL).set(u);var p=[];if(this.textureMode===o.TextureModes.Uniform)for(var m=0;6>m;m++)p.push(s),p.push(0),p.push(0),p.push(0),p.push(0),p.push(l),p.push(s),p.push(l);else p.push(1,1/3,.75,1/3,.75,2/3,1,2/3),p.push(.75,1/3,.5,1/3,.5,2/3,.75,2/3),p.push(.5,1/3,.25,1/3,.25,2/3,.5,2/3),p.push(.25,1/3,0,1/3,0,2/3,.25,2/3),p.push(.5,1,.5,2/3,.25,2/3,.25,1),p.push(.25,0,.25,1/3,.5,1/3,.5,0);return this.getAttributeBuffer(t.TEXCOORD0).set(p),this.getIndexBuffer().set([2,1,0,3,2,0,6,5,4,7,6,4,10,9,8,11,10,8,14,13,12,15,14,12,18,17,16,19,18,16,22,21,20,23,22,20]),this},o.TextureModes=new e("Uniform","Unfolded"),o}),define("goo/shapes/Quad",["goo/renderer/MeshData"],function(t){"use strict";function e(e,o,r,i){if(1===arguments.length&&arguments[0]instanceof Object){var n=arguments[0];e=n.width,o=n.height,r=n.tileX,i=n.tileY}this.xExtent=void 0!==e?.5*e:.5,this.yExtent=void 0!==o?.5*o:.5,this.tileX=r||1,this.tileY=i||1;var a=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,a,4,6),this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){var e=this.xExtent,o=this.yExtent,r=this.tileX,i=this.tileY;return this.getAttributeBuffer(t.POSITION).set([-e,-o,0,-e,o,0,e,o,0,e,-o,0]),this.getAttributeBuffer(t.NORMAL).set([0,0,1,0,0,1,0,0,1,0,0,1]),this.getAttributeBuffer(t.TEXCOORD0).set([0,0,0,i,r,i,r,0]),this.getIndexBuffer().set([0,3,1,1,3,2]),this},e}),define("goo/shapes/Sphere",["goo/renderer/MeshData","goo/util/Enum","goo/math/Vector3","goo/math/MathUtils"],function(t,e,o,r){"use strict";function i(e,o,r,n){if(1===arguments.length&&arguments[0]instanceof Object){var a=arguments[0];e=a.zSamples,o=a.radialSamples,r=a.radius,n=a.textureMode}this.zSamples=(void 0!==e?e:8)+1,this.radialSamples=void 0!==o?o:8,this.radius=void 0!==r?r:.5,"string"==typeof n&&(n=i.TextureModes[n]),this.textureMode=void 0!==n?n:i.TextureModes.Polar,this.viewInside=!1;var s=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]),l=this.textureMode===i.TextureModes.Chromeball?this.zSamples+1:this.zSamples;this._useSharedPoleVertices=this.textureMode!==i.TextureModes.Projected&&this.textureMode!==i.TextureModes.Linear;var h=this._useSharedPoleVertices?2:0,d=(l-h)*(this.radialSamples+1)+h,c=6*(l-2)*this.radialSamples;t.call(this,s,d,c),this.rebuild()}function n(t,e,o){t[3*o+0]=t[3*e+0],t[3*o+1]=t[3*e+1],t[3*o+2]=t[3*e+2]}return i.prototype=Object.create(t.prototype),i.prototype.rebuild=function(){for(var e=this.getAttributeBuffer(t.POSITION),a=this.getAttributeBuffer(t.NORMAL),s=this.getAttributeBuffer(t.TEXCOORD0),l=this.getIndexBuffer(),h=1/this.radialSamples,d=2/(this.zSamples-1),c=[],u=[],p=0;p<this.radialSamples;p++){var m=r.TWO_PI*h*p;u[p]=Math.cos(m),c[p]=Math.sin(m)}c[this.radialSamples]=c[0],u[this.radialSamples]=u[0];var f=0,g=this.zSamples;this._useSharedPoleVertices&&(f=1,g=this.zSamples-1);for(var v=0,y=new o,x=new o,w=new o,_=f;g>_;_++){var b=r.HALF_PI*(-1+d*_),S=Math.sin(b),M=this.radius*S,C=x.set(0,0,0);C.z+=M;for(var P,T=Math.sqrt(Math.abs(this.radius*this.radius-M*M)),E=v,p=0;p<this.radialSamples;p++){var D=p*h,A=w.set(u[p],c[p],0);o.mul(A,T,y),e[3*v+0]=C.x+y.x,e[3*v+1]=C.y+y.y,e[3*v+2]=C.z+y.z,P=y.set(e[3*v+0],e[3*v+1],e[3*v+2]),P.normalize(),this.viewInside?(a[3*v+0]=-P.x,a[3*v+1]=-P.y,a[3*v+2]=-P.z):(a[3*v+0]=P.x,a[3*v+1]=P.y,a[3*v+2]=P.z);var R=0;if(this._useSharedPoleVertices||_!==f&&_!==g-1||(R=.5*h),this.textureMode===i.TextureModes.Linear)s[2*v+0]=D+R,s[2*v+1]=.5*(S+1);else if(this.textureMode===i.TextureModes.Projected)s[2*v+0]=D+R,s[2*v+1]=(r.HALF_PI+Math.asin(S))/Math.PI;else if(this.textureMode===i.TextureModes.Polar){var I=(r.HALF_PI-Math.abs(b))/Math.PI,O=I*u[p]+.5,L=I*c[p]+.5;s[2*v+0]=O,s[2*v+1]=L}else if(this.textureMode===i.TextureModes.Chromeball){var I=Math.sin((r.HALF_PI+b)/2);I/=2;var O=I*u[p]+.5,L=I*c[p]+.5;s[2*v+0]=O,s[2*v+1]=L}v++}if(n(e,E,v),n(a,E,v),this.textureMode===i.TextureModes.Linear)s[2*v+0]=1,s[2*v+1]=.5*(S+1);
else if(this.textureMode===i.TextureModes.Projected)s[2*v+0]=1,s[2*v+1]=(r.HALF_PI+Math.asin(S))/Math.PI;else if(this.textureMode===i.TextureModes.Polar){var I=(r.HALF_PI-Math.abs(b))/Math.PI;s[2*v+0]=I+.5,s[2*v+1]=.5}else if(this.textureMode===i.TextureModes.Chromeball){var I=Math.sin((r.HALF_PI+b)/2);I/=2,s[2*v+0]=I+.5,s[2*v+1]=.5}v++}if(this.textureMode===i.TextureModes.Chromeball){for(var N=r.HALF_PI-.001,F=this.radius*Math.sin(N),B=Math.sqrt(Math.abs(this.radius*this.radius-F*F)),E=v,p=0;p<this.radialSamples;p++){e[3*v+0]=B*u[p],e[3*v+1]=B*c[p],e[3*v+2]=F;var P=y.set(e[3*v+0],e[3*v+1],e[3*v+2]);P.normalize(),this.viewInside?(a[3*v+0]=-P.x,a[3*v+1]=-P.y,a[3*v+2]=-P.z):(a[3*v+0]=P.x,a[3*v+1]=P.y,a[3*v+2]=P.z);var I=Math.sin((r.HALF_PI+N)/2);I/=2;var O=I*u[p]+.5,L=I*c[p]+.5;s[2*v+0]=O,s[2*v+1]=L,v++}n(e,E,v),n(a,E,v);var I=Math.sin((r.HALF_PI+N)/2);I/=2,s[2*v+0]=I+.5,s[2*v+1]=.5,v++}this._useSharedPoleVertices&&(e[3*v+0]=0,e[3*v+1]=0,e[3*v+2]=-this.radius,this.viewInside?(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=1):(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=-1),this.textureMode===i.TextureModes.Polar||this.textureMode===i.TextureModes.Chromeball?(s[2*v+0]=.5,s[2*v+1]=.5):(s[2*v+0]=.5,s[2*v+1]=0),v++,e[3*v+0]=0,e[3*v+1]=0,e[3*v+2]=this.radius,this.viewInside?(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=-1):(a[3*v+0]=0,a[3*v+1]=0,a[3*v+2]=1),this.textureMode===i.TextureModes.Polar?(s[2*v+0]=.5,s[2*v+1]=.5):this.textureMode===i.TextureModes.Chromeball?(s[2*v+0]=1,s[2*v+1]=-.5):(s[2*v+0]=.5,s[2*v+1]=1));var k=0,z=this.textureMode===i.TextureModes.Chromeball?this.zSamples+1:this.zSamples,U=0;this._useSharedPoleVertices||(U=this.radialSamples+1);for(var _=0;z-3>_;_++){var V=U,j=V+1;U+=this.radialSamples+1;for(var X=U,H=X+1,v=0;v<this.radialSamples;v++)this.viewInside?(l[k++]=V++,l[k++]=X,l[k++]=j,l[k++]=j++,l[k++]=X++,l[k++]=H++):(l[k++]=V++,l[k++]=j,l[k++]=X,l[k++]=j++,l[k++]=H++,l[k++]=X++)}for(var v=0;v<this.radialSamples;v++){var V,j,X;this._useSharedPoleVertices?(V=v,j=this.vertexCount-2,X=v+1):(V=v,j=v+this.radialSamples+2,X=v+this.radialSamples+1),this.viewInside?(l[k++]=V,l[k++]=X,l[k++]=j):(l[k++]=V,l[k++]=j,l[k++]=X)}for(var W=(g-f-1)*(this.radialSamples+1),v=0;v<this.radialSamples;v++){var V,j,X;this._useSharedPoleVertices?(V=v+W,j=v+1+W,X=this.vertexCount-1):(V=v+W-this.radialSamples-1,j=v+W-this.radialSamples,X=v+W),this.viewInside?(l[k++]=V,l[k++]=X,l[k++]=j):(l[k++]=V,l[k++]=j,l[k++]=X)}return this},i.TextureModes=new e("Linear","Projected","Polar","Chromeball"),i}),define("goo/shapes/Cylinder",["goo/renderer/MeshData"],function(t){"use strict";function e(e,o){if(1===arguments.length&&arguments[0]instanceof Object){var r=arguments[0];e=r.radialSamples,o=r.radius}this.radialSamples=e||8,this.radius=o||1;var i=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,i,4*this.radialSamples+2+2,3*this.radialSamples*4),this.indexModes=["Triangles"],this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){for(var e=[],o=[],r=[],i=[],n=2*Math.PI/this.radialSamples,a=1/this.radialSamples,s=4*this.radialSamples+2+2-1,l=0,h=0,d=0;l<this.radialSamples;l++,h+=n,d+=a){var c=Math.cos(h),u=Math.sin(h),p=c*this.radius,m=u*this.radius;e.push(p,m,.5,p,m,-.5,p,m,.5,p,m,-.5),o.push(0,0,1,0,0,-1,c,u,0,c,u,0),r.push(c/4+.25,u/4+.75,c/4+.25,u/4+.25,.5,d,1,d)}e.push(this.radius,0,.5,this.radius,0,-.5),o.push(1,0,0,1,0,0),r.push(.5,1,1,1);for(var l=0;l<this.radialSamples-1;l++)i.push(s,4*l+0,4*l+4,4*l+1,s-1,4*l+5,4*l+4+2,4*l+2,4*l+4+3,4*l+2,4*l+3,4*l+4+3);return i.push(s,4*l+0,0,4*l+1,s-1,1,4*l+4,4*l+2,4*l+5,4*l+2,4*l+3,4*l+5),e.push(0,0,-.5,0,0,.5),o.push(0,0,-.5,0,0,.5),r.push(.25,.25,.25,.75),this.getAttributeBuffer(t.POSITION).set(e),this.getAttributeBuffer(t.NORMAL).set(o),this.getAttributeBuffer(t.TEXCOORD0).set(r),this.getIndexBuffer().set(i),this},e}),define("goo/shapes/Torus",["goo/renderer/MeshData","goo/math/Vector3","goo/math/MathUtils"],function(t,e,o){"use strict";function r(e,o,r,i){if(1===arguments.length&&arguments[0]instanceof Object){var n=arguments[0];e=n.circleSamples,o=n.radialSamples,r=n.tubeRadius,i=n.centerRadius}this._circleSamples=void 0!==e?e:8,this._radialSamples=void 0!==o?o:8,this._tubeRadius=void 0!==r?r:1,this._centerRadius=void 0!==i?i:2,this.viewInside=!1;var a=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]),s=(this._circleSamples+1)*(this._radialSamples+1),l=6*this._circleSamples*this._radialSamples;t.call(this,a,s,l),this.rebuild()}function i(t,e,o){t[3*o+0]=t[3*e+0],t[3*o+1]=t[3*e+1],t[3*o+2]=t[3*e+2]}function n(t,e,o){t[2*o+0]=t[2*e+0],t[2*o+1]=t[2*e+1]}return r.prototype=Object.create(t.prototype),r.prototype.rebuild=function(){for(var r=this.getAttributeBuffer(t.POSITION),a=this.getAttributeBuffer(t.NORMAL),s=this.getAttributeBuffer(t.TEXCOORD0),l=this.getIndexBuffer(),h=1/this._circleSamples,d=1/this._radialSamples,c=0,u=new e,p=new e,m=new e,f=0;f<this._circleSamples;f++){var g=f*h,v=o.TWO_PI*g,y=Math.cos(v),x=Math.sin(v);u.set(y,x,0),e.mul(u,this._centerRadius,p);for(var w=c,_=0;_<this._radialSamples;_++){var b=_*d,S=o.TWO_PI*b,M=Math.cos(S),C=Math.sin(S);m.copy(u).mul(M),m.z=m.z+C,m.normalize(),this.viewInside?(a[3*c+0]=-m.x,a[3*c+1]=-m.y,a[3*c+2]=-m.z):(a[3*c+0]=m.x,a[3*c+1]=m.y,a[3*c+2]=m.z),m.mul(this._tubeRadius).add(p),r[3*c+0]=m.x,r[3*c+1]=m.y,r[3*c+2]=m.z,s[2*c+0]=b,s[2*c+1]=g,c++}i(r,w,c),i(a,w,c),s[2*c+0]=1,s[2*c+1]=g,c++}for(var P=0;P<=this._radialSamples;P++,c++)i(r,P,c),i(a,P,c),n(s,P,c),s[2*c+1]=1;for(var T=0,E=0,f=0;f<this._circleSamples;f++){var D=E,A=D+1;E+=this._radialSamples+1;var R=E,I=R+1;for(c=0;c<this._radialSamples;c++)this.viewInside?(l[T++]=D++,l[T++]=A,l[T++]=R,l[T++]=A++,l[T++]=I++,l[T++]=R++):(l[T++]=D++,l[T++]=R,l[T++]=A,l[T++]=A++,l[T++]=R++,l[T++]=I++)}return this},r}),define("goo/shapes/ShapeCreator",["goo/shapes/Box","goo/shapes/Quad","goo/shapes/Sphere","goo/shapes/Cylinder","goo/shapes/Torus"],function(t,e,o,r,i){"use strict";function n(){}return n.createQuad=function(t,o,r,i){return new e(t,o,r,i)},n.createBox=function(e,o,r,i,n){return new t(e,o,r,i,n)},n.createSphere=function(t,e,r,i){return new o(t,e,r,i)},n.createCylinder=function(t,e,o){return new r(t,e,o)},n.createTorus=function(t,e,o,r){return new i(t,e,o,r)},n}),define("goo/renderer/pass/FullscreenUtil",["goo/shapes/ShapeCreator","goo/renderer/Camera","goo/math/Vector3"],function(t,e,o){"use strict";function r(){}var i=new e;return i.projectionMode=e.Parallel,i.setFrustum(0,1,-1,1,1,-1),i._left.copy(o.UNIT_X).invert(),i._up.copy(o.UNIT_Y),i._direction.copy(o.UNIT_Z),i.onFrameChange(),r.camera=i,r.quad=t.createQuad(2,2),r}),define("goo/renderer/pass/FullscreenPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/shaders/ShaderLib"],function(t,e,o){"use strict";function r(r){this.material=t.createMaterial(r||o.simple),this.useReadBuffer=!0,this.renderToScreen=!1,this.renderable={meshData:e.quad,materials:[this.material]},this.enabled=!0,this.clear=!1,this.needsSwap=!0}return r.prototype.render=function(t,o,r){this.useReadBuffer&&this.material.setTexture("DIFFUSE_MAP",r),this.renderToScreen?t.render(this.renderable,e.camera,[],null,this.clear):t.render(this.renderable,e.camera,[],o,this.clear)},r}),define("goo/renderer/shadow/ShadowHandler",["goo/math/Vector3","goo/renderer/pass/FullscreenPass","goo/renderer/Camera","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/pass/RenderTarget","goo/math/Vector4","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(){this.depthMaterial=r.createMaterial(i.lightDepth,"depthMaterial"),this.depthMaterial.cullState.cullFace="Back",this.fullscreenPass=new e,this.downsample=r.createShader(i.downsample,"downsample");var o=2;this.blurfilter=r.createShader(i.convolution,"blurfilter");var n=2*Math.ceil(3*o)+1;this.blurfilter.defines={KERNEL_SIZE_FLOAT:n.toFixed(1),KERNEL_SIZE_INT:n.toFixed(0)},this.blurfilter.uniforms.cKernel=i.convolution.buildKernel(o),this.oldClearColor=new a(0,0,0,0),this.shadowClearColor=new a(1,1,1,1),this.renderList=[],this.shadowList=[],this.tmpVec=new t,this.first=!0}return d.prototype._createShadowData=function(t){var e=t.resolution[0],o=t.resolution[1];t.shadowData=t.shadowData||{},t.shadowData.shadowTarget=new n(e,o,{type:"Float",magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps"}),t.shadowData.shadowResult=null,"VSM"===t.shadowType&&(t.shadowData.shadowTargetDown=new n(e/2,o/2,{type:"Float"}),t.shadowData.shadowBlurred=new n(e/2,o/2,{type:"Float"})),t.shadowRecord=t.shadowRecord||{},t.shadowRecord.resolution=t.shadowRecord.resolution||[],t.shadowRecord.resolution[0]=e,t.shadowRecord.resolution[0]=e,t.shadowRecord.shadowType=t.shadowType},d.prototype._testStatesEqual=function(t,e){var o=Object.keys(t),r=Object.keys(e);if(o.length!==r.length)return!1;for(var i=0;i<o.length;i++){var n=o[i];if(t[n]!==e[n])return!1}return!0},d.prototype.checkShadowRendering=function(e,r,i,n){if(this.first===!0)return void(this.first=!1);this.shadowResults=[],this.shadowLights=[];for(var a=0;a<n.length;a++){var l=n[a];if(l.shadowCaster||l.lightCookie){var d=l.shadowSettings;d.shadowData||(this._createShadowData(d),d.shadowData.lightCamera=new o(55,1,1,1e3));var c=d.shadowRecord,u=d.shadowData.lightCamera;if(u.translation.copy(l.translation),l.direction?(this.tmpVec.setv(l.translation).addv(l.direction),u.lookAt(this.tmpVec,d.upVector)):u.lookAt(t.ZERO,d.upVector),c.angle!==l.angle||!c.resolution||c.resolution[0]!==d.resolution[0]||c.resolution[1]!==d.resolution[1]||c.near!==d.near||c.far!==d.far||c.size!==d.size){if(c.resolution&&c.resolution[0]===d.resolution[0]&&c.resolution[1]===d.resolution[1]||this._createShadowData(d),l instanceof h)u.setFrustumPerspective(l.angle,d.resolution[0]/d.resolution[1],d.near,d.far);else if(l instanceof s)u.setFrustumPerspective(90,d.resolution[0]/d.resolution[1],d.near,d.far);else{var p=d.size;u.setFrustum(d.near,d.far,-p,p,p,-p),u.projectionMode=o.Parallel}u.update(),c.resolution=c.resolution||[],c.resolution[0]=d.resolution[0],c.resolution[1]=d.resolution[1],c.angle=l.angle,c.near=d.near,c.far=d.far,c.size=d.size}if("VSM"===d.shadowType&&c.shadowType!==d.shadowType&&(this._createShadowData(d),c.shadowType=d.shadowType),u.onFrameChange(),l.shadowCaster){this.depthMaterial.shader.defines.SHADOW_TYPE="VSM"===d.shadowType?2:0,this.depthMaterial.uniforms.cameraScale=1/(u.far-u.near),this.oldClearColor.copy(e.clearColor),e.setClearColor(this.shadowClearColor.r,this.shadowClearColor.g,this.shadowClearColor.b,this.shadowClearColor.a),this.shadowList.length=0;for(var m=0;m<i.length;m++){var f=i[m];f.meshRendererComponent&&f.meshRendererComponent.castShadows&&!f.isSkybox&&this.shadowList.push(f)}switch(r.process(u,this.shadowList,this.renderList),e.render(this.renderList,u,[],d.shadowData.shadowTarget,!0,this.depthMaterial),d.shadowType){case"VSM":this.fullscreenPass.material.shader=this.downsample,this.fullscreenPass.render(e,d.shadowData.shadowTargetDown,d.shadowData.shadowTarget,0),this.fullscreenPass.material.shader=this.blurfilter,this.fullscreenPass.material.uniforms.uImageIncrement=[2/d.resolution[0],0],this.fullscreenPass.render(e,d.shadowData.shadowBlurred,d.shadowData.shadowTargetDown,0),this.fullscreenPass.material.uniforms.uImageIncrement=[0,2/d.resolution[1]],this.fullscreenPass.render(e,d.shadowData.shadowTargetDown,d.shadowData.shadowBlurred,0),d.shadowData.shadowResult=d.shadowData.shadowTargetDown;break;case"PCF":d.shadowData.shadowResult=d.shadowData.shadowTarget;break;case"Basic":d.shadowData.shadowResult=d.shadowData.shadowTarget;break;default:d.shadowData.shadowResult=d.shadowData.shadowTarget}e.setClearColor(this.oldClearColor.r,this.oldClearColor.g,this.oldClearColor.b,this.oldClearColor.a)}}}},d}),define("goo/renderer/Renderer",["goo/renderer/RendererRecord","goo/renderer/Util","goo/renderer/TextureCreator","goo/renderer/pass/RenderTarget","goo/math/Vector4","goo/entities/Entity","goo/renderer/Texture","goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils","goo/renderer/Material","goo/math/Transform","goo/renderer/RenderQueue","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/entities/SystemBus"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m){"use strict";function f(e){e=e||{};var o=e.canvas;void 0===o&&(o=document.createElement("canvas"),o.width=500,o.height=500),o.screencanvas=!0,this.domElement=o,this._alpha=void 0!==e.alpha?e.alpha:!1,this._premultipliedAlpha=void 0!==e.premultipliedAlpha?e.premultipliedAlpha:!0,this._antialias=void 0!==e.antialias?e.antialias:!0,this._stencil=void 0!==e.stencil?e.stencil:!1,this._preserveDrawingBuffer=void 0!==e.preserveDrawingBuffer?e.preserveDrawingBuffer:!1,this._useDevicePixelRatio=void 0!==e.useDevicePixelRatio?e.useDevicePixelRatio:!1,this._onError=e.onError;var r={alpha:this._alpha,premultipliedAlpha:this._premultipliedAlpha,antialias:this._antialias,stencil:this._stencil,preserveDrawingBuffer:this._preserveDrawingBuffer};if(this.context=null,!window.WebGLRenderingContext)throw{name:"GooWebGLError",message:"WebGL is not supported",supported:!1,enabled:!1};for(var n=["experimental-webgl","webgl","moz-webgl","webkit-3d"],a=0;a<n.length;a++)try{if(this.context=o.getContext(n[a],r),this.context&&"function"==typeof this.context.getParameter)break}catch(d){}if(!this.context)throw{name:"GooWebGLError",message:"WebGL is supported but disabled",supported:!0,enabled:!1};if(e.debug){var u=new XMLHttpRequest;u.open("GET","/js/goo/lib/webgl-debug.js",!1),u.onreadystatechange=function(){4===u.readyState&&u.status>=200&&u.status<=299&&window.eval.call(window,u.responseText)},u.send(null),"undefined"==typeof window.WebGLDebugUtils?console.warn("You need to include webgl-debug.js in your script definition to run in debug mode."):(console.log("Running in webgl debug mode."),e.validate?(console.log('Running with "undefined arguments" validation.'),this.context=window.WebGLDebugUtils.makeDebugContext(this.context,this.onDebugError.bind(this),g)):this.context=window.WebGLDebugUtils.makeDebugContext(this.context,this.onDebugError.bind(this)))}this.rendererRecord=new t,this.glExtensionCompressedTextureS3TC=s.SUPPORTS_DDS=l.isSupported(this.context),this.glExtensionTextureFloat=this.context.getExtension("OES_texture_float"),this.glExtensionTextureFloatLinear=this.context.getExtension("OES_texture_float_linear"),this.glExtensionTextureHalfFloat=this.context.getExtension("OES_texture_half_float"),this.glExtensionStandardDerivatives=this.context.getExtension("OES_standard_derivatives"),this.glExtensionTextureFilterAnisotropic=this.context.getExtension("EXT_texture_filter_anisotropic")||this.context.getExtension("MOZ_EXT_texture_filter_anisotropic")||this.context.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.glExtensionDepthTexture=this.context.getExtension("WEBGL_depth_texture")||this.context.getExtension("WEBKIT_WEBGL_depth_texture")||this.context.getExtension("MOZ_WEBGL_depth_texture"),this.glExtensionElementIndexUInt=this.context.getExtension("OES_element_index_uint"),this.glExtensionTextureFloat||console.log("Float textures not supported."),this.glExtensionTextureFloatLinear||console.log("Float textures with linear filtering not supported."),this.glExtensionStandardDerivatives||console.log("Standard derivatives not supported."),this.glExtensionTextureFilterAnisotropic||console.log("Anisotropic texture filtering not supported."),this.glExtensionCompressedTextureS3TC||console.log("S3TC compressed textures not supported."),this.glExtensionDepthTexture||console.log("Depth textures not supported."),this.glExtensionElementIndexUInt||console.log("32 bit indices not supported."),void 0===this.context.getShaderPrecisionFormat&&(this.context.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),this.capabilities={maxTexureSize:this.context.getParameter(v.MAX_TEXTURE_SIZE),maxCubemapSize:this.context.getParameter(v.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderbufferSize:this.context.getParameter(v.MAX_RENDERBUFFER_SIZE),maxViewPortDims:this.context.getParameter(v.MAX_VIEWPORT_DIMS),maxAnisotropy:this.glExtensionTextureFilterAnisotropic?this.context.getParameter(this.glExtensionTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,maxVertexTextureUnits:this.context.getParameter(v.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxFragmentTextureUnits:this.context.getParameter(v.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTextureUnits:this.context.getParameter(v.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.context.getParameter(v.MAX_VERTEX_ATTRIBS),maxVertexUniformVectors:this.context.getParameter(v.MAX_VERTEX_UNIFORM_VECTORS),maxFragmentUniformVectors:this.context.getParameter(v.MAX_FRAGMENT_UNIFORM_VECTORS),maxVaryingVectors:this.context.getParameter(v.MAX_VARYING_VECTORS),aliasedPointSizeRange:this.context.getParameter(v.ALIASED_POINT_SIZE_RANGE),aliasedLineWidthRange:this.context.getParameter(v.ALIASED_LINE_WIDTH_RANGE),samples:this.context.getParameter(v.SAMPLES),sampleBuffers:this.context.getParameter(v.SAMPLE_BUFFERS),depthBits:this.context.getParameter(v.DEPTH_BITS),stencilBits:this.context.getParameter(v.STENCIL_BITS),subpixelBits:this.context.getParameter(v.SUBPIXEL_BITS),supportedExtensionsList:this.context.getSupportedExtensions(),renderer:this.context.getParameter(v.RENDERER),vendor:this.context.getParameter(v.VENDOR),version:this.context.getParameter(v.VERSION),shadingLanguageVersion:this.context.getParameter(v.SHADING_LANGUAGE_VERSION),vertexShaderHighpFloat:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.HIGH_FLOAT),vertexShaderMediumpFloat:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.MEDIUM_FLOAT),vertexShaderLowpFloat:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.LOW_FLOAT),fragmentShaderHighpFloat:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.HIGH_FLOAT),fragmentShaderMediumpFloat:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.MEDIUM_FLOAT),fragmentShaderLowpFloat:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.LOW_FLOAT),vertexShaderHighpInt:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.HIGH_INT),vertexShaderMediumpInt:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.MEDIUM_INT),vertexShaderLowpInt:this.context.getShaderPrecisionFormat(this.context.VERTEX_SHADER,this.context.LOW_INT),fragmentShaderHighpInt:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.HIGH_INT),fragmentShaderMediumpInt:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.MEDIUM_INT),fragmentShaderLowpInt:this.context.getShaderPrecisionFormat(this.context.FRAGMENT_SHADER,this.context.LOW_INT)},this.maxTextureSize=isNaN(e.maxTextureSize)?this.capabilities.maxTexureSize:Math.min(e.maxTextureSize,this.capabilities.maxTexureSize),this.maxCubemapSize=isNaN(e.maxTextureSize)?this.capabilities.maxCubemapSize:Math.min(e.maxTextureSize,this.capabilities.maxCubemapSize),this.shaderPrecision=e.shaderPrecision||"highp",this.shaderPrecision="highp"===this.shaderPrecision&&this.capabilities.vertexShaderHighpFloat.precision>0&&this.capabilities.fragmentShaderHighpFloat.precision>0?"highp":"lowp"!==this.shaderPrecision&&this.capabilities.vertexShaderMediumpFloat.precision>0&&this.capabilities.fragmentShaderMediumpFloat.precision>0?"mediump":"lowp",this.downScale=e.downScale||1,this.clearColor=new i,this._clearColor=new Float64Array(4),this.setClearColor(.3,.3,.3,1),this.context.clearDepth(1),this.context.clearStencil(0),this.context.stencilMask(0),this.context.enable(v.DEPTH_TEST),this.context.depthFunc(v.LEQUAL),this.viewportX=0,this.viewportY=0,this.viewportWidth=0,this.viewportHeight=0,this.currentWidth=0,this.currentHeight=0,this._overrideMaterials=[],this._mergedMaterial=new h("Merged Material"),this.renderQueue=new c,this.info={calls:0,vertices:0,indices:0,reset:function(){this.calls=0,this.vertices=0,this.indices=0},toString:function(){return"Calls: "+this.calls+" Vertices: "+this.vertices+" Indices: "+this.indices}},this.shadowHandler=new p,this.hardwarePicking=null,m.addListener("goo.setClearColor",function(t){this.setClearColor.apply(this,t)}.bind(this)),document.createElementNS?(this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("xmlns","http://www.w3.org/2000/svg"),this.svg.setAttribute("version","1.1"),this.svg.style.position="absolute",this.svg.style.display="none",document.body.appendChild(this.svg)):this.svg={currentScale:1}}function g(t,e){for(var o=0;o<e.length;++o)void 0===e[o]&&console.error("undefined passed to gl."+t+"("+window.WebGLDebugUtils.glFunctionArgsToString(t,e)+")")}var v=window.WebGLRenderingContext;return f.prototype.onDebugError=function(t,e,o){for(var r="WebGL error "+window.WebGLDebugUtils.glEnumToString(t)+" in "+e+"(",i=0;i<o.length;++i)r+=(0===i?"":", ")+window.WebGLDebugUtils.glFunctionArgToString(e,i,o[i]);r+=")",console.error(r),this._onError&&this._onError(r)},f.mainCamera=null,m.addListener("goo.setCurrentCamera",function(t){f.mainCamera=t.camera}),f.prototype.checkResize=function(t){var e,o,r=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1;document.querySelector?(e=this.domElement.offsetWidth,o=this.domElement.offsetHeight):(e=window.innerWidth,o=window.innerHeight),e=e*r/this.downScale,o=o*r/this.downScale;var i=e,n=o;t&&t.lockedRatio===!0&&t.aspect&&(e=o*t.aspect);var a=e/o;this.setSize(e,o,i,n),t&&t.lockedRatio===!1&&t.aspect!==a&&(t.aspect=a,0===t.projectionMode?t.setFrustumPerspective():t.setFrustum(),t.onFrameChange())},f.prototype.setSize=function(t,e,o,r){if(void 0===o&&(o=t),void 0===r&&(r=e),this.domElement.width=o,this.domElement.height=r,t>o){var i=o/t;t=o,e=r*i}var n=.5*(o-t),a=.5*(r-e);(n!==this.viewportX||a!==this.viewportY||t!==this.viewportWidth||e!==this.viewportHeight)&&(this.setViewport(n,a,t,e),null!==this.hardwarePicking&&(this.hardwarePicking.pickingTarget=null))},f.prototype.setViewport=function(t,e,o,r){this.viewportX=void 0!==t?t:0,this.viewportY=void 0!==e?e:0,this.viewportWidth=void 0!==o?o:this.domElement.width,this.viewportHeight=void 0!==r?r:this.domElement.height,this.context.viewport(this.viewportX,this.viewportY,this.viewportWidth,this.viewportHeight),m.emit("goo.viewportResize",{x:this.viewportX,y:this.viewportY,width:this.viewportWidth,height:this.viewportHeight},!0)},f.prototype.setClearColor=function(t,e,o,r){(this._clearColor[0]!==t||this._clearColor[1]!==e||this._clearColor[2]!==o||this._clearColor[3]!==r)&&(this._clearColor[0]=t,this._clearColor[1]=e,this._clearColor[2]=o,this._clearColor[3]=r,this.clearColor.seta(this._clearColor),this.context.clearColor(t,e,o,r))},f.prototype.bindData=function(t){var e=t.glBuffer;null!==e?(this.setBoundBuffer(e,t.target),t._dataNeedsRefresh&&(this.context.bufferSubData(this.getGLBufferTarget(t.target),0,t.data),t._dataNeedsRefresh=!1)):(e=this.context.createBuffer(),t.glBuffer=e,this.rendererRecord.invalidateBuffer(t.target),this.setBoundBuffer(e,t.target),this.context.bufferData(this.getGLBufferTarget(t.target),t.data,this.getGLBufferUsage(t._dataUsage)))},f.prototype.setShadowType=function(t){this.shadowHandler.shadowType=t},f.prototype.updateShadows=function(t,e,o){this.shadowHandler.checkShadowRendering(this,t,e,o)},f.prototype.render=function(t,o,r,i,n,a){if(this._overrideMaterials=a?a instanceof Array?a:[a]:[],o){null===f.mainCamera&&(f.mainCamera=o),this.setRenderTarget(i),void 0===n||null===n||n===!0?this.clear():"object"==typeof n&&this.clear(n.color,n.depth,n.stencil);var s={camera:o,mainCamera:f.mainCamera,lights:r,shadowHandler:this.shadowHandler,renderer:this};if(Array.isArray(t)){this.renderQueue.sort(t,o);for(var l=0;l<t.length;l++){var h=t[l];h.isSkybox&&this._overrideMaterials.length>0||(this.fillRenderInfo(h,s),this.renderMesh(s))}}else this.fillRenderInfo(t,s),this.renderMesh(s);i&&i.generateMipmaps&&e.isPowerOfTwo(i.width)&&e.isPowerOfTwo(i.height)&&this.updateRenderTargetMipmap(i)}},f.prototype.fillRenderInfo=function(t,e){t instanceof n?(e.meshData=t.meshDataComponent.meshData,e.materials=t.meshRendererComponent.materials,e.transform=t.particleComponent?d.IDENTITY:t.transformComponent.worldTransform,e.currentPose=t.meshDataComponent.currentPose?t.meshDataComponent.currentPose:void 0):(e.meshData=t.meshData,e.materials=t.materials,e.transform=t.transform,e.currentPose=t.currentPose?t.currentPose:void 0),e.renderable=t},f.prototype._override=function(t,e,o){o.empty();for(var r=Object.keys(o),i=0,n=r.length;n>i;i++){var a=r[i],s=o[a],l=t[a],h=e[a];if(s instanceof Object&&"shader"!==a){for(var d=Object.keys(l),c=0,u=d.length;u>c;c++){var p=d[c];s[p]=l[p]}for(var d=Object.keys(h),c=0,u=d.length;u>c;c++){var p=d[c];void 0===s[p]&&(s[p]=h[p])}}else o[a]=void 0!==l?l:h}},f.prototype.renderMesh=function(t){var e=t.meshData;if(!(null===e.vertexData||null!==e.vertexData&&0===e.vertexData.data.byteLength||null!==e.indexData&&0===e.indexData.data.byteLength)){this.bindData(e.vertexData);var o=t.materials,r=null,i=e,n=0;n=0===this._overrideMaterials.length?o.length:this._overrideMaterials.length;for(var a=0;n>a;a++){var s=null,l=null;if(a<o.length&&(s=o[a]),a<this._overrideMaterials.length&&(l=this._overrideMaterials[a]),s&&l?(this._override(l,s,this._mergedMaterial),s=this._mergedMaterial):l&&(s=l),s.shader){s.errorOnce=!1,s.wireframe&&"wire"!==r?(e.wireframeData||(e.wireframeData=e.buildWireframeData()),e=e.wireframeData,this.bindData(e.vertexData),r="wire"):s.flat&&"flat"!==r?(e.flatMeshData||(e.flatMeshData=e.buildFlatMeshData()),e=e.flatMeshData,this.bindData(e.vertexData),r="flat"):s.wireframe||s.flat||null===r||(e=i,this.bindData(e.vertexData),r=null),t.material=s,t.meshData=e;var h=s.shader;if(h.processors||h.defines){if(h.processors)for(var d=0;d<h.processors.length;d++)h.processors[d](h,t);for(var c=Object.keys(h.defines),u=c.length,p=[],d=0;u>d;d++){var m=c[d];p.push(m+"_"+h.defines[m])}p.sort();var f=p.join("_")+"_"+h.name,g=this.rendererRecord.shaderCache=this.rendererRecord.shaderCache||{};if(g[f]){if(h=g[f],h!==s.shader){for(var v=s.shader.uniforms,y=Object.keys(v),x=0,w=y.length;w>x;x++){var m=y[x];h.uniforms[m]=v[m]}s.shader=h}}else h.builder&&h.builder(h,t),h=s.shader=h.clone(),g[f]=h}h.apply(t,this),this.updateDepthTest(s),this.updateCulling(s),this.updateBlending(s),this.updateOffset(s),this.updateTextures(s),this.updateLineAndPointSettings(s),this._checkDualTransparency(s,e),this.updateCulling(s),this._drawBuffers(e),this.info.calls++,this.info.vertices+=e.vertexCount,this.info.indices+=e.indexCount}else s.errorOnce||(console.warn("No shader set on material: "+s.name),s.errorOnce=!0)}}},f.prototype._drawBuffers=function(t){null!==t.getIndexBuffer()?(this.bindData(t.getIndexData()),null!==t.getIndexLengths()?this.drawElementsVBO(t.getIndexBuffer(),t.getIndexModes(),t.getIndexLengths()):this.drawElementsVBO(t.getIndexBuffer(),t.getIndexModes(),[t.getIndexBuffer().length])):null!==t.getIndexLengths()?this.drawArraysVBO(t.getIndexModes(),t.getIndexLengths()):this.drawArraysVBO(t.getIndexModes(),[t.vertexCount])},f.prototype._checkDualTransparency=function(t,e){if(t.dualTransparency){var o=t.cullState.cullFace,r="Front"===o?"Back":"Front";t.cullState.cullFace=r,this.updateCulling(t),this._drawBuffers(e),t.cullState.cullFace=o}},f.prototype.readPixels=function(t,e,o,r,i){this.context.readPixels(t,e,o,r,v.RGBA,v.UNSIGNED_BYTE,i)},f.prototype.drawElementsVBO=function(t,e,o){for(var r=0,i=0,n=t.type=t.type||this.getGLArrayType(t),a=this.getGLByteSize(t),s=0;s<o.length;s++){var l=o[s],h=this.getGLIndexMode(e[i]);this.context.drawElements(h,l,n,r*a),r+=l,i<e.length-1&&i++}},f.prototype.drawArraysVBO=function(t,e){for(var o=0,r=0,i=0;i<e.length;i++){var n=e[i],a=this.getGLIndexMode(t[r]);this.context.drawArrays(a,o,n),o+=n,r<t.length-1&&r++}},f.prototype.renderToPick=function(t,e,o,n,a,s,l,d,c){if(this.viewportWidth*this.viewportHeight!==0){var p=4;if(null===this.hardwarePicking){var m=h.createEmptyMaterial(u.pickingShader,"pickingMaterial");m.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},m.wireframe=!1,this.hardwarePicking={pickingTarget:new r(this.viewportWidth/p,this.viewportHeight/p,{minFilter:"NearestNeighborNoMipMaps",magFilter:"NearestNeighbor"}),pickingMaterial:m,pickingBuffer:new Uint8Array(4),clearColorStore:new i},n=!1}else null===this.hardwarePicking.pickingTarget&&(this.hardwarePicking.pickingTarget=new r(this.viewportWidth/p,this.viewportHeight/p,{minFilter:"NearestNeighborNoMipMaps",magFilter:"NearestNeighbor"}),n=!1);if(n)this.setRenderTarget(this.hardwarePicking.pickingTarget);else{if(this.hardwarePicking.clearColorStore.setv(this.clearColor),a&&void 0!==s&&void 0!==l){var f=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,g=Math.floor((s*f-this.viewportX)/p),y=Math.floor((this.viewportHeight-(l*f-this.viewportY))/p);this.context.enable(v.SCISSOR_TEST),this.context.scissor(g,y,1,1)}for(var x=[],w=0,_=t.length;_>w;w++){var b=t[w];(!b.meshRendererComponent||b.meshRendererComponent.isPickable)&&x.push(b)}c?this.render(x,e,[],this.hardwarePicking.pickingTarget,o):this.render(x,e,[],this.hardwarePicking.pickingTarget,o,d||this.hardwarePicking.pickingMaterial),a&&this.context.disable(v.SCISSOR_TEST)}}},f.prototype.pick=function(t,e,o,r){if(this.viewportWidth*this.viewportHeight===0)return o.id=-1,void(o.depth=0);var i=this._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/this.svg.currentScale:1,n=4,a=Math.floor((t*i-this.viewportX)/n),s=Math.floor((this.viewportHeight-(e*i-this.viewportY))/n);this.readPixels(a,s,1,1,this.hardwarePicking.pickingBuffer);var l=255*this.hardwarePicking.pickingBuffer[0]+this.hardwarePicking.pickingBuffer[1]-1,h=(this.hardwarePicking.pickingBuffer[2]/255+this.hardwarePicking.pickingBuffer[3]/65025)*r.far;o.id=l,o.depth=h},f.prototype.updateLineAndPointSettings=function(t){var e=this.rendererRecord.lineRecord,o=t.lineWidth||1;e.lineWidth!==o&&(this.context.lineWidth(o),e.lineWidth=o)},f.prototype.updateDepthTest=function(t){var e=this.rendererRecord.depthRecord,o=t.depthState;e.enabled!==o.enabled&&(o.enabled?this.context.enable(v.DEPTH_TEST):this.context.disable(v.DEPTH_TEST),e.enabled=o.enabled),e.write!==o.write&&(this.context.depthMask(o.write?!0:!1),e.write=o.write)},f.prototype.updateCulling=function(t){var e=this.rendererRecord.cullRecord,o=t.cullState.cullFace,r=t.cullState.frontFace,i=t.cullState.enabled;if(e.enabled!==i&&(i?this.context.enable(v.CULL_FACE):this.context.disable(v.CULL_FACE),e.enabled=i),e.cullFace!==o){var n="Front"===o?v.FRONT:"Back"===o?v.BACK:v.FRONT_AND_BACK;this.context.cullFace(n),e.cullFace=o}if(e.frontFace!==r){switch(r){case"CCW":this.context.frontFace(v.CCW);break;case"CW":this.context.frontFace(v.CW)}e.frontFace=r}},f.prototype.updateTextures=function(t){for(var i=this.context,n=t.shader.textureSlots,a=0;a<n.length;a++){var s=n[a],l=t.getTexture(s.mapping);if(void 0!==l){var h=l;l instanceof Array==!1&&(h=[l]);for(var d=0;d<h.length;d++){l=h[d];var c=s.index instanceof Array?s.index[d]:s.index;(null===l||l instanceof r==!1&&(void 0===l.image||l.checkDataReady()===!1))&&("sampler2D"===s.format?l=o.DEFAULT_TEXTURE_2D:"samplerCube"===s.format&&(l=o.DEFAULT_TEXTURE_CUBE));var u=this.rendererRecord.textureRecord[c];void 0===u&&(u=this.rendererRecord.textureRecord[c]={}),null===l.glTexture?(l.glTexture=i.createTexture(),this.updateTexture(i,l,c,u)):l instanceof r==!1&&l.checkNeedsUpdate()?(this.updateTexture(i,l,c,u),l.needsUpdate=!1):this.bindTexture(i,l,c,u);var p=void 0!==l.image?l.image:l,m=e.isPowerOfTwo(p.width)&&e.isPowerOfTwo(p.height);this.updateTextureParameters(l,m)}}}},f.prototype.updateTextureParameters=function(t,e){var o=this.context,r=t.textureRecord;
void 0===r&&(r={},t.textureRecord=r);var i=this.getGLType(t.variant);r.magFilter!==t.magFilter&&(o.texParameteri(i,v.TEXTURE_MAG_FILTER,this.getGLMagFilter(t.magFilter)),r.magFilter=t.magFilter);var n=e?t.minFilter:this.getFilterFallback(t.minFilter);r.minFilter!==n&&(o.texParameteri(i,v.TEXTURE_MIN_FILTER,this.getGLMinFilter(n)),r.minFilter=n);var a=e?t.wrapS:"EdgeClamp";if(r.wrapS!==a){var s=this.getGLWrap(a,o);o.texParameteri(i,v.TEXTURE_WRAP_S,s),r.wrapS=a}var l=e?t.wrapT:"EdgeClamp";if(r.wrapT!==l){var h=this.getGLWrap(l,o);o.texParameteri(i,v.TEXTURE_WRAP_T,h),r.wrapT=l}if(this.glExtensionTextureFilterAnisotropic&&"Float"!==t.type){var d=t.anisotropy;r.anisotropy!==d&&(o.texParameterf(i,this.glExtensionTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(d,this.capabilities.maxAnisotropy)),r.anisotropy=d)}},f.prototype.bindTexture=function(t,e,o,r){(void 0===r.boundTexture||void 0!==e.glTexture&&r.boundTexture!==e.glTexture)&&(t.activeTexture(v.TEXTURE0+o),t.bindTexture(this.getGLType(e.variant),e.glTexture),r.boundTexture=e.glTexture)},f.prototype.getGLType=function(t){switch(t){case"2D":return v.TEXTURE_2D;case"CUBE":return v.TEXTURE_CUBE_MAP}throw"invalid texture type: "+t},f.prototype.loadCompressedTexture=function(t,e,o,r){var i=o.image.mipmapSizes,n=0,a=0,s=o.image.width,h=o.image.height,d=l.getDdsExtension(t),c=d.COMPRESSED_RGBA_S3TC_DXT5_EXT;if("PrecompressedDXT1"===o.format)c=d.COMPRESSED_RGB_S3TC_DXT1_EXT;else if("PrecompressedDXT1A"===o.format)c=d.COMPRESSED_RGBA_S3TC_DXT1_EXT;else if("PrecompressedDXT3"===o.format)c=d.COMPRESSED_RGBA_S3TC_DXT3_EXT;else{if("PrecompressedDXT5"!==o.format)throw new Error("Unhandled compression format: "+r.getDataFormat().name());c=d.COMPRESSED_RGBA_S3TC_DXT5_EXT}if("undefined"==typeof i||null===i)r instanceof Uint8Array?t.compressedTexImage2D(e,0,c,s,h,0,r):t.compressedTexImage2D(e,0,c,s,h,0,new Uint8Array(r.buffer,r.byteOffset,r.byteLength));else{if(o.generateMipmaps=!1,r instanceof Array)for(var u=0;u<r.length;u++)t.compressedTexImage2D(e,u,c,s,h,0,r[u]),s=~~(s/2)>1?~~(s/2):1,h=~~(h/2)>1?~~(h/2):1;else for(var u=0;u<i.length;u++)a=i[u],t.compressedTexImage2D(e,u,c,s,h,0,new Uint8Array(r.buffer,r.byteOffset+n,a)),s=~~(s/2)>1?~~(s/2):1,h=~~(h/2)>1?~~(h/2):1,n+=a;var p=1+Math.ceil(Math.log(Math.max(o.image.height,o.image.width))/Math.log(2)),m=i[i.length-1];if(i.length<p)for(var u=i.length;p>u;u++)m=~~((s+3)/4)*~~((h+3)/4)*o.image.bpp*2,t.compressedTexImage2D(e,u,c,s,h,0,new Uint8Array(m)),s=~~(s/2)>1?~~(s/2):1,h=~~(h/2)>1?~~(h/2):1}},f.prototype.updateTexture=function(t,o,r,i){t.activeTexture(v.TEXTURE0+r),t.bindTexture(this.getGLType(o.variant),o.glTexture),i.boundTexture=o.glTexture,t.pixelStorei(v.UNPACK_ALIGNMENT,o.unpackAlignment),t.pixelStorei(v.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),t.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,o.flipY);var n=o.image;if("2D"===o.variant)n?(!n.isCompressed&&(o.generateMipmaps||n.width>this.maxTextureSize||n.height>this.maxTextureSize)&&(this.checkRescale(o,n,n.width,n.height,this.maxTextureSize),n=o.image),n.isData===!0?n.isCompressed?this.loadCompressedTexture(t,v.TEXTURE_2D,o,n.data):t.texImage2D(v.TEXTURE_2D,0,this.getGLInternalFormat(o.format),n.width,n.height,o.hasBorder?1:0,this.getGLInternalFormat(o.format),this.getGLPixelDataType(o.type),n.data):t.texImage2D(v.TEXTURE_2D,0,this.getGLInternalFormat(o.format),this.getGLInternalFormat(o.format),this.getGLPixelDataType(o.type),n),o.generateMipmaps&&!n.isCompressed&&t.generateMipmap(v.TEXTURE_2D)):t.texImage2D(v.TEXTURE_2D,0,this.getGLInternalFormat(o.format),o.width,o.height,0,this.getGLInternalFormat(o.format),this.getGLPixelDataType(o.type),null);else if("CUBE"===o.variant){if(n&&(o.generateMipmaps||n.width>this.maxCubemapSize||n.height>this.maxCubemapSize)){for(var s=0;s<a.CUBE_FACES.length;s++)n.data[s]&&!n.data[s].buffer?e.scaleImage(o,n.data[s],n.width,n.height,this.maxCubemapSize,s):e.getBlankImage(o,[.3,.3,.3,0],n.width,n.height,this.maxCubemapSize,s);o.image.width=Math.min(this.maxCubemapSize,e.nearestPowerOfTwo(o.image.width)),o.image.height=Math.min(this.maxCubemapSize,e.nearestPowerOfTwo(o.image.height)),n=o.image}for(var l=0;l<a.CUBE_FACES.length;l++){var h=a.CUBE_FACES[l];n?n.isData===!0?n.isCompressed?this.loadCompressedTexture(t,this.getGLCubeMapFace(h),o,n.data[l]):t.texImage2D(this.getGLCubeMapFace(h),0,this.getGLInternalFormat(o.format),n.width,n.height,o.hasBorder?1:0,this.getGLInternalFormat(o.format),this.getGLPixelDataType(o.type),n.data[l]):t.texImage2D(this.getGLCubeMapFace(h),0,this.getGLInternalFormat(o.format),this.getGLInternalFormat(o.format),this.getGLPixelDataType(o.type),n.data[l]):t.texImage2D(this.getGLCubeMapFace(h),0,this.getGLInternalFormat(o.format),o.width,o.height,0,this.getGLInternalFormat(o.format),this.getGLPixelDataType(o.type),null)}n&&o.generateMipmaps&&!n.isCompressed&&t.generateMipmap(v.TEXTURE_CUBE_MAP)}},f.prototype.checkRescale=function(t,o,r,i,n,a){e.scaleImage(t,o,r,i,n,a)},f.prototype.getGLWrap=function(t){switch(t){case"Repeat":return v.REPEAT;case"MirroredRepeat":return v.MIRRORED_REPEAT;case"EdgeClamp":return v.CLAMP_TO_EDGE}throw"invalid WrapMode type: "+t},f.prototype.getGLInternalFormat=function(t){switch(t){case"RGBA":return v.RGBA;case"RGB":return v.RGB;case"Alpha":return v.ALPHA;case"Luminance":return v.LUMINANCE;case"LuminanceAlpha":return v.LUMINANCE_ALPHA;default:throw"Unsupported format: "+t}},f.prototype.getGLPixelDataType=function(t){switch(t){case"UnsignedByte":return v.UNSIGNED_BYTE;case"UnsignedShort565":return v.UNSIGNED_SHORT_5_6_5;case"UnsignedShort4444":return v.UNSIGNED_SHORT_4_4_4_4;case"UnsignedShort5551":return v.UNSIGNED_SHORT_5_5_5_1;case"Float":return v.FLOAT;default:throw"Unsupported type: "+t}},f.prototype.getFilterFallback=function(t){switch(t){case"NearestNeighborNoMipMaps":case"NearestNeighborNearestMipMap":case"NearestNeighborLinearMipMap":return"NearestNeighborNoMipMaps";case"BilinearNoMipMaps":case"Trilinear":case"BilinearNearestMipMap":return"BilinearNoMipMaps";default:return"NearestNeighborNoMipMaps"}},f.prototype.getGLMagFilter=function(t){switch(t){case"Bilinear":return v.LINEAR;case"NearestNeighbor":return v.NEAREST}throw"invalid MagnificationFilter type: "+t},f.prototype.getGLMinFilter=function(t){switch(t){case"BilinearNoMipMaps":return v.LINEAR;case"Trilinear":return v.LINEAR_MIPMAP_LINEAR;case"BilinearNearestMipMap":return v.LINEAR_MIPMAP_NEAREST;case"NearestNeighborNoMipMaps":return v.NEAREST;case"NearestNeighborNearestMipMap":return v.NEAREST_MIPMAP_NEAREST;case"NearestNeighborLinearMipMap":return v.NEAREST_MIPMAP_LINEAR}throw"invalid MinificationFilter type: "+t},f.prototype.getGLBufferTarget=function(t){return"ElementArrayBuffer"===t?v.ELEMENT_ARRAY_BUFFER:v.ARRAY_BUFFER},f.prototype.getGLArrayType=function(t){return t instanceof Uint8Array?v.UNSIGNED_BYTE:t instanceof Uint16Array?v.UNSIGNED_SHORT:t instanceof Uint32Array?v.UNSIGNED_INT:t instanceof Int8Array?v.UNSIGNED_BYTE:t instanceof Int16Array?v.UNSIGNED_SHORT:t instanceof Int32Array?v.UNSIGNED_INT:null},f.prototype.getGLByteSize=function(t){return t instanceof Uint8Array?1:t instanceof Uint16Array?2:t instanceof Uint32Array?4:t instanceof Int8Array?1:t instanceof Int16Array?2:t instanceof Int32Array?4:1},f.prototype.getGLCubeMapFace=function(t){switch(t){case"PositiveX":return v.TEXTURE_CUBE_MAP_POSITIVE_X;case"NegativeX":return v.TEXTURE_CUBE_MAP_NEGATIVE_X;case"PositiveY":return v.TEXTURE_CUBE_MAP_POSITIVE_Y;case"NegativeY":return v.TEXTURE_CUBE_MAP_NEGATIVE_Y;case"PositiveZ":return v.TEXTURE_CUBE_MAP_POSITIVE_Z;case"NegativeZ":return v.TEXTURE_CUBE_MAP_NEGATIVE_Z}throw"Invalid cubemap face: "+t},f.prototype.getGLBufferUsage=function(t){var e=v.STATIC_DRAW;switch(t){case"StaticDraw":e=v.STATIC_DRAW;break;case"DynamicDraw":e=v.DYNAMIC_DRAW;break;case"StreamDraw":e=v.STREAM_DRAW}return e},f.prototype.getGLIndexMode=function(t){var e=v.TRIANGLES;switch(t){case"Triangles":e=v.TRIANGLES;break;case"TriangleStrip":e=v.TRIANGLE_STRIP;break;case"TriangleFan":e=v.TRIANGLE_FAN;break;case"Lines":e=v.LINES;break;case"LineStrip":e=v.LINE_STRIP;break;case"LineLoop":e=v.LINE_LOOP;break;case"Points":e=v.POINTS}return e},f.prototype.updateBlending=function(t){var e=this.rendererRecord.blendRecord,o=this.context,r=t.blendState.blending;if(r!==e.blending&&("NoBlending"===r?o.disable(v.BLEND):"AdditiveBlending"===r?(o.enable(v.BLEND),o.blendEquation(v.FUNC_ADD),o.blendFunc(v.SRC_ALPHA,v.ONE)):"SubtractiveBlending"===r?(o.enable(v.BLEND),o.blendEquation(v.FUNC_REVERSE_SUBTRACT),o.blendFunc(v.SRC_ALPHA,v.ONE)):"MultiplyBlending"===r?(o.enable(v.BLEND),o.blendEquation(v.FUNC_ADD),o.blendFunc(v.DST_COLOR,v.ONE_MINUS_SRC_ALPHA)):"AlphaBlending"===r?(o.enable(v.BLEND),o.blendEquation(v.FUNC_ADD),o.blendFunc(v.SRC_ALPHA,v.ONE_MINUS_SRC_ALPHA)):"CustomBlending"===r?o.enable(v.BLEND):"SeparateBlending"===r?(o.enable(v.BLEND),o.blendEquationSeparate(this.getGLBlendParam(t.blendState.blendEquationColor),this.getGLBlendParam(t.blendState.blendEquationAlpha)),o.blendFuncSeparate(this.getGLBlendParam(t.blendState.blendSrcColor),this.getGLBlendParam(t.blendState.blendDstColor),this.getGLBlendParam(t.blendState.blendSrcAlpha),this.getGLBlendParam(t.blendState.blendDstAlpha))):(o.enable(v.BLEND),o.blendEquationSeparate(v.FUNC_ADD,v.FUNC_ADD),o.blendFuncSeparate(v.SRC_ALPHA,v.ONE_MINUS_SRC_ALPHA,v.ONE,v.ONE_MINUS_SRC_ALPHA)),e.blending=r),"CustomBlending"===r){var i=t.blendState.blendEquation,n=t.blendState.blendSrc,a=t.blendState.blendDst;i!==e.blendEquation&&(o.blendEquation(this.getGLBlendParam(i)),e.blendEquation=i),(n!==e.blendSrc||a!==e.blendDst)&&(o.blendFunc(this.getGLBlendParam(n),this.getGLBlendParam(a)),e.blendSrc=n,e.blendDst=a)}else e.blendEquation=null,e.blendSrc=null,e.blendDst=null},f.prototype.updateOffset=function(t){var e=this.rendererRecord.offsetRecord,o=this.context,r=t.offsetState.enabled,i=t.offsetState.factor,n=t.offsetState.units;e.enabled!==r&&(r?o.enable(v.POLYGON_OFFSET_FILL):o.disable(v.POLYGON_OFFSET_FILL),e.enabled=r),!r||e.factor===i&&e.units===n||(o.polygonOffset(i,n),e.factor=i,e.units=n)},f.prototype.setBoundBuffer=function(t,e){var o=this.rendererRecord.currentBuffer[e];o.valid&&o.buffer===t||(this.context.bindBuffer(this.getGLBufferTarget(e),t),o.buffer=t,o.valid=!0)},f.prototype.bindVertexAttribute=function(t,e){this.context.vertexAttribPointer(t,e.count,this.getGLDataType(e.type),e.normalized,e.stride,e.offset)},f.prototype.getGLDataType=function(t){switch(t){case"Float":case"HalfFloat":case"Double":return v.FLOAT;case"Byte":return v.BYTE;case"UnsignedByte":return v.UNSIGNED_BYTE;case"Short":return v.SHORT;case"UnsignedShort":return v.UNSIGNED_SHORT;case"Int":return v.INT;case"UnsignedInt":return v.UNSIGNED_INT;default:throw"Unknown datatype: "+t}},f.prototype.getGLBlendParam=function(t){switch(t){case"AddEquation":return v.FUNC_ADD;case"SubtractEquation":return v.FUNC_SUBTRACT;case"ReverseSubtractEquation":return v.FUNC_REVERSE_SUBTRACT;case"ZeroFactor":return v.ZERO;case"OneFactor":return v.ONE;case"SrcColorFactor":return v.SRC_COLOR;case"OneMinusSrcColorFactor":return v.ONE_MINUS_SRC_COLOR;case"SrcAlphaFactor":return v.SRC_ALPHA;case"OneMinusSrcAlphaFactor":return v.ONE_MINUS_SRC_ALPHA;case"DstAlphaFactor":return v.DST_ALPHA;case"OneMinusDstAlphaFactor":return v.ONE_MINUS_DST_ALPHA;case"DstColorFactor":return v.DST_COLOR;case"OneMinusDstColorFactor":return v.ONE_MINUS_DST_COLOR;case"SrcAlphaSaturateFactor":return v.SRC_ALPHA_SATURATE;default:throw"Unknown blend param: "+t}},f.prototype.clear=function(t,e,o){var r=0;(void 0===t||t)&&(r|=v.COLOR_BUFFER_BIT),(void 0===e||e)&&(r|=v.DEPTH_BUFFER_BIT),(void 0===o||o)&&(r|=v.STENCIL_BUFFER_BIT);var i=this.rendererRecord.depthRecord;i.write!==!0&&(this.context.depthMask(!0),i.write=!0),this.context.clear(r)},f.prototype.flush=function(){this.context.flush()},f.prototype.finish=function(){this.context.finish()},f.prototype.setupFrameBuffer=function(t,e,o){this.context.bindFramebuffer(v.FRAMEBUFFER,t),this.context.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,o,e.glTexture,0)},f.prototype.setupRenderBuffer=function(t,e){this.context.bindRenderbuffer(v.RENDERBUFFER,t),e.depthBuffer&&!e.stencilBuffer?(this.context.renderbufferStorage(v.RENDERBUFFER,v.DEPTH_COMPONENT16,e.width,e.height),this.context.framebufferRenderbuffer(v.FRAMEBUFFER,v.DEPTH_ATTACHMENT,v.RENDERBUFFER,t)):e.depthBuffer&&e.stencilBuffer?(this.context.renderbufferStorage(v.RENDERBUFFER,v.DEPTH_STENCIL,e.width,e.height),this.context.framebufferRenderbuffer(v.FRAMEBUFFER,v.DEPTH_STENCIL_ATTACHMENT,v.RENDERBUFFER,t)):this.context.renderbufferStorage(v.RENDERBUFFER,v.RGBA4,e.width,e.height)},f.prototype.setRenderTarget=function(t){if(t&&!t._glFrameBuffer){void 0===t.depthBuffer&&(t.depthBuffer=!0),void 0===t.stencilBuffer&&(t.stencilBuffer=!0),t.glTexture=this.context.createTexture();var o=e.isPowerOfTwo(t.width)&&e.isPowerOfTwo(t.height),r=this.getGLInternalFormat(t.format),i=this.getGLDataType(t.type);t._glFrameBuffer=this.context.createFramebuffer(),t._glRenderBuffer=this.context.createRenderbuffer(),this.context.bindTexture(v.TEXTURE_2D,t.glTexture),this.updateTextureParameters(t,o),this.context.texImage2D(v.TEXTURE_2D,0,r,t.width,t.height,0,r,i,null),this.setupFrameBuffer(t._glFrameBuffer,t,v.TEXTURE_2D),this.setupRenderBuffer(t._glRenderBuffer,t),t.generateMipmaps&&o&&this.context.generateMipmap(v.TEXTURE_2D),this.context.bindTexture(v.TEXTURE_2D,null),this.context.bindRenderbuffer(v.RENDERBUFFER,null),this.context.bindFramebuffer(v.FRAMEBUFFER,null)}var n,a,s,l,h;t?(n=t._glFrameBuffer,l=0,h=0,a=t.width,s=t.height):(n=null,l=this.viewportX,h=this.viewportY,a=this.viewportWidth,s=this.viewportHeight),n!==this.rendererRecord.currentFrameBuffer&&(this.context.bindFramebuffer(v.FRAMEBUFFER,n),this.context.viewport(l,h,a,s),this.rendererRecord.currentFrameBuffer=n,this.rendererRecord.textureRecord=[]),this.currentWidth=a,this.currentHeight=s},f.prototype.updateRenderTargetMipmap=function(t){this.context.bindTexture(v.TEXTURE_2D,t.glTexture),this.context.generateMipmap(v.TEXTURE_2D),this.context.bindTexture(v.TEXTURE_2D,null)},f.prototype.getCapabilitiesString=function(){var t=[];for(var e in this.capabilities){var o=this.capabilities[e],r="";if(o instanceof ArrayBufferView){r+="[";for(var i=0;i<o.length;i++)r+=o[i],i<o.length-1&&(r+=",");r+="]"}else r=o;t.push(e+": "+r)}return t.join("\n")},f.prototype._deallocateMeshData=function(t){void 0!==t.vertexData&&void 0!==t.vertexData.glBuffer&&this.context.deleteBuffer(t.vertexData.glBuffer),void 0!==t.indexData&&void 0!==t.indexData.glBuffer&&this.context.deleteBuffer(t.indexData.glBuffer)},f.prototype._deallocateTexture=function(t){t.glTexture&&this.context.deleteTexture(t.glTexture)},f.prototype._deallocateRenderTarget=function(t){t.glTexture&&this.context.deleteTexture(t.glTexture),t._glRenderBuffer&&this.context.deleteFramebuffer(t._glRenderBuffer),t._glFrameBuffer&&this.context.deleteRenderbuffer(t._glFrameBuffer)},f.prototype._deallocateShader=function(t){t.shaderProgram&&this.context.deleteProgram(t.shaderProgram)},f}),define("goo/scripts/newwave/PanCamScript",["goo/math/Vector3","goo/scripts/Scripts","goo/scripts/ScriptUtils","goo/renderer/Renderer"],function(t,e,o,r){"use strict";function i(){function e(t){var e=t[0].clientX,o=t[0].clientY,r=t[1].clientX,i=t[1].clientY,n=(e+r)/2,a=(o+i)/2;return[n,a]}function o(o,r){c=["Any","Left","Middle","Right"].indexOf(o.panButton)-1,-1>c&&(c=-1),u=r.goingToLookAt,a=new t(t.UNIT_Y),s=new t(t.UNIT_X).invert(),l=new t,h=new t,d=new t,p={x:0,y:0,ox:0,oy:0,dx:0,dy:0,down:!1},m={mousedown:function(t){o.whenUsed&&r.entity!==r.activeCameraEntity||(t.button===c||-1===c)&&(p.down=!0,p.ox=p.x=t.clientX,p.oy=p.y=t.clientY)},mouseup:function(t){(t.button===c||-1===c)&&(p.down=!1,p.dx=p.dy=0)},mousemove:function(t){o.whenUsed&&r.entity!==r.activeCameraEntity||p.down&&(p.x=t.clientX,p.y=t.clientY,r.dirty=!0)},mouseleave:function(){p.down=!1,p.ox=p.x,p.oy=p.y},touchstart:function(t){if(!o.whenUsed||r.entity===r.activeCameraEntity){if(p.down=2===t.targetTouches.length,!p.down)return;var i=e(t.targetTouches);p.ox=p.x=i[0],p.oy=p.y=i[1]}},touchmove:function(t){if(!o.whenUsed||r.entity===r.activeCameraEntity){if(!p.down)return;var i=e(t.targetTouches);p.x=i[0],p.y=i[1]}},touchend:function(){p.down=!1,p.ox=p.x,p.oy=p.y}};for(var i in m)r.domElement.addEventListener(i,m[i]);r.dirty=!0}function i(t,e){if(e.dirty&&(p.dx=p.x-p.ox,p.dy=p.y-p.oy,0!==p.dx||0!==p.dy)){t.invertX&&(p.dx=-p.dx),t.invertY&&(p.dy=-p.dy),p.ox=p.x,p.oy=p.y;var o=r.mainCamera;if(u&&o){if(u.equals(o.translation))return;o.getScreenCoordinates(u,1,1,h),h.add_d(-p.dx/e.viewportWidth,p.dy/e.viewportHeight,0),o.getWorldCoordinates(h.x,h.y,1,1,h.z,h),u.setv(h)}else{var i=e.entity,n=i.transformComponent.transform;h.setv(a).scale(p.dy),d.setv(s).scale(p.dx),h.addv(d),n.rotation.applyPost(h),h.scale(t.panSpeed),i.transformComponent.transform.translation.addv(h),i.transformComponent.setUpdated()}}}function n(t,e){for(var o in m)e.domElement.removeEventListener(o,m[o])}var a,s,l,h,d,c,u,p,m;return{setup:o,update:i,cleanup:n}}return i.externals={name:"PanCamControlScript",description:"Enables camera to pan around a point in 3D space using the mouse",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"panButton",name:"Pan button",description:"Only pan with this button",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"panSpeed",type:"float","default":.005,scale:.001,decimals:3}]},i}),define("goo/scripts/newwave/OrbitNPanControlScript",["goo/scripts/Scripts","goo/scripts/ScriptUtils","goo/scripts/newwave/OrbitCamControlScript","goo/scripts/newwave/PanCamScript"],function(t,e,o,r){"use strict";function i(){function e(t,e,o){i.setup(t,e,o),n.setup(t,e,o)}function o(t,e,o){n.update(t,e,o),i.update(t,e,o)}function r(t,e,o){n.cleanup(t,e,o),i.cleanup(t,e,o)}var i=t.create("OrbitCamControlScript"),n=t.create("PanCamControlScript");return{setup:e,cleanup:r,update:o}}for(var n=o.externals.parameters,a=r.externals.parameters,s=n.concat(a.slice(1)),l=0;l<s.length;l++){var h=s[l];switch(h.key){case"dragButton":h["default"]="Left";break;case"panButton":h["default"]="Right"}}return i.externals={name:"OrbitNPanControlScript",description:"This is a combo of orbitcamcontrolscript and pancamcontrolscript",parameters:s},i}),define("goo/scripts/newwave/WASDScript",["goo/math/Vector3","goo/scripts/Scripts","goo/scripts/ScriptUtils"],function(t,e,o){"use strict";var r=function(){function e(){g.x=p.strafeLeft-p.strafeRight,g.z=p.forward-p.back}function r(t){if(!t.altKey)switch(o.keyForCode(t.keyCode)){case u.crawlKey:p.speed=u.crawlSpeed;break;case u.forwardKey:p.forward=1,e();break;case u.backKey:p.back=1,e();break;case u.strafeLeftKey:p.strafeLeft=1,e();break;case u.strafeRightKey:p.strafeRight=1,e()}}function i(t){if(!t.altKey)switch(o.keyForCode(t.keyCode)){case u.crawlKey:p.speed=u.walkSpeed;break;case u.forwardKey:p.forward=0,e();break;case u.backKey:p.back=0,e();break;case u.strafeLeftKey:p.strafeLeft=0,e();break;case u.strafeRightKey:p.strafeRight=0,e()}}function n(t){t.setAttribute("tabindex",-1),t.addEventListener("keydown",r,!1),t.addEventListener("keyup",i,!1)}function a(t,e){u=t,e.moveState=p={strafeLeft:0,strafeRight:0,forward:0,back:0,crawling:!1,speed:t.walkSpeed},h=e.entity,d=h.transformComponent,c=d.transform,n(e.domElement)}function s(e,o){if(!(g.equals(t.ZERO)||e.whenUsed&&o.entity!==o.activeCameraEntity)){v.set(m.x*g.z+f.x*g.x,m.y*g.z+f.y*g.x,m.z*g.z+f.z*g.x),v.normalize();var r=o.world.tpf*p.speed;v.mul(r);var i=c.rotation;i.applyPost(v),c.translation.add(v),d.setUpdated()}}function l(t,e){e.domElement.removeEventListener("keydown",r,!1),e.domElement.removeEventListener("keyup",i,!1)}var h,d,c,u,p,m=new t(0,0,-1),f=new t(-1,0,0),g=new t,v=new t;return{setup:a,update:s,cleanup:l}};return r.externals={name:"WASD",description:"Enables moving via the WASD keys",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"crawlKey",type:"key","default":"Shift"},{key:"forwardKey",type:"key","default":"W"},{key:"backKey",type:"key","default":"S"},{key:"strafeLeftKey",type:"key","default":"A"},{key:"strafeRightKey",type:"key","default":"D"},{key:"walkSpeed",type:"int","default":100,min:1,max:1e3,exponential:!0,control:"slider"},{key:"crawlSpeed",type:"int","default":10,min:.1,max:100,exponential:!0,control:"slider"}]},r}),define("goo/scripts/newwave/MouseLookScript",["goo/scripts/Scripts","goo/math/Vector3","goo/math/MathUtils"],function(t,e,o){"use strict";function r(){function t(t){f.whenUsed&&m.entity!==m.activeCameraEntity||(-1===p||t.button===p)&&(v=!0,l=d=t.clientX,h=c=t.clientY)}function r(t){f.whenUsed&&m.entity!==m.activeCameraEntity||v&&(d=t.clientX,c=t.clientY)}function i(){v=!1}function n(o,n){m=n,f=o,p=["Any","Left","Middle","Right"].indexOf(o.button)-1,-1>p&&(p=-1);var a=n.domElement;a.addEventListener("mousedown",t),a.addEventListener("mousemove",r),a.addEventListener("mouseup",i),a.addEventListener("mouseleave",i),u=new e;var s=n.entity.transformComponent.transform.rotation;s.toAngles(u),g=u.data[1]}function a(t,e){if(d!==l||c!==h){var r=d-l,i=c-h,n=e.entity,a=n.transformComponent.transform.rotation;a.toAngles(u);var s=u.data[0],p=u.data[1],m=t.maxAscent*o.DEG_TO_RAD,f=t.minAscent*o.DEG_TO_RAD;s=o.clamp(s-i*t.speed/200,f,m);var v=t.maxAzimuth*o.DEG_TO_RAD-g,y=t.minAzimuth*o.DEG_TO_RAD-g;p-=r*t.speed/200,t.clampAzimuth&&(p=o.radialClamp(p,y,v)),a.fromAngles(s,p,0),n.transformComponent.setUpdated(),l=d,h=c}}function s(e,o){var n=o.domElement;n.removeEventListener("mousedown",t),n.removeEventListener("mousemove",r),n.removeEventListener("mouseup",i),n.removeEventListener("mouseleave",i)}var l,h,d,c,u,p,m,f,g,v=!1;return{setup:n,update:a,cleanup:s}}return r.externals={name:"MouseLookScript",description:"Click and drag to change rotation of entity, usually a camera",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"button",name:"Mouse button",type:"string",control:"select","default":"Left",options:["Any","Left","Middle","Right"]},{key:"speed",name:"Turn Speed",type:"float",control:"slider","default":1,min:-10,max:10,scale:.1},{key:"maxAscent",name:"Max Ascent",type:"float",control:"slider","default":89.95,min:-89.95,max:89.95},{key:"minAscent",name:"Min Ascent",type:"float",control:"slider","default":-89.95,min:-89.95,max:89.95},{key:"clampAzimuth","default":!1,type:"boolean"},{key:"minAzimuth",description:"Maximum arc the camera can reach clockwise of the target point","default":-90,type:"int",control:"slider",min:-180,max:0},{key:"maxAzimuth",description:"Maximum arc the camera can reach counter-clockwise of the target point","default":90,type:"int",control:"slider",min:0,max:180}]},r}),define("goo/scripts/newwave/FlyControlScript",["goo/scripts/Scripts","goo/scripts/newwave/WASDScript","goo/scripts/newwave/MouseLookScript"],function(t,e,o){"use strict";function r(){function e(t,e){n.setup(t,e),i.setup(t,e)}function o(t,e){n.update(t,e),i.update(t,e)}function r(t,e){n.cleanup(t,e),i.cleanup(t,e)}var i=t.create("WASD"),n=t.create("MouseLookScript");return{setup:e,cleanup:r,update:o}}var i=e.externals.parameters,n=o.externals.parameters,a=i.concat(n.slice(1));return r.externals={name:"FlyControlScript",description:"This is a combo of WASDscript and mouselookscript",parameters:a},r}),define("goo/scripts/ScriptRegister",["goo/scripts/Scripts","goo/scripts/newwave/OrbitNPanControlScript","goo/scripts/newwave/FlyControlScript","goo/scripts/newwave/OrbitCamControlScript","goo/scripts/newwave/PanCamScript","goo/scripts/newwave/MouseLookScript","goo/scripts/newwave/WASDScript"],function(t){"use strict";for(var e=1;e<arguments.length;e++)t.register(arguments[e])}),define("goo/entities/components/ScriptComponent",["goo/entities/components/Component","goo/entities/SystemBus","goo/scripts/Scripts","goo/util/ObjectUtil","goo/scripts/ScriptRegister"],function(t,e,o,r){"use strict";function i(t){this.type="ScriptComponent",this._gooClasses=o.getClasses(),this.scripts=t instanceof Array?t:t?[t]:[]}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype.setup=function(t){var o=t._world.getSystem("ScriptSystem").context,i=Object.create(o);r.extend(i,{entity:t,entityData:{}});for(var n=0;n<this.scripts.length;n++){var a=this.scripts[n],s=Object.create(i);if(a.context=s,a.setup)try{a.setup(a.parameters,a.context,this._gooClasses),a.enabled=a.parameters&&void 0!==a.parameters.enabled?a.parameters.enabled:!0}catch(l){a.enabled=!1,e.emit("goo.scriptError",{message:l.message||l,phase:"setup",scriptName:a.name||a.externals.name})}}},i.prototype.run=function(t){for(var o=0;o<this.scripts.length;o++){var r=this.scripts[o];if(r&&r.run&&(void 0===r.enabled||r.enabled))try{r.run(t,t._world.tpf,r.context,r.parameters)}catch(i){}else if(r.update&&(void 0===r.enabled||r.enabled))try{r.update(r.parameters,r.context,this._gooClasses)}catch(i){r.enabled=!1,e.emit("goo.scriptError",{message:i.message||i,scriptName:r.name||r.externals.name,phase:"run"})}}},i.prototype.cleanup=function(){for(var t=0;t<this.scripts.length;t++){var o=this.scripts[t];if(o.cleanup){try{o.cleanup(o.parameters,o.context,this._gooClasses)}catch(r){e.emit("goo.scriptError",{message:r.message||r,scriptName:o.name||o.externals.name,phase:"cleanup"})}o.enabled=!1}}},i.applyOnEntity=function(t,e){if(t instanceof Function||t&&t.run instanceof Function||t&&t.update instanceof Function){var o;return e.scriptComponent?o=e.scriptComponent:(o=new i,e.setComponent(o)),o.scripts.push(t.run instanceof Function||t.update instanceof Function?t:{run:t}),!0}},i}),define("goo/entities/components/CSSTransformComponent",["goo/entities/components/Component"],function(t){"use strict";function e(e,o){t.call(this),this.type="CSSTransformComponent",this.domElement=e,this.scale=1,this.faceCamera="undefined"==typeof o?!1:o}return e.prototype=Object.create(t.prototype),e}),define("goo/animation/state/AbstractState",[],function(){"use strict";function t(){this._globalStartTime=0,this.onFinished=null}return t.prototype.update=function(){},t.prototype.postUpdate=function(){},t.prototype.getCurrentSourceData=function(){},t.prototype.resetClips=function(t){this._globalStartTime=t},t.prototype.shiftClipTime=function(t){this._globalStartTime+=t},t}),define("goo/math/Quaternion",["goo/math/Vector","goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(t,e,o,r){"use strict";function i(){t.call(this,4),0!==arguments.length?this.set(arguments):this.setd(0,0,0,1)}i.prototype=Object.create(t.prototype),i.prototype.setupAliases([["x"],["y"],["z"],["w"]]),i.IDENTITY=new i(0,0,0,1),i.ALLOWED_DEVIANCE=1e-8,i.add=function(t,e,o){return o||(o=new i),o.data[0]=t.data[0]+e.data[0],o.data[1]=t.data[1]+e.data[1],o.data[2]=t.data[2]+e.data[2],o.data[3]=t.data[3]+e.data[3],o},i.sub=function(t,e,o){return o||(o=new i),o.data[0]=t.data[0]-e.data[0],o.data[1]=t.data[1]-e.data[1],o.data[2]=t.data[2]-e.data[2],o.data[3]=t.data[3]-e.data[3],o},i.mul=function(t,e,o){return o||(o=new i),o.data[0]=t.data[0]*e.data[0],o.data[1]=t.data[1]*e.data[1],o.data[2]=t.data[2]*e.data[2],o.data[3]=t.data[3]*e.data[3],o},i.mul2=function(t,e,o){var r=t.data[0],i=t.data[1],n=t.data[2],a=t.data[3],s=e.data[0],l=e.data[1],h=e.data[2],d=e.data[3];return o.data[0]=r*d+a*s+i*h-n*l,o.data[1]=i*d+a*l+n*s-r*h,o.data[2]=n*d+a*h+r*l-i*s,o.data[3]=a*d-r*s-i*l-n*h,o},i.div=function(t,e,o){o||(o=new i);var r=!0;return o.data[0]=(r&=e.data[0]<0||e.data[0]>0)?t.data[0]/e.data[0]:0,o.data[1]=(r&=e.data[1]<0||e.data[1]>0)?t.data[1]/e.data[1]:0,o.data[2]=(r&=e.data[2]<0||e.data[2]>0)?t.data[2]/e.data[2]:0,o.data[3]=(r&=e.data[3]<0||e.data[3]>0)?t.data[3]/e.data[3]:0,r===!1&&console.warn("[Quaternion.div] Attempted to divide by zero!"),o},i.scalarAdd=function(t,e,o){return o||(o=new i),o.data[0]=t.data[0]+e,o.data[1]=t.data[1]+e,o.data[2]=t.data[2]+e,o.data[3]=t.data[3]+e,o},i.scalarSub=function(t,e,o){return o||(o=new i),o.data[0]=t.data[0]-e,o.data[1]=t.data[1]-e,o.data[2]=t.data[2]-e,o.data[3]=t.data[3]-e,o},i.scalarMul=function(t,e,o){return o||(o=new i),o.data[0]=t.data[0]*e,o.data[1]=t.data[1]*e,o.data[2]=t.data[2]*e,o.data[3]=t.data[3]*e,o},i.scalarDiv=function(t,e,o){o||(o=new i);var r=!0;return e=(r&=0>e||e>0)?1/e:0,o.data[0]=t.data[0]*e,o.data[1]=t.data[1]*e,o.data[2]=t.data[2]*e,o.data[3]=t.data[3]*e,r===!1&&console.warn("[Quaternion.scalarDiv] Attempted to divide by zero!"),o},i.slerp=function(t,e,o,r){if(0===o)return r.setv(t);if(1===o)return r.setv(e);if(t.equals(e))return r.setv(t);var i=t.dot(e);r.setv(e),0>i&&(r.negate(),i=-i);var n=1-o,a=o;if(1-i>.1){var s=Math.acos(i),l=1/Math.sin(s);n=Math.sin((1-o)*s)*l,a=Math.sin(o*s)*l}var h=n*t.data[0]+a*r.data[0],d=n*t.data[1]+a*r.data[1],c=n*t.data[2]+a*r.data[2],u=n*t.data[3]+a*r.data[3];return r.setd(h,d,c,u),r},i.prototype.negate=function(){return this.data[0]*=-1,this.data[1]*=-1,this.data[2]*=-1,this.data[3]*=-1,this},i.prototype.dot=function(t){var e=this.data,o=t.data||t,r=0;return r+=e[0]*o[0],r+=e[1]*o[1],r+=e[2]*o[2],r+=e[3]*o[3]},i.prototype.add=function(t){return i.add(this,t,this)},i.prototype.sub=function(t){return i.sub(this,t,this)},i.prototype.mul=function(t){return i.mul(this,t,this)},i.prototype.div=function(t){return i.div(this,t,this)},i.prototype.scalarAdd=function(t){return i.scalarAdd(this,t,this)},i.prototype.scalarSub=function(t){return i.scalarSub(this,t,this)},i.prototype.scalarMul=function(t){return i.scalarMul(this,t,this)},i.prototype.scalarDiv=function(t){return i.scalarDiv(this,t,this)};var n;return i.prototype.slerp=function(t,e){return n||(n=new i),n.copy(t),i.slerp(this,t,e,n),this.copy(n),this},i.prototype.fromRotationMatrix=function(t){var e,o,r,i,n=t.e00+t.e11+t.e22;if(n>=0){var a=Math.sqrt(n+1);i=.5*a,a=.5/a,e=(t.e21-t.e12)*a,o=(t.e02-t.e20)*a,r=(t.e10-t.e01)*a}else if(t.e00>t.e11&&t.e00>t.e22){var a=Math.sqrt(1+t.e00-t.e11-t.e22);e=.5*a,a=.5/a,o=(t.e10+t.e01)*a,r=(t.e02+t.e20)*a,i=(t.e21-t.e12)*a}else if(t.e11>t.e22){var a=Math.sqrt(1+t.e11-t.e00-t.e22);o=.5*a,a=.5/a,e=(t.e10+t.e01)*a,r=(t.e21+t.e12)*a,i=(t.e02-t.e20)*a}else{var a=Math.sqrt(1+t.e22-t.e00-t.e11);r=.5*a,a=.5/a,e=(t.e02+t.e20)*a,o=(t.e21+t.e12)*a,i=(t.e10-t.e01)*a}return this.set(e,o,r,i)},i.prototype.toRotationMatrix=function(t){var e=t;e||(e=new o);var r=this.magnitudeSquared(),i=r>0?2/r:0,n=this.data,a=n[0]*i,s=n[1]*i,l=n[2]*i,h=n[0]*a,d=n[0]*s,c=n[0]*l,u=n[3]*a,p=n[1]*s,m=n[1]*l,f=n[3]*s,g=n[2]*l,v=n[3]*l,y=e.data;return y[0]=1-(p+g),y[1]=d+v,y[2]=c-f,y[3]=d-v,y[4]=1-(h+g),y[5]=m+u,y[6]=c+f,y[7]=m-u,y[8]=1-(h+p),e},i.prototype.fromVectorToVector=function(t,o){var n=t,a=o,s=n.length()*a.length();if(Math.abs(s)>r.EPSILON){var l=new e,h=n.dot(a)/s,d=Math.acos(Math.max(-1,Math.min(h,1)));if(n.cross(a,l),0>h&&l.length()<r.EPSILON){var c;c=Math.abs(n.x)>Math.abs(n.y)?Math.abs(n.x)>Math.abs(n.z)?0:2:Math.abs(n.y)>Math.abs(n.z)?1:2,l.setValue(c,-n[(c+1)%3]),l.setValue((c+1)%3,n[c]),l.setValue((c+2)%3,0)}return this.fromAngleAxis(d,l)}return this.set(i.IDENTITY)},i.prototype.normalize=function(){var t=1/this.magnitude(),e=this.x*t,o=this.y*t,r=this.z*t,i=this.w*t;return this.set(e,o,r,i)},i.prototype.magnitude=function(){var t=this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]+this.data[3]*this.data[3];return 1===t?1:Math.sqrt(t)},i.prototype.magnitudeSquared=function(){return this.data[0]*this.data[0]+this.data[1]*this.data[1]+this.data[2]*this.data[2]+this.data[3]*this.data[3]},i.prototype.fromAngleAxis=function(t,o){var r=new e(o).normalize();return this.fromAngleNormalAxis(t,r)},i.prototype.fromAngleNormalAxis=function(t,o){if(o.equals(e.ZERO))return this.set(i.IDENTITY);var r=.5*t,n=Math.sin(r),a=Math.cos(r),s=n*o.x,l=n*o.y,h=n*o.z;return this.set(s,l,h,a)},i.prototype.toAngleAxis=function(t){var e,o=this.x*this.x+this.y*this.y+this.z*this.z;if(Math.abs(o)<=i.ALLOWED_DEVIANCE)e=0,null!==t&&(t.x=1,t.y=0,t.z=0);else if(e=2*Math.acos(this.w),null!==t){var r=1/Math.sqrt(o);t.x=this.x*r,t.y=this.y*r,t.z=this.z*r
}return e},i.prototype.equals=function(t){return this===t?!0:t instanceof i?Math.abs(this.data[0]-t.data[0])<i.ALLOWED_DEVIANCE&&Math.abs(this.data[1]-t.data[1])<i.ALLOWED_DEVIANCE&&Math.abs(this.data[2]-t.data[2])<i.ALLOWED_DEVIANCE&&Math.abs(this.data[3]-t.data[3])<i.ALLOWED_DEVIANCE:!1},i.prototype.setd=function(t,e,o,r){return this.data[0]=t,this.data[1]=e,this.data[2]=o,this.data[3]=r,this},i.prototype.seta=function(t){return this.data[0]=t[0],this.data[1]=t[1],this.data[2]=t[2],this.data[3]=t[3],this},i.prototype.setv=function(t){return this.data[0]=t.data[0],this.data[1]=t.data[1],this.data[2]=t.data[2],this.data[3]=t.data[3],this},i}),define("goo/animation/clip/TransformData",["goo/math/Quaternion","goo/math/Vector3"],function(t,e){"use strict";function o(o){this._rotation=(new t).copy(o?o._rotation:t.IDENTITY),this._scale=(new e).copy(o?o._scale:e.ONE),this._translation=(new e).copy(o?o._translation:e.ZERO)}return o.prototype.applyTo=function(t){t.setIdentity(),t.rotation.copyQuaternion(this._rotation),t.scale.setv(this._scale),t.translation.setv(this._translation),t.update()},o.prototype.set=function(t){this._rotation.copy(t._rotation),this._scale.copy(t._scale),this._translation.copy(t._translation)},o.prototype.blend=function(e,r,i){var n=i?i:new o;return n._translation.setv(this._translation).lerp(e._translation,r),n._scale.setv(this._scale).lerp(e._scale,r),t.slerp(this._rotation,e._rotation,r,n._rotation),n},o}),define("goo/animation/blendtree/BinaryLERPSource",["goo/math/MathUtils","goo/animation/clip/TransformData"],function(t,e){"use strict";function o(t,e,o){this._sourceA=t?t:null,this._sourceB=e?e:null,this.blendWeight=o?o:null}return o.prototype.getSourceData=function(){var t=this._sourceA?this._sourceA.getSourceData():null,e=this._sourceB?this._sourceB.getSourceData():null;return o.combineSourceData(t,e,this.blendWeight)},o.prototype.setTime=function(t){var e=!1,o=!1;return this._sourceA&&(e=this._sourceA.setTime(t)),this._sourceB&&(o=this._sourceB.setTime(t)),e||o},o.prototype.resetClips=function(t){this._sourceA&&this._sourceA.resetClips(t),this._sourceB&&this._sourceB.resetClips(t)},o.prototype.shiftClipTime=function(t){this._sourceA&&this._sourceA.shiftClipTime(t),this._sourceB&&this._sourceB.shiftClipTime(t)},o.prototype.setTimeScale=function(t){this._sourceA.setTimeScale(t),this._sourceB.setTimeScale(t)},o.prototype.isActive=function(){var t=!1;return this._sourceA&&(t=t||this._sourceA.isActive()),this._sourceB&&(t=t||this._sourceB.isActive()),t},o.combineSourceData=function(t,r,i,n){if(!r)return t;if(!t)return r;var a=n?n:{};for(var s in t){var l=t[s],h=r[s];isNaN(l)?l instanceof e?h?a[s]=l.blend(h,i,a[s]):a[s]?a[s].set(l):a[s]=new l.constructor(l):a[s]=l:o.blendFloatValues(a,s,i,l,h)}for(var s in r)a[s]||(a[s]=r[s]);return a},o.blendFloatValues=function(e,o,r,i,n){e[o]=isNaN(n)?i:t.lerp(r,i[0],n[0])},o.prototype.clone=function(){return new o(this._sourceA,this._sourceB,this._blendWeight)},o}),define("goo/animation/state/AbstractTransitionState",["goo/animation/state/AbstractState","goo/animation/blendtree/BinaryLERPSource","goo/math/MathUtils"],function(t,e,o){"use strict";function r(){t.call(this),this._sourceState=null,this._targetState=null,this._percent=0,this._sourceData=null,this._fadeTime=0,this._blendType="Linear"}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.update=function(t){var e=t-this._globalStartTime;if(e>this._fadeTime&&this.onFinished)return void this.onFinished();var r=e/this._fadeTime;switch(this._blendType){case"SCurve3":this._percent=o.scurve3(r);break;case"SCurve5":this._percent=o.scurve5(r);break;default:this._percent=r}},r.prototype.readFromConfig=function(t){t&&(void 0!==t.fadeTime&&(this._fadeTime=t.fadeTime),void 0!==t.blendType&&(this._blendType=t.blendType))},r.prototype.getCurrentSourceData=function(){var t=this._sourceState?this._sourceState.getCurrentSourceData():null,o=this._targetState?this._targetState.getCurrentSourceData():null;return this._sourceData||(this._sourceData={}),e.combineSourceData(t,o,this._percent,this._sourceData)},r.prototype.isValid=function(t,e){var o=e-this._sourceState._globalStartTime,r=t[0],i=t[1];return 0>=r?0>=i?!0:i>=o:0>=i?o>=r:i>=r?o>=r&&i>=o:o>=r||i>=o},r.prototype.resetClips=function(e){t.prototype.resetClips.call(this,e),this._percent=0},r.prototype.shiftClipTime=function(e){t.prototype.shiftClipTime.call(this,e)},r.prototype.setTimeScale=function(t){this._sourceState&&this._sourceState.setTimeScale(t),this._targetState&&this._targetState.setTimeScale(t)},r}),define("goo/animation/state/FadeTransitionState",["goo/animation/state/AbstractTransitionState"],function(t){"use strict";function e(){t.call(this)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.update=function(e){t.prototype.update.call(this,e),this._sourceState&&this._sourceState.update(e),this._targetState&&this._targetState.update(e)},e.prototype.postUpdate=function(){this._sourceState&&this._sourceState.postUpdate(),this._targetState&&this._targetState.postUpdate()},e.prototype.resetClips=function(e){t.prototype.resetClips.call(this,e),this._targetState&&this._targetState.resetClips(e)},e.prototype.shiftClipTime=function(e){t.prototype.shiftClipTime.call(this,e),this._targetState&&this._targetState.shiftClipTime(e),this._sourceState&&this._sourceState.shiftClipTime(e)},e}),define("goo/animation/state/SyncFadeTransitionState",["goo/animation/state/FadeTransitionState"],function(t){"use strict";function e(){t.call(this)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.resetClips=function(e){t.prototype.resetClips.call(this,e),this._targetState.resetClips(this._sourceState._globalStartTime)},e.prototype.shiftClipTime=function(e){t.prototype.shiftClipTime.call(this,e),this._targetState.shiftClipTime(this._sourceState._globalStartTime+e),this._sourceState.shiftClipTime(e)},e}),define("goo/animation/state/FrozenTransitionState",["goo/animation/state/AbstractTransitionState"],function(t){"use strict";function e(){t.call(this)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.update=function(e){t.prototype.update.call(this,e),this._targetState&&this._targetState.update(e)},e.prototype.postUpdate=function(){this._targetState&&this._targetState.postUpdate()},e.prototype.resetClips=function(e){t.prototype.resetClips.call(this,e),this._targetState.resetClips(e)},e.prototype.shiftClipTime=function(e){t.prototype.shiftClipTime.call(this,e),this._targetState.shiftClipTime(e)},e}),define("goo/animation/state/SteadyState",["goo/animation/state/AbstractState"],function(t){"use strict";function e(e){t.call(this),this.id=null,this._name=e,this._transitions={},this._sourceTree=null}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.setClipSource=function(t){this._sourceTree=t},e.prototype.update=function(t){this._sourceTree.setTime(t)||this.onFinished&&this.onFinished()},e.prototype.getCurrentSourceData=function(){return this._sourceTree.getSourceData()},e.prototype.resetClips=function(e){t.prototype.resetClips.call(this,e),this._sourceTree.resetClips(e)},e.prototype.shiftClipTime=function(e){t.prototype.shiftClipTime.call(this,e),this._sourceTree.shiftClipTime(e)},e.prototype.setTimeScale=function(t){this._sourceTree.setTimeScale(t)},e.prototype.clone=function(){var t=new e(this._name);for(var o in this._transitions)t._transitions[o]=this._transitions[o];return t._sourceTree=this._sourceTree.clone(),t},e}),define("goo/animation/layer/LayerLERPBlender",["goo/animation/blendtree/BinaryLERPSource"],function(t){"use strict";function e(){this._blendWeight=null,this._layerA=null,this._layerB=null}return e.prototype.getBlendedSourceData=function(){var e=this._layerA.getCurrentSourceData(),o=this._layerB._currentState?this._layerB._currentState.getCurrentSourceData():null;return t.combineSourceData(e,o,this._blendWeight)},e}),define("goo/animation/layer/AnimationLayer",["goo/animation/state/FadeTransitionState","goo/animation/state/SyncFadeTransitionState","goo/animation/state/FrozenTransitionState","goo/animation/state/SteadyState","goo/animation/layer/LayerLERPBlender","goo/entities/World","goo/math/MathUtils"],function(t,e,o,r,i,n,a){"use strict";function s(t,e){this.id=e,this._name=t,this._steadyStates={},this._currentState=null,this._layerBlender=new i,this._transitions={},this._transitionStates={}}return s.BASE_LAYER_NAME="-BASE_LAYER-",s.prototype.getStates=function(){return Object.keys(this._steadyStates)},s.prototype.setState=function(t,e){this._steadyStates[t]=e},s.prototype.setBlendWeight=function(t){this._layerBlender&&(this._layerBlender._blendWeight=a.clamp(t,0,1))},s.prototype.getTransitions=function(){var t;if(t=this._currentState?Object.keys(this._currentState._transitions):[],this._transitions)for(var e in this._transitions)-1===t.indexOf(e)&&t.push(e);return t.sort(),t},s.prototype.update=function(t){this._currentState&&this._currentState.update(t||n.time)},s.prototype.postUpdate=function(){this._currentState&&this._currentState.postUpdate()},s.prototype.transitionTo=function(t,e){e=e||n.time;var o,i=this._currentState;if(this._steadyStates[t]===i)return!1;if(!this._steadyStates[t])return!1;if(i&&i._transitions&&(o=i._transitions[t]||i._transitions["*"]),!o&&this._transitions&&(o=this._transitions[t]||this._transitions["*"]),i instanceof r&&o){var a=this._getTransitionByType(o.type);return this._doTransition(a,i,this._steadyStates[t],o,e),!0}if(!i&&(o=this._transitions[t])){var a=this._getTransitionByType(o.type);if(a)return this._doTransition(a,null,this._steadyStates[t],o,e),!0}return!1},s.prototype._doTransition=function(t,e,o,r,i){if(e){t._sourceState=e;var n=r.timeWindow||[-1,-1];if(!t.isValid(n,i))return void console.warn("State not in allowed time window");e.onFinished=null}t._targetState=o,t.readFromConfig(r),t.resetClips(i),this.setCurrentState(t)},s.prototype.setCurrentState=function(t,e,o){o=o||n.time,this._currentState=t,t&&(e&&t.resetClips(o),t.onFinished=function(){this.setCurrentState(t._targetState||null),this.update()}.bind(this))},s.prototype.getCurrentState=function(){return this._currentState},s.prototype.setCurrentStateByName=function(t,e,o){if(t){var r=this._steadyStates[t];if(r)return this.setCurrentState(r,e,o),!0;console.warn("unable to find SteadyState named: "+t)}return!1},s.prototype.getCurrentSourceData=function(){return this._layerBlender?this._layerBlender.getBlendedSourceData():this._currentState?this._currentState.getCurrentSourceData():null},s.prototype.updateLayerBlending=function(t){this._layerBlender&&(this._layerBlender._layerA=t,this._layerBlender._layerB=this)},s.prototype.clearCurrentState=function(){this.setCurrentState(null)},s.prototype.resetClips=function(t){this._currentState&&this._currentState.resetClips(t||n.time)},s.prototype.shiftClipTime=function(t){this._currentState&&this._currentState.shiftClipTime(t||0)},s.prototype.setTimeScale=function(t){this._currentState&&this._currentState.setTimeScale(t)},s.prototype._getTransitionByType=function(r){if(this._transitionStates[r])return this._transitionStates[r];var i;switch(r){case"Fade":i=new t;break;case"SyncFade":i=new e;break;case"Frozen":i=new o;break;default:console.log("Defaulting to frozen transition type"),i=new o}return this._transitionStates[r]=i},s.prototype.clone=function(){var t=new s(this._name);for(var e in this._steadyStates)t._steadyStates[e]=this._steadyStates[e].clone(),this._steadyStates[e]===this._currentState&&(t._currentState=t._steadyStates[e]);for(var e in this._transitions)t._transitions[e]=this._transitions[e];for(var e in this._transitionStates)t._transitionStates[e]=new this._transitionStates[e].constructor;return t},s}),define("goo/animation/clip/JointData",["goo/animation/clip/TransformData"],function(t){"use strict";function e(e){t.call(this,e),this._jointIndex=e?e._jointIndex:0}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.set=function(e){t.prototype.set.call(this,e),this._jointIndex=e._jointIndex},e.prototype.blend=function(o,r,i){var n=i;return n?n instanceof e&&(n._jointIndex=this._jointIndex):(n=new e,n._jointIndex=this._jointIndex),t.prototype.blend.call(this,o,r,n)},e.prototype.clone=function(){return new e(this)},e}),define("goo/animation/clip/TriggerData",[],function(){"use strict";function t(){this._currentTriggers=[],this._currentIndex=-1,this.armed=!1}return t.prototype.arm=function(t,e){if(null===e||0===e.length)this._currentTriggers.length=0,this.armed=!1;else if(t!==this._currentIndex){this._currentTriggers.length=0;for(var o=0,r=e.length;r>o;o++)e[o]&&""!==e[o]&&this._currentTriggers.push(e[o]);this.armed=!0}this._currentIndex=t},t}),define("goo/entities/components/AnimationComponent",["goo/entities/components/Component","goo/entities/World","goo/animation/layer/AnimationLayer","goo/animation/clip/JointData","goo/animation/clip/TransformData","goo/animation/clip/TriggerData"],function(t,e,o,r,i,n){"use strict";function a(t){this.type="AnimationComponent",this.layers=[],this.floats={},this._updateRate=1/60,this._lastUpdate=0,this._triggerCallbacks={};var e=new o(o.BASE_LAYER_NAME);this.layers.push(e),this._skeletonPose=t,this.paused=!1,this.lastTimeOfPause=null}return a.prototype=Object.create(t.prototype),a.prototype.transitionTo=function(t,e){return this.layers[0].transitionTo(t)?!0:e?this.layers[0].setCurrentStateByName(t):!1},a.prototype.getStates=function(){return this.layers[0].getStates()},a.prototype.getCurrentState=function(){return this.layers[0].getCurrentState()},a.prototype.getTransitions=function(){return this.layers[0].getTransitions()},a.prototype.update=function(t){if(!this.paused){if(t=t||e.time,0!==this._updateRate){if(t>this._lastUpdate&&t-this._lastUpdate<this._updateRate)return;this._lastUpdate=t-(t-this._lastUpdate)%this._updateRate}for(var o=0,r=this.layers.length;r>o;o++)this.layers[o].update(t)}},a.prototype.apply=function(t){var e=this.getCurrentSourceData(),o=this._skeletonPose;if(e){for(var a=Object.keys(e),s=0,l=a.length;l>s;s++){var h=a[s],d=e[h];if(d instanceof r)o&&d._jointIndex>=0&&d.applyTo(o._localTransforms[d._jointIndex]);else if(d instanceof i)t&&(d.applyTo(t.transform),t.updateTransform(),this._updateWorldTransform(t));else if(d instanceof n){if(d.armed){for(var s=0,c=d._currentTriggers.length;c>s;s++){var u=this._triggerCallbacks[d._currentTriggers[s]];if(u&&u.length)for(var p=0,m=u.length;m>p;p++)u[p]()}d.armed=!1}}else d instanceof Array&&(this.floats[h]=d[0])}o&&o.updateTransforms()}},a.prototype._updateWorldTransform=function(t){t.updateWorldTransform();for(var e=0;e<t.children.length;e++)this._updateWorldTransform(t.children[e])},a.prototype.postUpdate=function(){for(var t=0,e=this.layers.length;e>t;t++)this.layers[t].postUpdate()},a.prototype.getCurrentSourceData=function(){if(0===this.layers.length)return[];var t=this.layers.length-1;this.layers[0]._layerBlender=null;for(var e=0;t>e;e++)this.layers[e+1].updateLayerBlending(this.layers[e]);return this.layers[t].getCurrentSourceData()},a.prototype.addLayer=function(t,e){isNaN(e)?this.layers.push(t):this.layers.splice(e,0,t)},a.prototype.resetClips=function(t){for(var e=0;e<this.layers.length;e++)this.layers[e].resetClips(t)},a.prototype.shiftClipTime=function(t){for(var e=0;e<this.layers.length;e++)this.layers[e].shiftClipTime(t)},a.prototype.setTimeScale=function(t){for(var e=0;e<this.layers.length;e++)this.layers[e].setTimeScale(t)},a.prototype.pause=function(){this.paused||(this.lastTimeOfPause=e.time,this.paused=!0)},a.prototype.stop=function(){this._skeletonPose&&this._skeletonPose.setToBindPose(),this.paused=!0,this.lastTimeOfPause=-1},a.prototype.resume=function(){this.paused&&(-1===this.lastTimeOfPause?this.resetClips():this.shiftClipTime(e.time-this.lastTimeOfPause)),this.paused=!1},a.prototype.clone=function(){var t=new a;return t.layers=this.layers.map(function(t){return t.clone()}),t},a}),define("goo/entities/EntityUtils",["goo/entities/components/TransformComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/CameraComponent","goo/entities/components/LightComponent","goo/entities/components/ScriptComponent","goo/renderer/Camera","goo/renderer/light/Light","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/bounds/BoundingBox","goo/math/Transform","goo/entities/components/CSSTransformComponent","goo/entities/components/AnimationComponent"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p){"use strict";function m(){}function f(t,e){e.skeletonMap=e.skeletonMap||{originals:[],clones:[]};var o,r=e.skeletonMap.originals.indexOf(t);return-1===r?(o=t.clone(),e.skeletonMap.originals.push(t),e.skeletonMap.clones.push(o)):o=e.skeletonMap.clones[r],o}function g(r,i,n){for(var a=r.createEntity(i.name),s=0;s<i._components.length;s++){var l=i._components[s];if(l instanceof t)a.transformComponent.transform.copy(l.transform);else if(l instanceof e){var h=new e(l.meshData);h.modelBound=new l.modelBound.constructor,l.currentPose&&(h.currentPose=f(l.currentPose,n)),a.setComponent(h)}else if(l instanceof o){for(var d=new o,c=0;c<l.materials.length;c++)d.materials.push(l.materials[c]);a.setComponent(d)}else if(l instanceof p){var u=l.clone();u._skeletonPose=f(l._skeletonPose,n),a.setComponent(u)}else a.setComponent(l)}for(var c=0;c<i.transformComponent.children.length;c++){var m=i.transformComponent.children[c],v=g(r,m.entity,n);a.transformComponent.attachChild(v.transformComponent)}return n.callback&&n.callback(a),a}return m.clone=function(t,e,o){return o=o||{},o.shareData=o.shareData||!0,o.shareMaterial=o.shareMaterial||!0,o.cloneHierarchy=o.cloneHierarchy||!0,g(t,e,o)},m.traverse=function(t,e,o){if(o=void 0!==o?o:0,e(t,o)!==!1)for(var r=0;r<t.transformComponent.children.length;r++){var i=t.transformComponent.children[r];m.traverse(i.entity,e,o+1)}},m.getRoot=function(t){for(;t.transformComponent.parent;)t=t.transformComponent.parent.entity;return t},m.updateWorldTransform=function(t){t.updateWorldTransform();for(var e=0;e<t.children.length;e++)m.updateWorldTransform(t.children[e])},m.show=function(t){t.hidden=!1;for(var e=t;e.transformComponent.parent;)if(e=e.transformComponent.parent.entity,e.hidden)return void(t.meshRendererComponent&&(t.meshRendererComponent.hidden=!0));m.traverse(t,function(t){return t.hidden?!1:(t.meshRendererComponent&&(t.meshRendererComponent.hidden=t.hidden),void(t.lightComponent&&(t.lightComponent.hidden=t.hidden)))})},m.hide=function(t){t.hidden=!0,m.traverse(t,function(t){t.meshRendererComponent&&(t.meshRendererComponent.hidden=!0),t.lightComponent&&(t.lightComponent.hidden=!0)})},m.createTypicalEntity=function(t){for(var d=t.createEntity(),u=1;u<arguments.length;u++){var p=arguments[u];if(p instanceof h){var m=new e(p);if(d.setComponent(m),!d.hasComponent("MeshRendererComponent")){var f=new o;d.setComponent(f)}}else if(p instanceof l){if(!d.hasComponent("MeshRendererComponent")){var f=new o;d.setComponent(f)}d.meshRendererComponent.materials.push(p)}else if(p instanceof s){var g=new i(p);d.setComponent(g)}else if(p instanceof a){var v=new r(p);d.setComponent(v)}else p instanceof c?d.transformComponent.transform=p:"string"==typeof p?d.name=p:Array.isArray(p)&&3===p.length?d.transformComponent.transform.translation.setd(p[0],p[1],p[2]):"function"==typeof p.run&&(d.hasComponent("ScriptComponent")||d.setComponent(new n),d.scriptComponent.scripts.push(p))}return d},m.createDOMEntity=function(t,e){var o=t.createEntity();return o.setComponent(new u(e)),o},m.getChildren=function(t){return t.transformComponent.children.map(function(t){return t.entity})},m.getTotalBoundingBox=function(t){var e=new d,o=!0;if(m.traverse(t,function(t){if(t.meshRendererComponent)if(o){var r=t.meshRendererComponent.worldBound;r instanceof d?r.clone(e):(e.center.setv(r.center),e.xExtent=e.yExtent=e.zExtent=r.radius),o=!1}else e.merge(t.meshRendererComponent.worldBound)}),o){var r=t.transformComponent.worldTransform.translation;e=new d(r.clone(),.001,.001,.001)}return e},m}),define("goo/addons/ammo/calculateTriangleMeshShape",[],function(){"use strict";var t=window.Ammo;return function(e,o){o=o||[1,1,1];for(var r=4,i=!0,n=i?4:2,a=i?"i32":"i16",s=e.meshDataComponent.meshData,l=s.dataViews.POSITION,h=t.allocate(r*l.length,"float",t.ALLOC_NORMAL),d=0,c=l.length;c>d;d++)t.setValue(h+d*r,o[d%3]*l[d],"float");for(var u=s.indexData.data,p=t.allocate(n*u.length,a,t.ALLOC_NORMAL),d=0,c=u.length;c>d;d++)t.setValue(p+d*n,u[d],a);var m=new t.btIndexedMesh;m.set_m_numTriangles(s.indexCount/3),m.set_m_triangleIndexBase(p),m.set_m_triangleIndexStride(3*n),m.set_m_numVertices(s.vertexCount),m.set_m_vertexBase(h),m.set_m_vertexStride(3*r);var f=new t.btTriangleIndexVertexArray;return f.addIndexedMesh(m,2),new t.btBvhTriangleMeshShape(f,!0,!0)}}),define("goo/addons/ammo/AmmoComponent",["goo/entities/EntityUtils","goo/entities/components/Component","goo/math/Quaternion","goo/addons/ammo/calculateTriangleMeshShape","goo/shapes/Box","goo/shapes/Quad","goo/shapes/Sphere","goo/renderer/Material","goo/shapes/ShapeCreator","goo/renderer/shaders/ShaderLib","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a,s,l,h,d,c,u){"use strict";function p(t){this.settings=t=t||{},u.defaults(t,{mass:0,useBounds:!1,useWorldBounds:!1,useWorldTransform:!1,linearFactor:new m.btVector3(1,1,1),isTrigger:!1,onInitializeBody:null}),this.mass=t.mass,this.useBounds=t.useBounds,this.useWorldBounds=t.useWorldBounds,this.useWorldTransform=t.useWorldTransform,this.linearFactor=t.linearFactor,this.onInitializeBody=t.onInitializeBody,this.isTrigger=t.isTrigger,this.type="AmmoComponent",this.ammoTransform=new m.btTransform,this.gooQuaternion=new o,this.shape=void 0}var m=window.Ammo;return p.prototype=Object.create(e.prototype),p.prototype.getAmmoShapefromGooShape=function(t,e){var o,s=[Math.abs(e.scale.x),Math.abs(e.scale.y),Math.abs(e.scale.z)];if(t.meshDataComponent&&t.meshDataComponent.meshData){var l=t.meshDataComponent.meshData;if(l instanceof i)o=new m.btBoxShape(new m.btVector3(l.xExtent*s[0],l.yExtent*s[1],l.zExtent*s[2]));else if(l instanceof a)o=new m.btSphereShape(l.radius*s[0]);else if(l instanceof n)o=new m.btBoxShape(new m.btVector3(l.xExtent,l.yExtent,.01));else if(this.useBounds||this.mass>0){t.meshDataComponent.computeBoundFromPoints();var h=t.meshDataComponent.modelBound;h instanceof d?o=new m.btBoxShape(new m.btVector3(h.xExtent*s[0],h.yExtent*s[1],h.zExtent*s[2])):h instanceof c&&(o=new m.btSphereShape(h.radius*s[0]))}else o=r(t,s.data)}else for(var o=new m.btCompoundShape,u=t.transformComponent.children,p=0;p<u.length;p++){var f=this.getAmmoShapefromGooShape(u[p].entity,e),g=new m.btTransform;g.setIdentity();var v=u[p].transform.translation;g.setOrigin(new m.btVector3(v.x,v.y,v.z)),o.addChildShape(g,f)}return o},p.prototype.getAmmoShapefromGooShapeWorldBounds=function(e){var o,r=t.getTotalBoundingBox(e);return this.center=r.center,o=new m.btBoxShape(new m.btVector3(r.xExtent,r.yExtent,r.zExtent))},p.prototype.initialize=function(t){var e=t.transformComponent.transform;this.useWorldTransform&&(e=t.transformComponent.worldTransform);var o=e.translation,r=new m.btTransform;r.setIdentity(),r.setOrigin(new m.btVector3(o.x,o.y,o.z)),this.gooQuaternion.fromRotationMatrix(e.rotation);var i=this.gooQuaternion;if(r.setRotation(new m.btQuaternion(i.x,i.y,i.z,i.w)),this.useWorldBounds?(t._world.process(),this.shape=this.getAmmoShapefromGooShapeWorldBounds(t,e),this.difference=this.center.clone().sub(e.translation).invert()):this.shape=this.getAmmoShapefromGooShape(t,e),!1===this.isTrigger){var n=new m.btDefaultMotionState(r),a=new m.btVector3(0,0,0);0!==this.mass&&this.shape.calculateLocalInertia(this.mass,a);var s=new m.btRigidBodyConstructionInfo(this.mass,n,this.shape,a);this.localInertia=a,this.body=new m.btRigidBody(s),this.body.setLinearFactor(this.linearFactor),this.onInitializeBody&&this.onInitializeBody(this.body)}},p.prototype.showBounds=function(e){var o,r=t.getTotalBoundingBox(e);r.xExtent?o=t.createTypicalEntity(e._world,l.createBox(2*r.xExtent,2*r.yExtent,2*r.zExtent)):r.radius&&(o=t.createTypicalEntity(e._world,l.createSphere(12,12,r.radius)));var i=s.createMaterial(h.simpleLit);i.wireframe=!0,o.meshRendererComponent.materials.push(i),o.transformComponent.setTranslation(r.center),o.addToWorld(),this.bv=o},p.prototype.setPhysicalTransform=function(t){var e=t.translation;this.ammoTransform.setIdentity(),this.ammoTransform.setOrigin(new m.btVector3(e.x,e.y,e.z)),this.gooQuaternion.fromRotationMatrix(t.rotation);var o=this.gooQuaternion;this.ammoTransform.setRotation(new m.btQuaternion(o.x,o.y,o.z,o.w)),this.body.setWorldTransform(this.ammoTransform)},p.prototype.copyPhysicalTransformToVisual=function(t){var e=t.transformComponent;if(this.body){this.body.getMotionState().getWorldTransform(this.ammoTransform);var o=this.ammoTransform.getRotation();this.gooQuaternion.setd(o.x(),o.y(),o.z(),o.w()),e.transform.rotation.copyQuaternion(this.gooQuaternion);var r=this.ammoTransform.getOrigin();e.setTranslation(r.x(),r.y(),r.z()),this.settings.showBounds&&(this.bv||this.showBounds(t),this.bv.transformComponent.transform.rotation.copy(e.transform.rotation),this.bv.transformComponent.setTranslation(e.transform.translation)),this.difference&&e.addTranslation(this.difference)}},p}),define("goo/addons/ammo/AmmoSystem",["goo/entities/systems/System"],function(t){"use strict";function e(e){t.call(this,"AmmoSystem",["AmmoComponent","TransformComponent"]),this.settings=e||{},this.fixedTime=1/(this.settings.stepFrequency||60),this.maxSubSteps=this.settings.maxSubSteps||5;var r=new o.btDefaultCollisionConfiguration,i=new o.btCollisionDispatcher(r),n=new o.btDbvtBroadphase,a=new o.btSequentialImpulseConstraintSolver;this.ammoWorld=new o.btDiscreteDynamicsWorld(i,n,a,r),this.ammoWorld.setGravity(new o.btVector3(0,this.settings.gravity||-9.81,0))}var o=window.Ammo;return e.prototype=Object.create(t.prototype),e.prototype.inserted=function(t){t.ammoComponent?(t.ammoComponent.initialize(t),this.ammoWorld.addRigidBody(t.ammoComponent.body)):console.log("Warning: missing entity.ammoComponent")},e.prototype.deleted=function(t){t.ammoComponent&&this.ammoWorld.removeRigidBody(t.ammoComponent.body)},e.prototype.process=function(t,e){this.ammoWorld.stepSimulation(e,this.maxSubSteps,this.fixedTime);for(var o=0;o<t.length;o++){var r=t[o];r.ammoComponent.mass>0&&r.ammoComponent.copyPhysicalTransformToVisual(r,e)}},e}),define("goo/addons/box2d/components/Box2DComponent",["goo/entities/components/Component"],function(t){"use strict";function e(t){this.type="Box2DComponent",this.body=null,this.world=null,this.mass=1,this.settings=t||{},this.shape=t.shape?t.shape:"box",this.width=t.width?t.width:1,this.height=t.height?t.height:1,this.radius=t.radius?t.radius:1,this.vertices=t.vertices?t.vertices:[0,1,2,2,0,2],this.movable=t.movable===!1?!1:!0,this.friction=t.friction?t.friction:1,this.restitution=t.restitution?t.restitution:0,this.offsetX=t.offsetX?t.offsetX:0,this.offsetY=t.offsetY?t.offsetY:0}return e.prototype=Object.create(t.prototype),e}),define("goo/addons/box2d/systems/Box2DSystem",["goo/entities/systems/System"],function(t){"use strict";function e(){t.call(this,"Box2DSystem",["Box2DComponent","MeshDataComponent"]),this.SCALE=.5,this.world=new Box2D.b2World(new Box2D.b2Vec2(0,-9.81)),this.sortVertexesClockWise=function(t,e){var o=Math.atan2(t.get_y(),t.get_x()),r=Math.atan2(e.get_y(),e.get_x());return o>r?1:-1},this.velocityIterations=8,this.positionIterations=3;var e=4;this.createPolygonShape=function(t){for(var o=new Box2D.b2PolygonShape,r=Box2D.allocate(t.length*e*2,"float",Box2D.ALLOC_STACK),i=0,n=0;n<t.length;n++)Box2D.setValue(r+i,t[n].get_x(),"float"),Box2D.setValue(r+(i+e),t[n].get_y(),"float"),i+=2*e;var a=Box2D.wrapPointer(r,Box2D.b2Vec2);return o.Set(a,t.length),o}}return e.prototype=Object.create(t.prototype),e.prototype.inserted=function(t){var e=t.box2DComponent,o=0,r=0,i=new Box2D.b2PolygonShape;if("box"===e.shape)i.SetAsBox(e.width*this.SCALE,e.height*this.SCALE);else if("circle"===e.shape)i=new Box2D.b2CircleShape,i.set_m_radius(e.radius);else if("mesh"===e.shape){for(var n=t.meshDataComponent.meshData,a=n.getAttributeBuffer("POSITION"),s=0,l=[],h=1/0,d=-1/0,c=1/0,u=-1/0;s<=a.length-3;){var p=a[s],m=a[++s];h>m&&(h=m),m>d&&(d=m),c>p&&(c=p),p>u&&(u=p),++s,t.transformComponent.updateWorldTransform();var f=new Box2D.b2Vec2(p,m);l.push(f)}i=this.createPolygonShape(l),o=d-h,r=u-c}else if("polygon"===e.shape){for(var l=[],s=0;s<=e.vertices.length-2;){var f=new Box2D.b2Vec2(e.vertices[s],e.vertices[++s]);l.push(f),++s}i=this.createPolygonShape(l)}var g=new Box2D.b2FixtureDef;g.set_shape(i),g.set_density(1),g.set_friction(e.friction),g.set_restitution(e.restitution);var v=new Box2D.b2BodyDef;e.movable===!0&&v.set_type(Box2D.b2_dynamicBody),v.set_position(new Box2D.b2Vec2(t.transformComponent.transform.translation.x+e.offsetX,t.transformComponent.transform.translation.y+e.offsetY));var y=t.transformComponent.transform.rotation.toAngles();v.set_angle(y.z);var x=this.world.CreateBody(v);x.CreateFixture(g),x.SetLinearDamping(.95),x.SetAngularDamping(.6),e.body=x,e.world=this.world,t.body=x,t.body.h=o,t.body.w=r},e.prototype.deleted=function(t){this.world.DestroyBody(t.body)},e.prototype.process=function(t,e){this.world.Step(e,this.velocityIterations,this.positionIterations);for(var o=0;o<t.length;o++){var r=t[o],i=r.transformComponent,n=i.transform,a=r.body.GetPosition(),s=a.get_x(),l=a.get_y();-10>l?r.removeFromWorld():(n.translation.x=s-r.box2DComponent.offsetX,n.translation.y=l-r.box2DComponent.offsetY,i.setRotation(0,0,r.body.GetAngle()),i.setUpdated())}},e}),define("goo/addons/cannon/CannonBoxColliderComponent",["goo/entities/components/Component","goo/shapes/Box","goo/math/Vector3"],function(t,e,o){"use strict";function r(t){this.type="CannonBoxColliderComponent",t=t||{};var e=this.halfExtents=t.halfExtents||new o(.5,.5,.5);this.cannonShape=new i.Box(new i.Vec3(e.x,e.y,e.z))}var i=window.CANNON;return r.prototype=Object.create(t.prototype),r.constructor=r,r}),define("goo/addons/cannon/CannonDistanceJointComponent",["goo/entities/components/Component","goo/util/ObjectUtil"],function(t,e){"use strict";function o(t){t=t||{},this.type="CannonDistanceJointComponent",e.defaults(t,{distance:1,connectedBody:null}),this.distance=t.distance,this.connectedBody=t.connectedBody,this.cannonConstraint=null}var r=window.CANNON;return o.prototype=Object.create(t.prototype),o.constructor=o,o.prototype.createConstraint=function(t){var e=t.cannonRigidbodyComponent.body,o=this.connectedBody.body;return this.cannonConstraint=new r.DistanceConstraint(e,o,this.distance),this.cannonConstraint},o}),define("goo/addons/cannon/CannonPlaneColliderComponent",["goo/entities/components/Component","goo/shapes/Box","goo/math/Vector3"],function(t){"use strict";function e(t){this.type="CannonPlaneColliderComponent",t=t||{},this.cannonShape=new o.Plane}var o=window.CANNON;return e.prototype=Object.create(t.prototype),e.constructor=e,e}),define("goo/addons/cannon/CannonRigidBodyComponent",["goo/entities/components/Component","goo/math/Quaternion","goo/math/Vector3","goo/math/Transform","goo/shapes/Box","goo/shapes/Sphere","goo/shapes/Quad","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a,s){"use strict";function l(t){t=t||{},this.type="CannonRigidbodyComponent",s.defaults(t,{mass:1,velocity:new o}),this.mass=t.mass,this._initialized=!1,this._quat=new e,this._initialVelocity=new o,this._initialVelocity.setv(t.velocity),this.api={setForce:function(t){l.prototype.setForce.call(this,t)}.bind(this),setVelocity:function(t){l.prototype.setVelocity.call(this,t)}.bind(this),setPosition:function(t){l.prototype.setPosition.call(this,t)}.bind(this),setAngularVelocity:function(t){l.prototype.setAngularVelocity.call(this,t)}.bind(this)}}var h=window.CANNON;return l.prototype=Object.create(t.prototype),l.constructor=l,l.prototype.setForce=function(t){this.body.force.set(t.x,t.y,t.z)
},l.prototype.setVelocity=function(t){this.body.velocity.set(t.x,t.y,t.z)},l.prototype.setPosition=function(t){this.body.position.set(t.x,t.y,t.z)},l.prototype.setAngularVelocity=function(t){this.body.angularVelocity.set(t.x,t.y,t.z)},l.getCollider=function(t){return t.cannonBoxColliderComponent||t.cannonPlaneColliderComponent||t.cannonSphereColliderComponent||null},l.prototype.createShape=function(t){var e,o=l.getCollider(t);if(o)e=o.cannonShape;else{e=new h.Compound;var i=t.transformComponent.worldTransform,n=new r;n.copy(i),n.invert(n);var a=this;t.traverse(function(t){var o=l.getCollider(t);if(o){var r=t.transformComponent.transform,i=r.translation,n=r.rotation,s=new h.Vec3(i.x,i.y,i.z),d=a._quat;d.fromRotationMatrix(n);var c=new h.Quaternion(d.x,d.y,d.z,d.w);e.addChild(o.cannonShape,s,c)}})}return e},l}),define("goo/addons/cannon/CannonSphereColliderComponent",["goo/entities/components/Component"],function(t){"use strict";function e(t){t=t||{},this.type="CannonSphereColliderComponent",this.radius=t.radius||.5,this.cannonShape=new o.Sphere(this.radius)}var o=window.CANNON;return e.prototype=Object.create(t.prototype),e.constructor=e,e}),define("goo/addons/cannon/CannonSystem",["goo/entities/systems/System","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/math/Quaternion","goo/math/Transform","goo/math/Vector3","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a){"use strict";function s(e){t.call(this,"CannonSystem",["CannonRigidbodyComponent","TransformComponent"]),e=e||{},a.defaults(e,{gravity:new n(0,-10,0),stepFrequency:60,broadphase:"naive"});var o=this.world=new l.World;o.gravity.x=e.gravity.x,o.gravity.y=e.gravity.y,o.gravity.z=e.gravity.z,this.setBroadphaseAlgorithm(e.broadphase),this.stepFrequency=e.stepFrequency,this._quat=new r}var l=window.CANNON;return s.prototype=Object.create(t.prototype),s.prototype.inserted=function(t){var e=t.cannonRigidbodyComponent,o=t.transformComponent,r=e.createShape(t);if(!r)return void t.clearComponent("CannonComponent");var i=new l.RigidBody(e.mass,r);e.body=i,t.setPosition(o.transform.translation),t.setVelocity(e._initialVelocity);var n=this._quat;n.fromRotationMatrix(o.transform.rotation),i.quaternion.set(n.x,n.y,n.z,n.w),this.world.add(i);var a=t.cannonDistanceJointComponent;a&&this.world.addConstraint(a.createConstraint(t))},s.prototype.deleted=function(t){var e=t.cannonRigidbodyComponent;e&&this.world.remove(e.body)},s.prototype.process=function(t){this.world.step(1/this.stepFrequency);for(var e=0;e<t.length;e++){var o=t[e],r=o.cannonRigidbodyComponent,i=r.body.position;o.transformComponent.setTranslation(i.x,i.y,i.z);var n=r.body.quaternion;this._quat.set(n.x,n.y,n.z,n.w),o.transformComponent.transform.rotation.copyQuaternion(this._quat),o.transformComponent.setUpdated()}},s.prototype.setBroadphaseAlgorithm=function(t){var e=this.world;switch(t){case"naive":e.broadphase=new l.NaiveBroadphase;break;case"sap":e.broadphase=new l.SAPBroadphase(e);break;default:throw new Error("Broadphase not supported: "+t)}},s}),define("goo/addons/howler/components/HowlerComponent",["goo/entities/components/Component"],function(t){"use strict";function e(){this.type="HowlerComponent",this.sounds=[]}return e.prototype=Object.create(t.prototype),e.prototype.addSound=function(t){-1===this.sounds.indexOf(t)&&this.sounds.push(t)},e.prototype.playSound=function(t,e,o){this.sounds[t].play(e,o)},e.prototype.getSound=function(t){return this.sounds[t]},e}),define("goo/addons/howler/systems/HowlerSystem",["goo/entities/systems/System","goo/math/Vector3","goo/renderer/Renderer"],function(t,e,o){"use strict";function r(e){t.call(this,"HowlerSystem",["HowlerComponent"]),this.settings=e||{},this.settings.scale=this.settings.scale||.1,this.entities=[]}return r.prototype=Object.create(t.prototype),r.prototype.deleted=function(t){var e=t.howlerComponent;if(e&&e.sounds)for(var o=e.sounds,r=0;r<o.length;r++)o[r].stop()},r.prototype.process=function(t){this.entities=t;for(var r=0;r<t.length;r++){var i=t[r],n=i.howlerComponent,a=n.sounds,s=new e;if(s.copy(i.transformComponent.transform.translation),o.mainCamera)for(var l=o.mainCamera.getViewMatrix().applyPostPoint(s),h=0;h<a.length;h++)a[h].pos3d(l.data[0]*this.settings.scale,l.data[1]*this.settings.scale,l.data[2]*this.settings.scale)}},r}),define("goo/addons/p2/P2Component",["goo/entities/components/Component"],function(t){"use strict";function e(t){this.type="P2Component",this.settings=t||{},this.mass=void 0!==t.mass?t.mass:0,this.linearDamping=void 0!==t.linearDamping?t.linearDamping:0,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:0,this.shapes=void 0!==t.shapes?t.shapes:[],this.scale=void 0!==t.scale?t.scale:1,this.offsetX=void 0!==t.offsetX?t.offsetX:0,this.offsetY=void 0!==t.offsetY?t.offsetY:0,this.offsetZ=void 0!==t.offsetZ?t.offsetZ:0,this.offsetAngleX=void 0!==t.offsetAngleX?t.offsetAngleX:0,this.offsetAngleY=void 0!==t.offsetAngleY?t.offsetAngleY:0,this.offsetAngleZ=void 0!==t.offsetAngleZ?t.offsetAngleZ:0}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e}),define("goo/addons/p2/P2System",["goo/entities/systems/System"],function(t){"use strict";function e(e){t.call(this,"P2System",["P2Component","TransformComponent"]),e=e||{},this.world=new r.World({gravity:e.gravity||[0,-9.82]}),this.stepFrequency=e.stepFrequency||60}function o(t,e){var o=e.body.position,r=e.scale;t.transform.translation.setd(o[0]*r,o[1]*r,0),t.transform.rotation.fromAngles(e.offsetAngleX,e.offsetAngleY,e.offsetAngleZ+e.body.angle),t.setUpdated()}var r=window.p2;return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.inserted=function(t){for(var e=t.p2Component,i=t.transformComponent,n=new r.Body({mass:e.mass,damping:e.damping,angularDamping:e.angularDamping}),n=e.body=new r.Body({mass:e.mass,position:[i.transform.translation.x,i.transform.translation.y]}),a=0;a<e.shapes.length;a++){var s,l=e.shapes[a];switch(l.type){case"box":s=new r.Rectangle(l.width,l.height);break;case"circle":s=new r.Circle(l.radius);break;case"plane":s=new r.Plane;break;default:throw new Error("p2 shape '"+l.type+"' not recognized")}n.addShape(s,l.offset,l.angle)}e.body=n,o(i,e),this.world.addBody(n)},e.prototype.deleted=function(t){var e=t.p2Component;e&&this.world.removeBody(e.body)},e.prototype.process=function(t){this.world.step(1/this.stepFrequency);for(var e=0;e<t.length;e++){var r=t[e],i=r.p2Component;o(r.transformComponent,i)}},e}),define("goo/addons/scripts/PolyBoundingScript",[],function(){"use strict";function t(t){this.collidables=t||[]}return t.prototype.addCollidable=function(t){this.collidables.push(t)},t.prototype.removeAllAt=function(t,e,o){this.collidables=this.collidables.filter(function(r){return r.bottom<=o&&r.top>=o?!window.PolyK.ContainsPoint(r.poly,t,e):void 0})},t.prototype.inside=function(t,e,o){for(var r=0;r<this.collidables.length;r++){var i=this.collidables[r];if(i.bottom<=e&&i.top>=e&&window.PolyK.ContainsPoint(i.poly,t,o))return window.PolyK.ClosestEdge(i.poly,t,o)}},t.prototype.run=function(t){for(var e=t.transformComponent,o=e.transform.translation,r=0;r<this.collidables.length;r++){var i=this.collidables[r];if(i.bottom<=o.data[1]&&i.top>=o.data[1]&&window.PolyK.ContainsPoint(i.poly,o.data[0],o.data[2])){var n=window.PolyK.ClosestEdge(i.poly,o.data[0],o.data[2]);return o.data[0]=n.point.x,o.data[2]=n.point.y,void e.setUpdated()}}},t}),define("goo/addons/soundmanager2/components/SoundManager2Component",["goo/entities/components/Component"],function(t){"use strict";function e(t){this.type="SoundManager2Component",this.settings=t||{},this.sounds={}}return e.prototype=Object.create(t.prototype),e.prototype.addSound=function(t,e){this.sounds[t]=e},e.prototype.playSound=function(t){this.sounds[t].soundObject.play()},e}),define("goo/addons/soundmanager2/systems/SoundManager2System",["goo/entities/systems/System"],function(t){"use strict";function e(e){t.call(this,"SoundManager2System",["SoundManager2Component","TransformComponent"]),e=e||{},this.isReady=!1,window.soundManager?window.soundManager.bind(this).setup({url:"swf",onready:function(){this.isReady=!0},ontimeout:function(){console.warn("Failed to load soundmanager")}}):console.warn("SoundManager2System: soundManager global not found")}return e.prototype=Object.create(t.prototype),e.prototype.inserted=function(t){for(var e=t.soundManager2Component,o=0;o<e.sounds.length;o++){var r=e.sounds[o],i=window.soundManager.createSound(r);r.soundObject=i}},e.prototype.deleted=function(){},e.prototype.process=function(){},e}),define("goo/util/MeshBuilder",["goo/renderer/MeshData","goo/math/Vector3","goo/entities/EntityUtils"],function(t,e,o){"use strict";function r(){this.meshDatas=[],this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]}r.prototype.addEntity=function(t){o.traverse(t,function(t){t.transformComponent._dirty&&t.transformComponent.updateTransform()}),o.traverse(t,function(t){t.transformComponent._dirty&&o.updateWorldTransform(t.transformComponent)}),o.traverse(t,function(t){t.meshDataComponent&&this.addMeshData(t.meshDataComponent.meshData,t.transformComponent.worldTransform)})};var i=new e;return r.prototype.addMeshData=function(e,o){if(e.vertexCount>=65536)throw new Error("Maximum number of vertices for a mesh to add is 65535. Got: "+e.vertexCount);this.vertexCounter+e.vertexCount>=65536&&this._generateMesh();for(var r=o.matrix,n=o.rotation,a=e.attributeMap,s=Object.keys(a),l=0,h=s.length;h>l;l++){var d=s[l],c=a[d],u=this.vertexData[d];u||(this.vertexData[d]={},u=this.vertexData[d],u.array=[],u.map={count:c.count,type:c.type,stride:c.stride,offset:c.offset,normalized:c.normalized});var p=e.getAttributeBuffer(d),m=p.length,f=u.array,g=c.count,v=this.vertexCounter*g;if(d===t.POSITION)for(var y=0;m>y;y+=g)i.setd(p[y+0],p[y+1],p[y+2]),r.applyPostPoint(i),f[v+y+0]=i.data[0],f[v+y+1]=i.data[1],f[v+y+2]=i.data[2];else if(d===t.NORMAL)for(var y=0;m>y;y+=g)i.setd(p[y+0],p[y+1],p[y+2]),n.applyPost(i),f[v+y+0]=i.data[0],f[v+y+1]=i.data[1],f[v+y+2]=i.data[2];else if(d===t.TANGENT)for(var y=0;m>y;y+=g)i.setd(p[y+0],p[y+1],p[y+2]),n.applyPost(i),f[v+y+0]=i.data[0],f[v+y+1]=i.data[1],f[v+y+2]=i.data[2],f[v+y+3]=p[y+3];else for(var y=0;m>y;y++)f[v+y]=p[y]}for(var x=e.getIndexBuffer(),y=0,h=e.indexCount;h>y;y++)this.indexData[this.indexCounter+y]=x[y]+this.vertexCounter;this.vertexCounter+=e.vertexCount,this.indexCounter+=e.indexCount,this.indexLengths=this.indexLengths.concat(e.indexLengths?e.indexLengths:e.getIndexBuffer().length),this.indexModes=this.indexModes.concat(e.indexModes)},r.prototype._generateMesh=function(){var e={};for(var o in this.vertexData){var r=this.vertexData[o];e[o]=r.map}var i=new t(e,this.vertexCounter,this.indexCounter);for(var o in this.vertexData){var r=this.vertexData[o].array;i.getAttributeBuffer(o).set(r)}i.getIndexBuffer().set(this.indexData),i.indexLengths=this.indexLengths,i.indexModes=this.indexModes;for(var n=i.indexModes[0],a=0,s=[],l=[],h=0;h<i.indexModes.length;h++){var d=i.indexModes[h];n!==d&&(s.push(n),l.push(a),n=d,a=0),a+=i.indexLengths[h],h===i.indexModes.length-1&&(s.push(d),l.push(a),n=d,a=0)}i.indexLengths=l,i.indexModes=s,this.meshDatas.push(i),this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]},r.prototype.build=function(){return this.vertexCounter>0&&this._generateMesh(),this.meshDatas},r.prototype.reset=function(){this.meshDatas=[],this.vertexData={},this.indexData=[],this.vertexCounter=0,this.indexCounter=0,this.indexLengths=[],this.indexModes=[]},r}),define("goo/noise/Noise",["goo/math/MathUtils"],function(t){"use strict";function e(){}return e.shifter=[37,91,12,128,216,96,51,153,39,231,223,180,160,157,135,179,74,50,205,151,4,213,196,58,212,120,53,45,10,195,137,159,103,144,109,170,202,48,121,13,245,68,232,28,210,174,197,80,107,206,156,116,155,240,162,79,41,59,147,117,0,242,118,164,129,101,98,126,214,105,89,26,130,254,85,199,8,165,76,75,187,166,64,143,217,149,78,7,172,230,87,119,42,247,84,139,16,141,134,86,154,71,253,60,99,235,168,30,34,55,113,140,191,69,31,106,40,82,73,33,81,14,234,131,255,88,169,136,248,148,220,138,219,102,44,127,36,200,95,208,54,152,47,20,23,15,52,123,177,224,122,171,215,173,211,188,190,133,244,167,236,35,63,145,221,104,65,24,70,100,56,150,49,77,110,228,112,209,198,1,237,185,250,225,93,201,124,108,218,72,243,21,22,6,114,38,125,29,66,249,222,111,241,11,186,61,176,183,17,163,229,161,57,238,227,132,67,83,207,226,46,189,115,193,194,233,182,192,18,27,25,2,3,252,97,62,184,239,175,92,246,142,251,204,203,32,146,90,19,9,178,158,181,94,43,5],e.split=function(e){var o=Math.floor(e),r=t.scurve5(e-o);return{i0:o+0,i1:o+1,f0:1-r,f1:0+r}},e.fractal1d=function(t,e,o,r,i,n){for(var a=0,s=1,l=0,h=0;o>h;h++)a+=s*n.evaluate1d(t,e),l+=s,s*=r,t*=i;return a/l},e.fractal2d=function(t,e,o,r,i,n,a){for(var s=0,l=1,h=0,d=0;r>d;d++)s+=l*a.evaluate2d(t,e,o),h+=l,l*=i,t*=n,e*=n;return s/h},e.fractal3d=function(t,e,o,r,i,n,a,s){for(var l=0,h=1,d=0,c=0;i>c;c++)l+=h*s.evaluate3d(t,e,o,r),d+=h,h*=n,t*=a,e*=a,o*=a;return l/d},e.fractal4d=function(t,e,o,r,i,n,a,s,l){for(var h=0,d=1,c=0,u=0;n>u;u++)h+=d*l.evaluate4d(t,e,o,r,i),c+=d,d*=a,t*=s,e*=s,o*=s,r*=s;return h/c},e}),define("goo/noise/ValueNoise",["goo/noise/Noise"],function(t){"use strict";function e(){t.call(this)}return e.prototype=Object.create(t.prototype),e.sources=[0,1/15,2/15,.2,4/15,5/15,.4,7/15,8/15,.6,10/15,11/15,.8,13/15,14/15,1],e.evaluate1d=function(o,r){var i=t.split(o/r),n=15&t.shifter[255&i.i0],a=15&t.shifter[255&i.i1],s=0;return s+=i.f0*e.sources[n],s+=i.f1*e.sources[a]},e.evaluate2d=function(o,r,i){var n=t.split(o/i),a=t.split(r/i),s=15&t.shifter[t.shifter[255&a.i0]+n.i0&255],l=15&t.shifter[t.shifter[255&a.i0]+n.i1&255],h=15&t.shifter[t.shifter[255&a.i1]+n.i0&255],d=15&t.shifter[t.shifter[255&a.i1]+n.i1&255],c=0;return c+=a.f0*n.f0*e.sources[s],c+=a.f0*n.f1*e.sources[l],c+=a.f1*n.f0*e.sources[h],c+=a.f1*n.f1*e.sources[d]},e.evaluate3d=function(o,r,i,n){var a=t.split(o/n),s=t.split(r/n),l=t.split(i/n),h=15&t.shifter[t.shifter[t.shifter[255&l.i0]+s.i0&255]+a.i0&255],d=15&t.shifter[t.shifter[t.shifter[255&l.i0]+s.i0&255]+a.i1&255],c=15&t.shifter[t.shifter[t.shifter[255&l.i0]+s.i1&255]+a.i0&255],u=15&t.shifter[t.shifter[t.shifter[255&l.i0]+s.i1&255]+a.i1&255],p=15&t.shifter[t.shifter[t.shifter[255&l.i1]+s.i0&255]+a.i0&255],m=15&t.shifter[t.shifter[t.shifter[255&l.i1]+s.i0&255]+a.i1&255],f=15&t.shifter[t.shifter[t.shifter[255&l.i1]+s.i1&255]+a.i0&255],g=15&t.shifter[t.shifter[t.shifter[255&l.i1]+s.i1&255]+a.i1&255],v=0;return v+=l.f0*s.f0*a.f0*e.sources[h],v+=l.f0*s.f0*a.f1*e.sources[d],v+=l.f0*s.f1*a.f0*e.sources[c],v+=l.f0*s.f1*a.f1*e.sources[u],v+=l.f1*s.f0*a.f0*e.sources[p],v+=l.f1*s.f0*a.f1*e.sources[m],v+=l.f1*s.f1*a.f0*e.sources[f],v+=l.f1*s.f1*a.f1*e.sources[g]},e.evaluate4d=function(o,r,i,n,a){var s=t.split(o/a),l=t.split(r/a),h=t.split(i/a),d=t.split(n/a),c=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i0&255]+l.i0&255]+s.i0&255],u=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i0&255]+l.i0&255]+s.i1&255],p=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i0&255]+l.i1&255]+s.i0&255],m=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i0&255]+l.i1&255]+s.i1&255],f=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i1&255]+l.i0&255]+s.i0&255],g=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i1&255]+l.i0&255]+s.i1&255],v=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i1&255]+l.i1&255]+s.i0&255],y=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i0]+h.i1&255]+l.i1&255]+s.i1&255],x=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i0&255]+l.i0&255]+s.i0&255],w=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i0&255]+l.i0&255]+s.i1&255],_=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i0&255]+l.i1&255]+s.i0&255],b=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i0&255]+l.i1&255]+s.i1&255],S=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i1&255]+l.i0&255]+s.i0&255],M=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i1&255]+l.i0&255]+s.i1&255],C=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i1&255]+l.i1&255]+s.i0&255],P=15&t.shifter[t.shifter[t.shifter[t.shifter[255&d.i1]+h.i1&255]+l.i1&255]+s.i1&255],T=0;return T+=d.f0*h.f0*l.f0*s.f0*e.sources[c],T+=d.f0*h.f0*l.f0*s.f1*e.sources[u],T+=d.f0*h.f0*l.f1*s.f0*e.sources[p],T+=d.f0*h.f0*l.f1*s.f1*e.sources[m],T+=d.f0*h.f1*l.f0*s.f0*e.sources[f],T+=d.f0*h.f1*l.f0*s.f1*e.sources[g],T+=d.f0*h.f1*l.f1*s.f0*e.sources[v],T+=d.f0*h.f1*l.f1*s.f1*e.sources[y],T+=d.f1*h.f0*l.f0*s.f0*e.sources[x],T+=d.f1*h.f0*l.f0*s.f1*e.sources[w],T+=d.f1*h.f0*l.f1*s.f0*e.sources[_],T+=d.f1*h.f0*l.f1*s.f1*e.sources[b],T+=d.f1*h.f1*l.f0*s.f0*e.sources[S],T+=d.f1*h.f1*l.f0*s.f1*e.sources[M],T+=d.f1*h.f1*l.f1*s.f0*e.sources[C],T+=d.f1*h.f1*l.f1*s.f1*e.sources[P]},e}),define("goo/shapes/TerrainSurface",["goo/renderer/MeshData","goo/math/MathUtils"],function(t,e){"use strict";function o(e,o,r,i){for(var n=[],a=0;a<e.length;a++)for(var s=0;s<e[a].length;s++)n.push(a*o/(e.length-1),e[a][s]*r,s*i/(e.length-1));this.verts=n,this.vertsPerLine=e[0].length;var l=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]),h=this.verts.length/3,d=h/this.vertsPerLine;t.call(this,l,h,(d-1)*(this.vertsPerLine-1)*6),this.rebuild()}return o.prototype=Object.create(t.prototype),o.prototype.rebuild=function(){this.getAttributeBuffer(t.POSITION).set(this.verts);for(var o=[],r=[],i=[],n=this.verts.length/3,a=n/this.vertsPerLine,s=0;a-1>s;s++){for(var l=0;l<this.vertsPerLine-1;l++){var h=(s+0)*this.vertsPerLine+(l+0),d=(s+1)*this.vertsPerLine+(l+0),c=(s+1)*this.vertsPerLine+(l+1),u=(s+0)*this.vertsPerLine+(l+1);o.push(d,h,u,d,u,c),i=e.getTriangleNormal(this.verts[3*h+0],this.verts[3*h+1],this.verts[3*h+2],this.verts[3*u+0],this.verts[3*u+1],this.verts[3*u+2],this.verts[3*d+0],this.verts[3*d+1],this.verts[3*d+2]),r.push(i[0],i[1],i[2])}r.push(i[0],i[1],i[2])}s--;for(var l=0;l<this.vertsPerLine-1;l++){var h=(s+0)*this.vertsPerLine+(l+0),d=(s+1)*this.vertsPerLine+(l+0),u=(s+0)*this.vertsPerLine+(l+1);i=e.getTriangleNormal(this.verts[3*h+0],this.verts[3*h+1],this.verts[3*h+2],this.verts[3*u+0],this.verts[3*u+1],this.verts[3*u+2],this.verts[3*d+0],this.verts[3*d+1],this.verts[3*d+2]),r.push(i[0],i[1],i[2])}r.push(i[0],i[1],i[2]),this.getAttributeBuffer(t.NORMAL).set(r),this.getIndexBuffer().set(o);for(var p=[],m=this.verts[this.verts.length-3],f=this.verts[this.verts.length-1],s=0;s<this.verts.length;s+=3){var g=this.verts[s+0]/m,v=this.verts[s+2]/f;p.push(g,v)}return this.getAttributeBuffer(t.TEXCOORD0).set(p),this},o}),define("goo/loaders/handlers/ComponentHandler",["goo/util/PromiseUtil"],function(t){"use strict";function e(t,e,o,r){this.world=t,this.getConfig=e,this.updateObject=o,this.loadObject=r}return e.prototype._prepare=function(){},e.prototype._create=function(){throw new Error("ComponentHandler._create is abstract, use ComponentHandler.getHandler(type)")},e.prototype._remove=function(t){t.clearComponent(this._type)},e.prototype._load=function(t,e){return this.loadObject(t,e)},e.prototype.update=function(e,o){if(!e)return t.createDummyPromise(null,"Entity is missing");if(!o)return this._remove(e),t.createDummyPromise();var r=e.getComponent(this._type);return r||(r=this._create(),e.setComponent(r)),this._prepare(o),t.createDummyPromise(r)},e.handlerClasses={},e.getHandler=function(t){return e.handlerClasses[t]},e._registerClass=function(t,o){e.handlerClasses[t]=o},e}),define("goo/loaders/handlers/CameraComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/CameraComponent","goo/renderer/Camera","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n){"use strict";function a(){t.apply(this,arguments),this._type="CameraComponent"}return a.prototype=Object.create(t.prototype),t._registerClass("camera",a),a.prototype.constructor=a,a.prototype._prepare=function(t){n.defaults(t,{near:1,far:1e4,projectionMode:"Perspective",aspect:1,lockedRatio:!1}),"Perspective"===t.projectionMode&&void 0===t.fov&&(t.fov=45),"Parallel"===t.projectionMode&&void 0===t.size&&(t.size=100),"Perspective"!==t.projectionMode&&"Parallel"!==t.projectionMode&&(t.projectionMode="Perspective")},a.prototype._create=function(){var t=new o(45,1,1,1e3),r=new e(t);return r},a.prototype.update=function(e,r,i){return t.prototype.update.call(this,e,r,i).then(function(t){if(t){if(t.camera.setProjectionMode(o[r.projectionMode]),t.camera.lockedRatio=r.lockedRatio||!1,"Perspective"===r.projectionMode)t.camera.setFrustumPerspective(r.fov,r.aspect||1,r.near,r.far);else{var e=r.size;t.camera.setFrustum(r.near,r.far,-e,e,e,-e,r.aspect||1),t.camera.size=e}return t}})},a}),define("goo/loaders/handlers/EntityHandler",["goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/ComponentHandler","goo/util/rsvp","goo/util/StringUtil","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/entities/EntityUtils"],function(t,e,o,r,i,n,a){"use strict";function s(){t.apply(this,arguments),this._componentHandlers={}}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("entity",s),s.prototype._create=function(){return this.world.createEntity()},s.prototype._remove=function(t){var e=this._objects[t];e&&(e.removeFromWorld(),delete this._objects[t])},s.prototype._update=function(e,o,r){var n=this;return t.prototype._update.call(this,e,o,r).then(function(t){if(t){t.id=e,t.name=o.name,t.static=!!o.static;var s=[];for(var l in o.components)if(o.components[l]){var h=n._updateComponent(t,l,o.components[l],r);h?s.push(h):console.error("Error handling component "+l)}for(var d=t._components,c=0;c<d.length;c++){var l=n._getComponentType(d[c]);o.components[l]||n._updateComponent(t,l,null,r)}return i.optimisticAll(s).then(function(){return o.hidden?a.hide(t):a.show(t),t})}})},s.prototype._updateComponent=function(t,e,o,r){var i=this._getHandler(e);if(!i)return null;var n=i.update(t,o,r);return n&&n.then?n:null},s.prototype._getComponentType=function(t){var e=t.type;return e=e.slice(0,e.lastIndexOf("Component")),e=r.uncapitalize(e),"howler"===e&&(e="sound"),e},s.prototype._getHandler=function(t){if(!this._componentHandlers[t]){var o=e.getHandler(t);o&&(this._componentHandlers[t]=new o(this.world,this.getConfig,this.updateObject,this.loadObject))}return this._componentHandlers[t]},s}),define("goo/loaders/handlers/LightComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/LightComponent","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/light/DirectionalLight","goo/math/Vector","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a,s,l){"use strict";function h(){t.apply(this,arguments),this._type="LightComponent"}return h.prototype=Object.create(t.prototype),h.prototype.constructor=h,t._registerClass("light",h),h.prototype._prepare=function(t){if(l.defaults(t,{direction:[0,0,0],color:[1,1,1],shadowCaster:!1,lightCookie:null}),"DirectionalLight"!==t.type&&(t.range=void 0!==t.range?t.range:1e3),t.shadowCaster){t.shadowSettings=t.shadowSettings||{},l.defaults(t.shadowSettings,{shadowType:"Basic",near:1,far:1e3,resolution:[512,512],darkness:.5});var e=t.shadowSettings;"Parallel"===e.projection?e.size=void 0!==e.size?e.size:400:e.fov=void 0!==e.fov?e.fov:55}},h.prototype._create=function(){return new e},h.prototype.update=function(e,a,s){var h=this,d={SpotLight:r,DirectionalLight:i,PointLight:o};return t.prototype.update.call(this,e,a,s).then(function(t){if(t){var e=t.light;e&&d[a.type]===e.constructor||(e=new d[a.type],t.light=e);for(var o in a){var r=a[o];if(e.hasOwnProperty(o))if("shadowSettings"===o)for(var o in r){var i=r[o];e.shadowSettings[o]instanceof n?e.shadowSettings[o].set(i):e.shadowSettings[o]=l.clone(i)}else e[o]instanceof n?e[o].set(r):e[o]=l.clone(r)}if("PointLight"===a.type&&(e.shadowCaster=!1),a.lightCookie&&"PointLight"!==a.type){var c=a.lightCookie;return c=c.enabled?c.textureRef:c,h._load(c,s).then(function(o){return e.lightCookie=o,t})}return e.lightCookie=null,t}})},h}),define("goo/loaders/handlers/MaterialHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Material","goo/renderer/Util","goo/renderer/shaders/ShaderLib","goo/renderer/RenderQueue","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a,s){"use strict";function l(){t.apply(this,arguments)}return l.prototype=Object.create(t.prototype),l.prototype.constructor=l,t._registerClass("material",l),l.ENGINE_SHADER_PREFIX="GOO_ENGINE_SHADERS/",l.prototype._prepare=function(t){t.blendState||(t.blendState={}),s.defaults(t.blendState,{blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"}),t.cullState||(t.cullState={}),s.defaults(t.cullState,{enabled:!0,cullFace:"Back",frontFace:"CCW"}),t.depthState||(t.depthState={}),s.defaults(t.depthState,{enabled:!0,write:!0}),(null===t.renderQueue||void 0===t.renderQueue)&&(t.renderQueue=-1),(null===t.dualTransparency||void 0===t.dualTransparency)&&(t.dualTransparency=!1),(null===t.wireframe||void 0===t.wireframe)&&(t.wireframe=!1),(null===t.flat||void 0===t.flat)&&(t.flat=!1)},l.prototype._create=function(){return new e},l.prototype._update=function(o,a,h){var d=this;return t.prototype._update.call(this,o,a,h).then(function(t){function o(e,o,r){return d._load(o,r).then(function(o){t.setTexture(e,o)}).then(null,function(t){throw new Error("Error loading texture: "+o+" - "+t)})}if(t){var c=[];s.extend(t.blendState,a.blendState),s.extend(t.cullState,a.cullState),s.extend(t.depthState,a.depthState),t.id=a.id,t.name=a.name,t.wireframe=a.wireframe,t.flat=a.flat,t.dualTransparency=a.dualTransparency,t.renderQueue=-1===a.renderQueue?"NoBlending"!==a.blendState.blending?i.TRANSPARENT:null:a.renderQueue,t.uniforms={};for(var u in a.uniforms)void 0===a.uniforms[u].enabled?t.uniforms[u]=s.clone(a.uniforms[u]):a.uniforms[u].enabled&&(t.uniforms[u]=s.clone(a.uniforms[u].value));var p=a.shaderRef;if(p)if(0===p.indexOf(l.ENGINE_SHADER_PREFIX)){var m=p.slice(l.ENGINE_SHADER_PREFIX.length);t.shader=e.createShader(r[m])}else{var f=d._load(p,h).then(function(e){t.shader=e}).then(null,function(t){throw new Error("Error loading shader: "+t)});c.push(f)}else t.shader=e.createShader(r.texturedLit,"DefaultShader");var g;for(var v in a.texturesMapping)g=a.texturesMapping[v],g&&g.textureRef&&g.enabled!==!1?c.push(o(v,g.textureRef,h)):t.removeTexture(v);for(var v in t._textureMaps)a.texturesMapping[v]||t.removeTexture(v);return n.all(c).then(function(){return t})}})},l}),define("goo/shapes/Disk",["goo/renderer/MeshData"],function(t){"use strict";function e(e,o,r){if(1===arguments.length&&arguments[0]instanceof Object){var i=arguments[0];e=i.nSegments,o=i.radius,r=i.pointiness}this.nSegments=e||8,this.radius=o||1,this.pointiness=r||0;var n=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,n,this.nSegments+1,3*this.nSegments),this.indexModes=["Triangles"],this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){for(var e=[],o=[],r=[],i=[],n=Math.atan2(this.radius,this.pointiness),a=2*Math.PI/this.nSegments,s=0,l=0;s<this.nSegments;s++,l+=a)e.push(Math.cos(l)*this.radius,Math.sin(l)*this.radius,0),o.push(Math.cos(l)*Math.cos(n),Math.sin(l)*Math.cos(n),Math.sin(n)),r.push(.5*Math.cos(l)+.5,.5*Math.sin(l)+.5),i.push(this.nSegments,s,(s+1)%this.nSegments);return e.push(0,0,this.pointiness),o.push(0,0,1),r.push(.5,.5),this.getAttributeBuffer(t.POSITION).set(e),this.getAttributeBuffer(t.NORMAL).set(o),this.getAttributeBuffer(t.TEXCOORD0).set(r),this.getIndexBuffer().set(i),this},e}),define("goo/shapes/Cone",["goo/renderer/MeshData"],function(t){"use strict";function e(e,o,r){if(1===arguments.length&&arguments[0]instanceof Object){var i=arguments[0];e=i.radialSamples,o=i.radius,r=i.height}this.radialSamples=e||8,this.radius=o||1,this.height="undefined"==typeof r?2:r;var n=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]);t.call(this,n,3*this.radialSamples+this.radialSamples+1,3*this.radialSamples*2),this.indexModes=["Triangles"],this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){for(var e=[],o=[],r=[],i=[],n=Math.atan2(this.radius,this.height),a=2*Math.PI/this.radialSamples,s=1/this.radialSamples,l=0,h=0,d=0;l<this.radialSamples;l++,h+=a,d+=s)e.push(0,0,this.height,Math.cos(h)*this.radius,Math.sin(h)*this.radius,0,Math.cos(h+a)*this.radius,Math.sin(h+a)*this.radius,0),o.push(0,0,1,Math.cos(h)*Math.cos(n),Math.sin(h)*Math.cos(n),Math.sin(n),Math.cos(h+a)*Math.cos(n),Math.sin(h+a)*Math.cos(n),Math.sin(n)),r.push(d+s/2,1,d,.5,d+s,.5),i.push(3*l+0,3*l+1,3*l+2);var c=3*l+0;e.push(0,0,0),o.push(0,0,-1),r.push(.25,.25);for(var l=1,h=0;l<=this.radialSamples-1;l++,h+=a)e.push(Math.cos(h)*this.radius,Math.sin(h)*this.radius,0),o.push(0,0,-1),r.push(.25*Math.cos(h)+.25,.25*Math.sin(h)+.25),i.push(c+l,c,c+l+1);return e.push(Math.cos(h)*this.radius,Math.sin(h)*this.radius,0),o.push(0,0,-1),r.push(.25*Math.cos(h)+.25,.25*Math.sin(h)+.25),i.push(c+this.radialSamples,c,c+1),this.getAttributeBuffer(t.POSITION).set(e),this.getAttributeBuffer(t.NORMAL).set(o),this.getAttributeBuffer(t.TEXCOORD0).set(r),this.getIndexBuffer().set(i),this},e}),define("goo/util/ShapeCreatorMemoized",["goo/shapes/Box","goo/shapes/Quad","goo/shapes/Sphere","goo/shapes/Cylinder","goo/shapes/Torus","goo/shapes/Disk","goo/shapes/Cone"],function(t,e,o,r,i,n,a){"use strict";function s(){}function l(t,e){var o=Object.keys(e),r=o.map(function(t){return t+""+e[t]}).join("");return t+r}function h(t,e,o){var r=l(t,e);if(d[r])return d[r];var i=o();return d[r]=i,i}var d={};return s.createQuad=function(t,o){var r=1,i=1,n=1,a=1;return o&&r===o.xExtent&&i===o.yExtent&&n===o.tileX&&a===o.tileY?o:h("quad",{},function(){return new e(r,i,n,a)})},s.createBox=function(e,o){var r=1,i=1,n=1,a=1,s=1;return o&&r===o.xExtent&&i===o.yExtent&&n===o.zExtent&&a===o.tileX&&s===o.tileY?o:h("box",{},function(){return new t(r,i,n,a,s)})},s.createSphere=function(t,e){t=t||{},t.zSamples=t.zSamples||8,t.radialSamples=t.radialSamples||8,t.textureMode=t.textureMode||"Projected";var r=1;return e&&t.zSamples===e.zSamples-1&&t.radialSamples===e.radialSamples&&t.textureMode===e.textureMode.name&&r===e.radius?e:h("sphere",t,function(){return new o(t.zSamples,t.radialSamples,r,t.textureMode)})},s.createCylinder=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8;var o=1;return e&&t.radialSamples===e.radialSamples&&o===e.radius?e:h("cylinder",t,function(){return new r(t.radialSamples,o)})},s.createTorus=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8,t.circleSamples=t.circleSamples||12,t.tubeRadius=t.tubeRadius||.2;var o=1;return e&&t.radialSamples===e._radialSamples&&t.circleSamples===e._circleSamples&&t.tubeRadius===e._tubeRadius&&o===e._centerRadius?e:new i(t.circleSamples,t.radialSamples,t.tubeRadius,o)},s.createDisk=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8,t.pointiness="undefined"==typeof t.pointiness?0:t.pointiness;var o=1;return e&&t.radialSamples===e.nSegments&&t.pointiness===e.pointiness&&o===e.radius?e:t.pointiness===Math.floor(t.pointiness)?h("disk",t,function(){return new n(t.radialSamples,o,t.pointiness)}):new n(t.radialSamples,o,t.pointiness)},s.createCone=function(t,e){t=t||{},t.radialSamples=t.radialSamples||8,t.height="undefined"==typeof t.height?0:t.height;var o=1;return e&&t.radialSamples===e.radialSamples&&t.height===e.height&&o===e.radius?e:t.height===Math.floor(t.height)?h("cone",t,function(){return new a(t.radialSamples,o,t.height)}):new a(t.radialSamples,o,t.height)},s}),define("goo/loaders/handlers/MeshDataComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/MeshDataComponent","goo/renderer/bounds/BoundingBox","goo/util/ShapeCreatorMemoized","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/util/StringUtil"],function(t,e,o,r,i,n,a,s){"use strict";
function l(){t.apply(this,arguments),this._type="MeshDataComponent"}return l.prototype=Object.create(t.prototype),l.prototype.constructor=l,t._registerClass("meshData",l),l.prototype._prepare=function(t){return a.defaults(t,{})},l.prototype._create=function(){return new e},l.prototype.update=function(e,n,a){var l=this;return t.prototype.update.call(this,e,n,a).then(function(t){if(t)if(n.shape){var e=r["create"+s.capitalize(n.shape)];if(e)return t.meshData=e(n.shapeOptions,t.meshData),t.autoCompute=!0,t}else if(n.meshRef){var h=[];return h.push(l._load(n.meshRef,a).then(function(e){if(t.meshData=e,e.boundingBox){var r=e.boundingBox.min,i=e.boundingBox.max,n=[i[0]-r[0],i[1]-r[1],i[2]-r[2]],a=[.5*(i[0]+r[0]),.5*(i[1]+r[1]),.5*(i[2]+r[2])],s=new o;s.xExtent=n[0]/2,s.yExtent=n[1]/2,s.zExtent=n[2]/2,s.center.seta(a),t.modelBound=s,t.autoCompute=!1}})),n.poseRef?h.push(l._load(n.poseRef,a).then(function(e){t.currentPose=e})):t.currentPose=null,i.all(h).then(function(){return t})}})},l}),define("goo/animation/Joint",["goo/math/Transform"],function(t){"use strict";function e(e){this._name=e,this._index=0,this._parentIndex=0,this._inverseBindPose=new t}return e.NO_PARENT=-32768,e}),define("goo/animation/SkeletonPose",["goo/math/Transform","goo/animation/Joint","goo/math/Matrix4x4"],function(t,e,o){"use strict";function r(e){this._skeleton=e,this._localTransforms=[],this._globalTransforms=[],this._matrixPalette=[],this._poseListeners=[];for(var r=this._skeleton._joints.length,i=0;r>i;i++)this._localTransforms[i]=new t;for(var i=0;r>i;i++)this._globalTransforms[i]=new t;for(var i=0;r>i;i++)this._matrixPalette[i]=new o;this.setToBindPose()}return r.prototype.setToBindPose=function(){for(var t=0;t<this._localTransforms.length;t++){this._localTransforms[t].matrix.copy(this._skeleton._joints[t]._inverseBindPose.matrix).invert();var r=this._skeleton._joints[t]._parentIndex;r!==e.NO_PARENT&&o.combine(this._skeleton._joints[r]._inverseBindPose.matrix,this._localTransforms[t].matrix,this._localTransforms[t].matrix)}this.updateTransforms()},r.prototype.updateTransforms=function(){for(var t=0;t<this._skeleton._joints.length;t++){var r=this._skeleton._joints[t]._parentIndex;r!==e.NO_PARENT?o.combine(this._globalTransforms[r].matrix,this._localTransforms[t].matrix,this._globalTransforms[t].matrix):this._globalTransforms[t].matrix.copy(this._localTransforms[t].matrix),o.combine(this._globalTransforms[t].matrix,this._skeleton._joints[t]._inverseBindPose.matrix,this._matrixPalette[t])}this.firePoseUpdated()},r.prototype.firePoseUpdated=function(){for(var t=this._poseListeners.length-1;t>=0;t--)this._poseListeners[t].poseUpdated(this)},r.prototype.clone=function(){return new r(this._skeleton)},r}),define("goo/loaders/handlers/MeshDataHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/MeshData","goo/renderer/BufferUtils","goo/animation/SkeletonPose","goo/util/PromiseUtil","goo/util/ArrayUtil"],function(t,e,o,r,i,n){"use strict";function a(){t.apply(this,arguments)}var s=4;return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("mesh",a),a.prototype._remove=function(t){delete this._objects[t]},a.prototype._update=function(t,e,o){if(!e)return this._remove(t),i.createDummyPromise();if(this._objects[t])return i.createDummyPromise(this._objects[t]);var r=this;return this.loadObject(e.binaryRef,o).then(function(t){if(!t)throw new Error("Binary mesh data was empty");var o=r._createMeshData(e,t);return r._fillMeshData(o,e,t),o})},a.prototype._createMeshData=function(t){var r="SkinnedMesh"===t.type,i=t.vertexCount;if(0===i)return null;var n=0;t.indexLengths?n=t.indexLengths.reduce(function(t,e){return t+e}):t.indices&&(n=t.indices.wordLength);var a={float32:"Float",uint8:"UnsignedByte",uint16:"UnsignedShort",uint32:"UnsignedInt"};"Trident"===o.browserType&&(a.uint8="UnsignedShort");var s={};for(var l in t.attributes){var h=t.attributes[l],d=h.value[2];s[l]=e.createAttribute(h.dimensions,a[d])}var c=new e(s,i,n);return c.type=r?e.SKINMESH:e.MESH,c},a.prototype._fillMeshData=function(t,o,r){var i=t.type===e.SKINMESH;for(var a in o.attributes)if("JOINTIDS"!==a){var l=o.attributes[a].value;t.getAttributeBuffer(a).set(n.getTypedArray(r,l))}if(i&&o.attributes.JOINTIDS){for(var h=t.getAttributeBuffer(e.JOINTIDS),d=n.getTypedArray(r,o.attributes.JOINTIDS.value),c=[],u=0,p=0;p<d.length;p++){var m=d[p];void 0===c[m]&&(c[m]=u++),h.set([c[m]],p)}for(var f=[],m=0;m<c.length;m++){var u=c[m];null!==u&&(f[u]=m)}t.paletteMap=f,t.weightsPerVertex=s}if(t.getIndexBuffer().set(n.getTypedArray(r,o.indices)),t.indexModes=o.indexModes.slice(),t.indexLengths=o.indexLengths.slice(),o.boundingVolume){if("BoundingBox"!==o.boundingVolume.type)throw new Error("Bounding volume was not BoundingBox");t.boundingBox={min:o.boundingVolume.min,max:o.boundingVolume.max}}return t},a}),define("goo/loaders/handlers/MeshRendererComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/MeshRendererComponent","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a){"use strict";function s(){t.apply(this,arguments),this._type="MeshRendererComponent"}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("meshRenderer",s),s.DEFAULT_MATERIAL=o.createMaterial(r.uber,"Default material"),s.prototype._prepare=function(t){return a.defaults(t,{cullMode:"Dynamic",castShadows:!0,receiveShadows:!0,reflectable:!0})},s.prototype._create=function(){return new e},s.prototype.update=function(e,o,r){var n=this;return t.prototype.update.call(this,e,o,r).then(function(t){if(t){t.cullMode=o.cullMode,t.castShadows=o.castShadows,t.receiveShadows=o.receiveShadows,t.isReflectable=o.reflectable;var e=o.materials;if(!e||!Object.keys(e).length){var l=t.materials.filter(function(t){return"gooSelectionIndicator"===t.name});return t.materials=[s.DEFAULT_MATERIAL].concat(l),t}var h=[];return a.forEach(e,function(t){h.push(n._load(t.materialRef,r))},null,"sortValue"),i.all(h).then(function(e){var o=t.materials.filter(function(t){return"gooSelectionIndicator"===t.name});return t.materials=e.concat(o),t})}})},s}),define("goo/loaders/handlers/SceneHandler",["goo/loaders/handlers/ConfigHandler","goo/entities/SystemBus","goo/util/ArrayUtil","goo/util/ObjectUtil","goo/util/rsvp"],function(t,e,o,r,i){"use strict";function n(){t.apply(this,arguments)}return n.prototype=Object.create(t.prototype),n.prototype.constructor=n,t._registerClass("scene",n),n.prototype._remove=function(t){var e=this._objects[t];if(e)for(var o=0;o<e.entities.length;o++)e.entities[o].removeFromWorld();delete this._objects[t]},n.prototype._create=function(){return{id:null,entities:{},posteffects:[],environment:null,initialCameraRef:null}},n.prototype._update=function(o,r,n){var a=this;return t.prototype._update.call(this,o,r,n).then(function(t){if(t){t.id=o;var s=[];return s.push(a._handleEntities(r,t,n)),r.posteffectsRef&&s.push(a._load(r.posteffectsRef,n)),r.environmentRef&&s.push(a._load(r.environmentRef,n)),n.scene&&n.scene.dontSetCamera||r.initialCameraRef&&r.initialCameraRef!==t.initialCameraRef&&s.push(a._load(r.initialCameraRef,n).then(function(o){o&&o.cameraComponent&&e.emit("goo.setCurrentCamera",{camera:o.cameraComponent.camera,entity:o}),t.initialCameraRef=r.initialCameraRef})),i.all(s).then(function(){return t})}})},n.prototype._handleEntities=function(t,e,o){var n=[],a=r.clone(t.entities),s=[];for(var l in e.entities)a[l]?delete a[l]:s[l]=l;for(var h in a)n.push(this._load(t.entities[h].entityRef,o));return i.all(n).then(function(t){for(var o=0;o<t.length;o++){var r=t[o];r.addToWorld(),e.entities[r.id]=r}for(var i in s)delete e.entities[i]})},n.prototype._handlePosteffects=function(t,e,o){return this._load(t.posteffectsRef,o)},n.prototype._handleEnvironment=function(t,e,o){return this._load(t.environmentRef,o)},n}),define("goo/loaders/handlers/ShaderHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderBuilder","goo/util/rsvp","goo/util/PromiseUtil"],function(t,e,o,r,i,n,a){"use strict";function s(){t.apply(this,arguments)}return s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("shader",s),s.prototype._remove=function(){},s.prototype._update=function(t,o,r){if(!o)return this._remove(t),a.createDummyPromise();if(!o.vshaderRef)return a.createDummyPromise(null,"Shader error, missing vertex shader ref");if(!o.fshaderRef)return a.createDummyPromise(null,"Shader error, missing fragment shader ref");var s=[this.loadObject(o.vshaderRef,r),this.loadObject(o.fshaderRef,r)];return n.all(s).then(function(r){var n=r[0],s=r[1];if(!n)return a.createDummyPromise(null,"Vertex shader",o.vshaderRef,"in shader",t,"not found");if(!s)return a.createDummyPromise(null,"Fragment shader",o.fshaderRef,"in shader",t,"not found");var l={defines:o.defines||{},attributes:o.attributes||{},uniforms:o.uniforms||{},vshader:n,fshader:s};if(o.processors){l.processors=[];for(var h=0;h<o.processors.length;h++){var d=o.processors[h];i[d]?l.processors.push(i[d].processor):console.error("Unknown processor "+d)}}return e.createShader(l,t)})},s}),define("goo/animation/Skeleton",["goo/animation/Joint"],function(t){"use strict";function e(t,e){this._name=t,this._joints=e}return e.prototype.clone=function(){for(var o=this._name,r=this._joints,i=[],n=0,a=r.length;a>n;n++){var s=r[n],l=s._name,h=new t(l);h._index=s._index,h._parentIndex=s._parentIndex,h._inverseBindPose.copy(s._inverseBindPose),h._inverseBindPose.update(),i[n]=h}return new e(o,i)},e}),define("goo/loaders/handlers/SkeletonHandler",["goo/loaders/handlers/ConfigHandler","goo/animation/Joint","goo/animation/Skeleton","goo/animation/SkeletonPose","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n){"use strict";function a(){t.apply(this,arguments)}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("skeleton",a),a.prototype._update=function(t,a){if(!this._objects[t]){if(!a)return i.createDummyPromise();var s=[];n.forEach(a.joints,function(t){var o=new e(t.name);o._index=t.index,o._parentIndex=t.parentIndex,o._inverseBindPose.matrix.data.set(t.inverseBindPose),s.push(o)},null,"index");var l=new o(a.name,s),h=new r(l);h.setToBindPose(),this._objects[t]=h}return i.createDummyPromise(this._objects[t])},a}),define("goo/loaders/handlers/TransformComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/TransformComponent","goo/math/MathUtils","goo/math/Quaternion","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/util/ArrayUtil","goo/util/rsvp"],function(t,e,o,r,i,n,a,s){"use strict";function l(){t.apply(this,arguments),this._type="TransformComponent"}return l.prototype=Object.create(t.prototype),l.prototype.constructor=l,t._registerClass("transform",l),l.prototype._prepare=function(t){return n.defaults(t,{translation:[0,0,0],rotation:[0,0,0],scale:[1,1,1]})},l.prototype._create=function(){return new e},l.prototype._remove=function(t){var e=t.transformComponent;e.transform.translation.setd(0,0,0),e.transform.setRotationXYZ(0,0,0),e.transform.scale.setd(1,1,1);for(var o=0;o<e.children.length;o++){var r=e.children[o];e.detachChild(r)}e.setUpdated()},l.prototype.update=function(e,r,i){function n(t,e){return a.loadObject(e,i).then(function(e){return e&&e.transformComponent?(t.attachChild(e.transformComponent),e.addToWorld()):console.error("Failed to add child to transform component"),t})}var a=this;return t.prototype.update.call(this,e,r,i).then(function(t){if(t){t.transform.translation.seta(r.translation),t.transform.setRotationXYZ(o.radFromDeg(r.rotation[0]),o.radFromDeg(r.rotation[1]),o.radFromDeg(r.rotation[2])),t.transform.scale.seta(r.scale);var e=[];if(r.children){for(var i=Object.keys(r.children),a=0;a<i.length;a++){var l=r.children[i[a]].entityRef;e.push(n(t,l))}for(var a=0;a<t.children.length;a++){var h=t.children[a],d=h.entity.id;r.children[d]||t.detachChild(h)}}else for(var a=0;a<t.children.length;a++){var h=t.children[a];t.detachChild(h)}return s.all(e).then(function(){return t.setUpdated(),t})}})},l}),define("goo/loaders/handlers/AnimationComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/AnimationComponent","goo/util/rsvp"],function(t,e,o){"use strict";function r(){t.apply(this,arguments),this._type="AnimationComponent"}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,t._registerClass("animation",r),r.prototype._create=function(){return new e},r.prototype.update=function(e,r,i){var n=this;return t.prototype.update.call(this,e,r,i).then(function(t){if(t){var e,a=[],s=r.poseRef;s&&(e=n._load(s,i).then(function(e){t._skeletonPose=e}),a.push(e));var l=r.layersRef;return l&&(e=n._load(l,i).then(function(e){t.layers=e,t._layersId=l}),a.push(e)),o.all(a).then(function(){return t})}})},r}),define("goo/animation/clip/AnimationClipInstance",["goo/entities/World"],function(t){"use strict";function e(){this._active=!0,this._loopCount=0,this._timeScale=1,this._startTime=0,this._prevClockTime=0,this._prevUnscaledClockTime=0,this._clipStateObjects={}}return e.prototype.setTimeScale=function(e,o){var o=o||t.time;if(this._active&&this._timeScale!==e)if(0!==this._timeScale&&0!==e){var r=o,i=r-this._startTime;i*=this._timeScale,i/=e,this._startTime=r-i}else if(0===this._timeScale){var r=o;this._startTime=r-this._prevUnscaledClockTime}this._timeScale=e},e.prototype.getApplyTo=function(t){var e=t._channelName,o=this._clipStateObjects[e];return o||(o=t.createStateDataObject(),this._clipStateObjects[e]=o),o},e.prototype.clone=function(){var t=new e;return t._active=this._active,t._loopCount=this._loopCount,t._timeScale=this._timeScale,t},e}),define("goo/animation/blendtree/ClipSource",["goo/math/MathUtils","goo/animation/clip/AnimationClipInstance"],function(t,e){"use strict";function o(t,o,r){this._clip=t,this._clipInstance=new e,this._filterChannels={},this._filter=null,this.setFilter(o,r),this._startTime=-1/0,this._endTime=1/0}return o.prototype.setFilter=function(t,e){if(t&&e){this._filter=["Exclude","Include"].indexOf(t)>-1?t:null;for(var o=0;o<e.length;o++)this._filterChannels[e[o]]=!0}else this._filter=null},o.prototype.setTime=function(e){var o=this._clipInstance;o._startTime||(o._startTime=e);var r,i;if(o._active){0!==o._timeScale?(o._prevUnscaledClockTime=e-o._startTime,r=o._timeScale*o._prevUnscaledClockTime,o._prevClockTime=r):r=o._prevClockTime;var n=Math.min(this._clip._maxTime,this._endTime),a=Math.max(this._startTime,0);if(i=n-a,-1===n)return!1;0!==n&&(-1===o._loopCount?0>r?(r*=-1,r%=i,r=i-r,r+=a):(r%=i,r+=a):o._loopCount>0&&i*o._loopCount>=Math.abs(r)&&(0>r?(r*=-1,r%=i,r=i-r,r+=a):(r%=i,r+=a)),(r>n||0>r)&&(r=t.clamp(r,0,n),o._active=!1)),this._clip.update(r,o)}return o._active},o.prototype.resetClips=function(t){this._clipInstance._startTime=t,this._clipInstance._active=!0},o.prototype.shiftClipTime=function(t){this._clipInstance._startTime+=t,this._clipInstance._active=!0},o.prototype.setTimeScale=function(t){this._clipInstance.setTimeScale(t)},o.prototype.isActive=function(){return this._clipInstance._active&&-1!==this._clip._maxTime},o.prototype.getSourceData=function(){if(!this._filter||!this._filterChannels)return this._clipInstance._clipStateObjects;var t=this._clipInstance._clipStateObjects,e={},o="Include"===this._filter;for(var r in t)void 0!==this._filterChannels[r]===o&&(e[r]=t[r]);return e},o.prototype.clone=function(){var t=new o(this._clip);t._clipInstance=this._clipInstance.clone(),t._filter=this._filter;for(var e in this._filterChannels)t._filterChannels[e]=this._filterChannels[e];return t._startTime=this._startTime,t._endTime=this._endTime,t},o}),define("goo/animation/clip/AbstractAnimationChannel",[],function(){"use strict";function t(t,e,o){this._blendType=o||"Linear",this._channelName=t,this._times=(e instanceof Array||e instanceof Float32Array)&&e.length?new Float32Array(e):[],this._lastStartFrame=0}return t.prototype.getSampleCount=function(){return this._times.length},t.prototype.getMaxTime=function(){return this._times.length?this._times[this._times.length-1]:0},t.prototype.updateSample=function(t,e){var o=this._times.length;if(o){var r=o-1;if(0>t||1===o)this.setCurrentSample(0,0,e);else if(t>=this._times[r])this.setCurrentSample(r,0,e);else{var i=0;if(t>=this._times[this._lastStartFrame]){i=this._lastStartFrame;for(var n=this._lastStartFrame;o-1>n&&!(this._times[n]>=t);n++)i=n}else for(var n=0;n<this._lastStartFrame&&!(this._times[n]>=t);n++)i=n;var a=(t-this._times[i])/(this._times[i+1]-this._times[i]);this.setCurrentSample(i,a,e),this._lastStartFrame=i}}},t}),define("goo/animation/clip/TransformChannel",["goo/animation/clip/AbstractAnimationChannel","goo/animation/clip/TransformData","goo/math/Quaternion","goo/math/Vector3"],function(t,e,o,r){"use strict";function i(e,i,n,a,s,l){if(t.call(this,e,i,l),n.length/4!==i.length||a.length/3!==i.length||s.length/3!==i.length)throw new Error("All provided arrays must be the same length (accounting for type)! Channel: "+e);this._rotations=new Float32Array(n),this._translations=new Float32Array(a),this._scales=new Float32Array(s),this.tmpVec=new r,this.tmpQuat=new o,this.tmpQuat2=new o}return i.prototype=Object.create(t.prototype),i.prototype.createStateDataObject=function(){return new e},i.prototype.setCurrentSample=function(t,e,r){var i=r,n=4*t,a=3*t,s=4*(t+1),l=3*(t+1);return 0===e?(i._rotation.data[0]=this._rotations[n+0],i._rotation.data[1]=this._rotations[n+1],i._rotation.data[2]=this._rotations[n+2],i._rotation.data[3]=this._rotations[n+3],i._translation.data[0]=this._translations[a+0],i._translation.data[1]=this._translations[a+1],i._translation.data[2]=this._translations[a+2],i._scale.data[0]=this._scales[a+0],i._scale.data[1]=this._scales[a+1],void(i._scale.data[2]=this._scales[a+2])):1===e?(i._rotation.data[0]=this._rotations[s+0],i._rotation.data[1]=this._rotations[s+1],i._rotation.data[2]=this._rotations[s+2],i._rotation.data[3]=this._rotations[s+3],i._translation.data[0]=this._translations[l+0],i._translation.data[1]=this._translations[l+1],i._translation.data[2]=this._translations[l+2],i._scale.data[0]=this._scales[l+0],i._scale.data[1]=this._scales[l+1],void(i._scale.data[2]=this._scales[l+2])):(i._rotation.data[0]=this._rotations[n+0],i._rotation.data[1]=this._rotations[n+1],i._rotation.data[2]=this._rotations[n+2],i._rotation.data[3]=this._rotations[n+3],this.tmpQuat.data[0]=this._rotations[s+0],this.tmpQuat.data[1]=this._rotations[s+1],this.tmpQuat.data[2]=this._rotations[s+2],this.tmpQuat.data[3]=this._rotations[s+3],i._rotation.equals(this.tmpQuat)||(o.slerp(i._rotation,this.tmpQuat,e,this.tmpQuat2),i._rotation.setv(this.tmpQuat2)),i._translation.data[0]=(1-e)*this._translations[a+0]+e*this._translations[l+0],i._translation.data[1]=(1-e)*this._translations[a+1]+e*this._translations[l+1],i._translation.data[2]=(1-e)*this._translations[a+2]+e*this._translations[l+2],i._scale.data[0]=(1-e)*this._scales[a+0]+e*this._scales[l+0],i._scale.data[1]=(1-e)*this._scales[a+1]+e*this._scales[l+1],void(i._scale.data[2]=(1-e)*this._scales[a+2]+e*this._scales[l+2]))},i.prototype.getData=function(t,o){var r=o?o:new e;return this.setCurrentSample(t,0,r),r},i}),define("goo/animation/clip/JointChannel",["goo/animation/clip/TransformChannel","goo/animation/clip/JointData"],function(t,e){"use strict";function o(e,o,r,i,n,a,s){t.call(this,o,r,i,n,a,s),this._jointName=o,this._jointIndex=e}return o.prototype=Object.create(t.prototype),o.JOINT_CHANNEL_NAME="_jnt",o.prototype.createStateDataObject=function(){return new e},o.prototype.setCurrentSample=function(e,o,r){t.prototype.setCurrentSample.call(this,e,o,r),r._jointIndex=this._jointIndex},o.prototype.getData=function(o,r){var i=r?r:new e;return t.prototype.getData.call(this,o,i),i._jointIndex=this._jointIndex,i},o}),define("goo/animation/blendtree/ManagedTransformSource",["goo/animation/clip/JointChannel","goo/animation/clip/JointData","goo/animation/clip/JointChannel","goo/animation/clip/JointData","goo/math/Vector3","goo/math/Quaternion"],function(t,e,o,r,i,n){"use strict";function a(t){this._sourceName=t?t:null,this._data={}}return a.prototype.setTranslation=function(t,e){var o=this._data[t];o instanceof r&&o._translation.setv(e)},a.prototype.getTranslation=function(t,e){var o=this._data[t];return o instanceof r&&(e=e||new i,e.setv(o._translation)),e},a.prototype.setScale=function(t,e){var o=this._data[t];o instanceof r&&o._scale.setv(e)},a.prototype.getScale=function(t,e){var o=this._data[t];return o instanceof r&&(e=e||new i,e.setv(o._scale)),e},a.prototype.setRotation=function(t,e){var o=this._data[t];o instanceof r&&o._rotation.set(e)},a.prototype.getRotation=function(t,e){var o=this._data[t];return o instanceof r&&(e=e||new n,e.setv(o._rotation)),e},a.prototype.initFromClip=function(t,e,o){if("Include"===e&&o&&o.length)for(var r=0,i=o.length;i>r;r++){var n=o[r],a=t.findChannelByName(n);if(a){var s=a.getData(0);this._data[n]=s}else console.error("Channel not in clip: "+n)}else for(var r=0,i=t._channels.length;i>r;r++){var a=t._channels[r],n=a._channelName;if("Exclude"===e&&o&&o.length&&o.indexOf(n)>-1){var s=a.getData(0);this._data[n]=s}}},a.prototype.resetClips=function(){},a.prototype.setTimeScale=function(){},a.prototype.setTime=function(){return!0},a.prototype.isActive=function(){return!0},a.prototype.getChannelData=function(t){return this._data[t]},a.prototype.getSourceData=function(){return this._data},a.prototype.clone=function(){var t={};for(var e in this._data)t[e]=this._data[e].clone();return new a(this._sourceName,t)},a}),define("goo/animation/blendtree/FrozenClipSource",[],function(){"use strict";function t(t,e){this._source=t,this._time=e}return t.prototype.getSourceData=function(){return this._source.getSourceData()},t.prototype.resetClips=function(){this._source.resetClips(0)},t.prototype.setTime=function(){return this._source.setTime(this._time),!0},t.prototype.isActive=function(){return!0},t.prototype.setTimeScale=function(){},t.prototype.clone=function(){var e=new t(this._source.clone(),this._time);return e},t}),define("goo/loaders/handlers/AnimationStateHandler",["goo/loaders/handlers/ConfigHandler","goo/animation/state/SteadyState","goo/animation/blendtree/ClipSource","goo/animation/blendtree/ManagedTransformSource","goo/animation/blendtree/BinaryLERPSource","goo/animation/blendtree/FrozenClipSource","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a,s,l){"use strict";function h(){t.apply(this,arguments)}return h.prototype=Object.create(t.prototype),h.prototype.constructor=h,t._registerClass("animstate",h),h.prototype._create=function(t){return this._objects[t]=new e},h.prototype._update=function(e,o,r){var i=this;return t.prototype._update.call(this,e,o,r).then(function(t){return t?(t._name=o.name,t.id=o.id,t._transitions=l.deepClone(o.transitions),i._parseClipSource(o.clipSource,t._sourceTree,r).then(function(e){return t._sourceTree=e,t})):void 0})},h.prototype._parseClipSource=function(t,e,l){switch(t.type){case"Clip":return this.loadObject(t.clipRef,l).then(function(r){return!e||!e instanceof o?e=new o(r,t.filter,t.channels):(e._clip=r,e.setFilter(t.filter,t.channels)),t.loopCount&&(e._clipInstance._loopCount=+t.loopCount),t.timeScale&&(e._clipInstance._timeScale=t.timeScale),e});case"Managed":return(!e||!e instanceof r)&&(e=new r),t.clipRef?this.loadObject(t.clipRef,l).then(function(o){return e.initFromClip(o,t.filter,t.channels),e}):s.createDummyPromise(e);case"Lerp":var h=[this._parseClipSource(t.clipSourceA,null,l),this._parseClipSource(t.clipSourceB,null,l)];return a.all(h).then(function(o){return e=new i(o[0],o[1]),t.blendWeight&&(e.blendWeight=t.blendWeight),e});case"Frozen":return this._parseClipSource(t.clipSource).then(function(o){return e&&e instanceof n?(e._source=o,e._time=t.frozenTime||0):e=new n(o,t.frozenTime||0),e});default:return console.error("Unable to parse clip source"),s.createDummyPromise()}},h}),define("goo/loaders/handlers/AnimationLayersHandler",["goo/loaders/handlers/ConfigHandler","goo/animation/layer/AnimationLayer","goo/animation/layer/LayerLERPBlender","goo/animation/state/FadeTransitionState","goo/animation/state/SyncFadeTransitionState","goo/animation/state/FrozenTransitionState","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n,a,s,l){"use strict";function h(){t.apply(this,arguments)}return h.prototype=Object.create(t.prototype),h.prototype.constructor=h,t._registerClass("animation",h),h.prototype._create=function(t){return this._objects[t]=[]},h.prototype._setInitialState=function(t,e){e&&t._steadyStates[e]?t._currentState!==t._steadyStates[e]&&t.setCurrentStateByName(e,!0):t.setCurrentState()},h.prototype._update=function(e,o,r){var i=this;return t.prototype._update.call(this,e,o,r).then(function(t){if(t){var e=[],n=0;return l.forEach(o.layers,function(o){e.push(i._parseLayer(o,t[n++],r))},null,"sortValue"),a.all(e).then(function(e){t.length=e.length;for(var o=0;o<e.length;o++)t[o]=e[o];return t})}})},h.prototype._parseLayer=function(t,o,r){var i=this;o?o._name=t.name:o=new e(t.name),o.id=t.id,o._transitions=l.deepClone(t.transitions),o._layerBlender&&(o._layerBlender._blendWeight=void 0!==t.blendWeight?t.blendWeight:1);var n=[];for(var s in t.states)n.push(this.loadObject(s,r).then(function(t){o._steadyStates[t.id]=t}));return a.all(n).then(function(){return i._setInitialState(o,t.initialStateRef),o})},h}),define("goo/animation/clip/AnimationClip",[],function(){"use strict";function t(t,e){this._name=t,this._channels=e||[],this._maxTime=-1,this.updateMaxTimeIndex()}return t.prototype.update=function(t,e){for(var o=0,r=this._channels.length;r>o;++o){var i=this._channels[o],n=e.getApplyTo(i);i.updateSample(t,n)}},t.prototype.addChannel=function(t){this._channels.push(t),this.updateMaxTimeIndex()},t.prototype.removeChannel=function(t){var e=this._channels.indexOf(t);return e>=0?(this._channels.splice(e,1),this.updateMaxTimeIndex(),!0):!1},t.prototype.findChannelByName=function(t){for(var e=0,o=this._channels.length;o>e;++e){var r=this._channels[e];if(t===r._channelName)return r}return null},t.prototype.updateMaxTimeIndex=function(){this._maxTime=-1;for(var t,e=0;e<this._channels.length;e++){var o=this._channels[e];t=o.getMaxTime(),t>this._maxTime&&(this._maxTime=t)}},t.prototype.toString=function(){return this._name+": "+this._channels.map(function(t){return t._channelName})},t}),define("goo/animation/clip/InterpolatedFloatChannel",["goo/animation/clip/AbstractAnimationChannel","goo/math/MathUtils"],function(t,e){"use strict";function o(e,o,r,i){t.call(this,e,o,i),this._values=r?r.slice(0):null}return o.prototype=Object.create(t.prototype),o.prototype.createStateDataObject=function(){return[0]},o.prototype.setCurrentSample=function(t,o,r){r[0]=e.lerp(o,this._values[t],this._values[t+1])},o.prototype.getData=function(t,e){var o=e||[];return o[0]=this._values[t],o},o}),define("goo/animation/clip/TriggerChannel",["goo/animation/clip/AbstractAnimationChannel","goo/animation/clip/TriggerData"],function(t,e){"use strict";function o(e,o,r,i){t.call(this,e,o,i),this._keys=r?r.slice(0):null,this.guarantee=!1}return o.prototype=Object.create(t.prototype),o.prototype.createStateDataObject=function(){return new e},o.prototype.setCurrentSample=function(t,e,o){var r=o._currentIndex,i=1!==e?t:t+1;if(r!==i&&this.guarantee){var n=[];if(r>i){for(var a=r+1;a<this._keys.length;a++)n.push(this._keys[a]);r=-1}for(var a=r+1;i>=a;a++)n.push(this._keys[a]);o.arm(i,n)}else o.arm(i,[this._keys[i]])},o}),define("goo/loaders/handlers/AnimationClipHandler",["goo/loaders/handlers/ConfigHandler","goo/animation/clip/AnimationClip","goo/animation/clip/JointChannel","goo/animation/clip/TransformChannel","goo/animation/clip/InterpolatedFloatChannel","goo/animation/clip/TriggerChannel","goo/util/PromiseUtil","goo/util/ArrayUtil"],function(t,e,o,r,i,n,a,s){"use strict";function l(){t.apply(this,arguments)}return l.prototype=Object.create(t.prototype),l.prototype.constructor=l,t._registerClass("clip",l),l.prototype._create=function(){return new e},l.prototype._update=function(e,o,r){var i=this;return t.prototype._update.call(this,e,o,r).then(function(t){return t?i.loadObject(o.binaryRef,r).then(function(e){if(!e)throw new Error("Binary clip data was empty");return i._updateAnimationClip(o,e,t)}):t})},l.prototype._updateAnimationClip=function(t,e,a){if(a._channels=[],t.channels)for(var l=Object.keys(t.channels),h=0;h<l.length;h++){var d,c=t.channels[l[h]],u=s.getTypedArray(e,c.times),p=c.blendType,m=c.type;switch(m){case"Joint":case"Transform":var f,g,v;f=s.getTypedArray(e,c.rotationSamples),g=s.getTypedArray(e,c.translationSamples),v=s.getTypedArray(e,c.scaleSamples),d="Joint"===m?new o(c.jointIndex,c.name,u,f,g,v,p):new r(c.name,u,f,g,v,p);break;case"FloatLERP":d=new i(c.name,u,c.values,p);break;case"Trigger":d=new n(c.name,u,c.keys),d.guarantee=!!c.guarantee;break;default:console.warn("Unhandled channel type: "+c.type);continue}a.addChannel(d)}return a},l}),define("goo/loaders/handlers/ProjectHandler",["goo/loaders/handlers/ConfigHandler"],function(t){"use strict";function e(){t.apply(this,arguments)}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,t._registerClass("project",e),e.prototype._remove=function(t,e){var o=this._objects[t];o&&this.updateObject(o.mainScene.id,null,e)},e.prototype._create=function(){return{mainScene:null}},e.prototype._update=function(e,o,r){var i=this;return t.prototype._update.call(this,e,o,r).then(function(t){function e(){return i._load(o.mainSceneRef,r).then(function(e){return t.mainScene=e,t})}if(t)return t.mainScene&&o.mainSceneRef!==t.mainScene.id?i.updateObject(t.mainScene.id,null,r).then(e):e()})},e}),define("goo/loaders/handlers/ScriptComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/ScriptComponent","goo/util/rsvp","goo/util/ObjectUtil"],function(t,e,o,r){"use strict";function i(){t.apply(this,arguments),this._type="ScriptComponent"}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,t._registerClass("script",i),i.prototype._prepare=function(){},i.prototype._create=function(){return new e},i.prototype.update=function(e,i,n){var a=this;return t.prototype.update.call(this,e,i,n).then(function(t){if(t){var e=[];return r.forEach(i.scripts,function(t){e.push(a._load(t.scriptRef,n))},null,"sortValue"),o.all(e).then(function(e){return t.scripts=e,t})}})},i}),define("goo/scripts/OrbitCamControlScript",["goo/math/Vector2","goo/math/Vector3","goo/math/MathUtils","goo/entities/SystemBus"],function(t,e,o,r){"use strict";function i(o){o=o||{};for(var i in a)this[i]="boolean"==typeof a[i]?void 0!==o[i]?o[i]===!0:a[i]:isNaN(a[i])?a[i]instanceof e?o[i]?new e(o[i]):(new e).set(a[i]):o[i]||a[i]:isNaN(o[i])?a[i]:o[i];this.name="OrbitCamControlScript",this.timeSamples=[0,0,0,0,0],this.xSamples=[0,0,0,0,0],this.ySamples=[0,0,0,0,0],this.sample=0,this.velocity=new t(0,0),this.targetSpherical=new e(this.spherical),this.cartesian=new e,this.dirty=!0,this.detailZoom=o.detailZoom||.15,this.zoomDistanceFactor=o.zoomDistanceFactor||.035,this.mouseState={buttonDown:!1,lastX:0/0,lastY:0/0},this.domElement&&this.setupMouseControls(),o.demoMode&&(this.demoMode=!0,this.moveInterval=o.moveInterval,this.lastTimeMoved=Date.now()+(o.moveInitialDelay-this.moveInterval)),this.active=!1,this.currentCameraEntity=null,r.addListener("goo.setCurrentCamera",function(t){this.currentCameraEntity=t.entity}.bind(this))}function n(t,e,r){var i=(e+r)/2+(r>e?Math.PI:0),n=o.moduloPositive(t-i,o.TWO_PI),a=o.moduloPositive(e-i,o.TWO_PI),s=o.moduloPositive(r-i,o.TWO_PI);return 0>t&&e>0?e-=o.TWO_PI:t>0&&0>e&&(e+=o.TWO_PI),t>o.TWO_PI&&r<o.TWO_PI&&(r+=o.TWO_PI),a>n?e:n>s?r:t}var a={domElement:null,turnSpeedHorizontal:.005,turnSpeedVertical:.005,zoomSpeed:.2,dragOnly:!0,dragButton:-1,worldUpVector:new e(0,1,0),baseDistance:15,minZoomDistance:1,maxZoomDistance:1e3,minAscent:-89.95*o.DEG_TO_RAD,maxAscent:89.95*o.DEG_TO_RAD,clampAzimuth:!1,minAzimuth:90*o.DEG_TO_RAD,maxAzimuth:270*o.DEG_TO_RAD,releaseVelocity:!1,invertedX:!1,invertedY:!1,invertedWheel:!0,drag:5,maxSampleTimeMS:200,lookAtPoint:new e(0,0,0),spherical:new e(15,0,0),interpolationSpeed:7,onRun:null};
return i.prototype.updateConfig=function(t){for(var o in t)"boolean"==typeof a[o]?this[o]=!!t[o]:isNaN(a[o])||isNaN(t[o])?a[o]instanceof e?this[o].set(t[o]):this[o]=t[o]:this[o]=t[o];this.targetSpherical.setv(this.spherical),this.dirty=!0},i.prototype.updateButtonState=function(t,e){this.domElement!==document&&this.domElement.focus(),!this.dragOnly||-1!==this.dragButton&&this.dragButton!==t||(this.mouseState.buttonDown=e,e?(this.mouseState.lastX=0/0,this.mouseState.lastY=0/0,this.velocity.set(0,0),this.spherical.y=o.moduloPositive(this.spherical.y,o.TWO_PI),this.targetSpherical.copy(this.spherical)):this.applyReleaseDrift())},i.prototype.updateDeltas=function(t,e){var o=0,r=0;isNaN(this.mouseState.lastX)||isNaN(this.mouseState.lastY)?(this.mouseState.lastX=t,this.mouseState.lastY=e):(o=-(t-this.mouseState.lastX),r=e-this.mouseState.lastY,this.mouseState.lastX=t,this.mouseState.lastY=e),this.dragOnly&&!this.mouseState.buttonDown||0===o&&0===r||(this.timeSamples[this.sample]=Date.now(),this.xSamples[this.sample]=o,this.ySamples[this.sample]=r,this.sample++,this.sample>this.timeSamples.length-1&&(this.sample=0),this.velocity.set(0,0),this.move(this.turnSpeedHorizontal*o,this.turnSpeedVertical*r))},i.prototype.move=function(t,e){var r=this.invertedX?-t:t,i=this.invertedY?-e:e;this.targetSpherical.y=this.clampAzimuth?n(this.targetSpherical.y-r,this.minAzimuth,this.maxAzimuth):this.targetSpherical.y-r,this.targetSpherical.z=o.clamp(this.targetSpherical.z+i,this.minAscent,this.maxAscent),this.dirty=!0},i.prototype.applyWheel=function(t){var e=(this.invertedWheel?-1:1)*Math.max(-1,Math.min(1,t.wheelDelta||-t.detail));e*=this.zoomDistanceFactor*this.targetSpherical.x,this.zoom(this.zoomSpeed*e)},i.prototype.zoom=function(t){var e=t*this.baseDistance;this.targetSpherical.x=o.clamp(this.targetSpherical.x+e,this.minZoomDistance,this.maxZoomDistance),this.dirty=!0},i.prototype.applyReleaseDrift=function(){for(var t=Date.now(),e=0,o=0,r=!1,i=0,n=this.timeSamples.length;n>i;i++)t-this.timeSamples[i]<this.maxSampleTimeMS&&(e+=this.xSamples[i],o+=this.ySamples[i],r=!0);r?this.velocity.set(e*this.turnSpeedHorizontal/this.timeSamples.length,o*this.turnSpeedVertical/this.timeSamples.length):this.velocity.set(0,0)},i.prototype.setupMouseControls=function(){var t=this;this.domElement.addEventListener("mousedown",function(e){t.active&&t.updateButtonState(e.button,!0)},!1),document.addEventListener("mouseup",function(e){t.active&&t.updateButtonState(e.button,!1)},!1),document.addEventListener("mousemove",function(e){t.active&&(t.updateDeltas(e.clientX,e.clientY),t.lastTimeMoved=Date.now())},!1),this.domElement.addEventListener("mousewheel",function(e){t.active&&(t.applyWheel(e),t.lastTimeMoved=Date.now())},!1),this.domElement.addEventListener("DOMMouseScroll",function(e){t.active&&t.applyWheel(e)},!1),this.domElement.addEventListener("dragstart",function(e){t.active&&e.preventDefault()},!1),this.domElement.oncontextmenu=function(){return!1};var e=0;this.domElement.addEventListener("touchstart",function(){t.active&&t.updateButtonState(0,!0)}),this.domElement.addEventListener("touchend",function(){t.active&&(t.updateButtonState(0,!1),e=0)}),this.domElement.addEventListener("touchmove",function(o){if(t.active){var r,i,n,a=o.targetTouches,s=a[0].clientX,l=a[0].clientY;if(2===a.length){var h=a[1].clientX,d=a[1].clientY;r=(s+h)/2,i=(l+d)/2,n=(s-h)*(s-h)+(l-d)*(l-d)}else r=s,i=l,t.updateDeltas(r,i);var c=(n-e)/Math.max(t.domElement.height,t.domElement.width);c/=3,0===e?e=n:2===a.length&&Math.abs(c)>.3&&(t.applyWheel({wheelDelta:c}),e=n)}})},i.prototype.updateVelocity=function(t){this.velocity.lengthSquared()>1e-6?(this.move(this.velocity.x,this.velocity.y),this.velocity.mul(o.clamp(o.lerp(t,1,1-this.drag),0,1)),this.dirty=!0):this.velocity.set(0,0,0)},i.prototype.run=function(t,e,i){if(this.active=t===this.currentCameraEntity,this.demoMode){var n=Date.now();n-this.lastTimeMoved>this.moveInterval&&(this.lastTimeMoved=n,this.move(Math.round(Math.random())-.5,Math.round(Math.random())-.5))}i&&!this.domElement&&i.domElement&&(this.domElement=i.domElement,this.setupMouseControls());var a=t.transformComponent;if(a){var s=a.transform;if(this.releaseVelocity&&this.updateVelocity(t._world.tpf),this.dirty){var l=o.clamp(this.interpolationSpeed*t._world.tpf,0,1);this.spherical.y=this.clampAzimuth?o.lerp(l,this.spherical.y,this.targetSpherical.y):o.lerp(l,this.spherical.y,this.targetSpherical.y),this.spherical.x=o.lerp(l,this.spherical.x,this.targetSpherical.x),this.spherical.z=o.lerp(l,this.spherical.z,this.targetSpherical.z),o.sphericalToCartesian(this.spherical.x,this.spherical.y,this.spherical.z,this.cartesian),s.translation.set(this.cartesian.add(this.lookAtPoint)),s.translation.equals(this.lookAtPoint)||s.lookAt(this.lookAtPoint,this.worldUpVector),this.spherical.distanceSquared(this.targetSpherical)<1e-6&&(this.dirty=!1,this.spherical.y=o.moduloPositive(this.spherical.y,o.TWO_PI),this.targetSpherical.copy(this.spherical)),a.setUpdated(),r.emit("goo.cameraPositionChanged",{spherical:this.spherical.data,translation:a.transform.translation.data,lookAtPoint:this.lookAtPoint.data,id:t.id})}}},i}),define("goo/scripts/OrbitNPanControlScript",["goo/scripts/OrbitCamControlScript","goo/renderer/Renderer","goo/math/Vector3","goo/math/MathUtils","goo/entities/SystemBus"],function(t,e,o,r,i){"use strict";function n(e){e=e||{},t.call(this,e),this.name="OrbitNPanControlScript",this.panState={buttonDown:!1,lastX:0/0,lastY:0/0,lastPos:new o},this.orbitButton=void 0!==e.orbitButton?e.orbitButton:a.LEFT,this.panButton=void 0!==e.panButton?e.panButton:a.RIGHT,this.orbitKey=e.orbitKey||"altKey",this.panKey=e.panKey||"shiftKey",this.viewportWidth=0,this.viewportHeight=0,this.shiftKey=!1,this.altKey=!1,this.goingToLookAt=(new o).setv(this.lookAtPoint),this.active=!1,this.currentCameraEntity=null,i.addListener("goo.setCurrentCamera",function(t){this.currentCameraEntity=t.entity}.bind(this))}var a={LEFT:0,MIDDLE:1,RIGHT:2};return n.prototype=Object.create(t.prototype),n.prototype.updateConfig=function(e){t.prototype.updateConfig.call(this,e),this.goingToLookAt.setv(this.lookAtPoint)},n.prototype.setupMouseControls=function(){var t=this;this.domElement.addEventListener("mousedown",function(e){t.active&&(t.shiftKey=e.shiftKey,t.altKey=e.altKey,t.metaKey=e.metaKey,t.ctrlKey=e.ctrlKey,t.updateButtonState(e.button,!0,e))},!1),document.addEventListener("mouseup",function(e){t.active&&t.updateButtonState(e.button,!1,e)},!1),document.addEventListener("mousemove",function(e){t.active&&t.updateDeltas(e.clientX,e.clientY)},!1),this.domElement.addEventListener("mousewheel",function(e){t.active&&(t.shiftKey=e.shiftKey,t.applyWheel(e.wheelDelta||-e.detail))},!1),this.domElement.addEventListener("DOMMouseScroll",function(e){t.active&&(t.shiftKey=e.shiftKey,t.applyWheel(e.wheelDelta||-e.detail))},!1),this.domElement.addEventListener("dragstart",function(e){t.active&&e.preventDefault()},!1),this.domElement.oncontextmenu=function(){return!1},this.domElement.addEventListener("touchstart",function(e){if(t.active){var o=2===e.targetTouches.length,r=1===e.targetTouches.length;t.updateButtonState(t.panButton,o),t.updateButtonState(t.orbitButton,r)}}),this.domElement.addEventListener("touchend",function(e){if(t.active){var o=2===e.targetTouches.length,r=1===e.targetTouches.length;t.updateButtonState(t.panButton,o),t.updateButtonState(t.orbitButton,r)}});var e=0;this.domElement.addEventListener("touchmove",function(o){if(t.active){var r,i,n,a=o.targetTouches,s=a[0].clientX,l=a[0].clientY;if(2===a.length){var h=a[1].clientX,d=a[1].clientY;r=(s+h)/2,i=(l+d)/2,n=(s-h)*(s-h)+(l-d)*(l-d)}else r=s,i=l;t.updateDeltas(r,i);var c=(n-e)/Math.max(t.domElement.height,t.domElement.width);c/=3,2===a.length&&Math.abs(c)>.3&&(t.applyWheel(t.zoomSpeed*c),e=n)}})},n.prototype.updateButtonState=function(e,o){e===this.orbitButton&&!this[this.panKey]||this[this.orbitKey]?t.prototype.updateButtonState.call(this,0,o):(e===this.panButton&&!this[this.orbitKey]||this[this.panKey])&&(this.panState.buttonDown=o,o&&(this.panState.lastX=0/0,this.panState.lastY=0/0,this.panState.lastPos.setv(this.lookAtPoint)))},n.prototype.resetLookAt=function(t,e,o,i){this.goingToLookAt.setv(t),this.lookAtPoint.setv(t),this.panState.lastX=0/0,this.panState.lastY=0/0,this.panState.lastPos.setv(t),this.velocity.set(0),r.cartesianToSpherical(e,o,i,this.spherical),this.targetSpherical.setv(this.spherical),r.sphericalToCartesian(this.spherical.x,this.spherical.y,this.spherical.z,this.cartesian)},n.prototype.updateDeltas=function(r,i){t.prototype.updateDeltas.call(this,r,i);var n=new o,a=new o;if((isNaN(this.panState.lastX)||isNaN(this.panState.lastY))&&(this.panState.lastX=r,this.panState.lastY=i),this.panState.buttonDown){var s=e.mainCamera;if(!s)return;s.getScreenCoordinates(this.panState.lastPos,1,1,a),a.x-=(r-this.panState.lastX)/this.viewportWidth,a.y+=(i-this.panState.lastY)/this.viewportHeight,s.getWorldCoordinates(a.x,a.y,1,1,a.z,n),this.lookAtPoint.setv(n),this.goingToLookAt.setv(this.lookAtPoint),this.dirty=!0}},n.prototype.applyWheel=function(t){var t=(this.invertedWheel?-1:1)*r.clamp(t,-1,1);this.shiftKey&&(t*=this.detailZoom),t*=this.zoomDistanceFactor*this.targetSpherical.x,this.zoom(this.zoomSpeed*t)},n.prototype.run=function(e,o,r){if(this.active=e===this.currentCameraEntity,!this.goingToLookAt.equals(this.lookAtPoint)){var i=7*o;this.lookAtPoint.lerp(this.goingToLookAt,i),this.dirty=!0}t.prototype.run.call(this,e,o,r),r&&(this.viewportWidth=r.viewportWidth,this.viewportHeight=r.viewportHeight)},n}),define("goo/scripts/FlyControlScript",["goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils","goo/entities/SystemBus"],function(t,e,o,r){"use strict";function i(i){i=i||{},this.name="FlyControlScript",this.domElement=i.domElement||null,this.turnSpeedHorizontal=isNaN(i.turnSpeedHorizontal)?.005:i.turnSpeedHorizontal,this.turnSpeedVertical=isNaN(i.turnSpeedVertical)?.005:i.turnSpeedVertical,this.dragOnly=void 0!==i.dragOnly?i.dragOnly===!0:!0,this.dragButton=isNaN(i.dragButton)?2:i.dragButton,this.dragToMove=void 0!==i.dragToMove?i.dragToMove===!0:!0,this.worldUpVector=new t(i.worldUpVector)||new t(0,1,0),this.localLeftVector=new t(i.localLeftVector)||new t(-1,0,0),this.onRun=i.onRun,this.maxAscent=void 0!==i.maxAscent?i.maxAscent:89.95*o.DEG_TO_RAD,this.minAscent=void 0!==i.minAscent?i.minAscent:-89.95*o.DEG_TO_RAD,this.calcVector=new t,this.calcMat1=new e,this.calcMat2=new e,this.rotX=0,this.rotY=0,this.walkSpeed=isNaN(i.walkSpeed)?400:i.walkSpeed,this.crawlSpeed=isNaN(i.crawlSpeed)?40:i.crawlSpeed,this.fwdVector=i.fwdVector||new t(0,0,-1),this.leftVector=i.leftVector||new t(-1,0,0),this.crawlKey=isNaN(i.crawlKey)?16:i.crawlKey,this.forwardKey=isNaN(i.forwardKey)?87:i.forwardKey,this.backKey=isNaN(i.backKey)?83:i.backKey,this.strafeLeftKey=isNaN(i.strafeLeftKey)?65:i.strafeLeftKey,this.strafeRightKey=isNaN(i.strafeRightKey)?68:i.strafeRightKey,this.XZ=i.XZ||!1,this.maxSpeed=i.maxSpeed||30,this.onRun=i.onRun,this.moveState={strafeLeft:0,strafeRight:0,forward:0,back:0,crawling:!1},this.moveVector=new t(0,0,0),this.calcVector=new t,this.baseMultiplier=1,this.movementMultiplier=this.baseMultiplier,this.domElement&&this.setupKeyControls(),this.resetMouseState(),this.domElement&&this.setupMouseControls(),this.active=!1,this.currentCameraEntity=null,r.addListener("goo.setCurrentCamera",function(t){this.currentCameraEntity=t.entity}.bind(this))}i.prototype.updateMovementVector=function(){this.moveVector.x=this.moveState.strafeLeft-this.moveState.strafeRight,this.moveVector.z=this.moveState.forward-this.moveState.back},i.prototype.updateKeys=function(t,e){if(!t.altKey){if(this.dragOnly&&!this.mouseState.buttonDown&&this.dragToMove)return this.movementMultiplier=this.baseMultiplier,this.moveState.forward=0,this.moveState.back=0,this.moveState.strafeLeft=0,this.moveState.strafeRight=0,void this.updateMovementVector();var o=!1;switch(t.keyCode){case this.crawlKey:this.moveState.crawling=e;break;case this.forwardKey:this.moveState.forward=e?1:0,o=!0;break;case this.backKey:this.moveState.back=e?1:0,o=!0;break;case this.strafeLeftKey:this.moveState.strafeLeft=e?1:0,o=!0;break;case this.strafeRightKey:this.moveState.strafeRight=e?1:0,o=!0}o&&this.updateMovementVector()}},i.prototype.resetMouseState=function(){this.mouseState={buttonDown:!1,lastX:0/0,lastY:0/0,dX:0,dY:0}},i.prototype.updateButtonState=function(t,e){!this.dragOnly||-1!==this.dragButton&&this.dragButton!==t.button||(this.mouseState.buttonDown=e,t.preventDefault())},i.prototype.updateDeltas=function(t){isNaN(this.mouseState.lastX)||isNaN(this.mouseState.lastY)?(this.mouseState.dX=0,this.mouseState.dY=0,this.mouseState.lastX=t.clientX,this.mouseState.lastY=t.clientY):(this.mouseState.dX=t.clientX-this.mouseState.lastX,this.mouseState.dY=t.clientY-this.mouseState.lastY,this.mouseState.lastX=t.clientX,this.mouseState.lastY=t.clientY)};var n=function(t){!this.active||this.dragToMove&&!this.mouseState.buttonDown&&this.dragOnly||this.updateKeys(t,!0)},a=function(t){!this.active||this.dragToMove&&!this.mouseState.buttonDown&&this.dragOnly||this.updateKeys(t,!1)};i.prototype.setupKeyControls=function(){this.domElement.setAttribute("tabindex",-1),this.keydown||(this.keydown=n.bind(this)),this.keyup||(this.keyup=a.bind(this)),this.domElement.addEventListener("keydown",this.keydown,!1),this.domElement.addEventListener("keyup",this.keyup,!1)},i.prototype.tearDownKeyControls=function(){this.domElement.removeEventListener("keydown",this.keydown,!1),this.domElement.removeEventListener("keyup",this.keyup,!1)};var s=function(t){this.active&&(this.domElement.focus(),this.resetMouseState(),this.updateButtonState(t,!0))},l=function(t){this.active&&this.updateDeltas(t)},h=function(t){this.active&&this.updateButtonState(t,!1)};return i.prototype.setupMouseControls=function(){var t=s.bind(this),e=l.bind(this),o=h.bind(this);this.domElement.addEventListener("mousedown",t,!1),this.domElement.addEventListener("mousemove",e,!1),this.domElement.addEventListener("mouseup",o,!1),this.domElement.addEventListener("mouseout",o,!1),this.domElement.addEventListener("dragstart",function(t){t.preventDefault()},!1),this.domElement.oncontextmenu=function(){return!1}},i.prototype.run=function(t,e,o){this.active=t===this.currentCameraEntity,o&&!this.domElement&&o.domElement&&(this.domElement=o.domElement,this.setupMouseControls(),this.setupKeyControls());var r=t.transformComponent;if(r){var i=r.transform,n=i.rotation;if(n.toAngles(this.calcVector),this.rotY=this.calcVector.x,this.rotX=this.calcVector.y,this.dragOnly&&!this.mouseState.buttonDown&&(this.mouseState.dX=0,this.mouseState.dY=0,this.dragToMove))return this.movementMultiplier=this.baseMultiplier,this.moveState.forward=0,this.moveState.back=0,this.moveState.strafeLeft=0,this.moveState.strafeRight=0,void this.updateMovementVector();0!==this.moveVector.x||0!==this.moveVector.z?(this.movementMultiplier+=e*this.movementMultiplier*1,this.movementMultiplier=Math.min(this.movementMultiplier,this.maxSpeed)):this.movementMultiplier=this.baseMultiplier;var a=this.turnSpeedHorizontal,s=this.turnSpeedVertical;0!==this.mouseState.dX&&(this.rotX-=a*this.mouseState.dX),0!==this.mouseState.dY&&(this.rotY-=s*this.mouseState.dY,this.rotY>this.maxAscent?this.rotY=this.maxAscent:this.rotY<this.minAscent&&(this.rotY=this.minAscent)),i.rotation.fromAngles(this.rotY,this.rotX,0),this.calcVector.set(this.fwdVector.x*this.moveVector.z+this.leftVector.x*this.moveVector.x,this.fwdVector.y*this.moveVector.z+this.leftVector.y*this.moveVector.x,this.fwdVector.z*this.moveVector.z+this.leftVector.z*this.moveVector.x),this.calcVector.normalize();var l=(this.moveState.crawling?this.crawlSpeed:this.walkSpeed)*this.movementMultiplier,h=t._world.tpf*l;this.calcVector.mul(h);var n=i.rotation;n.applyPost(this.calcVector),this.XZ&&(this.calcVector.data[1]=0),i.translation.add(this.calcVector),r.setUpdated(),this.mouseState.dX=0,this.mouseState.dY=0}},i}),define("goo/scripts/WASDControlScript",["goo/math/Vector","goo/math/Vector3"],function(t,e){"use strict";function o(t){t=t||{},this.name="WASDControlScript",this.domElement=t.domElement||null,this.walkSpeed=isNaN(t.walkSpeed)?100:t.walkSpeed,this.crawlSpeed=isNaN(t.crawlSpeed)?10:t.crawlSpeed,this.fwdVector=t.fwdVector||new e(0,0,-1),this.leftVector=t.leftVector||new e(-1,0,0),this.crawlKey=isNaN(t.crawlKey)?16:t.crawlKey,this.forwardKey=isNaN(t.forwardKey)?87:t.forwardKey,this.backKey=isNaN(t.backKey)?83:t.backKey,this.strafeLeftKey=isNaN(t.strafeLeftKey)?65:t.strafeLeftKey,this.strafeRightKey=isNaN(t.strafeRightKey)?68:t.strafeRightKey,this.XZ=t.XZ||!1,this.moveState={strafeLeft:0,strafeRight:0,forward:0,back:0,speed:this.walkSpeed},this.moveVector=new e,this.calcVector=new e,this.domElement&&this.setupKeyControls()}function r(t){if(!t.altKey)switch(t.keyCode){case this.crawlKey:this.moveState.speed=this.crawlSpeed;break;case this.forwardKey:this.moveState.forward=1,this.updateMovementVector();break;case this.backKey:this.moveState.back=1,this.updateMovementVector();break;case this.strafeLeftKey:this.moveState.strafeLeft=1,this.updateMovementVector();break;case this.strafeRightKey:this.moveState.strafeRight=1,this.updateMovementVector()}}function i(t){if(!t.altKey)switch(t.keyCode){case this.crawlKey:this.moveState.speed=this.walkSpeed;break;case this.forwardKey:this.moveState.forward=0,this.updateMovementVector();break;case this.backKey:this.moveState.back=0,this.updateMovementVector();break;case this.strafeLeftKey:this.moveState.strafeLeft=0,this.updateMovementVector();break;case this.strafeRightKey:this.moveState.strafeRight=0,this.updateMovementVector()}}return o.prototype.updateMovementVector=function(){this.moveVector.x=this.moveState.strafeLeft-this.moveState.strafeRight,this.moveVector.z=this.moveState.forward-this.moveState.back},o.prototype.setupKeyControls=function(){this.domElement.setAttribute("tabindex",-1),this.domElement.addEventListener("keydown",r.bind(this),!1),this.domElement.addEventListener("keyup",i.bind(this),!1)},o.prototype.run=function(o,r,i){i&&!this.domElement&&i.domElement&&(this.domElement=i.domElement,this.setupKeyControls());var n=o.transformComponent,a=n.transform;if(!t.equals(this.moveVector,e.ZERO)){this.calcVector.set(this.fwdVector.x*this.moveVector.z+this.leftVector.x*this.moveVector.x,this.fwdVector.y*this.moveVector.z+this.leftVector.y*this.moveVector.x,this.fwdVector.z*this.moveVector.z+this.leftVector.z*this.moveVector.x),this.calcVector.normalize();var s=o._world.tpf*this.moveState.speed;this.calcVector.mul(s);var l=a.rotation;l.applyPost(this.calcVector),this.XZ&&(this.calcVector.data[1]=0),a.translation.add(this.calcVector),n.setUpdated()}},o}),define("goo/scripts/BasicControlScript",["goo/math/Vector3","goo/math/Matrix3x3"],function(t,e){"use strict";function o(o){o=o||{},this.domElement=void 0===o.domElement?null:o.domElement.domElement||o.domElement,this.name="BasicControlScript",this.movementSpeed=10,this.rollSpeed=2,this.movementSpeedMultiplier=1,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new t(0,0,0),this.rotationVector=new t(0,0,0),this.multiplier=new t(1,1,1),this.rotationMatrix=new e,this.tmpVec=new t,this.handleEvent=function(t){"function"==typeof this[t.type]&&this[t.type](t)},this.keydown=function(t){if(!t.altKey){switch(t.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(t){switch(t.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(t){this.domElement!==document&&this.domElement.focus(),t.preventDefault(),t=t.touches&&1===t.touches.length?t.touches[0]:t,this.mouseDownX=t.pageX,this.mouseDownY=t.pageY,this.mouseStatus=1,document.addEventListener("mousemove",this.mousemove,!1),document.addEventListener("mouseup",this.mouseup,!1),document.addEventListener("touchmove",this.mousemove,!1),document.addEventListener("touchend",this.mouseup,!1)}.bind(this),this.mousemove=function(t){this.mouseStatus>0&&(t=t.touches&&1===t.touches.length?t.touches[0]:t,this.moveState.yawLeft=t.pageX-this.mouseDownX,this.moveState.pitchDown=t.pageY-this.mouseDownY,this.updateRotationVector(),this.mouseDownX=t.pageX,this.mouseDownY=t.pageY)}.bind(this),this.mouseup=function(t){this.mouseStatus&&(t.preventDefault(),this.mouseStatus=0,this.moveState.yawLeft=this.moveState.pitchDown=0,this.updateRotationVector(),document.removeEventListener("mousemove",this.mousemove),document.removeEventListener("mouseup",this.mouseup),document.removeEventListener("touchmove",this.mousemove),document.removeEventListener("touchend",this.mouseup))}.bind(this),this.updateMovementVector=function(){var t=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-t+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!==document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.domElement&&this.setupMouseControls(),this.updateMovementVector(),this.updateRotationVector()}return o.prototype.setupMouseControls=function(){this.domElement.setAttribute("tabindex",-1),this.domElement.addEventListener("mousedown",this.mousedown,!1),this.domElement.addEventListener("touchstart",this.mousedown,!1),this.domElement.addEventListener("keydown",this.keydown.bind(this),!1),this.domElement.addEventListener("keyup",this.keyup.bind(this),!1)},o.prototype.externals=function(){return[{variable:"movementSpeed",type:"number"},{variable:"rollSpeed",type:"number"}]},o.prototype.run=function(e,o,r){r&&!this.domElement&&r.domElement&&(this.domElement=r.domElement,this.setupMouseControls());var i=e.transformComponent,n=i.transform,a=e._world.tpf,s=a*this.movementSpeed*this.movementSpeedMultiplier,l=a*this.rollSpeed*this.movementSpeedMultiplier;(!this.moveVector.equals(t.ZERO)||!this.rotationVector.equals(t.ZERO)||this.mouseStatus>0)&&(n.translation.x+=this.moveVector.x*s,n.translation.y+=this.moveVector.y*s,n.translation.z+=this.moveVector.z*s,this.tmpVec.x+=-this.rotationVector.x*l*this.multiplier.x,this.tmpVec.y+=this.rotationVector.y*l*this.multiplier.y,this.tmpVec.z+=this.rotationVector.z*l*this.multiplier.z,n.rotation.fromAngles(this.tmpVec.x,this.tmpVec.y,this.tmpVec.z),this.mouseStatus>0&&(this.moveState.yawLeft=0,this.moveState.pitchDown=0,this.updateRotationVector()),i.setUpdated())},o}),define("goo/loaders/handlers/ScriptHandler",["goo/loaders/handlers/ConfigHandler","goo/util/rsvp","goo/scripts/OrbitCamControlScript","goo/scripts/OrbitNPanControlScript","goo/scripts/FlyControlScript","goo/scripts/WASDControlScript","goo/scripts/BasicControlScript","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/entities/SystemBus","goo/scripts/ScriptUtils","goo/scripts/Scripts"],function(t,e,o,r,i,n,a,s,l,h,d,c){"use strict";function u(){t.apply(this,arguments),this._bodyCache={},this._currentScriptLoading=null,this._addGlobalErrorListener()}function p(t){var e={},o=t.errors||[];if("object"!=typeof t)return e;if(!t.parameters||t.parameters instanceof Array||o.push("externals.parameters needs to be an array"),o.length)return e.errors=o,e;if(!t.parameters)return e;e.parameters=[];for(var r=0;r<t.parameters.length;r++){var i=t.parameters[r];"string"==typeof i.key&&0!==i.key.length?i.name&&"string"!=typeof i.name?o.push("parameter name needs to be string"):-1!==f.indexOf(i.type)?i.control&&"string"!=typeof i.control?o.push("parameter control needs to be string"):!i.options||i.options instanceof Array?i.min&&isNaN(i.min)?o.push("parameter min needs to be number"):i.max&&isNaN(i.max)?o.push("parameter max needs to be number"):i.scale&&isNaN(i.scale)?o.push("parameter scale needs to be number"):i.decimals&&isNaN(i.decimals)?o.push("parameter decimals needs to be number"):void 0===i.exponential||"boolean"==typeof i.exponential?void 0!==i["default"]?e.parameters.push(i):o.push("parameter default is missing"):o.push("parameter exponential needs to be boolean"):o.push("parameter key needs to be array"):o.push("parameter type needs to be one of ("+f.join(", ")+")"):o.push("parameter key needs to be string")}return o.length&&(e.errors=o),e}function m(t,e){if(e.file){var o=e.message;e.line&&(o+=" - on line "+e.line),t.externals.dependencyErrors=t.externals.dependencyErrors||{},t.externals.dependencyErrors[e.file]=o}else{t.externals.errors=t.externals.errors||[];var o=e.message;e.line&&(o+=" - on line "+e.line),t.externals.errors.push(o),t.setup=null,t.update=null,t.run=null,t.cleanup=null,t.parameters={},t.enabled=!1}}u.prototype=Object.create(t.prototype),u.prototype.constructor=u,t._registerClass("script",u),u.prototype._specialPrepare=function(t,e){e.options=e.options||{},t.externals&&t.externals.parameters&&d.fillDefaultValues(e.options,t.externals.parameters),e.body&&(e._externals=t.externals)},u.prototype._create=function(){return{externals:{},setup:null,update:null,run:null,cleanup:null,parameters:{},name:null}},u.prototype._remove=function(t){var e=this._objects[t];e&&e.cleanup&&e.context&&(e.cleanup(e.parameters,e.context,c.getClasses()),delete this._objects[t])},u.prototype._updateFromCustom=function(t,e){if(this._bodyCache[e.id]===e.body)return t;delete t.externals.errors,this._bodyCache[e.id]=e.body;var o=document.getElementById(u.DOM_ID_PREFIX+e.id);o&&o.parentNode.removeChild(o),window._gooScriptFactories||(window._gooScriptFactories={});var r=["window._gooScriptFactories['"+e.id+"'] = function () { 'use strict';",e.body," var obj = {","  externals: {}"," };",' if (typeof parameters !== "undefined") {',"  obj.externals.parameters = parameters;"," }",' if (typeof setup !== "undefined") {',"  obj.setup = setup;"," }",' if (typeof cleanup !== "undefined") {',"  obj.cleanup = cleanup;"," }",' if (typeof update !== "undefined") {',"  obj.update = update;"," }"," return obj;","};"].join("\n"),i=document.createElement("script");i.id=u.DOM_ID_PREFIX+e.id,i.innerHTML=r,this._currentScriptLoading=e.id,document.body.appendChild(i);var n=window._gooScriptFactories[e.id];if(n){try{n=n(),t.id=e.id,t.externals=p(n.externals),t.setup=n.setup,t.update=n.update,t.cleanup=n.cleanup,t.parameters={},t.enabled=!1}catch(a){var s={message:a.toString()},l=a.stack.split("\n")[1].match(/(\d+):\d+\)$/);l&&(s.line=parseInt(l[1],10)-1),m(t,s)}this._currentScriptLoading=null}return t.externals&&d.fillDefaultNames(t.externals.parameters),t},u.prototype._updateFromClass=function(t,e){if(!t.externals||t.externals.name!==e.className){var o=c.create(e.className);if(!o)throw"Unrecognized script name";t.id=e.id,t.externals=o.externals,t.setup=o.setup,t.update=o.update,t.run=o.run,t.cleanup=o.cleanup,t.parameters=o.parameters||{},t.enabled=!1,d.fillDefaultNames(t.externals.parameters)}return t},u.prototype._update=function(o,r,i){var n=this;return t.prototype._update.call(this,o,r,i).then(function(t){if(t){var o=[];if(r.body&&r.dependencies){delete t.externals.dependencyErrors;for(var a in r.dependencies)o.push(n._addDependency(t,a,r.id))}return e.all(o).then(function(){return r.className?n._updateFromClass(t,r,i):r.body&&n._updateFromCustom(t,r,i),n._specialPrepare(t,r),t.name=r.name,t.externals.errors?t:(l.extend(t.parameters,r.options),t)})}})},u.prototype._addDependency=function(t,o,r){var i=document.querySelector('script[src="'+o+'"]');if(i)return s.createDummyPromise();i=document.createElement("script"),i.src=o,i.setAttribute("data-script-id",r);var n=new e.Promise;return i.onload=function(){n.resolve()},i.onerror=function(){var e={message:"Could not load dependency",file:o};m(t,e),i.parentNode.removeChild(i),n.resolve()},document.body.appendChild(i),n},u.prototype._addGlobalErrorListener=function(){var t=this;window.addEventListener("error",function(e){if(e.filename){var o=document.querySelector('script[src="'+e.filename+'"]');if(o){var r=o.getAttribute("data-script-id"),i=t._objects[r];if(i){var n={message:e.message,line:e.lineno,file:e.filename};m(i,n)}o.parentNode.removeChild(o)}}if(t._currentScriptLoading){var a=document.getElementById(u.DOM_ID_PREFIX+t._currentScriptLoading);a&&a.parentNode.removeChild(a),delete window._gooScriptFactories[t._currentScriptLoading];var i=t._objects[t._currentScriptLoading],n={message:e.message,line:e.lineno-1};m(i,n),t._currentScriptLoading=null}})};var f=["string","float","int","vec3","boolean"];return u.DOM_ID_PREFIX="_script_",u}),define("goo/entities/components/SoundComponent",["goo/entities/components/Component","goo/sound/AudioContext","goo/math/Vector3","goo/math/MathUtils"],function(t,e,o,r){"use strict";function i(){return e?(this.type="SoundComponent",this.sounds=[],this._outDryNode=e.createGain(),this._outWetNode=e.createGain(),this.connectTo(),this._pannerNode=e.createPanner(),this._pannerNode.connect(this._outDryNode),this._oldPosition=new o,this._position=new o,this._orientation=new o,void(this._velocity=new o)):void console.warn("Cannot create soundComponent, webaudio not supported")}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype.addSound=function(t){return e?void(-1===this.sounds.indexOf(t)&&(t.connectTo([this._pannerNode,this._outWetNode]),this.sounds.push(t))):void console.warn("Webaudio not supported")},i.prototype.removeSound=function(t){if(!e)return void console.warn("Webaudio not supported");var o=this.sounds.indexOf(t);o>-1&&(t.stop(),this.sounds.splice(o,1),t.connectTo())},i.prototype.getSoundById=function(t){for(var e=0;e<this.sounds.length;e++)if(this.sounds[e].id===t)return this.sounds[e]},i.prototype.connectTo=function(t){return e?(this._outDryNode.disconnect(),this._outWetNode.disconnect(),t&&t.dry&&this._outDryNode.connect(t.dry),void(t&&t.wet&&this._outWetNode.connect(t.wet))):void console.warn("Webaudio not supported")},i.prototype.updateConfig=function(t){return e?(void 0!==t.volume&&(this._outDryNode.gain.value=r.clamp(t.volume,0,1)),void(void 0!==t.reverb&&(this._outWetNode.gain.value=r.clamp(t.reverb,0,1)))):void console.warn("Webaudio not supported")},i.prototype.process=function(t,o,r){if(e){this._pannerNode.rolloffFactor=t.rolloffFactor,this._pannerNode.maxDistance=t.maxDistance;var i=o.matrix;i.getTranslation(this._position),this._velocity.setv(this._position).subv(this._oldPosition).div(r),this._oldPosition.setv(this._position),this._orientation.setd(0,0,-1),i.applyPostVector(this._orientation);var n=this._position.data;this._pannerNode.setPosition(n[0],n[1],n[2]);var a=this._velocity.data;this._pannerNode.setVelocity(a[0],a[1],a[2]);var s=this._orientation.data;
this._pannerNode.setOrientation(s[0],s[1],s[2])}},i}),define("goo/loaders/handlers/SoundComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/SoundComponent","goo/sound/AudioContext","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n){"use strict";function a(){t.apply(this,arguments),this._type="SoundComponent"}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("sound",a),a.prototype._remove=function(t){var e=t.soundComponent;if(e&&e.sounds)for(var o=e.sounds,r=0;r<o.length;r++)o[r].stop()},a.prototype._prepare=function(t){n.defaults(t,{volume:1,reverb:0})},a.prototype._create=function(){return new e},a.prototype.update=function(e,n,a){if(!o)return i.createDummyPromise();var s=this;return t.prototype.update.call(this,e,n,a).then(function(t){if(t){t.updateConfig(n);for(var e=0;e<t.sounds.length;e++){var o=t.sounds[e];n.sounds[o.id]||t.removeSound(o)}var i=[];for(var l in n.sounds)i.push(s._load(n.sounds[l].soundRef,a));return r.all(i).then(function(e){for(var o=0;o<e.length;o++)-1===t.sounds.indexOf(e[o])&&t.addSound(e[o]);return t})}})},a}),define("goo/sound/Sound",["goo/sound/AudioContext","goo/math/MathUtils","goo/util/rsvp"],function(t,e,o){"use strict";function r(){return t?(this.id=null,this._loop=!1,this._rate=1,this._offset=0,this._duration=null,this._volume=1,this._buffer=null,this._currentSource=null,this._outNode=t.createGain(),this.connectTo(),this._playStart=0,this._pausePos=0,this._endPromise=null,void(this._paused=!1)):void console.warn("Cannot create sound, webaudio not supported")}return r.prototype.play=function(){if(!t)return void console.warn("Webaudio not supported");if(this._currentSource)return this._endPromise;if(this._endPromise=new o.Promise,!this._buffer)return this._endPromise;var e=this._currentSource=t.createBufferSource();this._paused=!1,this._currentSource.onended=function(){this._currentSource!==e||this._paused||this.stop()}.bind(this),this._currentSource.playbackRate.value=this._rate,this._currentSource.connect(this._outNode),this._currentSource.buffer=this._buffer,this._currentSource.loop=this._loop,this._loop&&(this._currentSource.loopStart=this._offset,this._currentSource.loopEnd=this._duration+this._offset),this._playStart=t.currentTime-this._pausePos;var r=this._duration-this._pausePos;return this._currentSource.start(0,this._pausePos+this._offset,r),this._endPromise},r.prototype.pause=function(){return t?void(this._currentSource&&(this._paused=!0,this._pausePos=(t.currentTime-this._playStart)%this._duration,this._pausePos/=this._rate,this._stop())):void console.warn("Webaudio not supported")},r.prototype.stop=function(){return t?(this._paused=!1,this._pausePos=0,this._endPromise&&this._endPromise.resolve(),void(this._currentSource&&this._stop())):void console.warn("Webaudio not supported")},r.prototype.fadeIn=function(t){this.stop();var e=this._volume;this._outNode.gain.value=0;var o=this.fade(e,t);return this.play(),o},r.prototype.fadeOut=function(t){return this.fade(0,t)},r.prototype.fade=function(e,r){this._outNode.gain.setValueAtTime(this._outNode.gain.value,t.currentTime),this._outNode.gain.linearRampToValueAtTime(e,t.currentTime+r);var i=new o.Promise;return setTimeout(function(){i.resolve()},1e3*r),i},r.prototype.isPlaying=function(){return!!this._currentSource},r.prototype._stop=function(){this._currentSource.stop(0),this._currentSource=null},r.prototype.update=function(o){return t?(o=o||{},void 0!==o.id&&(this.id=o.id),void 0!==o.loop&&(this._loop=!!o.loop,this._currentSource&&(this._currentSource.loop=this._loop)),void 0!==o.volume&&(this._volume=e.clamp(o.volume,0,1),this._outNode.gain.value=this._volume),void 0!==o.offset&&(this._offset=o.offset),void 0!==o.duration&&(this._duration=o.duration),void 0!==o.timeScale&&(this._rate=o.rate),void(this._buffer&&this._clampInterval())):void console.warn("Webaudio not supported")},r.prototype._clampInterval=function(){this._offset=Math.min(this._offset,this._buffer.duration),this._duration=null!==this._duration?Math.min(this._buffer.duration-this._offset,this._duration):this._buffer.duration-this._offset,this._pausePos=e.clamp(this._pausePos,0,this._duration)},r.prototype.connectTo=function(e){if(!t)return void console.warn("Webaudio not supported");if(this._outNode.disconnect(),e){e instanceof Array||(e=[e]);for(var o=0;o<e.length;o++)this._outNode.connect(e[o])}},r.prototype.setAudioBuffer=function(e){return t?(this._buffer=e,void this._clampInterval()):void console.warn("Webaudio not supported")},r}),define("goo/loaders/handlers/SoundHandler",["goo/loaders/handlers/ConfigHandler","goo/sound/AudioContext","goo/sound/Sound","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e,o,r,i,n){"use strict";function a(){if(t.apply(this,arguments),this._audioCache={},void 0!==window.Audio){var e=new Audio;this._codecs=[{type:"mp3",enabled:!!e.canPlayType("audio/mpeg;")},{type:"ogg",enabled:!!e.canPlayType('audio/ogg; codecs="vorbis"')},{type:"wav",enabled:!!e.canPlayType('audio/wav; codecs="1"')}]}else this._codecs=[]}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("sound",a),a.prototype._remove=function(t){var e=this._objects[t];e&&e.stop(),delete this._objects[t]},a.prototype._prepare=function(t){n.defaults(t,{loop:!1,audioRefs:{},volume:1,name:"A Sound"})},a.prototype._create=function(){return new o},a.prototype._update=function(o,n,a){if(!e)return i.createDummyPromise();var s=this;return t.prototype._update.call(this,o,n,a).then(function(t){if(t){t.update(n);for(var o=0;o<s._codecs.length;o++){var i=s._codecs[o],a=n.audioRefs[i.type];if(a&&i.enabled)return s._audioCache[a]?(t.setAudioBuffer(s._audioCache[a]),t):s.loadObject(a).then(function(t){var o=new r.Promise;return e.decodeAudioData(t,function(t){o.resolve(t)}),o}).then(function(e){return s._audioCache[a]=e,t.setAudioBuffer(e),t})}return console.warn("No supported audioformat was found"),t}})},a}),define("goo/renderer/pass/Composer",["goo/renderer/pass/RenderTarget","goo/renderer/pass/FullscreenPass","goo/renderer/shaders/ShaderLib","goo/entities/SystemBus"],function(t,e,o,r){"use strict";function i(i){if(this.writeBuffer=i,void 0===this.writeBuffer){var n=window.innerWidth||1,a=window.innerHeight||1;this.writeBuffer=new t(n,a)}this.readBuffer=this.writeBuffer.clone(),this.passes=[],this._clearColor=[0,0,0,1],this.copyPass=new e(o.copy),this.size=null,this.dirty=!1,r.addListener("goo.viewportResize",function(t){this.dirty=!0,this.size=t}.bind(this),!0)}var n=window.WebGLRenderingContext;return i.prototype.swapBuffers=function(){var t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t},i.prototype._checkPassResize=function(t,e){return t.viewportSize&&t.viewportSize.x===e.x&&t.viewportSize.y===e.y&&t.viewportSize.width===e.width&&t.viewportSize.height===e.height?!1:!0},i.prototype.addPass=function(t){this.passes.push(t),t.updateSize&&this.size&&this._checkPassResize(t,this.size)&&(t.updateSize(this.size),t.viewportSize=this.size)},i.prototype.setClearColor=function(t){this._clearColor[0]=t[0],this._clearColor[1]=t[1],this._clearColor[2]=t[2],this._clearColor[3]=t[3]},i.prototype.updateSize=function(){var e=this.size;if(e){var o=e.width,r=e.height;this.writeBuffer=new t(o,r),this.readBuffer=this.writeBuffer.clone();for(var i=0,n=this.passes.length;n>i;i++){var a=this.passes[i];a.updateSize&&this._checkPassResize(a,e)&&(a.updateSize(e),a.viewportSize=e)}}},i.prototype.render=function(t,e,o,r){this.dirty&&(this.updateSize(),this.dirty=!1);var i,a,s=!1,l=this.passes.length;for(a=0;l>a;a++)if(i=this.passes[a],i.enabled&&(i.render(t,this.writeBuffer,this.readBuffer,e,s,o,r,this._clearColor),i.needsSwap)){if(s){var h=this.renderer.context;h.stencilFunc(n.NOTEQUAL,1,4294967295),this.copyPass.render(t,this.writeBuffer,this.readBuffer,e,o,r),h.stencilFunc(n.EQUAL,1,4294967295)}this.swapBuffers()}},i}),define("goo/renderer/pass/RenderPass",["goo/renderer/Renderer","goo/math/Vector4"],function(t,e){"use strict";function o(t,o){this.renderList=t,this.filter=o,this.clearColor=new e(0,0,0,0),this.oldClearColor=new e,this.renderToScreen=!1,this.overrideMaterial=null,this.enabled=!0,this.clear=!0,this.needsSwap=!1}return o.prototype.render=function(e,o,r,i,n,a,s,l){if(a=a||t.mainCamera){s=s||[];var h;h=this.filter?this.renderList.filter(this.filter):this.renderList,this.renderToScreen?e.render(h,a,s,null,this.clear,this.overrideMaterial):e.render(h,a,s,r,this.clear,this.overrideMaterial)}},o}),define("goo/renderer/pass/BloomPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderTarget","goo/renderer/Util","goo/renderer/shaders/ShaderLib"],function(t,e,o,r,i){"use strict";function n(o){o=o||{},this.target=void 0!==o.target?o.target:null;var a=void 0!==o.strength?o.strength:0,s=void 0!==o.sigma?o.sigma:4,l=2*Math.ceil(3*s)+1;this.downsampleAmount=void 0!==o.downsampleAmount?Math.max(o.downsampleAmount,1):4;var h=window.innerWidth||1024,d=window.innerHeight||1024;this.updateSize({x:0,y:0,width:h,height:d}),this.renderable={meshData:e.quad,materials:[]},this.copyMaterial=t.createMaterial(i.copyPure),this.copyMaterial.uniforms.opacity=a,this.copyMaterial.blendState.blending="AdditiveBlending",this.convolutionShader=r.clone(i.convolution),this.convolutionShader.defines={KERNEL_SIZE_FLOAT:l.toFixed(1),KERNEL_SIZE_INT:l.toFixed(0)},this.convolutionMaterial=t.createMaterial(this.convolutionShader),this.convolutionMaterial.uniforms.uImageIncrement=n.blurX,this.convolutionMaterial.uniforms.cKernel=this.convolutionShader.buildKernel(s),this.bcMaterial=t.createMaterial(i.brightnesscontrast),this.bcMaterial.uniforms.brightness=0,this.bcMaterial.uniforms.contrast=0,this.enabled=!0,this.clear=!1,this.needsSwap=!1}return n.prototype.updateSize=function(t){var e=t.width/this.downsampleAmount,r=t.height/this.downsampleAmount;this.renderTargetX=new o(e,r),this.renderTargetY=new o(e,r)},n.prototype.render=function(t,o,r){this.renderable.materials[0]=this.bcMaterial,this.bcMaterial.setTexture("DIFFUSE_MAP",r),t.render(this.renderable,e.camera,[],this.renderTargetY,!0),this.renderable.materials[0]=this.convolutionMaterial,this.convolutionMaterial.setTexture("DIFFUSE_MAP",this.renderTargetY),this.convolutionMaterial.uniforms.uImageIncrement=n.blurY,t.render(this.renderable,e.camera,[],this.renderTargetX,!0),this.convolutionMaterial.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionMaterial.uniforms.uImageIncrement=n.blurX,t.render(this.renderable,e.camera,[],this.renderTargetY,!0),this.renderable.materials[0]=this.copyMaterial,this.copyMaterial.setTexture("DIFFUSE_MAP",this.renderTargetY),null!==this.target?t.render(this.renderable,e.camera,[],this.target,this.clear):t.render(this.renderable,e.camera,[],r,this.clear)},n.blurX=[.001953125,0],n.blurY=[0,.001953125],n}),define("goo/renderer/pass/BlurPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderTarget","goo/renderer/Util","goo/renderer/shaders/ShaderLib"],function(t,e,o,r,i){"use strict";function n(o){o=o||{},this.target=void 0!==o.target?o.target:null;var n=void 0!==o.strength?o.strength:1,a=void 0!==o.sigma?o.sigma:4,s=2*Math.ceil(3*a)+1;this.downsampleAmount=void 0!==o.downsampleAmount?Math.max(o.downsampleAmount,1):4,this.blurX=[.001953125,0],this.blurY=[0,.001953125];var l=window.innerWidth||1024,h=window.innerHeight||1024;this.updateSize({x:0,y:0,width:l,height:h}),this.renderable={meshData:e.quad,materials:[]},this.copyMaterial=t.createMaterial(i.copyPure),this.copyMaterial.uniforms.opacity=n,this.copyMaterial.blendState.blending="CustomBlending",this.convolutionShader=r.clone(i.convolution),this.convolutionShader.defines={KERNEL_SIZE_FLOAT:s.toFixed(1),KERNEL_SIZE_INT:s.toFixed(0)},this.convolutionShader.uniforms.uImageIncrement=this.blurX,this.convolutionShader.uniforms.cKernel=this.convolutionShader.buildKernel(a),this.convolutionMaterial=t.createMaterial(this.convolutionShader),this.enabled=!0,this.clear=!1,this.needsSwap=!1}return n.prototype.updateSize=function(t){var e=t.width/this.downsampleAmount,r=t.height/this.downsampleAmount;this.renderTargetX=new o(e,r),this.renderTargetY=new o(e,r)},n.prototype.render=function(t,o,r){this.renderable.materials[0]=this.convolutionMaterial,this.convolutionMaterial.setTexture("DIFFUSE_MAP",r),this.convolutionMaterial.uniforms.uImageIncrement=this.blurY,t.render(this.renderable,e.camera,[],this.renderTargetX,!0),this.convolutionMaterial.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionMaterial.uniforms.uImageIncrement=this.blurX,t.render(this.renderable,e.camera,[],this.renderTargetY,!0),this.renderable.materials[0]=this.copyMaterial,this.copyMaterial.setTexture("DIFFUSE_MAP",this.renderTargetY),null!==this.target?t.render(this.renderable,e.camera,[],this.target,this.clear):t.render(this.renderable,e.camera,[],r,this.clear)},n}),define("goo/renderer/pass/DoGPass",["goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/RenderTarget","goo/renderer/Util","goo/renderer/shaders/ShaderLib"],function(t,e,o,r,i){"use strict";function n(o){o=o||{},this.target=void 0!==o.target?o.target:null;var n=void 0!==o.width?o.width:1024,a=void 0!==o.height?o.height:1024,s=void 0!==o.sigma?o.sigma:.6,l=void 0!==o.threshold?o.threshold:.005;this.downsampleAmount=void 0!==o.downsampleAmount?Math.max(o.downsampleAmount,1):2,s>2.5&&(s=2.5),this.updateSize({width:n,height:a}),this.renderable={meshData:e.quad,materials:[]},this.convolutionShader1=r.clone(i.convolution),this.convolutionShader2=r.clone(i.convolution),this.differenceShader=r.clone(i.differenceOfGaussians),this.differenceShader.uniforms.threshold=l,this.differenceMaterial=t.createMaterial(this.differenceShader),this.updateSigma(s),this.enabled=!0,this.clear=!1,this.needsSwap=!1}return n.prototype.updateThreshold=function(t){this.differenceMaterial.shader.uniforms.threshold=t},n.prototype.updateEdgeColor=function(t){this.differenceMaterial.shader.uniforms.edgeColor=[t[0],t[1],t[2],1]},n.prototype.updateBackgroundColor=function(t){this.differenceMaterial.shader.uniforms.backgroundColor=[t[0],t[1],t[2],1]},n.prototype.updateBackgroundMix=function(t){this.differenceMaterial.shader.uniforms.backgroundMix=t},n.prototype.updateSize=function(t){var e=t.width/this.downsampleAmount,r=t.height/this.downsampleAmount;this.renderTargetX=new o(e,r),this.gaussian1=new o(e,r),this.gaussian2=new o(e,r),this.blurX=[.5/e,0],this.blurY=[0,.5/r]},n.prototype.updateSigma=function(e){var o=this.convolutionShader1.buildKernel(e),r=this.convolutionShader2.buildKernel(1.6*e),i=o.length;this.convolutionShader1.defines={KERNEL_SIZE_FLOAT:i.toFixed(1),KERNEL_SIZE_INT:i.toFixed(0)},i=r.length,this.convolutionShader2.defines={KERNEL_SIZE_FLOAT:i.toFixed(1),KERNEL_SIZE_INT:i.toFixed(0)},this.convolutionShader1.uniforms.cKernel=o,this.convolutionShader2.uniforms.cKernel=r,this.convolutionMaterial1=t.createMaterial(this.convolutionShader1),this.convolutionMaterial2=t.createMaterial(this.convolutionShader2)},n.prototype.render=function(t,o,r){this.renderable.materials[0]=this.convolutionMaterial1,this.convolutionMaterial1.setTexture("DIFFUSE_MAP",r),this.convolutionShader1.uniforms.uImageIncrement=this.blurX,t.render(this.renderable,e.camera,[],this.renderTargetX,!0),this.convolutionMaterial1.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionShader1.uniforms.uImageIncrement=this.blurY,t.render(this.renderable,e.camera,[],this.gaussian1,!0),this.renderable.materials[0]=this.convolutionMaterial2,this.convolutionMaterial2.setTexture("DIFFUSE_MAP",r),this.convolutionShader2.uniforms.uImageIncrement=this.blurX,t.render(this.renderable,e.camera,[],this.renderTargetX,!0),this.convolutionMaterial2.setTexture("DIFFUSE_MAP",this.renderTargetX),this.convolutionShader2.uniforms.uImageIncrement=this.blurY,t.render(this.renderable,e.camera,[],this.gaussian2,!0),this.renderable.materials[0]=this.differenceMaterial,this.differenceMaterial.setTexture("BLUR1",this.gaussian1),this.differenceMaterial.setTexture("BLUR2",this.gaussian2),this.differenceMaterial.setTexture("ORIGINAL",r),null!==this.target?t.render(this.renderable,e.camera,[],this.target,this.clear):t.render(this.renderable,e.camera,[],r,this.clear)},n}),define("goo/renderer/pass/MotionBlurPass",["goo/renderer/Material","goo/renderer/Shader","goo/renderer/shaders/ShaderLib","goo/renderer/pass/FullscreenUtil","goo/renderer/MeshData","goo/renderer/pass/RenderTarget","goo/renderer/pass/FullscreenPass"],function(t,e,o,r,i,n,a){"use strict";function s(){this.inPass=new a(l),this.outPass=new a(o.copyPure);var t=window.innerWidth||1024,e=window.innerHeight||1024;this.updateSize({x:0,y:0,width:t,height:e}),this.enabled=!0,this.clear=!1,this.needsSwap=!0}s.prototype.updateSize=function(t){var e=t.width,o=t.height;this.targetSwap=[new n(e,o),new n(e,o)]},s.prototype.render=function(t,e,o){this.targetSwap[1].glTexture&&this.inPass.material.setTexture("MOTION_MAP",this.targetSwap[1]),this.inPass.render(t,this.targetSwap[0],o),this.outPass.render(t,e,this.targetSwap[0]),this.targetSwap.reverse()};var l={attributes:{vertexPosition:i.POSITION,vertexUV0:i.TEXCOORD0},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,blend:.9,scale:1,diffuseMap:e.DIFFUSE_MAP,motionMap:"MOTION_MAP"},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","texCoord0 = vertexUV0;","gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform sampler2D motionMap;","uniform float blend;","uniform float scale;","varying vec2 texCoord0;","void main(void)","{","vec4 colA = texture2D(diffuseMap, texCoord0);","vec4 colB = texture2D(motionMap, (texCoord0 - 0.5) / scale + 0.5);","float wBlend = blend;// * length(colB) / sqrt(3.0);","gl_FragColor = mix(colA, colB, wBlend);","}"].join("\n")};return s}),define("goo/renderer/pass/PassLib",["goo/renderer/shaders/ShaderLib","goo/renderer/pass/FullscreenPass","goo/renderer/pass/BloomPass","goo/renderer/pass/BlurPass","goo/renderer/pass/DoGPass","goo/renderer/pass/MotionBlurPass","goo/renderer/Util"],function(t,e,o,r,i,n,a){"use strict";function s(t){o.call(this),this.id=t}function l(t){i.call(this,arguments),this.id=t}function h(t){r.call(this,arguments),this.id=t}function d(o){e.call(this,a.clone(t.vignette)),this.id=o}function c(o){e.call(this,a.clone(t.sepia)),this.id=o}function u(o){e.call(this,a.clone(t.film)),this.id=o}function p(o){e.call(this,a.clone(t.noise)),this.id=o}function m(o){e.call(this,a.clone(t.rgbshift)),this.id=o}function f(o){e.call(this,a.clone(t.bleachbypass)),this.id=o}function g(o){e.call(this,a.clone(t.hsb)),this.id=o}function v(o){e.call(this,a.clone(t.colorify)),this.id=o}function y(o){e.call(this,a.clone(t.hatch)),this.id=o}function x(o){e.call(this,a.clone(t.dotscreen)),this.id=o}function w(o){e.call(this,a.clone(t.brightnesscontrast)),this.id=o}function _(t){n.call(this),this.id=t}return s.prototype=Object.create(o.prototype),s.prototype.constructor=s,s.prototype.update=function(t){var e=t.options||{};void 0!==e.opacity&&(this.copyMaterial.uniforms.opacity=e.opacity/100),void 0!==e.size&&(this.convolutionMaterial.uniforms.size=e.size),void 0!==e.brightness&&(this.bcMaterial.uniforms.brightness=e.brightness/100),void 0!==e.contrast&&(this.bcMaterial.uniforms.contrast=e.contrast/100),void 0!==t.enabled&&(this.enabled=t.enabled)},s.label="Bloom",s.options=[{key:"opacity",name:"Opacity",type:"int",control:"slider",min:0,max:100,"default":100},{key:"size",name:"Size",type:"float",control:"slider",min:0,max:10,decimals:1,"default":2},{key:"brightness",name:"Gain",type:"int",control:"slider",min:-100,max:100,"default":0},{key:"contrast",name:"Intensity",type:"int",control:"slider",min:-100,max:100,"default":0}],l.prototype=Object.create(i.prototype),l.prototype.constructor=l,l.prototype.update=function(t){var e=t.options||{};void 0!==t.enabled&&(this.enabled=t.enabled),void 0!==e.sigma&&this.updateSigma(e.sigma),void 0!==e.threshold&&this.updateThreshold(e.threshold),void 0!==e.edgeColor&&this.updateEdgeColor(e.edgeColor),void 0!==e.backgroundColor&&this.updateBackgroundColor(e.backgroundColor),void 0!==e.backgroundMix&&this.updateBackgroundMix(e.backgroundMix)},l.label="Edge detect",l.options=[{key:"sigma",name:"Gauss Sigma",type:"float",control:"slider",min:.01,max:1.7,decimals:2,"default":.6},{key:"threshold",name:"Threshold",type:"float",control:"slider",min:1e-14,max:.11,decimals:20,"default":.005},{key:"backgroundMix",name:"Background %",type:"float",control:"slider",min:0,max:1,decimals:2,"default":0},{key:"edgeColor",name:"Edge Color",type:"color","default":[0,1,0]},{key:"backgroundColor",name:"Background Color",type:"color","default":[0,0,0]}],h.prototype=Object.create(r.prototype),h.prototype.constructor=h,h.prototype.update=function(t){var e=t.options||{};void 0!==e.opacity&&(this.copyMaterial.uniforms.opacity=e.opacity/100),void 0!==e.size&&(this.blurX=[.001953125*e.size,0],this.blurY=[0,.001953125*e.size]),void 0!==t.enabled&&(this.enabled=t.enabled)},h.label="Blur",h.options=[{key:"opacity",name:"Amount",type:"int",control:"slider",min:0,max:100,"default":100},{key:"size",name:"Size",type:"float",control:"slider",min:0,max:5,decimals:1,"default":1}],d.prototype=Object.create(e.prototype),d.prototype.construcor=d,d.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.offset&&(o.uniforms.offset=e.offset),void 0!==e.darkness&&(o.uniforms.darkness=e.darkness),void 0!==t.enabled&&(this.enabled=t.enabled)},d.label="Vignette",d.options=[{key:"offset",type:"float",control:"slider",name:"Offset",min:0,max:10,decimals:1,"default":1},{key:"darkness",type:"float",control:"slider",name:"Darkness",min:0,max:2,decimals:2,"default":1.5}],c.prototype=Object.create(e.prototype),c.prototype.constructor=c,c.prototype.update=function(t){var e=t.options;void 0!==e.amount&&(this.material.uniforms.amount=e.amount/100),void 0!==t.enabled&&(this.enabled=t.enabled)},c.label="Sepia",c.options=[{key:"amount",name:"Amount",type:"int",control:"slider",min:0,max:100,"default":100}],u.prototype=Object.create(e.prototype),u.prototype.constructor=u,u.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.nIntensity&&(o.uniforms.nIntensity=e.nIntensity/100),void 0!==e.sIntensity&&(o.uniforms.sIntensity=e.sIntensity/100),void 0!==e.sCount&&(o.uniforms.sCount=e.sCount),void 0!==t.enabled&&(this.enabled=t.enabled)},u.label="Film Grain",u.options=[{key:"nIntensity",type:"int",control:"slider",name:"Noise",min:0,max:100,"default":50},{key:"sIntensity",type:"int",control:"slider",name:"Line Intensity",min:0,max:100,"default":50},{key:"sCount",type:"int",control:"slider",name:"Line Count",min:1,max:4096,"default":1024}],p.prototype=Object.create(e.prototype),p.prototype.constructor=p,p.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.nIntensity&&(o.uniforms.nIntensity=e.nIntensity/100),void 0!==t.enabled&&(this.enabled=t.enabled)},p.label="Noise",p.options=[{key:"nIntensity",type:"int",control:"slider",name:"Noise",min:0,max:100,"default":50}],m.prototype=Object.create(e.prototype),m.prototype.constructor=m,m.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.amount&&(o.uniforms.amount=e.amount),void 0!==e.angle&&(o.uniforms.angle=e.angle),void 0!==t.enabled&&(this.enabled=t.enabled)},m.label="RgbShift",m.options=[{key:"amount",type:"float",control:"slider",name:"Amount",min:0,max:.05,decimals:3,"default":.005},{key:"angle",type:"float",control:"slider",name:"Angle",min:0,max:6.28,decimals:1,"default":0}],f.prototype=Object.create(e.prototype),f.prototype.constructor=f,f.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.opacity&&(o.uniforms.opacity=e.opacity),void 0!==t.enabled&&(this.enabled=t.enabled)},f.label="Bleach",f.options=[{key:"opacity",type:"float",control:"slider",name:"Opacity",min:0,max:1,decimals:2,"default":1}],g.prototype=Object.create(e.prototype),g.prototype.constructor=g,g.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.hue&&(o.uniforms.hue=e.hue),void 0!==e.saturation&&(o.uniforms.saturation=e.saturation),void 0!==e.brightness&&(o.uniforms.brightness=e.brightness),void 0!==t.enabled&&(this.enabled=t.enabled)},g.label="HSB",g.options=[{key:"hue",type:"float",control:"slider",name:"Hue",min:-1,max:1,decimals:2,"default":0},{key:"saturation",type:"float",control:"slider",name:"Saturation",min:-1,max:1,decimals:2,"default":0},{key:"brightness",type:"float",control:"slider",name:"Brightness",min:-1,max:1,decimals:2,"default":0}],v.prototype=Object.create(e.prototype),v.prototype.constructor=v,v.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.color&&(o.uniforms.color=e.color),void 0!==e.amount&&(o.uniforms.amount=e.amount),void 0!==t.enabled&&(this.enabled=t.enabled)},v.label="Tint",v.options=[{key:"color",type:"color",name:"Color","default":[1,1,1]},{key:"amount",type:"float",control:"slider",name:"Amount",min:0,max:1,decimals:2,"default":1}],y.prototype=Object.create(e.prototype),y.prototype.constructor=y,y.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.width&&(o.uniforms.width=e.width),void 0!==e.spread&&(o.uniforms.spread=e.spread),void 0!==t.enabled&&(this.enabled=t.enabled)},y.label="Hatch",y.options=[{key:"width",type:"float",control:"slider",name:"Width",min:0,max:10,decimals:1,"default":2},{key:"spread",type:"int",control:"slider",name:"Spread",min:1,max:50,"default":8}],x.prototype=Object.create(e.prototype),x.prototype.constructor=x,x.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.angle&&(o.uniforms.angle=e.angle),void 0!==e.scale&&(o.uniforms.scale=e.scale),void 0!==e.sizex&&(o.uniforms.tSize[0]=e.sizex),void 0!==e.sizey&&(o.uniforms.tSize[1]=e.sizey),void 0!==t.enabled&&(this.enabled=t.enabled)},x.label="Dot",x.options=[{key:"angle",type:"float",control:"slider",name:"Angle",min:0,max:10,decimals:2,"default":1.57},{key:"scale",type:"float",control:"slider",name:"Scale",min:0,max:10,decimals:2,"default":1},{key:"sizex",type:"int",control:"slider",name:"SizeX",min:0,max:1024,"default":256},{key:"sizey",type:"int",control:"slider",name:"SizeY",min:0,max:1024,"default":256}],w.prototype=Object.create(e.prototype),w.prototype.constructor=w,w.prototype.update=function(t){var e=t.options,o=this.material.shader;void 0!==e.brightness&&(o.uniforms.brightness=e.brightness),void 0!==e.contrast&&(o.uniforms.contrast=e.contrast),void 0!==e.saturation&&(o.uniforms.saturation=e.saturation),void 0!==t.enabled&&(this.enabled=t.enabled)},w.label="Contrast",w.options=[{key:"brightness",type:"float",control:"slider",name:"Brightness",min:-1,max:1,decimals:2,"default":0},{key:"contrast",type:"float",control:"slider",name:"Contrast",min:0,max:1,"default":0},{key:"saturation",type:"float",control:"slider",name:"Saturation",min:-1,max:1,decimals:2,"default":0}],_.prototype=Object.create(n.prototype),_.prototype.constructor=_,_.prototype.update=function(t){var e=t.options,o=this.inPass.material.shader;void 0!==e.blend&&(o.uniforms.blend=e.blend),void 0!==e.scale&&(o.uniforms.scale=e.scale),void 0!==t.enabled&&(this.enabled=t.enabled)},_.label="Motion Blur",_.options=[{key:"blend",type:"float",control:"slider",name:"Amount",min:0,max:1,"default":.5},{key:"scale",type:"float",name:"Scale",min:.2,"default":1,scale:.01}],{Bloom:s,Blur:h,Vignette:d,Sepia:c,Grain:u,Noise:p,RgbShift:m,Bleach:f,HSB:g,Colorify:v,Hatch:y,Dot:x,Contrast:w,DiffOfGaussians:l,MotionBlur:_}}),define("goo/loaders/handlers/PosteffectsHandler",["goo/loaders/handlers/ConfigHandler","goo/util/ArrayUtil","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/renderer/pass/Composer","goo/renderer/pass/RenderPass","goo/renderer/pass/FullscreenPass","goo/renderer/shaders/ShaderLib","goo/renderer/Util","goo/renderer/pass/PassLib"],function(t,e,o,r,i,n,a,s,l,h,d){"use strict";function c(){t.apply(this,arguments),this._composer=new n;var e=this.world.getSystem("RenderSystem");this._renderPass=new a(e.renderList),this._outPass=new s(h.clone(l.copy)),this._outPass.renderToScreen=!0}return c.prototype=Object.create(t.prototype),c.prototype.constructor=c,t._registerClass("posteffects",c),c.prototype._remove=function(t){var o=this.world.getSystem("RenderSystem");e.remove(o.composers,this._composer),delete this._objects[t]},c.prototype._create=function(){return[]},c.prototype._update=function(o,r,n){var a=this;return t.prototype._update.call(this,o,r,n).then(function(t){if(t){var e=0;return i.forEach(r.posteffects,function(o){t[e++]=a._updateEffect(o,t)},null,"sortValue"),t.length=e,t}}).then(function(t){if(t){var o=t.some(function(t){return t.enabled}),r=a.world.getSystem("RenderSystem"),i=a._composer;if(o){i.passes=[],i.addPass(a._renderPass);for(var n=0;n<t.length;n++){var s=t[n];s&&s.enabled&&i.addPass(t[n])}i.addPass(a._outPass),-1===r.composers.indexOf(i)&&r.composers.push(i)}else e.remove(r.composers,a._composer);return t}})},c.prototype._updateEffect=function(t,e){for(var o,r=0;r<e.length;r++)if(e[r].id===t.id){o=e[r];break}if(!o){if(!d[t.type])return null;o=new d[t.type](t.id)}return o.update(t),o},c}),define("goo/particles/ParticleLib",[],function(){"use strict";var t={};return t.getSmoke=function(t){return t=t||{},t.scale="undefined"!=typeof t.scale?t.scale:1,t.spread="undefined"!=typeof t.spread?t.spread:2,t.rate="undefined"!=typeof t.spread?t.rate:25,t.velocity="undefined"!=typeof t.velocity?t.velocity:function(e){var o=e.velocity;return o.data[0]=2*(Math.random()-.5)*t.spread*t.scale,o.data[1]=2*(Math.random()+4)*t.scale,o.data[2]=2*(Math.random()-.5)*t.spread*t.scale,o},t.color=t.color||[0,0,0],{totalParticlesToSpawn:-1,releaseRatePerSecond:t.rate,minLifetime:.5,maxLifetime:4,getEmissionVelocity:t.velocity,timeline:[{timeOffset:0,spin:0,mass:1,size:3*t.scale,color:[t.color[0],t.color[1],t.color[2],1]},{timeOffset:1,size:6*t.scale,color:[t.color[0],t.color[1],t.color[2],0]}]}},t.getFire=function(t){return t=t||{},t.scale="undefined"!=typeof t.scale?t.scale:1,t.spread="undefined"!=typeof t.spread?t.spread:2,t.velocity="undefined"!=typeof t.velocity?t.velocity:10,t.startColor=t.startColor||[1,1,0],t.endColor=t.endColor||[1,0,0],{totalParticlesToSpawn:-1,releaseRatePerSecond:30,minLifetime:.5,maxLifetime:2,getEmissionVelocity:function(e){var o=e.velocity;return o.data[0]=2*(Math.random()-.5)*t.spread*t.scale,o.data[1]=(Math.random()+1)*t.velocity*t.scale,o.data[2]=2*(Math.random()-.5)*t.spread*t.scale,o},timeline:[{timeOffset:0,spin:0,mass:1,size:2*t.scale,color:[t.startColor[0],t.startColor[1],t.startColor[2],0]},{timeOffset:.05,color:[t.startColor[0],t.startColor[1],t.startColor[2],1]},{timeOffset:.45,color:[t.endColor[0],t.endColor[1],t.endColor[2],.8]},{timeOffset:.5,size:3*t.scale,color:[0,0,0,0]}]}},t.getSnow=function(t){return t=t||{},t.scale="undefined"!=typeof t.scale?t.scale:2,t.spread="undefined"!=typeof t.spread?t.spread:50,t.velocity="undefined"!=typeof t.velocity?t.velocity:3,t.color=t.color||[1,1,1],{particleCount:1e3,totalParticlesToSpawn:-1,releaseRatePerSecond:50,minLifetime:15,maxLifetime:25,getEmissionPoint:function(e){var o=e.position;return t.getEmissionPoint(o),o},getEmissionVelocity:function(e){var o=e.velocity;return t.getEmissionVelocity(o),o},timeline:[{timeOffset:0,spin:0,mass:1,size:1*t.scale,color:[t.color[0],t.color[1],t.color[2],0]},{timeOffset:.05,color:[t.color[0],t.color[1],t.color[2],1]},{timeOffset:.7,color:[t.color[0],t.color[1],t.color[2],.8]},{timeOffset:.25,spin:5,size:.5*t.scale,color:[t.color[0],t.color[1],t.color[2],0]}]}},t}),define("goo/particles/ParticleUtils",["goo/math/Vector3"],function(t){"use strict";function e(){}return e.getRandomVelocityOffY=function(t,o,r,i,n){var a=o+Math.random()*(r-o),s=2*Math.PI*Math.random();
return t.x=Math.cos(s)*Math.sin(a),t.y=Math.cos(a),t.z=Math.sin(s)*Math.sin(a),n&&e.applyEntityTransformVector(t,n),t.mul(i),t},e.randomPointInCube=function(t,e,o,r,i){return t.x=2*Math.random()*e-e+(i?i.x:0),t.y=2*Math.random()*o-o+(i?i.y:0),t.z=2*Math.random()*r-r+(i?i.z:0),t},e.createConstantForce=function(e){var o=new t(e);return{enabled:!0,prepare:function(){},apply:function(t,e){e.velocity.x+=o.x*t,e.velocity.y+=o.y*t,e.velocity.z+=o.z*t}}},e.applyEntityTransformPoint=function(t,e){return e.transformComponent&&e.transformComponent.worldTransform?e.transformComponent.worldTransform.applyForward(t,t):t},e.applyEntityTransformVector=function(t,e){return e.transformComponent&&e.transformComponent.worldTransform?e.transformComponent.worldTransform.applyForwardVector(t,t):t},e.applyTimeline=function(t,e){for(var o=t.age,r=t.lifeSpan,i=0,n=0,a=0,s=0,l=r,h=r,d=r,c=r,u=0,p=0,m=null,f=null,g=null,v=null,y=null,x=null,w=null,_=null,b=null,S=0,M=e.length;M>S;S++){var C=e[S];u+=(C.timeOffset?C.timeOffset:0)*r,null===x&&(u>o?void 0!==C.color&&(l=u,x=C):void 0!==C.color&&(i=u,m=C)),null===w&&(u>o?void 0!==C.mass&&(h=u,w=C):void 0!==C.mass&&(n=u,f=C)),o>=u&&void 0!==C.uvIndex&&(y=C),null===_&&(u>o?void 0!==C.size&&(d=u,_=C):void 0!==C.size&&(a=u,g=C)),null===b&&(u>o?void 0!==C.spin&&(c=u,b=C):void 0!==C.spin&&(s=u,v=C))}p=(o-i)/(l-i);var P=null!==m?m.color:[1,1,1,1],T=null!==x?x.color:P;t.color.data[0]=(1-p)*P[0]+p*T[0],t.color.data[1]=(1-p)*P[1]+p*T[1],t.color.data[2]=(1-p)*P[2]+p*T[2],t.color.data[3]=(1-p)*P[3]+p*T[3],p=(o-n)/(h-n);var P=null!==f?f.mass:1,T=null!==w?w.mass:P;t.mass=(1-p)*P+p*T,t.uvIndex=null!==y?y.uvIndex:0,p=(o-a)/(d-a);var P=null!==g?g.size:1,T=null!==_?_.size:P;t.size=(1-p)*P+p*T,p=(o-s)/(c-s);var P=null!==v?v.spin:0,T=null!==b?b.spin:P;t.spin=(1-p)*P+p*T},e}),define("goo/particles/Particle",["goo/particles/ParticleUtils","goo/math/Vector","goo/math/Vector3","goo/math/Vector4","goo/renderer/MeshData"],function(t,e,o,r,i){"use strict";function n(t,e){this.alive=!1,this.position=new o,this.velocity=new o,this.lifeSpan=0,this.parent=t,this.age=0,this.index=e,this.color=new r(1,0,0,1),this.size=0,this.spin=0,this.mass=1,this.emitter=null,this.uvIndex=0,this.lastUVIndex=-1,this.bbX=new o,this.bbY=new o,this.lastColor=new r}var a=new o;return n.prototype.respawnParticle=function(t){this.emitter=t,this.lifeSpan=t.nextParticleLifeSpan(),this.alive=!0,this.age=0},n.prototype.update=function(r,n){if(this.alive){if(this.age+=r,this.age>this.lifeSpan)return void this.kill();if(this.position.add_d(this.velocity.x*r,this.velocity.y*r,this.velocity.z*r),t.applyTimeline(this,this.emitter&&this.emitter.timeline?this.emitter.timeline:this.parent.timeline),!e.equals(this.lastColor,this.color)){var s=this.parent.meshData.getAttributeBuffer(i.COLOR);s.set(this.color.data,16*this.index+0),s.set(this.color.data,16*this.index+4),s.set(this.color.data,16*this.index+8),s.set(this.color.data,16*this.index+12),this.lastColor.setv(this.color)}if(this.emitter&&this.emitter.getParticleBillboardVectors(this,n),0===this.spin)this.bbX.muld(this.size,this.size,this.size),this.bbY.muld(this.size,this.size,this.size);else{var l=Math.cos(this.spin)*this.size,h=Math.sin(this.spin)*this.size,d=this.bbY.x,c=this.bbY.y,u=this.bbY.z;this.bbY.setv(this.bbX),this.bbX.muld(l,l,l).add_d(d*h,c*h,u*h),this.bbY.muld(-h,-h,-h).add_d(d*l,c*l,u*l)}var p=this.parent.meshData.getAttributeBuffer(i.POSITION);if(o.subv(this.position,this.bbX,a).subv(this.bbY),p.set(a.data,12*this.index+0),o.subv(this.position,this.bbX,a).addv(this.bbY),p.set(a.data,12*this.index+3),o.addv(this.position,this.bbX,a).addv(this.bbY),p.set(a.data,12*this.index+6),o.addv(this.position,this.bbX,a).subv(this.bbY),p.set(a.data,12*this.index+9),this.lastUVIndex!==this.uvIndex){var m=this.parent.meshData.getAttributeBuffer(i.TEXCOORD0),f=this.uvIndex%this.parent.uRange/this.parent.uRange,g=1-Math.floor(this.uvIndex/this.parent.vRange)/this.parent.vRange,v=1/this.parent.uRange,y=1/this.parent.vRange;m.set([f+v,g-y],8*this.index+0),m.set([f+v,g],8*this.index+2),m.set([f,g],8*this.index+4),m.set([f,g-y],8*this.index+6),this.lastUVIndex=this.uvIndex}}},n.prototype.kill=function(){this.alive=!1;var t=this.parent.meshData.getAttributeBuffer(i.POSITION),e=t.subarray(12*this.index,12*this.index+3);t.set(e,12*this.index+3),t.set(e,12*this.index+6),t.set(e,12*this.index+9)},n}),define("goo/particles/ParticleEmitter",["goo/particles/ParticleUtils","goo/renderer/Renderer"],function(t,e){"use strict";function o(e){e=e||{},this.totalParticlesToSpawn=isNaN(e.totalParticlesToSpawn)?-1:e.totalParticlesToSpawn,this.maxLifetime=isNaN(e.maxLifetime)?3:e.maxLifetime,this.minLifetime=isNaN(e.minLifetime)?2:e.minLifetime,this.timeline=e.timeline?e.timeline:void 0,this.influences=e.influences?e.influences:[],this.getEmissionPoint=e.getEmissionPoint?e.getEmissionPoint:function(e,o){var r=e.position;return r.setd(0,0,0),t.applyEntityTransformPoint(r,o)},this.getEmissionVelocity=e.getEmissionVelocity?e.getEmissionVelocity:function(e,o){var r=e.velocity;return r.setd(0,1,0),t.applyEntityTransformVector(r,o)},this.getParticleBillboardVectors=e.getParticleBillboardVectors?e.getParticleBillboardVectors:o.CAMERA_BILLBOARD_FUNC,this.releaseRatePerSecond=isNaN(e.releaseRatePerSecond)?10:e.releaseRatePerSecond,this.particlesWaitingToRelease=0,this.enabled=void 0!==e.enabled?e.enabled===!0:!0}return o.CAMERA_BILLBOARD_FUNC=function(t){var o=e.mainCamera;o&&(t.bbX.setv(o._left),t.bbY.setv(o._up))},o.prototype.nextParticleLifeSpan=function(){return this.minLifetime+(this.maxLifetime-this.minLifetime)*Math.random()},o}),define("goo/entities/components/ParticleComponent",["goo/entities/components/Component","goo/particles/Particle","goo/particles/ParticleEmitter","goo/renderer/MeshData"],function(t,e,o,r){"use strict";function i(e){if(this.type="ParticleComponent",t.call(this),e=e||{},this.emitters=[],e.emitters)for(var r=0,i=e.emitters.length;i>r;r++)this.emitters.push(new o(e.emitters[r]));this.timeline=e.timeline?e.timeline:[],this.uRange=isNaN(e.uRange)?1:e.uRange,this.vRange=isNaN(e.vRange)?1:e.vRange;var n=isNaN(e.particleCount)?100:e.particleCount;this.recreateParticles(n),this.enabled=!0}return i.prototype=Object.create(t.prototype),i.prototype.generateMeshData=function(){var t=r.defaultMap([r.POSITION,r.COLOR,r.TEXCOORD0]);this.meshData=new r(t,4*this.particleCount,6*this.particleCount);for(var e=this.meshData.getAttributeBuffer(r.TEXCOORD0),o=this.meshData.getIndexBuffer(),i=0,n=this.particleCount;n>i;i++)e.set([1,0],8*i+0),e.set([1,1],8*i+2),e.set([0,1],8*i+4),e.set([0,0],8*i+6),o.set([4*i+0,4*i+3,4*i+1,4*i+1,4*i+3,4*i+2],6*i)},i.prototype.recreateParticles=function(t){this.particleCount=t,this.particles=[];for(var o=0;o<this.particleCount;o++)this.particles[o]=new e(this,o);this.generateMeshData()},i}),define("goo/util/ParticleSystemUtils",["goo/entities/components/ParticleComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MeshDataComponent","goo/renderer/Texture","goo/particles/ParticleEmitter"],function(t,e,o,r,i){"use strict";function n(){}return n.createParticleSystemEntity=function(r,n,a){var s=r.world.createEntity(),l=new t({particleCount:n.particleCount||500});l.emitters.push(new i(n)),s.setComponent(l);var h=new o(l.meshData);s.setComponent(h);var d=new e;return d.materials.push(a),d.cullMode="Never",s.setComponent(d),s},n.createFlareTexture=function(t,e){t=t||64,e=e||{},e.startRadius="undefined"!=typeof e.startRadius?e.startRadius:0,e.endRadius="undefined"!=typeof e.endRadius?e.endRadius:t/2,e.steps=e.steps||[{fraction:0,value:1},{fraction:1,value:0}];var o=document.createElement("canvas");o.width=t,o.height=t;for(var i=o.getContext("2d"),n=i.createRadialGradient(t/2,t/2,e.startRadius,t/2,t/2,e.endRadius),a=0;a<e.steps.length;a++){var s=e.steps[a];n.addColorStop(s.fraction,"rgba(255, 255, 255, "+s.value+")")}i.fillStyle=n,i.fillRect(0,0,t,t);var l=i.getImageData(0,0,t,t).data;l=new Uint8Array(l);var h=new r(l,null,t,t);return h},n.createSplashTexture=function(t,e){function o(t,e,o){var r=s.createRadialGradient(t,e,0,t,e,o);r.addColorStop(0,"rgba(255, 255, 255, 0.5)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),s.fillStyle=r,s.fillRect(t-o,e-o,2*o,2*o)}function i(t,e,r,i,n,a){for(var s=(r-t)/l,h=(i-e)/l,d=(a-n)/l,c=0,u=t,p=e,m=n;l>c;c++,u+=s,p+=h,m+=d)o(u,p,m)}function n(t,e,o,r,n,a,s){for(var l=0;s>l;l++){var h=Math.random()*Math.PI*2,d=4*Math.random()+o,c=4*Math.random()-r;i(t+Math.cos(h)*d,e+Math.sin(h)*d,t+Math.cos(h)*c,e+Math.sin(h)*c,n,a)}}t=t||64,e=e||{},e.nTrails="undefined"!=typeof e.nTrails?e.nTrails:8,e.trailStartRadius="undefined"!=typeof e.trailStartRadius?e.trailStartRadius:1,e.trailEndRadius="undefined"!=typeof e.trailEndRadius?e.trailEndRadius:4;var a=document.createElement("canvas");a.width=t,a.height=t;var s=a.getContext("2d"),l=30;n(t/2,t/2,t/2/10*1,t/2/10*9,e.trailStartRadius,e.trailEndRadius,e.nTrails);var h=s.getImageData(0,0,t,t).data;h=new Uint8Array(h);var d=new r(h,null,t,t);return d},n.createPlanktonTexture=function(t,e){function o(t,e,o){var r=a.createRadialGradient(t,e,0,t,e,o);r.addColorStop(0,"rgba(255, 255, 255, 1)"),r.addColorStop(.3,"rgba(255, 255, 255, 1)"),r.addColorStop(1,"rgba(255, 255, 255, 0)"),a.fillStyle=r,a.fillRect(t-o,e-o,2*o,2*o)}function i(r){for(var i=0;r>i;i++){var n=Math.random()*(t-2*e.maxRadius)+e.maxRadius,a=Math.random()*(t-2*e.maxRadius)+e.maxRadius;o(n,a,Math.random()*(e.maxRadius-e.minRadius)+e.minRadius)}}t=t||64,e=e||{},e.nPoints="undefined"!=typeof e.nPoints?e.nPoints:10,e.minRadius="undefined"!=typeof e.minRadius?e.minRadius:2,e.maxRadius="undefined"!=typeof e.maxRadius?e.maxRadius:5;var n=document.createElement("canvas");n.width=t,n.height=t;var a=n.getContext("2d");i(e.nPoints);var s=a.getImageData(0,0,t,t).data;s=new Uint8Array(s);var l=new r(s,null,t,t);return l},n.createSnowflakeTexture=function(t,e){function o(t,e){for(var o=2*Math.PI/t,r=0;t>r;r++)a.rotate(o),e()}function i(){a.beginPath(),a.moveTo(0,0),a.lineTo(0,90);for(var t=0;6>t;t++)a.moveTo(0,25+10*t),a.lineTo(16-1.5*t,35+10*t),a.moveTo(0,25+10*t),a.lineTo(-(16-1.5*t),35+10*t);a.stroke()}t=t||64,e=e||{};var n=document.createElement("canvas");n.width=t,n.height=t;var a=n.getContext("2d");a.strokeStyle="#FFF",a.lineWidth=4,a.lineCap="round",a.translate(t/2,t/2),a.scale(t/100/2,t/100/2),o(7,i);var s=a.getImageData(0,0,t,t).data;s=new Uint8Array(s);var l=new r(s,null,t,t);return l},n}),define("goo/util/Snow",["goo/entities/SystemBus","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/TextureCreator","goo/particles/ParticleLib","goo/util/ParticleSystemUtils","goo/renderer/Renderer","goo/math/Vector3"],function(t,e,o,r,i,n,a,s){"use strict";function l(t){this.velocity=10,this.height=25,this.material=e.createMaterial(o.particles);var r=n.createFlareTexture(64);r.generateMipmaps=!0,this.material.setTexture("DIFFUSE_MAP",r),this.material.blendState.blending="AdditiveBlending",this.material.cullState.enabled=!1,this.material.depthState.write=!1,this.material.renderQueue=2002;var l=this;this.particleCloudEntity=n.createParticleSystemEntity(t,i.getSnow({getEmissionPoint:function(t){t.copy(a.mainCamera?a.mainCamera.translation:new s),t.data[0]+=1e3*Math.random()-500,t.data[1]+=l.height,t.data[2]+=1e3*Math.random()-500},getEmissionVelocity:function(t){t.data[0]=2*(Math.random()-.5),t.data[1]=-(Math.random()+1)*l.velocity,t.data[2]=2*(Math.random()-.5)}}),this.material),this.particleCloudEntity.name="_ParticleSystemSnow",this.onCameraChange=function(t){t.entity.attachChild(this.particleCloudEntity)}.bind(this),this.particleCloudEntity.transformComponent.transform.translation.copy(a.mainCamera?a.mainCamera.translation:new s),this.particleCloudEntity.addToWorld()}return l.prototype.setEmissionVelocity=function(t){if(t){this.velocity=t;for(var e=this.particleCloudEntity.particleComponent,o=e.particles,r=0;r<o.length;r++)o[r].velocity[1]=-(Math.random()+1)*this.velocity}},l.prototype.setEmissionHeight=function(t){t&&(this.height=t)},l.prototype.setReleaseRatePerSecond=function(t){if(t){var e=this.particleCloudEntity.particleComponent,o=e.emitters[0];o.releaseRatePerSecond=t}},l.prototype.remove=function(){this.particleCloudEntity.removeFromWorld()},l}),define("goo/loaders/handlers/EnvironmentHandler",["goo/loaders/handlers/ConfigHandler","goo/util/ObjectUtil","goo/entities/SystemBus","goo/renderer/shaders/ShaderBuilder","goo/util/Snow","goo/util/rsvp"],function(t,e,o,r,i,n){"use strict";function a(){t.apply(this,arguments)}var s={backgroundColor:[.3,.3,.3,1],globalAmbient:[0,0,0],fog:{enabled:!1,color:[1,1,1],near:10,far:1e3}},l={volume:1,reverb:0,dopplerFactor:1,rolloffFactor:.4,maxDistance:100};return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,t._registerClass("environment",a),a.prototype._prepare=function(t){e.defaults(t,s)},a.prototype._create=function(){return{weatherState:{}}},a.prototype._remove=function(t){var e=this._objects[t];delete this._objects[t];for(var i in e.weatherState)a.weatherHandlers[i].remove(e.weatherState);o.emit("goo.setClearColor",s.backgroundColor),r.CLEAR_COLOR=s.backgroundColor,r.GLOBAL_AMBIENT=s.globalAmbient.slice(0,3),r.USE_FOG=s.fog.enabled,r.FOG_COLOR=s.fog.color.slice(0,3),r.FOG_SETTINGS=[s.fog.near,s.fog.far];var n=this.world.getSystem("SoundSystem");n&&(n.updateConfig(l),n.setReverb(null))},a.prototype._update=function(i,s,l){var h=this;return t.prototype._update.call(this,i,s,l).then(function(t){if(t){t.backgroundColor=s.backgroundColor.slice(0),t.globalAmbient=s.globalAmbient.slice(0,3),t.fog=e.deepClone(s.fog),o.emit("goo.setClearColor",t.backgroundColor),r.CLEAR_COLOR=t.backgroundColor,r.GLOBAL_AMBIENT=t.globalAmbient,r.USE_FOG=t.fog.enabled,r.FOG_COLOR=t.fog.color.slice(0,3),r.FOG_SETTINGS=[t.fog.near,s.fog.far];for(var i in s.weather){var d=a.weatherHandlers[i];d&&d.update.call(h,s.weather[i],t.weatherState)}var c=[];if(s.skyboxRef){var u=h._load(s.skyboxRef,l);c.push(u)}var p=h.world.getSystem("SoundSystem");if(s.sound&&p)if(p.updateConfig(s.sound),s.sound.reverbRef){var u=h._load(s.sound.reverbRef).then(function(t){p.setReverb(t._buffer)});c.push(u)}else p.setReverb(null);return n.all(c).then(function(){return t})}})},a.weatherHandlers={snow:{update:function(t,e){t.enabled?e.snow&&e.snow.enabled?(e.snow.snow.setEmissionVelocity(t.velocity),e.snow.snow.setReleaseRatePerSecond(t.rate),e.snow.snow.setEmissionHeight(t.height)):(e.snow=e.snow||{},e.snow.enabled=!0,e.snow.snow=new i(this.world.gooRunner)):e.snow&&e.snow.enabled&&(e.snow.snow.remove(),e.snow.enabled=!1,delete e.snow.snow)},remove:function(t){t.snow.snow&&(t.snow.snow.remove(),t.snow.enabled=!1,delete t.snow.snow)}}},a}),define("goo/util/Skybox",["goo/shapes/ShapeCreator","goo/shapes/Sphere","goo/renderer/MeshData","goo/renderer/Material","goo/renderer/Shader","goo/renderer/TextureCreator","goo/math/Transform"],function(t,e,o,r,i,n,a){"use strict";function s(o,h,d,c){var u;if(o===s.SPHERE)this.meshData=t.createSphere(48,48,1,d||e.TextureModes.Projected),h instanceof Array&&(h=h[0]),h&&(u=(new n).loadTexture2D(h));else{if(o!==s.BOX)throw new Error("Unknown geometry type");this.meshData=t.createBox(1,1,1),h.length&&(u=(new n).loadTextureCube(h,{flipY:!1}))}var p=r.createMaterial(l[o],"Skybox material");p.setTexture(i.DIFFUSE_MAP,u),p.cullState.cullFace="Front",p.depthState.enabled=!1,p.renderQueue=1,this.materials=[p],this.transform=new a;var m=o===s.SPHERE?Math.PI/2:0;this.transform.rotation.fromAngles(m,c,0),this.transform.update(),this.active=!0}s.SPHERE="sphere",s.BOX="box";var l={};return l.box={attributes:{vertexPosition:o.POSITION},uniforms:{viewMatrix:i.VIEW_MATRIX,projectionMatrix:i.PROJECTION_MATRIX,worldMatrix:i.WORLD_MATRIX,cameraPosition:i.CAMERA,near:i.NEAR_PLANE,diffuseMap:i.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float near;","varying vec3 eyeVec;","void main(void) {","	vec4 worldPos = worldMatrix * vec4(vertexPosition * near * 10.0, 1.0);"," worldPos += vec4(cameraPosition, 0.0);","	gl_Position = projectionMatrix * viewMatrix * worldPos;","	eyeVec = worldPos.xyz - cameraPosition;"," eyeVec.x = -eyeVec.x;"," eyeVec = (worldMatrix * vec4(eyeVec, 0.0)).xyz;","}"].join("\n"),fshader:["precision mediump float;","uniform samplerCube diffuseMap;","varying vec3 eyeVec;","void main(void)","{","	vec4 cube = textureCube(diffuseMap, eyeVec);"," if (cube.a < 0.05) discard;","	gl_FragColor = cube;","}"].join("\n")},l.sphere={attributes:{vertexPosition:o.POSITION,vertexUV0:o.TEXCOORD0},uniforms:{viewMatrix:i.VIEW_MATRIX,projectionMatrix:i.PROJECTION_MATRIX,worldMatrix:i.WORLD_MATRIX,cameraPosition:i.CAMERA,near:i.NEAR_PLANE,diffuseMap:i.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float near;","varying vec2 texCoord0;","varying vec3 eyeVec;","void main(void) {","	texCoord0 = vertexUV0;","	vec4 worldPos = worldMatrix * vec4(vertexPosition * near * 10.0, 1.0);"," worldPos += vec4(cameraPosition, 0.0);","	gl_Position = projectionMatrix * viewMatrix * worldPos;","	eyeVec = cameraPosition - worldPos.xyz;","}"].join("\n"),fshader:["precision mediump float;","uniform sampler2D diffuseMap;","varying vec2 texCoord0;","void main(void)","{"," vec4 sphere = texture2D(diffuseMap, texCoord0);"," if (sphere.a < 0.05) discard;","	gl_FragColor = sphere;","}"].join("\n")},s}),define("goo/loaders/handlers/SkyboxHandler",["goo/loaders/handlers/ConfigHandler","goo/renderer/Texture","goo/renderer/shaders/ShaderBuilder","goo/util/Skybox","goo/util/rsvp","goo/util/PromiseUtil","goo/entities/SystemBus"],function(t,e,o,r,i,n,a){"use strict";function s(){t.apply(this,arguments);var o=new r("box",[],null,0);this._skybox=this.world.createEntity(o.meshData,o.materials[0],o.transform),this._skybox.transformComponent.updateWorldTransform(),this._skybox.isSkybox=!0,this._skybox.name="Skybox_box",this._skyboxTexture=new e(null,{flipY:!1}),this._skyboxTexture.variant="CUBE",this._skybox.meshRendererComponent.materials[0].setTexture("DIFFUSE_MAP",this._skyboxTexture);var i=new r("sphere",[],null,0);this._skysphere=this.world.createEntity(i.meshData,i.materials[0],i.transform),this._skysphere.transformComponent.updateWorldTransform(),this._skysphere.isSkybox=!0,this._skysphere.name="Skybox_sphere",this._skysphereTexture=new e(null,{flipY:!1}),this._skysphere.meshRendererComponent.materials[0].setTexture("DIFFUSE_MAP",this._skysphereTexture),this._activeSkyshape=null}function l(t,e){var o=t.length;if(o!==e.length)return!1;for(;o--;)if(t[o]!==e[o])return!1;return!0}s.prototype=Object.create(t.prototype),s.prototype.constructor=s,t._registerClass("skybox",s),s.prototype._remove=function(t){this._hide(this._skybox),this._hide(this._skysphere),this._skyboxTexture.setImage(null),this._activeSkyshape=null,o.SKYBOX=null,o.SKYSPHERE=null,delete this._objects[t]},s.prototype._create=function(){return{textures:[],enabled:!1}},s.prototype._update=function(e,o,r){var n=this;return t.prototype._update.call(this,e,o,r).then(function(t){if(t){var e=[];return o.box&&e.push(n._updateBox(o.box,r,t)),o.sphere&&e.push(n._updateSphere(o.sphere,r,t)),i.all(e)}})},s.prototype._updateSphere=function(t,e,o){var r=this;return t.sphereRef?this._load(t.sphereRef,e).then(function(e){if(!e||!e.image)return a.emit("goo.error.skybox",{type:"Sphere",message:"The skysphere needs an image to display."}),void r._hide(r._skysphere);var i=r._skysphereTexture;return o.textures=[e],i.setImage(e.image),t.enabled?r._show(r._skysphere):r._hide(r._skysphere),r._skysphere}):(r._skysphereTexture.setImage(null),r._hide(r._skysphere),n.createDummyPromise(r._skysphere))};var h=["rightRef","leftRef","topRef","bottomRef","frontRef","backRef"];return s.prototype._updateBox=function(t,e,o){var r=this,a=h.map(function(o){return t[o]?r._load(t[o],e):n.createDummyPromise()});return i.all(a).then(function(e){if(l(e,o.textures)&&r._activeSkyShape===r._skybox)return r._skybox;var i=e.map(function(t){return t?t.image:null});if(0===i.filter(Boolean).length)return r._skyboxTexture.setImage(null),r._hide(r._skybox),r._skybox;for(var n=1,a=1,s=0;s<i.length;s++)i[s]&&(n=Math.max(n,i[s].width),a=Math.max(a,i[s].width));o.textures=e;var h=r._skyboxTexture;return h.setImage(i),h.image.width=n,h.image.height=a,h.image.dataReady=!0,h.setNeedsUpdate(),t.enabled?r._show(r._skybox):r._hide(r._skybox),r._skybox})},s.prototype._hide=function(t){var e=this.world.getSystem("RenderSystem");e.removed(t),t===this._skybox?o.SKYBOX=null:t===this._skysphere&&(o.SKYSPHERE=null)},s.prototype._show=function(t){var e=this.world.getSystem("RenderSystem");e.added(t),this._activeSkyshape=t,o.SKYBOX=t===this._skybox?this._skyboxTexture:null,o.SKYSPHERE=t===this._skysphere?this._skysphereTexture:null},s}),define("goo/entities/components/HTMLComponent",["goo/entities/components/Component"],function(t){"use strict";function e(e){t.call(this),this.type="HTMLComponent",this.domElement=e}return e.prototype=Object.create(t.prototype),e}),define("goo/loaders/handlers/HTMLComponentHandler",["goo/loaders/handlers/ComponentHandler","goo/entities/components/HTMLComponent","goo/util/rsvp","goo/util/PromiseUtil","goo/util/ObjectUtil"],function(t,e){"use strict";function o(){t.apply(this,arguments),this._type="HTMLComponent"}return o.prototype=Object.create(t.prototype),t._registerClass("html",o),o.prototype.constructor=o,o.prototype._prepare=function(){},o.prototype._create=function(){return new e},o.prototype.update=function(e,o,r){return t.prototype.update.call(this,e,o,r).then(function(t){if(t){var r=t.domElement;if(!r){r=document.createElement("div"),r.id=e.id,r.addEventListener("mousedown",function(t){console.log("Picked a html entity");var o=e._world.gooRunner,r={entity:e,depth:0,x:t.pageX,y:t.pageY,domEvent:t,id:e.id,type:"mousedown"};o.triggerEvent("mousedown",r)}),t.domElement=r,r.style.position="absolute",r.style.top=0,r.style.left=0,r.style.zIndex=3e3;var i=e._world.gooRunner.renderer.domElement.parentElement||document.body;i.appendChild(r)}r.innerHTML=o.innerHTML}})},o.prototype._remove=function(e){t.prototype._remove.call(this,e);var o=e.htmlComponent;o.domElement&&o.domElement.parentNode.removeChild(o.domElement)},o}),define("goo/loaders/DynamicLoader",["goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/ComponentHandler","goo/util/Ajax","goo/util/rsvp","goo/util/StringUtil","goo/util/PromiseUtil","goo/util/ObjectUtil","goo/loaders/handlers/CameraComponentHandler","goo/loaders/handlers/EntityHandler","goo/loaders/handlers/LightComponentHandler","goo/loaders/handlers/MaterialHandler","goo/loaders/handlers/MeshDataComponentHandler","goo/loaders/handlers/MeshDataHandler","goo/loaders/handlers/MeshRendererComponentHandler","goo/loaders/handlers/SceneHandler","goo/loaders/handlers/ShaderHandler","goo/loaders/handlers/SkeletonHandler","goo/loaders/handlers/TextureHandler","goo/loaders/handlers/TransformComponentHandler","goo/loaders/handlers/AnimationComponentHandler","goo/loaders/handlers/AnimationStateHandler","goo/loaders/handlers/AnimationLayersHandler","goo/loaders/handlers/AnimationClipHandler","goo/loaders/handlers/ProjectHandler","goo/loaders/handlers/ScriptComponentHandler","goo/loaders/handlers/ScriptHandler","goo/loaders/handlers/SoundComponentHandler","goo/loaders/handlers/SoundHandler","goo/loaders/handlers/PosteffectsHandler","goo/loaders/handlers/EnvironmentHandler","goo/loaders/handlers/SkyboxHandler","goo/loaders/handlers/HTMLComponentHandler"],function(t,e,o,r,i,n,a){"use strict";function s(t){if(!t.world)throw new Error("World argument cannot be null");if(this._world=t.world,t.ajax)this._ajax=t.ajax;else{if(!t.rootPath)throw new Error("ajax or rootPath must be defined");this._ajax=new o(t.rootPath)}this._objects={},this._handlers={}}return s.prototype.preload=function(t,e){this._ajax.prefill(t,e)},s.prototype.clear=function(){var t=[];for(var e in this._handlers)t.push(this._handlers[e].clear());return this._ajax.clear instanceof Function&&this._ajax.clear(),r.all(t)},s.prototype.load=function(t,e){e=e||{};var o=this._loadObject.bind(this,t,e);return e.preloadBinaries===!0?this._loadBinariesFromRefs(t,e).then(o):o()},s.prototype.update=function(t,e,o){var r=this;return o=o||{},this._ajax.update(t,e).then(function(e){return r._updateObject(t,e,o)}).then(null,function(e){throw console.error("Error updating "+t+" "+e),e})},s.prototype._loadObject=function(t,e){var o=s.getTypeForRef(t),r=this._getHandler(o);return r?r.load(t,e):this._loadRef(t,e)},s.prototype._updateObject=function(t,e,o){var r=s.getTypeForRef(t),i=this._getHandler(r);return i?i.update(t,e,o):s._isRefTypeInGroup(t,"binary")||"bundle"!==r?n.createDummyPromise(e):(console.warn("No handler for type "+r),n.createDummyPromise(e))},s.prototype._loadRef=function(t,e){return this._ajax.load(t,null==e?!1:e.noCache)},s.prototype._loadBinariesFromRefs=function(t,e){function o(t){function o(o){return n._loadRef(o,e).then(function(){i++,e.progressCallback instanceof Function&&e.progressCallback(i,t.length)})}var i=0;return r.all(t.map(function(t){return o(t)}))}function i(t){function o(t){h.push(n._loadRef(t,e).then(i))}function i(t){for(var e=n._getRefsFromConfig(t),r=0,i=Object.keys(e),h=e.length;h>r;r++){var d=e[i[r]];s._isRefTypeInGroup(d,"asset")&&-1===a.indexOf(d)?a.push(d):s._isRefTypeInGroup(d,"json")&&-1===l.indexOf(d)&&o(d)}}var a=[],l=[],h=[];return i({collectionRefs:t}),r.all(h).then(function(){return a})}var n=this;return i(t).then(o)},s.prototype._getHandler=function(e){var o=this._handlers[e];if(o)return o;var r=t.getHandler(e);return r?this._handlers[e]=new r(this._world,this._loadRef.bind(this),this._updateObject.bind(this),this._loadObject.bind(this)):null},s.prototype._getRefsFromConfig=function(t){function e(t,r){if(/\S+refs?$/i.test(t))if(r instanceof Object)for(var i=0,n=Object.keys(r),a=n.length;a>i;i++)r[n[i]]&&o.push(r[n[i]]);else r&&o.push(r);else if(r instanceof Object)for(var i=0,n=Object.keys(r),a=n.length;a>i;i++)r.hasOwnProperty(n[i])&&e(n[i],r[n[i]])}var o=[];return e("",t),o},s.getTypeForRef=function(t){return t.split(".").pop().toLowerCase()},s._isRefTypeInGroup=function(t,e){var r=s.getTypeForRef(t);return r&&o.types[e]&&a.indexOf(o.types[e],r)>=0},s}),define("goo/util/combine/EntityCombiner",["goo/entities/EntityUtils","goo/entities/Entity","goo/util/MeshBuilder","goo/math/Transform","goo/math/Vector3","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere"],function(t,e,o,r,i,n,a){"use strict";function s(t,e,o,r){this.world=t,this.gridCount=e||1,this.gridSize=1,this.removeOldData=void 0!==o?o:!0,this.keepEntities=void 0!==r?r:!1}function l(){var t=[],e=[];return{put:function(o,r){var i=t.indexOf(o);-1===i?(t.push(o),e.push(r)):e[i]=r},get:function(o){return e[t.indexOf(o)]},getKeys:function(){return t},getValues:function(){return e}}}return s.prototype.combine=function(){this.world.process();var t=this.world.entityManager.getTopEntities();this.gridSize>1&&(this.gridSize=this._calculateBounds(t)/this.gridCount),this._combineList(t)},s.prototype._combineList=function(t){var o=t;if(t instanceof e==!1){o=this.world.createEntity("root"),o.addToWorld();for(var r=0;r<t.length;r++)o.attachChild(t[r])}var i=new l;this._buildSubs(o,i);for(var n=i.getKeys(),r=0;r<n.length;r++){var a=n[r],s=i.get(a);this._combine(a,s)}},s.prototype._buildSubs=function(t,e,o){if(!(t.hidden||t.skip||t.animationComponent||t.particleComponent)){(!o||t.scriptComponent||t.stateMachineComponent)&&(o=[],e.put(t,o)),t.meshDataComponent&&t.meshRendererComponent&&t.meshRendererComponent.worldBound&&o.push(t);for(var r=0;r<t.transformComponent.children.length;r++){var i=t.transformComponent.children[r];this._buildSubs(i.entity,e,o)}}},s.prototype._combine=function(t,e){var i=t.transformComponent.worldTransform,n=new r,a=new r;i.invert(n);for(var s=new l,h=0;h<e.length;h++){var d=e[h],c=d.meshRendererComponent.materials[0],u=d.meshDataComponent.meshData.attributeMap,p=Object.keys(u);if(p.sort(),p=p.join("_"),this.gridSize>1){var m=d.meshRendererComponent.worldBound.center.x/this.gridSize,f=d.meshRendererComponent.worldBound.center.z/this.gridSize;p=p+"_"+Math.round(m)+"_"+Math.round(f)}var g=s.get(c);g||(g=new l,s.put(c,g));var v=g.get(p);v||(v=[],g.put(p,v)),v.push(d)}for(var y=s.getKeys(),h=0;h<y.length;h++)for(var x=y[h],w=s.get(x),_=w.getKeys(),b=0;b<_.length;b++){var S=w.get(_[b]);if(1!==S.length){for(var M=new o,C=0;C<S.length;C++){var d=S[C];t!==d?a.multiply(n,d.transformComponent.worldTransform):a.setIdentity(),M.addMeshData(d.meshDataComponent.meshData,a),this.removeOldData?(d.clearComponent("meshDataComponent"),d.clearComponent("meshRendererComponent"),this.keepEntities||1!==d._components.length||0!==d.transformComponent.children.length||d.removeFromWorld()):(d.skip=!0,d.hidden=!0)}var P=M.build();for(var c in P){var d=this.world.createEntity(P[c],x);d.addToWorld(),t.attachChild(d)}}}},s.prototype._calculateBounds=function(e){for(var o=!0,r=new n,s=0;s<e.length;s++){var l=e[s];t.traverse(l,function(t){if(t.meshRendererComponent&&!t.particleComponent)if(o){var e=t.meshRendererComponent.worldBound;e instanceof n?e.clone(r):e instanceof a?(r.center.setv(e.center),r.xExtent=r.yExtent=r.zExtent=e.radius):(r.center.setv(i.ZERO),r.xExtent=r.yExtent=r.zExtent=10),o=!1}else r.merge(t.meshRendererComponent.worldBound)})}return 2*Math.max(r.xExtent,r.zExtent)},s}),define("goo/addons/terrain/Forrest",["goo/renderer/Material","goo/renderer/Camera","goo/math/Vector3","goo/math/Transform","goo/renderer/TextureCreator","goo/renderer/Texture","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/light/DirectionalLight","goo/util/CanvasUtils","goo/util/Ajax","goo/util/MeshBuilder","goo/noise/Noise","goo/noise/ValueNoise","goo/shapes/TerrainSurface","goo/shapes/ShapeCreator","goo/loaders/DynamicLoader","goo/entities/EntityUtils","goo/util/combine/EntityCombiner","goo/util/TangentGenerator","goo/entities/components/MeshDataComponent","goo/entities/components/ScriptComponent","goo/renderer/shaders/ShaderBuilder","goo/math/MathUtils","goo/util/rsvp"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m,f,g,v,y,x,w,_,b,S,M){"use strict";function C(){this.calcVec=new o,this.initDone=!1}var P=function(t,e,o){var r=new g({world:t,preloadBinaries:!0,rootPath:"res/trees2"});return e.then(function(){return console.log("loading bundle ",o),r.load("root.bundle")}).then(function(t){for(var e in t)console.log(e);console.error("Config in bundle ",o," contained no scene?!")})};C.prototype.init=function(t,e,o,r,i,n){for(var a=new M.Promise,s=["fish"],l=0;l<s.length;l++)a=P(t,a,s[l]);return a.then(function(){console.log("loaded forrest",i)},function(t){console.log("Error! ",t)}).then(null,function(t){console.log("Error! ",t)}),this.loadLODTrees(t,e,o,r,i,n)},C.prototype.loadLODTrees=function(e,o,r,i,n,a){this.terrainQuery=o,this.forrestTypes=n,this.entityMap=a||{},this.world=e,this.vegetationList={};for(var s in n){var l=n[s],h=this.createBase(l);this.vegetationList[s]=h}var d=t.createMaterial(E,"vegetation");d.setTexture("DIFFUSE_MAP",r),d.setTexture("NORMAL_MAP",i),d.uniforms.discardThreshold=.6,d.uniforms.materialAmbient=[0,0,0,0],d.uniforms.materialDiffuse=[1,1,1,1],d.uniforms.materialSpecular=[0,0,0,0],d.renderQueue=2001,this.material=d,this.patchSize=32,this.patchDensity=5,this.gridSize=7,this.minDist=1.5,this.patchSpacing=this.patchSize/this.patchDensity,this.gridSizeHalf=Math.floor(.5*this.gridSize),this.grid=[];for(var c=this.createForrestPatch(0,0,1),u=0;u<this.gridSize;u++){this.grid[u]=[];for(var p=0;p<this.gridSize;p++){var m=e.createEntity(this.material),f=new w(c);f.modelBound.xExtent=this.patchSize,f.modelBound.yExtent=500,f.modelBound.zExtent=this.patchSize,f.autoCompute=!1,m.set(f),m.addToWorld(),this.grid[u][p]=m,m.meshRendererComponent.hidden=!0}}this.currentX=-1e4,this.currentZ=-1e4,this.initDone=!0
},C.prototype.rebuild=function(){this.currentX=-1e4,this.currentZ=-1e4};var T=!1;C.prototype.toggle=function(){T=!T;for(var t=0;t<this.gridSize;t++)for(var e=0;e<this.gridSize;e++){var o=this.grid[t][e];o.skip=T}T||this.rebuild()},C.prototype.update=function(t,e){if(this.initDone&&!T){var o=Math.floor(t/this.patchSize),r=Math.floor(e/this.patchSize);if(this.currentX!==o||this.currentZ!==r){for(var t=0;t<this.gridSize;t++)for(var e=0;e<this.gridSize;e++){var i=o+t,n=r+e,a=i-this.currentX,s=n-this.currentZ;i-=this.gridSizeHalf,n-=this.gridSizeHalf;var l=S.moduloPositive(i,this.gridSize),h=S.moduloPositive(n,this.gridSize),d=this.grid[l][h],c=Math.abs(t-this.gridSizeHalf),u=Math.abs(e-this.gridSizeHalf),p=1;if(d.meshRendererComponent.hidden===!1&&a>=0&&a<this.gridSize&&s>=0&&s<this.gridSize){if(!(c<this.minDist&&u<this.minDist)){d.traverse(function(t,e){e>0&&t.removeFromWorld()});continue}p=2}c<this.minDist&&u<this.minDist&&(p=2),i*=this.patchSize,n*=this.patchSize;var m=null;m=this.createForrestPatch(i,n,p,d),m?(d.meshRendererComponent.hidden=!1,2>p&&(d.meshDataComponent.meshData=m)):d.meshRendererComponent.hidden=!0,d.meshRendererComponent.worldBound.center.setd(i+.5*this.patchSize,0,n+.5*this.patchSize)}this.currentX=o,this.currentZ=r}}},C.prototype.determineVegTypeAtPos=function(t){var e=this.terrainQuery.getNormalAt(t);null===e&&(e=o.UNIT_Y);var r=e.dot(o.UNIT_Y);return this.terrainQuery.getForrestType(t[0],t[2],r,S.fastRandom())},C.prototype.fetchTreeMesh=function(t){return v.clone(this.world,this.entityMap[t])},C.prototype.fetchTreeBillboard=function(t,e){var o=this.vegetationList[t],r=this.forrestTypes[t],i=r.w*e,n=r.h*e;return o.getAttributeBuffer("OFFSET").set([.5*-i,0,.5*-i,n,.5*i,n,.5*i,0]),o},C.prototype.getPointInPatch=function(t,e,o,r,i){var n=[0,0,0];return n[0]=o+(t+.75*S.fastRandom())*i,n[2]=.5+r+(e+.75*S.fastRandom())*i,n[1]=this.terrainQuery.getHeightAt(n),null===n[1]&&(n[1]=0),n},C.prototype.addVegMeshToPatch=function(t,e,o,i,n){var a=new r,s=.5*S.fastRandom()+.75;if(a.translation.set(e),a.update(),2===i&&this.entityMap[t]){var l=this.fetchTreeMesh(t);l.transformComponent.transform.scale.mul(.4*s),l.transformComponent.transform.translation.set(e),l.addToWorld(),n.attachChild(l)}else{var h=this.fetchTreeBillboard(t,s);o.addMeshData(h,a)}},C.prototype.createForrestPatch=function(t,e,o,r){var i=new c,n=this.patchDensity,a=this.patchSpacing;r&&r.traverse(function(t,e){e>0&&t.removeFromWorld()}),S.randomSeed=1e4*t+e;for(var s=0;n>s;s++)for(var l=0;n>l;l++){var h=this.getPointInPatch(s,l,t,e,a),d=this.determineVegTypeAtPos(h);d&&this.addVegMeshToPatch(d,h,i,o,r)}var u=i.build();return 2===o&&new y(this.world,1,!0,!0)._combineList(r),u[0]},C.prototype.createBase=function(t){var e=a.defaultMap([a.POSITION,a.TEXCOORD0]);e.BASE=a.createAttribute(1,"Float"),e.OFFSET=a.createAttribute(2,"Float");var o=new a(e,4,6);return o.getAttributeBuffer(a.POSITION).set([0,.1*-t.h,0,0,.1*-t.h,0,0,.1*-t.h,0,0,.1*-t.h,0]),o.getAttributeBuffer(a.TEXCOORD0).set([t.tx,t.ty,t.tx,t.ty+t.th,t.tx+t.tw,t.ty+t.th,t.tx+t.tw,t.ty]),o.getAttributeBuffer("BASE").set([0,t.h,t.h,0]),o.getAttributeBuffer("OFFSET").set([.5*-t.w,0,.5*-t.w,t.h,.5*t.w,t.h,.5*t.w,0]),o.getIndexBuffer().set([0,3,1,1,3,2]),o};var E={processors:[b.light.processor,function(t){b.USE_FOG?(t.defines.FOG=!0,t.uniforms.fogSettings=b.FOG_SETTINGS,t.uniforms.fogColor=b.FOG_COLOR):delete t.defines.FOG}],attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0,base:"BASE",offset:"OFFSET"},uniforms:{viewProjectionMatrix:s.VIEW_PROJECTION_MATRIX,cameraPosition:s.CAMERA,diffuseMap:s.DIFFUSE_MAP,normalMap:s.NORMAL_MAP,discardThreshold:-.01,fogSettings:function(){return b.FOG_SETTINGS},fogColor:function(){return b.FOG_COLOR},time:s.TIME},builder:function(t,e){b.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","attribute float base;","attribute vec2 offset;","uniform mat4 viewProjectionMatrix;","uniform vec3 cameraPosition;","uniform float time;",b.light.prevertex,"varying vec3 normal;","varying vec3 binormal;","varying vec3 tangent;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void) {","vec3 swayPos = vertexPosition;","vec3 nn = cameraPosition - swayPos.xyz;","nn.y = 0.0;","normal = normalize(nn);","tangent = cross(vec3(0.0, 1.0, 0.0), normal);","binormal = cross(normal, tangent);","swayPos.xz += tangent.xz * offset.x;","swayPos.y += offset.y;","swayPos.x += sin(time * 0.5 + swayPos.x * 0.4) * base * sin(time * 1.5 + swayPos.y * 0.4) * 0.02 + 0.01;","	vec4 worldPos = vec4(swayPos, 1.0);","	vWorldPos = worldPos.xyz;","	gl_Position = viewProjectionMatrix * worldPos;",b.light.vertex,"	texCoord0 = vertexUV0;","	viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n")},fshader:function(){return["uniform sampler2D diffuseMap;","uniform sampler2D normalMap;","uniform float discardThreshold;","uniform vec2 fogSettings;","uniform vec3 fogColor;",b.light.prefragment,"varying vec3 normal;","varying vec3 binormal;","varying vec3 tangent;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","void main(void)","{","	vec4 final_color = texture2D(diffuseMap, texCoord0);","if (final_color.a < discardThreshold) discard;","mat3 tangentToWorld = mat3(tangent, binormal, normal);","vec3 tangentNormal = texture2D(normalMap, texCoord0).xyz * vec3(2.0) - vec3(1.0);","vec3 worldNormal = (tangentToWorld * tangentNormal);","vec3 N = normalize(worldNormal);",b.light.fragment,"#ifdef FOG","float d = pow(smoothstep(fogSettings.x, fogSettings.y, length(viewPosition)), 1.0);","final_color.rgb = mix(final_color.rgb, fogColor, d);","#endif","	gl_FragColor = final_color;","}"].join("\n")}};return C}),define("goo/addons/terrain/Terrain",["goo/entities/EntityUtils","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/math/MathUtils","goo/math/Transform","goo/math/Vector3","goo/renderer/MeshData","goo/renderer/Material","goo/renderer/Shader","goo/renderer/shaders/ShaderBuilder","goo/renderer/shaders/ShaderLib","goo/renderer/shaders/ShaderFragment","goo/renderer/TextureCreator","goo/renderer/pass/RenderTarget","goo/renderer/Texture","goo/renderer/Renderer","goo/renderer/pass/FullscreenPass","goo/renderer/pass/FullscreenUtil","goo/renderer/light/DirectionalLight","goo/shapes/ShapeCreator"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m,f,g,v,y,x){"use strict";function w(t,e,o){this.world=t.world,this.renderer=t.renderer,this.size=e,this.count=o,this.splatMult=2;var r=x.createQuad(2/e,2/e),n=this.drawMaterial1=s.createMaterial(C);n.blendState.blending="AdditiveBlending",n.cullState.cullFace="Front";var a=this.drawMaterial2=s.createMaterial(P);a.cullState.cullFace="Front";var l=this.drawMaterial3=s.createMaterial(T);l.uniforms.size=1/e,l.cullState.cullFace="Front";var h=this.drawMaterial4=s.createMaterial(E);h.cullState.cullFace="Front",this.renderable={meshData:r,materials:[n],transform:new i},this.renderable.transform.setRotationXYZ(0,0,.5*Math.PI),this.copyPass=new g(d.screenCopy),this.copyPass.material.depthState.enabled=!1,this.upsamplePass=new g(M),this.upsamplePass.material.depthState.enabled=!1,this.normalmapPass=new g(R),this.normalmapPass.material.depthState.enabled=!1,this.normalmapPass.material.uniforms.resolution=[e,e],this.normalmapPass.material.uniforms.height=10,this.extractFloatPass=new g(D),this.normalMap=new p(e,e),this.textures=[],this.texturesBounce=[];for(var c=0;o>c;c++)this.textures[c]=new p(e,e,{magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps",wrapS:"EdgeClamp",wrapT:"EdgeClamp",generateMipmaps:!1,type:"Float"}),this.texturesBounce[c]=new p(e,e,{magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps",wrapS:"EdgeClamp",wrapT:"EdgeClamp",generateMipmaps:!1,type:"Float"}),e*=.5;l.setTexture("HEIGHT_MAP",this.texturesBounce[0]),h.setTexture("HEIGHT_MAP",this.texturesBounce[0]),this.n=31,this.gridSize=4*(this.n+1)-1,console.log("grid size: ",this.gridSize),this.splat=new p(this.size*this.splatMult,this.size*this.splatMult,{wrapS:"EdgeClamp",wrapT:"EdgeClamp",generateMipmaps:!1}),this.splatCopy=new p(this.size*this.splatMult,this.size*this.splatMult,{wrapS:"EdgeClamp",wrapT:"EdgeClamp",generateMipmaps:!1}),a.setTexture("SPLAT_MAP",this.splatCopy)}var _=window.Ammo;w.prototype.init=function(t){var e=this.world,o=this.count,r=this.terrainRoot=e.createEntity("TerrainRoot");r.addToWorld(),this.clipmaps=[];for(var i=0;o>i;i++){var n=Math.pow(2,i),a=s.createMaterial(S,"clipmap"+i);a.uniforms.materialAmbient=[0,0,0,1],a.uniforms.materialDiffuse=[1,1,1,1],a.cullState.frontFace="CW",a.uniforms.resolution=[1,1/n,this.size,this.size],a.uniforms.resolutionNorm=[this.size,this.size];var l=this.createClipmapLevel(e,a,i);l.setScale(n,1,n),r.attachChild(l);var h=s.createMaterial(A,"terrainPickingMaterial"+i);h.cullState.frontFace="CW",h.uniforms.resolution=[1,1/n,this.size,this.size],h.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},this.clipmaps[i]={clipmapEntity:l,level:i,size:n,currentX:1e5,currentY:1e5,currentZ:1e5,origMaterial:a,terrainPickingMaterial:h}}for(var d=this.clipmaps[this.clipmaps.length-1],i=this.clipmaps.length-2;i>=0;i--){var c=this.clipmaps[i];c.parentClipmap=d,d=c}var u=new y;u.shadowSettings.size=10;var p=this.lightEntity=e.createEntity(u);p.setTranslation(200,200,200),p.setRotation(.5*-Math.PI,0,0),p.addToWorld(),this.lightEntity.lightComponent.hidden=!0,this.floatTexture=t.heightMap instanceof m?t.heightMap:new m(t.heightMap,{magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps",wrapS:"EdgeClamp",wrapT:"EdgeClamp",generateMipmaps:!1,format:"Luminance"},this.size,this.size),this.splatTexture=t.splatMap instanceof m?t.splatMap:new m(t.splatMap,{magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps",wrapS:"EdgeClamp",wrapT:"EdgeClamp",generateMipmaps:!1,flipY:!1},this.size*this.splatMult,this.size*this.splatMult);for(var i=0;i<this.count;i++){var a=this.clipmaps[i].origMaterial,f=this.textures[i];a.setTexture("HEIGHT_MAP",f),a.setTexture("NORMAL_MAP",this.normalMap),a.setTexture("DETAIL_MAP",this.detailMap),a.setTexture("SPLAT_MAP",this.splat),a.setTexture("GROUND_MAP1",t.ground1),a.setTexture("GROUND_MAP2",t.ground2),a.setTexture("GROUND_MAP3",t.ground3),a.setTexture("GROUND_MAP4",t.ground4),a.setTexture("GROUND_MAP5",t.ground5),a.setTexture("STONE_MAP",t.stone);var h=this.clipmaps[i].terrainPickingMaterial;h.setTexture("HEIGHT_MAP",f)}this.copyPass.render(this.renderer,this.textures[0],this.floatTexture),this.copyPass.render(this.renderer,this.splatCopy,this.splatTexture),this.copyPass.render(this.renderer,this.splat,this.splatTexture),this.updateTextures()},w.prototype.toggleMarker=function(){this.lightEntity.lightComponent.hidden=!this.lightEntity.lightComponent.hidden},w.prototype.setMarker=function(t,e,o,r,i,n){this.lightEntity.lightComponent.light.shadowSettings.size=.5*e,n.wrapS="EdgeClamp",n.wrapT="EdgeClamp",this.lightEntity.lightComponent.light.lightCookie=n,this.lightEntity.setTranslation(o,200,r)},w.prototype.pick=function(e,o,r,i){var n=[];t.traverse(this.terrainRoot,function(t){t.meshDataComponent&&t.meshRendererComponent.hidden===!1&&n.push(t)});for(var a=0;a<this.clipmaps.length;a++){var s=this.clipmaps[a];t.traverse(s.clipmapEntity,function(t){t.meshRendererComponent&&(t.meshRendererComponent.isPickable=!0,t.meshRendererComponent.materials[0]=s.terrainPickingMaterial)})}this.renderer.renderToPick(n,f.mainCamera,!0,!1,!1,o,r,null,!0);var l={};this.renderer.pick(o,r,l,f.mainCamera),e.getWorldPosition(o,r,this.renderer.viewportWidth,this.renderer.viewportHeight,l.depth,i);for(var a=0;a<this.clipmaps.length;a++){var s=this.clipmaps[a];t.traverse(s.clipmapEntity,function(t){t.meshRendererComponent&&(t.meshRendererComponent.isPickable=!1,t.meshRendererComponent.materials[0]=s.origMaterial)})}},w.prototype.draw=function(t,e,o,i,n,a,s,h,d){s=r.clamp(s,0,1),i=2*(i-this.size/2),a=2*(a-this.size/2),"paint"===t?(this.renderable.materials[0]=this.drawMaterial2,this.renderable.materials[0].uniforms.opacity=s,"add"===e?(this.renderable.materials[0].blendState.blendEquationColor="AddEquation",this.renderable.materials[0].blendState.blendEquationAlpha="AddEquation"):"sub"===e&&(this.renderable.materials[0].blendState.blendEquationColor="ReverseSubtractEquation",this.renderable.materials[0].blendState.blendEquationAlpha="ReverseSubtractEquation"),h?this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,h):this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,this.defaultBrushTexture),this.renderable.transform.translation.setd(i/this.size,a/this.size,0),this.renderable.transform.scale.setd(-o,o,o),this.renderable.transform.update(),this.copyPass.render(this.renderer,this.splatCopy,this.splat),this.renderable.materials[0].uniforms.rgba=d||[1,1,1,1],this.renderer.render(this.renderable,v.camera,[],this.splat,!1)):"smooth"===t?(this.renderable.materials[0]=this.drawMaterial3,this.renderable.materials[0].uniforms.opacity=s,h?this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,h):this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,this.defaultBrushTexture),this.renderable.transform.translation.setd(i/this.size,a/this.size,0),this.renderable.transform.scale.setd(-o,o,o),this.renderable.transform.update(),this.copyPass.render(this.renderer,this.texturesBounce[0],this.textures[0]),this.renderer.render(this.renderable,v.camera,[],this.textures[0],!1)):"flatten"===t?(this.renderable.materials[0]=this.drawMaterial4,this.renderable.materials[0].uniforms.opacity=s,this.renderable.materials[0].uniforms.height=n,h?this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,h):this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,this.defaultBrushTexture),this.renderable.transform.translation.setd(i/this.size,a/this.size,0),this.renderable.transform.scale.setd(-o,o,o),this.renderable.transform.update(),this.copyPass.render(this.renderer,this.texturesBounce[0],this.textures[0]),this.renderer.render(this.renderable,v.camera,[],this.textures[0],!1)):(this.renderable.materials[0]=this.drawMaterial1,this.renderable.materials[0].uniforms.opacity=s,"add"===e?this.renderable.materials[0].blendState.blending="AdditiveBlending":"sub"===e?this.renderable.materials[0].blendState.blending="SubtractiveBlending":"mul"===e&&(this.renderable.materials[0].blendState.blending="MultiplyBlending"),h?this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,h):this.renderable.materials[0].setTexture(l.DIFFUSE_MAP,this.defaultBrushTexture),this.renderable.transform.translation.setd(i/this.size,a/this.size,0),this.renderable.transform.scale.setd(-o,o,o),this.renderable.transform.update(),this.renderer.render(this.renderable,v.camera,[],this.textures[0],!1))},w.prototype.getTerrainData=function(){var t=new Uint8Array(this.size*this.size*4);this.extractFloatPass.render(this.renderer,this.texturesBounce[0],this.textures[0]),this.renderer.readPixels(0,0,this.size,this.size,t);var e=new Float32Array(t.buffer),o=new Uint8Array(this.size*this.size*4);this.normalmapPass.render(this.renderer,this.normalMap,this.textures[0]),this.renderer.readPixels(0,0,this.size,this.size,o);var r=new Uint8Array(this.size*this.size*4*4);return this.copyPass.render(this.renderer,this.splatCopy,this.splat),this.renderer.readPixels(0,0,this.size*this.splatMult,this.size*this.splatMult,r),{heights:e,normals:o,splat:r}},w.prototype.updateAmmoBody=function(){for(var t=this.getTerrainData().heights,e=this.heightBuffer,o=0;o<this.size;o++)for(var r=0;r<this.size;r++)_.setValue(e+4*(o*this.size+r),t[(this.size-o-1)*this.size+r],"float")},w.prototype.initAmmoBody=function(){var t=this.heightBuffer=_.allocate(4*this.size*this.size,"float",_.ALLOC_NORMAL);this.updateAmmoBody();var e=1,o=-500,r=500,i=1,n=0,a=!1,s=new _.btHeightfieldTerrainShape(this.size,this.size,t,e,o,r,i,n,a),l=new _.btTransform;l.setIdentity(),l.setOrigin(new _.btVector3(this.size/2,0,this.size/2));var h=new _.btDefaultMotionState(l),d=new _.btVector3(0,0,0),c=0,u=new _.btRigidBodyConstructionInfo(c,h,s,d),p=new _.btRigidBody(u);p.setFriction(1),this.world.getSystem("AmmoSystem").ammoWorld.addRigidBody(p)},w.prototype.updateTextures=function(){for(var t=0;t<this.count-1;t++){var e=this.textures[t],o=this.textures[t+1];e.magFilter="Bilinear",e.minFilter="BilinearNoMipMaps",this.copyPass.render(this.renderer,o,e)}for(var r=this.size,t=0;t<this.count;t++){var i=this.texturesBounce[t],e=this.textures[t],o=this.textures[t+1];this.upsamplePass.material.setTexture("MAIN_MAP",e),this.upsamplePass.material.uniforms.res=[r,r,2/r,2/r],o?(o.magFilter="NearestNeighbor",o.minFilter="NearestNeighborNoMipMaps",this.upsamplePass.render(this.renderer,i,o)):(e.magFilter="NearestNeighbor",e.minFilter="NearestNeighborNoMipMaps",this.upsamplePass.render(this.renderer,i,e)),r*=.5}for(var t=0;t<this.count;t++)this.copyPass.render(this.renderer,this.textures[t],this.texturesBounce[t]);this.normalmapPass.render(this.renderer,this.normalMap,this.textures[0])},w.prototype.update=function(e){for(var o=e.x,i=e.y,n=e.z,a=0;a<this.clipmaps.length;a++){var s=this.clipmaps[a],l=Math.floor(.5*o/s.size),h=Math.floor(.5*i/s.size),d=Math.floor(.5*n/s.size);if(h!==s.currentY){s.currentY=h;var c=this.gridSize*s.size*2;if(s.clipmapEntity.hidden===!1&&i>c){if(t.hide(s.clipmapEntity),a<this.clipmaps.length-1){var u=this.clipmaps[a+1];u.clipmapEntity.innermost.meshRendererComponent.hidden=!1,u.clipmapEntity.interior1.meshRendererComponent.hidden=!0,u.clipmapEntity.interior2.meshRendererComponent.hidden=!0}continue}if(s.clipmapEntity.hidden===!0&&c>=i&&(t.show(s.clipmapEntity),a<this.clipmaps.length-1)){var u=this.clipmaps[a+1];u.clipmapEntity.innermost.meshRendererComponent.hidden=!0,u.clipmapEntity.interior1.meshRendererComponent.hidden=!1,u.clipmapEntity.interior2.meshRendererComponent.hidden=!1}}if(l!==s.currentX||d!==s.currentZ){var p=this.n;if(s.parentClipmap){var m=s.parentClipmap.clipmapEntity.interior1,f=s.parentClipmap.clipmapEntity.interior2,g=r.moduloPositive(l+1,2),v=r.moduloPositive(d+1,2),y=g%2===0?-p:p+1,x=v%2===0?-p:p+1;m.setTranslation(-p,0,x),v=r.moduloPositive(d,2),x=v%2===0?-p:-p+1,f.setTranslation(y,0,x)}s.clipmapEntity.setTranslation(l*s.size*2,0,d*s.size*2),s.currentX=l,s.currentZ=d}}},w.prototype.createClipmapLevel=function(t,e,o){var r=t.createEntity("clipmap"+o);r.addToWorld();var i=this.n;return this.createQuadEntity(t,e,o,r,-2*i,-2*i,i,i),this.createQuadEntity(t,e,o,r,-1*i,-2*i,i,i),this.createQuadEntity(t,e,o,r,0*i,-2*i,2,i),this.createQuadEntity(t,e,o,r,2,-2*i,i,i),this.createQuadEntity(t,e,o,r,2+1*i,-2*i,i,i),this.createQuadEntity(t,e,o,r,-2*i,-1*i,i,i),this.createQuadEntity(t,e,o,r,2+1*i,-1*i,i,i),this.createQuadEntity(t,e,o,r,-2*i,0,i,2),this.createQuadEntity(t,e,o,r,2+1*i,0,i,2),this.createQuadEntity(t,e,o,r,-2*i,2,i,i),this.createQuadEntity(t,e,o,r,2+1*i,2,i,i),this.createQuadEntity(t,e,o,r,-2*i,2+1*i,i,i),this.createQuadEntity(t,e,o,r,-1*i,2+1*i,i,i),this.createQuadEntity(t,e,o,r,0,2+1*i,2,i),this.createQuadEntity(t,e,o,r,2,2+1*i,i,i),this.createQuadEntity(t,e,o,r,2+1*i,2+1*i,i,i),r.innermost=this.createQuadEntity(t,e,o,r,-i,-i,2*i+2,2*i+2),0!==o&&(r.innermost.meshRendererComponent.hidden=!0,r.interior1=this.createQuadEntity(t,e,o,r,-i,-i,2*i+2,1),r.interior2=this.createQuadEntity(t,e,o,r,-i,-i,1,2*i+1)),r},w.prototype.createQuadEntity=function(t,e,o,r,i,n,a,s){var l=this.createGrid(a,s),h=t.createEntity("mesh_"+a+"_"+s,l,e);return h.meshDataComponent.modelBound.xExtent=.5*a,h.meshDataComponent.modelBound.yExtent=255,h.meshDataComponent.modelBound.zExtent=.5*s,h.meshDataComponent.modelBound.center.setd(.5*a,128,.5*s),h.meshDataComponent.autoCompute=!1,h.meshRendererComponent.isPickable=!1,h.setTranslation(i,0,n),r.attachChild(h),h.addToWorld(),h};var b={};w.prototype.createGrid=function(t,e){var o=t+"_"+e;if(b[o])return b[o];var r=a.defaultMap([a.POSITION]),i=new a(r,(t+1)*(e+1),(2*t+4)*e);b[o]=i,i.indexModes=["TriangleStrip"];for(var n=i.getAttributeBuffer(a.POSITION),s=i.getIndexBuffer(),l=0;t+1>l;l++)for(var h=0;e+1>h;h++){var d=h*(t+1)+l;n[3*d+0]=l,n[3*d+1]=0,n[3*d+2]=h}for(var c=0,d=0,h=0;e>h;h++){s[c++]=h*(t+1),s[c++]=h*(t+1);for(var l=0;t>l;l++)d=h*(t+1)+l,s[c++]=d+t+1,s[c++]=d+1;s[c++]=d+t+1+1,s[c++]=d+t+1+1}return console.log((t+1)*(e+1),(2*t+4)*e,t*e*6),i};var S={defines:{SKIP_SPECULAR:!0},processors:[h.light.processor,function(t){h.USE_FOG?(t.defines.FOG=!0,t.uniforms.fogSettings=h.FOG_SETTINGS,t.uniforms.fogColor=h.FOG_COLOR):delete t.defines.FOG}],attributes:{vertexPosition:a.POSITION},uniforms:{viewProjectionMatrix:l.VIEW_PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,cameraPosition:l.CAMERA,heightMap:"HEIGHT_MAP",normalMap:"NORMAL_MAP",detailMap:"DETAIL_MAP",splatMap:"SPLAT_MAP",groundMap1:"GROUND_MAP1",groundMap2:"GROUND_MAP2",groundMap3:"GROUND_MAP3",groundMap4:"GROUND_MAP4",groundMap5:"GROUND_MAP5",stoneMap:"STONE_MAP",fogSettings:function(){return h.FOG_SETTINGS},fogColor:function(){return h.FOG_COLOR},resolution:[255,1,1024,1024],resolutionNorm:[1024,1024],col:[0,0,0]},builder:function(t,e){h.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform sampler2D heightMap;","uniform vec4 resolution;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec4 alphaval;",h.light.prevertex,"const vec2 alphaOffset = vec2(45.0);","const vec2 oneOverWidth = vec2(1.0 / 16.0);","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vec2 coord = (worldPos.xz + vec2(0.5, 0.5)) / resolution.zw;","vec4 heightCol = texture2D(heightMap, coord);","float zf = heightCol.r;","float zd = heightCol.g;","vec2 alpha = clamp((abs(worldPos.xz - cameraPosition.xz) * resolution.y - alphaOffset) * oneOverWidth, vec2(0.0), vec2(1.0));","alpha.x = max(alpha.x, alpha.y);","float z = mix(zf, zd, alpha.x);","z = coord.x <= 0.0 || coord.x >= 1.0 || coord.y <= 0.0 || coord.y >= 1.0 ? -2000.0 : z;","alphaval = vec4(zf, zd, alpha.x, z);","worldPos.y = z * resolution.x;","gl_Position = viewProjectionMatrix * worldPos;","vWorldPos = worldPos.xyz;","viewPosition = cameraPosition - vWorldPos;",h.light.vertex,"}"].join("\n")},fshader:function(){return["uniform vec3 col;","uniform sampler2D normalMap;","uniform sampler2D splatMap;","uniform sampler2D detailMap;","uniform sampler2D groundMap1;","uniform sampler2D groundMap2;","uniform sampler2D groundMap3;","uniform sampler2D groundMap4;","uniform sampler2D groundMap5;","uniform sampler2D stoneMap;","uniform vec2 fogSettings;","uniform vec3 fogColor;","uniform vec2 resolutionNorm;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec4 alphaval;",h.light.prefragment,"void main(void) {","if (alphaval.w < -1000.0) discard;","vec2 mapcoord = vWorldPos.xz / resolutionNorm;","vec2 coord = mapcoord * 96.0;","vec4 final_color = vec4(1.0);","vec3 N = (texture2D(normalMap, mapcoord).xyz * vec3(2.0) - vec3(1.0)).xzy;","N.y = 0.1;","N = normalize(N);","vec4 splat = texture2D(splatMap, mapcoord);","vec4 g1 = texture2D(groundMap1, coord);","vec4 g2 = texture2D(groundMap2, coord);","vec4 g3 = texture2D(groundMap3, coord);","vec4 g4 = texture2D(groundMap4, coord);","vec4 g5 = texture2D(groundMap5, coord);","vec4 stone = texture2D(stoneMap, coord);","final_color = mix(g1, g2, splat.r);","final_color = mix(final_color, g3, splat.g);","final_color = mix(final_color, g4, splat.b);","final_color = mix(final_color, g5, splat.a);","float slope = clamp(1.0 - dot(N, vec3(0.0, 1.0, 0.0)), 0.0, 1.0);","slope = smoothstep(0.15, 0.25, slope);","final_color = mix(final_color, stone, slope);",h.light.fragment,"#ifdef FOG","float d = pow(smoothstep(fogSettings.x, fogSettings.y, length(viewPosition)), 1.0);","final_color.rgb = mix(final_color.rgb, fogColor, d);","#endif","gl_FragColor = final_color;","}"].join("\n")}},M={attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0},uniforms:{diffuseMap:"MAIN_MAP",childMap:l.DIFFUSE_MAP,res:[1,1,1,1]},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","varying vec2 texCoord0;","void main(void) {","	texCoord0 = vertexUV0;","	gl_Position = vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform sampler2D childMap;","uniform vec4 res;","varying vec2 texCoord0;","void main(void)","{","	gl_FragColor = texture2D(diffuseMap, texCoord0);","	vec2 coordMod = mod(floor(texCoord0 * res.xy), 2.0);","	bvec2 test = equal(coordMod, vec2(0.0));","	if (all(test)) {","		gl_FragColor.g = texture2D(childMap, texCoord0).r;","	} else if (test.x) {","		gl_FragColor.g = (texture2D(childMap, texCoord0).r + texture2D(childMap, texCoord0 + vec2(0.0, res.w)).r) * 0.5;","	} else if (test.y) {","		gl_FragColor.g = (texture2D(childMap, texCoord0).r + texture2D(childMap, texCoord0 + vec2(res.z, 0.0)).r) * 0.5;","	} else {","		gl_FragColor.g = (texture2D(childMap, texCoord0).r + texture2D(childMap, texCoord0 + vec2(res.z, res.w)).r) * 0.5;","	}","	gl_FragColor.ba = vec2(0.0);","}"].join("\n")},C={attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0},uniforms:{viewProjectionMatrix:l.VIEW_PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,opacity:1,diffuseMap:l.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","	texCoord0 = vertexUV0;","	gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform float opacity;","varying vec2 texCoord0;","void main(void)","{","	gl_FragColor = texture2D(diffuseMap, texCoord0);","	gl_FragColor.a *= opacity;","}"].join("\n")},P={attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0},uniforms:{viewProjectionMatrix:l.VIEW_PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,opacity:1,rgba:[1,1,1,1],diffuseMap:l.DIFFUSE_MAP,splatMap:"SPLAT_MAP"},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","varying vec2 texCoord1;","void main(void) {","	vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewProjectionMatrix * worldPos;","	texCoord0 = vertexUV0;","	texCoord1 = worldPos.xy * 0.5 + 0.5;","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform sampler2D splatMap;","uniform vec4 rgba;","uniform float opacity;","varying vec2 texCoord0;","varying vec2 texCoord1;","void main(void)","{","	vec4 splat = texture2D(splatMap, texCoord1);","	vec4 brush = texture2D(diffuseMap, texCoord0);","	vec4 final = mix(splat, rgba, opacity * length(brush.rgb) * brush.a);","	gl_FragColor = final;","}"].join("\n")},T={attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0},uniforms:{viewProjectionMatrix:l.VIEW_PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,opacity:1,size:1/512,diffuseMap:l.DIFFUSE_MAP,heightMap:"HEIGHT_MAP"},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","varying vec2 texCoord1;","void main(void) {","	vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewProjectionMatrix * worldPos;","	texCoord0 = vertexUV0;","	texCoord1 = worldPos.xy * 0.5 + 0.5;","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform sampler2D heightMap;","uniform float opacity;","uniform float size;","varying vec2 texCoord0;","varying vec2 texCoord1;","void main(void)","{","	float col1 = texture2D(heightMap, texCoord1 + vec2(-size, -size)).r;","	float col2 = texture2D(heightMap, texCoord1 + vec2(-size, size)).r;","	float col3 = texture2D(heightMap, texCoord1 + vec2(size, size)).r;","	float col4 = texture2D(heightMap, texCoord1 + vec2(size, -size)).r;","	float avg = (col1 + col2 + col3 + col4) * 0.25;","	gl_FragColor = texture2D(heightMap, texCoord1);","	vec4 brush = texture2D(diffuseMap, texCoord0);","	gl_FragColor.r = mix(gl_FragColor.r, avg, brush.r * brush.a * opacity);","}"].join("\n")},E={attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0},uniforms:{viewProjectionMatrix:l.VIEW_PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,opacity:1,height:0,diffuseMap:l.DIFFUSE_MAP,heightMap:"HEIGHT_MAP"},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","varying vec2 texCoord1;","void main(void) {","	vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewProjectionMatrix * worldPos;","	texCoord0 = vertexUV0;","	texCoord1 = worldPos.xy * 0.5 + 0.5;","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","uniform sampler2D heightMap;","uniform float opacity;","uniform float height;","varying vec2 texCoord0;","varying vec2 texCoord1;","void main(void)","{","	gl_FragColor = texture2D(heightMap, texCoord1);","	vec4 brush = texture2D(diffuseMap, texCoord0);","	gl_FragColor.r = mix(gl_FragColor.r, height, brush.r * brush.a * opacity);","}"].join("\n")},D={attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0},uniforms:{viewProjectionMatrix:l.VIEW_PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,diffuseMap:l.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","	texCoord0 = vertexUV0;","	gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["uniform sampler2D diffuseMap;","varying vec2 texCoord0;","float shift_right (float v, float amt) {","v = floor(v) + 0.5;","return floor(v / exp2(amt));","}","float shift_left (float v, float amt) {","return floor(v * exp2(amt) + 0.5);","}","float mask_last (float v, float bits) {","return mod(v, shift_left(1.0, bits));","}","float extract_bits (float num, float from, float to) {","from = floor(from + 0.5); to = floor(to + 0.5);","return mask_last(shift_right(num, from), to - from);","}","vec4 encode_float (float val) {","if (val == 0.0) return vec4(0, 0, 0, 0);","float sign = val > 0.0 ? 0.0 : 1.0;","val = abs(val);","float exponent = floor(log2(val));","float biased_exponent = exponent + 127.0;","float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;","float t = biased_exponent / 2.0;","float last_bit_of_biased_exponent = fract(t) * 2.0;","float remaining_bits_of_biased_exponent = floor(t);","float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;","float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;","float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;","float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0;","return vec4(byte4, byte3, byte2, byte1);","}","void main(void)","{","	gl_FragColor = encode_float(texture2D(diffuseMap, vec2(texCoord0.x, 1.0 - texCoord0.y) + vec2(0.0/512.0, 1.0/512.0)).r);","}"].join("\n")},A={attributes:{vertexPosition:a.POSITION},uniforms:{viewMatrix:l.VIEW_MATRIX,projectionMatrix:l.PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,cameraFar:l.FAR_PLANE,cameraPosition:l.CAMERA,heightMap:"HEIGHT_MAP",resolution:[255,1,1,1],id:function(t){return t.renderable.id+1}},vshader:["attribute vec3 vertexPosition;","uniform sampler2D heightMap;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float cameraFar;","uniform vec4 resolution;","uniform vec3 cameraPosition;","varying float depth;","const vec2 alphaOffset = vec2(45.0);","const vec2 oneOverWidth = vec2(1.0 / 16.0);","void main(void) {","vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","vec2 coord = (worldPos.xz + vec2(0.5, 0.5)) / resolution.zw;","vec4 heightCol = texture2D(heightMap, coord);","float zf = heightCol.r;","float zd = heightCol.g;","vec2 alpha = clamp((abs(worldPos.xz - cameraPosition.xz) * resolution.y - alphaOffset) * oneOverWidth, vec2(0.0), vec2(1.0));","alpha.x = max(alpha.x, alpha.y);","float z = mix(zf, zd, alpha.x);","worldPos.y = z * resolution.x;","vec4 mvPosition = viewMatrix * worldPos;","depth = -mvPosition.z / cameraFar;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fshader:["uniform float id;","varying float depth;",c.methods.packDepth16,"void main() {","vec2 packedId = vec2(floor(id/255.0), mod(id, 255.0)) * vec2(1.0/255.0);","vec2 packedDepth = packDepth16(depth);","gl_FragColor = vec4(packedId, packedDepth);","}"].join("\n")},R={attributes:{vertexPosition:a.POSITION,vertexUV0:a.TEXCOORD0},uniforms:{viewMatrix:l.VIEW_MATRIX,projectionMatrix:l.PROJECTION_MATRIX,worldMatrix:l.WORLD_MATRIX,heightMap:l.DIFFUSE_MAP,resolution:[512,512],height:.05},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 vUv;","void main() {","vUv = vertexUV0;","gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","}"].join("\n"),fshader:["uniform float height;","uniform vec2 resolution;","uniform sampler2D heightMap;","varying vec2 vUv;","void main() {","float val = texture2D(heightMap, vUv).x;","float valU = texture2D(heightMap, vUv + vec2(1.0 / resolution.x, 0.0)).x;","float valV = texture2D(heightMap, vUv + vec2(0.0, 1.0 / resolution.y)).x;","vec3 normal = vec3(val - valU, val - valV, height);","gl_FragColor = vec4((0.5 * normalize(normal) + 0.5), 1.0);","}"].join("\n")};
return w}),define("goo/addons/terrain/Vegetation",["goo/entities/components/MeshDataComponent","goo/renderer/Material","goo/renderer/Camera","goo/math/MathUtils","goo/math/Vector3","goo/math/Transform","goo/renderer/TextureCreator","goo/renderer/Texture","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/light/DirectionalLight","goo/util/CanvasUtils","goo/util/Ajax","goo/util/MeshBuilder","goo/noise/Noise","goo/noise/ValueNoise","goo/shapes/TerrainSurface","goo/shapes/ShapeCreator","goo/renderer/shaders/ShaderBuilder"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m,f,g,v,y){"use strict";function x(){this.calcVec=new i,this.initDone=!1}x.prototype.init=function(o,r,i,n){this.world=o,this.terrainQuery=r,this.vegetationList={};for(var a in n){var s=n[a],l=this.createBase(s);this.vegetationList[a]=l}var h=e.createMaterial(_,"vegetation");h.setTexture("DIFFUSE_MAP",i),h.cullState.enabled=!1,h.uniforms.discardThreshold=.2,h.blendState.blending="CustomBlending",h.uniforms.materialAmbient=[0,0,0,0],h.uniforms.materialDiffuse=[1,1,1,1],h.uniforms.materialSpecular=[0,0,0,0],h.renderQueue=3001,this.material=h,this.patchSize=15,this.patchDensity=19,this.gridSize=7,this.patchSpacing=this.patchSize/this.patchDensity,this.gridSizeHalf=Math.floor(.5*this.gridSize),this.grid=[];for(var d=this.createPatch(0,0),c=0;c<this.gridSize;c++){this.grid[c]=[];for(var u=0;u<this.gridSize;u++){var p=this.world.createEntity(this.material),m=new t(d);m.modelBound.xExtent=this.patchSize,m.modelBound.yExtent=500,m.modelBound.zExtent=this.patchSize,m.autoCompute=!1,p.set(m),p.addToWorld(),this.grid[c][u]=p,p.meshRendererComponent.hidden=!0}}this.currentX=-1e4,this.currentZ=-1e4,this.initDone=!0},x.prototype.rebuild=function(){this.currentX=-1e4,this.currentZ=-1e4};var w=!1;x.prototype.toggle=function(){w=!w;for(var t=0;t<this.gridSize;t++)for(var e=0;e<this.gridSize;e++){var o=this.grid[t][e];o.skip=w}w||this.rebuild()},x.prototype.update=function(t,e){if(this.initDone&&!w){var o=Math.floor(t/this.patchSize),i=Math.floor(e/this.patchSize);if(this.currentX!==o||this.currentZ!==i){for(var t=0;t<this.gridSize;t++)for(var e=0;e<this.gridSize;e++){var n=o+t,a=i+e,s=n-this.currentX,l=a-this.currentZ;if(!(s>=0&&s<this.gridSize&&l>=0&&l<this.gridSize)){n-=this.gridSizeHalf,a-=this.gridSizeHalf;var h=r.moduloPositive(n,this.gridSize),d=r.moduloPositive(a,this.gridSize);n*=this.patchSize,a*=this.patchSize;var c=this.grid[h][d],u=this.createPatch(n,a);u?(c.meshRendererComponent.hidden=!1,c.meshDataComponent.meshData=u,c.meshRendererComponent.worldBound.center.setd(n+.5*this.patchSize,0,a+.5*this.patchSize)):c.meshRendererComponent.hidden=!0}}this.currentX=o,this.currentZ=i}}},x.prototype.createPatch=function(t,e){for(var o=new p,r=new n,a=this.patchDensity,s=this.patchSpacing,l=[0,10,0],h=0;a>h;h++)for(var d=0;a>d;d++){var c=t+(h+.5*Math.random())*s,u=e+(d+.5*Math.random())*s;l[0]=c,l[2]=u+.5;var m=this.terrainQuery.getHeightAt(l),f=this.terrainQuery.getNormalAt(l);null===m&&(m=0),null===f&&(f=i.UNIT_Y);var g=f.dot(i.UNIT_Y),v=this.terrainQuery.getVegetationType(c,u,g);if(v){var y=.4*Math.random()+.8;r.scale.setd(y,y,y),r.translation.setd(0,0,0);var x=Math.random()*Math.PI*2,w=Math.sin(x),_=Math.cos(x);this.calcVec.setd(w,0,_),this.lookAt(r.rotation,this.calcVec,f),r.translation.setd(c,m,u),r.update();var b=this.vegetationList[v];o.addMeshData(b,r)}}var S=o.build();return S[0]},x.prototype.lookAt=function(t,e,o){var r=t._tempX,i=t._tempY,n=t._tempZ;i.setv(o).normalize(),r.setv(o).cross(e).normalize(),n.setv(i).cross(r);var a=t.data;return a[0]=r.data[0],a[1]=r.data[1],a[2]=r.data[2],a[3]=i.data[0],a[4]=i.data[1],a[5]=i.data[2],a[6]=n.data[0],a[7]=n.data[1],a[8]=n.data[2],this},x.prototype.createBase=function(t){var e=v.createQuad(t.w,t.h,10,10);e.attributeMap.BASE=l.createAttribute(1,"Float"),e.rebuildData(e.vertexCount,e.indexCount,!0),e.getAttributeBuffer(l.NORMAL).set([0,1,0,0,1,0,0,1,0,0,1,0]),e.getAttributeBuffer(l.TEXCOORD0).set([t.tx,t.ty,t.tx,t.ty+t.th,t.tx+t.tw,t.ty+t.th,t.tx+t.tw,t.ty]),e.getAttributeBuffer("BASE").set([0,t.h,t.h,0]);var o=new p,r=new n;r.translation.y=.5*t.h-.1*t.h,r.translation.z=.1*-t.w,r.update(),o.addMeshData(e,r),r.setRotationXYZ(0,.3*Math.PI,0),r.translation.x=.1*t.w,r.translation.z=.1*t.w,r.update(),o.addMeshData(e,r),r.setRotationXYZ(0,.3*-Math.PI,0),r.translation.x=.1*-t.w,r.translation.z=.1*t.w,r.update(),o.addMeshData(e,r);var i=o.build();return i[0]};var _={processors:[y.light.processor,function(t){y.USE_FOG?(t.defines.FOG=!0,t.uniforms.fogSettings=y.FOG_SETTINGS,t.uniforms.fogColor=y.FOG_COLOR):delete t.defines.FOG}],attributes:{vertexPosition:l.POSITION,vertexNormal:l.NORMAL,vertexUV0:l.TEXCOORD0,base:"BASE"},uniforms:{viewProjectionMatrix:h.VIEW_PROJECTION_MATRIX,worldMatrix:h.WORLD_MATRIX,cameraPosition:h.CAMERA,diffuseMap:h.DIFFUSE_MAP,discardThreshold:-.01,fogSettings:function(){return y.FOG_SETTINGS},fogColor:function(){return y.FOG_COLOR},time:h.TIME},builder:function(t,e){y.light.builder(t,e)},vshader:function(){return["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","attribute vec2 vertexUV0;","attribute float base;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","uniform float time;",y.light.prevertex,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","varying float dist;","void main(void) {","vec3 swayPos = vertexPosition;","swayPos.x += sin(time * 1.0 + swayPos.x * 0.5) * base * sin(time * 1.8 + swayPos.y * 0.6) * 0.1 + 0.08;","vec4 worldPos = worldMatrix * vec4(swayPos, 1.0);","vWorldPos = worldPos.xyz;","gl_Position = viewProjectionMatrix * worldPos;",y.light.vertex,"normal = (worldMatrix * vec4(vertexNormal, 0.0)).xyz;","texCoord0 = vertexUV0;","viewPosition = cameraPosition - worldPos.xyz;","dist = 1.0 - smoothstep(40.0, 50.0, length(viewPosition.xz));","}"].join("\n")},fshader:function(){return["uniform sampler2D diffuseMap;","uniform float discardThreshold;","uniform vec2 fogSettings;","uniform vec3 fogColor;",y.light.prefragment,"varying vec3 normal;","varying vec3 vWorldPos;","varying vec3 viewPosition;","varying vec2 texCoord0;","varying float dist;","void main(void)","{","vec4 final_color = texture2D(diffuseMap, texCoord0);","if (final_color.a < discardThreshold) discard;","final_color.a = min(final_color.a, dist);","if (final_color.a <= 0.0) discard;","vec3 N = normalize(normal);",y.light.fragment,"final_color.a = pow(final_color.a, 0.5);","#ifdef FOG","float d = pow(smoothstep(fogSettings.x, fogSettings.y, length(viewPosition)), 1.0);","final_color.rgb = mix(final_color.rgb, fogColor, d);","#endif","gl_FragColor = final_color;","}"].join("\n")}};return x}),define("goo/addons/terrain/TerrainHandler",["goo/addons/terrain/Terrain","goo/addons/terrain/Vegetation","goo/addons/terrain/Forrest","goo/math/Vector3","goo/util/Ajax","goo/math/Transform","goo/math/MathUtils","goo/renderer/Texture","goo/renderer/TextureCreator","goo/util/rsvp"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(i,n,a,s){this.goo=i,this.terrainSize=n,this.resourceFolder=s,this.terrain=new t(i,this.terrainSize,a),this.vegetation=new e,this.forrest=new o,this.hidden=!1,this.store=new r,this.settings=null,this.pick=!0,this.draw=!1,this.eventX=0,this.eventY=0}d.prototype.isEditing=function(){return!this.hidden},d.prototype.getHeightAt=function(t){return this.terrainQuery?this.terrainQuery.getHeightAt(t):0};var c=!1,u=!1,p=function(t){0===t.button&&(this.eventX=t.clientX,this.eventY=t.clientY,c=!0,u=t.altKey,this.pick=!0,this.draw=!0,console.log("mousedown"))},m=function(t){0===t.button&&(c=!1,this.draw=!1,console.log("mouseup"))},f=function(t){this.eventX=t.clientX,this.eventY=t.clientY,this.pick=!0,c&&(u=t.altKey,this.draw=!0)};return d.prototype.toggleEditMode=function(){this.terrain.toggleMarker(),this.hidden=!this.hidden,this.hidden?(this.goo.renderer.domElement.addEventListener("mousedown",p.bind(this),!1),this.goo.renderer.domElement.addEventListener("mouseup",m.bind(this),!1),this.goo.renderer.domElement.addEventListener("mouseout",m.bind(this),!1),this.goo.renderer.domElement.addEventListener("mousemove",f.bind(this),!1)):(this.goo.renderer.domElement.removeEventListener("mousedown",p),this.goo.renderer.domElement.removeEventListener("mouseup",m),this.goo.renderer.domElement.removeEventListener("mouseout",m),this.goo.renderer.domElement.removeEventListener("mousemove",f),this.terrainInfo=this.terrain.getTerrainData(),this.draw=!1,c=!1),this.forrest.toggle(),this.vegetation.toggle()},d.prototype.initLevel=function(t,e,o){this.settings=e;var r=this.terrainSize,i=this._loadData(t.heightMap),n=this._loadData(t.splatMap);return h.all([i,n]).then(function(e){var i,n=e[0],a=e[1];i=new Float32Array(n?n:r*r);var s;return s=new Uint8Array(a?a:r*r*4*4),this._load(t,i,s,o)}.bind(this))},d.prototype._loadData=function(t){var e=new h.Promise,o=new i;return o.get({url:this.resourceFolder+t,responseType:"arraybuffer"}).then(function(t){e.resolve(t.response)}.bind(this),function(){e.resolve(null)}.bind(this)),e},d.prototype._textureLoad=function(t){var e=new h.Promise;return(new l).loadTexture2D(t,{anisotropy:4},function(t){e.resolve(t)}),e},d.prototype._load=function(t,e,o,i){var n=[];return n.push(this._textureLoad(this.resourceFolder+t.ground1.texture)),n.push(this._textureLoad(this.resourceFolder+t.ground2.texture)),n.push(this._textureLoad(this.resourceFolder+t.ground3.texture)),n.push(this._textureLoad(this.resourceFolder+t.ground4.texture)),n.push(this._textureLoad(this.resourceFolder+t.ground5.texture)),n.push(this._textureLoad(this.resourceFolder+t.stone.texture)),h.all(n).then(function(n){this.terrain.init({heightMap:e,splatMap:o,ground1:n[0],ground2:n[1],ground3:n[2],ground4:n[3],ground5:n[4],stone:n[5]}),this.terrainInfo=this.terrain.getTerrainData();var s=this.terrainSize,h=new r,d=this.terrainQuery={getHeightAt:function(t){if(t[0]<0||t[0]>s-1||t[2]<0||t[2]>s-1)return-1e3;var e=t[0],o=s-t[2],r=Math.floor(e),i=Math.floor(o),n=e-r,l=o-i,h=r+1,d=i+1;r=a.moduloPositive(r,s),i=a.moduloPositive(i,s),h=a.moduloPositive(h,s),d=a.moduloPositive(d,s);var c=this.terrainInfo.heights[i*s+r],u=this.terrainInfo.heights[i*s+h],p=this.terrainInfo.heights[d*s+r],m=this.terrainInfo.heights[d*s+h];return a.lerp(l,a.lerp(n,c,u),a.lerp(n,p,m))}.bind(this),getNormalAt:function(t){var e=t[0],o=s-t[2],r=Math.floor(e),i=Math.floor(o),n=r+1,l=i+1;r=a.moduloPositive(r,s),i=a.moduloPositive(i,s),n=a.moduloPositive(n,s),l=a.moduloPositive(l,s);var d=this.terrainInfo.heights[i*s+r],c=this.terrainInfo.heights[i*s+n],u=this.terrainInfo.heights[l*s+r];return h.setd(d-c,1,u-d).normalize()}.bind(this),getVegetationType:function(e,o,r){var i=Math.random();if(a.smoothstep(.82,.91,r)<i)return null;if(this.terrainInfo){if(e=Math.floor(e),o=Math.floor(o),0>e||e>s-1||0>o||o>s-1)return null;e*=this.terrain.splatMult,o*=this.terrain.splatMult;var n=4*(o*s*this.terrain.splatMult+e),l=this.terrainInfo.splat[n+0]/255,h=this.terrainInfo.splat[n+1]/255,d=this.terrainInfo.splat[n+2]/255,c=this.terrainInfo.splat[n+3]/255,u=l>i?t.ground2:h>i?t.ground3:d>i?t.ground4:c>i?t.ground5:t.ground1,p=0;for(var m in u.vegetation)if(p+=u.vegetation[m],p>i)return m;return null}return null}.bind(this),getForrestType:function(e,o,r,i){if(a.smoothstep(.8,.88,r)<i)return null;if(this.terrainInfo){if(e=Math.floor(e),o=Math.floor(o),0>e||e>s-1||0>o||o>s-1)return null;e*=this.terrain.splatMult,o*=this.terrain.splatMult;var n=4*(o*s*this.terrain.splatMult+e),l=this.terrainInfo.splat[n+0]/255,h=this.terrainInfo.splat[n+1]/255,d=this.terrainInfo.splat[n+2]/255,c=this.terrainInfo.splat[n+3]/255,u=l>i?t.ground2:h>i?t.ground3:d>i?t.ground4:c>i?t.ground5:t.ground1,p=0;for(var m in u.forrest)if(p+=u.forrest[m],p>i)return m;return null}return null}.bind(this)},c=(new l).loadTexture2D(this.resourceFolder+t.vegetationAtlas);c.anisotropy=4;var u=t.vegetationTypes,p=(new l).loadTexture2D(this.resourceFolder+t.forrestAtlas);p.anisotropy=4;var m=(new l).loadTexture2D(this.resourceFolder+t.forrestAtlasNormals),f=t.forrestTypes;this.vegetation.init(this.goo.world,d,c,u),this.forrest.init(this.goo.world,d,p,m,f,i)}.bind(this))},d.prototype.updatePhysics=function(){this.terrain.updateAmmoBody()},d.prototype.initPhysics=function(){this.terrain.initAmmoBody()},d.prototype.update=function(t){var e=t.transformComponent.transform.translation;if(this.terrain){var o=this.settings;if(this.hidden&&this.pick&&(this.terrain.pick(t.cameraComponent.camera,this.eventX,this.eventY,this.store),this.terrain.setMarker("add",o.size,this.store.x,this.store.z,o.power,o.brushTexture),this.pick=!1),this.hidden&&this.draw){var r="add";u&&(r="sub");var i=[0,0,0,0];"ground2"===o.rgba?i=[1,0,0,0]:"ground3"===o.rgba?i=[0,1,0,0]:"ground4"===o.rgba?i=[0,0,1,0]:"ground5"===o.rgba&&(i=[0,0,0,1]),this.terrain.draw(o.mode,r,o.size,this.store.x,this.store.y,this.store.z,o.power*this.goo.world.tpf*60/100,o.brushTexture,i),this.terrain.updateTextures()}this.terrain.update(e)}this.vegetation&&this.vegetation.update(e.x,e.z),this.forrest&&this.forrest.update(e.x,e.z)},d}),define("goo/addons/water/FlatWaterRenderer",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/Camera","goo/math/Plane","goo/renderer/pass/RenderTarget","goo/math/Vector3","goo/math/Vector4","goo/renderer/Material","goo/renderer/TextureCreator","goo/renderer/shaders/ShaderFragment"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(t){t=t||{},this.useRefraction=void 0!==t.useRefraction?t.useRefraction:!0,this.waterCamera=new o(45,1,.1,2e3),this.renderList=[],this.waterPlane=new r;var e=Math.floor(window.innerWidth/(t.divider||2)),h=Math.floor(window.innerHeight/(t.divider||2));this.reflectionTarget=new i(e,h),this.useRefraction&&(this.refractionTarget=new i(e,h),this.depthTarget=new i(e,h));var d=s.createMaterial(c,"WaterMaterial");d.shader.defines.REFRACTION=this.useRefraction,d.cullState.enabled=!1;var p=t.normalsUrl||"../resources/water/waternormals3.png";d.setTexture("NORMAL_MAP",(new l).loadTexture2D(p)),d.setTexture("REFLECTION_MAP",this.reflectionTarget),this.useRefraction&&(d.setTexture("REFRACTION_MAP",this.refractionTarget),d.setTexture("DEPTH_MAP",this.depthTarget)),this.waterMaterial=d,this.followCam=!0,this.updateWaterPlaneFromEntity=void 0!==t.updateWaterPlaneFromEntity?this.updateWaterPlaneFromEntity:!0,this.calcVect=new n,this.camReflectDir=new n,this.camReflectUp=new n,this.camReflectLeft=new n,this.camLocation=new n,this.camReflectPos=new n,this.offset=new n,this.clipPlane=new a,this.waterEntity=null,this.depthMaterial=s.createMaterial(u,"depth")}d.prototype.process=function(t,e,o,r,i){e=e.filter(function(t){return t.meshRendererComponent.isReflectable});var n=this.waterPlane;this.waterCamera.copy(r),this.updateWaterPlaneFromEntity&&(n.constant=this.waterEntity.transformComponent.transform.translation.y);var a=r.translation.y>n.constant;if(this.waterEntity.skip=!0,a){this.useRefraction&&(o.process(this.waterCamera,e,this.renderList),this.clipPlane.setd(n.normal.x,-n.normal.y,n.normal.z,n.constant),this.waterCamera.setToObliqueMatrix(this.clipPlane),t.render(this.renderList,this.waterCamera,i,this.depthTarget,!0,this.depthMaterial),t.render(this.renderList,this.waterCamera,i,this.refractionTarget,!0));var s=this.calcVect,l=this.camReflectDir,h=this.camReflectUp,d=this.camReflectLeft,c=this.camLocation,u=this.camReflectPos;c.set(r.translation);var p=n.pseudoDistance(c);if(s.set(n.normal).mul(2*p),u.set(c.sub(s)),c.set(r.translation).add(r._direction),p=n.pseudoDistance(c),s.set(n.normal).mul(2*p),l.set(c.sub(s)).sub(u).normalize(),c.set(r.translation).add(r._up),p=n.pseudoDistance(c),s.set(n.normal).mul(2*p),h.set(c.sub(s)).sub(u).normalize(),d.set(h).cross(l).normalize(),this.waterCamera.translation.set(u),this.waterCamera._direction.set(l),this.waterCamera._up.set(h),this.waterCamera._left.set(d),this.waterCamera.normalize(),this.waterCamera.update(),this.skybox&&this.followCam){var m=this.skybox.transformComponent.worldTransform;m.translation.setv(u),m.update()}}if(this.waterMaterial.shader.uniforms.abovewater=a,o.process(this.waterCamera,e,this.renderList),t.setRenderTarget(this.reflectionTarget),t.clear(),this.skybox)if(this.skybox instanceof Array){this.clipPlane.setd(n.normal.x,n.normal.y,n.normal.z,n.constant),this.waterCamera.setToObliqueMatrix(this.clipPlane,10);for(var f=0;f<this.skybox.length;f++)t.render(this.skybox[f],this.waterCamera,i,this.reflectionTarget,!1),this.skybox[f].skip=!0}else t.render(this.skybox,this.waterCamera,i,this.reflectionTarget,!1),this.skybox.skip=!0;if(this.clipPlane.setd(n.normal.x,n.normal.y,n.normal.z,n.constant),this.waterCamera.setToObliqueMatrix(this.clipPlane),t.render(this.renderList,this.waterCamera,i,this.reflectionTarget,!1),this.waterEntity.skip=!1,this.skybox)if(this.skybox instanceof Array)for(var f=0;f<this.skybox.length;f++)this.skybox[f].skip=!1;else this.skybox.skip=!1;if(a&&this.skybox&&this.followCam){var g=r.translation,m=this.skybox.transformComponent.worldTransform;m.translation.setv(g).addv(this.offset),m.update(),this.waterCamera._updatePMatrix=!0}},d.prototype.setSkyBox=function(t){this.skybox=t,t.meshRendererComponent&&(this.skybox.meshRendererComponent.materials[0].depthState.enabled=!1,this.skybox.meshRendererComponent.materials[0].renderQueue=0,this.skybox.meshRendererComponent.cullMode="Never")},d.prototype.setWaterEntity=function(t){this.waterEntity=t,this.waterEntity.meshRendererComponent.materials[0]=this.waterMaterial};var c={defines:{REFRACTION:!1},attributes:{vertexPosition:t.POSITION,vertexNormal:t.NORMAL},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,normalMatrix:e.NORMAL_MATRIX,cameraPosition:e.CAMERA,normalMap:"NORMAL_MAP",reflection:"REFLECTION_MAP",refraction:"REFRACTION_MAP",depthmap:"DEPTH_MAP",vertexTangent:[1,0,0,1],waterColor:[.0625,.0625,.0625],abovewater:!0,fogColor:[1,1,1],sunDirection:[.66,.66,.33],sunColor:[1,1,.5],sunShininess:100,sunSpecPower:4,fogStart:0,fogScale:2e3,timeMultiplier:1,time:e.TIME,distortionMultiplier:.025,fresnelPow:2,normalMultiplier:3,fresnelMultiplier:1,waterScale:5,doFog:!0,resolution:e.RESOLUTION},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform vec4 vertexTangent;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 normalMatrix;","uniform vec3 cameraPosition;","uniform float waterScale;","varying vec2 texCoord0;","varying vec3 eyeVec;","varying vec4 viewCoords;","varying vec3 worldPos;","void main(void) {","	worldPos = (worldMatrix * vec4(vertexPosition, 1.0)).xyz;","	texCoord0 = worldPos.xz * waterScale;","	vec3 n = normalize((normalMatrix * vec4(vertexNormal.x, vertexNormal.y, -vertexNormal.z, 0.0)).xyz);","	vec3 t = normalize((normalMatrix * vec4(vertexTangent.xyz, 0.0)).xyz);","	vec3 b = cross(n, t) * vertexTangent.w;","	mat3 rotMat = mat3(t, b, n);","	vec3 eyeDir = worldPos - cameraPosition;","	eyeVec = eyeDir * rotMat;","	viewCoords = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewCoords;","}"].join("\n"),fshader:["uniform sampler2D normalMap;","uniform sampler2D reflection;","#ifdef REFRACTION","uniform sampler2D refraction;","uniform sampler2D depthmap;","#endif","uniform vec3 waterColor;","uniform bool abovewater;","uniform vec3 fogColor;","uniform float fogStart;","uniform float fogScale;","uniform float time;","uniform float timeMultiplier;","uniform float distortionMultiplier;","uniform float fresnelPow;","uniform vec3 sunDirection;","uniform vec3 sunColor;","uniform float sunShininess;","uniform float sunSpecPower;","uniform float normalMultiplier;","uniform float fresnelMultiplier;","uniform bool doFog;","uniform vec2 resolution;","varying vec2 texCoord0;","varying vec3 eyeVec;","varying vec4 viewCoords;","varying vec3 worldPos;","vec4 combineTurbulence(in vec2 coords) {","	float t = time * timeMultiplier;","	vec4 coarse1 = texture2D(normalMap, coords * vec2(0.0012, 0.001) + vec2(0.019 * t, 0.021 * t));","	vec4 coarse2 = texture2D(normalMap, coords * vec2(0.001, 0.0011) + vec2(-0.017 * t, 0.016 * t));","	vec4 detail1 = texture2D(normalMap, coords * vec2(0.008) + vec2(0.06 * t, 0.03 * t));","	vec4 detail2 = texture2D(normalMap, coords * vec2(0.006) + vec2(0.05 * t, -0.04 * t));","	return (detail1 * 0.25 + detail2 * 0.25 + coarse1 * 0.75 + coarse2 * 1.0) / 2.25 - 0.48;","}","#ifdef REFRACTION",h.methods.unpackDepth,"#endif","void main(void)","{","	float fogDist = clamp((viewCoords.z-fogStart)/fogScale,0.0,1.0);","	vec2 normCoords = texCoord0;","	vec4 noise = combineTurbulence(normCoords);","	vec3 normalVector = normalize(noise.xyz * vec3(normalMultiplier, normalMultiplier, 1.0));","	vec3 localView = normalize(eyeVec);","	float fresnel = dot(normalize(normalVector * vec3(fresnelMultiplier, fresnelMultiplier, 1.0)), localView);","	if ( abovewater == false ) {","		fresnel = -fresnel;","	}","	fresnel *= 1.0 - fogDist;","	float fresnelTerm = 1.0 - fresnel;","	fresnelTerm = pow(fresnelTerm, fresnelPow);","	fresnelTerm = clamp(fresnelTerm, 0.0, 1.0);","	fresnelTerm = fresnelTerm * 0.95 + 0.05;","	vec2 projCoord = viewCoords.xy / viewCoords.q;","	projCoord = (projCoord + 1.0) * 0.5;","	projCoord.y -= 1.0 / resolution.y;","#ifdef REFRACTION","	float depthUnpack = unpackDepth(texture2D(depthmap, projCoord));","	if (depthUnpack > 0.5) {depthUnpack = 0.0;}","	float depth2 = clamp(depthUnpack * 400.0, 0.0, 1.0);","	vec2 projCoordRefr = vec2(projCoord);","	projCoordRefr += (normalVector.xy * distortionMultiplier) * (depth2);","	projCoordRefr = clamp(projCoordRefr, 0.001, 0.999);","	depthUnpack = unpackDepth(texture2D(depthmap, projCoordRefr));","	float depth = clamp(depthUnpack * 40.0, 0.8, 1.0);","#endif","	projCoord += (normalVector.xy * distortionMultiplier);","	projCoord = clamp(projCoord, 0.001, 0.999);","	if ( abovewater == true ) {","		projCoord.x = 1.0 - projCoord.x;","	}","	vec4 waterColorX = vec4(waterColor, 1.0);","	vec4 reflectionColor = texture2D(reflection, projCoord);","	if ( abovewater == false ) {","		reflectionColor *= vec4(0.8,0.9,1.0,1.0);","		vec4 endColor = mix(reflectionColor,waterColorX,fresnelTerm);","		gl_FragColor = mix(endColor,waterColorX,fogDist);","	}","	else {","		vec3 sunSpecReflection = normalize(reflect(-sunDirection, normalVector));","		float sunSpecDirection = max(0.0, dot(localView, sunSpecReflection));","		vec3 specular = pow(sunSpecDirection, sunShininess) * sunSpecPower * sunColor;","		vec4 endColor = waterColorX;","#ifdef REFRACTION","		vec4 refractionColor = texture2D(refraction, projCoordRefr) * vec4(0.6);","		endColor = mix(refractionColor, waterColorX, depth);","#endif","		endColor = mix(endColor, reflectionColor, fresnelTerm);","		if (doFog) {","			gl_FragColor = (vec4(specular, 1.0) + mix(endColor,reflectionColor,fogDist)) * (1.0-fogDist) + vec4(fogColor, 1.0) * fogDist;","		} else {","			gl_FragColor = vec4(specular, 1.0) + mix(endColor,reflectionColor,fogDist);","		}","	}","}"].join("\n")},u={attributes:{vertexPosition:t.POSITION},uniforms:{viewProjectionMatrix:e.VIEW_PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,farPlane:e.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec4 vPosition;","void main(void) {","	vPosition = worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewProjectionMatrix * vPosition;","}"].join("\n"),fshader:["uniform float farPlane;",h.methods.packDepth,"varying vec4 vPosition;","void main(void)","{","	float linearDepth = abs(vPosition.y) / farPlane;","	gl_FragColor = packDepth(linearDepth);","}"].join("\n")};return d}),define("goo/addons/water/ProjectedGridWaterRenderer",["goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/Camera","goo/math/Plane","goo/renderer/pass/RenderTarget","goo/renderer/pass/FullscreenPass","goo/math/Vector3","goo/renderer/Material","goo/renderer/TextureCreator","goo/renderer/shaders/ShaderLib","goo/renderer/shaders/ShaderFragment"],function(t,e,o,r,i,n,a,s,l,h,d){"use strict";function c(e){this.waterCamera=new o(45,1,.1,2e3),this.renderList=[],this.waterPlane=new r,e=e||{};var d=window.innerWidth/(e.divider||4),c=window.innerHeight/(e.divider||4);this.renderTarget=new i(d,c),d=window.innerWidth/(e.divider||1),c=window.innerHeight/(e.divider||1),this.heightTarget=new i(d,c,{type:"Float"}),this.normalTarget=new i(d,c,{}),this.fullscreenPass=new n(h.normalmap),this.fullscreenPass.material.shader.uniforms.resolution=[d,c];var m=this.waterMaterial=s.createMaterial(u,"WaterMaterial");m.cullState.enabled=!1,m.setTexture("NORMAL_MAP",(new l).loadTexture2D("../resources/water/waternormals3.png")),m.setTexture("REFLECTION_MAP",this.renderTarget),m.setTexture("BUMP_MAP",this.heightTarget),m.setTexture("NORMAL_MAP_COARSE",this.normalTarget);var f=this.materialWire=s.createMaterial(h.simple,"mat");f.wireframe=!0,f.wireframeColor=[0,0,0],this.calcVect=new a,this.camReflectDir=new a,this.camReflectUp=new a,this.camReflectLeft=new a,this.camLocation=new a,this.camReflectPos=new a,this.waterEntity=null;var g=this.projData=new t(t.defaultMap([t.POSITION]),4,6);g.getAttributeBuffer(t.POSITION).set([0,0,0,1,0,0,1,1,0,0,1,0]),g.getIndexBuffer().set([1,3,0,2,3,1]);var v=s.createMaterial(p,"mat");this.projRenderable={meshData:g,materials:[v]}}c.prototype.updateHelper=function(e,o,r,i){var n=this.projData.getAttributeBuffer(t.POSITION);n[0]=e.x/e.w,n[1]=0,n[2]=e.z/e.w,n[3]=o.x/o.w,n[4]=0,n[5]=o.z/o.w,n[6]=r.x/r.w,n[7]=0,n[8]=r.z/r.w,n[9]=i.x/i.w,n[10]=0,n[11]=i.z/i.w,this.projData.setVertexDataUpdated()},c.prototype.process=function(t,e,o,r,i){var n=this.waterEntity.meshDataComponent.meshData;n.update(r),this.waterMaterial.shader.uniforms.intersectBottomLeft=[n.intersectBottomLeft.x,n.intersectBottomLeft.y,n.intersectBottomLeft.z,n.intersectBottomLeft.w],this.waterMaterial.shader.uniforms.intersectBottomRight=[n.intersectBottomRight.x,n.intersectBottomRight.y,n.intersectBottomRight.z,n.intersectBottomRight.w],this.waterMaterial.shader.uniforms.intersectTopLeft=[n.intersectTopLeft.x,n.intersectTopLeft.y,n.intersectTopLeft.z,n.intersectTopLeft.w],this.waterMaterial.shader.uniforms.intersectTopRight=[n.intersectTopRight.x,n.intersectTopRight.y,n.intersectTopRight.z,n.intersectTopRight.w],this.updateHelper(n.intersectBottomLeft,n.intersectBottomRight,n.intersectTopRight,n.intersectTopLeft),t.render(this.projRenderable,r,i,this.heightTarget,!0),this.fullscreenPass.render(t,this.normalTarget,this.heightTarget,0);var a=this.waterPlane;this.waterCamera.copy(r),a.constant=this.waterEntity.transformComponent.transform.translation.y;var s=r.translation.y>a.constant;if(s){var l=this.calcVect,h=this.camReflectDir,d=this.camReflectUp,c=this.camReflectLeft,u=this.camLocation,p=this.camReflectPos;u.set(r.translation);var m=a.pseudoDistance(u);if(l.set(a.normal).mul(2*m),p.set(u.sub(l)),u.set(r.translation).add(r._direction),m=a.pseudoDistance(u),l.set(a.normal).mul(2*m),h.set(u.sub(l)).sub(p).normalize(),u.set(r.translation).add(r._up),m=a.pseudoDistance(u),l.set(a.normal).mul(2*m),d.set(u.sub(l)).sub(p).normalize(),c.set(d).cross(h).normalize(),this.waterCamera.translation.set(p),this.waterCamera._direction.set(h),this.waterCamera._up.set(d),this.waterCamera._left.set(c),this.waterCamera.normalize(),this.waterCamera.update(),this.skybox){var f=this.skybox.transformComponent.worldTransform;f.translation.setv(p),f.update()}}if(this.waterMaterial.shader.uniforms.abovewater=s,this.waterEntity.skip=!0,this.renderList.length=0,o.process(this.waterCamera,e,this.renderList),t.render(this.renderList,this.waterCamera,i,this.renderTarget,!0),this.waterEntity.skip=!1,s&&this.skybox){var g=r.translation,f=this.skybox.transformComponent.worldTransform;f.translation.setv(g),f.update()}},c.prototype.setSkyBox=function(t){this.skybox=t},c.prototype.setWaterEntity=function(t){this.waterEntity=t,this.waterEntity.meshRendererComponent.cullMode="Never",this.waterEntity.meshRendererComponent.materials[0]=this.waterMaterial;var e=this.waterEntity.meshDataComponent.meshData;this.waterMaterial.shader.uniforms.density=[e.densityX,e.densityY]};var u={attributes:{vertexUV0:t.TEXCOORD0},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,normalMatrix:e.NORMAL_MATRIX,cameraPosition:e.CAMERA,normalMap:"NORMAL_MAP",reflection:"REFLECTION_MAP",bump:"BUMP_MAP",normalMapCoarse:"NORMAL_MAP_COARSE",vertexNormal:[0,-1,0],vertexTangent:[1,0,0,1],waterColor:[15,15,15],abovewater:!0,fogColor:[1,1,1,1],sunDirection:[.66,-.1,.66],coarseStrength:.25,detailStrength:2,fogStart:0,camNear:e.NEAR_PLANE,camFar:e.FAR_PLANE,time:e.TIME,intersectBottomLeft:[0,0,0,0],intersectTopLeft:[0,0,0,0],intersectTopRight:[0,0,0,0],intersectBottomRight:[0,0,0,0],grid:!1,heightMultiplier:50,density:[1,1]},vshader:["attribute vec2 vertexUV0;","uniform vec3 vertexNormal;","uniform vec4 vertexTangent;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform mat4 normalMatrix;","uniform vec3 cameraPosition;","uniform float time;","uniform vec3 sunDirection;","uniform float coarseStrength;","uniform float heightMultiplier;","uniform sampler2D bump;","uniform vec4 intersectBottomLeft;","uniform vec4 intersectTopLeft;","uniform vec4 intersectTopRight;","uniform vec4 intersectBottomRight;","varying vec2 texCoord0;","varying vec2 texCoord1;","varying vec3 eyeVec;","varying vec3 sunDir;","varying vec4 viewCoords;","varying vec3 worldPos;","varying vec3 normal;","void main(void) {","	vec4 pointTop = mix(intersectTopLeft, intersectTopRight, vertexUV0.x);","	vec4 pointBottom = mix(intersectBottomLeft, intersectBottomRight, vertexUV0.x);","	vec4 pointFinal = mix(pointTop, pointBottom, 1.0 - vertexUV0.y);","	pointFinal.xz /= pointFinal.w;","	pointFinal.y = 0.0;","	vec4 screenpos = projectionMatrix * viewMatrix * worldMatrix * vec4(pointFinal.xyz, 1.0);","	vec2 projCoord = screenpos.xy / screenpos.q;","	projCoord = (projCoord + 1.0) * 0.5;","	float height = texture2D(bump, projCoord).x;","	pointFinal.y = height * heightMultiplier;","	texCoord1 = vertexUV0;","	vec4 pos = worldMatrix * vec4(pointFinal.xyz, 1.0);","	worldPos = pos.xyz;","	texCoord0 = worldPos.xz * 2.0;","	vec3 n = normalize((normalMatrix * vec4(vertexNormal, 0.0)).xyz);","	vec3 t = normalize((normalMatrix * vec4(vertexTangent.xyz, 0.0)).xyz);","	vec3 b = cross(n, t) * vertexTangent.w;","	mat3 rotMat = mat3(t, b, n);","	vec3 eyeDir = worldPos - cameraPosition;","	eyeVec = eyeDir * rotMat;","	sunDir = sunDirection * rotMat;","	viewCoords = projectionMatrix * viewMatrix * pos;","	gl_Position = viewCoords;","}"].join("\n"),fshader:["uniform sampler2D normalMap;","uniform sampler2D reflection;","uniform sampler2D normalMapCoarse;","uniform vec3 waterColor;","uniform bool abovewater;","uniform vec4 fogColor;","uniform float time;","uniform bool grid;","uniform vec2 density;","uniform float camNear;","uniform float camFar;","uniform float fogStart;","uniform float coarseStrength;","uniform float detailStrength;","varying vec2 texCoord0;","varying vec2 texCoord1;","varying vec3 eyeVec;","varying vec3 sunDir;","varying vec4 viewCoords;","varying vec3 worldPos;","varying vec3 normal;","const vec3 sunColor = vec3(1.0, 0.96, 0.96);","vec4 getNoise(vec2 uv) {","    vec2 uv0 = (uv/123.0)+vec2(time/17.0, time/29.0);","    vec2 uv1 = uv/127.0-vec2(time/-19.0, time/31.0);","    vec2 uv2 = uv/vec2(897.0, 983.0)+vec2(time/51.0, time/47.0);","    vec2 uv3 = uv/vec2(991.0, 877.0)-vec2(time/59.0, time/-63.0);","    vec4 noise = (texture2D(normalMap, uv0)) +","                 (texture2D(normalMap, uv1)) +","                 (texture2D(normalMap, uv2)*3.0) +","                 (texture2D(normalMap, uv3)*3.0);","    return noise/4.0-1.0;","}","void main(void)","{","	vec2 projCoord = viewCoords.xy / viewCoords.q;","	projCoord = (projCoord + 1.0) * 0.5;","	float fs = camFar * fogStart;","	float fogDist = clamp(max(viewCoords.z - fs, 0.0)/(camFar - camNear - fs), 0.0, 1.0);","	vec3 coarseNormal = texture2D(normalMapCoarse, projCoord).xyz * 2.0 - 1.0;","	vec2 normCoords = texCoord0;","	vec4 noise = getNoise(normCoords);","	vec3 normalVector = normalize(noise.xyz * vec3(1.8 * detailStrength, 1.8 * detailStrength, 1.0) + coarseNormal.xyz * vec3(1.8 * coarseStrength, 1.8 * coarseStrength, 1.0));","	vec3 localView = normalize(eyeVec);","	float fresnel = dot(normalize(normalVector*vec3(1.0, 1.0, 1.0)), localView);","	if ( abovewater == false ) {","		fresnel = -fresnel;","	}","	float fresnelTerm = 1.0 - fresnel;","	fresnelTerm *= fresnelTerm;","	fresnelTerm *= fresnelTerm;","	fresnelTerm = fresnelTerm * 0.95 + 0.05;","	if ( abovewater == true ) {","		projCoord.x = 1.0 - projCoord.x;","	}","	projCoord += (normalVector.xy * 0.05);","	projCoord = clamp(projCoord, 0.001, 0.999);"," vec4 waterColorX = vec4(waterColor / 255.0, 1.0);","	vec4 reflectionColor = texture2D(reflection, projCoord);","	if ( abovewater == false ) {","		reflectionColor *= vec4(0.8,0.9,1.0,1.0);","		vec4 endColor = mix(reflectionColor,waterColorX,fresnelTerm);","		gl_FragColor = mix(endColor,waterColorX,fogDist);","	}","	else {","		vec3 diffuse = vec3(0.0);","		vec3 specular = vec3(0.0);","		vec3 sunreflection = normalize(reflect(-sunDir, normalVector));","		float direction = max(0.0, dot(localView, sunreflection));","		specular += pow(direction, 100.0)*sunColor * 2.0;","		diffuse += max(dot(sunDir, normalVector),0.0)*sunColor*0.4;","		vec4 endColor = mix(waterColorX,reflectionColor,fresnelTerm);","		gl_FragColor = mix(vec4(diffuse*0.0 + specular, 1.0) + mix(endColor,reflectionColor,fogDist), fogColor, fogDist);","	}","	if (grid) {","		vec2 low = abs(fract(texCoord1*density)-0.5);","		float dist = 1.0 - step(min(low.x, low.y), 0.05);","		gl_FragColor *= vec4(dist);","	}","}"].join("\n")},p={attributes:{vertexPosition:t.POSITION},uniforms:{viewMatrix:e.VIEW_MATRIX,projectionMatrix:e.PROJECTION_MATRIX,worldMatrix:e.WORLD_MATRIX,time:e.TIME},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 worldPos;","varying vec4 viewCoords;","void main(void) {","	worldPos = worldMatrix * vec4(vertexPosition, 1.0);","	viewCoords = viewMatrix * worldPos;","	gl_Position = projectionMatrix * viewMatrix * worldPos;","}"].join("\n"),fshader:["precision mediump float;","uniform float time;","varying vec4 worldPos;","varying vec4 viewCoords;",d.noise3d,"vec4 getNoise(sampler2D map, vec2 uv) {","    vec2 uv0 = (uv/223.0)+vec2(time/17.0, time/29.0);","    vec2 uv1 = uv/327.0-vec2(time/-19.0, time/31.0);","    vec2 uv2 = uv/vec2(697.0, 983.0)+vec2(time/151.0, time/147.0);","    vec2 uv3 = uv/vec2(791.0, 877.0)-vec2(time/259.0, time/263.0);","    vec4 noise = (texture2D(map, uv0)*0.0) +","                 (texture2D(map, uv1)*0.0) +","                 (texture2D(map, uv2)*0.0) +","                 (texture2D(map, uv3)*10.0);","    return noise/5.0-1.0;","}","void main(void)","{","	float fogDist = clamp(-viewCoords.z / 1000.0, 0.0, 1.0);","	gl_FragColor = vec4((snoise(vec3(worldPos.xz * 0.008, time * 0.4))+snoise(vec3(worldPos.xz * 0.02, time * 0.8))*0.5)/10.0);","}"].join("\n")};
return c}),define("goo/debug/BoundingVolumeMeshBuilder",["goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/util/MeshBuilder","goo/renderer/MeshData","goo/math/Transform"],function(t,e,o,r,i){"use strict";function n(){}function a(t,e,o){var i=[t,e,o,t,e,-o,t,-e,o,t,-e,-o,-t,e,o,-t,e,-o,-t,-e,o,-t,-e,-o],n=[0,1,0,2,1,3,2,3,4,5,4,6,5,7,6,7,0,4,1,5,2,6,3,7],a=new r(r.defaultMap([r.POSITION]),i.length/3,n.length);return a.getAttributeBuffer(r.POSITION).set(i),a.getIndexBuffer().set(n),a.indexLengths=null,a.indexModes=["Lines"],a}function s(t,e){t=t||1,e=e||8;for(var o=[],i=[],n=2*Math.PI/e,a=0,s=0;e>a;a++,s+=n)o.push(Math.cos(s)*t,Math.sin(s)*t,0),i.push(a,a+1);i[i.length-1]=0;var l=new r(r.defaultMap([r.POSITION]),e,i.length);return l.getAttributeBuffer(r.POSITION).set(o),l.getIndexBuffer().set(i),l.indexLengths=null,l.indexModes=["Lines"],l}function l(t){t=t||1;var e,r=new o,n=128,a=s(t,n);e=new i,r.addMeshData(a,e),e=new i,e.rotation.fromAngles(0,Math.PI/2,0),e.update(),r.addMeshData(a,e),e=new i,e.rotation.fromAngles(Math.PI/2,Math.PI/2,0),e.update(),r.addMeshData(a,e);var l=r.build();return l[0]}return n.buildBox=function(t){var e=a(t.xExtent,t.yExtent,t.zExtent);return e},n.buildSphere=function(t){var e=l(t.radius);return e},n.build=function(o){return o instanceof t?n.buildBox(o):o instanceof e?n.buildSphere(o):void 0},n}),define("goo/shapes/debug/LightDebug",["goo/renderer/MeshData","goo/util/MeshBuilder","goo/math/Transform","goo/shapes/ShapeCreator","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight"],function(t,e,o,r,i,n,a){"use strict";function s(){this._ball=r.createSphere(12,12,.3),this._pointLightMesh=s._buildPointLightMesh(),this._spotLightMesh=s._buildSpotLightMesh(),this._directionalLightMesh=s._buildDirectionalLightMesh()}function l(e,o){e=e||1,o=o||8;for(var r=[],i=[],n=2*Math.PI/o,a=0,s=0;o>a;a++,s+=n)r.push(Math.cos(s)*e,Math.sin(s)*e,0),i.push(a,a+1);i[i.length-1]=0;var l=new t(t.defaultMap([t.POSITION]),o,i.length);return l.getAttributeBuffer(t.POSITION).set(r),l.getIndexBuffer().set(i),l.indexLengths=null,l.indexModes=["Lines"],l}function h(){var t,r=1,i=new e,n=128,a=l(r,n);t=new o,i.addMeshData(a,t),t=new o,t.rotation.fromAngles(0,Math.PI/2,0),t.update(),i.addMeshData(a,t),t=new o,t.rotation.fromAngles(Math.PI/2,Math.PI/2,0),t.update(),i.addMeshData(a,t);var s=i.build();return s[0]}function d(e){e=e||8;for(var o=[0,0,0],r=[],i=2*Math.PI/e,n=0,a=0;e>n;n++,a+=i)o.push(Math.cos(a),Math.sin(a),1),r.push(0,n+1);var s=new t(t.defaultMap([t.POSITION]),e+1,r.length);return s.getAttributeBuffer(t.POSITION).set(o),s.getIndexBuffer().set(r),s.indexLengths=null,s.indexModes=["Lines"],s}function c(){for(var t=-1,r=new e,i=64,n=2,a=t/2,s=a,h=1;n>=h;h++){var c=l(s*h,i),u=new o;u.translation.set(0,0,a*h),u.update(),r.addMeshData(c,u)}var p=d(4),u=new o;u.scale.set(s*n,s*n,a*n),u.update(),r.addMeshData(p,u);var m=r.build();return m[0]}function u(e){e=e||8;for(var o=[],r=[],i=2*Math.PI/e,n=0,a=0;e>n;n++,a+=i)o.push(Math.cos(a),Math.sin(a),0),o.push(Math.cos(a),Math.sin(a),1),r.push(2*n,2*n+1);var s=new t(t.defaultMap([t.POSITION]),2*e,r.length);return s.getAttributeBuffer(t.POSITION).set(o),s.getIndexBuffer().set(r),s.indexLengths=null,s.indexModes=["Lines"],s}function p(){for(var t=new e,r=64,i=2,n=10/i,a=1,s=0;i>s;s++){var h=l(a,r),d=new o;d.translation.set(0,0,-n*s),d.update(),t.addMeshData(h,d)}var c=u(4),d=new o;d.scale.set(a,a,-n*i),d.update(),t.addMeshData(c,d);var p=t.build();return p[0]}return s.prototype.getMesh=function(t,e){return t instanceof i?e.full?[this._ball,this._pointLightMesh]:[this._ball]:t instanceof a?e.full?[this._ball,this._spotLightMesh]:[this._ball]:t instanceof n?e.full?[this._ball,this._directionalLightMesh]:[this._ball]:void 0},s._buildPointLightMesh=function(){return h()},s._buildSpotLightMesh=function(){return c()},s._buildDirectionalLightMesh=function(){return p()},s}),define("goo/shapes/debug/CameraDebug",["goo/renderer/MeshData","goo/util/MeshBuilder","goo/math/Transform","goo/shapes/Box","goo/shapes/Cylinder"],function(t,e,o,r,i){"use strict";function n(){this._camera=n.buildCamera()}return n.prototype.getMesh=function(t,e){return e.full?[this._camera,n.buildFrustum(t)]:[this._camera]},n.buildFrustum=function(e){var o,r,i=e.near,n=e.far,a=e.aspect;if(0===e.projectionMode){var s=Math.tan(e.fov/2*Math.PI/180);o=s*n,r=s*i}else{var l=e.size||100;o=l,r=l}var h,d,c,u;h={x:-o*a,y:o,z:-n},d={x:-o*a,y:-o,z:-n},c={x:o*a,y:-o,z:-n},u={x:o*a,y:o,z:-n};var p,m,f,g;p={x:-r*a,y:r,z:-i},m={x:-r*a,y:-r,z:-i},f={x:r*a,y:-r,z:-i},g={x:r*a,y:r,z:-i};var v=[];v.push(h.x,h.y,h.z),v.push(d.x,d.y,d.z),v.push(c.x,c.y,c.z),v.push(u.x,u.y,u.z),v.push(p.x,p.y,p.z),v.push(m.x,m.y,m.z),v.push(f.x,f.y,f.z),v.push(g.x,g.y,g.z);var y=[];y.push(0,1),y.push(1,2),y.push(2,3),y.push(3,0),y.push(4,5),y.push(5,6),y.push(6,7),y.push(7,4),y.push(0,4),y.push(1,5),y.push(2,6),y.push(3,7);var x=new t(t.defaultMap([t.POSITION]),8,24);return x.getAttributeBuffer(t.POSITION).set(v),x.getIndexBuffer().set(y),x.indexLengths=null,x.indexModes=["Lines"],x},n.buildCamera=function(){var n=new e,a=new o,s=new i(32,.6),l=new i(32,.6),h=new r(.3,1,1.6),d=new r(.2,.15,.7);d.applyFunction(t.POSITION,function(t){return[t.x+t.x/(.3*(t.z+1.1)),t.y+t.y/(.3*(t.z+1.1)),t.z]}),a.translation.setd(0,0,0),a.update(),n.addMeshData(d,a),a.translation.setd(0,0,1.3),a.update(),n.addMeshData(h,a),a.scale.setd(1,1,.5),a.setRotationXYZ(0,Math.PI/2,0),a.translation.setd(0,1.2,.6),a.update(),n.addMeshData(s,a),a.translation.setd(0,1.2,2),a.update(),n.addMeshData(l,a);var c=n.build();return c[0]},n}),define("goo/shapes/debug/MeshRendererDebug",["goo/renderer/MeshData"],function(t){"use strict";function e(){this._meshes=[o(1,1,1),null]}function o(e,o,r){var i=[e,o,r,e,o,-r,e,-o,r,e,-o,-r,-e,o,r,-e,o,-r,-e,-o,r,-e,-o,-r],n=[0,1,0,2,1,3,2,3,4,5,4,6,5,7,6,7,0,4,1,5,2,6,3,7],a=new t(t.defaultMap([t.POSITION]),i.length/3,n.length);return a.getAttributeBuffer(t.POSITION).set(i),a.getIndexBuffer().set(n),a.indexLengths=null,a.indexModes=["Lines"],a}return e.prototype.getMesh=function(){return this._meshes},e}),define("goo/shapes/debug/SkeletonDebug",["goo/shapes/Box","goo/math/Transform","goo/animation/Joint","goo/util/MeshBuilder","goo/renderer/MeshData"],function(t,e,o,r,i){"use strict";function n(){}var a=new e;return n.prototype.getMesh=function(t){var e=t._skeleton._joints;return[this._buildLines(e),this._buildBoxes(e)]},n.prototype._buildBoxes=function(e){var o=new r,n=new t(2,2,2);n.attributeMap.WEIGHTS=i.createAttribute(4,"Float"),n.attributeMap.JOINTIDS=i.createAttribute(4,"Float"),n.rebuildData(),n.rebuild();for(var s=0;s<e.length;s++)a.matrix.copy(e[s]._inverseBindPose.matrix).invert(),this._stuffBox(n,e[s]),o.addMeshData(n,a);var l=o.build(),h=l[0];return this._buildPaletteMap(h,e),h},n.prototype._buildLines=function(t){for(var e=[],r=[],n=[],s=[],l=0,h=a.matrix.data,d=0;d<t.length;d++){var c=t[d];if(c._parentIndex!==o.NO_PARENT){var u=t[c._parentIndex];r.push(1,0,0,0,1,0,0,0),n.push(c._index,0,0,0,u._index,0,0,0),s.push(2*l,2*l+1),l++,a.matrix.copy(c._inverseBindPose.matrix).invert(),e.push(h[12],h[13],h[14]),a.matrix.copy(u._inverseBindPose.matrix).invert(),e.push(h[12],h[13],h[14])}}var p=new i(i.defaultMap([i.POSITION,i.WEIGHTS,i.JOINTIDS]),e.length/3,s.length);return p.indexModes=["Lines"],p.getAttributeBuffer(i.POSITION).set(e),p.getAttributeBuffer(i.WEIGHTS).set(r),p.getAttributeBuffer(i.JOINTIDS).set(n),p.getIndexBuffer().set(s),this._buildPaletteMap(p,t),p},n.prototype._stuffBox=function(t,e){for(var o=t.getAttributeBuffer("WEIGHTS"),r=t.getAttributeBuffer("JOINTIDS"),i=0;i<o.length;i+=4)o[i]=1,r[i]=e._index},n.prototype._buildPaletteMap=function(t,e){for(var o=[],r=0;r<e.length;r++)o[r]=e[r]._index;t.paletteMap=o,t.weightsPerVertex=4},n}),define("goo/debug/DebugDrawHelper",["goo/entities/components/LightComponent","goo/entities/components/CameraComponent","goo/entities/components/MeshRendererComponent","goo/animation/SkeletonPose","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight","goo/shapes/debug/LightDebug","goo/shapes/debug/CameraDebug","goo/shapes/debug/MeshRendererDebug","goo/shapes/debug/SkeletonDebug","goo/renderer/Material","goo/renderer/Util","goo/renderer/shaders/ShaderLib","goo/renderer/shaders/ShaderBuilder","goo/math/Transform"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m,f){"use strict";var g={},v=new s,y=new l,x=new h,w=new d;return g.getRenderablesFor=function(t,e){var o,i;if("LightComponent"===t.type)o=v.getMesh(t.light,e),i=c.createMaterial(p.simpleColored,"DebugDrawLightMaterial");else if("CameraComponent"===t.type)o=y.getMesh(t.camera,e),i=c.createMaterial(p.simpleLit,"DebugDrawCameraMaterial"),i.uniforms.materialAmbient=[.4,.4,.4,1],i.uniforms.materialDiffuse=[.6,.6,.6,1],i.uniforms.materialSpecular=[0,0,0,1];else if("MeshRendererComponent"===t.type)o=x.getMesh(),i=c.createMaterial(p.simpleColored,"DebugMeshRendererComponentMaterial");else if(t instanceof r){o=w.getMesh(t,e);for(var n=[c.createMaterial(p.uber,"SkeletonDebugMaterial"),c.createMaterial(p.uber,"SkeletonDebugMaterial")],a=[],s=n.length;s--;){var i=n[s];i.depthState={enabled:!1,write:!1},i.renderQueue=3e3,i.uniforms.materialDiffuse=[0,0,0,1],i.uniforms.materialDiffuse[s]=.8,i.uniforms.materialAmbient=[0,0,0,1],i.uniforms.materialAmbient[s]=.5,a[s]={meshData:o[s],transform:new f,materials:[i],currentPose:t}}return a}return o.map(function(t){return{meshData:t,transform:new f,materials:[i]}})},g.update=function(t,e,o){if(e.camera&&e.camera.changedProperties){var r=e.camera;t.length>1&&(r.far/r.near!==t[1].farNear||r.fov!==t[1].fov||r.size!==t[1].size||r.aspect!==t[1].aspect||r.projectionMode!==t[1].projectionMode)&&(t[1].meshData=l.buildFrustum(r),t[1].farNear=r.far/r.near,t[1].fov=r.fov,t[1].size=r.size,t[1].aspect=r.aspect,t[1].projectionMode=r.projectionMode),e.camera.changedProperties=!1}g[e.type].updateMaterial(t[0].materials[0],e),t[1]&&g[e.type].updateMaterial(t[1].materials[0],e),t[1]&&g[e.type].updateTransform(t[1].transform,e);var i=t[0].transform.translation.distance(o)/30;t[0].transform.scale.setd(i,i,i),t[0].transform.update(),e.light&&e.light instanceof n&&(t[1]&&t[1].transform.scale.scale(i),t[1]&&t[1].transform.update())},g.LightComponent={},g.CameraComponent={},g.LightComponent.updateMaterial=function(t,e){var o=e.light,r=t.uniforms.color=t.uniforms.color||[];r[0]=o.color.data[0],r[1]=o.color.data[1],r[2]=o.color.data[2]},g.LightComponent.updateTransform=function(t,e){var o=e.light;if(!(o instanceof n)){var r=o.range;if(t.scale.setd(r,r,r),o instanceof a){var i=o.angle*Math.PI/180,s=Math.tan(i/2);t.scale.muld(s,s,1)}}t.update()},g.CameraComponent.updateMaterial=function(t){t.uniforms.color=t.uniforms.color||[1,1,1]},g.CameraComponent.updateTransform=function(){},g}),define("goo/debug/components/MarkerComponent",["goo/entities/components/Component","goo/shapes/ShapeCreator","goo/debug/BoundingVolumeMeshBuilder"],function(t,e,o){"use strict";function r(t){this.type="MarkerComponent";var e=t.meshRendererComponent.worldBound;this.meshData=o.build(e)}return r.prototype=Object.create(t.prototype),r}),define("goo/debug/systems/MarkerSystem",["goo/entities/systems/System","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/shapes/ShapeCreator","goo/debug/components/MarkerComponent","goo/renderer/Renderer","goo/math/Transform"],function(t,e,o,r,i,n,a){"use strict";function s(r){t.call(this,"MarkerSystem",["MarkerComponent"]),this.material=e.createMaterial(o.simpleColored,""),this.material.depthState.enabled=!1,this.material.shader.uniforms.color=[0,1,0],this.goo=r,this.renderer=this.goo.renderer,this.entities=[],this.goo.callbacks.push(function(){for(var t=0;t<this.entities.length;t++){var e=this.entities[t];if(e.hasComponent("MarkerComponent")){var o=new a;o.copy(e.transformComponent.worldTransform),o.setRotationXYZ(0,0,0),o.scale.setd(1,1,1),o.update();var r={meshData:e.markerComponent.meshData,materials:[this.material],transform:o};this.goo.renderer.render(r,n.mainCamera,[],null,!1)}}}.bind(this))}return s.prototype=Object.create(t.prototype),s.prototype.process=function(t){this.entities=t},s}),define("goo/debug/Debugger",["goo/debug/components/MarkerComponent","goo/debug/systems/MarkerSystem"],function(MarkerComponent,MarkerSystem){"use strict";function Debugger(t){this.goo=null,this.exportPicked=t||!1,this.picked=null,this.oldPicked=null}function createPanel(){var t=document.createElement("div");t.id="debugdiv";var e='<span style="font-size: x-small;font-family: sans-serif">Filter</span><br /><textarea cols="30" id="debugparams">name, Compo, tran, data</textarea><br /><span style="font-size: x-small;font-family: sans-serif">Result</span><br /><textarea readonly rows="10" cols="30" id="debugtex">Click on an entity</textarea><br />';e+='<hr /><span style="font-size: x-small;font-family: sans-serif">REPL</span><br /><textarea readonly rows="10" cols="30" id="replouttex">...</textarea><br /><textarea cols="30" id="replintex">entity.</textarea>',t.innerHTML=e,t.style.position="absolute",t.style.zIndex="2001",t.style.backgroundColor="#DDDDDD",t.style.left="10px",t.style.top="100px",t.style.webkitTouchCallout="none",t.style.webkitUserSelect="none",t.style.khtmlUserSelect="none",t.style.mozUserSelect="none",t.style.msUserSelect="none",t.style.userSelect="none",t.style.padding="3px",t.style.borderRadius="6px",document.body.appendChild(t)}function getFilterList(t){return t.split(",").map(function(t){return t.replace(/(^[\s]+|[\s]+$)/g,"")}).filter(function(t){return t.length>0}).map(function(t){return new RegExp(t)})}function stringifyTypedArray(t){if(0===t.length)return"[]";for(var e="["+t[0],o=1;o<t.length;o++)e+=" "+t[o];return e+="]"}function filterProperties(t,e,o,r){if(0===e.length)return"No interests specified;\n\nSome popular interests: is, tran, Compo\n\nEvery entry separated by a comma is a regex";if(0>r)return o+"REACHED MAXIMUM DEPH\n";if(null===t)return o+"null\n";var i=typeof t;if("undefined"===i||"number"===i||"boolean"===i||"string"===i||t instanceof Array&&("string"==typeof t[0]||"number"==typeof t[0]||"boolean"==typeof t[0]))return o+JSON.stringify(t)+"\n";if(-1!==Object.prototype.toString.call(t).indexOf("Array]"))return o+stringifyTypedArray(t)+"\n";var n=[];for(var a in t)if(t.hasOwnProperty(a)){if("function"==typeof t[a])continue;for(var s in e)if(e[s].test(a)){var l=filterProperties(t[a],e,o+" ",r-1);n.push(o+a+"\n"+l);break}}return n.join("")}function updateMarker(t,e){t!==e?(null!==e&&e.hasComponent("MarkerComponent")&&e.clearComponent("MarkerComponent"),null!==t&&t.setComponent(new MarkerComponent(t))):t.hasComponent("MarkerComponent")?t.clearComponent("MarkerComponent"):t.setComponent(new MarkerComponent(t))}function displayInfo(t){var e=getFilterList(document.getElementById("debugparams").value);t&&console.log("==> ",t);var o=filterProperties(t,e,"",20),r=document.getElementById("debugtex");r.value=o}return Debugger.prototype._setUpREPL=function(){var lastCommStr="";document.getElementById("replintex").addEventListener("keyup",function(event){event.stopPropagation();var replinElemHandle=document.getElementById("replintex"),reploutElemHandle=document.getElementById("replouttex");if(13!==event.keyCode||event.shiftKey)38===event.keyCode&&(replinElemHandle.value=lastCommStr);else{var commStr=replinElemHandle.value.substr(0,replinElemHandle.value.length-1);lastCommStr=commStr;var entity=this.picked,goo=this.goo,resultStr="";try{resultStr+=eval(commStr)}catch(err){resultStr+=err}replinElemHandle.value="entity.",reploutElemHandle.value+="\n-------\n"+resultStr,displayInfo(this.picked)}}.bind(this),!1)},Debugger.prototype._setUpPicking=function(){document.addEventListener("mouseup",function(t){t.stopPropagation();var e=t.pageX,o=t.pageY;this.goo.pick(e,o,function(t){var e=this.goo.world.entityManager.getEntityByIndex(t);e&&(this.oldPicked=this.picked,this.picked=e,this.picked===this.oldPicked&&(this.picked=null),this.exportPicked&&(window.picked=this.picked),displayInfo(this.picked),updateMarker(this.picked,this.oldPicked))}.bind(this))}.bind(this),!1)},Debugger.prototype.inject=function(t){return this.goo=t,createPanel(),this.goo.world.getSystem("MarkerSystem")||this.goo.world.setSystem(new MarkerSystem(this.goo)),this._setUpPicking(),document.getElementById("debugparams").addEventListener("keyup",function(){displayInfo(this.picked)}.bind(this)),this._setUpREPL(),this},Debugger}),define("goo/debug/EntityCounter",[],function(){"use strict";function t(t){this.goo=null,this.skipFrames=t||20,this.texHandle=null}function e(){var t=document.createElement("div");t.id="_entitycounterdiv";var e='<span style="font-size: x-small;font-family: sans-serif">Counter</span><br /><textarea cols="30" rows="6" id="_entitycountertex">...</textarea>';return t.innerHTML=e,t.style.position="absolute",t.style.zIndex="2001",t.style.backgroundColor="#BBBBBB",t.style.left="10px",t.style.bottom="10px",t.style.webkitTouchCallout="none",t.style.webkitUserSelect="none",t.style.khtmlUserSelect="none",t.style.mozUserSelect="none",t.style.msUserSelect="none",t.style.userSelect="none",t.style.padding="3px",t.style.borderRadius="6px",document.body.appendChild(t),document.getElementById("_entitycountertex")}return t.prototype.inject=function(t){this.goo=t,this.texHandle=e();var o=this,r=0;return this.goo.callbacks.push(function(){if(r--,0>=r){r=o.skipFrames;var t="";for(var e in o.goo.world._systems){var i=o.goo.world._systems[e];t+=i.type+": "+i._activeEntities.length+"\n"}o.texHandle.value=t}}),this},t}),define("goo/debug/FrustumViewer",["goo/renderer/MeshData","goo/util/MeshBuilder","goo/math/Transform","goo/shapes/ShapeCreator","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/shapes/Box","goo/shapes/Cylinder"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(){}function c(e,o,r,i){var n,a,s,l,h=e*Math.PI/180/2,d=Math.tan(h);n={x:-d*i*o,y:d*i,z:-i},a={x:-d*i*o,y:-d*i,z:-i},s={x:d*i*o,y:-d*i,z:-i},l={x:d*i*o,y:d*i,z:-i};var c,u,p,m;c={x:-d*r*o,y:d*r,z:-r},u={x:-d*r*o,y:-d*r,z:-r},p={x:d*r*o,y:-d*r,z:-r},m={x:d*r*o,y:d*r,z:-r};var f=[];f.push(n.x,n.y,n.z),f.push(a.x,a.y,a.z),f.push(s.x,s.y,s.z),f.push(l.x,l.y,l.z),f.push(c.x,c.y,c.z),f.push(u.x,u.y,u.z),f.push(p.x,p.y,p.z),f.push(m.x,m.y,m.z);var g=[];g.push(0,1),g.push(1,2),g.push(2,3),g.push(3,0),g.push(4,5),g.push(5,6),g.push(6,7),g.push(7,4),g.push(0,4),g.push(1,5),g.push(2,6),g.push(3,7);var v=new t(t.defaultMap([t.POSITION]),8,24);return v.getAttributeBuffer(t.POSITION).set(f),v.getIndexBuffer().set(g),v.indexLengths=null,v.indexModes=["Lines"],v}function u(r){var i=new e,n=new o,a=c(r.fov,r.aspect,r.near,r.far);i.addMeshData(a,n);var s=new h(32,.6),d=new h(32,.6),u=new l(.3,1,1.6),p=new l(.2,.15,.7);p.applyFunction(t.POSITION,function(t){return[t.x+t.x/(.3*(t.z+1.1)),t.y+t.y/(.3*(t.z+1.1)),t.z]}),n.translation.setd(0,0,0),n.update(),i.addMeshData(p,n),n.translation.setd(0,0,1.3),n.update(),i.addMeshData(u,n),n.scale.setd(1,1,.5),n.setRotationXYZ(0,Math.PI/2,0),n.translation.setd(0,1.2,.6),n.update(),i.addMeshData(s,n),n.translation.setd(0,1.2,2),n.update(),i.addMeshData(d,n);var m=i.build();return m[0]}return d.getMeshData=function(t){var e=u(t);return e},d.attachGuide=function(t){var e=t.getComponent("CameraComponent").camera,o=c(e.fov,e.aspect,e.near,e.far-e.far/1e3),r=new i(o);t.setComponent(r);var l=new n,h=a.createMaterial(s.simpleColored,"");return h.uniforms.color=[.5,.7,1],l.materials.push(h),t.setComponent(l),t},d.removeMesh=function(t){return t.hasComponent("cameraComponent")&&(t.clearComponent("meshDataComponent"),t.clearComponent("meshRendererComponent")),t},d}),define("goo/debug/LightPointer",["goo/renderer/MeshData","goo/util/MeshBuilder","goo/math/Transform","goo/shapes/ShapeCreator","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/math/MathUtils","goo/renderer/light/PointLight","goo/renderer/light/DirectionalLight","goo/renderer/light/SpotLight"],function(t,e,o,r,i,n,a,s,l,h,d,c){"use strict";function u(){}function p(e,o){e=e||1,o=o||8;for(var r=[],i=[],n=2*Math.PI/o,a=0,s=0;o>a;a++,s+=n)r.push(Math.cos(s)*e,Math.sin(s)*e,0),i.push(a,a+1);i[i.length-1]=0;var l=new t(t.defaultMap([t.POSITION]),o,i.length);return l.getAttributeBuffer(t.POSITION).set(r),l.getIndexBuffer().set(i),l.indexLengths=null,l.indexModes=["Lines"],l}function m(t){t=t||1;var r,i=new e,n=128,a=p(t,n);r=new o,i.addMeshData(a,r),r=new o,r.rotation.fromAngles(0,Math.PI/2,0),r.update(),i.addMeshData(a,r),r=new o,r.rotation.fromAngles(Math.PI/2,Math.PI/2,0),r.update(),i.addMeshData(a,r);var s=i.build();return s[0]}function f(e){e=e||8;for(var o=[0,0,0],r=[],i=2*Math.PI/e,n=0,a=0;e>n;n++,a+=i)o.push(Math.cos(a),Math.sin(a),1),r.push(0,n+1);var s=new t(t.defaultMap([t.POSITION]),e+1,r.length);return s.getAttributeBuffer(t.POSITION).set(o),s.getIndexBuffer().set(r),s.indexLengths=null,s.indexModes=["Lines"],s}function g(t,r){t=t||45,r=r||1;for(var i=new e,n=64,a=2,s=r/2,h=Math.tan(t*l.DEG_TO_RAD/2)*s,d=1;a>=d;d++){var c=p(h*d,n),u=new o;u.translation.set(0,0,s*d),u.update(),i.addMeshData(c,u)}var m=f(4),u=new o;u.scale.set(h*a,h*a,s*a),u.update(),i.addMeshData(m,u);var g=i.build();return g[0]}function v(e){e=e||8;for(var o=[],r=[],i=2*Math.PI/e,n=0,a=0;e>n;n++,a+=i)o.push(Math.cos(a),Math.sin(a),0),o.push(Math.cos(a),Math.sin(a),1),r.push(2*n,2*n+1);var s=new t(t.defaultMap([t.POSITION]),2*e,r.length);return s.getAttributeBuffer(t.POSITION).set(o),s.getIndexBuffer().set(r),s.indexLengths=null,s.indexModes=["Lines"],s}function y(){for(var t=new e,r=64,i=2,n=10,a=2,s=0;i>s;s++){var l=p(a,r),h=new o;h.translation.set(0,0,n*s),h.update(),t.addMeshData(l,h)}var d=v(4),h=new o;h.scale.set(a,a,n*i),h.update(),t.addMeshData(d,h);var c=t.build();return c[0]}function x(t){var i=new e,n=new o,a=m(t.range),s=r.createSphere(8,8,.1);i.addMeshData(a,n),i.addMeshData(s,n);var l=i.build();return l[0]}function w(t){var i=new e,n=new o,a=g(t.angle,t.range),s=r.createSphere(8,8,.1);i.addMeshData(s,n),n.scale.setd(1,1,-1),n.update(),i.addMeshData(a,n);var l=i.build();return l[0]}function _(){var t=new e,i=new o;i.scale.setd(1,1,-1),i.update();var n=y(),a=r.createSphere(8,8,.1);t.addMeshData(n,i),t.addMeshData(a,i);var s=t.build();return s[0]}function b(t){return t instanceof h?x(t):t instanceof d?_(t):t instanceof c?w(t):void 0}return u.getMeshData=function(t){var e=b(t);return e},u.attachPointer=function(t){var e=t.getComponent("lightComponent").light,o=b(e),r=new i(o);t.setComponent(r);var l=new n;t.setComponent(l);var h=a.createMaterial(s.simpleColored,"");return h.uniforms.color=[e.color.data[0],e.color.data[1],e.color.data[2]],t.meshRendererComponent.materials.push(h),t},u.removeMesh=function(t){return t.clearComponent("meshDataComponent"),t.clearComponent("meshRendererComponent"),t},u}),define("goo/entities/systems/TransformSystem",["goo/entities/systems/System"],function(t){"use strict";function e(){t.call(this,"TransformSystem",["TransformComponent"])}return e.prototype=Object.create(t.prototype),e.prototype.process=function(t){var e,o;for(e=0;e<t.length;e++)o=t[e].transformComponent,o._updated=!1,o._dirty&&o.updateTransform();for(e=0;e<t.length;e++)o=t[e].transformComponent,o._dirty&&this.updateWorldTransform(o)},e.prototype.updateWorldTransform=function(t){t.updateWorldTransform();for(var e=0;e<t.children.length;e++)this.updateWorldTransform(t.children[e])},e}),define("goo/renderer/SimplePartitioner",["goo/renderer/Camera"],function(t){"use strict";function e(){}return e.prototype.added=function(){},e.prototype.removed=function(){},e.prototype.process=function(e,o,r){for(var i=0,n=0;n<o.length;n++){var a=o[n];if(!a.skip&&!a.meshRendererComponent.hidden)if("Never"===a.meshRendererComponent.cullMode)r[i++]=a,a.isVisible=!0;else{var s=a.meshRendererComponent.worldBound,l=e.contains(s);l!==t.Outside?(r[i++]=a,a.isVisible=!0):a.isVisible=!1}}r.length=i},e}),define("goo/entities/systems/RenderSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/SimplePartitioner","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/Util"],function(t,e,o,r,i,n){"use strict";function a(){t.call(this,"RenderSystem",["MeshRendererComponent","MeshDataComponent"]),this.entities=[],this.renderList=[],this.postRenderables=[],this.partitioner=new o,this.preRenderers=[],this.composers=[],this._composersActive=!0,this.doRender=!0,this._debugMaterials={},this.overrideMaterials=[],this.camera=null,this.lights=[],this.currentTpf=0;var r=this;e.addListener("goo.setCurrentCamera",function(t){r.camera=t.camera}),e.addListener("goo.setLights",function(t){r.lights=t}),this.picking={doPick:!1,x:0,y:0,pickingStore:{},pickingCallback:function(t,e){console.log(t,e)},skipUpdateBuffer:!1}}return a.prototype=Object.create(t.prototype),a.prototype.pick=function(t,e,o,r){this.picking.x=t,this.picking.y=e,this.picking.skipUpdateBuffer=void 0===r?!1:r,o&&(this.picking.pickingCallback=o),this.picking.doPick=!0},a.prototype.inserted=function(t){this.partitioner&&this.partitioner.added(t)},a.prototype.deleted=function(t){this.partitioner&&this.partitioner.removed(t)},a.prototype.process=function(t,e){this.entities=t,this.currentTpf=e},a.prototype.render=function(t){if(this.doRender&&this.camera){t.updateShadows(this.partitioner,this.entities,this.lights);for(var e=0;e<this.preRenderers.length;e++){var o=this.preRenderers[e];o.process(t,this.entities,this.partitioner,this.camera,this.lights)}if(this.partitioner.process(this.camera,this.entities,this.renderList),this.composers.length>0&&this._composersActive)for(var e=0;e<this.composers.length;e++){var r=this.composers[e];r.render(t,this.currentTpf,this.camera,this.lights,null,!0,this.overrideMaterials)}else t.render(this.renderList,this.camera,this.lights,null,!0,this.overrideMaterials)}},a.prototype.renderToPick=function(t,e){t.renderToPick(this.renderList,this.camera,!0,e)},a.prototype.enableComposers=function(t){this._composersActive=!!t},a.prototype._createDebugMaterial=function(t){if(""!==t){var e;switch(t){case"wireframe":case"color":e=n.clone(i.simpleColored.fshader);break;case"lit":e=n.clone(i.simpleLit.fshader);break;case"texture":e=n.clone(i.textured.fshader);break;case"normals":e=n.clone(i.showNormals.fshader);break;case"simple":e=n.clone(i.simple.fshader)}var o=n.clone(i.uber);o.fshader=e,"flat"!==t?(this._debugMaterials[t]=r.createMaterial(o,t),"wireframe"===t&&(this._debugMaterials[t].wireframe=!0),"lit"===t&&(this._debugMaterials[t]._textureMaps={EMISSIVE_MAP:null,DIFFUSE_MAP:null,SPECULAR_MAP:null,NORMAL_MAP:null,AO_MAP:null,LIGHT_MAP:null,TRANSPARENCY_MAP:null})):(this._debugMaterials[t]=r.createEmptyMaterial(null,t),this._debugMaterials[t].flat=!0)}},a.prototype.setDebugMaterial=function(t){if(!t||""===t)return void(this.overrideMaterials=[]);var e=t.split("+");this.overrideMaterials=[];for(var o=0;o<e.length;o++){var t=e[o];this._debugMaterials[t]||this._createDebugMaterial(t),this.overrideMaterials.push(""===t?null:this._debugMaterials[t])}},a}),define("goo/entities/systems/BoundingUpdateSystem",["goo/entities/systems/System","goo/renderer/bounds/BoundingBox"],function(t,e){"use strict";function o(){t.call(this,"BoundingUpdateSystem",["TransformComponent","MeshRendererComponent","MeshDataComponent"]),this._worldBound=new e,this._computeWorldBound=null}return o.prototype=Object.create(t.prototype),o.prototype.process=function(t){for(var e=0;e<t.length;e++){var o=t[e],r=o.meshDataComponent,i=o.transformComponent,n=o.meshRendererComponent;r.autoCompute?(r.computeBoundFromPoints(),n.updateBounds(r.modelBound,i.worldTransform)):i._updated&&n.updateBounds(r.modelBound,i.worldTransform)}if(this._computeWorldBound&&this._computeWorldBound instanceof Function){if(0===t.length)return void(this._computeWorldBound=null);for(var e=0;e<t.length;e++)if(!t[e].particleComponent){this._worldBound=t[e].meshRendererComponent.worldBound.clone();break}for(;e<t.length;e++)if(!t[e].particleComponent){var a=t[e].meshRendererComponent;this._worldBound=this._worldBound.merge(a.worldBound)}this._computeWorldBound(this._worldBound),this._computeWorldBound=null}},o.prototype.getWorldBound=function(t){this._computeWorldBound=t},o}),define("goo/entities/components/CameraDebugComponent",["goo/entities/components/Component"],function(t){"use strict";function e(){this.type="CameraDebugComponent"}return e.prototype=Object.create(t.prototype),e}),define("goo/entities/components/LightDebugComponent",["goo/entities/components/Component"],function(t){"use strict";function e(){this.type="LightDebugComponent"}return e.prototype=Object.create(t.prototype),e}),define("goo/entities/components/MovementComponent",["goo/math/Vector3","goo/entities/components/Component"],function(t,e){"use strict";function o(){this.type="MovementComponent",this.velocity=new t,this.rotationVelocity=new t}return o.prototype=Object.create(e.prototype),o.prototype.addVelocity=function(t){this.velocity.add(t)},o.prototype.setVelocity=function(t){this.velocity.set(t)},o.prototype.getVelocity=function(){return this.velocity},o.prototype.addRotationVelocity=function(t){this.rotationVelocity.add(t)},o.prototype.setRotationVelocity=function(t){this.rotationVelocity.set(t)},o.prototype.getRotationVelocity=function(){return this.rotationVelocity},o}),define("goo/entities/components/PortalComponent",["goo/entities/components/Component","goo/renderer/pass/RenderTarget"],function(t,e){"use strict";function o(t,o,r,i){o=o||200,this.options=r||{},this.options.preciseRecursion=!!this.options.preciseRecursion,this.options.autoUpdate=this.options.autoUpdate!==!1,this.options.alwaysRender=!!this.options.alwaysRender,this.overrideMaterial=i,this.doUpdate=!0;var n=t.aspect;this.type="PortalComponent",this.camera=t,this.target=new e(o,o/n),this.options.preciseRecursion&&(this.secondaryTarget=new e(o,o/n))}return o.prototype=Object.create(t.prototype),o.prototype.requestUpdate=function(){this.doUpdate=!0},o}),define("goo/entities/components/ProximityComponent",["goo/entities/components/Component"],function(t){"use strict";function e(t){this.type="ProximityComponent",Object.defineProperty(this,"tag",{value:t||"red",writable:!1})}return e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.prototype.attached=function(t){var e=t._world;if(e){var o=e.getSystem("ProximitySystem");o&&o.add(t,this.tag)}},e.prototype.detached=function(t){var e=t._world;if(e){var o=e.getSystem("ProximitySystem");o&&o.remove(t,this.tag)}},e}),define("goo/shapes/TextureGrid",["goo/renderer/MeshData"],function(t){"use strict";function e(e,r){this.matrix=e,this.textureUnitsPerLine=r||8;var i=t.defaultMap([t.POSITION,t.NORMAL,t.TEXCOORD0]),n=o(e);t.call(this,i,4*n,6*n),this.rebuild()}function o(t){for(var e=0,o=0;o<t.length;o++)e+=t[o].length;return e}function r(t){var e=[],o=t.split("\n");return o.forEach(function(t){var o=t.split(""),r=o.map(function(t){return t.charCodeAt(0)});e.push(r)}),e}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){for(var e=[],o=[],r=[],i=[],n=0,a=0;a<this.matrix.length;a++)for(var s=0;s<this.matrix[a].length;s++){e.push(s,-a-1,0,s,-a,0,s+1,-a,0,s+1,-a-1,0),o.push(0,0,1,0,0,1,0,0,1,0,0,1);var l=this.matrix[a][s]%this.textureUnitsPerLine/this.textureUnitsPerLine,h=Math.floor(this.matrix[a][s]/this.textureUnitsPerLine)/this.textureUnitsPerLine;h=1-h,i.push(l,h-1/this.textureUnitsPerLine,l,h,l+1/this.textureUnitsPerLine,h,l+1/this.textureUnitsPerLine,h-1/this.textureUnitsPerLine),r.push(n+3,n+1,n+0,n+2,n+1,n+3),n+=4}return this.getAttributeBuffer(t.POSITION).set(e),this.getAttributeBuffer(t.NORMAL).set(o),this.getAttributeBuffer(t.TEXCOORD0).set(i),this.getIndexBuffer().set(r),this},e.fromString=function(t){return new e(r(t),16)},e}),define("goo/entities/components/TextComponent",["goo/entities/components/Component","goo/shapes/TextureGrid","goo/entities/components/MeshDataComponent"],function(t){"use strict";
function e(t){this.type="TextComponent",this.text=t||"",this.dirty=!0}return e.prototype=Object.create(t.prototype),e.prototype.setText=function(t){return this.text=t,this.dirty=!0,this},e}),define("goo/entities/systems/AnimationSystem",["goo/entities/systems/System","goo/entities/World"],function(t,e){"use strict";function o(){t.call(this,"AnimationSystem",["AnimationComponent"]),this.entities=[]}return o.prototype=Object.create(t.prototype),o.prototype.process=function(t){this.entities=t;for(var o=0;o<t.length;o++){var r=t[o],i=r.animationComponent;i.update(e.time),i.apply(r.transformComponent),i.postUpdate()}},o.prototype.pause=function(){this.passive=!0;for(var t=this.entities.length;t--;)this.entities[t].animationComponent.pause()},o.prototype.stop=function(){this.passive=!0;for(var t=0;t<this.entities.length;t++){var e=this.entities[t];e.animationComponent.stop()}},o.prototype.resume=function(){this.passive=!1;for(var t=0;t<this.entities.length;t++){var e=this.entities[t];e.animationComponent.resume()}},o}),define("goo/entities/systems/CSSTransformSystem",["goo/entities/systems/System","goo/renderer/Renderer","goo/math/Matrix4x4","goo/math/MathUtils","goo/math/Vector3"],function(t,e,o,r,i){"use strict";function n(e){t.call(this,"CSSTransformSystem",["TransformComponent","CSSTransformComponent"]),this.renderer=e,document.querySelector&&(this.viewDom=document.querySelector("#view"),this.containerDom=document.querySelector("#cam1"),this.containerDom2=document.querySelector("#cam2")),this.tmpMatrix=new o,this.tmpMatrix2=new o,this.tmpVector=new i}n.prototype=Object.create(t.prototype);var a=function(t){return Math.abs(t)<1e-6?0:t},s=["","-webkit-","-moz-","-ms-","-o-"],l=function(t,e,o){for(var r=0;r<s.length;r++)t.style[s[r]+e]=o},h=function(t){var e=t.data;return"matrix3d("+a(e[0])+","+a(-e[1])+","+a(e[2])+","+a(e[3])+","+a(e[4])+","+a(-e[5])+","+a(e[6])+","+a(e[7])+","+a(e[8])+","+a(-e[9])+","+a(e[10])+","+a(e[11])+","+a(e[12])+","+a(-e[13])+","+a(e[14])+","+a(e[15])+")"};return n.prototype.process=function(t){if(0!==t.length){var o=e.mainCamera;if(o){var n=.5/Math.tan(r.DEG_TO_RAD*o.fov*.5)*this.renderer.domElement.offsetHeight;l(this.viewDom,"perspective",n+"px"),this.tmpMatrix.copy(o.getViewInverseMatrix()),this.tmpMatrix2.copy(this.tmpMatrix),this.tmpMatrix.invert(),this.tmpMatrix.setTranslation(new i(0,0,n));var a=h(this.tmpMatrix);l(this.containerDom,"transform",a),this.tmpMatrix2.e03=-this.tmpMatrix2.e03,this.tmpMatrix2.e23=-this.tmpMatrix2.e23,this.tmpMatrix2.setRotationFromVector(new i(0,0,0)),a=h(this.tmpMatrix2),l(this.containerDom2,"transform",a);for(var s=0;s<t.length;s++){var d=t[s],c=d.getComponent("CSSTransformComponent"),u=c.domElement,p=c.scale;p=[p,-p,p].join(","),c.faceCamera?(d.transformComponent.worldTransform.matrix.getTranslation(this.tmpVector),this.tmpMatrix.copy(o.getViewInverseMatrix()),this.tmpMatrix.setTranslation(this.tmpVector)):this.tmpMatrix.copy(d.transformComponent.worldTransform.matrix),a="translate3d(-50%,-50%,0) "+h(this.tmpMatrix)+"scale3d("+p+")",l(u,"transform",a),u.parentNode!==this.containerDom2&&this.containerDom2.appendChild(u)}}}},n}),define("goo/entities/systems/CameraDebugSystem",["goo/entities/systems/System","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/debug/FrustumViewer"],function(t,e,o,r,i,n){"use strict";function a(){t.call(this,"CameraDebugSystem",["CameraDebugComponent"])}return a.prototype=Object.create(t.prototype),a.prototype.inserted=function(t){var a=t.cameraComponent.camera,s=n.getMeshData(a);t.setComponent(new e(s));var l=r.createMaterial(i.simpleColored,"");l.uniforms.color=[.4,.7,1];var h=new o;h.materials.push(l),t.setComponent(h),h.updateBounds(t.meshDataComponent.modelBound,t.transformComponent.worldTransform)},a.prototype.process=function(t){for(var e=0;e<t.length;e++){var o=t[e],r=o.cameraComponent.camera;r.changedProperties&&(o.meshDataComponent.meshData=n.getMeshData(r),o.meshRendererComponent.updateBounds(o.meshDataComponent.modelBound,o.transformComponent.worldTransform),r.changedProperties=!1)}},a.prototype.deleted=function(t){t.clearComponent("MeshDataComponent"),t.clearComponent("MeshRendererComponent")},a}),define("goo/entities/systems/CameraSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/Renderer"],function(t,e,o){"use strict";function r(){t.call(this,"CameraSystem",["TransformComponent","CameraComponent"]),this.mainCamera=null}return r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.findMainCamera=function(){if(this._activeEntities.length){var t=this._activeEntities[0];e.emit("goo.setCurrentCamera",{camera:t.cameraComponent.camera,entity:t})}},r.prototype.inserted=function(t){o.mainCamera||e.emit("goo.setCurrentCamera",{camera:t.cameraComponent.camera,entity:t})},r.prototype.deleted=function(){},r.prototype.process=function(){for(var t=0;t<this._activeEntities.length;t++){var e=this._activeEntities[t],o=e.transformComponent,r=e.cameraComponent;o._updated&&r.updateCamera(o.worldTransform)}},r}),define("goo/entities/systems/DebugRenderSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/SimplePartitioner","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/Util","goo/debug/DebugDrawHelper"],function(t,e,o,r,i,n,a){"use strict";function s(){t.call(this,"DebugRenderSystem",["TransformComponent"]),this._renderablesTree={},this.renderList=[],this.preRenderers=[],this.composers=[],this.doRender={CameraComponent:!1,LightComponent:!1,MeshRendererComponent:!1,SkeletonPose:!1},this.inserted(),this._interestComponents=["CameraComponent","LightComponent"],this.camera=null,this.lights=[],this.currentTpf=0,this.scale=20;var o=this;e.addListener("goo.setCurrentCamera",function(t){o.camera=t.camera}),e.addListener("goo.setLights",function(t){o.lights=t}),this.selectionRenderable=a.getRenderablesFor({type:"MeshRendererComponent"}),this.selectionActive=!1,this.oldSelectionActive=!1}return s.prototype=Object.create(t.prototype),s.prototype.inserted=function(){},s.prototype.deleted=function(){},s.prototype.process=function(t,e){for(var o,r=this.renderList.length=0,i=0;i<t.length;i++){for(var n=t[i],s=0,l=this._interestComponents.length;l>s;s++){var h=this._interestComponents[s];if(!n.hidden&&n.hasComponent(h)){var d=n.getComponent(h),c={full:this.doRender[h]||n.getComponent(h).forceDebug},u=this._renderablesTree[n.id]=this._renderablesTree[n.id]||{};u[h]&&(2===u[h].length&&c.full||1===u[h].length&&!c.full)?o=u[h]:(o=a.getRenderablesFor(d,c),o.forEach(function(t){t.id=n.id,t._index=n._index}),u[h]=o),o.forEach(function(t){t.transform.copy(n.transformComponent.worldTransform)}),a.update(o,d,this.camera.translation),o.forEach(function(t){this.renderList[r++]=t}.bind(this))}}if(this.doRender.SkeletonPose&&n.meshDataComponent&&n.meshDataComponent.currentPose){var p=n.meshDataComponent.currentPose,u=this._renderablesTree[n.id]=this._renderablesTree[n.id]||{};u.skeleton?o=u.skeleton:(o=a.getRenderablesFor(p),o.forEach(function(t){t.id=n.id}),u.skeleton=o),o.forEach(function(t){t.transform.copy(n.transformComponent.worldTransform),this.renderList[r++]=t}.bind(this))}}this.selectionActive&&(this.renderList[r++]=this.selectionRenderable[0]),this.renderList.length=r,this.currentTpf=e},s.prototype.render=function(t){t.checkResize(this.camera),this.camera&&t.render(this.renderList,this.camera,this.lights,null,!1)},s.prototype.renderToPick=function(t,e){t.renderToPick(this.renderList,this.camera,!1,e)},s}),define("goo/util/gizmos/Gizmo",["goo/renderer/shaders/ShaderBuilder","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/Material","goo/renderer/Renderer","goo/math/Transform","goo/math/Matrix4x4","goo/math/Plane","goo/math/Ray","goo/math/Vector3","goo/renderer/Camera"],function(t,e,o,r,i,n,a,s,l,h,d){"use strict";function c(t,e){this.name=t||"Default Gizmo",this.gizmoRenderSystem=e,this._colors=[[1,.1,.3],[.2,1,.3],[.2,.3,1],[.8,.8,.8]],this._gizmoSize=1/60,this._plane=new s,this._line=new h,this._activeHandle=null,this._mouse={position:[0,0],oldPosition:[0,0]},this.dirty=!1,this.visible=!1,this.transform=new n,this.renderables=[],this.onChange=null,this._oldRay=new l,this._newRay=new l,this._result=new h,this._v0=new h,this._v1=new h,this._v2=new h,this._v3=new h,this._s0=new h,this._s1=new h,this._s2=new h,this._s3=new h}return c.handleStore=[],c.registerHandle=function(t){var e=c.handleStore.length+16e3;return c.handleStore.push(t),e},c.getHandle=function(t){return 16e3>t?null:c.handleStore[t-16e3]},c.prototype.getRenderable=function(t){for(var e=0;e<this.renderables.length;e++){var o=this.renderables[e];if(o.id===t)return o}},c.prototype.activate=function(t){this._activeHandle=t.data,this._mouse.oldPosition[0]=t.x,this._mouse.oldPosition[1]=t.y,this._activeRenderable=this.getRenderable(t.id),this._activeRenderable.materials[0].uniforms.color=[1,1,0]},c.prototype.deactivate=function(){if(this._activeRenderable){var t=this._activeRenderable.originalColor;this._activeRenderable.materials[0].uniforms.color=[t[0],t[1],t[2]]}},c.prototype.copyTransform=function(t){this.transform.setIdentity(),t&&(t.matrix.getTranslation(this.transform.translation),this.transform.rotation.copy(t.rotation),this.updateTransforms())},c.prototype.update=function(t){this._mouse.position[0]=t[0],this._mouse.position[1]=t[1],this.dirty=!0},c.prototype.updateTransforms=function(){if(i.mainCamera){var t,e=i.mainCamera;if(e.projectionMode===d.Perspective){var o=e.translation.distance(this.transform.translation);t=o*this._gizmoSize}else t=(e._frustumTop-e._frustumBottom)/30;this.transform.scale.setd(t,t,t)}this.transform.update();for(var r=this.renderables.length-1;r>=0;r--)this.renderables[r].transform.update(),a.combine(this.transform.matrix,this.renderables[r].transform.matrix,this.renderables[r].transform.matrix)},c.prototype._setPlane=function(){var t=this._plane.normal,e=this._v0,o=this._v1,r=this._v2,n=this._v3,a=this._s0,s=this._s1,l=this._s2,d=this._s3;"Plane"===this._activeHandle.type?(t.setv([h.UNIT_X,h.UNIT_Y,h.UNIT_Z][this._activeHandle.axis]),this.transform.matrix.applyPostVector(t),t.normalize(),e.setv(h.ZERO),this.transform.matrix.applyPostPoint(e),this._plane.constant=e.dot(t)):(e.setv(h.ZERO),this.transform.matrix.applyPostPoint(e),o.setv(h.UNIT_X),this.transform.matrix.applyPostPoint(o),r.setv(h.UNIT_Y),this.transform.matrix.applyPostPoint(r),n.setv(h.UNIT_Z),this.transform.matrix.applyPostPoint(n),i.mainCamera.getScreenCoordinates(e,1,1,a),i.mainCamera.getScreenCoordinates(o,1,1,s),s.subv(a),i.mainCamera.getScreenCoordinates(r,1,1,l),l.subv(a),i.mainCamera.getScreenCoordinates(n,1,1,d),d.subv(a),0===this._activeHandle.axis?l.cross(s).length()>d.cross(s).length()?t.setv(n).subv(e).normalize():t.setv(r).subv(e).normalize():1===this._activeHandle.axis?d.cross(l).length()>s.cross(l).length()?t.setv(o).subv(e).normalize():t.setv(n).subv(e).normalize():s.cross(d).length()>l.cross(d).length()?t.setv(r).subv(e).normalize():t.setv(o).subv(e).normalize(),this._plane.constant=e.dot(t))},c.prototype._setLine=function(){this._line.setv([h.UNIT_X,h.UNIT_Y,h.UNIT_Z][this._activeHandle.axis]),this.transform.matrix.applyPostVector(this._line),this._line.normalize()},c.prototype.addRenderable=function(t){t.originalColor=t.materials[0].uniforms.color,this.renderables.push(t)},c.prototype._buildMaterialForAxis=function(t,e){var o=r.createMaterial(c._shaderDef,t+"Material");return o.uniforms.color=this._colors[t],void 0!==e&&1>e&&(o.blendState.blending="CustomBlending",o.uniforms.opacity=e,o.renderQueue=3e3),o.cullState.enabled=!1,o},c._shaderDef={attributes:{vertexPosition:e.POSITION,vertexNormal:e.NORMAL},uniforms:{viewProjectionMatrix:o.VIEW_PROJECTION_MATRIX,worldMatrix:o.WORLD_MATRIX,cameraPosition:o.CAMERA,color:[1,1,1],opacity:1,light:[-20,20,20]},vshader:["attribute vec3 vertexPosition;","attribute vec3 vertexNormal;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","uniform vec3 cameraPosition;","varying vec3 normal;","varying vec3 viewPosition;","void main(void) {","	vec4 worldPos = worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = viewProjectionMatrix * worldPos;","	normal = vertexNormal;","	viewPosition = cameraPosition - worldPos.xyz;","}"].join("\n"),fshader:["varying vec3 normal;","varying vec3 viewPosition;","uniform vec3 color;","uniform float opacity;","uniform vec3 light;","void main(void)","{","	vec3 N = normalize(normal);","	vec4 final_color = vec4(color, 1.0);"," vec3 lVector = normalize(light);"," float dotProduct = dot(N, lVector);"," float diffuse = max(dotProduct, 0.0);"," final_color.rgb *= (0.5*diffuse+0.5);"," final_color.a = opacity;","	gl_FragColor = final_color;","}"].join("\n")},c}),define("goo/util/gizmos/TranslationGizmo",["goo/util/gizmos/Gizmo","goo/renderer/MeshData","goo/util/MeshBuilder","goo/shapes/Disk","goo/shapes/Quad","goo/math/Transform","goo/renderer/Renderer"],function(t,e,o,r,i,n,a){"use strict";function s(){t.call(this,"TranslationGizmo"),this._quadMesh=new i(2,2),this._arrowMesh=this._buildArrowMesh(),this._buildArrow(0),this._buildArrow(1),this._buildArrow(2)}return s.prototype=Object.create(t.prototype),s.prototype.activate=function(e){t.prototype.activate.call(this,e),this._setPlane(),"Axis"===this._activeHandle.type&&this._setLine()},s.prototype.process=function(){var t=this._mouse.oldPosition,e=this._mouse.position;a.mainCamera.getPickRay(t[0],t[1],1,1,this._oldRay),a.mainCamera.getPickRay(e[0],e[1],1,1,this._newRay),"Plane"===this._activeHandle.type?this._moveOnPlane():"Axis"===this._activeHandle.type&&this._moveOnLine(),t[0]=e[0],t[1]=e[1],this.updateTransforms(),this.dirty=!1,this.onChange instanceof Function&&this.onChange(this.transform.translation)},s.prototype.copyTransform=function(e,o){t.prototype.copyTransform.call(this,e),e&&o&&(this.transform.rotation.setIdentity(),this.updateTransforms())},s.prototype._moveOnPlane=function(){var t=this._v0,e=this._v1,o=this._result;this._plane.rayIntersect(this._oldRay,t),this._plane.rayIntersect(this._newRay,e),o.setv(e).subv(t),this.transform.translation.add(o)},s.prototype._moveOnLine=function(){var t=this._v0,e=this._v1,o=this._result,r=this._line;this._plane.rayIntersect(this._oldRay,t),this._plane.rayIntersect(this._newRay,e),o.setv(e).subv(t);var i=o.dot(r);o.setv(r).muld(i,i,i),this.transform.translation.addv(o)},s.prototype._buildArrow=function(e){var o=new n,r=new n,i=1;r.scale.setd(i,i,i),2===e?r.translation.setd(i,i,0):0===e?(r.translation.setd(0,i,i),r.setRotationXYZ(0,Math.PI/2,0),o.setRotationXYZ(0,Math.PI/2,0)):1===e&&(r.translation.setd(i,0,i),r.setRotationXYZ(Math.PI/2,0,0),o.setRotationXYZ(3*Math.PI/2,0,0)),this.addRenderable({meshData:this._arrowMesh,materials:[this._buildMaterialForAxis(e)],transform:o,id:t.registerHandle({type:"Axis",axis:e}),thickness:.6}),this.addRenderable({meshData:this._quadMesh,materials:[this._buildMaterialForAxis(e,.6)],transform:r,id:t.registerHandle({type:"Plane",axis:e})})},s.prototype._buildArrowMesh=function(){var t=new o,i=new r(32,.6,2.3),a=new r(32,.6),s=new e(e.defaultMap([e.POSITION]),2,2);s.getAttributeBuffer(e.POSITION).set([0,0,0,0,0,7]),s.getIndexBuffer().set([0,1]),s.indexLengths=null,s.indexModes=["Lines"];var l=new n;l.translation.setd(0,0,7),l.update(),t.addMeshData(i,l),l.setRotationXYZ(0,Math.PI,0),l.update(),t.addMeshData(a,l);var l=new n;l.update(),t.addMeshData(s,l);var h=t.build()[0];return h},s}),define("goo/util/gizmos/RotationGizmo",["goo/util/gizmos/Gizmo","goo/shapes/Sphere","goo/shapes/Torus","goo/math/Vector3","goo/math/Matrix3x3","goo/math/Transform","goo/renderer/Renderer","goo/math/Ray"],function(t,e,o,r,i,n,a,s){"use strict";function l(){t.call(this,"RotationGizmo"),this._ballMesh=new e(32,32,1.1),this._torusMesh=new o(64,8,.1,2.5),this._buildBall(),this._buildTorus(0),this._buildTorus(1),this._buildTorus(2),this._rotation=new i,this._rotationScale=4,this._axis=new r,this._direction=new r,this._ray=new s,this._m1=new i,this._m2=new i,this.snap=!1,this.accumulatedRotationX=0,this.accumulatedRotationY=0,this.accumulatedRotationThorX=0,this.accumulatedRotationThorY=0,this.accumulatedRotationThorZ=0,this.oldAngleX=0,this.oldAngleY=0,this.oldAngleZ=0}function h(t,e){return function(o){var r=o%t;return r+=0>r?t:0,e>r?o-r:r>t-e?o+t-r:o}}l.prototype=Object.create(t.prototype),l.prototype.activate=function(e){t.prototype.activate.call(this,e);var o=this._v0,i=this._v1,n=this._v2,s=this._axis,l=this._ray;if(this._activeHandle.axis<3){s.setv([r.UNIT_X,r.UNIT_Y,r.UNIT_Z][this._activeHandle.axis]),this.transform.rotation.applyPost(s),o.setv(r.ZERO),this.transform.matrix.applyPostPoint(o),a.mainCamera.getPickRay(e.x,e.y,1,1,l),i.setv(l.origin).subv(o);var h=.9*i.length();i.setv(l.direction).muld(h,h,h).addv(l.origin),n.setv(i).subv(o),r.cross(s,n,n),n.addv(i),a.mainCamera.getScreenCoordinates(n,1,1,this._direction),this._direction.sub_d(e.x,1-e.y,0),this._direction.y*=-1,this._direction.z=0,this._direction.normalize()}},l.prototype.process=function(){var t=this._mouse.oldPosition,e=this._mouse.position,o=e[0]-t[0],r=e[1]-t[1];3===this._activeHandle.axis?this._rotateOnScreen(o,r):this._rotateOnAxis(o,r),t[0]=e[0],t[1]=e[1],this.updateTransforms(),this.dirty=!1,this.onChange instanceof Function&&this.onChange(this.transform.rotation)},l.prototype._rotateOnScreen=function(t,e){this._rotation.setIdentity();this._rotation.rotateY(t*this._rotationScale),this._rotation.rotateX(e*this._rotationScale);var o=a.mainCamera.getViewMatrix().data,r=this._m1,n=this._m2;r.set(o[0],o[1],o[2],o[4],o[5],o[6],o[8],o[9],o[10]),n.set(r).invert(),n.combine(this._rotation),n.combine(r),i.combine(n,this.transform.rotation,this.transform.rotation)};var d=h(Math.PI/4,Math.PI/16),c=d;return l.prototype._rotateOnAxis=function(t,e){this._rotation.setIdentity();var o=t*this._direction.x+e*this._direction.y;if(o*=this._rotationScale,this.snap)switch(this._activeHandle.axis){case 0:this.accumulatedRotationThorX+=o;var r=c(this.accumulatedRotationThorX);this._rotation.rotateX(r-this.oldAngleX),this.oldAngleX=r;break;case 1:this.accumulatedRotationThorY+=o;var n=c(this.accumulatedRotationThorY);this._rotation.rotateY(n-this.oldAngleY),this.oldAngleY=n;break;case 2:this.accumulatedRotationThorZ+=o;var a=c(this.accumulatedRotationThorZ);this._rotation.rotateZ(a-this.oldAngleZ),this.oldAngleZ=a}else switch(this._activeHandle.axis){case 0:this.accumulatedRotationThorX+=o;var r=this.accumulatedRotationThorX;this._rotation.rotateX(r-this.oldAngleX),this.oldAngleX=r;break;case 1:this.accumulatedRotationThorY+=o;var n=this.accumulatedRotationThorY;this._rotation.rotateY(n-this.oldAngleY),this.oldAngleY=n;break;case 2:this.accumulatedRotationThorZ+=o;var a=this.accumulatedRotationThorZ;this._rotation.rotateZ(a-this.oldAngleZ),this.oldAngleZ=a}i.combine(this.transform.rotation,this._rotation,this.transform.rotation)},l.prototype._buildBall=function(){var e=new n;e.scale.setd(1.2,1.2,1.2),this.addRenderable({meshData:this._ballMesh,materials:[this._buildMaterialForAxis(3,.6)],transform:new n,id:t.registerHandle({type:"Rotate",axis:3})})},l.prototype._buildTorus=function(e){var o=new n;o.scale.setd(1.7,1.7,1.7),0===e?o.setRotationXYZ(0,Math.PI/2,0):1===e&&o.setRotationXYZ(Math.PI/2,0,0),this.addRenderable({meshData:this._torusMesh,materials:[this._buildMaterialForAxis(e)],transform:o,id:t.registerHandle({type:"Rotate",axis:e}),thickness:.35})},l}),define("goo/util/gizmos/ScaleGizmo",["goo/util/gizmos/Gizmo","goo/renderer/MeshData","goo/util/MeshBuilder","goo/shapes/Box","goo/math/Transform","goo/renderer/Renderer","goo/math/Vector3","goo/math/MathUtils"],function(t,e,o,r,i,n,a,s){"use strict";function l(e){t.call(this,"ScaleGizmo",e),this._boxMesh=new r(1.4,1.4,1.4),this._arrowMesh=this._buildArrowMesh(),this._scale=1,this._transformScale=new a,this._transformScale.setd(1,1,1),this._buildBox(),this._buildArrow(0),this._buildArrow(1),this._buildArrow(2)}return l.prototype=Object.create(t.prototype),l.prototype.activate=function(e){t.prototype.activate.call(this,e),3!==this._activeHandle.axis&&(this._setPlane(),this._setLine())},l.prototype.copyTransform=function(e){t.prototype.copyTransform.call(this,e),this._transformScale.setv(e.scale)},l.prototype.process=function(){var t=this._mouse.oldPosition,e=this._mouse.position;3===this._activeHandle.axis?this._scaleUniform():this._scaleNonUniform(),t[0]=e[0],t[1]=e[1],this.updateTransforms(),this.dirty=!1,this.onChange instanceof Function&&this.onChange(this._transformScale)},l.prototype._scaleUniform=function(){var t=this._mouse.oldPosition,e=this._mouse.position,o=Math.pow(1+e[0]+t[1]-t[0]-e[1],this._scale),r=this.gizmoRenderSystem.entity.transformComponent.worldTransform.translation,i=n.mainCamera.translation,a=i.distance(r);o+=a/2e5*s.sign(o-1),this._transformScale.muld(o,o,o)},l.prototype._scaleNonUniform=function(){var t=this._mouse.position,e=this._mouse.oldPosition;n.mainCamera.getPickRay(e[0],e[1],1,1,this._oldRay),n.mainCamera.getPickRay(t[0],t[1],1,1,this._newRay);var o=this._v0,r=this._v1,i=this._line,a=this._result;this._plane.rayIntersect(this._oldRay,o),this._plane.rayIntersect(this._newRay,r),a.setv(r).subv(o),a.div(this.transform.scale).scale(.07);var s=a.dot(i);a.setv(i).muld(s,s,s);var l=Math.pow(1+s,this._scale);switch(this._activeHandle.axis){case 0:this._transformScale.data[0]*=l;break;case 1:this._transformScale.data[1]*=l;break;case 2:this._transformScale.data[2]*=l}},l.prototype._buildBox=function(){this.addRenderable({meshData:this._boxMesh,materials:[this._buildMaterialForAxis(3)],transform:new i,id:t.registerHandle({type:"Scale",axis:3})})},l.prototype._buildArrow=function(e){var o=new i;0===e?o.setRotationXYZ(0,Math.PI/2,0):1===e&&o.setRotationXYZ(3*Math.PI/2,0,0),this.addRenderable({meshData:this._arrowMesh,materials:[this._buildMaterialForAxis(e)],transform:o,id:t.registerHandle({type:"Scale",axis:e})})},l.prototype._buildArrowMesh=function(){var t=new o,n=new r,a=new e(e.defaultMap([e.POSITION]),2,2);a.getAttributeBuffer(e.POSITION).set([0,0,0,0,0,1]),a.getIndexBuffer().set([0,1]),a.indexLengths=null,a.indexModes=["Lines"];var s=new i;s.translation.setd(0,0,8),s.update(),t.addMeshData(n,s);var s=new i;s.scale.setd(1,1,8),s.update(),t.addMeshData(a,s);var l=t.build()[0];return l},l}),define("goo/entities/systems/GizmoRenderSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/SimplePartitioner","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/renderer/shaders/ShaderFragment","goo/renderer/Util","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/renderer/MeshData","goo/renderer/Shader","goo/util/gizmos/Gizmo","goo/util/gizmos/TranslationGizmo","goo/util/gizmos/RotationGizmo","goo/util/gizmos/ScaleGizmo"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m){"use strict";function f(o){t.call(this,"GizmoRenderSystem",null),this.renderables=[],this.camera=null,this.gizmos=[new u(this),new p(this),new m(this)],this.active=!1,this.nextGizmo=null,this.setupCallbacks(o),this.activeGizmo=null,this.viewportWidth=0,this.viewportHeight=0,this.domElement=null,this.global=!1,this.pickingMaterial=r.createEmptyMaterial(g,"pickingMaterial"),this.pickingMaterial.blendState={blending:"NoBlending",blendEquation:"AddEquation",blendSrc:"SrcAlphaFactor",blendDst:"OneMinusSrcAlphaFactor"},this.mouseMove=function(t){if(this.activeGizmo){var e=void 0!==t.offsetX?t.offsetX:t.layerX,o=void 0!==t.offsetY?t.offsetY:t.layerY;this.activeGizmo.update([e/this.viewportWidth,o/this.viewportHeight])}}.bind(this);var i=this;e.addListener("goo.setCurrentCamera",function(t){i.camera=t.camera})}f.prototype=Object.create(t.prototype),f.prototype.activate=function(t,e,o){this.active=!0;var r=c.getHandle(t);r&&this.activeGizmo&&(this.activeGizmo.activate({id:t,data:r,x:e/this.viewportWidth,y:o/this.viewportHeight}),this.domElement.addEventListener("mousemove",this.mouseMove))},f.prototype.deactivate=function(){this.activeGizmo.deactivate(),this.active=!1,this.domElement.removeEventListener("mousemove",this.mouseMove),null!==this.nextGizmo&&(this.setActiveGizmo(this.nextGizmo),this.nextGizmo=null)},f.prototype.getGizmo=function(t){return this.gizmos[t]},f.prototype.show=function(t){this.entity=t,this.activeGizmo&&(this.entity?this.showGizmo(this.activeGizmo):this.hideGizmo(this.activeGizmo))},f.prototype.showGizmo=function(t){t.copyTransform(this.entity.transformComponent.worldTransform,this.global),t.visible||(this.renderables=t.renderables,t.visible=!0)},f.prototype.hideGizmo=function(t){t.visible&&(this.renderables=[],t.visible=!1)},f.prototype.setActiveGizmo=function(t){return this.active?void(this.nextGizmo=t):(this.activeGizmo&&this.hideGizmo(this.activeGizmo),this.activeGizmo=this.gizmos[t]||null,void(this.activeGizmo&&this.entity&&this.showGizmo(this.activeGizmo)))},f.prototype.setGlobal=function(t){this.global!==t&&(this.global=!!t,this.entity&&this.activeGizmo&&this.showGizmo(this.activeGizmo))},f.prototype.setupCallbacks=function(t){if(t&&3===t.length)return this.gizmos[0].onChange=t[0],this.gizmos[1].onChange=t[1],void(this.gizmos[2].onChange=t[2]);var e=new s,o=new l;this.gizmos[0].onChange=function(t){if(this.entity){var e=this.entity.transformComponent.transform.translation;e.setv(t),this.entity.transformComponent.parent&&(o.copy(this.entity.transformComponent.parent.worldTransform.matrix),o.invert(),o.applyPostPoint(e)),this.entity.transformComponent.setUpdated()}}.bind(this),this.gizmos[1].onChange=function(t){this.entity&&(this.entity.transformComponent.transform.rotation.copy(t),this.entity.transformComponent.parent&&(e.copy(this.entity.transformComponent.parent.worldTransform.rotation),e.invert()),s.combine(e,this.entity.transformComponent.transform.rotation,this.entity.transformComponent.transform.rotation),this.entity.transformComponent.setUpdated())}.bind(this),this.gizmos[2].onChange=function(t){if(this.entity){var e=this.entity.transformComponent.transform.scale;e.setv(t),this.entity.transformComponent.parent&&e.div(this.entity.transformComponent.parent.worldTransform.scale),this.entity.transformComponent.setUpdated()}}.bind(this)},f.prototype.inserted=function(){},f.prototype.deleted=function(){},f.prototype.process=function(){this.activeGizmo&&(this.activeGizmo.dirty?this.activeGizmo.process():this.entity&&this.entity.transformComponent._updated&&this.activeGizmo.copyTransform(this.entity.transformComponent.worldTransform,this.global),this.activeGizmo.updateTransforms())},f.prototype.render=function(t){t.checkResize(this.camera),this.domElement||(this.domElement=t.domElement),this.viewportHeight=t.viewportHeight,this.viewportWidth=t.viewportWidth,this.camera&&t.render(this.renderables,this.camera,this.lights,null,{color:!1,stencil:!0,depth:!0},this.overrideMaterials)},f.prototype.renderToPick=function(t,e){for(var o=0;o<this.renderables.length;o++){var r=this.renderables[o];void 0!==r.thickness&&(r.materials[0].uniforms.thickness=r.thickness)}t.renderToPick(this.renderables,this.camera,{color:!1,stencil:!0,depth:!0},e,void 0,void 0,void 0,this.pickingMaterial);for(var o=0;o<this.renderables.length;o++){var r=this.renderables[o];r.thickness&&(r.materials[0].uniforms.thickness=0)}};var g={attributes:{vertexPosition:h.POSITION,vertexNormal:h.NORMAL},processors:[function(t,e){var o=e.meshData.attributeMap;t.defines=t.defines||{};for(var r in o)t.defines[r]||(t.defines[r]=!0)}],uniforms:{viewMatrix:d.VIEW_MATRIX,projectionMatrix:d.PROJECTION_MATRIX,worldMatrix:d.WORLD_MATRIX,cameraFar:d.FAR_PLANE,thickness:0,id:function(t){return t.renderable.id+1}},vshader:["attribute vec3 vertexPosition;","#ifdef NORMAL","attribute vec3 vertexNormal;","#endif","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","uniform float cameraFar;","uniform float thickness;","varying float depth;","void main() {","#ifdef NORMAL","vec4 mvPosition = viewMatrix * worldMatrix * vec4( vertexPosition + vertexNormal * thickness, 1.0 );","#else","vec4 mvPosition = viewMatrix * worldMatrix * vec4( vertexPosition, 1.0 );","#endif","depth = length(mvPosition.xyz) / cameraFar;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fshader:["uniform float id;","varying float depth;",n.methods.packDepth16,"void main() {","vec2 packedId = vec2(floor(id/255.0), mod(id, 255.0)) * vec2(1.0/255.0);","vec2 packedDepth = packDepth16(depth);","gl_FragColor = vec4(packedId, packedDepth);","}"].join("\n")};return f}),define("goo/shapes/Grid",["goo/renderer/MeshData"],function(t){"use strict";function e(e,o,r,i){if(1===arguments.length&&arguments[0]instanceof Object){var n=arguments[0];e=n.xSegments,o=n.ySegments,r=n.width,i=n.height}this.xSegments=e||10,this.ySegments=o||10,this.width=r||1,this.height=i||1;var a=t.defaultMap([t.POSITION]),s=4+2*(this.xSegments-1)+2*(this.ySegments-1),l=8+2*(this.xSegments-1)+2*(this.ySegments-1);t.call(this,a,s,l),this.indexModes[0]="Lines",this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){var e=this.width/2,o=this.height/2,r=[],i=[];r.push(-e,-o,0,-e,o,0,e,o,0,e,-o,0),i.push(0,1,1,2,2,3,3,0);for(var n,a=this.width/this.xSegments,s=1;s<this.xSegments;s++)n=s*a-e,r.push(n,-o,0,n,o,0);var l;a=this.height/this.ySegments;for(var s=1;s<this.ySegments;s++)l=s*a-o,r.push(-e,l,0,e,l,0);for(var s=i.length/2;s<r.length/3;s+=2)i.push(s,s+1);this.getAttributeBuffer(t.POSITION).set(r),this.getIndexBuffer().set(i)},e}),define("goo/entities/systems/GridRenderSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/renderer/SimplePartitioner","goo/renderer/MeshData","goo/renderer/Material","goo/renderer/Shader","goo/renderer/shaders/ShaderLib","goo/renderer/Util","goo/math/Transform","goo/shapes/Grid","goo/shapes/Quad"],function(t,e,o,r,i,n,a,s,l,h,d){"use strict";function c(){t.call(this,"GridRenderSystem",[]),this.renderList=[],this.doRender={grid:!0,surface:!0},this.camera=null,this.lights=[],this.transform=new l,this.transform.rotation.rotateX(-Math.PI/2),this.transform.scale.setd(1e3,1e3,1e3),this.transform.update();var o=i.createMaterial(u,"Grid Material");o.depthState.write=!0,o.depthState.enabled=!0,this.grid={meshData:new h(100,100),materials:[o],transform:this.transform};var r=s.clone(a.simpleColored),n=i.createMaterial(r,"Surface Material");n.uniforms.color=[.4,.4,.4],n.uniforms.opacity=.9,n.blendState.blending="CustomBlending",n.cullState.enabled=!1,n.depthState.write=!0,n.depthState.enabled=!0,n.offsetState.enabled=!0,n.offsetState.units=10,n.offsetState.factor=.8,this.surface={meshData:new d,materials:[n],transform:this.transform};var c=this;e.addListener("goo.setCurrentCamera",function(t){c.camera=t.camera}),e.addListener("goo.setLights",function(t){c.lights=t})}c.prototype=Object.create(t.prototype),c.prototype.inserted=function(){},c.prototype.deleted=function(){},c.prototype.process=function(){var t=this.renderList.length=0;this.doRender.surface&&(this.renderList[t++]=this.surface),this.doRender.grid&&(this.renderList[t++]=this.grid),this.renderList.length=t},c.prototype.render=function(t){t.checkResize(this.camera),this.camera&&t.render(this.renderList,this.camera,this.lights,null,!1)};var u={attributes:{vertexPosition:r.POSITION},uniforms:{viewMatrix:n.VIEW_MATRIX,projectionMatrix:n.PROJECTION_MATRIX,worldMatrix:n.WORLD_MATRIX,color:[.55,.55,.55,1],fogOn:!1,fogColor:[.1,.1,.1,1],fogNear:n.NEAR_PLANE,fogFar:n.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 worldMatrix;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","varying float depth;","void main(void)","{","vec4 viewPosition = viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","depth = viewPosition.z;","gl_Position = projectionMatrix * viewPosition;","}"].join("\n"),fshader:["precision mediump float;","uniform vec4 fogColor;","uniform vec4 color;","uniform float fogNear;","uniform float fogFar;","uniform bool fogOn;","varying float depth;","void main(void)","{","if (fogOn) {","float lerpVal = clamp(depth / (-fogFar + fogNear), 0.0, 1.0);","lerpVal = pow(lerpVal, 1.5);","gl_FragColor = mix(color, fogColor, lerpVal);","} else {","gl_FragColor = color;","}","}"].join("\n")};
return c}),define("goo/entities/systems/HTMLSystem",["goo/entities/systems/System","goo/renderer/Renderer","goo/math/Matrix4x4","goo/math/MathUtils","goo/math/Vector3"],function(t,e,o,r,i){"use strict";function n(e){t.call(this,"HTMLSystem",["TransformComponent","HTMLComponent"]),this.renderer=e,this.tmpVector=new i}n.prototype=Object.create(t.prototype);var a=["","-webkit-","-moz-","-ms-","-o-"],s=function(t,e,o){for(var r=0;r<a.length;r++)t.style[a[r]+e]=o};return n.prototype.process=function(t){if(0!==t.length)for(var o=e.mainCamera,r=this.renderer.domElement.width,i=this.renderer.domElement.height,n=0;n<t.length;n++){var a=t[n],l=a.getComponent("HTMLComponent");if(o.getScreenCoordinates(a.transformComponent.worldTransform.translation,r,i,this.tmpVector),a.hidden)l.domElement.style.display="none";else{if(this.tmpVector.z<0){l.hidden!==!0&&(l.domElement.style.display="none",l.hidden=!0);continue}l.domElement.style.display=l.hidden===!0?"none":""}var h=this.renderer,d=h._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/h.svg.currentScale:1,c=Math.floor(this.tmpVector.x/d),u=Math.floor((i-this.tmpVector.y)/d);s(l.domElement,"transform","translate(-50%, -50%) translate("+c+"px, "+u+"px)")}},n}),define("goo/entities/systems/LightDebugSystem",["goo/entities/systems/System","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/renderer/Material","goo/renderer/shaders/ShaderLib","goo/debug/LightPointer"],function(t,e,o,r,i,n){"use strict";function a(){t.call(this,"LightDebugSystem",["LightDebugComponent"])}return a.prototype=Object.create(t.prototype),a.prototype.inserted=function(t){var a=t.lightComponent.light,s=n.getMeshData(a);t.setComponent(new e(s));var l=r.createMaterial(i.simpleColored,"");l.uniforms.color=[a.color.data[0],a.color.data[1],a.color.data[2]];var h=new o;h.materials.push(l),t.setComponent(h),h.updateBounds(t.meshDataComponent.modelBound,t.transformComponent.worldTransform)},a.prototype.process=function(t){for(var e=0;e<t.length;e++){var o=t[e],r=o.lightComponent.light;r.changedProperties&&(r.changedProperties=!1,o.meshDataComponent.meshData=n.getMeshData(r),o.meshRendererComponent.updateBounds(o.meshDataComponent.modelBound,o.transformComponent.worldTransform)),r.changedColor&&(r.changedColor=!1,o.meshRendererComponent.materials[0].uniforms.color=[r.color.data[0],r.color.data[1],r.color.data[2]])}},a.prototype.deleted=function(t){t.clearComponent("MeshDataComponent"),t.clearComponent("MeshRendererComponent")},a}),define("goo/entities/systems/LightingSystem",["goo/entities/systems/System","goo/entities/SystemBus"],function(t,e){"use strict";function o(){t.call(this,"LightingSystem",["LightComponent","TransformComponent"]),this.overrideLights=null,this._needsUpdate=!0}return o.prototype=Object.create(t.prototype),o.prototype.setOverrideLights=function(t){this.overrideLights=t,e.emit("goo.setLights",this.overrideLights),this._needsUpdate=!0},o.prototype.clearOverrideLights=function(){this.overrideLights=void 0,this._needsUpdate=!0},o.prototype.process=function(t){if(!this.overrideLights){for(var o=[],r=0;r<t.length;r++){var i=t[r],n=i.transformComponent,a=i.lightComponent;(n._updated||this._needsUpdate)&&a.updateLight(n.worldTransform),a.hidden||o.push(a.light)}this._needsUpdate=!1,e.emit("goo.setLights",o)}},o}),define("goo/entities/systems/MovementSystem",["goo/entities/systems/System"],function(t){"use strict";function e(){t.call(this,"MovementSystem",["MovementComponent"])}return e.prototype=Object.create(t.prototype),e.prototype.addVelocityToTransform=function(t,e,o){e.translation.add_d(t.data[0]*o,t.data[1]*o,t.data[2]*o)},e.prototype.addRotToTransform=function(t,e,o){e.rotation.rotateX(t.data[0]*o),e.rotation.rotateY(t.data[1]*o),e.rotation.rotateZ(t.data[2]*o)},e.prototype.applyMovementToEntity=function(t){var e=t._world.tpf,o=t.movementComponent.getRotationVelocity(),r=t.movementComponent.getVelocity(),i=t.transformComponent.transform;this.addVelocityToTransform(r,i,e),this.addRotToTransform(o,i,e),t.transformComponent.setUpdated()},e.prototype.process=function(t){var e,o;for(e=0;e<t.length;e++)o=t[e].movementComponent,this.applyMovementToEntity(t[e])},e}),define("goo/entities/systems/ParticlesSystem",["goo/entities/systems/System"],function(t){"use strict";function e(){t.call(this,"ParticlesSystem",["TransformComponent","MeshRendererComponent","MeshDataComponent","ParticleComponent"]),this.passive=!1}return e.prototype=Object.create(t.prototype),e.prototype.process=function(t,e){if(!(e>1))for(var o=0,r=t.length;r>o;o++){var i=t[o],n=i.particleComponent;n.enabled&&this.updateParticles(i,n,e)}},e.prototype.updateParticles=function(t,e,o){for(var r,i=0,n=-1,a=!1,s=!1;i<e.particleCount;){for(;void 0===r;)if(n++,e.emitters.length>n){if(r=e.emitters[n],r.influences.length)for(var l=0,h=r.influences.length;h>l;l++)r.influences[l].prepare(t,r);if(!r.enabled){r=void 0;continue}if(0!==r.totalParticlesToSpawn&&(r.particlesWaitingToRelease+=r.releaseRatePerSecond*o,r.particlesWaitingToRelease=Math.max(r.particlesWaitingToRelease,0),s=!0),r.particlesWaitingToRelease<1){r=void 0;continue}}else r=null;var d=e.particles[i];if(d.alive&&d.emitter&&d.emitter.influences.length)for(var l=0,h=d.emitter.influences.length;h>l;l++)d.emitter.influences[l].enabled&&d.emitter.influences[l].apply(o,d,i);d.alive&&(d.update(o,t),a=!0,s=!0),!d.alive&&r&&(r.particlesWaitingToRelease--,r.totalParticlesToSpawn>=1&&r.totalParticlesToSpawn--,d.respawnParticle(r),r.getEmissionPoint(d,t),r.getEmissionVelocity(d,t),(r.particlesWaitingToRelease<1||0===r.totalParticlesToSpawn)&&(r=void 0)),i++}a&&(e.meshData.vertexData._dataNeedsRefresh=!0,t.meshDataComponent.autoCompute=!0),s||(e.enabled=!1)},e}),define("goo/entities/systems/PickingSystem",["goo/entities/systems/System"],function(t){"use strict";function e(e){t.call(this,"PickingSystem",["MeshRendererComponent","TransformComponent"]),this.passive=!0,this.pickRay=null,this.onPick=null,e=e||{},this.setPickLogic(e.pickLogic||null)}return e.prototype=Object.create(t.prototype),e.prototype.setPickLogic=function(t){this.pickLogic=t,t&&-1===this.interests.indexOf("MeshDataComponent")&&this.interests.push("MeshDataComponent")},e.prototype.inserted=function(t){t.meshRendererComponent.isPickable&&this.pickLogic&&this.pickLogic.added(t)},e.prototype.deleted=function(t){this.pickLogic&&this.pickLogic.removed(t)},e.prototype.process=function(t){if(this.pickRay&&this.onPick){for(var e=[],o=0;o<t.length;o++){var r=t[o],i=r.meshRendererComponent;if(i.isPickable)if(this.pickLogic){this.pickLogic.isConstructed(r)||this.pickLogic.added(r);var n=this.pickLogic.getPickResult(this.pickRay,r);n&&n.distances&&n.distances.length&&e.push({entity:r,intersection:n})}else if(i.worldBound){var n=i.worldBound.intersectsRayWhere(this.pickRay);n&&n.distances.length&&e.push({entity:r,intersection:n})}}e.sort(function(t,e){return t.intersection.distances[0]-e.intersection.distances[0]}),this.onPick(e)}},e}),define("goo/entities/systems/PortalSystem",["goo/entities/systems/System"],function(t){"use strict";function e(e,o){t.call(this,"PortalSystem",["MeshRendererComponent","MeshDataComponent","PortalComponent"]),this.renderer=e,this.renderSystem=o,this.renderList=[]}return e.prototype=Object.create(t.prototype),e.prototype.process=function(t){for(var e=0;e<t.length;e++){var o=t[e],r=o.portalComponent;if(r.options.autoUpdate||r.doUpdate){r.doUpdate=!1;var i=r.camera,n=r.target,a=r.secondaryTarget,s=r.overrideMaterial;if(r.alwaysRender||o.isVisible){this.render(this.renderer,i,n,s);var l=o.meshRendererComponent.materials[0];if(l.setTexture("DIFFUSE_MAP",n),r.options.preciseRecursion){var h=n;r.target=a,r.secondaryTarget=h}}}}},e.prototype.render=function(t,e,o,r){t.updateShadows(this.renderSystem.partitioner,this.renderSystem.entities,this.renderSystem.lights);for(var i=0;i<this.renderSystem.preRenderers.length;i++){var n=this.renderSystem.preRenderers[i];n.process(t,this.renderSystem.entities,this.renderSystem.partitioner,e,this.renderSystem.lights)}if(this.renderSystem.partitioner.process(e,this.renderSystem.entities,this.renderList),this.renderSystem.composers.length>0)for(var i=0;i<this.renderSystem.composers.length;i++){var a=this.renderSystem.composers[i];a.render(t,this.renderSystem.currentTpf,e,this.renderSystem.lights,null,!0)}else t.render(this.renderList,e,this.renderSystem.lights,o,!0,r)},e}),define("goo/entities/systems/ProximitySystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/util/StringUtil"],function(t,e,o){"use strict";function r(){t.call(this,"ProximitySystem",["ProximityComponent"]),this.collections={Red:{name:"Red",collection:[]},Blue:{name:"Blue",collection:[]},Green:{name:"Green",collection:[]},Yellow:{name:"Yellow",collection:[]}}}function i(t){return o.capitalize(t)}return r.prototype=Object.create(t.prototype),r.prototype._collides=function(t,o){for(var r=0;r<t.collection.length;r++)for(var i=t.collection[r],n=0;n<o.collection.length;n++){var a=o.collection[n];i.meshRendererComponent.worldBound.intersects(a.meshRendererComponent.worldBound)&&e.send("collides."+t.name+"."+o.name)}},r.prototype.getFor=function(t){return t=i(t),this.collections[t]?this.collections[t].collection:[]},r.prototype.add=function(t,e){e=i(e),this.collections[e]||(this.collections[e]={name:e,collection:[]}),this.collections[e].collection.push(t)},r.prototype.remove=function(t,e){e=i(e);var o=this.collections[e].collection,r=o.indexOf(t);o.splice(r,1)},r.prototype.process=function(){},r}),define("goo/entities/systems/SoundSystem",["goo/entities/systems/System","goo/sound/AudioContext","goo/math/Vector3","goo/math/MathUtils","goo/entities/SystemBus","goo/util/ObjectUtil"],function(t,e,o,r,i,n){"use strict";function a(){if(!e)return void console.warn("Cannot create soundsystem, webaudio not supported");t.call(this,"SoundSystem",["SoundComponent","TransformComponent"]),this.entities=[],this._outNode=e.createGain(),this._outNode.connect(e.destination),this._wetNode=e.createGain(),this._wetNode.connect(this._outNode),this._convolver=e.createConvolver(),this._convolver.connect(this._wetNode),this._listener=e.listener,this._listener.dopplerFactor=0,this._position=new o,this._oldPosition=new o,this._velocity=new o,this._orientation=new o,this._camera=null,this._up=new o,this._left=new o,this._settings={rolloffFactor:.4,maxDistance:100},this._wetNode.gain.value=.2,this._pausedSounds={};var r=this;i.addListener("goo.setCurrentCamera",function(t){r._camera=t.camera})}return a.prototype=Object.create(t.prototype),a.prototype.constructor=a,a.prototype.inserted=function(t){t.soundComponent.connectTo({dry:this._outNode,wet:this._convolver})},a.prototype.deleted=function(t){if(t.soundComponent){for(var e=t.soundComponent.sounds,o=0;o<e.length;o++)e[o].stop();t.soundComponent.connectTo(this._outNode)}},a.prototype.updateConfig=function(t){return e?(n.extend(this._settings,t),void 0!==t.dopplerFactor&&(this._listener.dopplerFactor=.05*t.dopplerFactor),void 0!==t.volume&&(this._outNode.gain.value=r.clamp(t.volume,0,1)),void(void 0!==t.reverb&&(this._wetNode.gain.value=r.clamp(t.reverb,0,1)))):void console.warn("Webaudio not supported")},a.prototype.setReverb=function(t){return e?(this._wetNode.disconnect(),void(!t&&this._wetNode?this._convolver.buffer=null:(this._convolver.buffer=t,this._wetNode.connect(this._outNode)))):void console.warn("Webaudio not supported")},a.prototype.pause=function(){if(!this._pausedSounds){this._pausedSounds={};for(var t=0;t<this.entities.length;t++)for(var e=this.entities[t].soundComponent.sounds,o=0;o<e.length;o++){var r=e[o];r.isPlaying()&&(r.pause(),this._pausedSounds[r.id]=!0)}}},a.prototype.stop=function(){for(var t=0;t<this.entities.length;t++)for(var e=this.entities[t].soundComponent.sounds,o=0;o<e.length;o++){var r=e[o];r.stop()}this._pausedSounds=null},a.prototype.resume=function(){if(this._pausedSounds){for(var t=0;t<this.entities.length;t++)for(var e=this.entities[t].soundComponent.sounds,o=0;o<e.length;o++){var r=e[o];this._pausedSounds[r.id]&&r.play()}this._pausedSounds=null}},a.prototype.process=function(t,o){if(e){this.entities=t;for(var r=0;r<t.length;r++){var i=t[r].soundComponent;i.process(this._settings,t[r].transformComponent.worldTransform,o)}if(this._camera){var n=this._camera;this._position.setv(n.translation),this._velocity.setv(this._position).subv(this._oldPosition).div(o),this._oldPosition.setv(this._position),this._orientation.setv(n._direction),this._up.setv(n._up),this._left.setv(n._left);var a=this._position.data;this._listener.setPosition(a[0],a[1],a[2]);var s=this._velocity.data;this._listener.setVelocity(s[0],s[1],s[2]);var l=this._orientation.data,h=this._up.data;this._listener.setOrientation(l[0],l[1],l[2],h[0],h[1],h[2])}}},a}),define("goo/entities/systems/TextSystem",["goo/entities/systems/System","goo/shapes/TextureGrid","goo/entities/components/MeshDataComponent"],function(t,e,o){"use strict";function r(){t.call(this,"TextSystem",["TextComponent"])}return r.prototype=Object.create(t.prototype),r.prototype.process=function(t){for(var r=0;r<t.length;r++){var i=t[r],n=i.textComponent;if(n.dirty){if(i.hasComponent("MeshDataComponent"))i.getComponent("MeshDataComponent").meshData=e.fromString(n.text);else{var a=e.fromString(n.text),s=new o(a);i.setComponent(s)}this.dirty=!1}}},r}),define("goo/math/Matrix2x2",["goo/math/MathUtils","goo/math/Matrix"],function(t,e){"use strict";function o(){e.call(this,2,2),0===arguments.length?this.setIdentity():this.set(arguments)}return o.prototype=Object.create(e.prototype),o.prototype.setupAliases([["e00"],["e10"],["e01"],["e11"]]),o.IDENTITY=new o(1,0,0,1),o.add=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00+e.e00,r.e10=t.e10+e.e10,r.e01=t.e01+e.e01,r.e11=t.e11+e.e11):(r.e00=t.e00+e,r.e10=t.e10+e,r.e01=t.e01+e,r.e11=t.e11+e),r},o.prototype.add=function(t){return o.add(this,t,this)},o.sub=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00-e.e00,r.e10=t.e10-e.e10,r.e01=t.e01-e.e01,r.e11=t.e11-e.e11):(r.e00=t.e00-e,r.e10=t.e10-e,r.e01=t.e01-e,r.e11=t.e11-e),r},o.prototype.sub=function(t){return o.sub(this,t,this)},o.mul=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00*e.e00,r.e10=t.e10*e.e10,r.e01=t.e01*e.e01,r.e11=t.e11*e.e11):(r.e00=t.e00*e,r.e10=t.e10*e,r.e01=t.e01*e,r.e11=t.e11*e),r},o.prototype.mul=function(t){return o.mul(this,t,this)},o.div=function(t,e,r){return r||(r=new o),e instanceof o?(r.e00=t.e00/e.e00,r.e10=t.e10/e.e10,r.e01=t.e01/e.e01,r.e11=t.e11/e.e11):(e=1/e,r.e00=t.e00*e,r.e10=t.e10*e,r.e01=t.e01*e,r.e11=t.e11*e),r},o.prototype.div=function(t){return o.div(this,t,this)},o.combine=function(t,r,i){return i||(i=new o),i===t||i===r?e.copy(o.combine(t,r),i):(i.e00=t.e00*r.e00+t.e01*r.e10,i.e10=t.e10*r.e00+t.e11*r.e10,i.e01=t.e00*r.e01+t.e01*r.e11,i.e11=t.e10*r.e01+t.e11*r.e11,i)},o.prototype.combine=function(t){return o.combine(this,t,this)},o.transpose=function(t,r){return r||(r=new o),r===t?e.copy(o.transpose(t),r):(r.e00=t.e00,r.e10=t.e01,r.e01=t.e10,r.e11=t.e11,r)},o.prototype.transpose=function(){return o.transpose(this,this)},o.invert=function(r,i){if(i||(i=new o),i===r)return e.copy(o.invert(r),i);var n=r.determinant();if(Math.abs(n)<t.EPSILON)throw{name:"Singular Matrix",message:"The matrix is singular and cannot be inverted."};return n=1/n,i.e00=r.e11*n,i.e10=0-r.e10*n,i.e01=0-r.e01*n,i.e11=r.e00*n,i},o.prototype.invert=function(){return o.invert(this,this)},o.prototype.isOrthogonal=function(){var e;return e=this.e00*this.e01+this.e10*this.e11,Math.abs(e)>t.EPSILON?!1:!0},o.prototype.isNormal=function(){var e;return e=this.e00*this.e00+this.e10*this.e10,Math.abs(e-1)>t.EPSILON?!1:(e=this.e01*this.e01+this.e11*this.e11,Math.abs(e-1)>t.EPSILON?!1:!0)},o.prototype.isOrthonormal=function(){return this.isOrthogonal()&&this.isNormal()},o.prototype.determinant=function(){return this.e00*this.e11-this.e01*this.e10},o.prototype.setIdentity=function(){return this.set(o.IDENTITY),this},o}),define("goo/particles/ParticleInfluence",[],function(){"use strict";function t(t){t=t||{},this.prepare=t.prepare?t.prepare:function(){},this.apply=t.apply?t.apply:function(){},this.enabled=void 0!==t.enabled?t.enabled===!0:!0}return t}),define("goo/picking/BoundingTree",["goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/math/Vector3"],function(t,e,o){"use strict";function r(t){this.leftTree=null,this.rightTree=null,this.localBound=null,this.worldBound=null,this.boundType=t?t:r.BOUNDTYPE_BOX}return r.BOUNDTYPE_SPHERE="sphere",r.BOUNDTYPE_BOX="box",r.MAX_PRIMITIVES_PER_LEAF=16,r.prototype.construct=function(t){if(!t.meshRendererComponent||!t.meshDataComponent||!t.transformComponent)return void console.warn("Entity missing required components for boundingtree construction: ",t);var e=t.meshDataComponent.meshData;if(e.updatePrimitiveCounts(),1===e.getSectionCount()){this.primitiveIndices=[];for(var o=0,r=e.getPrimitiveCount(0);r>o;o++)this.primitiveIndices.push(o);this.createTree(t,0,0,this.primitiveIndices.length)}else this.split(t,0,e.getSectionCount())},r.prototype.createTree=function(t,e,o,i){var n=t.meshDataComponent.meshData;this.section=e,this.start=o,this.end=i,this.primitiveIndices&&(this.createBounds(),this.localBound.computeFromPrimitives(n,e,this.primitiveIndices,o,i),i-o+1<=r.MAX_PRIMITIVES_PER_LEAF||(this.leftTree||(this.leftTree=new r(this.boundType)),this.leftTree.primitiveIndices=this.primitiveIndices,this.leftTree.createTree(t,e,o,Math.floor((o+i)/2)),this.rightTree||(this.rightTree=new r(this.boundType)),this.rightTree.primitiveIndices=this.primitiveIndices,this.rightTree.createTree(t,e,Math.floor((o+i)/2),i)))},r.prototype.split=function(t,e,o){var i=o-e,n=Math.floor(i/2);if(1===n){var a=e;this.leftTree=new r(this.boundType),this.leftTree.primitiveIndices=[];for(var s=0;s<this.leftTree.primitiveIndices.length;s++)this.leftTree.primitiveIndices.push(s);this.leftTree.createTree(t,a,0,this.leftTree.primitiveIndices.length)}else this.leftTree=new r(this.boundType),this.leftTree.split(t,e,e+n);if(i-n===1){var a=e+1;this.rightTree=new r(this.boundType),this.rightTree._primitiveIndices=[];for(var s=0;s<this.rightTree.primitiveIndices.length;s++)this.rightTree.primitiveIndices.push(s);this.rightTree.createTree(t,a,0,this.rightTree.primitiveIndices.length)}else this.rightTree=new r(this.boundType),this.rightTree.split(t,e+n,o);this.localBound=this.leftTree.localBound.clone(this.localBound),this.localBound.merge(this.rightTree.localBound),this.worldBound=this.localBound.clone(this.worldBound)},r.prototype.createBounds=function(){switch(this.boundType){case r.BOUNDTYPE_BOX:this.localBound=new t,this.worldBound=new t;break;case r.BOUNDTYPE_SPHERE:this.localBound=new e,this.worldBound=new e}},r.prototype.findPick=function(t,e,r){var i=r;i||(i={});var n=e.transformComponent.worldTransform;if(this.localBound.transform(n,this.worldBound),!this.worldBound.intersectsRay(t))return i;if(this.leftTree&&this.leftTree.findPick(t,e,i),this.rightTree)this.rightTree.findPick(t,e,i);else if(!this.leftTree)for(var a=e.meshDataComponent.meshData,s=null,l=new o,h=this.start;h<this.end;h++){s=a.getPrimitiveVertices(this.primitiveIndices[h],this.section,s);for(var d=0;d<s.length;d++)n.matrix.applyPostPoint(s[d]);if(t.intersects(s,!1,l)){i.distances=i.distances||[],i.distances.push(t.origin.distance(l)),i.points=i.points||[];var c=new o;c.setv(l),i.points.push(c),i.vertices=i.vertices||[],i.vertices.push(s)}}return i},r}),define("goo/picking/PrimitivePickLogic",["goo/picking/BoundingTree"],function(t){"use strict";function e(){}return e.prototype.getPickResult=function(t,e){var o=e.meshDataComponent.meshData.__boundingTree;return o?o.findPick(t,e,{}):null},e.prototype.added=function(t){this.isConstructed(t)||this.rebuild(t)},e.prototype.removed=function(t){t.meshDataComponent&&t.meshDataComponent.meshData&&(t.meshDataComponent.meshData.__boundingTree=null)},e.prototype.isConstructed=function(t){return!!t.meshDataComponent.meshData.__boundingTree},e.prototype.rebuild=function(e){e.meshDataComponent.meshData.__boundingTree=new t,e.meshDataComponent.meshData.__boundingTree.construct(e)},e}),define("goo/renderer/pass/DOFPass",["goo/renderer/Material","goo/renderer/pass/RenderTarget","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderFragment","goo/renderer/pass/RenderPass","goo/renderer/pass/FullscreenPass","goo/renderer/pass/BlurPass","goo/renderer/Util","goo/util/Skybox"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(o,r){this.depthPass=new n(o,function(t){return!(t instanceof h)}),this.regularPass=new n(o);var i=t.createMaterial(c);this.depthPass.overrideMaterial=i;var s=r||u;this.outPass=new a(s),this.outPass.useReadBuffer=!1,this.outPass.renderToScreen=!0;var d=window.innerWidth||1,p=window.innerHeight||1,m=l.nearestPowerOfTwo(Math.max(d,p));this.depthTarget=new e(d,p),this.regularTarget=new e(m/2,m/2),this.regularTarget2=new e(d,p),this.regularTarget.generateMipmaps=!0,this.regularTarget.minFilter="Trilinear",this.enabled=!0,this.clear=!1,this.needsSwap=!0}d.prototype.render=function(t,e,o,i){this.depthPass.render(t,null,this.depthTarget,i),this.regularPass.render(t,null,this.regularTarget,i),this.regularPass.render(t,null,this.regularTarget2,i),this.outPass.material.setTexture(r.DEPTH_MAP,this.depthTarget),this.outPass.material.setTexture(r.DIFFUSE_MAP,this.regularTarget),this.outPass.material.setTexture("DIFFUSE_MIP",this.regularTarget2),this.outPass.render(t,e,o,i)};var c={attributes:{vertexPosition:o.POSITION},uniforms:{viewMatrix:r.VIEW_MATRIX,projectionMatrix:r.PROJECTION_MATRIX,worldMatrix:r.WORLD_MATRIX,farPlane:r.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 vPosition;","void main(void) {","	vPosition = viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fshader:["precision mediump float;","uniform float farPlane;",i.methods.packDepth,"varying vec4 vPosition;","void main(void)","{","	float linearDepth = min(-vPosition.z, farPlane) / farPlane;","	gl_FragColor = packDepth(linearDepth);","}"].join("\n")},u={attributes:{vertexPosition:o.POSITION,vertexUV0:o.TEXCOORD0},uniforms:{worldMatrix:r.WORLD_MATRIX,viewProjectionMatrix:r.VIEW_PROJECTION_MATRIX,depthMap:r.DEPTH_MAP,diffuseMap:r.DIFFUSE_MAP,diffuseMip:"DIFFUSE_MIP",zfar:r.FAR_PLANE,focalDepth:100,fStop:2,CoC:.003,focalLength:75,maxBlur:16},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewProjectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","	texCoord0 = vertexUV0;","	gl_Position = viewProjectionMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:"uniform sampler2D diffuseMap;\nuniform sampler2D diffuseMip;\nuniform sampler2D depthMap;\nuniform float zfar; //camera clipping end\nuniform float focalDepth;\nuniform float focalLength;\nuniform float fStop;\nuniform float CoC;\nuniform float maxBlur;\nvarying vec2 texCoord0;\n"+i.methods.unpackDepth+"void main() \n{\n	float depth = unpackDepth(texture2D(depthMap,texCoord0)) * zfar;\n	float f = focalLength; //focal length in mm\n	float d = focalDepth*1000.0; //focal plane in mm\n	float o = depth*1000.0; //depth in mm\n	float a = (o*f)/(o-f); \n	float b = (d*f)/(d-f); \n	float c = (d-f)/(d*fStop*CoC); \n	float blur = clamp(abs(a-b)*c, 0.0, maxBlur);\n if (blur < 0.3) {\n   gl_FragColor = texture2D(diffuseMip, texCoord0);\n } else { \n   gl_FragColor = texture2D(diffuseMap, texCoord0, log2(blur));\n }\n gl_FragColor.a = 1.0;}"};return d}),define("goo/renderer/pass/DepthPass",["goo/renderer/Material","goo/renderer/pass/RenderTarget","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderFragment","goo/renderer/pass/RenderPass","goo/renderer/pass/FullscreenPass","goo/renderer/pass/BlurPass"],function(t,e,o,r,i,n,a,s){"use strict";function l(o,r){this.depthPass=new n(o);var i=t.createMaterial(h);this.depthPass.overrideMaterial=i,this.blurTarget=new e(256,256),this.blurPass=new s({target:this.blurTarget});var l=r||d;this.outPass=new a(l),this.outPass.useReadBuffer=!1;var c=window.innerWidth||1,u=window.innerHeight||1;this.depthTarget=new e(c,u),this.enabled=!0,this.clear=!1,this.needsSwap=!0}l.prototype.render=function(t,e,o,i){this.depthPass.render(t,null,this.depthTarget,i),this.blurPass.render(t,e,o,i),this.outPass.material.setTexture(r.DEPTH_MAP,this.depthTarget),this.outPass.material.setTexture(r.DIFFUSE_MAP,o),this.outPass.material.setTexture("BLUR_MAP",this.blurTarget),this.outPass.render(t,e,o,i)};var h={attributes:{vertexPosition:o.POSITION},uniforms:{viewMatrix:r.VIEW_MATRIX,projectionMatrix:r.PROJECTION_MATRIX,worldMatrix:r.WORLD_MATRIX,farPlane:r.FAR_PLANE},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec4 vPosition;","void main(void) {","	vPosition = viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","	gl_Position = projectionMatrix * vPosition;","}"].join("\n"),fshader:["precision mediump float;","uniform float farPlane;",i.methods.packDepth,"varying vec4 vPosition;","void main(void)","{","	float linearDepth = min(length(vPosition), farPlane) / farPlane;","	gl_FragColor = packDepth(linearDepth);","}"].join("\n")},d={attributes:{vertexPosition:o.POSITION,vertexUV0:o.TEXCOORD0},uniforms:{viewMatrix:r.VIEW_MATRIX,projectionMatrix:r.PROJECTION_MATRIX,worldMatrix:r.WORLD_MATRIX,depthMap:r.DEPTH_MAP,diffuseMap:r.DIFFUSE_MAP},vshader:["attribute vec3 vertexPosition;","attribute vec2 vertexUV0;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","varying vec2 texCoord0;","void main(void) {","	texCoord0 = vertexUV0;","	gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["precision mediump float;","uniform sampler2D depthMap;","uniform sampler2D diffuseMap;","varying vec2 texCoord0;",i.methods.unpackDepth,"void main(void)","{","	vec4 depthCol = texture2D(depthMap, texCoord0);","	vec4 diffuseCol = texture2D(diffuseMap, texCoord0);","	float depth = unpackDepth(depthCol);","	gl_FragColor = diffuseCol * vec4(depth);","}"].join("\n")};return l}),define("goo/renderer/pass/NesPass",["goo/renderer/TextureCreator","goo/renderer/Material","goo/renderer/pass/FullscreenUtil","goo/renderer/shaders/ShaderLib"],function(t,e,o,r){"use strict";function i(r){this.material=e.createMaterial(n),this.renderToScreen=!1,this.renderable={meshData:o.quad,materials:[this.material]},this.mapping=(new t).loadTexture2D(r),this.mapping.minFilter="NearestNeighborNoMipMaps",this.mapping.magFilter="NearestNeighbor",this.mapping.generateMipmaps=!1,this.enabled=!0,this.clear=!1,this.needsSwap=!0}i.prototype.render=function(t,e,r){this.material.setTexture("DIFFUSE_MAP",r),this.material.setTexture("COLOR_MAPPING",this.mapping),this.renderToScreen?t.render(this.renderable,o.camera,[],null,this.clear):t.render(this.renderable,o.camera,[],e,this.clear)};var n={attributes:r.copy.attributes,uniforms:{diffuse:"DIFFUSE_MAP",mapping:"COLOR_MAPPING",$link:r.copy.uniforms},vshader:r.copy.vshader,fshader:["precision mediump float;","uniform sampler2D diffuse;","uniform sampler2D mapping;","varying vec2 texCoord0;","void main() {","	vec4 texCol = texture2D( diffuse, texCoord0 );","	float r = floor(texCol.r * 31.0);","	float g = floor(texCol.g * 31.0);","	float b = floor(texCol.b * 31.0);","	vec4 texPalette = texture2D( mapping, vec2((r * 32.0 + g)/1024.0, b / 32.0) );","	gl_FragColor = vec4( texPalette.rgb, 1.0 );","}"].join("\n")};return i}),define("goo/renderer/pass/SSAOPass",["goo/renderer/Material","goo/renderer/pass/RenderTarget","goo/renderer/Util","goo/renderer/MeshData","goo/renderer/Shader","goo/renderer/shaders/ShaderFragment","goo/renderer/pass/RenderPass","goo/renderer/pass/FullscreenPass","goo/renderer/pass/BlurPass","goo/renderer/shaders/ShaderLib"],function(t,e,o,r,i,n,a,s,l,h){"use strict";function d(e){this.depthPass=new a(e),this.depthPass.clearColor.set(1,1,1,1);var o=t.createMaterial(c);this.depthPass.overrideMaterial=o,this.downsampleAmount=4;var r=window.innerWidth||1024,i=window.innerHeight||1024;this.updateSize({x:0,y:0,width:r,height:i}),this.enabled=!0,this.clear=!1,this.needsSwap=!0}d.prototype.updateSize=function(t){var r=Math.floor(t.width/this.downsampleAmount),i=Math.floor(t.height/this.downsampleAmount),n=o.clone(h.ssao);n.uniforms.size=[r,i],this.outPass=new s(n),this.outPass.useReadBuffer=!1,this.blurPass=new l({sizeX:r,sizeY:i}),this.depthTarget=new e(r,i,{magFilter:"NearestNeighbor",minFilter:"NearestNeighborNoMipMaps"}),console.log("UPDATE SSAOPASS: ",r,i)},d.prototype.render=function(t,e,o,r){this.depthPass.render(t,null,this.depthTarget,r),this.outPass.material.setTexture(i.DIFFUSE_MAP,o),this.outPass.material.setTexture(i.DEPTH_MAP,this.depthTarget),this.outPass.render(t,e,o,r)};var c={attributes:{vertexPosition:r.POSITION},uniforms:{viewMatrix:i.VIEW_MATRIX,projectionMatrix:i.PROJECTION_MATRIX,worldMatrix:i.WORLD_MATRIX},vshader:["attribute vec3 vertexPosition;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 worldMatrix;","void main(void) {","	gl_Position = projectionMatrix * viewMatrix * worldMatrix * vec4(vertexPosition, 1.0);","}"].join("\n"),fshader:["precision mediump float;",n.methods.packDepth,"void main(void) {","	gl_FragColor = packDepth(gl_FragCoord.z);","}"].join("\n")};return d}),define("goo/util/GameUtils",[],function(){"use strict";function t(){}return t.supported={fullscreen:!0,pointerLock:!0},t.toggleFullScreen=function(){document.fullscreenElement?document.cancelFullScreen&&document.cancelFullScreen():document.documentElement.requestFullScreen&&document.documentElement.requestFullScreen()},t.requestPointerLock=function(){document.documentElement.requestPointerLock&&document.documentElement.requestPointerLock()},t.exitPointerLock=function(){document.exitPointerLock&&document.exitPointerLock()},t.togglePointerLock=function(){document.pointerLockElement?document.exitPointerLock&&document.exitPointerLock():document.documentElement.requestPointerLock&&document.documentElement.requestPointerLock()},t.addVisibilityChangeListener=function(t){if("function"==typeof t){for(var e,o,r=["","ms","moz","webkit"],i=0;i<r.length;++i){var n=r[i]+(0===r[i].length?"hidden":"Hidden"),a=r[i]+"visibilitychange";if("undefined"!=typeof document[n]){e=n,o=a;break}}"undefined"!=typeof document.addEventListener&&"undefined"!=typeof e&&document.addEventListener(o,function(){t(document[e]?!0:!1)})}},t.initAllShims=function(e){t.initWebGLShims(),t.initAnimationShims(),t.initFullscreenShims(e),t.initPointerLockShims(e)},t.initWebGLShims=function(){window.Uint8ClampedArray=window.Uint8ClampedArray||window.Uint8Array},t.initAnimationShims=function(){for(var t=0,e=["ms","moz","webkit","o"],o=0;o<e.length&&!window.requestAnimationFrame;++o)window.requestAnimationFrame=window[e[o]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[o]+"CancelAnimationFrame"]||window[e[o]+"CancelRequestAnimationFrame"];void 0===window.requestAnimationFrame&&(window.requestAnimationFrame=function(e){var o=Date.now(),r=Math.max(0,16-(o-t)),i=window.setTimeout(function(){e(o+r)},r);return t=o+r,i}),void 0===window.cancelAnimationFrame&&(window.cancelAnimationFrame=function(t){clearTimeout(t)})},t.initFullscreenShims=function(e){function o(){var t=document.createEvent("CustomEvent");t.initCustomEvent("fullscreenchange",!0,!1,null),document.dispatchEvent(t)}function r(){var t=document.createEvent("CustomEvent");t.initCustomEvent("fullscreenerror",!0,!1,null),document.dispatchEvent(t)}e=e||window;var i=(e.HTMLElement||e.Element).prototype;if(!document.hasOwnProperty("fullscreenEnabled")){var n=function(){return"webkitIsFullScreen"in document?function(){return document.webkitFullscreenEnabled
}:"mozFullScreenEnabled"in document?function(){return document.mozFullScreenEnabled}:(t.supported.fullscreen=!1,function(){return!1})}();Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,writeable:!1,get:n})}if(!document.hasOwnProperty("fullscreenElement")){var n=function(){for(var t=["webkitCurrentFullScreenElement","webkitFullscreenElement","mozFullScreenElement"],e=function(e){return function(){return document[t[e]]}},o=0;o<t.length;o++)if(t[o]in document)return e(o);return function(){return null}}();Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,writeable:!1,get:n})}document.addEventListener("webkitfullscreenchange",o,!1),document.addEventListener("mozfullscreenchange",o,!1),document.addEventListener("webkitfullscreenerror",r,!1),document.addEventListener("mozfullscreenerror",r,!1),i.requestFullScreen||(i.requestFullScreen=function(){return i.webkitRequestFullScreen?function(){this.webkitRequestFullScreen(e.Element.ALLOW_KEYBOARD_INPUT)}:i.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:function(){}}()),document.cancelFullScreen||(document.cancelFullScreen=function(){return document.webkitCancelFullScreen||document.mozCancelFullScreen||function(){}}())},t.initPointerLockShims=function(e){function o(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(t)}function r(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(t)}e=e||window;var i=(e.HTMLElement||e.Element).prototype;if(e.MouseEvent){var n=e.MouseEvent.prototype;if("movementX"in n||Object.defineProperty(n,"movementX",{enumerable:!0,configurable:!1,writeable:!1,get:function(){return this.webkitMovementX||this.mozMovementX||0}}),"movementY"in n||Object.defineProperty(n,"movementY",{enumerable:!0,configurable:!1,writeable:!1,get:function(){return this.webkitMovementY||this.mozMovementY||0}}),navigator.pointer||(navigator.pointer=navigator.webkitPointer||navigator.mozPointer),document.addEventListener("webkitpointerlockchange",o,!1),document.addEventListener("webkitpointerlocklost",o,!1),document.addEventListener("mozpointerlockchange",o,!1),document.addEventListener("mozpointerlocklost",o,!1),document.addEventListener("webkitpointerlockerror",r,!1),document.addEventListener("mozpointerlockerror",r,!1),!document.hasOwnProperty("pointerLockElement")){var a=function(){return"webkitPointerLockElement"in document?function(){return document.webkitPointerLockElement}:"mozPointerLockElement"in document?function(){return document.mozPointerLockElement}:function(){return null}}();Object.defineProperty(document,"pointerLockElement",{enumerable:!0,configurable:!1,writeable:!1,get:a})}i.requestPointerLock||(i.requestPointerLock=function(){return i.webkitRequestPointerLock?function(){this.webkitRequestPointerLock()}:i.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:navigator.pointer?function(){var t=this;navigator.pointer.lock(t,o,r)}:(t.supported.pointerLock=!1,function(){})}()),document.exitPointerLock||(document.exitPointerLock=function(){return document.webkitExitPointerLock||document.mozExitPointerLock||function(){navigator.pointer&&navigator.pointer.unlock()}}())}},t}),define("goo/scripts/newwave/FPCamControlScript",["goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils","goo/util/GameUtils"],function(t,e,o,r){"use strict";function i(){function e(e,o){s=new t,l=0,h=0,d=!1,c={dX:0,dY:0},a(o.domElement)}function i(t,e,r,i){var n=t.transformComponent,a=n.transform,d=a.rotation;if(d.toAngles(s),h=s.x,l=s.y,0!==c.dX&&(l-=i.turnSpeedHorizontal*c.dX),0!==c.dY){var u=i.maxAscent*o.DEG_TO_RAD,p=i.minAscent*o.DEG_TO_RAD;h-=i.turnSpeedVertical*c.dY,h>u?h=u:p>h&&(h=p)}a.rotation.fromAngles(h,l,0),n.setUpdated(),c.dX=0,c.dY=0}function n(){}function a(t){t.addEventListener("mousedown",u.bind(this),!1),document.addEventListener("mousemove",p.bind(this)),document.addEventListener("pointerlockchange",m.bind(this)),document.addEventListener("pointerlockerror",f.bind(this)),r.requestPointerLock()}var s,l,h,d,c,s,u=function(){r.requestPointerLock()},p=function(t){d&&(c.dX+=t.movementX,c.dY+=t.movementY)},m=function(){d=!!document.pointerLockElement},f=function(){d=!!document.pointerLockElement};return{setup:e,run:i,cleanup:n}}return i.externals={name:"FPCamControlScript",description:"Attempts to lock the pointer and control the entity's orientation based on mouse movements",parameters:[{key:"turnSpeedHorizontal","default":.01,type:"float",control:"slider",min:.01,max:1},{key:"turnSpeedVertical","default":.01,type:"float",control:"slider",min:.01,max:1},{key:"maxAscent","default":89,type:"int",control:"slider",min:-89,max:89},{key:"minAscent","default":-89,type:"int",control:"slider",min:-89,max:89}]},i}),define("goo/scripts/newwave/PickAndRotateScript",["goo/math/Vector3"],function(t){"use strict";function e(){function e(t){console.log("Entity is "+t.entity+" at "+t.depth),d=t.entity,u.down=!!t.entity}function o(t){u.ox=u.x,u.oy=u.y,u.x=t.clientX,u.y=t.clientY,u.dx=u.x-u.ox,u.dy=u.y-u.oy,d&&u.down&&(d.transformComponent.transform.rotation.fromAngles(u.y/-180,u.x/180,0),d.transformComponent.setUpdated())}function r(){u.down=!1}function i(t,i){c=t,h=i.world.gooRunner,h.addEventListener("mousedown",e),h.renderer.domElement.addEventListener("mousemove",o),h.renderer.domElement.addEventListener("mouseup",r)}function n(){if(!f.equals(t.ZERO)){g.set(p.x*f.z+m.x*f.x,p.y*f.z+m.y*f.x,p.z*f.z+m.z*f.x),g.normalize();var e=1;g.mul(e);var o=l.rotation;o.applyPost(g),l.translation.add(g),s.setUpdated()}}function a(t,i){i.domElement.removeEventListener("mousemove",o,!1),i.domElement.removeEventListener("mouseup",r,!1),h.removeEventListener("mousedown",e)}var s,l,h,d,c,u={x:0,y:0,ox:0,oy:0,dx:0,dy:0},p=new t(0,0,-1),m=new t(-1,0,0),f=new t,g=new t;return{setup:i,update:n,cleanup:a}}return e.externals={name:"Pick and rotate",key:"PickAndRotateScript",description:"Enables pick-drag-rotating entities"},e}),define("goo/scripts/newwave/RotationScript",[],function(){"use strict";function t(){function t(t,e){i={x:0,y:0},n={x:0,y:0},a=e.entity,document.addEventListener("mousemove",o)}function e(t){n.x+=(i.x-n.x)*t.fraction,n.y+=(i.y-n.y)*t.fraction,a.setRotation(n.y/200,n.x/200,0)}function o(t){i.x=t.x,i.y=t.y}function r(){document.removeEventListener("mousemove",o)}var i,n,a;return{setup:t,update:e,cleanup:r}}return t.externals={name:"RotationScript",description:"",parameters:[{key:"fraction",name:"Speed","default":.01,type:"float",control:"slider",min:.01,max:1}]},t}),define("goo/shapes/ProjectedGrid",["goo/renderer/MeshData","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4","goo/math/Matrix4x4","goo/renderer/Camera","goo/math/MathUtils"],function(t,e,o,r,i,n,a){"use strict";function s(a,s){this.densityX=void 0!==a?a:20,this.densityY=void 0!==s?s:20,this.projectorCamera=new n(45,1,.1,2e3),this.mainCamera=new n(45,1,.1,2e3),this.freezeProjector=!1,this.upperBound=20,this.origin=new r,this.direction=new r,this.source=new e,this.rangeMatrix=new i,this.intersectBottomLeft=new r,this.intersectTopLeft=new r,this.intersectTopRight=new r,this.intersectBottomRight=new r,this.planeIntersection=new o,this.freezeProjector=!1,this.projectorMinHeight=50,this.intersections=[];for(var l=0;24>l;l++)this.intersections.push(new o);this.connections=[0,3,1,2,0,4,1,5,2,6,3,7,4,7,5,6];var h=this.densityX*this.densityY,d=(this.densityX-1)*(this.densityY-1)*6,c=t.defaultMap([t.POSITION,t.TEXCOORD0]);t.call(this,c,h,d),this.rebuild()}return s.prototype=Object.create(t.prototype),s.prototype.update=function(t){var e=this.upperBound,n=this.mainCamera;if(n){this.freezeProjector||n.copy(t);var s=n.translation;s.y>0&&s.y<e+n.near?n.translation.setd(s.x,e+n.near,s.z):s.y<0&&s.y>-e-n.near&&n.translation.setd(s.x,-e-n.near,s.z);for(var l=n.calculateFrustumCorners(),h=0,d=new o,c=0;8>c;c++){var u=this.connections[2*c],p=this.connections[2*c+1];(l[u].y>e&&l[p].y<e||l[u].y<e&&l[p].y>e)&&this.getWorldIntersectionSimple(e,l[u],l[p],this.intersections[h++],d),(l[u].y>-e&&l[p].y<-e||l[u].y<-e&&l[p].y>-e)&&this.getWorldIntersectionSimple(-e,l[u],l[p],this.intersections[h++],d)}for(var c=0;8>c;c++)l[c].y<e&&l[c].y>-e&&this.intersections[h++].set(l[c]);if(0===h)return!1;var m=this.projectorCamera;if(m.copy(n),m.translation.y>0&&m._direction.y>0||m.translation.y<0&&m._direction.y<0){m._direction.y=-m._direction.y;var f=new o;f.setv(m._direction).cross(m._left).normalize(),m._up.setv(f)}var u=this.source,g=this.planeIntersection;u.set(.5,.5),this.getWorldIntersection(0,u,m.getViewProjectionInverseMatrix(),g);var v=m.translation;if(v.y>0&&v.y<2*this.projectorMinHeight){var y=(2*this.projectorMinHeight-v.y)/(2*this.projectorMinHeight);m.translation.setd(v.x,2*this.projectorMinHeight-this.projectorMinHeight*y,v.z)}else if(v.y<0&&v.y>2*-this.projectorMinHeight){var y=(2*-this.projectorMinHeight-v.y)/(2*-this.projectorMinHeight);m.translation.setd(v.x,2*-this.projectorMinHeight+this.projectorMinHeight*y,v.z)}g.subv(m.translation),g.y=0;var x=g.length();x>Math.abs(m.translation.y)?(g.normalize(),g.mul(Math.abs(m.translation.y))):x<a.EPSILON&&(g.addv(m._up),g.y=0,g.normalize(),g.mul(.1)),g.addv(m.translation),g.y=0,m.lookAt(g,o.UNIT_Y);for(var w=m.getViewProjectionMatrix(),_=new r,b=this.intersections,c=0;h>c;c++)_.set(b[c].x,0,this.intersections[c].z,1),w.applyPost(_),b[c].set(_.x,_.y,0),b[c].div(_.w);for(var S=Number.MAX_VALUE,M=-Number.MAX_VALUE,C=Number.MAX_VALUE,P=-Number.MAX_VALUE,c=0;h>c;c++)b[c].x<S&&(S=b[c].x),b[c].x>M&&(M=b[c].x),b[c].y<C&&(C=b[c].y),b[c].y>P&&(P=b[c].y);var T=this.rangeMatrix;T.setIdentity(),T.e00=M-S,T.e11=P-C,T.e03=S,T.e13=C;var E=m.getViewProjectionInverseMatrix();return i.combine(E,T,T),u.set(.5,.5),this.getWorldIntersectionHomogenous(0,u,T,this.intersectBottomLeft),u.set(.5,1),this.getWorldIntersectionHomogenous(0,u,T,this.intersectTopLeft),u.set(1,1),this.getWorldIntersectionHomogenous(0,u,T,this.intersectTopRight),u.set(1,.5),this.getWorldIntersectionHomogenous(0,u,T,this.intersectBottomRight),!0}},s.prototype.getWorldIntersectionHomogenous=function(t,e,o,r){this.calculateIntersection(t,e,o),r.setv(this.origin)},s.prototype.getWorldIntersection=function(t,e,o,r){this.calculateIntersection(t,e,o),r.setd(this.origin.x,this.origin.y,this.origin.z).div(this.origin.w)},s.prototype.getWorldIntersectionSimple=function(t,e,o,r,i){var n=r.setv(e),a=i.setv(o).sub(n),s=(t-n.y)/a.y;return a.mul(s),n.addv(a),s>=0&&1>=s},s.prototype.calculateIntersection=function(t,e,o){if(this.origin.setd(2*e.x-1,2*e.y-1,-1,1),this.direction.setd(2*e.x-1,2*e.y-1,1,1),o.applyPost(this.origin),o.applyPost(this.direction),this.direction.sub(this.origin),Math.abs(this.direction.y)>a.EPSILON){var r=(t-this.origin.y)/this.direction.y;this.direction.mul(r)}else this.direction.normalize(),this.direction.mul(this.mainCamera._frustumFar);this.origin.add(this.direction)},s.prototype.rebuild=function(){for(var e=this.getAttributeBuffer(t.POSITION),o=this.getAttributeBuffer(t.TEXCOORD0),r=this.getIndexBuffer(),i=this.densityX,n=this.densityY,a=0;i>a;a++)for(var s=0;n>s;s++)e[3*(a+s*i)+0]=a,e[3*(a+s*i)+1]=0,e[3*(a+s*i)+2]=s,o[2*(a+s*i)+0]=a/(i-1),o[2*(a+s*i)+1]=s/(n-1);for(var l=0,h=0;i*(n-1)>h;h++)(h%(i*(Math.floor(h/i)+1)-1)!==0||0===h)&&(r[l++]=h,r[l++]=1+i+h,r[l++]=1+h,r[l++]=h,r[l++]=i+h,r[l++]=1+i+h);return this},s}),define("goo/shapes/SimpleBox",["goo/renderer/MeshData"],function(t){"use strict";function e(e,o,r){this.xExtent=void 0!==e?.5*e:.5,this.yExtent=void 0!==o?.5*o:.5,this.zExtent=void 0!==r?.5*r:.5;var i=t.defaultMap([t.POSITION]);t.call(this,i,8,36),this.rebuild()}return e.prototype=Object.create(t.prototype),e.prototype.rebuild=function(){var e=this.xExtent,o=this.yExtent,r=this.zExtent;return this.getAttributeBuffer(t.POSITION).set([-e,-o,-r,e,-o,-r,e,o,-r,-e,o,-r,-e,-o,r,e,-o,r,e,o,r,-e,o,r]),this.getIndexBuffer().set([0,1,2,2,3,0,7,6,5,5,4,7,0,3,7,7,4,0,1,2,6,6,5,1,3,2,6,6,7,3,0,1,5,5,4,0]),this},e}),define("goo/sound/OscillatorSound",["goo/sound/AudioContext","goo/math/MathUtils"],function(t,e){"use strict";function o(){this.id=null,this._volume=1,this._frequency=440,this._type="sine",this._outNode=t.createGain(),this.connectTo()}return o.prototype.stop=function(){this._oscNode.stop(),this._oscNode=null},o.prototype.play=function(){this._oscNode=t.createOscillator(),this._oscNode.connect(this._outNode),this._oscNode.frequency.value=this._frequency,this._oscNode.type=this._type,this._oscNode.start()},o.prototype.update=function(t){void 0!==t.volume&&(this._volume=e.clamp(t.volume,0,1),this._outNode.gain.value=this._volume),void 0!==t.frequency&&(this._frequency=t.frequency,this._oscNode&&(this._oscNode.frequency.value=this._frequency)),void 0!==t.type&&-1!==o.TYPES.indexOf(t.type)&&(this._type=t.type,this._oscNode&&(this._oscNode.type=this._type))},o.prototype.connectTo=function(e){if(!t)return void console.warn("Webaudio not supported");if(this._outNode.disconnect(),e){e instanceof Array||(e=[e]);for(var o=0;o<e.length;o++)this._outNode.connect(e[o])}},o.TYPES=["sine","square","sawtooth","triangle","custom"],o}),define("goo/util/ColorUtil",["goo/math/Vector4"],function(t){"use strict";function e(){}e.arrayToVector4=function(e,o){return o=o||new t,o.seta(e),o},e.hexToArray=function(t,e){return e=e||[],t=Math.floor(t),e[0]=(t>>16&255)/255,e[1]=(t>>8&255)/255,e[2]=(255&t)/255,e},e.arrayToHex=function(t){return 255*t[0]<<16^255*t[1]<<8^255*t[2]<<0},e.arrayToHexString=function(t){return("000000"+e.arrayToHex(t).toString(16)).slice(-6)};var o=/^rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)$/i,r=/^rgb\(\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*\)$/i,i=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i,n=/^\#([0-9a-f]{6})$/i,a=/^(\w+)$/i;return e.cssToArray=function(t,s){if(s=s||[],o.test(t)){var l=o.exec(t);return s[0]=Math.min(255,parseInt(l[1],10))/255,s[1]=Math.min(255,parseInt(l[2],10))/255,s[2]=Math.min(255,parseInt(l[3],10))/255,s}if(r.test(t)){var l=r.exec(t);return s[0]=Math.min(100,parseInt(l[1],10))/100,s[1]=Math.min(100,parseInt(l[2],10))/100,s[2]=Math.min(100,parseInt(l[3],10))/100,s}if(n.test(t)){var l=n.exec(t);return this.hexToArray(parseInt(l[1],16),s)}if(i.test(t)){var l=i.exec(t);return this.hexToArray(parseInt(l[1]+l[1]+l[2]+l[2]+l[3]+l[3],16),s)}return a.test(t)?this.hexToArray(e.color[t],s):(console.warn("No matching style found"),s[0]=s[1]=s[2]=0,s)},e.HSLToArray=function(t,e,o,r){if(r=r||[],0===e)r[0]=r[1]=r[2]=o;else{var i=function(t,e,o){return 0>o&&(o+=1),o>1&&(o-=1),1/6>o?t+6*(e-t)*o:.5>o?e:2/3>o?t+6*(e-t)*(2/3-o):t},n=.5>=o?o*(1+e):o+e-o*e,a=2*o-n;r[0]=i(a,n,t+1/3),r[1]=i(a,n,t),r[2]=i(a,n,t-1/3)}return r},e.arrayToHSL=function(t,e){e=e||[];var o,r,i=t[0],n=t[1],a=t[2],s=Math.max(i,n,a),l=Math.min(i,n,a),h=(l+s)/2;if(l===s)o=0,r=0;else{var d=s-l;switch(r=.5>=h?d/(s+l):d/(2-s-l),s){case i:o=(n-a)/d+(a>n?6:0);break;case n:o=(a-i)/d+2;break;case a:o=(i-n)/d+4}o/=6}return e[0]=o,e[1]=r,e[2]=h,e},e.HSBToArray=function(t,e,o,r){r=r||[];var i=0,n=0,a=0;if(0===e)i=n=a=o;else{var s=6*(t-Math.floor(t)),l=s-Math.floor(s),h=o*(1-e),d=o*(1-e*l),c=o*(1-e*(1-l));switch(s){case 0:i=o,n=c,a=h;break;case 1:i=d,n=o,a=h;break;case 2:i=h,n=o,a=c;break;case 3:i=h,n=d,a=o;break;case 4:i=c,n=h,a=o;break;case 5:i=o,n=h,a=d}}return r[0]=i,r[1]=n,r[2]=a,r},e.arrayToHSB=function(t,e){e=e||[];var o,r,i,n=t[0],a=t[1],s=t[2],l=n>a?n:a;s>l&&(l=s);var h=a>n?n:a;if(h>s&&(h=s),i=l/255,r=0!==l?(l-h)/l:0,0===r)o=0;else{var d=(l-n)/(l-h),c=(l-a)/(l-h),u=(l-s)/(l-h);o=n===l?u-c:a===l?2+d-u:4+c-d,o/=6,0>o&&(o+=1)}return e[0]=o,e[1]=r,e[2]=i,e},e.arrayToCSS=function(t){return"rgb("+(255*t[0]|0)+","+(255*t[1]|0)+","+(255*t[2]|0)+")"},e.color={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},e}),define("goo/util/Rc4Random",[],function(){"use strict";function t(t){function e(){r=(r+1)%256,i=(i+o[r])%256;var t=o[r];return o[r]=o[i],o[i]=t,o[(o[r]+o[i])%256]}var o=[],r=0,i=0;this.init=function(t){for(var e=0;256>e;e++)o[e]=e;for(var r=0,e=0;256>e;e++){r=(r+o[e]+t.charCodeAt(e%t.length))%256;var i=o[e];o[e]=o[r],o[r]=i}},this.init(t),this.getRandomNumber=function(){for(var t=0,o=1,r=0;8>r;r++)t+=e()*o,o*=256;return t/0x10000000000000000}}return t}),define("goo/util/SoundCreator",["goo/renderer/Util","goo/loaders/handlers/SoundHandler","goo/util/Ajax","goo/util/StringUtil"],function(t,e,o,r){"use strict";function i(){var t=new o;this.soundHandler=new e({},function(e,o){return t.load(e,o?o.noCache:!1)},function(){},function(e,o){return t.load(e,o?o.noCache:!1)})}return i.prototype.loadSound=function(t,e,o){var i=r.createUniqueId("sound");e=e||{},e.audioRefs={};var n=r.getAfterLast(t,".");e.audioRefs[n]=t;var a=this.soundHandler._objects[i]=this.soundHandler._create();return this.soundHandler.update(i,e,{}).then(function(){o&&o(a)}),a},i}),define("goo/util/Stats",[],function(){"use strict";function t(){var t=Date.now(),e=t,o=t,r=0,i=1/0,n=0,a=0,s=1/0,l=0,h=0,d=0,c=document.createElement("div");c.id="stats",c.addEventListener("mousedown",function(t){t.preventDefault(),_(++d%2)},!1),c.style.cssText="width:80px;cursor:pointer;z-index:1000;-webkit-touch-callout: none;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;";var u=document.createElement("div");u.id="fps",u.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#002",c.appendChild(u);var p=document.createElement("div");p.id="fpsText",p.style.cssText="color:#0ff;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",p.innerHTML="FPS",u.appendChild(p);var m=document.createElement("div");for(m.id="fpsGraph",m.style.cssText="position:relative;width:74px;height:30px;background-color:#0ff",u.appendChild(m);m.children.length<74;){var f=document.createElement("span");f.style.cssText="width:1px;height:30px;float:left;background-color:#113",m.appendChild(f)}var g=document.createElement("div");g.id="ms",g.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#020;display:none",c.appendChild(g);var v=document.createElement("div");v.id="msText",v.style.cssText="color:#0f0;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",v.innerHTML="MS",g.appendChild(v);var y=document.createElement("div");for(y.id="msGraph",y.style.cssText="position:relative;width:74px;height:30px;background-color:#0f0",g.appendChild(y);y.children.length<74;){var f=document.createElement("span");f.style.cssText="width:1px;height:30px;float:left;background-color:#131",y.appendChild(f)}var x=document.createElement("div");x.id="info",x.style.cssText="padding:0 0 3px 3px;text-align:left;background-color:#200",c.appendChild(x);var w=document.createElement("div");w.id="infoText",w.style.cssText="color:#f66;font-family:Helvetica,Arial,sans-serif;font-size:8px;font-weight:bold;line-height:13px",w.innerHTML="INFO",x.appendChild(w);var _=function(t){switch(d=t){case 0:u.style.display="block",g.style.display="none";break;case 1:u.style.display="none",g.style.display="block"}},b=function(t,e){var o=t.appendChild(t.firstChild);o.style.height=e+"px"};this.domElement=c,this.setMode=_,this.begin=function(){t=Date.now()},this.end=function(d){var c=Date.now();return c>o+100&&(r=c-t,i=Math.min(i,r),n=Math.max(n,r),v.textContent=r+" MS ("+i+"-"+n+")",b(y,Math.min(30,30-r/200*30)),o=c,d&&(w.innerHTML="Calls: "+d.calls+"<br>Vertices: "+d.vertices+"<br>Indices: "+d.indices)),h++,c>e+1e3&&(a=Math.round(1e3*h/(c-e)),s=Math.min(s,a),l=Math.max(l,a),p.textContent=a+" FPS ("+s+"-"+l+")",b(m,Math.min(30,30-a/(Math.min(500,l)+10)*30)),e=c,h=0),c},this.update=function(e){t=this.end(e)}}return t}),define("goo/util/combine/Rectangle",[],function(){"use strict";function t(t,e,o,r){this.x=t,this.y=e,this.w=o,this.h=r}return t}),define("goo/util/combine/AtlasNode",["goo/util/combine/Rectangle"],function(t){"use strict";function e(e,o){this.isLeaf=!0,this.isSet=!1,this.children=[],this.localRectangle=void 0!==e&&void 0!==o?new t(0,0,e,o):null}return e.prototype.getRectangles=function(){var t=[];return this._getRectangles(t),t},e.prototype._getRectangles=function(t){this.isSet&&t.push(this.localRectangle),this.isLeaf||(this.children[0]._getRectangles(t),this.children[1]._getRectangles(t))},e.prototype.insert=function(e,o){return this._insert(new t(0,0,e,o))},e.prototype._insert=function(o){if(this.isLeaf){if(this.isSet)return null;if(o.w>this.localRectangle.w||o.h>this.localRectangle.h)return null;if(o.w===this.localRectangle.w&&o.h===this.localRectangle.h)return this.isSet=!0,this;this.isLeaf=!1,this.children[0]=new e,this.children[1]=new e;var r=this.localRectangle.w-o.w,i=this.localRectangle.h-o.h;return r>i?(this.children[0].localRectangle=new t(this.localRectangle.x,this.localRectangle.y,o.w,this.localRectangle.h),this.children[1].localRectangle=new t(this.localRectangle.x+o.w,this.localRectangle.y,r,this.localRectangle.h)):(this.children[0].localRectangle=new t(this.localRectangle.x,this.localRectangle.y,this.localRectangle.w,o.h),this.children[1].localRectangle=new t(this.localRectangle.x,this.localRectangle.y+o.h,this.localRectangle.w,i)),this.children[0]._insert(o)}var n=this.children[0]._insert(o);return null!==n?n:this.children[1]._insert(o)},e}),define("goo/scripts/GooClassRegister",["goo/scripts/Scripts","goo/addons/ammo/AmmoComponent","goo/addons/ammo/AmmoSystem","goo/addons/box2d/components/Box2DComponent","goo/addons/box2d/systems/Box2DSystem","goo/addons/cannon/CannonBoxColliderComponent","goo/addons/cannon/CannonDistanceJointComponent","goo/addons/cannon/CannonPlaneColliderComponent","goo/addons/cannon/CannonRigidBodyComponent","goo/addons/cannon/CannonSphereColliderComponent","goo/addons/cannon/CannonSystem","goo/addons/p2/P2Component","goo/addons/p2/P2System","goo/addons/scripts/PolyBoundingScript","goo/addons/terrain/Forrest","goo/addons/terrain/Terrain","goo/addons/terrain/TerrainHandler","goo/addons/terrain/Vegetation","goo/addons/water/FlatWaterRenderer","goo/addons/water/ProjectedGridWaterRenderer","goo/animation/Joint","goo/animation/Skeleton","goo/animation/SkeletonPose","goo/animation/blendtree/BinaryLERPSource","goo/animation/blendtree/ClipSource","goo/animation/blendtree/FrozenClipSource","goo/animation/blendtree/ManagedTransformSource","goo/animation/clip/AbstractAnimationChannel","goo/animation/clip/AnimationClip","goo/animation/clip/AnimationClipInstance","goo/animation/clip/InterpolatedFloatChannel","goo/animation/clip/JointChannel","goo/animation/clip/JointData","goo/animation/clip/TransformChannel","goo/animation/clip/TransformData","goo/animation/clip/TriggerChannel","goo/animation/clip/TriggerData","goo/animation/layer/AnimationLayer","goo/animation/layer/LayerLERPBlender","goo/animation/state/AbstractState","goo/animation/state/AbstractTransitionState","goo/animation/state/FadeTransitionState","goo/animation/state/FrozenTransitionState","goo/animation/state/SteadyState","goo/animation/state/SyncFadeTransitionState","goo/debug/BoundingVolumeMeshBuilder","goo/debug/DebugDrawHelper","goo/debug/Debugger","goo/debug/EntityCounter","goo/debug/FrustumViewer","goo/debug/LightPointer","goo/entities/Entity","goo/entities/EntitySelection","goo/entities/EntityUtils","goo/entities/Selection","goo/entities/SystemBus","goo/entities/World","goo/entities/components/AnimationComponent","goo/entities/components/CSSTransformComponent","goo/entities/components/CameraComponent","goo/entities/components/CameraDebugComponent","goo/entities/components/Component","goo/entities/components/HTMLComponent","goo/entities/components/LightComponent","goo/entities/components/LightDebugComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MovementComponent","goo/entities/components/ParticleComponent","goo/entities/components/PortalComponent","goo/entities/components/ProximityComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/entities/components/TextComponent","goo/entities/components/TransformComponent","goo/entities/managers/EntityManager","goo/entities/managers/Manager","goo/entities/systems/AnimationSystem","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/CSSTransformSystem","goo/entities/systems/CameraDebugSystem","goo/entities/systems/CameraSystem","goo/entities/systems/DebugRenderSystem","goo/entities/systems/GizmoRenderSystem","goo/entities/systems/GridRenderSystem","goo/entities/systems/HTMLSystem","goo/entities/systems/LightDebugSystem","goo/entities/systems/LightingSystem","goo/entities/systems/MovementSystem","goo/entities/systems/ParticlesSystem","goo/entities/systems/PickingSystem","goo/entities/systems/PortalSystem","goo/entities/systems/ProximitySystem","goo/entities/systems/RenderSystem","goo/entities/systems/SoundSystem","goo/entities/systems/System","goo/entities/systems/TextSystem","goo/entities/systems/TransformSystem","goo/loaders/DynamicLoader","goo/math/MathUtils","goo/math/Matrix","goo/math/Matrix2x2","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/math/Plane","goo/math/Quaternion","goo/math/Ray","goo/math/Transform","goo/math/Vector","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4","goo/noise/Noise","goo/noise/ValueNoise","goo/particles/Particle","goo/particles/ParticleEmitter","goo/particles/ParticleInfluence","goo/particles/ParticleLib","goo/particles/ParticleUtils","goo/picking/BoundingTree","goo/picking/PrimitivePickLogic","goo/renderer/BufferData","goo/renderer/BufferUtils","goo/renderer/Camera","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/RenderQueue","goo/renderer/Renderer","goo/renderer/RendererRecord","goo/renderer/Shader","goo/renderer/ShaderCall","goo/renderer/SimplePartitioner","goo/renderer/Texture","goo/renderer/TextureCreator","goo/renderer/Util","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume","goo/renderer/light/DirectionalLight","goo/renderer/light/Light","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/pass/BloomPass","goo/renderer/pass/BlurPass","goo/renderer/pass/Composer","goo/renderer/pass/DOFPass","goo/renderer/pass/DepthPass","goo/renderer/pass/DoGPass","goo/renderer/pass/FullscreenPass","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/MotionBlurPass","goo/renderer/pass/NesPass","goo/renderer/pass/PassLib","goo/renderer/pass/RenderPass","goo/renderer/pass/RenderTarget","goo/renderer/pass/SSAOPass","goo/renderer/shaders/ShaderBuilder","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/scripts/newwave/FPCamControlScript","goo/scripts/newwave/FlyControlScript","goo/scripts/newwave/MouseLookScript","goo/scripts/newwave/OrbitCamControlScript","goo/scripts/newwave/OrbitNPanControlScript","goo/scripts/newwave/PanCamScript","goo/scripts/newwave/PickAndRotateScript","goo/scripts/newwave/RotationScript","goo/scripts/newwave/WASDScript","goo/shapes/Box","goo/shapes/Cone","goo/shapes/Cylinder","goo/shapes/Disk","goo/shapes/Grid","goo/shapes/ProjectedGrid","goo/shapes/Quad","goo/shapes/ShapeCreator","goo/shapes/SimpleBox","goo/shapes/Sphere","goo/shapes/TerrainSurface","goo/shapes/TextureGrid","goo/shapes/Torus","goo/shapes/debug/CameraDebug","goo/shapes/debug/LightDebug","goo/shapes/debug/MeshRendererDebug","goo/shapes/debug/SkeletonDebug","goo/sound/AudioContext","goo/sound/OscillatorSound","goo/sound/Sound","goo/util/Ajax","goo/util/ArrayUtil","goo/util/CanvasUtils","goo/util/ColorUtil","goo/util/GameUtils","goo/util/MeshBuilder","goo/util/ObjectUtil","goo/util/ParticleSystemUtils","goo/util/PromiseUtil","goo/util/Rc4Random","goo/util/Skybox","goo/util/Snow","goo/util/SoundCreator","goo/util/Stats","goo/util/StringUtil","goo/util/TangentGenerator","goo/util/combine/AtlasNode","goo/util/combine/EntityCombiner","goo/util/combine/Rectangle","goo/util/gizmos/Gizmo","goo/util/gizmos/RotationGizmo","goo/util/gizmos/ScaleGizmo","goo/util/gizmos/TranslationGizmo","goo/util/rsvp"],function(t){"use strict";for(var e=["goo/scripts/Scripts","goo/addons/ammo/AmmoComponent","goo/addons/ammo/AmmoSystem","goo/addons/box2d/components/Box2DComponent","goo/addons/box2d/systems/Box2DSystem","goo/addons/cannon/CannonBoxColliderComponent","goo/addons/cannon/CannonDistanceJointComponent","goo/addons/cannon/CannonPlaneColliderComponent","goo/addons/cannon/CannonRigidBodyComponent","goo/addons/cannon/CannonSphereColliderComponent","goo/addons/cannon/CannonSystem","goo/addons/p2/P2Component","goo/addons/p2/P2System","goo/addons/scripts/PolyBoundingScript","goo/addons/terrain/Forrest","goo/addons/terrain/Terrain","goo/addons/terrain/TerrainHandler","goo/addons/terrain/Vegetation","goo/addons/water/FlatWaterRenderer","goo/addons/water/ProjectedGridWaterRenderer","goo/animation/Joint","goo/animation/Skeleton","goo/animation/SkeletonPose","goo/animation/blendtree/BinaryLERPSource","goo/animation/blendtree/ClipSource","goo/animation/blendtree/FrozenClipSource","goo/animation/blendtree/ManagedTransformSource","goo/animation/clip/AbstractAnimationChannel","goo/animation/clip/AnimationClip","goo/animation/clip/AnimationClipInstance","goo/animation/clip/InterpolatedFloatChannel","goo/animation/clip/JointChannel","goo/animation/clip/JointData","goo/animation/clip/TransformChannel","goo/animation/clip/TransformData","goo/animation/clip/TriggerChannel","goo/animation/clip/TriggerData","goo/animation/layer/AnimationLayer","goo/animation/layer/LayerLERPBlender","goo/animation/state/AbstractState","goo/animation/state/AbstractTransitionState","goo/animation/state/FadeTransitionState","goo/animation/state/FrozenTransitionState","goo/animation/state/SteadyState","goo/animation/state/SyncFadeTransitionState","goo/debug/BoundingVolumeMeshBuilder","goo/debug/DebugDrawHelper","goo/debug/Debugger","goo/debug/EntityCounter","goo/debug/FrustumViewer","goo/debug/LightPointer","goo/entities/Entity","goo/entities/EntitySelection","goo/entities/EntityUtils","goo/entities/Selection","goo/entities/SystemBus","goo/entities/World","goo/entities/components/AnimationComponent","goo/entities/components/CSSTransformComponent","goo/entities/components/CameraComponent","goo/entities/components/CameraDebugComponent","goo/entities/components/Component","goo/entities/components/HTMLComponent","goo/entities/components/LightComponent","goo/entities/components/LightDebugComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MovementComponent","goo/entities/components/ParticleComponent","goo/entities/components/PortalComponent","goo/entities/components/ProximityComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/entities/components/TextComponent","goo/entities/components/TransformComponent","goo/entities/managers/EntityManager","goo/entities/managers/Manager","goo/entities/systems/AnimationSystem","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/CSSTransformSystem","goo/entities/systems/CameraDebugSystem","goo/entities/systems/CameraSystem","goo/entities/systems/DebugRenderSystem","goo/entities/systems/GizmoRenderSystem","goo/entities/systems/GridRenderSystem","goo/entities/systems/HTMLSystem","goo/entities/systems/LightDebugSystem","goo/entities/systems/LightingSystem","goo/entities/systems/MovementSystem","goo/entities/systems/ParticlesSystem","goo/entities/systems/PickingSystem","goo/entities/systems/PortalSystem","goo/entities/systems/ProximitySystem","goo/entities/systems/RenderSystem","goo/entities/systems/SoundSystem","goo/entities/systems/System","goo/entities/systems/TextSystem","goo/entities/systems/TransformSystem","goo/loaders/DynamicLoader","goo/math/MathUtils","goo/math/Matrix","goo/math/Matrix2x2","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/math/Plane","goo/math/Quaternion","goo/math/Ray","goo/math/Transform","goo/math/Vector","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4","goo/noise/Noise","goo/noise/ValueNoise","goo/particles/Particle","goo/particles/ParticleEmitter","goo/particles/ParticleInfluence","goo/particles/ParticleLib","goo/particles/ParticleUtils","goo/picking/BoundingTree","goo/picking/PrimitivePickLogic","goo/renderer/BufferData","goo/renderer/BufferUtils","goo/renderer/Camera","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/RenderQueue","goo/renderer/Renderer","goo/renderer/RendererRecord","goo/renderer/Shader","goo/renderer/ShaderCall","goo/renderer/SimplePartitioner","goo/renderer/Texture","goo/renderer/TextureCreator","goo/renderer/Util","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume","goo/renderer/light/DirectionalLight","goo/renderer/light/Light","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/pass/BloomPass","goo/renderer/pass/BlurPass","goo/renderer/pass/Composer","goo/renderer/pass/DOFPass","goo/renderer/pass/DepthPass","goo/renderer/pass/DoGPass","goo/renderer/pass/FullscreenPass","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/MotionBlurPass","goo/renderer/pass/NesPass","goo/renderer/pass/PassLib","goo/renderer/pass/RenderPass","goo/renderer/pass/RenderTarget","goo/renderer/pass/SSAOPass","goo/renderer/shaders/ShaderBuilder","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/scripts/newwave/FPCamControlScript","goo/scripts/newwave/FlyControlScript","goo/scripts/newwave/MouseLookScript","goo/scripts/newwave/OrbitCamControlScript","goo/scripts/newwave/OrbitNPanControlScript","goo/scripts/newwave/PanCamScript","goo/scripts/newwave/PickAndRotateScript","goo/scripts/newwave/RotationScript","goo/scripts/newwave/WASDScript","goo/shapes/Box","goo/shapes/Cone","goo/shapes/Cylinder","goo/shapes/Disk","goo/shapes/Grid","goo/shapes/ProjectedGrid","goo/shapes/Quad","goo/shapes/ShapeCreator","goo/shapes/SimpleBox","goo/shapes/Sphere","goo/shapes/TerrainSurface","goo/shapes/TextureGrid","goo/shapes/Torus","goo/shapes/debug/CameraDebug","goo/shapes/debug/LightDebug","goo/shapes/debug/MeshRendererDebug","goo/shapes/debug/SkeletonDebug","goo/sound/AudioContext","goo/sound/OscillatorSound","goo/sound/Sound","goo/util/Ajax","goo/util/ArrayUtil","goo/util/CanvasUtils","goo/util/ColorUtil","goo/util/GameUtils","goo/util/MeshBuilder","goo/util/ObjectUtil","goo/util/ParticleSystemUtils","goo/util/PromiseUtil","goo/util/Rc4Random","goo/util/Skybox","goo/util/Snow","goo/util/SoundCreator","goo/util/Stats","goo/util/StringUtil","goo/util/TangentGenerator","goo/util/combine/AtlasNode","goo/util/combine/EntityCombiner","goo/util/combine/Rectangle","goo/util/gizmos/Gizmo","goo/util/gizmos/RotationGizmo","goo/util/gizmos/ScaleGizmo","goo/util/gizmos/TranslationGizmo","goo/util/rsvp"],o=1;o<e.length;o++){var r=e[o].slice(e[o].lastIndexOf("/")+1);
t.addClass(r,arguments[o])}}),define("goo/entities/systems/ScriptSystem",["goo/entities/systems/System","goo/entities/SystemBus","goo/util/ObjectUtil","goo/scripts/Scripts","goo/scripts/GooClassRegister"],function(t,e,o,r){"use strict";function i(o){t.call(this,"ScriptSystem",["ScriptComponent"]),this._world=o;var r=this._world.gooRunner.renderer;this.context={domElement:r.domElement,viewportWidth:r.viewportWidth,viewportHeight:r.viewportHeight,world:o,activeCameraEntity:null,worldData:{}},e.addListener("goo.setCurrentCamera",function(t){this.context.activeCameraEntity=t.entity}.bind(this)),this.manualSetup=!1,this.priority=500}return i.prototype=Object.create(t.prototype),i.prototype.constructor=i,i.prototype.process=function(t,e){var r=this._world.gooRunner.renderer;o.extend(this.context,{viewportWidth:r.viewportWidth,viewportHeight:r.viewportHeight});for(var i=0;i<t.length;i++){var n=t[i].scriptComponent;n.run(t[i],e)}},i.prototype.addedComponent=function(t,e){"ScriptComponent"!==e.type||this.manualSetup||e.setup(t)},i.prototype.removedComponent=function(t,e){"ScriptComponent"!==e.type||this.manualSetup||e.cleanup()},r.addClass("ScriptSystem",i),i}),define("goo/util/Logo",[],function(){"use strict";function t(){}t.blue="#2A3276",t.white="#FFFFFF";var e={color:t.white,shadow:!1};return t.getLogo=function(t){t=t||{};for(var o in e)void 0===t[o]&&(t[o]=e[o]);if(!document.createElementNS)return"";var r="http://www.w3.org/2000/svg",i=document.createElementNS(r,"svg");i.setAttribute("version","1.1"),i.setAttribute("xmlns",r),i.setAttribute("x","0px"),i.setAttribute("y","0px"),i.setAttribute("viewBox","0 0 396.603 277.343"),i.setAttribute("enable-background","new 0 0 396.603 277.343"),i.setAttribute("xml:space","preserve"),t.width&&i.setAttribute("width",t.width),t.height&&i.setAttribute("height",t.height);var n=document.createElementNS(r,"g");i.appendChild(n);var a=document.createElementNS(r,"filter");a.setAttribute("id","insetShadow");var s=document.createElementNS(r,"feGaussianBlur");s.setAttribute("in","SourceAlpha"),s.setAttribute("stdDeviation","0");var l=document.createElementNS(r,"feOffset");l.setAttribute("dx","0"),l.setAttribute("dy","-5"),l.setAttribute("result","offsetblur");var h=document.createElementNS(r,"feComponentTransfer"),d=document.createElementNS(r,"feFuncA");d.setAttribute("type","linear"),d.setAttribute("slope","0.5"),h.appendChild(d);var c=document.createElementNS(r,"feMerge"),u=document.createElementNS(r,"feMergeNode"),p=document.createElementNS(r,"feMergeNode");p.setAttribute("in","SourceGraphic"),c.appendChild(u),c.appendChild(p),a.appendChild(s),a.appendChild(l),a.appendChild(h),a.appendChild(c),n.appendChild(a);var m=document.createElementNS(r,"path");m.setAttribute("d","M303.337,46.286c-13.578,0-25.784,5.744-34.396,14.998c-9.86,10.59-26.319,10.59-36.172,0c-8.605-9.254-20.818-14.998-34.402-14.998c-25.936,0-46.971,21.034-46.971,46.978c0,25.936,21.035,46.972,46.971,46.972c13.584,0,25.797-5.744,34.402-14.998c9.853-10.598,26.325-10.598,36.172,0c8.612,9.254,20.818,14.998,34.396,14.998c25.941,0,46.977-21.036,46.977-46.972C350.313,67.32,329.278,46.286,303.337,46.286z M198.296,116.39c-12.785,0-23.146-10.359-23.146-23.144s10.361-23.151,23.146-23.151c12.795,0,23.156,10.367,23.156,23.151S211.091,116.39,198.296,116.39z M303.337,116.407c-12.785,0-23.146-10.36-23.146-23.144c0-12.784,10.36-23.151,23.146-23.151c12.795,0,23.156,10.367,23.156,23.151C326.493,106.047,316.132,116.407,303.337,116.407z M156.18,138.347c-14.087-3.23-22.316-17.482-18.068-31.305c3.704-12.072,2.568-25.511-4.22-37.256C120.927,47.323,92.22,39.63,69.766,52.587C47.317,65.552,39.624,94.26,52.581,116.713c6.795,11.761,17.853,19.462,30.17,22.282c14.084,3.235,22.314,17.497,18.074,31.317c-3.711,12.08-2.582,25.504,4.213,37.264c12.965,22.455,41.666,30.148,64.127,17.178c22.447-12.945,30.148-41.658,17.185-64.111C179.554,148.881,168.497,141.181,156.18,138.347z M104.802,113.287c-11.064,6.387-25.219,2.599-31.604-8.474c-6.397-11.07-2.604-25.225,8.474-31.609c11.057-6.398,25.22-2.598,31.611,8.46C119.673,92.741,115.872,106.897,104.802,113.287z M145.687,207.256c-12.785,0-23.145-10.361-23.145-23.145s10.359-23.15,23.145-23.15c12.797,0,23.156,10.367,23.156,23.15S158.483,207.256,145.687,207.256z"),m.setAttribute("fill",t.color),t.shadow&&(n.appendChild(a),m.setAttribute("style","filter:url(#insetShadow)")),n.appendChild(m);var f=new XMLSerializer,g=f.serializeToString(i);return g},t}),define("goo/entities/GooRunner",["goo/entities/World","goo/entities/systems/TransformSystem","goo/entities/systems/RenderSystem","goo/renderer/Renderer","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/ScriptSystem","goo/entities/systems/LightingSystem","goo/entities/systems/CameraSystem","goo/entities/systems/ParticlesSystem","goo/util/Stats","goo/entities/systems/CSSTransformSystem","goo/entities/systems/AnimationSystem","goo/entities/systems/LightDebugSystem","goo/entities/systems/CameraDebugSystem","goo/entities/systems/MovementSystem","goo/sound/AudioContext","goo/entities/systems/SoundSystem","goo/entities/components/TransformComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/CameraComponent","goo/entities/components/LightComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/util/GameUtils","goo/util/Logo"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m,f,g,v,y,x,w,_,b,S,M,C){"use strict";function P(S){if(S=S||{},M.initAllShims(),this.world=new t(this),this.renderer=new r(S),this.world.setSystem(new n(this.world)),this.world.setSystem(new e),this.world.setSystem(new s),this.world.setSystem(new d(this.renderer)),this.world.setSystem(new l),this.world.setSystem(new i),this.world.setSystem(new a),this.world.setSystem(new c),this.world.setSystem(new u),this.world.setSystem(new p),this.world.setSystem(new m),f&&this.world.setSystem(new g),this.renderSystem=new o,this.renderSystems=[this.renderSystem],this.world.setSystem(this.renderSystem),this.world.registerComponent(v),this.world.registerComponent(y),this.world.registerComponent(x),this.world.registerComponent(w),this.world.registerComponent(_),this.world.registerComponent(b),this.doProcess=!0,this.doRender=!0,this.tpfSmoothingCount=void 0!==S.tpfSmoothingCount?S.tpfSmoothingCount:10,S.showStats&&(this.stats=new h,this.stats.domElement.style.position="absolute",this.stats.domElement.style.left="10px",this.stats.domElement.style.top="10px",document.body.appendChild(this.stats.domElement)),void 0===S.logo||S.logo){var C=this._buildLogo(S.logo);document.body.appendChild(C)}this.callbacks=[],this.callbacksPreProcess=[],this.callbacksPreRender=[],this.callbacksNextFrame=[],this._takeSnapshots=[];var P=this;this.start=-1,this.run=function(t){try{P._updateFrame(t)}catch(e){console.error(e instanceof Error?e.stack:e)}},this.animationId=0,S.manuallyStartGameLoop||this.startGameLoop(),S.debugKeys&&this._addDebugKeys(),this._events={click:null,mousedown:null,mouseup:null,mousemove:null},this._eventListeners={click:[],mousedown:[],mouseup:[],mousemove:[]},this._eventTriggered={click:null,mousedown:null,mouseup:null,mousemove:null},M.addVisibilityChangeListener(function(t){t?this._stopGameLoop():this.manuallyPaused||this._startGameLoop()}.bind(this)),this._picking={x:0,y:0,skipUpdateBuffer:!1,doPick:!1,pickingCallback:null,pickingStore:{},clearColorStore:[]},this.manuallyPaused=!!S.manuallyStartGameLoop}P.prototype.setRenderSystem=function(t,e){this.world.setSystem(t),void 0!==e?this.renderSystems.splice(e,0,t):this.renderSystems.push(t)};var T=[],E=0;return P.prototype._updateFrame=function(e){this.start<0&&(this.start=e);var o=(e-this.start)/1e3;if(0>o||o>1)return this.start=e,void(this.animationId=window.requestAnimationFrame(this.run));o=Math.max(Math.min(o,.5),1e-4),T[E]=o,E=(E+1)%this.tpfSmoothingCount;for(var i=0,n=0;n<T.length;n++)i+=T[n];i/=T.length,this.world.tpf=i,this.world.time+=this.world.tpf,t.time=this.world.time,t.tpf=this.world.tpf,this.start=e;try{var a=this.callbacksNextFrame;this.callbacksNextFrame=[];for(var n=0;n<a.length;n++)a[n](this.world.tpf)}catch(s){console.error(s)}try{for(var n=0;n<this.callbacksPreProcess.length;n++)this.callbacksPreProcess[n](this.world.tpf)}catch(s){console.error(s)}if(this.doProcess&&this.world.process(),this.renderer.info.reset(),this.doRender){this.renderer.checkResize(r.mainCamera),this.renderer.setRenderTarget();for(var n=0;n<this.callbacksPreRender.length;n++)this.callbacksPreRender[n](this.world.tpf);for(var n=0;n<this.renderSystems.length;n++)this.renderSystems[n].passive||this.renderSystems[n].render(this.renderer);if(this._picking.doPick&&r.mainCamera){var l=this.renderer.clearColor.data;this._picking.clearColorStore[0]=l[0],this._picking.clearColorStore[1]=l[1],this._picking.clearColorStore[2]=l[2],this._picking.clearColorStore[3]=l[3],this.renderer.setClearColor(0,0,0,1);for(var n=0;n<this.renderSystems.length;n++)this.renderSystems[n].renderToPick&&!this.renderSystems[n].passive&&this.renderSystems[n].renderToPick(this.renderer,this._picking.skipUpdateBuffer);this.renderer.pick(this._picking.x,this._picking.y,this._picking.pickingStore,r.mainCamera);try{this._picking.pickingCallback(this._picking.pickingStore.id,this._picking.pickingStore.depth)}catch(s){console.error(s)}this._picking.doPick=!1,this.renderer.setClearColor.apply(this.renderer,this._picking.clearColorStore)}}try{for(var n=0;n<this.callbacks.length;n++)this.callbacks[n](this.world.tpf)}catch(s){console.error(s)}if(this.stats&&this.stats.update(this.renderer.info),this._takeSnapshots.length){try{for(var h=this.renderer.domElement.toDataURL(),n=this._takeSnapshots.length-1;n>=0;n--)this._takeSnapshots[n](h)}catch(d){console.error("Failed to take snapshot",d.message)}this._takeSnapshots=[]}this.animationId=window.requestAnimationFrame(this.run)},P.prototype._buildLogo=function(t){var e=document.createElement("div"),o=t&&t.color?t.color:C.blue,r=C.getLogo({width:"70px",height:"50px",color:o}),i='<span style="color: #EEE; font-family: Helvetica, sans-serif; font-size: 11px; display: inline-block; margin-top: 14px; margin-right: -3px; vertical-align: top;">Powered by</span>';return e.innerHTML='<a style="text-decoration: none;" href="http://www.gooengine.com" target="_blank">'+i+r+"</a>",e.style.position="absolute",e.style.zIndex="2000",t?"topright"===t||"topright"===t.position?(e.style.top="10px",e.style.right="10px"):"topleft"===t||"topleft"===t.position?(e.style.top="10px",e.style.left="10px"):"bottomright"===t||"bottomright"===t.position?(e.style.bottom="10px",e.style.right="10px"):(e.style.bottom="10px",e.style.left="10px"):(e.style.top="10px",e.style.right="10px"),e.id="goologo",e.style.webkitTouchCallout="none",e.style.webkitUserSelect="none",e.style.khtmlUserSelect="none",e.style.mozUserSelect="none",e.style.msUserSelect="none",e.style.userSelect="none",e.ondragstart=function(){return!1},e},P.prototype._addDebugKeys=function(){var t="shiftKey";document.addEventListener("keydown",function(e){32===e.which&&e[t]?M.toggleFullScreen():13===e.which&&e[t]?M.togglePointerLock():49===e.which&&e[t]?this.renderSystem.setDebugMaterial():50!==e.which&&222!==e.which||!e[t]?51===e.which&&e[t]?this.renderSystem.setDebugMaterial("lit"):52===e.which&&e[t]?this.renderSystem.setDebugMaterial("color"):53===e.which&&e[t]?this.renderSystem.setDebugMaterial("wireframe"):54===e.which&&e[t]?this.renderSystem.setDebugMaterial("flat"):55!==e.which&&191!==e.which||!e[t]?56===e.which&&e[t]&&this.renderSystem.setDebugMaterial("+wireframe"):this.renderSystem.setDebugMaterial("texture"):this.renderSystem.setDebugMaterial("normals")}.bind(this),!1),document.addEventListener("mousedown",function(e){if(e[t]){var o=e.clientX,r=e.clientY;this.pick(o,r,function(t,e){var o=this.world.entityManager.getEntityById(t);console.log("Picked entity:",o,"At depth:",e)}.bind(this))}}.bind(this),!1)},P.prototype.addEventListener=function(t,e){!this._eventListeners[t]||this._eventListeners[t].indexOf(e)>-1||"function"==typeof e&&(this._eventListeners[t].push(e),1===this._eventListeners[t].length&&this._enableEvent(t))},P.prototype.removeEventListener=function(t,e){if(this._eventListeners[t]){var o=this._eventListeners[t].indexOf(e);o>-1&&this._eventListeners[t].splice(o,1),0===this._eventListeners[t].length&&this._disableEvent(t)}},P.prototype.triggerEvent=function(t,e){e.type=t,this._eventTriggered.mousedown=e.domEvent,this._dispatchEvent(e)},P.prototype._dispatchEvent=function(t){for(var e in this._eventTriggered)if(this._eventTriggered[e]&&this._eventListeners[e]){var o={entity:t.entity,depth:t.depth,x:t.x,y:t.y,type:e,domEvent:this._eventTriggered[e],id:t.id,intersection:t.intersection};try{for(var r=0;r<this._eventListeners[e].length&&this._eventListeners[e][r](o)!==!1;r++);}catch(i){console.error(i)}this._eventTriggered[e]=null}},P.prototype._enableEvent=function(t){if(!this._events[t]){var e=function(e){var o=void 0!==e.offsetX?e.offsetX:e.layerX,i=void 0!==e.offsetY?e.offsetY:e.layerY;this._eventTriggered[t]=e,this.pick(o,i,function(t,e){var n=this.world.entityManager.getEntityByIndex(t),a=r.mainCamera.getWorldPosition(o,i,this.renderer.viewportWidth,this.renderer.viewportHeight,e);this._dispatchEvent({entity:n,depth:e,x:o,y:i,id:t,intersection:a})}.bind(this))}.bind(this);this.renderer.domElement.addEventListener(t,e),this._events[t]=e}},P.prototype._disableEvent=function(t){this._events[t]&&this.renderer.domElement.removeEventListener(t,this._events[t]),this._events[t]=null},P.prototype._startGameLoop=function(){this.animationId||(this.start=-1,this.animationId=window.requestAnimationFrame(this.run))},P.prototype.startGameLoop=function(){this.manuallyPaused=!1,this._startGameLoop()},P.prototype._stopGameLoop=function(){window.cancelAnimationFrame(this.animationId),this.animationId=0},P.prototype.stopGameLoop=function(){this.manuallyPaused=!0,this._stopGameLoop()},P.prototype.takeSnapshot=function(t){this._takeSnapshots.push(t)},P.prototype.pick=function(t,e,o,r){this._picking.x=t,this._picking.y=e,this._picking.skipUpdateBuffer=void 0===r?!1:r,o&&(this._picking.pickingCallback=o),this._picking.doPick=!0},P}),define("goo/scripts/FPCamControlScript",["goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils","goo/util/GameUtils"],function(t,e,o,r){"use strict";function i(e){e=e||{},this.name="FPCamControlScript",this.domElement=e.domElement||null,this.turnSpeedHorizontal=isNaN(e.turnSpeedHorizontal)?.01:e.turnSpeedHorizontal,this.turnSpeedVertical=isNaN(e.turnSpeedVertical)?.01:e.turnSpeedVertical,this.maxAscent=void 0!==e.maxAscent?e.maxAscent:89.95*o.DEG_TO_RAD,this.minAscent=void 0!==e.minAscent?e.minAscent:-89.95*o.DEG_TO_RAD,this.calcVector=new t,this.rotX=0,this.rotY=0,this.pointerLocked=!1,this.mouseState={dX:0,dY:0},this.domElement&&this.setupMouseControls()}var n=function(){r.requestPointerLock()},a=function(t){this.pointerLocked&&(this.mouseState.dX+=t.movementX,this.mouseState.dY+=t.movementY)},s=function(){this.pointerLocked=!!document.pointerLockElement},l=function(){this.pointerLocked=!!document.pointerLockElement};return i.prototype.setupMouseControls=function(){this.domElement.addEventListener("mousedown",n.bind(this),!1),document.addEventListener("mousemove",a.bind(this)),document.addEventListener("pointerlockchange",s.bind(this)),document.addEventListener("pointerlockerror",l.bind(this)),r.requestPointerLock()},i.prototype.run=function(t,e,o){o&&!this.domElement&&o.domElement&&(this.domElement=o.domElement,this.setupMouseControls());var r=t.transformComponent,i=r.transform,n=i.rotation;n.toAngles(this.calcVector),this.rotY=this.calcVector.x,this.rotX=this.calcVector.y,0!==this.mouseState.dX&&(this.rotX-=this.turnSpeedHorizontal*this.mouseState.dX),0!==this.mouseState.dY&&(this.rotY-=this.turnSpeedVertical*this.mouseState.dY,this.rotY>this.maxAscent?this.rotY=this.maxAscent:this.rotY<this.minAscent&&(this.rotY=this.minAscent)),i.rotation.fromAngles(this.rotY,this.rotX,0),r.setUpdated(),this.mouseState.dX=0,this.mouseState.dY=0},i}),define("goo/scripts/GroundBoundMovementScript",["goo/math/Vector3"],function(t){"use strict";function e(e){e=e||{};for(var o in r)this[o]="boolean"==typeof r[o]?void 0!==e[o]?e[o]===!0:r[o]:isNaN(r[o])?r[o]instanceof t?e[o]?new t(e[o]):(new t).set(r[o]):e[o]||r[o]:isNaN(e[o])?r[o]:e[o];this.groundContact=1,this.targetVelocity=new t,this.targetHeading=new t,this.acceleration=new t,this.torque=new t,this.groundHeight=0,this.groundNormal=new t,this.controlState={run:0,strafe:0,jump:0,yaw:0,roll:0,pitch:0}}var o=new t,r={gravity:-9.81,worldFloor:-1/0,jumpImpulse:95,accLerp:.1,rotLerp:.1,modForward:1,modStrafe:.7,modBack:.4,modTurn:.3};return e.prototype.setTerrainSystem=function(t){this.terrainScript=t},e.prototype.getTerrainSystem=function(){return this.terrainScript},e.prototype.getTerrainHeight=function(t){var e=this.getTerrainSystem().getTerrainHeightAt(t.data);return null===e&&(e=this.worldFloor),e},e.prototype.getTerrainNormal=function(t){return this.getTerrainSystem().getTerrainNormalAt(t.data)},e.prototype.applyForward=function(t){this.controlState.run=t},e.prototype.applyStrafe=function(t){this.controlState.strafe=t},e.prototype.applyJump=function(t){this.controlState.jump=t},e.prototype.applyTurn=function(t){this.controlState.yaw=t},e.prototype.applyJumpImpulse=function(t){return this.groundContact&&(this.controlState.jump?(t=this.jumpImpulse,this.controlState.jump=0):t=0),t},e.prototype.applyDirectionalModulation=function(t,e,o){t*=this.modStrafe,o*=o>0?this.modForward:this.modBack,this.targetVelocity.set(t,this.applyJumpImpulse(e),o)},e.prototype.applyTorqueModulation=function(t,e,o){this.targetHeading.set(t,e*this.modTurn,o)},e.prototype.applyGroundNormalInfluence=function(){var t=Math.abs(Math.cos(this.groundNormal.data[0])),e=Math.abs(Math.cos(this.groundNormal.data[2]));this.targetVelocity.data[0]*=t,this.targetVelocity.data[2]*=e},e.prototype.updateTargetVectors=function(t){this.applyDirectionalModulation(this.controlState.strafe,this.gravity,this.controlState.run),t.rotation.applyPost(this.targetVelocity),this.applyGroundNormalInfluence(),this.applyTorqueModulation(this.controlState.pitch,this.controlState.yaw,this.controlState.roll)},e.prototype.computeAcceleration=function(t,e,r){return o.set(r),t.transformComponent.transform.rotation.applyPost(o),o.sub(e),o.lerp(r,this.accLerp),o.data[1]=r.data[1],o},e.prototype.computeTorque=function(t,e){return o.set(e),o.sub(t),o.lerp(e,this.rotLerp),o},e.prototype.updateVelocities=function(t){var e=t.movementComponent.getVelocity(),o=t.movementComponent.getRotationVelocity();this.acceleration.set(this.computeAcceleration(t,e,this.targetVelocity)),this.torque.set(this.computeTorque(o,this.targetHeading))},e.prototype.applyAccelerations=function(t){t.movementComponent.addVelocity(this.acceleration),t.movementComponent.addRotationVelocity(this.torque)},e.prototype.updateGroundNormal=function(t){this.groundNormal.set(this.getTerrainNormal(t.translation))},e.prototype.checkGroundContact=function(t,e){this.groundHeight=this.getTerrainHeight(e.translation),e.translation.data[1]<=this.groundHeight?(this.groundContact=1,this.updateGroundNormal(e)):this.groundContact=0},e.prototype.applyGroundContact=function(t,e){this.groundHeight>=e.translation.data[1]&&(e.translation.data[1]=this.groundHeight,t.movementComponent.velocity.data[1]<0&&(t.movementComponent.velocity.data[1]=0))},e.prototype.run=function(t){var e=t.transformComponent.transform;this.checkGroundContact(t,e),this.updateTargetVectors(e),this.updateVelocities(t),this.applyAccelerations(t),this.applyGroundContact(t,e)},e}),define("goo/scripts/HeightMapBoundingScript",["goo/math/MathUtils"],function(t){"use strict";function e(t){this.matrixData=t,this.width=t.length-1}return e.prototype.getMatrixData=function(){return this.matrixData},e.prototype.getPointInMatrix=function(t,e){return this.matrixData[t][e]},e.prototype.getAt=function(t,e){return 0>t||t>this.width||0>e||e>this.width?0:this.getPointInMatrix(t,e)},e.prototype.getInterpolated=function(t,e){var o=this.getAt(Math.ceil(t),Math.ceil(e)),r=this.getAt(Math.ceil(t),Math.floor(e)),i=this.getAt(Math.floor(t),Math.ceil(e)),n=this.getAt(Math.floor(t),Math.floor(e)),a=t-Math.floor(t),s=e-Math.floor(e),l=o*a+i*(1-a),h=r*a+n*(1-a),d=l*s+h*(1-s);return d},e.prototype.getTriangleAt=function(t,e){var o,r=Math.ceil(t),i=Math.floor(t),n=Math.ceil(e),a=Math.floor(e),s=t-i,l=e-a,h={x:i,y:n,z:this.getAt(i,n)},d={x:r,y:a,z:this.getAt(r,a)};return o=1-l>s?{x:i,y:a,z:this.getAt(i,a)}:{x:r,y:n,z:this.getAt(r,n)},[h,d,o]},e.prototype.getPreciseHeight=function(e,o){var r=this.getTriangleAt(e,o),i=t.barycentricInterpolation(r[0],r[1],r[2],{x:e,y:o,z:0});return i.z},e.prototype.run=function(t){var e=t.transformComponent.transform.translation;e.data[1]=this.getInterpolated(e.data[2],e.data[0])},e}),define("goo/scripts/MouseLookControlScript",["goo/math/Vector3","goo/math/Matrix3x3","goo/math/MathUtils"],function(t,e,o){"use strict";function r(r){r=r||{},this.name="MouseLookControlScript",this.domElement=r.domElement||null,this.turnSpeedHorizontal=isNaN(r.turnSpeedHorizontal)?.01:r.turnSpeedHorizontal,this.turnSpeedVertical=isNaN(r.turnSpeedVertical)?.01:r.turnSpeedVertical,this.dragOnly=void 0!==r.dragOnly?r.dragOnly===!0:!0,this.dragButton=isNaN(r.dragButton)?-1:r.dragButton,this.worldUpVector=new t(r.worldUpVector)||new t(0,1,0),this.localLeftVector=new t(r.localLeftVector)||new t(-1,0,0),this.onRun=r.onRun,this.maxAscent=void 0!==r.maxAscent?r.maxAscent:89.95*o.DEG_TO_RAD,this.minAscent=void 0!==r.minAscent?r.minAscent:-89.95*o.DEG_TO_RAD,this.calcVector=new t,this.calcMat1=new e,this.calcMat2=new e,this.rotX=0,this.rotY=0,this.resetMouseState(),this.domElement&&this.setupMouseControls()}r.prototype.resetMouseState=function(){this.mouseState={buttonDown:!1,lastX:0/0,lastY:0/0,dX:0,dY:0}},r.prototype.updateButtonState=function(t,e){this.domElement!==document&&this.domElement.focus(),!this.dragOnly||-1!==this.dragButton&&this.dragButton!==t.button||(this.mouseState.buttonDown=e,t.preventDefault())},r.prototype.updateDeltas=function(t){isNaN(this.mouseState.lastX)||isNaN(this.mouseState.lastY)?(this.mouseState.dX=0,this.mouseState.dY=0,this.mouseState.lastX=t.clientX,this.mouseState.lastY=t.clientY):(this.mouseState.dX=t.clientX-this.mouseState.lastX,this.mouseState.dY=t.clientY-this.mouseState.lastY,this.mouseState.lastX=t.clientX,this.mouseState.lastY=t.clientY)};var i,n,a,s=function(t){this.resetMouseState(),this.updateButtonState(t,!0),n=l.bind(this),a=h.bind(this),document.addEventListener("mousemove",n,!1),document.addEventListener("mouseup",a,!1),document.addEventListener("mouseout",a,!1)},l=function(t){this.updateDeltas(t)},h=function(t){this.updateButtonState(t,!1),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),document.removeEventListener("mouseout",a)};return r.prototype.setupMouseControls=function(){i=s.bind(this),this.domElement.addEventListener("mousedown",i,!1)},r.prototype.run=function(t,e,o){o&&!this.domElement&&o.domElement&&(this.domElement=o.domElement,this.setupMouseControls());var r=t.transformComponent;if(r){var i=r.transform,n=i.rotation;if(n.toAngles(this.calcVector),this.rotY=this.calcVector.x,this.rotX=this.calcVector.y,this.dragOnly&&!this.mouseState.buttonDown||0===this.mouseState.dX&&0===this.mouseState.dY)return this.mouseState.dX=0,void(this.mouseState.dY=0);var a=this.turnSpeedHorizontal,s=this.turnSpeedVertical;0!==this.mouseState.dX&&(this.rotX-=a*this.mouseState.dX),0!==this.mouseState.dY&&(this.rotY-=s*this.mouseState.dY,this.rotY>this.maxAscent?this.rotY=this.maxAscent:this.rotY<this.minAscent&&(this.rotY=this.minAscent)),i.rotation.fromAngles(this.rotY,this.rotX,0),r.setUpdated(),this.mouseState.dX=0,this.mouseState.dY=0}},r}),define("goo/scripts/RotationControlScript",["goo/math/Matrix3x3"],function(t){"use strict";function e(t){t=t||{},this.bindings={attach:o.bind(this),update:null,remove:null},this.element=t.domElement||null,this.name="RotationControlScript",this.states={dirty:!1,x:null,y:null,dx:null,dy:null},this.element&&this.setupMouseControls()}var o=function(t){t=t.touches&&1===t.touches.length?t.touches[0]:t,this.states.dx=0,this.states.dy=0,this.states.x=t.pageX,this.states.y=t.pageY,this.bindings.update=r.bind(this),this.bindings.remove=i.bind(this),document.addEventListener("mousemove",this.bindings.update,!1),document.addEventListener("touchmove",this.bindings.update,!1),document.addEventListener("mouseup",this.bindings.remove,!1),document.addEventListener("touchend",this.bindings.remove,!1)},r=function(t){t=t.touches&&1===t.touches.length?t.touches[0]:t,this.states.dirty=!0,this.states.dx+=t.pageX-this.states.x,this.states.dy+=t.pageY-this.states.y,this.states.x=t.pageX,this.states.y=t.pageY},i=function(){document.removeEventListener("mousemove",this.bindings.update),document.removeEventListener("touchmove",this.bindings.update),document.removeEventListener("mouseup",this.bindings.remove),document.removeEventListener("touchend",this.bindings.remove)};return e.prototype.setupMouseControls=function(){this.element.addEventListener("mousedown",this.bindings.attach,!1),this.element.addEventListener("touchstart",this.bindings.attach,!1)},e.prototype.run=function(e,o,r){if(r&&!this.element&&r.domElement&&(this.element=r.domElement,this.setupMouseControls()),this.states.dirty){var i=Math.PI*this.states.dy/this.element.clientHeight,n=Math.PI*this.states.dx/this.element.clientWidth,a=Math.cos(i),s=Math.sin(i),l=Math.cos(n),h=Math.sin(n),d=new t(l,s*h,0-a*h,0,a,s,h,0-s*l,a*l);t.combine(d,e.transformComponent.transform.rotation,e.transformComponent.transform.rotation),e.transformComponent.setUpdated(),this.states.dirty=!1,this.states.dx=0,this.states.dy=0}},e}),define("goo/scripts/SparseHeightMapBoundingScript",[],function(){"use strict";function t(t){this.elevationData=t}return t.prototype.getClosest=function(t,e){for(var o=Number.MAX_VALUE,r=-1,i=0;i<this.elevationData.length;i+=3){var n=Math.pow(this.elevationData[i+0]-t,2)+Math.pow(this.elevationData[i+2]-e,2);o>n&&(o=n,r=i)}return this.elevationData[r+1]},t.prototype.run=function(t){var e=t.transformComponent.transform.translation,o=this.getClosest(e.data[0],e.data[2]),r=e.data[1]-o;e.data[1]-=.1*r},t}),define("goo/scripts/SplineInterpolator",["goo/math/Matrix4x4","goo/math/Vector4"],function(t,e){"use strict";function o(t){t=t||{},this.controlPoint=0,this.controlPoints=t.controlPoints||[],this.elapsedTime=0,this.enabled=t.enabled||!0,this.firstIteration=!0,this.tolerance=t.tolerance||.01,this.beforeFunction=t.beforeFunction||function(t){return t.transformComponent.transform.translation.clone().data},this.updateFunction=t.updateFunction||function(t,e){t.transformComponent.transform.translation.set(e),t.transformComponent.setUpdated()},this.afterFunction=t.afterFunction||function(){}}var r=function(t,e,o){return Math.min(Math.max(t,e),o)};return o.CATMULL_ROM=new t(-.5,1,-.5,0,1.5,-2.5,0,1,-1.5,2,.5,0,.5,-.5,0,0),o.UNIFORM_CUBIC=new t(-.16667,.5,-.5,.16667,.5,-1,0,.66667,-.5,.5,.5,.16667,.16667,0,0,0),o.prototype.run=function(t,i){if(this.firstIteration){this.firstIteration=!1;try{this.controlPoints.unshift({time:0,value:this.beforeFunction(t)})}catch(n){return void(this.enabled=!1)}}for(var a=r(this.controlPoint-1,0,this.controlPoints.length-1),s=r(this.controlPoint+0,0,this.controlPoints.length-1),l=r(this.controlPoint+1,0,this.controlPoints.length-1),h=r(this.controlPoint+2,0,this.controlPoints.length-1),d=this.controlPoints[l].time>this.controlPoints[s].time?(this.elapsedTime-this.controlPoints[s].time)/(this.controlPoints[l].time-this.controlPoints[s].time):0,c=o.CATMULL_ROM.applyPre(new e(d*d*d,d*d,d,1)),u=new Array(this.controlPoints[0].value.length),p=0,m=0;m<u.length;m++)u[m]=0,u[m]+=this.controlPoints[a].value[m]*c[0],u[m]+=this.controlPoints[s].value[m]*c[1],u[m]+=this.controlPoints[l].value[m]*c[2],u[m]+=this.controlPoints[h].value[m]*c[3],p+=Math.abs(this.controlPoints[this.controlPoints.length-1].value[m]-u[m]);try{this.updateFunction(t,u)}catch(n){return void(this.enabled=!1)}if(this.elapsedTime+=i,this.elapsedTime>=this.controlPoints[l].time&&this.controlPoint++,this.controlPoint>=this.controlPoints.length||p<this.tolerance){try{this.afterFunction(t)}catch(n){}return void(this.enabled=!1)}},o}),define("goo/scripts/WorldFittedTerrainScript",["goo/scripts/HeightMapBoundingScript","goo/math/Vector3"],function(t,e){"use strict";function o(t,e){if(t.minX>t.maxX)throw{name:"Terrain Exception",message:"minX is larger than maxX"};if(t.minY>t.maxY)throw{name:"Terrain Exception",message:"minY is larger than maxY"};if(t.minZ>t.maxZ)throw{name:"Terrain Exception",message:"minZ is larger than maxZ"};if(!e)throw{name:"Terrain Exception",message:"No heightmap data specified"};if(e.length!==e[0].length)throw{name:"Terrain Exception",message:"Heightmap data is not a square"};return!0}function r(e,r,i){r=r||s,o(r,e,i);var n={dimensions:r,sideQuadCount:e.length-1,script:new t(e)};return n}function i(){this.heightMapData=[],this.yMargin=1}var n=new e,a=new e,s={minX:0,maxX:100,minY:0,maxY:50,minZ:0,maxZ:100};return i.prototype.addHeightData=function(t,e){var o=r(t,e,this.heightMapData);return this.heightMapData.push(o),o},i.prototype.getHeightDataForPosition=function(t){for(var e=0;e<this.heightMapData.length;e++){var o=this.heightMapData[e].dimensions;if(t[0]<=o.maxX&&t[0]>=o.minX&&t[1]<o.maxY+this.yMargin&&t[1]>o.minY-this.yMargin&&t[2]<=o.maxZ&&t[2]>=o.minZ)return this.heightMapData[e]}return null},i.prototype.displaceAxisDimensions=function(t,e,o,r){var i=t-e;return r*i/(o-e)},i.prototype.returnToWorldDimensions=function(t,e,o,r){var i=(o-e)/r,n=t*i;return e+n},i.prototype.getTerrainHeightAt=function(t){var e=this.getHeightDataForPosition(t);if(null===e)return null;var o=e.dimensions,r=this.displaceAxisDimensions(t[0],o.minX,o.maxX,e.sideQuadCount),i=this.displaceAxisDimensions(t[2],o.minZ,o.maxZ,e.sideQuadCount),n=e.script.getPreciseHeight(r,i);return n*(o.maxY-o.minY)+o.minY},i.prototype.getTerrainNormalAt=function(t){var e=this.getHeightDataForPosition(t);if(!e)return null;for(var o=e.dimensions,r=this.displaceAxisDimensions(t[0],o.minX,o.maxX,e.sideQuadCount),i=this.displaceAxisDimensions(t[2],o.minZ,o.maxZ,e.sideQuadCount),s=e.script.getTriangleAt(r,i),l=0;l<s.length;l++)s[l].x=this.returnToWorldDimensions(s[l].x,o.minX,o.maxX,e.sideQuadCount),s[l].z=this.returnToWorldDimensions(s[l].z,o.minY,o.maxY,1),s[l].y=this.returnToWorldDimensions(s[l].y,o.minZ,o.maxZ,e.sideQuadCount);return n.set(s[1].x-s[0].x,s[1].z-s[0].z,s[1].y-s[0].y),a.set(s[2].x-s[0].x,s[2].z-s[0].z,s[2].y-s[0].y),n.cross(a),n.data[1]<0&&n.muld(-1,-1,-1),n.normalize(),n},i}),require(["goo/addons/ammo/AmmoComponent","goo/addons/ammo/AmmoSystem","goo/addons/ammo/calculateTriangleMeshShape","goo/addons/box2d/components/Box2DComponent","goo/addons/box2d/systems/Box2DSystem","goo/addons/cannon/CannonBoxColliderComponent","goo/addons/cannon/CannonDistanceJointComponent","goo/addons/cannon/CannonPlaneColliderComponent","goo/addons/cannon/CannonRigidBodyComponent","goo/addons/cannon/CannonSphereColliderComponent","goo/addons/cannon/CannonSystem","goo/addons/howler/components/HowlerComponent","goo/addons/howler/systems/HowlerSystem","goo/addons/p2/P2Component","goo/addons/p2/P2System","goo/addons/scripts/PolyBoundingScript","goo/addons/soundmanager2/components/SoundManager2Component","goo/addons/soundmanager2/systems/SoundManager2System","goo/addons/terrain/Forrest","goo/addons/terrain/Terrain","goo/addons/terrain/TerrainHandler","goo/addons/terrain/Vegetation","goo/addons/water/FlatWaterRenderer","goo/addons/water/ProjectedGridWaterRenderer","goo/animation/Joint","goo/animation/Skeleton","goo/animation/SkeletonPose","goo/animation/blendtree/BinaryLERPSource","goo/animation/blendtree/ClipSource","goo/animation/blendtree/FrozenClipSource","goo/animation/blendtree/ManagedTransformSource","goo/animation/clip/AbstractAnimationChannel","goo/animation/clip/AnimationClip","goo/animation/clip/AnimationClipInstance","goo/animation/clip/InterpolatedFloatChannel","goo/animation/clip/JointChannel","goo/animation/clip/JointData","goo/animation/clip/TransformChannel","goo/animation/clip/TransformData","goo/animation/clip/TriggerChannel","goo/animation/clip/TriggerData","goo/animation/layer/AnimationLayer","goo/animation/layer/LayerLERPBlender","goo/animation/state/AbstractState","goo/animation/state/AbstractTransitionState","goo/animation/state/FadeTransitionState","goo/animation/state/FrozenTransitionState","goo/animation/state/SteadyState","goo/animation/state/SyncFadeTransitionState","goo/debug/BoundingVolumeMeshBuilder","goo/debug/DebugDrawHelper","goo/debug/Debugger","goo/debug/EntityCounter","goo/debug/FrustumViewer","goo/debug/LightPointer","goo/debug/components/MarkerComponent","goo/debug/systems/MarkerSystem","goo/entities/Bus","goo/entities/Entity","goo/entities/EntitySelection","goo/entities/EntityUtils","goo/entities/GooRunner","goo/entities/Selection","goo/entities/SystemBus","goo/entities/World","goo/entities/components/AnimationComponent","goo/entities/components/CSSTransformComponent","goo/entities/components/CameraComponent","goo/entities/components/CameraDebugComponent","goo/entities/components/Component","goo/entities/components/HTMLComponent","goo/entities/components/LightComponent","goo/entities/components/LightDebugComponent","goo/entities/components/MeshDataComponent","goo/entities/components/MeshRendererComponent","goo/entities/components/MovementComponent","goo/entities/components/ParticleComponent","goo/entities/components/PortalComponent","goo/entities/components/ProximityComponent","goo/entities/components/ScriptComponent","goo/entities/components/SoundComponent","goo/entities/components/TextComponent","goo/entities/components/TransformComponent","goo/entities/managers/EntityManager","goo/entities/managers/Manager","goo/entities/systems/AnimationSystem","goo/entities/systems/BoundingUpdateSystem","goo/entities/systems/CSSTransformSystem","goo/entities/systems/CameraDebugSystem","goo/entities/systems/CameraSystem","goo/entities/systems/DebugRenderSystem","goo/entities/systems/GizmoRenderSystem","goo/entities/systems/GridRenderSystem","goo/entities/systems/HTMLSystem","goo/entities/systems/LightDebugSystem","goo/entities/systems/LightingSystem","goo/entities/systems/MovementSystem","goo/entities/systems/ParticlesSystem","goo/entities/systems/PickingSystem","goo/entities/systems/PortalSystem","goo/entities/systems/ProximitySystem","goo/entities/systems/RenderSystem","goo/entities/systems/ScriptSystem","goo/entities/systems/SoundSystem","goo/entities/systems/System","goo/entities/systems/TextSystem","goo/entities/systems/TransformSystem","goo/loaders/DynamicLoader","goo/loaders/crunch/CrunchLoader","goo/loaders/dds/DdsLoader","goo/loaders/dds/DdsUtils","goo/loaders/handlers/AnimationClipHandler","goo/loaders/handlers/AnimationComponentHandler","goo/loaders/handlers/AnimationLayersHandler","goo/loaders/handlers/AnimationStateHandler","goo/loaders/handlers/CameraComponentHandler","goo/loaders/handlers/ComponentHandler","goo/loaders/handlers/ConfigHandler","goo/loaders/handlers/EntityHandler","goo/loaders/handlers/EnvironmentHandler","goo/loaders/handlers/HTMLComponentHandler","goo/loaders/handlers/LightComponentHandler","goo/loaders/handlers/MaterialHandler","goo/loaders/handlers/MeshDataComponentHandler","goo/loaders/handlers/MeshDataHandler","goo/loaders/handlers/MeshRendererComponentHandler","goo/loaders/handlers/PosteffectsHandler","goo/loaders/handlers/ProjectHandler","goo/loaders/handlers/SceneHandler","goo/loaders/handlers/ScriptComponentHandler","goo/loaders/handlers/ScriptHandler","goo/loaders/handlers/ShaderHandler","goo/loaders/handlers/SkeletonHandler","goo/loaders/handlers/SkyboxHandler","goo/loaders/handlers/SoundComponentHandler","goo/loaders/handlers/SoundHandler","goo/loaders/handlers/TextureHandler","goo/loaders/handlers/TransformComponentHandler","goo/loaders/tga/TgaLoader","goo/math/MathUtils","goo/math/Matrix","goo/math/Matrix2x2","goo/math/Matrix3x3","goo/math/Matrix4x4","goo/math/Plane","goo/math/Quaternion","goo/math/Ray","goo/math/Transform","goo/math/Vector","goo/math/Vector2","goo/math/Vector3","goo/math/Vector4","goo/noise/Noise","goo/noise/ValueNoise","goo/particles/Particle","goo/particles/ParticleEmitter","goo/particles/ParticleInfluence","goo/particles/ParticleLib","goo/particles/ParticleUtils","goo/picking/BoundingTree","goo/picking/PrimitivePickLogic","goo/renderer/BufferData","goo/renderer/BufferUtils","goo/renderer/Camera","goo/renderer/Material","goo/renderer/MeshData","goo/renderer/RenderQueue","goo/renderer/Renderer","goo/renderer/RendererRecord","goo/renderer/Shader","goo/renderer/ShaderCall","goo/renderer/SimplePartitioner","goo/renderer/Texture","goo/renderer/TextureCreator","goo/renderer/Util","goo/renderer/bounds/BoundingBox","goo/renderer/bounds/BoundingSphere","goo/renderer/bounds/BoundingVolume","goo/renderer/light/DirectionalLight","goo/renderer/light/Light","goo/renderer/light/PointLight","goo/renderer/light/SpotLight","goo/renderer/pass/BloomPass","goo/renderer/pass/BlurPass","goo/renderer/pass/Composer","goo/renderer/pass/DOFPass","goo/renderer/pass/DepthPass","goo/renderer/pass/DoGPass","goo/renderer/pass/FullscreenPass","goo/renderer/pass/FullscreenUtil","goo/renderer/pass/MotionBlurPass","goo/renderer/pass/NesPass","goo/renderer/pass/PassLib","goo/renderer/pass/RenderPass","goo/renderer/pass/RenderTarget","goo/renderer/pass/SSAOPass","goo/renderer/shaders/ShaderBuilder","goo/renderer/shaders/ShaderFragment","goo/renderer/shaders/ShaderLib","goo/renderer/shadow/ShadowHandler","goo/scripts/BasicControlScript","goo/scripts/FPCamControlScript","goo/scripts/FlyControlScript","goo/scripts/GooClassRegister","goo/scripts/GroundBoundMovementScript","goo/scripts/HeightMapBoundingScript","goo/scripts/MouseLookControlScript","goo/scripts/OrbitCamControlScript","goo/scripts/OrbitNPanControlScript","goo/scripts/RotationControlScript","goo/scripts/ScriptRegister","goo/scripts/ScriptUtils","goo/scripts/Scripts","goo/scripts/SparseHeightMapBoundingScript","goo/scripts/SplineInterpolator","goo/scripts/WASDControlScript","goo/scripts/WorldFittedTerrainScript","goo/scripts/newwave/FPCamControlScript","goo/scripts/newwave/FlyControlScript","goo/scripts/newwave/MouseLookScript","goo/scripts/newwave/OrbitCamControlScript","goo/scripts/newwave/OrbitNPanControlScript","goo/scripts/newwave/PanCamScript","goo/scripts/newwave/PickAndRotateScript","goo/scripts/newwave/RotationScript","goo/scripts/newwave/WASDScript","goo/shapes/Box","goo/shapes/Cone","goo/shapes/Cylinder","goo/shapes/Disk","goo/shapes/Grid","goo/shapes/ProjectedGrid","goo/shapes/Quad","goo/shapes/ShapeCreator","goo/shapes/SimpleBox","goo/shapes/Sphere","goo/shapes/TerrainSurface","goo/shapes/TextureGrid","goo/shapes/Torus","goo/shapes/debug/CameraDebug","goo/shapes/debug/LightDebug","goo/shapes/debug/MeshRendererDebug","goo/shapes/debug/SkeletonDebug","goo/sound/AudioContext","goo/sound/OscillatorSound","goo/sound/Sound","goo/util/Ajax","goo/util/ArrayUtil","goo/util/CanvasUtils","goo/util/ColorUtil","goo/util/Enum","goo/util/GameUtils","goo/util/Handy","goo/util/Latch","goo/util/Logo","goo/util/MeshBuilder","goo/util/ObjectUtil","goo/util/ParticleSystemUtils","goo/util/PromiseUtil","goo/util/Rc4Random","goo/util/ShapeCreatorMemoized","goo/util/Skybox","goo/util/Snow","goo/util/SoundCreator","goo/util/Stats","goo/util/StringUtil","goo/util/TangentGenerator","goo/util/combine/AtlasNode","goo/util/combine/EntityCombiner","goo/util/combine/Rectangle","goo/util/gizmos/Gizmo","goo/util/gizmos/RotationGizmo","goo/util/gizmos/ScaleGizmo","goo/util/gizmos/TranslationGizmo","goo/util/rsvp"],function(t,e,o,r,i,n,a,s,l,h,d,c,u,p,m,f,g,v,y,x,w,_,b,S,M,C,P,T,E,D,A,R,I,O,L,N,F,B,k,z,U,V,j,X,H,W,G,Y,q,K,Z,J,Q,$,te,ee,oe,re,ie,ne,ae,se,le,he,de,ce,ue,pe,me,fe,ge,ve,ye,xe,we,_e,be,Se,Me,Ce,Pe,Te,Ee,De,Ae,Re,Ie,Oe,Le,Ne,Fe,Be,ke,ze,Ue,Ve,je,Xe,He,We,Ge,Ye,qe,Ke,Ze,Je,Qe,$e,to,eo,oo,ro,io,no,ao,so,lo,ho,co,uo,po,mo,fo,go,vo,yo,xo,wo,_o,bo,So,Mo,Co,Po,To,Eo,Do,Ao,Ro,Io,Oo,Lo,No,Fo,Bo,ko,zo,Uo,Vo,jo,Xo,Ho,Wo,Go,Yo,qo,Ko,Zo,Jo,Qo,$o,tr,er,or,rr,ir,nr,ar,sr,lr,hr,dr,cr,ur,pr,mr,fr,gr,vr,yr,xr,wr,_r,br,Sr,Mr,Cr,Pr,Tr,Er,Dr,Ar,Rr,Ir,Or,Lr,Nr,Fr,Br,kr,zr,Ur,Vr,jr,Xr,Hr,Wr,Gr,Yr,qr,Kr,Zr,Jr,Qr,$r,ti,ei,Ur,Vr,oi,Gr,Yr,ri,ii,ni,ai,si,li,hi,di,ci,ui,pi,mi,fi,gi,vi,yi,xi,wi,_i,bi,Si,Mi,Ci,Pi,Ti,Ei,Di,Ai,Ri,Ii,Oi,Li,Ni,Fi,Bi,ki,zi,Ui,Vi,ji,Xi,Hi,Wi,Gi,Yi,qi,Ki,Zi,Ji,Qi,$i,tn,en){var on=window.goo;
on&&(on.AmmoComponent=t,on.AmmoSystem=e,on.calculateTriangleMeshShape=o,on.Box2DComponent=r,on.Box2DSystem=i,on.CannonBoxColliderComponent=n,on.CannonDistanceJointComponent=a,on.CannonPlaneColliderComponent=s,on.CannonRigidBodyComponent=l,on.CannonSphereColliderComponent=h,on.CannonSystem=d,on.HowlerComponent=c,on.HowlerSystem=u,on.P2Component=p,on.P2System=m,on.PolyBoundingScript=f,on.SoundManager2Component=g,on.SoundManager2System=v,on.Forrest=y,on.Terrain=x,on.TerrainHandler=w,on.Vegetation=_,on.FlatWaterRenderer=b,on.ProjectedGridWaterRenderer=S,on.Joint=M,on.Skeleton=C,on.SkeletonPose=P,on.BinaryLERPSource=T,on.ClipSource=E,on.FrozenClipSource=D,on.ManagedTransformSource=A,on.AbstractAnimationChannel=R,on.AnimationClip=I,on.AnimationClipInstance=O,on.InterpolatedFloatChannel=L,on.JointChannel=N,on.JointData=F,on.TransformChannel=B,on.TransformData=k,on.TriggerChannel=z,on.TriggerData=U,on.AnimationLayer=V,on.LayerLERPBlender=j,on.AbstractState=X,on.AbstractTransitionState=H,on.FadeTransitionState=W,on.FrozenTransitionState=G,on.SteadyState=Y,on.SyncFadeTransitionState=q,on.BoundingVolumeMeshBuilder=K,on.DebugDrawHelper=Z,on.Debugger=J,on.EntityCounter=Q,on.FrustumViewer=$,on.LightPointer=te,on.MarkerComponent=ee,on.MarkerSystem=oe,on.Bus=re,on.Entity=ie,on.EntitySelection=ne,on.EntityUtils=ae,on.GooRunner=se,on.Selection=le,on.SystemBus=he,on.World=de,on.AnimationComponent=ce,on.CSSTransformComponent=ue,on.CameraComponent=pe,on.CameraDebugComponent=me,on.Component=fe,on.HTMLComponent=ge,on.LightComponent=ve,on.LightDebugComponent=ye,on.MeshDataComponent=xe,on.MeshRendererComponent=we,on.MovementComponent=_e,on.ParticleComponent=be,on.PortalComponent=Se,on.ProximityComponent=Me,on.ScriptComponent=Ce,on.SoundComponent=Pe,on.TextComponent=Te,on.TransformComponent=Ee,on.EntityManager=De,on.Manager=Ae,on.AnimationSystem=Re,on.BoundingUpdateSystem=Ie,on.CSSTransformSystem=Oe,on.CameraDebugSystem=Le,on.CameraSystem=Ne,on.DebugRenderSystem=Fe,on.GizmoRenderSystem=Be,on.GridRenderSystem=ke,on.HTMLSystem=ze,on.LightDebugSystem=Ue,on.LightingSystem=Ve,on.MovementSystem=je,on.ParticlesSystem=Xe,on.PickingSystem=He,on.PortalSystem=We,on.ProximitySystem=Ge,on.RenderSystem=Ye,on.ScriptSystem=qe,on.SoundSystem=Ke,on.System=Ze,on.TextSystem=Je,on.TransformSystem=Qe,on.DynamicLoader=$e,on.CrunchLoader=to,on.DdsLoader=eo,on.DdsUtils=oo,on.AnimationClipHandler=ro,on.AnimationComponentHandler=io,on.AnimationLayersHandler=no,on.AnimationStateHandler=ao,on.CameraComponentHandler=so,on.ComponentHandler=lo,on.ConfigHandler=ho,on.EntityHandler=co,on.EnvironmentHandler=uo,on.HTMLComponentHandler=po,on.LightComponentHandler=mo,on.MaterialHandler=fo,on.MeshDataComponentHandler=go,on.MeshDataHandler=vo,on.MeshRendererComponentHandler=yo,on.PosteffectsHandler=xo,on.ProjectHandler=wo,on.SceneHandler=_o,on.ScriptComponentHandler=bo,on.ScriptHandler=So,on.ShaderHandler=Mo,on.SkeletonHandler=Co,on.SkyboxHandler=Po,on.SoundComponentHandler=To,on.SoundHandler=Eo,on.TextureHandler=Do,on.TransformComponentHandler=Ao,on.TgaLoader=Ro,on.MathUtils=Io,on.Matrix=Oo,on.Matrix2x2=Lo,on.Matrix3x3=No,on.Matrix4x4=Fo,on.Plane=Bo,on.Quaternion=ko,on.Ray=zo,on.Transform=Uo,on.Vector=Vo,on.Vector2=jo,on.Vector3=Xo,on.Vector4=Ho,on.Noise=Wo,on.ValueNoise=Go,on.Particle=Yo,on.ParticleEmitter=qo,on.ParticleInfluence=Ko,on.ParticleLib=Zo,on.ParticleUtils=Jo,on.BoundingTree=Qo,on.PrimitivePickLogic=$o,on.BufferData=tr,on.BufferUtils=er,on.Camera=or,on.Material=rr,on.MeshData=ir,on.RenderQueue=nr,on.Renderer=ar,on.RendererRecord=sr,on.Shader=lr,on.ShaderCall=hr,on.SimplePartitioner=dr,on.Texture=cr,on.TextureCreator=ur,on.Util=pr,on.BoundingBox=mr,on.BoundingSphere=fr,on.BoundingVolume=gr,on.DirectionalLight=vr,on.Light=yr,on.PointLight=xr,on.SpotLight=wr,on.BloomPass=_r,on.BlurPass=br,on.Composer=Sr,on.DOFPass=Mr,on.DepthPass=Cr,on.DoGPass=Pr,on.FullscreenPass=Tr,on.FullscreenUtil=Er,on.MotionBlurPass=Dr,on.NesPass=Ar,on.PassLib=Rr,on.RenderPass=Ir,on.RenderTarget=Or,on.SSAOPass=Lr,on.ShaderBuilder=Nr,on.ShaderFragment=Fr,on.ShaderLib=Br,on.ShadowHandler=kr,on.BasicControlScript=zr,on.FPCamControlScript=Ur,on.FlyControlScript=Vr,on.GooClassRegister=jr,on.GroundBoundMovementScript=Xr,on.HeightMapBoundingScript=Hr,on.MouseLookControlScript=Wr,on.OrbitCamControlScript=Gr,on.OrbitNPanControlScript=Yr,on.RotationControlScript=qr,on.ScriptRegister=Kr,on.ScriptUtils=Zr,on.Scripts=Jr,on.SparseHeightMapBoundingScript=Qr,on.SplineInterpolator=$r,on.WASDControlScript=ti,on.WorldFittedTerrainScript=ei,on.FPCamControlScript=Ur,on.FlyControlScript=Vr,on.MouseLookScript=oi,on.OrbitCamControlScript=Gr,on.OrbitNPanControlScript=Yr,on.PanCamScript=ri,on.PickAndRotateScript=ii,on.RotationScript=ni,on.WASDScript=ai,on.Box=si,on.Cone=li,on.Cylinder=hi,on.Disk=di,on.Grid=ci,on.ProjectedGrid=ui,on.Quad=pi,on.ShapeCreator=mi,on.SimpleBox=fi,on.Sphere=gi,on.TerrainSurface=vi,on.TextureGrid=yi,on.Torus=xi,on.CameraDebug=wi,on.LightDebug=_i,on.MeshRendererDebug=bi,on.SkeletonDebug=Si,on.AudioContext=Mi,on.OscillatorSound=Ci,on.Sound=Pi,on.Ajax=Ti,on.ArrayUtil=Ei,on.CanvasUtils=Di,on.ColorUtil=Ai,on.Enum=Ri,on.GameUtils=Ii,on.Handy=Oi,on.Latch=Li,on.Logo=Ni,on.MeshBuilder=Fi,on.ObjectUtil=Bi,on.ParticleSystemUtils=ki,on.PromiseUtil=zi,on.Rc4Random=Ui,on.ShapeCreatorMemoized=Vi,on.Skybox=ji,on.Snow=Xi,on.SoundCreator=Hi,on.Stats=Wi,on.StringUtil=Gi,on.TangentGenerator=Yi,on.AtlasNode=qi,on.EntityCombiner=Ki,on.Rectangle=Zi,on.Gizmo=Ji,on.RotationGizmo=Qi,on.ScaleGizmo=$i,on.TranslationGizmo=tn,on.rsvp=en)}),define("goo",function(){});
}try{if(window.localStorage&&window.localStorage.gooPath){window.require.config({paths:{goo:localStorage.gooPath}})}else f()}catch(e){f()}})(window,undefined)